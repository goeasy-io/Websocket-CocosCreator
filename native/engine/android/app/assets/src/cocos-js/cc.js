System.register([],(function(t,e){"use strict";return{execute:function(){t({BitMask:kt,CCClass:Me,CacheMode:void 0,DebugMode:void 0,Enum:jt,Eventify:u_,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,Overflow:void 0,SystemEventType:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Vv,WorldNode3DToWorldNodeUI:kv,absMax:sn,absMaxComponent:nn,approx:Ge,assert:d,assertID:C,bezier:wb,bezierByTime:Nb,ccenum:Xt,clamp:He,clamp01:Ve,color:zn,computeRatioByType:Ub,deserialize:uu,earcut:DH,equals:Ue,error:u,errorID:T,find:PT,fragmentText:CN,getBaselineOffset:function(){return 0},getError:b,getPathFromRoot:function(t,e){let n=t,i="";for(;null!==n&&n!==e;)i=`${n.name}/${i}`,n=n.parent;return i.slice(0,-1)},getWorldTransformUntilRoot:$w,instantiate:Yf,inverseLerp:en,isCustomTargetModifier:cR,isDisplayStats:w,isElementModifier:aR,isPropertyModifier:oR,isUnicodeCJK:xN,isUnicodeSpace:SN,isValid:s_,lerp:ke,log:h,logID:v,markAsWarning:void 0,mat4:In,murmurhash2_32_gc:vo,nextPow2:Je,pingPong:tn,pseudoRandom:Ke,pseudoRandomRange:$e,pseudoRandomRangeInt:Ze,quat:Cn,randomRange:Xe,randomRangeInt:Ye,rect:Nn,removeProperty:void 0,repeat:Qe,replaceProperty:void 0,safeMeasureText:TN,sampleAnimationCurve:Fb,setDefaultLogTimes:function(t){t>0&&(If=t)},setDisplayStats:R,size:Dn,toDegree:We,toRadian:je,v2:cn,v3:un,v4:pn,warn:_,warnID:x});const n="undefined"==typeof window?global:window,i=t("cclegacy",{_global:n});i.internal={},n.CC_BUILD=!0,n.CC_TEST=!1,n.CC_EDITOR=!1,n.CC_PREVIEW=!1,n.CC_DEV=!1,n.CC_DEBUG=!1,n.CC_JSB=!0,n.CC_BYTEDANCE=!1,n.CC_WECHAT=!1,n.CC_ALIPAY=!1,n.CC_XIAOMI=!1,n.CC_BAIDU=!1,n.CC_COCOSPLAY=!1,n.CC_HUAWEI=!1,n.CC_OPPO=!1,n.CC_VIVO=!1,n.CC_MINIGAME=!1,n.CC_RUNTIME_BASED=!1,n.CC_SUPPORT_JIT=!0,n.CocosEngine=i.ENGINE_VERSION="3.0.0",n.cc=i;let s=null,r=console.log.bind(console),o=r,a=r,c=(t,e,...n)=>{t||console.log("ASSERT: "+l(e,...n))};function l(t,...e){return i.js.formatStr.apply(null,[t].concat(e))}function h(t,...e){return r(t,...e)}function _(t,...e){return o(t,...e)}function u(t,...e){return a(t,...e)}function d(t,e,...n){return c(t,e,...n)}function p(t){if(r=o=a=c=()=>{},t!==A.NONE){if(t>A.ERROR){const e=t=>{if(i.game.canvas){if(!s){const t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",i.game.canvas.height);const e=t.style;e.zIndex="99999",e.position="absolute",e.top=e.left="0",s=document.createElement("textarea"),s.setAttribute("rows","20"),s.setAttribute("cols","30"),s.setAttribute("disabled","true");const n=s.style;n.backgroundColor="transparent",n.borderBottom="1px solid #cccccc",n.borderTopWidth=n.borderLeftWidth=n.borderRightWidth="0px",n.borderTopStyle=n.borderLeftStyle=n.borderRightStyle="none",n.padding="0px",n.margin="0px",t.appendChild(s),i.game.canvas.parentNode.appendChild(t)}s.value=s.value+t+"\r\n",s.scrollTop=s.scrollHeight}};a=(t,...n)=>{e("ERROR :  "+l(t,...n))},c=(t,n,...i)=>{t||e("ASSERT: "+l(n,...i))},t!==A.ERROR_FOR_WEB_PAGE&&(o=(t,...n)=>{e("WARN :  "+l(t,...n))}),t===A.INFO_FOR_WEB_PAGE&&(r=(t,...n)=>{e(l(t,...n))})}else console&&console.log.apply&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),a=console.error.bind?console.error.bind(console):console.error,c=(t,e,...n)=>{if(!t){const t=l(e,...n);throw new Error(t)}});t!==A.ERROR&&(o=console.warn.bind?console.warn.bind(console):console.warn),t===A.INFO&&(r="JavaScriptCore"===scriptEngineType?(t,...e)=>console.log.apply(console,[t,...e]):console.log)}}function m(t){{const e=t.stack;u(e?`${t}\n${e}`:t)}}function f(t){return(e,...n)=>{const i=`${t} ${e}, please go to https://github.com/cocos-creator/engine/blob/3d/EngineErrorMap.md#${e} to see details.`;return 0===n.length?i:`${i} Arguments: ${n.join(", ")}`}}const g=f("Log");function v(t,...e){h(g(t,...e))}const y=f("Warning");function x(t,...e){_(y(t,...e))}const S=f("Error");function T(t,...e){u(S(t,...e))}const E=f("Assert");function C(t,e,...n){t||d(!1,E(e,...n))}let A;function b(t,...e){return S(t,...e)}function w(){return!!i.profiler&&i.profiler.isShowingStats()}function R(t){i.profiler&&(t?i.profiler.showStats():i.profiler.hideStats(),i.game.config.showFPS=!!t)}!function(t){t[t.NONE=0]="NONE",t[t.INFO=1]="INFO",t[t.WARN=2]="WARN",t[t.ERROR=3]="ERROR",t[t.INFO_FOR_WEB_PAGE=4]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=5]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=6]="ERROR_FOR_WEB_PAGE"}(A||(A=t("DebugMode",{})));var I=Object.freeze({__proto__:null,log:h,warn:_,error:u,assert:d,_resetDebugSetting:p,_throw:m,logID:v,warnID:x,errorID:T,assertID:C,get DebugMode(){return A},getError:b,isDisplayStats:w,setDisplayStats:R});const P=/(\.[^\.\/\?\\]*)(\?.*)?$/,O=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,D=/[^\.\/]+\/\.\.\//;function M(...t){let e="";for(const n of t)e=(e+(""===e?"":"/")+n).replace(/(\/|\\\\)$/,"");return e}function N(t){const e=P.exec(t);return e?e[1]:""}function L(t){if(t){const e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function z(t,e){const n=t.indexOf("?");n>0&&(t=t.substring(0,n));const i=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!i)return t;const s=i[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?s.substring(0,s.length-e.length):s}function B(t){const e=O.exec(t);return e?e[2]:""}function F(t,e){e=e||"";let n=t.indexOf("?"),i="";return n>0&&(i=t.substring(n),t=t.substring(0,n)),n=t.lastIndexOf("."),n<0?t+e+i:t.substring(0,n)+e+i}function U(t,e,n){if(0===e.indexOf("."))return F(t,e);let i=t.indexOf("?"),s="";const r=n?N(t):"";return i>0&&(s=t.substring(i),t=t.substring(0,i)),i=t.lastIndexOf("/"),i=i<=0?0:i+1,t.substring(0,i)+e+r+s}function G(t){let e=t=String(t);do{e=t,t=t.replace(D,"")}while(e.length!==t.length);return t}function H(t){return t.replace(/[\/\\]$/,"")}function V(){return i.sys.os===i.sys.OS_WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,join:M,extname:N,mainFileName:L,basename:z,dirname:B,changeExtname:F,changeBasename:U,_normalize:G,stripSep:H,getSeperator:V})),i.log=h,i.warn=_,i.error=u,i.assert=d,i._throw=m,i.logID=v,i.warnID=x,i.errorID=T,i.assertID=C,i.debug=I,i.path={join:M,extname:N,mainFileName:L,basename:z,dirname:B,changeExtname:F,changeBasename:U,_normalize:G,stripSep:H,get sep(){return V()}};let k=0;const j={};var W={addStage(t){if(void 0!==j[t])return;const e=1<<k;j[t]=e,k+=1},stageID(t){const e=j[t];return void 0===e?-1:e},stageIDs(t){let e=0;for(const n of t){const t=j[n];void 0!==t&&(e|=t)}return e}};function q(t){let e,n;return e=(t>65535)<<4,n=((t>>>=e)>255)<<3,e|=n,n=((t>>>=n)>15)<<2,e|=n,n=((t>>>=n)>3)<<1,e|=n,e|(t>>>=n)>>1}function X(t){let e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function Y(t){return t+=0===t,--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}const K=new Array(256);(t=>{for(let e=0;e<256;++e){let n=e,i=e,s=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--s;t[e]=i<<s&255}})(K);var $=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-1<<31,sign:function(t){return(t>0)-(t<0)},abs:function(t){const e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:q,log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},countTrailingZeros:X,nextPow2:Y,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return K[255&t]<<24|K[t>>>8&255]<<16|K[t>>>16&255]<<8|K[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,n){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){const e=t|t-1;return e+1|(~e&-~e)-1>>>X(t)+1}});t("bits",$);class Z{constructor(t){this.i=0,this.array=t}get length(){return this.array.length}set length(t){this.array.length=t,this.i>=t&&(this.i=t-1)}remove(t){const e=this.array.indexOf(t);e>=0&&this.removeAt(e)}removeAt(t){this.array.splice(t,1),t<=this.i&&--this.i}fastRemove(t){const e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)}fastRemoveAt(t){const e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i}push(t){this.array.push(t)}}function J(t,e){t.splice(e,1)}function Q(t,e){const n=t.length;e<0||e>=n||(t[e]=t[n-1],t.length=n-1)}function tt(t,e){const n=t.indexOf(e);return n>=0&&(J(t,n),!0)}function et(t,e){return t.indexOf(e)>=0}var nt=Object.freeze({__proto__:null,removeAt:J,fastRemoveAt:Q,remove:tt,fastRemove:function(t,e){const n=t.indexOf(e);n>=0&&(t[n]=t[t.length-1],--t.length)},removeIf:function(t,e){const n=t.findIndex(e);if(n>=0){const e=t[n];return J(t,n),e}},verifyType:function(t,e){if(t&&t.length>0)for(const n of t)if(!(n instanceof e))return v(1300),!1;return!0},removeArray:function(t,e){for(let n=0,i=e.length;n<i;n++)tt(t,e[n])},appendObjectsAt:function(t,e,n){return t.splice.apply(t,[n,0,...e]),t},contains:et,copy:function(t){const e=t.length,n=new Array(e);for(let i=0;i<e;i+=1)n[i]=t[i];return n},MutableForwardIterator:Z});class it{constructor(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}getNewId(){return this.prefix+ ++this.id}}it.global=new it("global");const st=new it("TmpCId."),rt="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]");function ot(t){return"number"==typeof t||t instanceof Number}function at(t){return"string"==typeof t||t instanceof String}function ct(t){for(const e in t)return!1;return!0}const lt=(()=>{const t={value:void 0,enumerable:!1,writable:!1,configurable:!0};return(e,n,i,s,r)=>{t.value=i,t.writable=s,t.enumerable=r,Object.defineProperty(e,n,t),t.value=void 0}})(),ht=(()=>{const t={get:void 0,set:void 0,enumerable:!1};return(e,n,i,s,r=!1,o=!1)=>{"boolean"==typeof s&&(r=s,s=void 0),t.get=i,t.set=s,t.enumerable=r,t.configurable=o,Object.defineProperty(e,n,t),t.get=void 0,t.set=void 0}})(),_t=(()=>{const t={get:void 0,enumerable:!1,configurable:!1};return(e,n,i,s,r)=>{t.get=i,t.enumerable=s,t.configurable=r,Object.defineProperty(e,n,t),t.get=void 0}})(),ut=(()=>{const t={set:void 0,enumerable:!1,configurable:!1};return(e,n,i,s,r)=>{t.set=i,t.enumerable=s,t.configurable=r,Object.defineProperty(e,n,t),t.set=void 0}})();function dt(t){const e=Object.create(null);if(t){const t=".",n="/";e[t]=1,e[n]=1,delete e[t],delete e[n]}return e}function pt(t){if("function"==typeof t){const e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;let n="";if(t.name&&(n=t.name),t.toString){let e;const i=t.toString();e="["===i.charAt(0)?i.match(/\[\w+\s*(\w+)\]/):i.match(/function\s*(\w+)/),e&&2===e.length&&(n=e[1])}return"Object"!==n?n:""}return t&&t.constructor?pt(t.constructor):""}function mt(t,e,n,i){const s=/([^.]+)$/,r=s.exec(e)[0],o=s.exec(n)[0];function a(){return this[o]}i?ht(t,r,a,(function(t){this[o]=t})):_t(t,r,a)}function ft(t,e,n,i){for(const s in n)mt(t,`${e}.${s}`,n[s],i)}const gt=/(%d)|(%s)/,vt=/%s/;function yt(t,...e){if(0===arguments.length)return"";if(0===e.length)return""+t;const n="string"==typeof t&&gt.test(t);if(n)for(const n of e){const e="number"==typeof n?gt:vt;if(e.test(t)){const i=""+n;t=t.replace(e,i)}else t+=" "+n}else for(const n of e)t+=" "+n;return t}function xt(){const t=arguments.length-1,e=new Array(t);for(let n=0;n<t;++n)e[n]=arguments[n+1];return e}function St(t,e){for(;t;){const n=Object.getOwnPropertyDescriptor(t,e);if(n)return n;t=Object.getPrototypeOf(t)}return null}function Tt(t,e,n){const i=St(e,t);i&&Object.defineProperty(n,t,i)}function Et(t,...e){t=t||{};for(const n of e)if(n){if("object"!=typeof n){T(5402,n);continue}for(const e in n)e in t||Tt(e,n,t)}return t}function Ct(t,...e){t=t||{};for(const n of e)if(n){if("object"!=typeof n){T(5403,n);continue}for(const e in n)Tt(e,n,t)}return t}function At(t,e){for(const n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function bt(t){const e=t.prototype,n=e&&Object.getPrototypeOf(e);return n&&n.constructor}function wt(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=bt(t)))return!1;if(t===e)return!0}}return!1}function Rt(t){for(const e of Object.keys(t))delete t[e]}const It=dt(!0),Pt=dt(!0);function Ot(t,e){return function(n,i){if(i.prototype.hasOwnProperty(t)&&delete e[i.prototype[t]],lt(i.prototype,t,n),n){const s=e[n];s&&s!==i?u(`A Class already exists with the same ${t} : "${n}".`):e[n]=i}}}const Dt=Ot("__cid__",It),Mt=Ot("__classname__",Pt);function Nt(t,e){if(Mt(t,e),!e.prototype.hasOwnProperty("__cid__")){const n=t||st.getNewId();n&&Dt(n,e)}}function Lt(t,e){const n=Pt[e],i=It[e];let s=!0;if(n&&n!==t&&(u(`"${e}" has already been set as name or alias of another class.`),s=!1),i&&i!==t&&(u(`"${e}" has already been set as id or alias of another class.`),s=!1),s){let n=t[rt];n||(n=[],t[rt]=n),n.push(e),Pt[e]=t,It[e]=t}}function zt(...t){for(const e of t){const t=e.prototype,n=t.__cid__;n&&delete It[n];const i=t.__classname__;i&&delete Pt[i];const s=t[rt];if(s)for(let t=0;t<s.length;++t){const e=s[t];delete Pt[e],delete It[e]}}}function Bt(t){return It[t]}function Ft(t){return Pt[t]}function Ut(t,e){let n;if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty("__cid__"))return n=t.prototype.__cid__,n;if(t&&t.constructor){const e=t.constructor.prototype;if(e&&e.hasOwnProperty("__cid__"))return n=t.__cid__,n}return""}class Gt{get(){return this._get()}constructor(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;const n=void 0===e?t:e,i=void 0===e?null:t;this.count=0,this._pool=new Array(n),this._cleanup=i}_get(){if(this.count>0){--this.count;const t=this._pool[this.count];return this._pool[this.count]=null,t}return null}put(t){const e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}}resize(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))}}const Ht=nt,Vt={IDGenerator:it,Pool:Gt,array:nt,isNumber:ot,isString:at,isEmptyObject:ct,getPropertyDescriptor:St,addon:Et,mixin:Ct,extend:At,getSuper:bt,isChildClassOf:wt,clear:Rt,value:lt,getset:ht,get:_t,set:ut,unregisterClass:zt,getClassName:pt,setClassName:Nt,setClassAlias:Lt,getClassByName:Ft,get _registeredClassNames(){return{...Pt}},set _registeredClassNames(t){Rt(Pt),Object.assign(Pt,t)},get _registeredClassIds(){return{...It}},set _registeredClassIds(t){Rt(It),Object.assign(It,t)},_getClassId:Ut,_setClassId:Dt,_getClassById:Bt,obsolete:mt,obsoletes:ft,formatStr:yt,shiftArguments:xt,createMap:dt};function kt(t){if("__bitmask__"in t)return t;lt(t,"__bitmask__",null,!0);let e=-1;const n=Object.keys(t);for(let i=0;i<n.length;i++){const s=n[i];let r=t[s];if(-1===r)r=++e,t[s]=r;else if("number"==typeof r)e=r;else if("string"==typeof r&&Number.isInteger(parseFloat(s)))continue;const o=""+r;s!==o&&lt(t,o,s)}return t}function jt(t){return"__enums__"in t?t:(lt(t,"__enums__",null,!0),jt.update(t))}function Wt(t){t.hasOwnProperty("__enums__")}function qt(t){Wt(t);const e=t.__enums__||[];e.length=0;for(const n in t){const i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((t,e)=>t.value-e.value),t.__enums__=e,e}function Xt(t){"__enums__"in t||lt(t,"__enums__",null,!0)}i.js=Vt,t("js",Object.freeze({__proto__:null,array:Ht,js:Vt,IDGenerator:it,Pool:Gt,isNumber:ot,isString:at,isEmptyObject:ct,value:lt,getset:ht,get:_t,set:ut,createMap:dt,getClassName:pt,obsolete:mt,obsoletes:ft,formatStr:yt,shiftArguments:xt,getPropertyDescriptor:St,addon:Et,mixin:Ct,extend:At,getSuper:bt,isChildClassOf:wt,clear:Rt,_idToClass:It,_nameToClass:Pt,_setClassId:Dt,setClassName:Nt,setClassAlias:Lt,unregisterClass:zt,_getClassById:Bt,getClassByName:Ft,_getClassId:Ut})),kt.isBitMask=t=>t&&t.hasOwnProperty("__bitmask__"),kt.getList=t=>{if(t.__bitmask__)return t.__bitmask__;const e=t.__bitmask__=[];for(const n in t){const i=t[n];Number.isInteger(i)&&e.push({name:n,value:i})}return e.sort((t,e)=>t.value-e.value),e},i.BitMask=kt,jt.update=t=>{let e=-1;const n=Object.keys(t);for(let i=0;i<n.length;i++){const s=n[i];let r=t[s];if(-1===r)r=++e,t[s]=r;else if("number"==typeof r)e=r;else if("string"==typeof r&&Number.isInteger(parseFloat(s)))continue;const o=""+r;s!==o&&lt(t,o,s)}return Array.isArray(t.__enums__)&&qt(t),t},jt||(jt=t("Enum",{})),jt.isEnum=t=>t&&t.hasOwnProperty("__enums__"),jt.getList=t=>(Wt(t),t.__enums__?t.__enums__:qt(t)),i.Enum=jt;class Yt{clone(){return T(100,pt(this)+".clone"),this}equals(t){return!1}set(t){T(100,pt(this)+".set")}toString(){return""+{}}}t("ValueType",Yt),Nt("cc.ValueType",Yt),i.ValueType=Yt;const Kt=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20});i.macro=Kt;const $t=/^(?:cc|dragonBones|sp|ccsg)\..+/,Zt=new Array(123);for(let t=0;t<123;++t)Zt[t]=64;for(let t=0;t<64;++t)Zt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(t)]=t;const Jt=Zt;function Qt(t,e,n){function i(t,e,n,i){const s=Object.getOwnPropertyDescriptor(t,e);if(s)s.get&&(t[n]=s.get),s.set&&i&&(t[i]=s.set);else{const s=t[n];ht(t,e,s,t[i])}}let s;const r=t.prototype;for(let t=0;t<e.length;t++){s=e[t];const n=s[0].toUpperCase()+s.slice(1);i(r,s,"get"+n,"set"+n)}for(s in n){const t=n[s];i(r,s,t[0],t[1])}}function te(t,e,n,i){const s=t[e];s?Array.isArray(s)?i?(s.push(s[0]),s[0]=n):s.push(n):t[e]=i?[n,s]:[s,n]:t[e]=n}function ee(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));{let n=e.parentNode;if(n)do{if(n===t)return!0;n=n.parentNode}while(null!==n);return!1}}function ne(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function ie(t,e,n){t&&setTimeout(()=>{t(e,n)},0)}function se(t){return!(!t||t.constructor!==Object)&&ct(t)}function re(t,e,n){if(e>n){const t=e;e=n,n=t}return t<e?e:t<n?t:n}function oe(t){return t*Kt.RAD}function ae(t){return t*Kt.DEG}function ce(t,e){const n=e?Object.create(e):{};return lt(t,"__attrs__",n),n}function le(t){if("function"!=typeof t)return ce(t,_e(t.constructor));let e;const n=i.Class.getInheritanceChain(t);for(let t=n.length-1;t>=0;t--){const i=n[t];i.hasOwnProperty("__attrs__")&&i.__attrs__||(e=n[t+1],ce(i,e&&e.__attrs__))}return e=n[0],ce(t,e&&e.__attrs__),t.__attrs__}function he(t,e){const n=_e(t),i=e+"$_$",s={};for(const t in n)t.startsWith(i)&&(s[t.slice(i.length)]=n[t]);return s}function _e(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||le(t)}function ue(t,e,n,i){_e(t)[e+"$_$"+n]=i}i.misc={BUILTIN_CLASSID_RE:$t,BASE64_VALUES:Jt,propertyDefine:Qt,pushToMap:te,contains:ee,isDomNode:ne,callInNextTick:ie,isPlainEmptyObj_DEV:se,clampf:re,degreesToRadians:oe,radiansToDegrees:ae},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:$t,BASE64_VALUES:Jt,propertyDefine:Qt,pushToMap:te,contains:ee,isDomNode:ne,callInNextTick:ie,tryCatchFunctor_EDITOR:function(t){return Function("target",`try {\n  target.${t}();\n}\ncatch (e) {\n  cc._throw(e);\n}`)},isPlainEmptyObj_DEV:se,clampf:re,degreesToRadians:oe,radiansToDegrees:ae}));class de{constructor(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}toString(){return this.name}}const pe=t("CCInteger",new de("Integer",0));i.Integer=pe,i.CCInteger=pe;const me=t("CCFloat",new de("Float",0));i.Float=me,i.CCFloat=me;const fe=t("CCBoolean",new de("Boolean",!1));i.Boolean=fe,i.CCBoolean=fe;const ge=t("CCString",new de("String",""));function ve(t,e){return function(n,i){const s=`"${pt(n)}.${i}"`,r=he(n,i);let o=r.type;if(o===pe||o===me?o="Number":o!==ge&&o!==fe||(o=""+o),o!==t)return void x(3604,s);if(!r.hasOwnProperty("default"))return;const a=r.default;if(void 0===a)return;if(Array.isArray(a)||se(a))return;const c=typeof a,l=t.toLowerCase();if(c===l)if("object"===l){if(!a||a instanceof r.ctor)return;x(3605,s,pt(r.ctor))}else"Number"!==t&&x(3606,e,s,t);else{if("function"===c)return;t===ge.default&&null==a?x(3607,s):x(3611,e,s,c)}delete r.type}}i.String=ge,i.CCString=ge;var ye=Object.freeze({__proto__:null,DELIMETER:"$_$",createAttrsSingle:ce,createAttrs:le,attr:he,getClassAttrs:_e,setClassAttr:ue,PrimitiveType:de,CCInteger:pe,CCFloat:me,CCBoolean:fe,CCString:ge,getTypeChecker_ET:ve,getObjTypeChecker_ET:function(t){return function(e,n){ve("Object","type")(e,n);const s=_e(e)[n+"$_$default"],r=i.Class.getDefault(s);if(!Array.isArray(r)&&wt(t,i.ValueType)){const i=pt(t),r=yt('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',pt(e),n,i);s?h(r):x(3612,r,i,pt(e),n,i)}}}});const xe={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Se(t,e,n,i){if(!t.get&&!t.set&&t.hasOwnProperty("default")){const s="_N$"+e;t.get=function(){return this[s]},t.set=function(t){const e=this[s];this[s]=t,n.call(this,e)};const r={};i[s]=r;for(const e in xe){const n=xe[e];t.hasOwnProperty(e)&&(r[e]=t[e],n.canUsedInGet||delete t[e])}}}function Te(t,e,n,s){if(Array.isArray(e)){if(!(e.length>0))return T(5508,n,s);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=i.String:e===Boolean?t.type=i.Boolean:e===Number&&(t.type=i.Float))}function Ee(t,e,n){const i=t?{_short:!0}:{_short:!0,default:e};return n&&(i.type=n),i}function Ce(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return Ee(e,[],t);if("function"==typeof t){const n=t;return Ee(e,wt(n,i.ValueType)?new n:null,n)}return Ee(e,t instanceof de?t.default:t)}return null}let Ae=[];function be(){return Ae[Ae.length-1]}i._RF={push:function(t,e,n,i){void 0===n&&(n=e,e=""),Ae.push({uuid:e,script:n,module:t,exports:t.exports,beh:null,importMeta:i})},pop:function(){const t=Ae.pop(),e=t.module;let n=e.exports;if(n===t.exports){for(const t in n)return;e.exports=n=t.cls}},peek:be};const we={datas:null,push(t){if(this.datas)this.datas.push(t);else{this.datas=[t];const e=this;setTimeout(()=>{e.init()},0)}},init(){const t=this.datas;if(t){for(let e=0;e<t.length;++e){const n=t[e],i=n.cls;let s=n.props;"function"==typeof s&&(s=s());const r=pt(i);s?De(i,r,s,i.$super,n.mixins):T(3633,r)}this.datas=null}}};function Re(t,e,n,i){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,n),Le(t,i,e,n)}function Ie(t,e,n,i){const s=i.get;i.set,s&&(Le(t,i,e,n),ue(t,n,"serializable",!1))}function Pe(t){return"function"==typeof t?t():t}function Oe(t,e,n){for(const i in e)t.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(t,i,St(e,i))}function De(t,e,n,i,s){if(t.__props__=[],i&&i.__props__&&(t.__props__=i.__props__.slice()),s)for(let e=0;e<s.length;++e){const n=s[e];n.__props__&&(t.__props__=t.__props__.concat(n.__props__.filter(e=>t.__props__.indexOf(e)<0)))}if(n){!function(t,e){for(const n in t){let i=t[n];const s=Ce(i,!1);if(s&&(i=t[n]=s),i){const s=i.notify;s&&Se(i,n,s,t),"type"in i&&Te(i,i.type,e,n)}}}(n,e);for(const i in n){const s=n[i];s.get||s.set?Ie(t,e,i,s):Re(t,e,i,s)}}const r=_e(t);t.__values__=t.__props__.filter(t=>!1!==r[t+"$_$serializable"])}function Me(t){let e=t.name;const n=t.extends,s=t.mixins,r=function(t,e,n,s){const r=i.Component,o=be();if(o&&wt(e,r)){if(wt(o.cls,r))return T(3615),null;t=t||o.script}const a=function(t,e,n,i){const s=i.ctor,r=[s],o=s;lt(o,"__ctors__",r.length>0?r:null,!0);const a=o.prototype;if(e&&(o.$super=e),n){for(let t=n.length-1;t>=0;t--){const e=n[t];Oe(a,e.prototype),Me._isCCClass(e)&&Oe(_e(o),_e(e))}a.constructor=o}return Nt(t,o),o}(t,e,n,s);if(o)if(wt(e,r)){const t=o.uuid;t&&Dt(t,a),o.cls=a}else wt(o.cls,r)||(o.cls=a);return a}(e,n,s,t);e||(e=i.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);const o=t.properties;"function"==typeof o||n&&null===n.__props__||s&&s.some(t=>null===t.__props__)?(we.push({cls:r,props:o,mixins:s}),r.__props__=r.__values__=null):De(r,e,o,n,t.mixins);const a=t.editor;return a&&wt(n,i.Component)&&i.Component._registerEditorProps(r,a),r}Me._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__ctors__")},Me.fastDefine=function(t,e,n){Nt(t,e);const i=e.__props__=e.__values__=Object.keys(n),s=_e(e);for(let t=0;t<i.length;t++){const e=i[t];s[e+"$_$visible"]=!1,s[e+"$_$default"]=n[e]}},Me.Attr=ye,Me.attr=he,Me.getInheritanceChain=function(t){const e=[];for(;t=bt(t);)t!==Object&&e.push(t);return e};const Ne={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Le(t,e,n,i){let s=null,r="";function o(){return r=i+"$_$",s=_e(t)}"type"in e&&void 0===e.type&&x(3660,i,n);const a=e.type;a&&(Ne[a]?(s||o())[r+"type"]=a:"Object"===a||("object"==typeof a?jt.isEnum(a)?((s||o())[r+"type"]="Enum",s[r+"enumList"]=jt.getList(a)):kt.isBitMask(a)&&((s||o())[r+"type"]="BitMask",s[r+"bitmaskList"]=kt.getList(a)):"function"==typeof a&&((s||o())[r+"type"]="Object",s[r+"ctor"]=a))),"default"in e&&((s||o())[r+"default"]=e.default);const c=(t,n)=>{if(t in e){const i=e[t];typeof i===n&&((s||o())[r+t]=i)}};var l;e.editorOnly&&((s||o())[r+"editorOnly"]=!0),e.__noImplicit?(s||o())[r+"serializable"]=null!==(l=e.serializable)&&void 0!==l&&l:!1===e.serializable&&((s||o())[r+"serializable"]=!1),c("formerlySerializedAs","string");const h=e.range;h&&Array.isArray(h)&&h.length>=2&&((s||o())[r+"min"]=h[0],s[r+"max"]=h[1],h.length>2&&(s[r+"step"]=h[2])),c("min","number"),c("max","number"),c("step","number")}Me.isArray=function(t){return t=Pe(t),Array.isArray(t)},Me.getDefault=Pe,Me.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},Me.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,Me.getNewValueTypeCode=function(t){const e=pt(t),n=t.constructor;let i=`new ${e}(`;for(let e=0;e<n.__props__.length;e++)i+=t[n.__props__[e]],e<n.__props__.length-1&&(i+=",");return i+")"},i.Class=Me;const ze=Math.PI/180,Be=180/Math.PI,Fe=t("EPSILON",1e-6);function Ue(t,e){return Math.abs(t-e)<=Fe*Math.max(1,Math.abs(t),Math.abs(e))}function Ge(t,e,n){return n=n||Fe,Math.abs(t-e)<=n}function He(t,e,n){if(e>n){const t=e;e=n,n=t}return t<e?e:t>n?n:t}function Ve(t){return t<0?0:t>1?1:t}function ke(t,e,n){return t+(e-t)*n}function je(t){return t*ze}function We(t){return t*Be}const qe=t("random",Math.random);function Xe(t,e){return Math.random()*(e-t)+t}function Ye(t,e){return Math.floor(Xe(t,e))}function Ke(t){return(t=(9301*t+49297)%233280)/233280}function $e(t,e,n){return Ke(t)*(n-e)+e}function Ze(t,e,n){return Math.floor($e(t,e,n))}function Je(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function Qe(t,e){return t-Math.floor(t/e)*e}function tn(t,e){return t=Qe(t,2*e),e-Math.abs(t-e)}function en(t,e,n){return(n-t)/(e-t)}function nn(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function sn(t,e){return Math.abs(t)>Math.abs(e)?t:e}class rn extends Yt{static clone(t){return new rn(t.x,t.y)}static copy(t,e){return t.x=e.x,t.y=e.y,t}static set(t,e,n){return t.x=e,t.y=n,t}static add(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t}static subtract(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t}static multiply(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t}static divide(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t}static min(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t}static max(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t}static multiplyScalar(t,e,n){return t.x=e.x*n,t.y=e.y*n,t}static scaleAndAdd(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t}static distance(t,e){const n=e.x-t.x,i=e.y-t.y;return Math.sqrt(n*n+i*i)}static squaredDistance(t,e){const n=e.x-t.x,i=e.y-t.y;return n*n+i*i}static len(t){const e=t.x,n=t.y;return Math.sqrt(e*e+n*n)}static lengthSqr(t){const e=t.x,n=t.y;return e*e+n*n}static negate(t,e){return t.x=-e.x,t.y=-e.y,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t}static inverseSafe(t,e){const n=e.x,i=e.y;return Math.abs(n)<Fe?t.x=0:t.x=1/n,Math.abs(i)<Fe?t.y=0:t.y=1/i,t}static normalize(t,e){const n=e.x,i=e.y;let s=n*n+i*i;return s>0&&(s=1/Math.sqrt(s),t.x=n*s,t.y=i*s),t}static dot(t,e){return t.x*e.x+t.y*e.y}static cross(t,e,n){return t.x=t.y=0,t.z=e.x*n.y-e.y*n.x,t}static lerp(t,e,n,i){const s=e.x,r=e.y;return t.x=s+i*(n.x-s),t.y=r+i*(n.y-r),t}static random(t,e){e=e||1;const n=2*qe()*Math.PI;return t.x=Math.cos(n)*e,t.y=Math.sin(n)*e,t}static transformMat3(t,e,n){const i=e.x,s=e.y;return t.x=n.m00*i+n.m03*s+n.m06,t.y=n.m01*i+n.m04*s+n.m07,t}static transformMat4(t,e,n){const i=e.x,s=e.y;return t.x=n.m00*i+n.m04*s+n.m12,t.y=n.m01*i+n.m05*s+n.m13,t}static str(t){return`Vec2(${t.x}, ${t.y})`}static toArray(t,e,n=0){return t[n+0]=e.x,t[n+1]=e.y,t}static fromArray(t,e,n=0){return t.x=e[n+0],t.y=e[n+1],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y}static equals(t,e,n=Fe){return Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))}static angle(t,e){rn.normalize(on,t),rn.normalize(an,e);const n=rn.dot(on,an);return n>1?0:n<-1?Math.PI:Math.acos(n)}constructor(t,e){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0)}clone(){return new rn(this.x,this.y)}set(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this}equals(t,e=Fe){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))}equals2f(t,e,n=Fe){return Math.abs(this.x-t)<=n*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=n*Math.max(1,Math.abs(this.y),Math.abs(e))}strictEquals(t){return t&&this.x===t.x&&this.y===t.y}strictEquals2f(t,e){return this.x===t&&this.y===e}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}lerp(t,e){const n=this.x,i=this.y;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this}clampf(t,e){return this.x=He(this.x,t.x,e.x),this.y=He(this.y,t.y,e.y),this}add(t){return this.x+=t.x,this.y+=t.y,this}add2f(t,e){return this.x+=t,this.y+=e,this}subtract(t){return this.x-=t.x,this.y-=t.y,this}subtract2f(t,e){return this.x-=t,this.y-=e,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this}multiply2f(t,e){return this.x*=t,this.y*=e,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divide2f(t,e){return this.x/=t,this.y/=e,this}negative(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSqr(){return this.x*this.x+this.y*this.y}normalize(){const t=this.x,e=this.y;let n=t*t+e*e;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this}angle(t){const e=this.lengthSqr(),n=t.lengthSqr();if(0===e||0===n)return console.warn("Can't get angle between zero vector"),0;let i=this.dot(t)/Math.sqrt(e*n);return i=He(i,-1,1),Math.acos(i)}signAngle(t){const e=this.angle(t);return this.cross(t)<0?-e:e}rotate(t){const e=this.x,n=this.y,i=Math.sin(t),s=Math.cos(t);return this.x=s*e-i*n,this.y=i*e+s*n,this}project(t){const e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this}transformMat4(t){const e=this.x,n=this.y;return this.x=t.m00*e+t.m04*n+t.m12,this.y=t.m01*e+t.m05*n+t.m13,this}}t("Vec2",rn),rn.ZERO=Object.freeze(new rn(0,0)),rn.ONE=Object.freeze(new rn(1,1)),rn.NEG_ONE=Object.freeze(new rn(-1,-1)),rn.UNIT_X=Object.freeze(new rn(1,0)),rn.UNIT_Y=Object.freeze(new rn(0,1));const on=new rn,an=new rn;function cn(t,e){return new rn(t,e)}Me.fastDefine("cc.Vec2",rn,{x:0,y:0}),i.Vec2=rn,i.v2=cn;class ln extends Yt{static zero(t){return t.x=0,t.y=0,t.z=0,t}static clone(t){return new ln(t.x,t.y,t.z)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t}static set(t,e,n,i){return t.x=e,t.y=n,t.z=i,t}static add(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t}static subtract(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t}static multiply(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t}static divide(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t}static min(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t}static max(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t}static multiplyScalar(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t}static scaleAndAdd(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t}static distance(t,e){const n=e.x-t.x,i=e.y-t.y,s=e.z-t.z;return Math.sqrt(n*n+i*i+s*s)}static squaredDistance(t,e){const n=e.x-t.x,i=e.y-t.y,s=e.z-t.z;return n*n+i*i+s*s}static len(t){const e=t.x,n=t.y,i=t.z;return Math.sqrt(e*e+n*n+i*i)}static lengthSqr(t){const e=t.x,n=t.y,i=t.z;return e*e+n*n+i*i}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t}static invert(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t}static invertSafe(t,e){const n=e.x,i=e.y,s=e.z;return Math.abs(n)<Fe?t.x=0:t.x=1/n,Math.abs(i)<Fe?t.y=0:t.y=1/i,Math.abs(s)<Fe?t.z=0:t.z=1/s,t}static normalize(t,e){const n=e.x,i=e.y,s=e.z;let r=n*n+i*i+s*s;return r>0&&(r=1/Math.sqrt(r),t.x=n*r,t.y=i*r,t.z=s*r),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e,n){const{x:i,y:s,z:r}=e,{x:o,y:a,z:c}=n;return t.x=s*c-r*a,t.y=r*o-i*c,t.z=i*a-s*o,t}static lerp(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t}static random(t,e){e=e||1;const n=2*qe()*Math.PI,i=2*qe()-1,s=Math.sqrt(1-i*i);return t.x=s*Math.cos(n)*e,t.y=s*Math.sin(n)*e,t.z=i*e,t}static transformMat4(t,e,n){const i=e.x,s=e.y,r=e.z;let o=n.m03*i+n.m07*s+n.m11*r+n.m15;return o=o?Math.abs(1/o):1,t.x=(n.m00*i+n.m04*s+n.m08*r+n.m12)*o,t.y=(n.m01*i+n.m05*s+n.m09*r+n.m13)*o,t.z=(n.m02*i+n.m06*s+n.m10*r+n.m14)*o,t}static transformMat4Normal(t,e,n){const i=e.x,s=e.y,r=e.z;let o=n.m03*i+n.m07*s+n.m11*r;return o=o?Math.abs(1/o):1,t.x=(n.m00*i+n.m04*s+n.m08*r)*o,t.y=(n.m01*i+n.m05*s+n.m09*r)*o,t.z=(n.m02*i+n.m06*s+n.m10*r)*o,t}static transformMat3(t,e,n){const i=e.x,s=e.y,r=e.z;return t.x=i*n.m00+s*n.m03+r*n.m06,t.y=i*n.m01+s*n.m04+r*n.m07,t.z=i*n.m02+s*n.m05+r*n.m08,t}static transformAffine(t,e,n){const i=e.x,s=e.y,r=e.z;return t.x=n.m00*i+n.m04*s+n.m08*r+n.m12,t.y=n.m01*i+n.m05*s+n.m09*r+n.m13,t.x=n.m02*i+n.m06*s+n.m10*r+n.m14,t}static transformQuat(t,e,n){const i=n.w*e.x+n.y*e.z-n.z*e.y,s=n.w*e.y+n.z*e.x-n.x*e.z,r=n.w*e.z+n.x*e.y-n.y*e.x,o=-n.x*e.x-n.y*e.y-n.z*e.z;return t.x=i*n.w+o*-n.x+s*-n.z-r*-n.y,t.y=s*n.w+o*-n.y+r*-n.x-i*-n.z,t.z=r*n.w+o*-n.z+i*-n.y-s*-n.x,t}static transformRTS(t,e,n,i,s){const r=e.x*s.x,o=e.y*s.y,a=e.z*s.z,c=n.w*r+n.y*a-n.z*o,l=n.w*o+n.z*r-n.x*a,h=n.w*a+n.x*o-n.y*r,_=-n.x*r-n.y*o-n.z*a;return t.x=c*n.w+_*-n.x+l*-n.z-h*-n.y+i.x,t.y=l*n.w+_*-n.y+h*-n.x-c*-n.z+i.y,t.z=h*n.w+_*-n.z+c*-n.y-l*-n.x+i.z,t}static transformInverseRTS(t,e,n,i,s){const r=e.x-i.x,o=e.y-i.y,a=e.z-i.z,c=n.w*r-n.y*a+n.z*o,l=n.w*o-n.z*r+n.x*a,h=n.w*a-n.x*o+n.y*r,_=n.x*r+n.y*o+n.z*a;return t.x=(c*n.w+_*n.x+l*n.z-h*n.y)/s.x,t.y=(l*n.w+_*n.y+h*n.x-c*n.z)/s.y,t.z=(h*n.w+_*n.z+c*n.y-l*n.x)/s.z,t}static rotateX(t,e,n,i){const s=e.x-n.x,r=e.y-n.y,o=e.z-n.z,a=Math.cos(i),c=Math.sin(i),l=s,h=r*a-o*c,_=r*c+o*a;return t.x=l+n.x,t.y=h+n.y,t.z=_+n.z,t}static rotateY(t,e,n,i){const s=e.x-n.x,r=e.y-n.y,o=e.z-n.z,a=Math.cos(i),c=Math.sin(i),l=o*c+s*a,h=r,_=o*a-s*c;return t.x=l+n.x,t.y=h+n.y,t.z=_+n.z,t}static rotateZ(t,e,n,i){const s=e.x-n.x,r=e.y-n.y,o=e.z-n.z,a=Math.cos(i),c=Math.sin(i),l=s*a-r*c,h=s*c+r*a,_=o;return t.x=l+n.x,t.y=h+n.y,t.z=_+n.z,t}static toArray(t,e,n=0){return t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t}static fromArray(t,e,n=0){return t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z}static equals(t,e,n=Fe){const{x:i,y:s,z:r}=t,{x:o,y:a,z:c}=e;return Math.abs(i-o)<=n*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(s-a)<=n*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(r-c)<=n*Math.max(1,Math.abs(r),Math.abs(c))}static angle(t,e){ln.normalize(hn,t),ln.normalize(_n,e);const n=ln.dot(hn,_n);return n>1?0:n<-1?Math.PI:Math.acos(n)}static projectOnPlane(t,e,n){return ln.subtract(t,e,ln.project(t,e,n))}static project(t,e,n){const i=ln.lengthSqr(n);return i<1e-6?ln.set(t,0,0,0):ln.multiplyScalar(t,n,ln.dot(e,n)/i)}constructor(t,e,n){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=n||0)}clone(){return new ln(this.x,this.y,this.z)}set(t,e,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t||0,this.y=e||0,this.z=n||0),this}equals(t,e=Fe){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))}equals3f(t,e,n,i=Fe){return Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))}strictEquals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}strictEquals3f(t,e,n){return this.x===t&&this.y===e&&this.z===n}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)})`}lerp(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}add3f(t,e,n){return this.x+=t,this.y+=e,this.z+=n,this}subtract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subtract3f(t,e,n){return this.x-=t,this.y-=e,this.z-=n,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiply3f(t,e,n){return this.x*=t,this.y*=e,this.z*=n,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divide3f(t,e,n){return this.x/=t,this.y/=e,this.z/=n,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}clampf(t,e){return this.x=He(this.x,t.x,e.x),this.y=He(this.y,t.y,e.y),this.z=He(this.z,t.z,e.z),this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}cross(t){const{x:e,y:n,z:i}=this,{x:s,y:r,z:o}=t;return this.x=n*o-i*r,this.y=i*s-e*o,this.z=e*r-n*s,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSqr(){return this.x*this.x+this.y*this.y+this.z*this.z}normalize(){const t=this.x,e=this.y,n=this.z;let i=t*t+e*e+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=t*i,this.y=e*i,this.z=n*i),this}transformMat4(t){const e=this.x,n=this.y,i=this.z;let s=t.m03*e+t.m07*n+t.m11*i+t.m15;return s=s?1/s:1,this.x=(t.m00*e+t.m04*n+t.m08*i+t.m12)*s,this.y=(t.m01*e+t.m05*n+t.m09*i+t.m13)*s,this.z=(t.m02*e+t.m06*n+t.m10*i+t.m14)*s,this}}t("Vec3",ln),ln.UNIT_X=Object.freeze(new ln(1,0,0)),ln.UNIT_Y=Object.freeze(new ln(0,1,0)),ln.UNIT_Z=Object.freeze(new ln(0,0,1)),ln.RIGHT=Object.freeze(new ln(1,0,0)),ln.UP=Object.freeze(new ln(0,1,0)),ln.FORWARD=Object.freeze(new ln(0,0,-1)),ln.ZERO=Object.freeze(new ln(0,0,0)),ln.ONE=Object.freeze(new ln(1,1,1)),ln.NEG_ONE=Object.freeze(new ln(-1,-1,-1));const hn=new ln,_n=new ln;function un(t,e,n){return new ln(t,e,n)}Me.fastDefine("cc.Vec3",ln,{x:0,y:0,z:0}),i.Vec3=ln,i.v3=un;class dn extends Yt{static clone(t){return new dn(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,n,i,s){return t.x=e,t.y=n,t.z=i,t.w=s,t}static add(t,e,n){return t.x=e.x+n.x,t.y=e.y+n.y,t.z=e.z+n.z,t.w=e.w+n.w,t}static subtract(t,e,n){return t.x=e.x-n.x,t.y=e.y-n.y,t.z=e.z-n.z,t.w=e.w-n.w,t}static multiply(t,e,n){return t.x=e.x*n.x,t.y=e.y*n.y,t.z=e.z*n.z,t.w=e.w*n.w,t}static divide(t,e,n){return t.x=e.x/n.x,t.y=e.y/n.y,t.z=e.z/n.z,t.w=e.w/n.w,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t}static min(t,e,n){return t.x=Math.min(e.x,n.x),t.y=Math.min(e.y,n.y),t.z=Math.min(e.z,n.z),t.w=Math.min(e.w,n.w),t}static max(t,e,n){return t.x=Math.max(e.x,n.x),t.y=Math.max(e.y,n.y),t.z=Math.max(e.z,n.z),t.w=Math.max(e.w,n.w),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t}static multiplyScalar(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t}static scaleAndAdd(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t}static distance(t,e){const n=e.x-t.x,i=e.y-t.y,s=e.z-t.z,r=e.w-t.w;return Math.sqrt(n*n+i*i+s*s+r*r)}static squaredDistance(t,e){const n=e.x-t.x,i=e.y-t.y,s=e.z-t.z,r=e.w-t.w;return n*n+i*i+s*s+r*r}static len(t){const e=t.x,n=t.y,i=t.z,s=t.w;return Math.sqrt(e*e+n*n+i*i+s*s)}static lengthSqr(t){const e=t.x,n=t.y,i=t.z,s=t.w;return e*e+n*n+i*i+s*s}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t}static inverseSafe(t,e){const n=e.x,i=e.y,s=e.z,r=e.w;return Math.abs(n)<Fe?t.x=0:t.x=1/n,Math.abs(i)<Fe?t.y=0:t.y=1/i,Math.abs(s)<Fe?t.z=0:t.z=1/s,Math.abs(r)<Fe?t.w=0:t.w=1/r,t}static normalize(t,e){const n=e.x,i=e.y,s=e.z,r=e.w;let o=n*n+i*i+s*s+r*r;return o>0&&(o=1/Math.sqrt(o),t.x=n*o,t.y=i*o,t.z=s*o,t.w=r*o),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t}static random(t,e){e=e||1;const n=2*qe()*Math.PI,i=2*qe()-1,s=Math.sqrt(1-i*i);return t.x=s*Math.cos(n)*e,t.y=s*Math.sin(n)*e,t.z=i*e,t.w=0,t}static transformMat4(t,e,n){const i=e.x,s=e.y,r=e.z,o=e.w;return t.x=n.m00*i+n.m04*s+n.m08*r+n.m12*o,t.y=n.m01*i+n.m05*s+n.m09*r+n.m13*o,t.z=n.m02*i+n.m06*s+n.m10*r+n.m14*o,t.w=n.m03*i+n.m07*s+n.m11*r+n.m15*o,t}static transformAffine(t,e,n){const i=e.x,s=e.y,r=e.z,o=e.w;return t.x=n.m00*i+n.m01*s+n.m02*r+n.m03*o,t.y=n.m04*i+n.m05*s+n.m06*r+n.m07*o,t.x=n.m08*i+n.m09*s+n.m10*r+n.m11*o,t.w=e.w,t}static transformQuat(t,e,n){const{x:i,y:s,z:r}=e,o=n.x,a=n.y,c=n.z,l=n.w,h=l*i+a*r-c*s,_=l*s+c*i-o*r,u=l*r+o*s-a*i,d=-o*i-a*s-c*r;return t.x=h*l+d*-o+_*-c-u*-a,t.y=_*l+d*-a+u*-o-h*-c,t.z=u*l+d*-c+h*-a-_*-o,t.w=e.w,t}static toArray(t,e,n=0){return t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t}static fromArray(t,e,n=0){return t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,n=Fe){return Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))}constructor(t,e,n,i){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=i||0)}clone(){return new dn(this.x,this.y,this.z,this.w)}set(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=i||0),this}equals(t,e=Fe){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))}equals4f(t,e,n,i,s=Fe){return Math.abs(this.x-t)<=s*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=s*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-n)<=s*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=s*Math.max(1,Math.abs(this.w),Math.abs(i))}strictEquals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}strictEquals4f(t,e,n,i){return this.x===t&&this.y===e&&this.z===n&&this.w===i}lerp(t,e){const n=this.x,i=this.y,s=this.z,r=this.w;return this.x=n+e*(t.x-n),this.y=i+e*(t.y-i),this.z=s+e*(t.z-s),this.w=r+e*(t.w-r),this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)}, ${this.w.toFixed(2)})`}clampf(t,e){return this.x=He(this.x,t.x,e.x),this.y=He(this.y,t.y,e.y),this.z=He(this.z,t.z,e.z),this.w=He(this.w,t.w,e.w),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add4f(t,e,n,i){return this.x+=t,this.y+=e,this.z+=n,this.w+=i,this}subtract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subtract4f(t,e,n,i){return this.x-=t,this.y-=e,this.z-=n,this.w-=i,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiply4f(t,e,n,i){return this.x*=t,this.y*=e,this.z*=n,this.w*=i,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}divide4f(t,e,n,i){return this.x/=t,this.y/=e,this.z/=n,this.w/=i,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}cross(t){const{x:e,y:n,z:i}=this,{x:s,y:r,z:o}=t;return this.x=n*o-i*r,this.y=i*s-e*o,this.z=e*r-n*s,this}length(){const t=this.x,e=this.y,n=this.z,i=this.w;return Math.sqrt(t*t+e*e+n*n+i*i)}lengthSqr(){const t=this.x,e=this.y,n=this.z,i=this.w;return t*t+e*e+n*n+i*i}normalize(){const t=this.x,e=this.y,n=this.z,i=this.w;let s=t*t+e*e+n*n+i*i;return s>0&&(s=1/Math.sqrt(s),this.x=t*s,this.y=e*s,this.z=n*s,this.w=i*s),this}transformMat4(t){const e=this.x,n=this.y,i=this.z,s=this.w;return this.x=t.m00*e+t.m04*n+t.m08*i+t.m12*s,this.y=t.m01*e+t.m05*n+t.m09*i+t.m13*s,this.z=t.m02*e+t.m06*n+t.m10*i+t.m14*s,this.w=t.m03*e+t.m07*n+t.m11*i+t.m15*s,this}}function pn(t,e,n,i){return new dn(t,e,n,i)}t("Vec4",dn),dn.ZERO=Object.freeze(new dn(0,0,0,0)),dn.ONE=Object.freeze(new dn(1,1,1,1)),dn.NEG_ONE=Object.freeze(new dn(-1,-1,-1,-1)),Me.fastDefine("cc.Vec4",dn,{x:0,y:0,z:0,w:0}),i.Vec4=dn,i.v4=pn;class mn extends Yt{static clone(t){return new mn(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static set(t,e,n,i,s,r,o,a,c,l){return t.m00=e,t.m01=n,t.m02=i,t.m03=s,t.m04=r,t.m05=o,t.m06=a,t.m07=c,t.m08=l,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static transpose(t,e){if(t===e){const n=e.m01,i=e.m02,s=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=n,t.m05=e.m07,t.m06=i,t.m07=s}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t}static invert(t,e){const n=e.m00,i=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=h*o-a*l,u=-h*r+a*c,d=l*r-o*c;let p=n*_+i*u+s*d;return 0===p?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(p=1/p,t.m00=_*p,t.m01=(-h*i+s*l)*p,t.m02=(a*i-s*o)*p,t.m03=u*p,t.m04=(h*n-s*c)*p,t.m05=(-a*n+s*r)*p,t.m06=d*p,t.m07=(-l*n+i*c)*p,t.m08=(o*n-i*r)*p,t)}static determinant(t){const e=t.m00,n=t.m01,i=t.m02,s=t.m03,r=t.m04,o=t.m05,a=t.m06,c=t.m07,l=t.m08;return e*(l*r-o*c)+n*(-l*s+o*a)+i*(c*s-r*a)}static multiply(t,e,n){const i=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=n.m00,d=n.m01,p=n.m02,m=n.m03,f=n.m04,g=n.m05,v=n.m06,y=n.m07,x=n.m08;return t.m00=u*i+d*o+p*l,t.m01=u*s+d*a+p*h,t.m02=u*r+d*c+p*_,t.m03=m*i+f*o+g*l,t.m04=m*s+f*a+g*h,t.m05=m*r+f*c+g*_,t.m06=v*i+y*o+x*l,t.m07=v*s+y*a+x*h,t.m08=v*r+y*c+x*_,t}static multiplyMat4(t,e,n){const i=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=n.m00,d=n.m01,p=n.m02,m=n.m04,f=n.m05,g=n.m06,v=n.m08,y=n.m09,x=n.m10;return t.m00=u*i+d*o+p*l,t.m01=u*s+d*a+p*h,t.m02=u*r+d*c+p*_,t.m03=m*i+f*o+g*l,t.m04=m*s+f*a+g*h,t.m05=m*r+f*c+g*_,t.m06=v*i+y*o+x*l,t.m07=v*s+y*a+x*h,t.m08=v*r+y*c+x*_,t}static transform(t,e,n){const i=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=n.x,d=n.y;return t.m00=i,t.m01=s,t.m02=r,t.m03=o,t.m04=a,t.m05=c,t.m06=u*i+d*o+l,t.m07=u*s+d*a+h,t.m08=u*r+d*c+_,t}static scale(t,e,n){const i=n.x,s=n.y;return t.m00=i*e.m00,t.m01=i*e.m01,t.m02=i*e.m02,t.m03=s*e.m03,t.m04=s*e.m04,t.m05=s*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static rotate(t,e,n){const i=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=Math.sin(n),d=Math.cos(n);return t.m00=d*i+u*o,t.m01=d*s+u*a,t.m02=d*r+u*c,t.m03=d*o-u*i,t.m04=d*a-u*s,t.m05=d*c-u*r,t.m06=l,t.m07=h,t.m08=_,t}static fromMat4(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t}static fromViewUp(t,e,n){return ln.lengthSqr(e)<Fe*Fe?(mn.identity(t),t):(n=n||ln.UNIT_Y,ln.normalize(fn,ln.cross(fn,n,e)),ln.lengthSqr(fn)<Fe*Fe?(mn.identity(t),t):(ln.cross(gn,e,fn),mn.set(t,fn.x,fn.y,fn.z,gn.x,gn.y,gn.z,e.x,e.y,e.z),t))}static fromTranslation(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t}static fromScaling(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromRotation(t,e){const n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=-n,t.m04=i,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromQuat(t,e){const n=e.x,i=e.y,s=e.z,r=e.w,o=n+n,a=i+i,c=s+s,l=n*o,h=i*o,_=i*a,u=s*o,d=s*a,p=s*c,m=r*o,f=r*a,g=r*c;return t.m00=1-_-p,t.m03=h-g,t.m06=u+f,t.m01=h+g,t.m04=1-l-p,t.m07=d-m,t.m02=u-f,t.m05=d+m,t.m08=1-l-_,t}static inverseTransposeMat4(t,e){const n=e.m00,i=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=e.m09,u=e.m10,d=e.m11,p=e.m12,m=e.m13,f=e.m14,g=e.m15,v=n*a-i*o,y=n*c-s*o,x=n*l-r*o,S=i*c-s*a,T=i*l-r*a,E=s*l-r*c,C=h*m-_*p,A=h*f-u*p,b=h*g-d*p,w=_*f-u*m,R=_*g-d*m,I=u*g-d*f;let P=v*I-y*R+x*w+S*b-T*A+E*C;return P?(P=1/P,t.m00=(a*I-c*R+l*w)*P,t.m01=(c*b-o*I-l*A)*P,t.m02=(o*R-a*b+l*C)*P,t.m03=(s*R-i*I-r*w)*P,t.m04=(n*I-s*b+r*A)*P,t.m05=(i*b-n*R-r*C)*P,t.m06=(m*E-f*T+g*S)*P,t.m07=(f*x-p*E-g*y)*P,t.m08=(p*T-m*x+g*v)*P,t):null}static toArray(t,e,n=0){return t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t}static fromArray(t,e,n=0){return t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t}static add(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t}static subtract(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t}static multiplyScalar(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t}static multiplyScalarAndAdd(t,e,n,i){return t.m00=n.m00*i+e.m00,t.m01=n.m01*i+e.m01,t.m02=n.m02*i+e.m02,t.m03=n.m03*i+e.m03,t.m04=n.m04*i+e.m04,t.m05=n.m05*i+e.m05,t.m06=n.m06*i+e.m06,t.m07=n.m07*i+e.m07,t.m08=n.m08*i+e.m08,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08}static equals(t,e,n=Fe){return Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))}constructor(t=1,e=0,n=0,i=0,s=1,r=0,o=0,a=0,c=1){super(),"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=n,this.m03=i,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=c)}clone(){const t=this;return new mn(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)}set(t=1,e=0,n=0,i=0,s=1,r=0,o=0,a=0,c=1){return"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08):(this.m00=t,this.m01=e,this.m02=n,this.m03=i,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=c),this}equals(t,e=Fe){return Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))}strictEquals(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08}toString(){const t=this;return`[\n${t.m00}, ${t.m01}, ${t.m02},\n${t.m03},\n${t.m04}, ${t.m05},\n${t.m06}, ${t.m07},\n${t.m08}\n]`}identity(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this}transpose(){const t=this.m01,e=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=t,this.m05=this.m07,this.m06=e,this.m07=n,this}invert(){const t=this.m00,e=this.m01,n=this.m02,i=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,c=this.m08,l=c*s-r*a,h=-c*i+r*o,_=a*i-s*o;let u=t*l+e*h+n*_;return 0===u?(this.set(0,0,0,0,0,0,0,0,0),this):(u=1/u,this.m00=l*u,this.m01=(-c*e+n*a)*u,this.m02=(r*e-n*s)*u,this.m03=h*u,this.m04=(c*t-n*o)*u,this.m05=(-r*t+n*i)*u,this.m06=_*u,this.m07=(-a*t+e*o)*u,this.m08=(s*t-e*i)*u,this)}determinant(){const t=this.m00,e=this.m01,n=this.m02,i=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,c=this.m08;return t*(c*s-r*a)+e*(-c*i+r*o)+n*(a*i-s*o)}add(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this}subtract(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this}multiply(t){const e=this.m00,n=this.m01,i=this.m02,s=this.m03,r=this.m04,o=this.m05,a=this.m06,c=this.m07,l=this.m08,h=t.m00,_=t.m01,u=t.m02,d=t.m03,p=t.m04,m=t.m05,f=t.m06,g=t.m07,v=t.m08;return this.m00=h*e+_*s+u*a,this.m01=h*n+_*r+u*c,this.m02=h*i+_*o+u*l,this.m03=d*e+p*s+m*a,this.m04=d*n+p*r+m*c,this.m05=d*i+p*o+m*l,this.m06=f*e+g*s+v*a,this.m07=f*n+g*r+v*c,this.m08=f*i+g*o+v*l,this}multiplyScalar(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this}scale(t){const e=t.x,n=t.y;return this.m00=e*this.m00,this.m01=e*this.m01,this.m02=e*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this}rotate(t){const e=this.m00,n=this.m01,i=this.m02,s=this.m03,r=this.m04,o=this.m05,a=this.m06,c=this.m07,l=this.m08,h=Math.sin(t),_=Math.cos(t);return this.m00=_*e+h*s,this.m01=_*n+h*r,this.m02=_*i+h*o,this.m03=_*s-h*e,this.m04=_*r-h*n,this.m05=_*o-h*i,this.m06=a,this.m07=c,this.m08=l,this}fromQuat(t){const e=t.x,n=t.y,i=t.z,s=t.w,r=e+e,o=n+n,a=i+i,c=e*r,l=n*r,h=n*o,_=i*r,u=i*o,d=i*a,p=s*r,m=s*o,f=s*a;return this.m00=1-h-d,this.m03=l-f,this.m06=_+m,this.m01=l+f,this.m04=1-c-d,this.m07=u-p,this.m02=_-m,this.m05=u+p,this.m08=1-c-h,this}}t("Mat3",mn),mn.IDENTITY=Object.freeze(new mn);const fn=new ln,gn=new ln;Me.fastDefine("cc.Mat3",mn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),i.Mat3=mn;class vn extends Yt{static clone(t){return new vn(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,n,i,s){return t.x=e,t.y=n,t.z=i,t.w=s,t}static identity(t){return t.x=0,t.y=0,t.z=0,t.w=1,t}static rotationTo(t,e,n){const i=ln.dot(e,n);return i<-.999999?(ln.cross(Sn,ln.UNIT_X,e),Sn.length()<1e-6&&ln.cross(Sn,ln.UNIT_Y,e),ln.normalize(Sn,Sn),vn.fromAxisAngle(t,Sn,Math.PI),t):i>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(ln.cross(Sn,e,n),t.x=Sn.x,t.y=Sn.y,t.z=Sn.z,t.w=1+i,vn.normalize(t,t))}static getAxisAngle(t,e){const n=2*Math.acos(e.w),i=Math.sin(n/2);return 0!==i?(t.x=e.x/i,t.y=e.y/i,t.z=e.z/i):(t.x=1,t.y=0,t.z=0),n}static multiply(t,e,n){const i=e.x*n.w+e.w*n.x+e.y*n.z-e.z*n.y,s=e.y*n.w+e.w*n.y+e.z*n.x-e.x*n.z,r=e.z*n.w+e.w*n.z+e.x*n.y-e.y*n.x,o=e.w*n.w-e.x*n.x-e.y*n.y-e.z*n.z;return t.x=i,t.y=s,t.z=r,t.w=o,t}static multiplyScalar(t,e,n){return t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n,t}static scaleAndAdd(t,e,n,i){return t.x=e.x+n.x*i,t.y=e.y+n.y*i,t.z=e.z+n.z*i,t.w=e.w+n.w*i,t}static rotateX(t,e,n){n*=.5;const i=Math.sin(n),s=Math.cos(n),{x:r,y:o,z:a,w:c}=e;return t.x=r*s+c*i,t.y=o*s+a*i,t.z=a*s-o*i,t.w=c*s-r*i,t}static rotateY(t,e,n){n*=.5;const i=Math.sin(n),s=Math.cos(n),{x:r,y:o,z:a,w:c}=e;return t.x=r*s-a*i,t.y=o*s+c*i,t.z=a*s+r*i,t.w=c*s-o*i,t}static rotateZ(t,e,n){n*=.5;const i=Math.sin(n),s=Math.cos(n),{x:r,y:o,z:a,w:c}=e;return t.x=r*s+o*i,t.y=o*s-r*i,t.z=a*s+c*i,t.w=c*s-a*i,t}static rotateAround(t,e,n,i){return vn.invert(yn,e),ln.transformQuat(Sn,n,yn),vn.fromAxisAngle(yn,Sn,i),vn.multiply(t,e,yn),t}static rotateAroundLocal(t,e,n,i){return vn.fromAxisAngle(yn,n,i),vn.multiply(t,e,yn),t}static calculateW(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,n,i){return t.x=e.x+i*(n.x-e.x),t.y=e.y+i*(n.y-e.y),t.z=e.z+i*(n.z-e.z),t.w=e.w+i*(n.w-e.w),t}static slerp(t,e,n,i){let s=0,r=0,o=n.x,a=n.y,c=n.z,l=n.w,h=e.x*n.x+e.y*n.y+e.z*n.z+e.w*n.w;if(h<0&&(h=-h,o=-o,a=-a,c=-c,l=-l),1-h>1e-6){const t=Math.acos(h),e=Math.sin(t);s=Math.sin((1-i)*t)/e,r=Math.sin(i*t)/e}else s=1-i,r=i;return t.x=s*e.x+r*o,t.y=s*e.y+r*a,t.z=s*e.z+r*c,t.w=s*e.w+r*l,t}static sqlerp(t,e,n,i,s,r){return vn.slerp(yn,e,s,r),vn.slerp(xn,n,i,r),vn.slerp(t,yn,xn,2*r*(1-r)),t}static invert(t,e){const n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,i=n?1/n:0;return t.x=-e.x*i,t.y=-e.y*i,t.z=-e.z*i,t.w=e.w*i,t}static conjugate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t}static len(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)}static lengthSqr(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w}static normalize(t,e){let n=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return n>0&&(n=1/Math.sqrt(n),t.x=e.x*n,t.y=e.y*n,t.z=e.z*n,t.w=e.w*n),t}static fromAxes(t,e,n,i){return mn.set(Tn,e.x,e.y,e.z,n.x,n.y,n.z,i.x,i.y,i.z),vn.normalize(t,vn.fromMat3(t,Tn))}static fromViewUp(t,e,n){return mn.fromViewUp(Tn,e,n),vn.normalize(t,vn.fromMat3(t,Tn))}static fromAxisAngle(t,e,n){n*=.5;const i=Math.sin(n);return t.x=i*e.x,t.y=i*e.y,t.z=i*e.z,t.w=Math.cos(n),t}static fromMat3(t,e){const{m00:n,m03:i,m06:s,m01:r,m04:o,m07:a,m02:c,m05:l,m08:h}=e,_=n+o+h;if(_>0){const e=.5/Math.sqrt(_+1);t.w=.25/e,t.x=(l-a)*e,t.y=(s-c)*e,t.z=(r-i)*e}else if(n>o&&n>h){const e=2*Math.sqrt(1+n-o-h);t.w=(l-a)/e,t.x=.25*e,t.y=(i+r)/e,t.z=(s+c)/e}else if(o>h){const e=2*Math.sqrt(1+o-n-h);t.w=(s-c)/e,t.x=(i+r)/e,t.y=.25*e,t.z=(a+l)/e}else{const e=2*Math.sqrt(1+h-n-o);t.w=(r-i)/e,t.x=(s+c)/e,t.y=(a+l)/e,t.z=.25*e}return t}static fromEuler(t,e,n,i){e*=En,n*=En,i*=En;const s=Math.sin(e),r=Math.cos(e),o=Math.sin(n),a=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return t.x=s*a*l+r*o*c,t.y=r*o*l+s*a*c,t.z=r*a*c-s*o*l,t.w=r*a*l-s*o*c,t}static fromAngleZ(t,e){return e*=En,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t}static toAxisX(t,e){const n=2*e.y,i=2*e.z;return t.x=1-n*e.y-i*e.z,t.y=n*e.x+i*e.w,t.z=i*e.x+n*e.w,t}static toAxisY(t,e){const n=2*e.x,i=2*e.y,s=2*e.z;return t.x=i*e.x-s*e.w,t.y=1-n*e.x-s*e.z,t.z=s*e.y+n*e.w,t}static toAxisZ(t,e){const n=2*e.x,i=2*e.y,s=2*e.z;return t.x=s*e.x-i*e.w,t.y=s*e.y-n*e.w,t.z=1-n*e.x-i*e.y,t}static toEuler(t,e,n){const{x:i,y:s,z:r,w:o}=e;let a=0,c=0,l=0;const h=i*s+r*o;if(h>.499999)a=0,c=We(2*Math.atan2(i,o)),l=90;else if(h<-.499999)a=0,c=-We(2*Math.atan2(i,o)),l=-90;else{const t=i*i,e=s*s,_=r*r;a=We(Math.atan2(2*i*o-2*s*r,1-2*t-2*_)),c=We(Math.atan2(2*s*o-2*i*r,1-2*e-2*_)),l=We(Math.asin(2*h)),n&&(a=-180*Math.sign(a+1e-6)+a,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return t.x=a,t.y=c,t.z=l,t}static toArray(t,e,n=0){return t[n+0]=e.x,t[n+1]=e.y,t[n+2]=e.z,t[n+3]=e.w,t}static fromArray(t,e,n=0){return t.x=e[n+0],t.y=e[n+1],t.z=e[n+2],t.w=e[n+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,n=Fe){return Math.abs(t.x-e.x)<=n*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=n*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=n*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=n*Math.max(1,Math.abs(t.w),Math.abs(e.w))}constructor(t,e,n,i){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=null!=i?i:1)}clone(){return new vn(this.x,this.y,this.z,this.w)}set(t,e,n,i){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=n||0,this.w=null!=i?i:1),this}equals(t,e=Fe){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))}strictEquals(t){return t&&this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}getEulerAngles(t){return vn.toEuler(t,this)}lerp(t,e){return this.x+=e*(t.x-this.x),this.y+=e*(t.y-this.y),this.z+=e*(t.z-this.z),this.w+=e*(t.w-this.w),this}slerp(t,e){return vn.slerp(this,this,t,e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSqr(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}}t("Quat",vn),vn.IDENTITY=Object.freeze(new vn);const yn=new vn,xn=new vn,Sn=new ln,Tn=new mn,En=.5*Math.PI/180;function Cn(t=0,e=0,n=0,i=1){return new vn(t,e,n,i)}Me.fastDefine("cc.Quat",vn,{x:0,y:0,z:0,w:1}),i.Quat=vn,i.quat=Cn;const An=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]);class bn extends Yt{static clone(t){return new bn(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static set(t,e,n,i,s,r,o,a,c,l,h,_,u,d,p,m,f){return t.m00=e,t.m01=n,t.m02=i,t.m03=s,t.m04=r,t.m05=o,t.m06=a,t.m07=c,t.m08=l,t.m09=h,t.m10=_,t.m11=u,t.m12=d,t.m13=p,t.m14=m,t.m15=f,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static transpose(t,e){if(t===e){const n=e.m01,i=e.m02,s=e.m03,r=e.m06,o=e.m07,a=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=n,t.m06=e.m09,t.m07=e.m13,t.m08=i,t.m09=r,t.m11=e.m14,t.m12=s,t.m13=o,t.m14=a}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t}static invert(t,e){const n=e.m00,i=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=e.m09,u=e.m10,d=e.m11,p=e.m12,m=e.m13,f=e.m14,g=e.m15,v=n*a-i*o,y=n*c-s*o,x=n*l-r*o,S=i*c-s*a,T=i*l-r*a,E=s*l-r*c,C=h*m-_*p,A=h*f-u*p,b=h*g-d*p,w=_*f-u*m,R=_*g-d*m,I=u*g-d*f;let P=v*I-y*R+x*w+S*b-T*A+E*C;return 0===P?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(P=1/P,t.m00=(a*I-c*R+l*w)*P,t.m01=(s*R-i*I-r*w)*P,t.m02=(m*E-f*T+g*S)*P,t.m03=(u*T-_*E-d*S)*P,t.m04=(c*b-o*I-l*A)*P,t.m05=(n*I-s*b+r*A)*P,t.m06=(f*x-p*E-g*y)*P,t.m07=(h*E-u*x+d*y)*P,t.m08=(o*R-a*b+l*C)*P,t.m09=(i*b-n*R-r*C)*P,t.m10=(p*T-m*x+g*v)*P,t.m11=(_*x-h*T-d*v)*P,t.m12=(a*A-o*w-c*C)*P,t.m13=(n*w-i*A+s*C)*P,t.m14=(m*y-p*S-f*v)*P,t.m15=(h*S-_*y+u*v)*P,t)}static determinant(t){const e=t.m00,n=t.m01,i=t.m02,s=t.m03,r=t.m04,o=t.m05,a=t.m06,c=t.m07,l=t.m08,h=t.m09,_=t.m10,u=t.m11,d=t.m12,p=t.m13,m=t.m14,f=t.m15;return(e*o-n*r)*(_*f-u*m)-(e*a-i*r)*(h*f-u*p)+(e*c-s*r)*(h*m-_*p)+(n*a-i*o)*(l*f-u*d)-(n*c-s*o)*(l*m-_*d)+(i*c-s*a)*(l*p-h*d)}static multiply(t,e,n){const i=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,c=e.m05,l=e.m06,h=e.m07,_=e.m08,u=e.m09,d=e.m10,p=e.m11,m=e.m12,f=e.m13,g=e.m14,v=e.m15;let y=n.m00,x=n.m01,S=n.m02,T=n.m03;return t.m00=y*i+x*a+S*_+T*m,t.m01=y*s+x*c+S*u+T*f,t.m02=y*r+x*l+S*d+T*g,t.m03=y*o+x*h+S*p+T*v,y=n.m04,x=n.m05,S=n.m06,T=n.m07,t.m04=y*i+x*a+S*_+T*m,t.m05=y*s+x*c+S*u+T*f,t.m06=y*r+x*l+S*d+T*g,t.m07=y*o+x*h+S*p+T*v,y=n.m08,x=n.m09,S=n.m10,T=n.m11,t.m08=y*i+x*a+S*_+T*m,t.m09=y*s+x*c+S*u+T*f,t.m10=y*r+x*l+S*d+T*g,t.m11=y*o+x*h+S*p+T*v,y=n.m12,x=n.m13,S=n.m14,T=n.m15,t.m12=y*i+x*a+S*_+T*m,t.m13=y*s+x*c+S*u+T*f,t.m14=y*r+x*l+S*d+T*g,t.m15=y*o+x*h+S*p+T*v,t}static transform(t,e,n){const i=n.x,s=n.y,r=n.z;if(e===t)t.m12=e.m00*i+e.m04*s+e.m08*r+e.m12,t.m13=e.m01*i+e.m05*s+e.m09*r+e.m13,t.m14=e.m02*i+e.m06*s+e.m10*r+e.m14,t.m15=e.m03*i+e.m07*s+e.m11*r+e.m15;else{const n=e.m00,o=e.m01,a=e.m02,c=e.m03,l=e.m04,h=e.m05,_=e.m06,u=e.m07,d=e.m08,p=e.m09,m=e.m10,f=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=n,t.m01=o,t.m02=a,t.m03=c,t.m04=l,t.m05=h,t.m06=_,t.m07=u,t.m08=d,t.m09=p,t.m10=m,t.m11=f,t.m12=n*i+l*s+d*r+e.m12,t.m13=o*i+h*s+p*r+e.m13,t.m14=a*i+_*s+m*r+e.m14,t.m15=c*i+u*s+f*r+e.m15}return t}static translate(t,e,n){return console.warn("function changed"),e===t?(t.m12+=n.x,t.m13+=n.y,t.m14+=n.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=n.x,t.m13+=n.y,t.m14+=n.z,t.m15=e.m15),t}static scale(t,e,n){const i=n.x,s=n.y,r=n.z;return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*s,t.m05=e.m05*s,t.m06=e.m06*s,t.m07=e.m07*s,t.m08=e.m08*r,t.m09=e.m09*r,t.m10=e.m10*r,t.m11=e.m11*r,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static rotate(t,e,n,i){let s=i.x,r=i.y,o=i.z,a=Math.sqrt(s*s+r*r+o*o);if(Math.abs(a)<Fe)return null;a=1/a,s*=a,r*=a,o*=a;const c=Math.sin(n),l=Math.cos(n),h=1-l,_=e.m00,u=e.m01,d=e.m02,p=e.m03,m=e.m04,f=e.m05,g=e.m06,v=e.m07,y=e.m08,x=e.m09,S=e.m10,T=e.m11,E=s*s*h+l,C=r*s*h+o*c,A=o*s*h-r*c,b=s*r*h-o*c,w=r*r*h+l,R=o*r*h+s*c,I=s*o*h+r*c,P=r*o*h-s*c,O=o*o*h+l;return t.m00=_*E+m*C+y*A,t.m01=u*E+f*C+x*A,t.m02=d*E+g*C+S*A,t.m03=p*E+v*C+T*A,t.m04=_*b+m*w+y*R,t.m05=u*b+f*w+x*R,t.m06=d*b+g*w+S*R,t.m07=p*b+v*w+T*R,t.m08=_*I+m*P+y*O,t.m09=u*I+f*P+x*O,t.m10=d*I+g*P+S*O,t.m11=p*I+v*P+T*O,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t}static rotateX(t,e,n){const i=Math.sin(n),s=Math.cos(n),r=e.m04,o=e.m05,a=e.m06,c=e.m07,l=e.m08,h=e.m09,_=e.m10,u=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=r*s+l*i,t.m05=o*s+h*i,t.m06=a*s+_*i,t.m07=c*s+u*i,t.m08=l*s-r*i,t.m09=h*s-o*i,t.m10=_*s-a*i,t.m11=u*s-c*i,t}static rotateY(t,e,n){const i=Math.sin(n),s=Math.cos(n),r=e.m00,o=e.m01,a=e.m02,c=e.m03,l=e.m08,h=e.m09,_=e.m10,u=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=r*s-l*i,t.m01=o*s-h*i,t.m02=a*s-_*i,t.m03=c*s-u*i,t.m08=r*i+l*s,t.m09=o*i+h*s,t.m10=a*i+_*s,t.m11=c*i+u*s,t}static rotateZ(t,e,n){const i=Math.sin(n),s=Math.cos(n),r=e.m00,o=e.m01,a=e.m02,c=e.m03,l=e.m04,h=e.m05,_=e.m06,u=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=r*s+l*i,t.m01=o*s+h*i,t.m02=a*s+_*i,t.m03=c*s+u*i,t.m04=l*s-r*i,t.m05=h*s-o*i,t.m06=_*s-a*i,t.m07=u*s-c*i,t}static fromTranslation(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t}static fromScaling(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromRotation(t,e,n){let i=n.x,s=n.y,r=n.z,o=Math.sqrt(i*i+s*s+r*r);if(Math.abs(o)<Fe)return null;o=1/o,i*=o,s*=o,r*=o;const a=Math.sin(e),c=Math.cos(e),l=1-c;return t.m00=i*i*l+c,t.m01=s*i*l+r*a,t.m02=r*i*l-s*a,t.m03=0,t.m04=i*s*l-r*a,t.m05=s*s*l+c,t.m06=r*s*l+i*a,t.m07=0,t.m08=i*r*l+s*a,t.m09=s*r*l-i*a,t.m10=r*r*l+c,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromXRotation(t,e){const n=Math.sin(e),i=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=i,t.m06=n,t.m07=0,t.m08=0,t.m09=-n,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromYRotation(t,e){const n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=0,t.m02=-n,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=n,t.m09=0,t.m10=i,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromZRotation(t,e){const n=Math.sin(e),i=Math.cos(e);return t.m00=i,t.m01=n,t.m02=0,t.m03=0,t.m04=-n,t.m05=i,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromRT(t,e,n){const i=e.x,s=e.y,r=e.z,o=e.w,a=i+i,c=s+s,l=r+r,h=i*a,_=i*c,u=i*l,d=s*c,p=s*l,m=r*l,f=o*a,g=o*c,v=o*l;return t.m00=1-(d+m),t.m01=_+v,t.m02=u-g,t.m03=0,t.m04=_-v,t.m05=1-(h+m),t.m06=p+f,t.m07=0,t.m08=u+g,t.m09=p-f,t.m10=1-(h+d),t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t}static getTranslation(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t}static getScaling(t,e){const n=Rn.m00=e.m00,i=Rn.m01=e.m01,s=Rn.m02=e.m02,r=Rn.m03=e.m04,o=Rn.m04=e.m05,a=Rn.m05=e.m06,c=Rn.m06=e.m08,l=Rn.m07=e.m09,h=Rn.m08=e.m10;return t.x=Math.sqrt(n*n+i*i+s*s),t.y=Math.sqrt(r*r+o*o+a*a),t.z=Math.sqrt(c*c+l*l+h*h),mn.determinant(Rn)<0&&(t.x*=-1),t}static getRotation(t,e){const n=e.m00+e.m05+e.m10;let i=0;return n>0?(i=2*Math.sqrt(n+1),t.w=.25*i,t.x=(e.m06-e.m09)/i,t.y=(e.m08-e.m02)/i,t.z=(e.m01-e.m04)/i):e.m00>e.m05&&e.m00>e.m10?(i=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/i,t.x=.25*i,t.y=(e.m01+e.m04)/i,t.z=(e.m08+e.m02)/i):e.m05>e.m10?(i=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/i,t.x=(e.m01+e.m04)/i,t.y=.25*i,t.z=(e.m06+e.m09)/i):(i=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/i,t.x=(e.m08+e.m02)/i,t.y=(e.m06+e.m09)/i,t.z=.25*i),t}static toRTS(t,e,n,i){i.x=ln.set(wn,t.m00,t.m01,t.m02).length(),Rn.m00=t.m00/i.x,Rn.m01=t.m01/i.x,Rn.m02=t.m02/i.x,i.y=ln.set(wn,t.m04,t.m05,t.m06).length(),Rn.m03=t.m04/i.y,Rn.m04=t.m05/i.y,Rn.m05=t.m06/i.y,i.z=ln.set(wn,t.m08,t.m09,t.m10).length(),Rn.m06=t.m08/i.z,Rn.m07=t.m09/i.z,Rn.m08=t.m10/i.z,mn.determinant(Rn)<0&&(i.x*=-1,Rn.m00*=-1,Rn.m01*=-1,Rn.m02*=-1),vn.fromMat3(e,Rn),ln.set(n,t.m12,t.m13,t.m14)}static fromRTS(t,e,n,i){const s=e.x,r=e.y,o=e.z,a=e.w,c=s+s,l=r+r,h=o+o,_=s*c,u=s*l,d=s*h,p=r*l,m=r*h,f=o*h,g=a*c,v=a*l,y=a*h,x=i.x,S=i.y,T=i.z;return t.m00=(1-(p+f))*x,t.m01=(u+y)*x,t.m02=(d-v)*x,t.m03=0,t.m04=(u-y)*S,t.m05=(1-(_+f))*S,t.m06=(m+g)*S,t.m07=0,t.m08=(d+v)*T,t.m09=(m-g)*T,t.m10=(1-(_+p))*T,t.m11=0,t.m12=n.x,t.m13=n.y,t.m14=n.z,t.m15=1,t}static fromRTSOrigin(t,e,n,i,s){const r=e.x,o=e.y,a=e.z,c=e.w,l=r+r,h=o+o,_=a+a,u=r*l,d=r*h,p=r*_,m=o*h,f=o*_,g=a*_,v=c*l,y=c*h,x=c*_,S=i.x,T=i.y,E=i.z,C=s.x,A=s.y,b=s.z;return t.m00=(1-(m+g))*S,t.m01=(d+x)*S,t.m02=(p-y)*S,t.m03=0,t.m04=(d-x)*T,t.m05=(1-(u+g))*T,t.m06=(f+v)*T,t.m07=0,t.m08=(p+y)*E,t.m09=(f-v)*E,t.m10=(1-(u+m))*E,t.m11=0,t.m12=n.x+C-(t.m00*C+t.m04*A+t.m08*b),t.m13=n.y+A-(t.m01*C+t.m05*A+t.m09*b),t.m14=n.z+b-(t.m02*C+t.m06*A+t.m10*b),t.m15=1,t}static fromQuat(t,e){const n=e.x,i=e.y,s=e.z,r=e.w,o=n+n,a=i+i,c=s+s,l=n*o,h=i*o,_=i*a,u=s*o,d=s*a,p=s*c,m=r*o,f=r*a,g=r*c;return t.m00=1-_-p,t.m01=h+g,t.m02=u-f,t.m03=0,t.m04=h-g,t.m05=1-l-p,t.m06=d+m,t.m07=0,t.m08=u+f,t.m09=d-m,t.m10=1-l-_,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static frustum(t,e,n,i,s,r,o){const a=1/(n-e),c=1/(s-i),l=1/(r-o);return t.m00=2*r*a,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*r*c,t.m06=0,t.m07=0,t.m08=(n+e)*a,t.m09=(s+i)*c,t.m10=(o+r)*l,t.m11=-1,t.m12=0,t.m13=0,t.m14=o*r*2*l,t.m15=0,t}static perspective(t,e,n,i,s,r=!0,o=-1,a=1,c=0){const l=1/Math.tan(e/2),h=1/(i-s),_=r?l/n:l,u=(r?l:l*n)*a,d=An[c];return t.m00=_*d[0],t.m01=_*d[1],t.m02=0,t.m03=0,t.m04=u*d[2],t.m05=u*d[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(s-o*i)*h,t.m11=-1,t.m12=0,t.m13=0,t.m14=s*i*h*(1-o),t.m15=0,t}static ortho(t,e,n,i,s,r,o,a=-1,c=1,l=0){const h=1/(e-n),_=1/(i-s)*c,u=1/(r-o),d=-2*h,p=-2*_,m=(e+n)*h,f=(s+i)*_,g=An[l];return t.m00=d*g[0],t.m01=d*g[1],t.m02=0,t.m03=0,t.m04=p*g[2],t.m05=p*g[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=u*(1-a),t.m11=0,t.m12=m*g[0]+f*g[2],t.m13=m*g[1]+f*g[3],t.m14=(r-a*o)*u,t.m15=1,t}static lookAt(t,e,n,i){const s=e.x,r=e.y,o=e.z,a=i.x,c=i.y,l=i.z;let h=s-n.x,_=r-n.y,u=o-n.z,d=1/Math.sqrt(h*h+_*_+u*u);h*=d,_*=d,u*=d;let p=c*u-l*_,m=l*h-a*u,f=a*_-c*h;d=1/Math.sqrt(p*p+m*m+f*f),p*=d,m*=d,f*=d;const g=_*f-u*m,v=u*p-h*f,y=h*m-_*p;return t.m00=p,t.m01=g,t.m02=h,t.m03=0,t.m04=m,t.m05=v,t.m06=_,t.m07=0,t.m08=f,t.m09=y,t.m10=u,t.m11=0,t.m12=-(p*s+m*r+f*o),t.m13=-(g*s+v*r+y*o),t.m14=-(h*s+_*r+u*o),t.m15=1,t}static inverseTranspose(t,e){const n=e.m00,i=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,c=e.m06,l=e.m07,h=e.m08,_=e.m09,u=e.m10,d=e.m11,p=e.m12,m=e.m13,f=e.m14,g=e.m15,v=n*a-i*o,y=n*c-s*o,x=n*l-r*o,S=i*c-s*a,T=i*l-r*a,E=s*l-r*c,C=h*m-_*p,A=h*f-u*p,b=h*g-d*p,w=_*f-u*m,R=_*g-d*m,I=u*g-d*f;let P=v*I-y*R+x*w+S*b-T*A+E*C;return P?(P=1/P,t.m00=(a*I-c*R+l*w)*P,t.m01=(c*b-o*I-l*A)*P,t.m02=(o*R-a*b+l*C)*P,t.m03=0,t.m04=(s*R-i*I-r*w)*P,t.m05=(n*I-s*b+r*A)*P,t.m06=(i*b-n*R-r*C)*P,t.m07=0,t.m08=(m*E-f*T+g*S)*P,t.m09=(f*x-p*E-g*y)*P,t.m10=(p*T-m*x+g*v)*P,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null}static toArray(t,e,n=0){return t[n+0]=e.m00,t[n+1]=e.m01,t[n+2]=e.m02,t[n+3]=e.m03,t[n+4]=e.m04,t[n+5]=e.m05,t[n+6]=e.m06,t[n+7]=e.m07,t[n+8]=e.m08,t[n+9]=e.m09,t[n+10]=e.m10,t[n+11]=e.m11,t[n+12]=e.m12,t[n+13]=e.m13,t[n+14]=e.m14,t[n+15]=e.m15,t}static fromArray(t,e,n=0){return t.m00=e[n+0],t.m01=e[n+1],t.m02=e[n+2],t.m03=e[n+3],t.m04=e[n+4],t.m05=e[n+5],t.m06=e[n+6],t.m07=e[n+7],t.m08=e[n+8],t.m09=e[n+9],t.m10=e[n+10],t.m11=e[n+11],t.m12=e[n+12],t.m13=e[n+13],t.m14=e[n+14],t.m15=e[n+15],t}static add(t,e,n){return t.m00=e.m00+n.m00,t.m01=e.m01+n.m01,t.m02=e.m02+n.m02,t.m03=e.m03+n.m03,t.m04=e.m04+n.m04,t.m05=e.m05+n.m05,t.m06=e.m06+n.m06,t.m07=e.m07+n.m07,t.m08=e.m08+n.m08,t.m09=e.m09+n.m09,t.m10=e.m10+n.m10,t.m11=e.m11+n.m11,t.m12=e.m12+n.m12,t.m13=e.m13+n.m13,t.m14=e.m14+n.m14,t.m15=e.m15+n.m15,t}static subtract(t,e,n){return t.m00=e.m00-n.m00,t.m01=e.m01-n.m01,t.m02=e.m02-n.m02,t.m03=e.m03-n.m03,t.m04=e.m04-n.m04,t.m05=e.m05-n.m05,t.m06=e.m06-n.m06,t.m07=e.m07-n.m07,t.m08=e.m08-n.m08,t.m09=e.m09-n.m09,t.m10=e.m10-n.m10,t.m11=e.m11-n.m11,t.m12=e.m12-n.m12,t.m13=e.m13-n.m13,t.m14=e.m14-n.m14,t.m15=e.m15-n.m15,t}static multiplyScalar(t,e,n){return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*n,t.m05=e.m05*n,t.m06=e.m06*n,t.m07=e.m07*n,t.m08=e.m08*n,t.m09=e.m09*n,t.m10=e.m10*n,t.m11=e.m11*n,t.m12=e.m12*n,t.m13=e.m13*n,t.m14=e.m14*n,t.m15=e.m15*n,t}static multiplyScalarAndAdd(t,e,n,i){return t.m00=e.m00+n.m00*i,t.m01=e.m01+n.m01*i,t.m02=e.m02+n.m02*i,t.m03=e.m03+n.m03*i,t.m04=e.m04+n.m04*i,t.m05=e.m05+n.m05*i,t.m06=e.m06+n.m06*i,t.m07=e.m07+n.m07*i,t.m08=e.m08+n.m08*i,t.m09=e.m09+n.m09*i,t.m10=e.m10+n.m10*i,t.m11=e.m11+n.m11*i,t.m12=e.m12+n.m12*i,t.m13=e.m13+n.m13*i,t.m14=e.m14+n.m14*i,t.m15=e.m15+n.m15*i,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15}static equals(t,e,n=Fe){return Math.abs(t.m00-e.m00)<=n*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=n*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=n*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=n*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=n*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=n*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=n*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=n*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=n*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=n*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=n*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=n*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=n*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=n*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=n*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=n*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))}constructor(t=1,e=0,n=0,i=0,s=0,r=1,o=0,a=0,c=0,l=0,h=1,_=0,u=0,d=0,p=0,m=1){super(),this.m00=void 0,this.m01=void 0,this.m02=void 0,this.m03=void 0,this.m04=void 0,this.m05=void 0,this.m06=void 0,this.m07=void 0,this.m08=void 0,this.m09=void 0,this.m10=void 0,this.m11=void 0,this.m12=void 0,this.m13=void 0,this.m14=void 0,this.m15=void 0,"object"==typeof t?(this.m00=t.m00,this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15):(this.m00=t,this.m01=e,this.m02=n,this.m03=i,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=c,this.m09=l,this.m10=h,this.m11=_,this.m12=u,this.m13=d,this.m14=p,this.m15=m)}clone(){return new bn(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)}set(t=1,e=0,n=0,i=0,s=0,r=1,o=0,a=0,c=0,l=0,h=1,_=0,u=0,d=0,p=0,m=1){return"object"==typeof t?(this.m01=t.m01,this.m02=t.m02,this.m03=t.m03,this.m04=t.m04,this.m05=t.m05,this.m06=t.m06,this.m07=t.m07,this.m08=t.m08,this.m09=t.m09,this.m10=t.m10,this.m11=t.m11,this.m12=t.m12,this.m13=t.m13,this.m14=t.m14,this.m15=t.m15,this.m00=t.m00):(this.m01=e,this.m02=n,this.m03=i,this.m04=s,this.m05=r,this.m06=o,this.m07=a,this.m08=c,this.m09=l,this.m10=h,this.m11=_,this.m12=u,this.m13=d,this.m14=p,this.m15=m,this.m00=t),this}equals(t,e=Fe){return Math.abs(this.m00-t.m00)<=e*Math.max(1,Math.abs(this.m00),Math.abs(t.m00))&&Math.abs(this.m01-t.m01)<=e*Math.max(1,Math.abs(this.m01),Math.abs(t.m01))&&Math.abs(this.m02-t.m02)<=e*Math.max(1,Math.abs(this.m02),Math.abs(t.m02))&&Math.abs(this.m03-t.m03)<=e*Math.max(1,Math.abs(this.m03),Math.abs(t.m03))&&Math.abs(this.m04-t.m04)<=e*Math.max(1,Math.abs(this.m04),Math.abs(t.m04))&&Math.abs(this.m05-t.m05)<=e*Math.max(1,Math.abs(this.m05),Math.abs(t.m05))&&Math.abs(this.m06-t.m06)<=e*Math.max(1,Math.abs(this.m06),Math.abs(t.m06))&&Math.abs(this.m07-t.m07)<=e*Math.max(1,Math.abs(this.m07),Math.abs(t.m07))&&Math.abs(this.m08-t.m08)<=e*Math.max(1,Math.abs(this.m08),Math.abs(t.m08))&&Math.abs(this.m09-t.m09)<=e*Math.max(1,Math.abs(this.m09),Math.abs(t.m09))&&Math.abs(this.m10-t.m10)<=e*Math.max(1,Math.abs(this.m10),Math.abs(t.m10))&&Math.abs(this.m11-t.m11)<=e*Math.max(1,Math.abs(this.m11),Math.abs(t.m11))&&Math.abs(this.m12-t.m12)<=e*Math.max(1,Math.abs(this.m12),Math.abs(t.m12))&&Math.abs(this.m13-t.m13)<=e*Math.max(1,Math.abs(this.m13),Math.abs(t.m13))&&Math.abs(this.m14-t.m14)<=e*Math.max(1,Math.abs(this.m14),Math.abs(t.m14))&&Math.abs(this.m15-t.m15)<=e*Math.max(1,Math.abs(this.m15),Math.abs(t.m15))}strictEquals(t){return this.m00===t.m00&&this.m01===t.m01&&this.m02===t.m02&&this.m03===t.m03&&this.m04===t.m04&&this.m05===t.m05&&this.m06===t.m06&&this.m07===t.m07&&this.m08===t.m08&&this.m09===t.m09&&this.m10===t.m10&&this.m11===t.m11&&this.m12===t.m12&&this.m13===t.m13&&this.m14===t.m14&&this.m15===t.m15}toString(){return`[\n${this.m00}, ${this.m01}, ${this.m02}, ${this.m03},\n${this.m04}, ${this.m05}, ${this.m06}, ${this.m07},\n${this.m08}, ${this.m09}, ${this.m10}, ${this.m11},\n${this.m12}, ${this.m13}, ${this.m14}, ${this.m15}\n]`}identity(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}zero(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this}transpose(){const t=this.m01,e=this.m02,n=this.m03,i=this.m06,s=this.m07,r=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=t,this.m06=this.m09,this.m07=this.m13,this.m08=e,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=s,this.m14=r,this}invert(){const t=this.m00,e=this.m01,n=this.m02,i=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,c=this.m08,l=this.m09,h=this.m10,_=this.m11,u=this.m12,d=this.m13,p=this.m14,m=this.m15,f=t*r-e*s,g=t*o-n*s,v=t*a-i*s,y=e*o-n*r,x=e*a-i*r,S=n*a-i*o,T=c*d-l*u,E=c*p-h*u,C=c*m-_*u,A=l*p-h*d,b=l*m-_*d,w=h*m-_*p;let R=f*w-g*b+v*A+y*C-x*E+S*T;return 0===R?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(R=1/R,this.m00=(r*w-o*b+a*A)*R,this.m01=(n*b-e*w-i*A)*R,this.m02=(d*S-p*x+m*y)*R,this.m03=(h*x-l*S-_*y)*R,this.m04=(o*C-s*w-a*E)*R,this.m05=(t*w-n*C+i*E)*R,this.m06=(p*v-u*S-m*g)*R,this.m07=(c*S-h*v+_*g)*R,this.m08=(s*b-r*C+a*T)*R,this.m09=(e*C-t*b-i*T)*R,this.m10=(u*x-d*v+m*f)*R,this.m11=(l*v-c*x-_*f)*R,this.m12=(r*E-s*A-o*T)*R,this.m13=(t*A-e*E+n*T)*R,this.m14=(d*g-u*y-p*f)*R,this.m15=(c*y-l*g+h*f)*R,this)}determinant(){const t=this.m00,e=this.m01,n=this.m02,i=this.m03,s=this.m04,r=this.m05,o=this.m06,a=this.m07,c=this.m08,l=this.m09,h=this.m10,_=this.m11,u=this.m12,d=this.m13,p=this.m14,m=this.m15;return(t*r-e*s)*(h*m-_*p)-(t*o-n*s)*(l*m-_*d)+(t*a-i*s)*(l*p-h*d)+(e*o-n*r)*(c*m-_*u)-(e*a-i*r)*(c*p-h*u)+(n*a-i*o)*(c*d-l*u)}add(t){return this.m00+=t.m00,this.m01+=t.m01,this.m02+=t.m02,this.m03+=t.m03,this.m04+=t.m04,this.m05+=t.m05,this.m06+=t.m06,this.m07+=t.m07,this.m08+=t.m08,this.m09+=t.m09,this.m10+=t.m10,this.m11+=t.m11,this.m12+=t.m12,this.m13+=t.m13,this.m14+=t.m14,this.m15+=t.m15,this}subtract(t){return this.m00-=t.m00,this.m01-=t.m01,this.m02-=t.m02,this.m03-=t.m03,this.m04-=t.m04,this.m05-=t.m05,this.m06-=t.m06,this.m07-=t.m07,this.m08-=t.m08,this.m09-=t.m09,this.m10-=t.m10,this.m11-=t.m11,this.m12-=t.m12,this.m13-=t.m13,this.m14-=t.m14,this.m15-=t.m15,this}multiply(t){const e=this.m00,n=this.m01,i=this.m02,s=this.m03,r=this.m04,o=this.m05,a=this.m06,c=this.m07,l=this.m08,h=this.m09,_=this.m10,u=this.m11,d=this.m12,p=this.m13,m=this.m14,f=this.m15;let g=t.m00,v=t.m01,y=t.m02,x=t.m03;return this.m00=g*e+v*r+y*l+x*d,this.m01=g*n+v*o+y*h+x*p,this.m02=g*i+v*a+y*_+x*m,this.m03=g*s+v*c+y*u+x*f,g=t.m04,v=t.m05,y=t.m06,x=t.m07,this.m04=g*e+v*r+y*l+x*d,this.m05=g*n+v*o+y*h+x*p,this.m06=g*i+v*a+y*_+x*m,this.m07=g*s+v*c+y*u+x*f,g=t.m08,v=t.m09,y=t.m10,x=t.m11,this.m08=g*e+v*r+y*l+x*d,this.m09=g*n+v*o+y*h+x*p,this.m10=g*i+v*a+y*_+x*m,this.m11=g*s+v*c+y*u+x*f,g=t.m12,v=t.m13,y=t.m14,x=t.m15,this.m12=g*e+v*r+y*l+x*d,this.m13=g*n+v*o+y*h+x*p,this.m14=g*i+v*a+y*_+x*m,this.m15=g*s+v*c+y*u+x*f,this}multiplyScalar(t){return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=t,this.m05*=t,this.m06*=t,this.m07*=t,this.m08*=t,this.m09*=t,this.m10*=t,this.m11*=t,this.m12*=t,this.m13*=t,this.m14*=t,this.m15*=t,this}translate(t){return console.warn("function changed"),this.m12+=t.x,this.m13+=t.y,this.m14+=t.z,this}scale(t){const e=t.x,n=t.y,i=t.z;return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this}rotate(t,e){let n=e.x,i=e.y,s=e.z,r=Math.sqrt(n*n+i*i+s*s);if(Math.abs(r)<Fe)return null;r=1/r,n*=r,i*=r,s*=r;const o=Math.sin(t),a=Math.cos(t),c=1-a,l=this.m00,h=this.m01,_=this.m02,u=this.m03,d=this.m04,p=this.m05,m=this.m06,f=this.m07,g=this.m08,v=this.m09,y=this.m10,x=this.m11,S=n*n*c+a,T=i*n*c+s*o,E=s*n*c-i*o,C=n*i*c-s*o,A=i*i*c+a,b=s*i*c+n*o,w=n*s*c+i*o,R=i*s*c-n*o,I=s*s*c+a;return this.m00=l*S+d*T+g*E,this.m01=h*S+p*T+v*E,this.m02=_*S+m*T+y*E,this.m03=u*S+f*T+x*E,this.m04=l*C+d*A+g*b,this.m05=h*C+p*A+v*b,this.m06=_*C+m*A+y*b,this.m07=u*C+f*A+x*b,this.m08=l*w+d*R+g*I,this.m09=h*w+p*R+v*I,this.m10=_*w+m*R+y*I,this.m11=u*w+f*R+x*I,this}getTranslation(t){return t.x=this.m12,t.y=this.m13,t.z=this.m14,t}getScale(t){const e=Rn.m00=this.m00,n=Rn.m01=this.m01,i=Rn.m02=this.m02,s=Rn.m03=this.m04,r=Rn.m04=this.m05,o=Rn.m05=this.m06,a=Rn.m06=this.m08,c=Rn.m07=this.m09,l=Rn.m08=this.m10;return t.x=Math.sqrt(e*e+n*n+i*i),t.y=Math.sqrt(s*s+r*r+o*o),t.z=Math.sqrt(a*a+c*c+l*l),mn.determinant(Rn)<0&&(t.x*=-1),t}getRotation(t){const e=this.m00+this.m05+this.m10;let n=0;return e>0?(n=2*Math.sqrt(e+1),t.w=.25*n,t.x=(this.m06-this.m09)/n,t.y=(this.m08-this.m02)/n,t.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),t.w=(this.m06-this.m09)/n,t.x=.25*n,t.y=(this.m01+this.m04)/n,t.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),t.w=(this.m08-this.m02)/n,t.x=(this.m01+this.m04)/n,t.y=.25*n,t.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),t.w=(this.m01-this.m04)/n,t.x=(this.m08+this.m02)/n,t.y=(this.m06+this.m09)/n,t.z=.25*n),t}fromRTS(t,e,n){const i=t.x,s=t.y,r=t.z,o=t.w,a=i+i,c=s+s,l=r+r,h=i*a,_=i*c,u=i*l,d=s*c,p=s*l,m=r*l,f=o*a,g=o*c,v=o*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(d+m))*y,this.m01=(_+v)*y,this.m02=(u-g)*y,this.m03=0,this.m04=(_-v)*x,this.m05=(1-(h+m))*x,this.m06=(p+f)*x,this.m07=0,this.m08=(u+g)*S,this.m09=(p-f)*S,this.m10=(1-(h+d))*S,this.m11=0,this.m12=e.x,this.m13=e.y,this.m14=e.z,this.m15=1,this}fromQuat(t){const e=t.x,n=t.y,i=t.z,s=t.w,r=e+e,o=n+n,a=i+i,c=e*r,l=n*r,h=n*o,_=i*r,u=i*o,d=i*a,p=s*r,m=s*o,f=s*a;return this.m00=1-h-d,this.m01=l+f,this.m02=_-m,this.m03=0,this.m04=l-f,this.m05=1-c-d,this.m06=u+p,this.m07=0,this.m08=_+m,this.m09=u-p,this.m10=1-c-h,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this}}t("Mat4",bn),bn.IDENTITY=Object.freeze(new bn);const wn=new ln,Rn=new mn;function In(t,e,n,i,s,r,o,a,c,l,h,_,u,d,p,m){return new bn(t,e,n,i,s,r,o,a,c,l,h,_,u,d,p,m)}Me.fastDefine("cc.Mat4",bn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),i.Mat4=bn,i.mat4=In;class Pn{static identity(){return new Pn}static clone(t){return new Pn(t.a,t.b,t.c,t.d,t.tx,t.ty)}static concat(t,e,n){const i=e.a,s=e.b,r=e.c,o=e.d,a=e.tx,c=e.ty;t.a=i*n.a+s*n.c,t.b=i*n.b+s*n.d,t.c=r*n.a+o*n.c,t.d=r*n.b+o*n.d,t.tx=a*n.a+c*n.c+n.tx,t.ty=a*n.b+c*n.d+n.ty}static invert(t,e){const n=1/(e.a*e.d-e.b*e.c);t.a=n*e.d,t.b=-n*e.b,t.c=-n*e.c,t.d=n*e.a,t.tx=n*(e.c*e.ty-e.d*e.tx),t.ty=n*(e.b*e.tx-e.a*e.ty)}static fromMat4(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13}static transformVec2(t,e,n,i){let s,r;void 0===i?(i=n,s=e.x,r=e.y):(s=e,r=n),t.x=i.a*s+i.c*r+i.tx,t.y=i.b*s+i.d*r+i.ty}static transformSize(t,e,n){t.width=n.a*e.width+n.c*e.height,t.height=n.b*e.width+n.d*e.height}static transformRect(t,e,n){const i=e.x+e.width,s=e.y+e.height,r=n.a*e.x+n.c*e.y+n.tx,o=n.b*e.x+n.d*e.y+n.ty,a=n.a*i+n.c*e.y+n.tx,c=n.b*i+n.d*e.y+n.ty,l=n.a*e.x+n.c*s+n.tx,h=n.b*e.x+n.d*s+n.ty,_=n.a*i+n.c*s+n.tx,u=n.b*i+n.d*s+n.ty,d=Math.min(r,a,l,_),p=Math.max(r,a,l,_),m=Math.min(o,c,h,u),f=Math.max(o,c,h,u);t.x=d,t.y=m,t.width=p-d,t.height=f-m}static transformObb(t,e,n,i,s,r){const o=r.a*s.x+r.c*s.y+r.tx,a=r.b*s.x+r.d*s.y+r.ty,c=r.a*s.width,l=r.b*s.width,h=r.c*s.height,_=r.d*s.height;e.x=o,e.y=a,n.x=c+o,n.y=l+a,t.x=h+o,t.y=_+a,i.x=c+h+o,i.y=l+_+a}constructor(t=1,e=0,n=0,i=1,s=0,r=0){this.a=t,this.b=e,this.c=n,this.d=i,this.tx=s,this.ty=r}}t("AffineTransform",Pn),i.AffineTransform=Pn;class On extends Yt{static lerp(t,e,n,i){return t.width=e.width+(n.width-e.width)*i,t.height=e.height+(n.height-e.height)*i,t}set x(t){this.width=t}get x(){return this.width}set y(t){this.height=t}get y(){return this.height}constructor(t,e){super(),t&&"object"==typeof t?(this.width=t.width,this.height=t.height):(this.width=t||0,this.height=e||0)}clone(){return new On(this.width,this.height)}set(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this}equals(t){return this.width===t.width&&this.height===t.height}lerp(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this}toString(){return`(${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}}function Dn(t=0,e=0){return new On(t,e)}t("Size",On),On.ZERO=Object.freeze(new On(0,0)),On.ONE=Object.freeze(new On(1,1)),Me.fastDefine("cc.Size",On,{width:0,height:0}),i.size=Dn,i.Size=On;class Mn extends Yt{static fromMinMax(t,e,n){const i=Math.min(e.x,n.x),s=Math.min(e.y,n.y),r=Math.max(e.x,n.x),o=Math.max(e.y,n.y);return t.x=i,t.y=s,t.width=r-i,t.height=o-s,t}static lerp(t,e,n,i){const s=e.x,r=e.y,o=e.width,a=e.height;return t.x=s+(n.x-s)*i,t.y=r+(n.y-r)*i,t.width=o+(n.width-o)*i,t.height=a+(n.height-a)*i,t}static intersection(t,e,n){const i=e.x,s=e.y,r=e.x+e.width,o=e.y+e.height,a=n.x,c=n.y,l=n.x+n.width,h=n.y+n.height;return t.x=Math.max(i,a),t.y=Math.max(s,c),t.width=Math.min(r,l)-t.x,t.height=Math.min(o,h)-t.y,t}static union(t,e,n){const i=e.x,s=e.y,r=e.width,o=e.height,a=n.x,c=n.y,l=n.width,h=n.height;return t.x=Math.min(i,a),t.y=Math.min(s,c),t.width=Math.max(i+r,a+l)-t.x,t.height=Math.max(s+o,c+h)-t.y,t}get xMin(){return this.x}set xMin(t){this.width+=this.x-t,this.x=t}get yMin(){return this.y}set yMin(t){this.height+=this.y-t,this.y=t}get xMax(){return this.x+this.width}set xMax(t){this.width=t-this.x}get yMax(){return this.y+this.height}set yMax(t){this.height=t-this.y}get center(){return new rn(this.x+.5*this.width,this.y+.5*this.height)}set center(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}get origin(){return new rn(this.x,this.y)}set origin(t){this.x=t.x,this.y=t.y}get size(){return new On(this.width,this.height)}set size(t){this.width=t.width,this.height=t.height}set z(t){this.width=t}get z(){return this.width}set w(t){this.height=t}get w(){return this.height}constructor(t,e,n,i){super(),this.T=void 0,t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=n||0,this.height=i||0)}clone(){return new Mn(this.x,this.y,this.width,this.height)}set(t,e,n,i){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=n||0,this.height=i||0),this}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}lerp(t,e){const n=this.x,i=this.y,s=this.width,r=this.height;return this.x=n+(t.x-n)*e,this.y=i+(t.y-i)*e,this.width=s+(t.width-s)*e,this.height=r+(t.height-r)*e,this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}intersects(t){const e=this.x+this.width,n=this.y+this.height,i=t.x+t.width,s=t.y+t.height;return!(e<t.x||i<this.x||n<t.y||s<this.y)}contains(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y}containsRect(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height}transformMat4(t){const e=this.x,n=this.y,i=e+this.width,s=n+this.height,r=t.m00*e+t.m04*n+t.m12,o=t.m01*e+t.m05*n+t.m13,a=t.m00*i+t.m04*n+t.m12,c=t.m01*i+t.m05*n+t.m13,l=t.m00*e+t.m04*s+t.m12,h=t.m01*e+t.m05*s+t.m13,_=t.m00*i+t.m04*s+t.m12,u=t.m01*i+t.m05*s+t.m13,d=Math.min(r,a,l,_),p=Math.max(r,a,l,_),m=Math.min(o,c,h,u),f=Math.max(o,c,h,u);return this.x=d,this.y=m,this.width=p-d,this.height=f-m,this}transformMat4ToPoints(t,e,n,i,s){const r=this.x,o=this.y,a=r+this.width,c=o+this.height;e.x=t.m00*r+t.m04*o+t.m12,e.y=t.m01*r+t.m05*o+t.m13,s.x=t.m00*a+t.m04*o+t.m12,s.y=t.m01*a+t.m05*o+t.m13,n.x=t.m00*r+t.m04*c+t.m12,n.y=t.m01*r+t.m05*c+t.m13,i.x=t.m00*a+t.m04*c+t.m12,i.y=t.m01*a+t.m05*c+t.m13}}function Nn(t=0,e=0,n=0,i=0){return new Mn(t,e,n,i)}t("Rect",Mn),Me.fastDefine("cc.Rect",Mn,{x:0,y:0,width:0,height:0}),i.Rect=Mn,i.rect=Nn;class Ln extends Yt{static clone(t){const e=new Ln;return t._val?e._val=t._val:e._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,e}static copy(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t}static set(t,e,n,i,s){return t.r=e,t.g=n,t.b=i,t.a=s,t}static fromHEX(t,e){return e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0,t.a=parseInt(e.substr(6,2),16)||255,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t}static add(t,e,n){return t.r=e.r+n.r,t.g=e.g+n.g,t.b=e.b+n.b,t.a=e.a+n.a,t}static subtract(t,e,n){return t.r=e.r-n.r,t.g=e.g-n.g,t.b=e.b-n.b,t.a=e.a-n.a,t}static multiply(t,e,n){return t.r=e.r*n.r,t.g=e.g*n.g,t.b=e.b*n.b,t.a=e.a*n.a,t}static divide(t,e,n){return t.r=e.r/n.r,t.g=e.g/n.g,t.b=e.b/n.b,t.a=e.a/n.a,t}static scale(t,e,n){return t.r=e.r*n,t.g=e.g*n,t.b=e.b*n,t.a=e.a*n,t}static lerp(t,e,n,i){let s=e.r,r=e.g,o=e.b,a=e.a;return s+=(n.r-s)*i,r+=(n.g-r)*i,o+=(n.b-o)*i,a+=(n.a-a)*i,t._val=Math.floor((a<<24>>>0)+(o<<16)+(r<<8)+s),t}static toArray(t,e,n=0){const i=e instanceof Ln||e.a>1?1/255:1;return t[n+0]=e.r*i,t[n+1]=e.g*i,t[n+2]=e.b*i,t[n+3]=e.a*i,t}static fromArray(t,e,n=0){return e.r=255*t[n+0],e.g=255*t[n+1],e.b=255*t[n+2],e.a=255*t[n+3],e}static strictEquals(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a}static equals(t,e,n=Fe){return Math.abs(t.r-e.r)<=n*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=n*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=n*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=n*Math.max(1,Math.abs(t.a),Math.abs(e.a))}static hex(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0}get r(){return 255&this._val}set r(t){t=~~He(t,0,255),this._val=(4294967040&this._val|t)>>>0}get g(){return(65280&this._val)>>8}set g(t){t=~~He(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}get b(){return(16711680&this._val)>>16}set b(t){t=~~He(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}get a(){return(4278190080&this._val)>>>24}set a(t){t=~~He(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}get x(){return this.r*(1/255)}set x(t){this.r=255*t}get y(){return this.g*(1/255)}set y(t){this.g=255*t}get z(){return this.b*(1/255)}set z(t){this.b=255*t}get w(){return this.a*(1/255)}set w(t){this.a=255*t}constructor(t,e,n,i){super(),this._val=0,"string"==typeof t?this.fromHEX(t):void 0!==e?this.set(t,e,n,i):this.set(t)}clone(){const t=new Ln;return t._val=this._val,t}equals(t){return t&&this._val===t._val}lerp(t,e){let n=this.r,i=this.g,s=this.b,r=this.a;return n+=(t.r-n)*e,i+=(t.g-i)*e,s+=(t.b-s)*e,r+=(t.a-r)*e,this._val=Math.floor((r<<24>>>0)+(s<<16)+(i<<8)+n),this}toString(){return`rgba(${this.r.toFixed()}, ${this.g.toFixed()}, ${this.b.toFixed()}, ${this.a.toFixed()})`}toCSS(t="rgba"){return"rgba"===t?`rgba(${this.r},${this.g},${this.b},${(this.a*(1/255)).toFixed(2)})`:"rgb"===t?`rgb(${this.r},${this.g},${this.b})`:"#"+this.toHEX(t)}fromHEX(t){t=0===t.indexOf("#")?t.substring(1):t;const e=parseInt(t.substr(0,2),16)||0,n=parseInt(t.substr(2,2),16)||0,i=parseInt(t.substr(4,2),16)||0,s=parseInt(t.substr(6,2),16)||255;return this._val=(s<<24>>>0)+(i<<16)+(n<<8)+(0|e),this}toHEX(t="#rrggbb"){const e=[(this.r<16?"0":"")+this.r.toString(16),(this.g<16?"0":"")+this.g.toString(16),(this.b<16?"0":"")+this.b.toString(16)];return"#rgb"===t?(e[0]=e[0][0],e[1]=e[1][0],e[2]=e[2][0]):"#rrggbbaa"===t&&e.push((this.a<16?"0":"")+this.a.toString(16)),e.join("")}toRGBValue(){return 16777215&this._val}fromHSV(t,e,n){let i=0,s=0,r=0;if(0===e)i=s=r=n;else if(0===n)i=s=r=0;else{1===t&&(t=0),t*=6;const o=Math.floor(t),a=t-o,c=n*(1-e),l=n*(1-e*a),h=n*(1-e*(1-a));switch(o){case 0:i=n,s=h,r=c;break;case 1:i=l,s=n,r=c;break;case 2:i=c,s=n,r=h;break;case 3:i=c,s=l,r=n;break;case 4:i=h,s=c,r=n;break;case 5:i=n,s=c,r=l}}return i*=255,s*=255,r*=255,this._val=(this.a<<24>>>0)+(r<<16)+(s<<8)+(0|i),this}toHSV(){const t=this.r*(1/255),e=this.g*(1/255),n=this.b*(1/255),i={h:0,s:0,v:0},s=Math.max(t,e,n),r=Math.min(t,e,n);let o=0;return i.v=s,i.s=s?(s-r)/s:0,i.s?(o=s-r,i.h=t===s?(e-n)/o:e===s?2+(n-t)/o:4+(t-e)/o,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i}set(t,e,n,i){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,n=t.b||0,i="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(e<<8)+(0|t)),this}multiply(t){const e=(255&this._val)*t.r>>8,n=(65280&this._val)*t.g>>8,i=(16711680&this._val)*t.b>>8,s=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&s|16711680&i|65280&n|255&e,this}_set_r_unsafe(t){return this._val=(4294967040&this._val|t)>>>0,this}_set_g_unsafe(t){return this._val=(4294902015&this._val|t<<8)>>>0,this}_set_b_unsafe(t){return this._val=(4278255615&this._val|t<<16)>>>0,this}_set_a_unsafe(t){return this._val=(16777215&this._val|t<<24)>>>0,this}}function zn(t,e,n,i){return new Ln(t,e,n,i)}t("Color",Ln),Ln.WHITE=Object.freeze(new Ln(255,255,255,255)),Ln.GRAY=Object.freeze(new Ln(127,127,127,255)),Ln.BLACK=Object.freeze(new Ln(0,0,0,255)),Ln.TRANSPARENT=Object.freeze(new Ln(0,0,0,0)),Ln.RED=Object.freeze(new Ln(255,0,0,255)),Ln.GREEN=Object.freeze(new Ln(0,255,0,255)),Ln.BLUE=Object.freeze(new Ln(0,0,255,255)),Ln.CYAN=Object.freeze(new Ln(0,255,255,255)),Ln.MAGENTA=Object.freeze(new Ln(255,0,255,255)),Ln.YELLOW=Object.freeze(new Ln(255,255,0,255)),Me.fastDefine("cc.Color",Ln,{r:0,g:0,b:0,a:255}),i.Color=Ln,i.color=zn;var Bn=Object.freeze({__proto__:null,bits:$,Vec2:rn,v2:cn,Vec3:ln,v3:un,Vec4:dn,v4:pn,Quat:vn,quat:Cn,Mat3:mn,Mat4:bn,mat4:In,AffineTransform:Pn,Size:On,size:Dn,Rect:Mn,rect:Nn,Color:Ln,color:zn,EPSILON:Fe,equals:Ue,approx:Ge,clamp:He,clamp01:Ve,lerp:ke,toRadian:je,toDegree:We,random:qe,randomRange:Xe,randomRangeInt:Ye,pseudoRandom:Ke,pseudoRandomRange:$e,pseudoRandomRangeInt:Ze,nextPow2:Je,repeat:Qe,pingPong:tn,inverseLerp:en,absMaxComponent:nn,absMax:sn});t("math",Bn);const Fn=jsb.NativeBufferPool,Un=jsb.NativeObjectPool,Gn=jsb.NativeBufferAllocator;var Hn;!function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}(Hn||(Hn={}));class Vn{constructor(t,e,n,i=8){this._dataType=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freelists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=n.COUNT,this._entryBits=i,this._dataType=e,this._stride=4*this._elementCount,this._entriesPerChunk=1<<i,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Fn(t,i,this._stride);let s=Hn.NEVER,r=!1,o=!1;for(const t in e){if(r=this._hasFloat32,o=this._hasUint32,o&&r)break;s=e[t],r||s!==Hn.FLOAT32?o||s!==Hn.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}alloc(){let t=0;for(;t<this._freelists.length;t++){const e=this._freelists[t];if(e.length){const n=e[e.length-1];return e.length--,(t<<this._entryBits)+n+this._poolFlag}}const e=this._nativePool.allocateNewChunk(),n=[],i=[],s=[],r=this._hasFloat32,o=this._hasUint32;for(let t=0;t<this._entriesPerChunk;t++)r&&n.push(new Float32Array(e,this._stride*t,this._elementCount)),o&&i.push(new Uint32Array(e,this._stride*t,this._elementCount)),t&&s.push(t);return this._arrayBuffers.push(e),o&&this._uint32BufferViews.push(i),r&&this._float32BufferViews.push(n),this._freelists.push(s),(t<<this._entryBits)+this._poolFlag}get(t,e){const n=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;return(this._dataType[e]===Hn.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i][e]}set(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;(this._dataType[e]===Hn.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s][e]=n}setVec2(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let r=e;const o=(this._dataType[e]===Hn.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s];o[r++]=n.x,o[r++]=n.y}setVec3(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let r=e;const o=(this._dataType[e]===Hn.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s];o[r++]=n.x,o[r++]=n.y,o[r]=n.z}setVec4(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let r=e;const o=(this._dataType[e]===Hn.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s];o[r++]=n.x,o[r++]=n.y,o[r++]=n.z,o[r]=n.w}setMat4(t,e,n){const i=(this._chunkMask&t)>>this._entryBits,s=this._entryMask&t;let r=e;const o=(this._dataType[e]===Hn.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][s];o[r++]=n.m00,o[r++]=n.m01,o[r++]=n.m02,o[r++]=n.m03,o[r++]=n.m04,o[r++]=n.m05,o[r++]=n.m06,o[r++]=n.m07,o[r++]=n.m08,o[r++]=n.m09,o[r++]=n.m10,o[r++]=n.m11,o[r++]=n.m12,o[r++]=n.m13,o[r++]=n.m14,o[r]=n.m15}free(t){const e=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][n].fill(0),this._freelists[e].push(n)}}class kn{constructor(t,e,n){this._ctor=void 0,this._dtor=void 0,this._indexMask=void 0,this._poolFlag=void 0,this._array=[],this._freelist=[],this._nativePool=void 0,this._ctor=e,n&&(this._dtor=n),this._poolFlag=1<<29,this._indexMask=~this._poolFlag,this._nativePool=new Un(t,this._array)}alloc(...t){const e=this._freelist;let n=-1;if(e.length)n=e[e.length-1],e.length--,this._array[n]=this._ctor(arguments,this._array[n]);else{n=this._array.length;const t=this._ctor(arguments);if(!t)return 0;this._array.push(t)}return n+this._poolFlag}get(t){const e=this._indexMask&t;return this._array[e]}free(t){const e=this._indexMask&t;this._dtor&&(this._array[e]=this._dtor(this._array[e])),this._freelist.push(e)}}class jn{constructor(t){this._nativeBufferAllocator=void 0,this._buffers=new Map,this._nextBufferIdx=0,this._poolFlag=void 0,this._bufferIdxMask=void 0,this._poolFlag=1<<30,this._bufferIdxMask=~this._poolFlag,this._nativeBufferAllocator=new Gn(t)}alloc(t){const e=this._nextBufferIdx++,n=this._nativeBufferAllocator.alloc(e,t);return this._buffers.set(e,n),e|this._poolFlag}free(t){const e=this._bufferIdxMask&t;this._buffers.get(e)&&(this._nativeBufferAllocator.free(e),this._buffers.delete(e))}getBuffer(t){const e=this._bufferIdxMask&t;return this._buffers.get(e)||null}}class Wn extends jn{constructor(t,e,n,i){super(t),this._viewCtor=void 0,this._size=void 0,this._step=void 0,this._viewCtor=e,this._size=n*e.BYTES_PER_ELEMENT,this._step=i||n}alloc(){const t=this._nextBufferIdx++,e=this._nativeBufferAllocator.alloc(t,this._size);return this._buffers.set(t,new this._viewCtor(e)),t|this._poolFlag}getBuffer(t){return null}assign(t,e,n){const i=this._bufferIdxMask&t;let s=this._buffers.get(i);if(!s)return;const r=e+1;if(r>=s.length){let t=s.length;for(;r>=t;)t+=this._step;t*=this._viewCtor.BYTES_PER_ELEMENT;const e=new this._viewCtor(this._nativeBufferAllocator.alloc(i,t));e.set(s),s=e,this._buffers.set(i,s)}s[r]=n;const o=s[0];s[0]=r>o?r:o}erase(t,e){const n=this._bufferIdxMask&t,i=this._buffers.get(n);if(i&&!(e>=i[0])){for(let t=e+1;t<i[0];++t)i[t]=i[t+1];--i[0]}}push(t,e){const n=this._bufferIdxMask&t,i=this._buffers.get(n);i&&this.assign(t,i[0],e)}pop(t){const e=this._bufferIdxMask&t,n=this._buffers.get(e);n&&0!==n[0]&&--n[0]}clear(t){const e=this._bufferIdxMask&t,n=this._buffers.get(e);n&&(n[0]=0)}get(t,e){const n=this._bufferIdxMask&t,i=this._buffers.get(n);return!i||e>=i[0]?0:i[e+1]}length(t){const e=this._bufferIdxMask&t,n=this._buffers.get(e);return n?n[0]:0}}function qn(t,e,n,i=!0){const s=e.length(t);for(let i=0;i<s;i++){const s=e.get(t,i);s&&n.free(s)}i?e.free(t):e.clear(t)}let Xn;!function(t){t[t.ATTRIBUTE=0]="ATTRIBUTE",t[t.DESCRIPTOR_SETS=1]="DESCRIPTOR_SETS",t[t.SHADER=2]="SHADER",t[t.INPUT_ASSEMBLER=3]="INPUT_ASSEMBLER",t[t.PIPELINE_LAYOUT=4]="PIPELINE_LAYOUT",t[t.FRAMEBUFFER=5]="FRAMEBUFFER",t[t.PASS=100]="PASS",t[t.SUB_MODEL=101]="SUB_MODEL",t[t.MODEL=102]="MODEL",t[t.SCENE=103]="SCENE",t[t.CAMERA=104]="CAMERA",t[t.NODE=105]="NODE",t[t.ROOT=106]="ROOT",t[t.AABB=107]="AABB",t[t.RENDER_WINDOW=108]="RENDER_WINDOW",t[t.FRUSTUM=109]="FRUSTUM",t[t.AMBIENT=110]="AMBIENT",t[t.FOG=111]="FOG",t[t.SKYBOX=112]="SKYBOX",t[t.SHADOW=113]="SHADOW",t[t.LIGHT=114]="LIGHT",t[t.SPHERE=115]="SPHERE",t[t.INSTANCED_ATTRIBUTE=116]="INSTANCED_ATTRIBUTE",t[t.FLAT_BUFFER=117]="FLAT_BUFFER",t[t.SUB_MESH=118]="SUB_MESH",t[t.RASTERIZER_STATE=119]="RASTERIZER_STATE",t[t.DEPTH_STENCIL_STATE=120]="DEPTH_STENCIL_STATE",t[t.BLEND_TARGET=121]="BLEND_TARGET",t[t.BLEND_STATE=122]="BLEND_STATE",t[t.BATCH_2D=123]="BATCH_2D",t[t.SUB_MODEL_ARRAY=200]="SUB_MODEL_ARRAY",t[t.MODEL_ARRAY=201]="MODEL_ARRAY",t[t.ATTRIBUTE_ARRAY=202]="ATTRIBUTE_ARRAY",t[t.FLAT_BUFFER_ARRAY=203]="FLAT_BUFFER_ARRAY",t[t.INSTANCED_BUFFER_ARRAY=204]="INSTANCED_BUFFER_ARRAY",t[t.LIGHT_ARRAY=205]="LIGHT_ARRAY",t[t.BLEND_TARGET_ARRAY=206]="BLEND_TARGET_ARRAY",t[t.BATCH_ARRAY_2D=207]="BATCH_ARRAY_2D",t[t.RAW_BUFFER=300]="RAW_BUFFER",t[t.RAW_OBJECT=400]="RAW_OBJECT"}(Xn||(Xn={}));const Yn=new kn(Xn.SHADER,(t,e)=>e?(e.initialize(t[1]),e):t[0].createShader(t[1]),t=>(t&&t.destroy(),t)),Kn=new kn(Xn.DESCRIPTOR_SETS,(t,e)=>e?(e.initialize(t[1]),e):t[0].createDescriptorSet(t[1]),t=>(t&&t.destroy(),t)),$n=new kn(Xn.INPUT_ASSEMBLER,(t,e)=>e?(e.initialize(t[1]),e):t[0].createInputAssembler(t[1]),t=>(t&&t.destroy(),t)),Zn=new kn(Xn.PIPELINE_LAYOUT,(t,e)=>e?(e.initialize(t[1]),e):t[0].createPipelineLayout(t[1]),t=>(t&&t.destroy(),t)),Jn=new kn(Xn.FRAMEBUFFER,(t,e)=>e?(e.initialize(t[1]),e):t[0].createFramebuffer(t[1]),t=>(t&&t.destroy(),t)),Qn=new Wn(Xn.SUB_MODEL_ARRAY,Uint32Array,8,4),ti=new Wn(Xn.MODEL_ARRAY,Uint32Array,32,16),ei=new Wn(Xn.ATTRIBUTE_ARRAY,Uint32Array,8,4),ni=new Wn(Xn.FLAT_BUFFER_ARRAY,Uint32Array,8,4),ii=new Wn(Xn.LIGHT_ARRAY,Uint32Array,8,4),si=new Wn(Xn.BLEND_TARGET_ARRAY,Uint32Array,8,4),ri=new Wn(Xn.BATCH_ARRAY_2D,Uint32Array,32,16),oi=new jn(Xn.RAW_BUFFER),ai=new kn(Xn.RAW_OBJECT,t=>t[0]||{},()=>{});let ci;!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.BATCHING_SCHEME=3]="BATCHING_SCHEME",t[t.PRIMITIVE=4]="PRIMITIVE",t[t.DYNAMIC_STATES=5]="DYNAMIC_STATES",t[t.HASH=6]="HASH",t[t.RASTERIZER_STATE=7]="RASTERIZER_STATE",t[t.DEPTH_STENCIL_STATE=8]="DEPTH_STENCIL_STATE",t[t.BLEND_STATE=9]="BLEND_STATE",t[t.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",t[t.PIPELINE_LAYOUT=11]="PIPELINE_LAYOUT",t[t.COUNT=12]="COUNT"}(ci||(ci={}));const li={[ci.PRIORITY]:Hn.UINT32,[ci.STAGE]:Hn.UINT32,[ci.PHASE]:Hn.UINT32,[ci.BATCHING_SCHEME]:Hn.UINT32,[ci.PRIMITIVE]:Hn.UINT32,[ci.DYNAMIC_STATES]:Hn.UINT32,[ci.HASH]:Hn.UINT32,[ci.RASTERIZER_STATE]:Hn.UINT32,[ci.DEPTH_STENCIL_STATE]:Hn.UINT32,[ci.BLEND_STATE]:Hn.UINT32,[ci.DESCRIPTOR_SET]:Hn.UINT32,[ci.PIPELINE_LAYOUT]:Hn.UINT32,[ci.COUNT]:Hn.NEVER},hi=new Vn(Xn.PASS,li,ci);let _i;!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.PASS_COUNT=1]="PASS_COUNT",t[t.PASS_0=2]="PASS_0",t[t.PASS_1=3]="PASS_1",t[t.PASS_2=4]="PASS_2",t[t.PASS_3=5]="PASS_3",t[t.SHADER_0=6]="SHADER_0",t[t.SHADER_1=7]="SHADER_1",t[t.SHADER_2=8]="SHADER_2",t[t.SHADER_3=9]="SHADER_3",t[t.PLANAR_SHADER=10]="PLANAR_SHADER",t[t.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",t[t.SUB_MESH=13]="SUB_MESH",t[t.COUNT=14]="COUNT"}(_i||(_i={}));const ui={[_i.PRIORITY]:Hn.UINT32,[_i.PASS_COUNT]:Hn.UINT32,[_i.PASS_0]:Hn.UINT32,[_i.PASS_1]:Hn.UINT32,[_i.PASS_2]:Hn.UINT32,[_i.PASS_3]:Hn.UINT32,[_i.SHADER_0]:Hn.UINT32,[_i.SHADER_1]:Hn.UINT32,[_i.SHADER_2]:Hn.UINT32,[_i.SHADER_3]:Hn.UINT32,[_i.PLANAR_SHADER]:Hn.UINT32,[_i.DESCRIPTOR_SET]:Hn.UINT32,[_i.INPUT_ASSEMBLER]:Hn.UINT32,[_i.SUB_MESH]:Hn.UINT32,[_i.COUNT]:Hn.NEVER},di=new Vn(Xn.SUB_MODEL,ui,_i);let pi;!function(t){t[t.ENABLED=0]="ENABLED",t[t.VIS_FLAGS=1]="VIS_FLAGS",t[t.CAST_SHADOW=2]="CAST_SHADOW",t[t.RECEIVE_SHADOW=3]="RECEIVE_SHADOW",t[t.WORLD_BOUNDS=4]="WORLD_BOUNDS",t[t.NODE=5]="NODE",t[t.TRANSFORM=6]="TRANSFORM",t[t.SUB_MODEL_ARRAY=7]="SUB_MODEL_ARRAY",t[t.INSTANCED_BUFFER=8]="INSTANCED_BUFFER",t[t.INSTANCED_ATTR_ARRAY=9]="INSTANCED_ATTR_ARRAY",t[t.COUNT=10]="COUNT"}(pi||(pi={}));const mi={[pi.ENABLED]:Hn.UINT32,[pi.VIS_FLAGS]:Hn.UINT32,[pi.CAST_SHADOW]:Hn.UINT32,[pi.RECEIVE_SHADOW]:Hn.UINT32,[pi.WORLD_BOUNDS]:Hn.UINT32,[pi.NODE]:Hn.UINT32,[pi.TRANSFORM]:Hn.UINT32,[pi.SUB_MODEL_ARRAY]:Hn.UINT32,[pi.INSTANCED_BUFFER]:Hn.UINT32,[pi.INSTANCED_ATTR_ARRAY]:Hn.UINT32,[pi.COUNT]:Hn.NEVER},fi=new Vn(Xn.MODEL,mi,pi);let gi;!function(t){t[t.VIS_FLAGS=0]="VIS_FLAGS",t[t.PASS_COUNT=1]="PASS_COUNT",t[t.PASS_0=2]="PASS_0",t[t.PASS_1=3]="PASS_1",t[t.PASS_2=4]="PASS_2",t[t.PASS_3=5]="PASS_3",t[t.SHADER_0=6]="SHADER_0",t[t.SHADER_1=7]="SHADER_1",t[t.SHADER_2=8]="SHADER_2",t[t.SHADER_3=9]="SHADER_3",t[t.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",t[t.COUNT=12]="COUNT"}(gi||(gi={}));const vi={[gi.VIS_FLAGS]:Hn.UINT32,[gi.PASS_COUNT]:Hn.UINT32,[gi.PASS_0]:Hn.UINT32,[gi.PASS_1]:Hn.UINT32,[gi.PASS_2]:Hn.UINT32,[gi.PASS_3]:Hn.UINT32,[gi.SHADER_0]:Hn.UINT32,[gi.SHADER_1]:Hn.UINT32,[gi.SHADER_2]:Hn.UINT32,[gi.SHADER_3]:Hn.UINT32,[gi.DESCRIPTOR_SET]:Hn.UINT32,[gi.INPUT_ASSEMBLER]:Hn.UINT32,[gi.COUNT]:Hn.NEVER},yi=new Vn(Xn.BATCH_2D,vi,gi);let xi;!function(t){t[t.CENTER=0]="CENTER",t[t.HALF_EXTENSION=3]="HALF_EXTENSION",t[t.COUNT=6]="COUNT"}(xi||(xi={}));const Si={[xi.CENTER]:Hn.FLOAT32,[xi.HALF_EXTENSION]:Hn.FLOAT32,[xi.COUNT]:Hn.NEVER},Ti=new Vn(Xn.AABB,Si,xi);let Ei;!function(t){t[t.MAIN_LIGHT=0]="MAIN_LIGHT",t[t.MODEL_ARRAY=1]="MODEL_ARRAY",t[t.SPHERE_LIGHT_ARRAY=2]="SPHERE_LIGHT_ARRAY",t[t.SPOT_LIGHT_ARRAY=3]="SPOT_LIGHT_ARRAY",t[t.BATCH_ARRAY_2D=4]="BATCH_ARRAY_2D",t[t.COUNT=5]="COUNT"}(Ei||(Ei={}));const Ci={[Ei.MAIN_LIGHT]:Hn.UINT32,[Ei.MODEL_ARRAY]:Hn.UINT32,[Ei.SPHERE_LIGHT_ARRAY]:Hn.UINT32,[Ei.SPOT_LIGHT_ARRAY]:Hn.UINT32,[Ei.BATCH_ARRAY_2D]:Hn.UINT32,[Ei.COUNT]:Hn.NEVER},Ai=new Vn(Xn.SCENE,Ci,Ei);let bi;!function(t){t[t.WIDTH=0]="WIDTH",t[t.HEIGHT=1]="HEIGHT",t[t.EXPOSURE=2]="EXPOSURE",t[t.CLEAR_FLAG=3]="CLEAR_FLAG",t[t.CLEAR_DEPTH=4]="CLEAR_DEPTH",t[t.CLEAR_STENCIL=5]="CLEAR_STENCIL",t[t.VISIBILITY=6]="VISIBILITY",t[t.NODE=7]="NODE",t[t.SCENE=8]="SCENE",t[t.FRUSTUM=9]="FRUSTUM",t[t.WINDOW=10]="WINDOW",t[t.FORWARD=11]="FORWARD",t[t.POSITION=14]="POSITION",t[t.VIEW_PORT=17]="VIEW_PORT",t[t.CLEAR_COLOR=21]="CLEAR_COLOR",t[t.MAT_VIEW=25]="MAT_VIEW",t[t.MAT_VIEW_PROJ=41]="MAT_VIEW_PROJ",t[t.MAT_VIEW_PROJ_INV=57]="MAT_VIEW_PROJ_INV",t[t.MAT_PROJ=73]="MAT_PROJ",t[t.MAT_PROJ_INV=89]="MAT_PROJ_INV",t[t.COUNT=105]="COUNT"}(bi||(bi={}));const wi={[bi.WIDTH]:Hn.UINT32,[bi.HEIGHT]:Hn.UINT32,[bi.EXPOSURE]:Hn.FLOAT32,[bi.CLEAR_FLAG]:Hn.UINT32,[bi.CLEAR_DEPTH]:Hn.FLOAT32,[bi.CLEAR_STENCIL]:Hn.UINT32,[bi.VISIBILITY]:Hn.UINT32,[bi.NODE]:Hn.UINT32,[bi.SCENE]:Hn.UINT32,[bi.FRUSTUM]:Hn.UINT32,[bi.WINDOW]:Hn.UINT32,[bi.FORWARD]:Hn.FLOAT32,[bi.POSITION]:Hn.FLOAT32,[bi.VIEW_PORT]:Hn.FLOAT32,[bi.CLEAR_COLOR]:Hn.FLOAT32,[bi.MAT_VIEW]:Hn.FLOAT32,[bi.MAT_VIEW_PROJ]:Hn.FLOAT32,[bi.MAT_VIEW_PROJ_INV]:Hn.FLOAT32,[bi.MAT_PROJ]:Hn.FLOAT32,[bi.MAT_PROJ_INV]:Hn.FLOAT32,[bi.COUNT]:Hn.NEVER},Ri=new Vn(Xn.CAMERA,wi,bi);let Ii;!function(t){t[t.FLAGS_CHANGED=0]="FLAGS_CHANGED",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.COUNT=28]="COUNT"}(Ii||(Ii={}));const Pi={[Ii.FLAGS_CHANGED]:Hn.UINT32,[Ii.LAYER]:Hn.UINT32,[Ii.WORLD_SCALE]:Hn.FLOAT32,[Ii.WORLD_POSITION]:Hn.FLOAT32,[Ii.WORLD_ROTATION]:Hn.FLOAT32,[Ii.WORLD_MATRIX]:Hn.FLOAT32,[Ii.COUNT]:Hn.NEVER},Oi=new Vn(Xn.NODE,Pi,Ii);let Di;!function(t){t[t.CUMULATIVE_TIME=0]="CUMULATIVE_TIME",t[t.FRAME_TIME=1]="FRAME_TIME",t[t.COUNT=2]="COUNT"}(Di||(Di={}));const Mi={[Di.CUMULATIVE_TIME]:Hn.FLOAT32,[Di.FRAME_TIME]:Hn.FLOAT32,[Di.COUNT]:Hn.NEVER},Ni=new Vn(Xn.ROOT,Mi,Di,1);let Li;!function(t){t[t.HAS_ON_SCREEN_ATTACHMENTS=0]="HAS_ON_SCREEN_ATTACHMENTS",t[t.HAS_OFF_SCREEN_ATTACHMENTS=1]="HAS_OFF_SCREEN_ATTACHMENTS",t[t.FRAMEBUFFER=2]="FRAMEBUFFER",t[t.COUNT=3]="COUNT"}(Li||(Li={}));const zi={[Li.HAS_ON_SCREEN_ATTACHMENTS]:Hn.UINT32,[Li.HAS_OFF_SCREEN_ATTACHMENTS]:Hn.UINT32,[Li.FRAMEBUFFER]:Hn.UINT32,[Li.COUNT]:Hn.NEVER},Bi=new Vn(Xn.RENDER_WINDOW,zi,Li,2);let Fi;!function(t){t[t.VERTICES=0]="VERTICES",t[t.PLANES=24]="PLANES",t[t.COUNT=48]="COUNT"}(Fi||(Fi={}));const Ui={[Fi.VERTICES]:Hn.FLOAT32,[Fi.PLANES]:Hn.FLOAT32,[Fi.COUNT]:Hn.NEVER},Gi=new Vn(Xn.FRUSTUM,Ui,Fi);let Hi;!function(t){t[t.ENABLE=0]="ENABLE",t[t.ILLUM=1]="ILLUM",t[t.SKY_COLOR=2]="SKY_COLOR",t[t.GROUND_ALBEDO=6]="GROUND_ALBEDO",t[t.COUNT=10]="COUNT"}(Hi||(Hi={}));const Vi={[Hi.ENABLE]:Hn.UINT32,[Hi.ILLUM]:Hn.FLOAT32,[Hi.SKY_COLOR]:Hn.FLOAT32,[Hi.GROUND_ALBEDO]:Hn.FLOAT32,[Hi.COUNT]:Hn.NEVER},ki=new Vn(Xn.AMBIENT,Vi,Hi,1);let ji;!function(t){t[t.ENABLE=0]="ENABLE",t[t.IS_RGBE=1]="IS_RGBE",t[t.USE_IBL=2]="USE_IBL",t[t.MODEL=3]="MODEL",t[t.COUNT=4]="COUNT"}(ji||(ji={}));const Wi={[ji.ENABLE]:Hn.UINT32,[ji.IS_RGBE]:Hn.UINT32,[ji.USE_IBL]:Hn.UINT32,[ji.MODEL]:Hn.UINT32,[ji.COUNT]:Hn.NEVER},qi=new Vn(Xn.SKYBOX,Wi,ji,1);let Xi;!function(t){t[t.ENABLE=0]="ENABLE",t[t.TYPE=1]="TYPE",t[t.DENSITY=2]="DENSITY",t[t.START=3]="START",t[t.END=4]="END",t[t.ATTEN=5]="ATTEN",t[t.TOP=6]="TOP",t[t.RANGE=7]="RANGE",t[t.COLOR=8]="COLOR",t[t.COUNT=12]="COUNT"}(Xi||(Xi={}));const Yi={[Xi.ENABLE]:Hn.UINT32,[Xi.TYPE]:Hn.UINT32,[Xi.DENSITY]:Hn.FLOAT32,[Xi.START]:Hn.FLOAT32,[Xi.END]:Hn.FLOAT32,[Xi.ATTEN]:Hn.FLOAT32,[Xi.TOP]:Hn.FLOAT32,[Xi.RANGE]:Hn.FLOAT32,[Xi.COLOR]:Hn.FLOAT32,[Xi.COUNT]:Hn.NEVER},Ki=new Vn(Xn.FOG,Yi,Xi);let $i;!function(t){t[t.ENABLE=0]="ENABLE",t[t.DIRTY=1]="DIRTY",t[t.TYPE=2]="TYPE",t[t.DISTANCE=3]="DISTANCE",t[t.INSTANCE_PASS=4]="INSTANCE_PASS",t[t.PLANAR_PASS=5]="PLANAR_PASS",t[t.NEAR=6]="NEAR",t[t.FAR=7]="FAR",t[t.ASPECT=8]="ASPECT",t[t.PCF_TYPE=9]="PCF_TYPE",t[t.SHADOW_MAP_DIRTY=10]="SHADOW_MAP_DIRTY",t[t.BIAS=11]="BIAS",t[t.ORTHO_SIZE=12]="ORTHO_SIZE",t[t.AUTO_ADAPT=13]="AUTO_ADAPT",t[t.COLOR=14]="COLOR",t[t.SIZE=18]="SIZE",t[t.NORMAL=20]="NORMAL",t[t.MAT_LIGHT=23]="MAT_LIGHT",t[t.COUNT=39]="COUNT"}($i||($i={}));const Zi={[$i.ENABLE]:Hn.UINT32,[$i.DIRTY]:Hn.UINT32,[$i.TYPE]:Hn.UINT32,[$i.DISTANCE]:Hn.FLOAT32,[$i.INSTANCE_PASS]:Hn.UINT32,[$i.PLANAR_PASS]:Hn.UINT32,[$i.NEAR]:Hn.FLOAT32,[$i.FAR]:Hn.FLOAT32,[$i.ASPECT]:Hn.FLOAT32,[$i.PCF_TYPE]:Hn.UINT32,[$i.SHADOW_MAP_DIRTY]:Hn.UINT32,[$i.BIAS]:Hn.FLOAT32,[$i.ORTHO_SIZE]:Hn.FLOAT32,[$i.AUTO_ADAPT]:Hn.UINT32,[$i.COLOR]:Hn.FLOAT32,[$i.SIZE]:Hn.FLOAT32,[$i.NORMAL]:Hn.FLOAT32,[$i.MAT_LIGHT]:Hn.FLOAT32,[$i.COUNT]:Hn.NEVER},Ji=new Vn(Xn.SHADOW,Zi,$i,1);let Qi;!function(t){t[t.USE_COLOR_TEMPERATURE=0]="USE_COLOR_TEMPERATURE",t[t.ILLUMINANCE=1]="ILLUMINANCE",t[t.NODE=2]="NODE",t[t.RANGE=3]="RANGE",t[t.TYPE=4]="TYPE",t[t.AABB=5]="AABB",t[t.FRUSTUM=6]="FRUSTUM",t[t.SIZE=7]="SIZE",t[t.SPOT_ANGLE=8]="SPOT_ANGLE",t[t.ASPECT=9]="ASPECT",t[t.DIRECTION=10]="DIRECTION",t[t.COLOR=13]="COLOR",t[t.COLOR_TEMPERATURE_RGB=16]="COLOR_TEMPERATURE_RGB",t[t.POSITION=19]="POSITION",t[t.COUNT=22]="COUNT"}(Qi||(Qi={}));const ts={[Qi.USE_COLOR_TEMPERATURE]:Hn.UINT32,[Qi.ILLUMINANCE]:Hn.FLOAT32,[Qi.NODE]:Hn.UINT32,[Qi.RANGE]:Hn.FLOAT32,[Qi.TYPE]:Hn.UINT32,[Qi.AABB]:Hn.UINT32,[Qi.FRUSTUM]:Hn.UINT32,[Qi.SIZE]:Hn.FLOAT32,[Qi.SPOT_ANGLE]:Hn.FLOAT32,[Qi.ASPECT]:Hn.FLOAT32,[Qi.DIRECTION]:Hn.FLOAT32,[Qi.COLOR]:Hn.FLOAT32,[Qi.COLOR_TEMPERATURE_RGB]:Hn.FLOAT32,[Qi.POSITION]:Hn.FLOAT32,[Qi.COUNT]:Hn.NEVER},es=new Vn(Xn.LIGHT,ts,Qi,3);let ns;!function(t){t[t.RADIUS=0]="RADIUS",t[t.CENTER=1]="CENTER",t[t.COUNT=4]="COUNT"}(ns||(ns={}));const is={[ns.RADIUS]:Hn.FLOAT32,[ns.CENTER]:Hn.FLOAT32,[ns.COUNT]:Hn.NEVER},ss=new Vn(Xn.SPHERE,is,ns,3);let rs;!function(t){t[t.STRIDE=0]="STRIDE",t[t.AMOUNT=1]="AMOUNT",t[t.BUFFER=2]="BUFFER",t[t.COUNT=3]="COUNT"}(rs||(rs={}));const os={[rs.STRIDE]:Hn.UINT32,[rs.AMOUNT]:Hn.UINT32,[rs.BUFFER]:Hn.UINT32,[rs.COUNT]:Hn.NEVER},as=new Vn(Xn.FLAT_BUFFER,os,rs,3);let cs;!function(t){t[t.FLAT_BUFFER_ARRAY=0]="FLAT_BUFFER_ARRAY",t[t.COUNT=1]="COUNT"}(cs||(cs={}));const ls={[cs.FLAT_BUFFER_ARRAY]:Hn.UINT32,[cs.COUNT]:Hn.NEVER},hs=new Vn(Xn.SUB_MESH,ls,cs,3);let _s;!function(t){t[t.IS_DISCARD=0]="IS_DISCARD",t[t.POLYGO_MODEL=1]="POLYGO_MODEL",t[t.SHADE_MODEL=2]="SHADE_MODEL",t[t.CULL_MODE=3]="CULL_MODE",t[t.IS_FRONT_FACE_CCW=4]="IS_FRONT_FACE_CCW",t[t.DEPTH_BIAS_ENABLED=5]="DEPTH_BIAS_ENABLED",t[t.DEPTH_BIAS=6]="DEPTH_BIAS",t[t.DEPTH_BIAS_CLAMP=7]="DEPTH_BIAS_CLAMP",t[t.DEPTH_BIAS_SLOP=8]="DEPTH_BIAS_SLOP",t[t.IS_DEPTH_CLIP=9]="IS_DEPTH_CLIP",t[t.IS_MULTI_SAMPLE=10]="IS_MULTI_SAMPLE",t[t.LINE_WIDTH=11]="LINE_WIDTH",t[t.COUNT=12]="COUNT"}(_s||(_s={}));const us={[_s.IS_DISCARD]:Hn.UINT32,[_s.POLYGO_MODEL]:Hn.UINT32,[_s.SHADE_MODEL]:Hn.UINT32,[_s.CULL_MODE]:Hn.UINT32,[_s.IS_FRONT_FACE_CCW]:Hn.UINT32,[_s.DEPTH_BIAS_ENABLED]:Hn.UINT32,[_s.DEPTH_BIAS]:Hn.FLOAT32,[_s.DEPTH_BIAS_CLAMP]:Hn.FLOAT32,[_s.DEPTH_BIAS_SLOP]:Hn.FLOAT32,[_s.IS_DEPTH_CLIP]:Hn.UINT32,[_s.IS_MULTI_SAMPLE]:Hn.UINT32,[_s.LINE_WIDTH]:Hn.FLOAT32,[_s.COUNT]:Hn.NEVER},ds=new Vn(Xn.RASTERIZER_STATE,us,_s,9);let ps;!function(t){t[t.DEPTH_TEST=0]="DEPTH_TEST",t[t.DEPTH_WRITE=1]="DEPTH_WRITE",t[t.DEPTH_FUNC=2]="DEPTH_FUNC",t[t.STENCIL_TEST_FRONT=3]="STENCIL_TEST_FRONT",t[t.STENCIL_FUNC_FRONT=4]="STENCIL_FUNC_FRONT",t[t.STENCIL_READ_MASK_FRONT=5]="STENCIL_READ_MASK_FRONT",t[t.STENCIL_WRITE_MASK_FRONT=6]="STENCIL_WRITE_MASK_FRONT",t[t.STENCIL_FAIL_OP_FRONT=7]="STENCIL_FAIL_OP_FRONT",t[t.STENCIL_Z_FAIL_OP_FRONT=8]="STENCIL_Z_FAIL_OP_FRONT",t[t.STENCIL_PASS_OP_FRONT=9]="STENCIL_PASS_OP_FRONT",t[t.STENCIL_REF_FRONT=10]="STENCIL_REF_FRONT",t[t.STENCIL_TEST_BACK=11]="STENCIL_TEST_BACK",t[t.STENCIL_FUNC_BACK=12]="STENCIL_FUNC_BACK",t[t.STENCIL_READ_MADK_BACK=13]="STENCIL_READ_MADK_BACK",t[t.STENCIL_WRITE_MASK_BACK=14]="STENCIL_WRITE_MASK_BACK",t[t.STENCIL_FAIL_OP_BACK=15]="STENCIL_FAIL_OP_BACK",t[t.STENCIL_Z_FAIL_OP_BACK=16]="STENCIL_Z_FAIL_OP_BACK",t[t.STENCIL_PASS_OP_BACK=17]="STENCIL_PASS_OP_BACK",t[t.STENCIL_REF_BACK=18]="STENCIL_REF_BACK",t[t.COUNT=19]="COUNT"}(ps||(ps={}));const ms={[ps.DEPTH_TEST]:Hn.UINT32,[ps.DEPTH_WRITE]:Hn.UINT32,[ps.DEPTH_FUNC]:Hn.UINT32,[ps.STENCIL_TEST_FRONT]:Hn.UINT32,[ps.STENCIL_FUNC_FRONT]:Hn.UINT32,[ps.STENCIL_READ_MASK_FRONT]:Hn.UINT32,[ps.STENCIL_WRITE_MASK_FRONT]:Hn.UINT32,[ps.STENCIL_FAIL_OP_FRONT]:Hn.UINT32,[ps.STENCIL_Z_FAIL_OP_FRONT]:Hn.UINT32,[ps.STENCIL_PASS_OP_FRONT]:Hn.UINT32,[ps.STENCIL_REF_FRONT]:Hn.UINT32,[ps.STENCIL_TEST_BACK]:Hn.UINT32,[ps.STENCIL_FUNC_BACK]:Hn.UINT32,[ps.STENCIL_READ_MADK_BACK]:Hn.UINT32,[ps.STENCIL_WRITE_MASK_BACK]:Hn.UINT32,[ps.STENCIL_FAIL_OP_BACK]:Hn.UINT32,[ps.STENCIL_Z_FAIL_OP_BACK]:Hn.UINT32,[ps.STENCIL_PASS_OP_BACK]:Hn.UINT32,[ps.STENCIL_REF_BACK]:Hn.UINT32,[ps.COUNT]:Hn.NEVER},fs=new Vn(Xn.DEPTH_STENCIL_STATE,ms,ps,9);let gs;!function(t){t[t.BLEND=0]="BLEND",t[t.BLEND_SRC=1]="BLEND_SRC",t[t.BLEND_DST=2]="BLEND_DST",t[t.BLEND_EQ=3]="BLEND_EQ",t[t.BLEND_SRC_ALPHA=4]="BLEND_SRC_ALPHA",t[t.BLEND_DST_ALPHA=5]="BLEND_DST_ALPHA",t[t.BLEND_ALPHA_EQ=6]="BLEND_ALPHA_EQ",t[t.BLEND_COLOR_MASK=7]="BLEND_COLOR_MASK",t[t.COUNT=8]="COUNT"}(gs||(gs={})),gs.BLEND,Hn.UINT32,gs.BLEND_SRC,Hn.UINT32,gs.BLEND_DST,Hn.UINT32,gs.BLEND_EQ,Hn.UINT32,gs.BLEND_SRC_ALPHA,Hn.UINT32,gs.BLEND_DST_ALPHA,Hn.UINT32,gs.BLEND_ALPHA_EQ,Hn.UINT32,gs.BLEND_COLOR_MASK,Hn.UINT32,gs.COUNT,Hn.NEVER;const vs=new Vn(Xn.BLEND_TARGET,ms,gs,9);let ys;!function(t){t[t.IS_A2C=0]="IS_A2C",t[t.IS_INDEPEND=1]="IS_INDEPEND",t[t.BLEND_COLOR=2]="BLEND_COLOR",t[t.BLEND_TARGET=6]="BLEND_TARGET",t[t.COUNT=7]="COUNT"}(ys||(ys={}));const xs={[ys.IS_A2C]:Hn.UINT32,[ys.IS_INDEPEND]:Hn.UINT32,[ys.BLEND_COLOR]:Hn.FLOAT32,[ys.BLEND_TARGET]:Hn.UINT32,[ys.COUNT]:Hn.NEVER},Ss=new Vn(Xn.BLEND_STATE,xs,ys,9);class Ts{get colorArray(){return this._colorArray}get albedoArray(){return this._albedoArray}set enabled(t){ki.set(this._handle,Hi.ENABLE,t?1:0)}get enabled(){return ki.get(this._handle,Hi.ENABLE)}get skyColor(){return this._skyColor}set skyColor(t){this._skyColor.set(t),Ln.toArray(this._colorArray,this._skyColor),ki.setVec4(this._handle,Hi.SKY_COLOR,this._skyColor)}get skyIllum(){return ki.get(this._handle,Hi.ILLUM)}set skyIllum(t){ki.set(this._handle,Hi.ILLUM,t)}get groundAlbedo(){return this._groundAlbedo}set groundAlbedo(t){this._groundAlbedo.set(t),ln.toArray(this._albedoArray,this._groundAlbedo),ki.setVec4(this._handle,Hi.GROUND_ALBEDO,this._groundAlbedo)}get handle(){return this._handle}constructor(){this._skyColor=new Ln(51,128,204,1),this._groundAlbedo=new Ln(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1]),this._handle=0,this._handle=ki.alloc()}initialize(t){this._skyColor.set(t.skyColor),this._groundAlbedo.set(t.groundAlbedo),Ln.toArray(this._colorArray,this._skyColor),ln.toArray(this._albedoArray,this._groundAlbedo),ki.setVec4(this._handle,Hi.SKY_COLOR,this._skyColor),ki.setVec4(this._handle,Hi.GROUND_ALBEDO,this._groundAlbedo),ki.set(this._handle,Hi.ILLUM,t.skyIllum)}destroy(){this._handle&&(ki.free(this._handle),this._handle=0)}}Ts.SUN_ILLUM=65e3,Ts.SKY_ILLUM=2e4,i.Ambient=Ts;const Es=new ln,Cs=new ln,As=new ln,bs=new ln,ws=new ln,Rs=new ln,Is=new Array(3),Ps=new Array(3);function Os(t,e){return ln.dot(e.n,t)-e.d}function Ds(t,e,n){return ln.copy(t,e),ln.subtract(ws,n.center,n.halfExtents),ln.add(Rs,n.center,n.halfExtents),t.x=t.x<ws.x?ws.x:t.x,t.y=t.y<ws.y?ws.y:t.y,t.z=t.z<ws.z?ws.z:t.z,t.x=t.x>Rs.x?Rs.x:t.x,t.y=t.y>Rs.y?Rs.y:t.y,t.z=t.z>Rs.z?Rs.z:t.z,t}function Ms(t,e,n){ln.set(Es,n.orientation.m00,n.orientation.m01,n.orientation.m02),ln.set(Cs,n.orientation.m03,n.orientation.m04,n.orientation.m05),ln.set(As,n.orientation.m06,n.orientation.m07,n.orientation.m08),Is[0]=Es,Is[1]=Cs,Is[2]=As,Ps[0]=n.halfExtents.x,Ps[1]=n.halfExtents.y,Ps[2]=n.halfExtents.z,ln.subtract(bs,e,n.center),ln.set(t,n.center.x,n.center.y,n.center.z);for(let e=0;e<3;e++){let n=ln.dot(bs,Is[e]);n>Ps[e]&&(n=Ps[e]),n<-Ps[e]&&(n=-Ps[e]),t.x+=n*Is[e].x,t.y+=n*Is[e].y,t.z+=n*Is[e].z}return t}var Ns=Object.freeze({__proto__:null,point_plane:Os,pt_point_plane:function(t,e,n){const i=Os(e,n);return ln.subtract(t,e,ln.multiplyScalar(t,n.n,i))},pt_point_aabb:Ds,pt_point_obb:Ms,pt_point_line:function(t,e,n,i){ln.subtract(Es,n,i);const s=Es,r=ln.lengthSqr(s);if(0==r)ln.copy(t,n);else{ln.subtract(Es,e,n);const o=ln.dot(Es,s)/r;o<0?ln.copy(t,n):o>1?ln.copy(t,i):ln.scaleAndAdd(t,n,s,o)}}}),Ls={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512};class zs{static create(t=0,e=0,n=0,i=0,s=0,r=1){return new zs(t,e,n,i,s,r)}static clone(t){return new zs(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}static copy(t,e){return ln.copy(t.o,e.o),ln.copy(t.d,e.d),t}static fromPoints(t,e,n){return ln.copy(t.o,e),ln.normalize(t.d,ln.subtract(t.d,n,e)),t}static set(t,e,n,i,s,r,o){return t.o.x=e,t.o.y=n,t.o.z=i,t.d.x=s,t.d.y=r,t.d.z=o,t}get type(){return this._type}constructor(t=0,e=0,n=0,i=0,s=0,r=-1){this.o=void 0,this.d=void 0,this._type=void 0,this._type=Ls.SHAPE_RAY,this.o=new ln(t,e,n),this.d=new ln(i,s,r)}computeHit(t,e){ln.normalize(t,this.d),ln.scaleAndAdd(t,this.o,t,e)}}const Bs=new ln,Fs=new ln,Us=new ln,Gs=new ln;function Hs(t){return Math.max(Math.max(t.x,t.y),t.z)}class Vs{static create(t,e,n,i){return new Vs(t,e,n,i)}static clone(t){return new Vs(t.center.x,t.center.y,t.center.z,t.radius)}static copy(t,e){return ln.copy(t.center,e.center),t.radius=e.radius,t}static fromPoints(t,e,n){return ln.multiplyScalar(t.center,ln.add(Bs,e,n),.5),t.radius=.5*ln.subtract(Bs,n,e).length(),t}static set(t,e,n,i,s){return t.center.x=e,t.center.y=n,t.center.z=i,t.radius=s,t}static mergePoint(t,e,n){if(e.radius<0)return t.center.set(n),t.radius=0,t;ln.subtract(Fs,n,e.center);const i=Fs.length();if(i>e.radius){const n=.5*(i-e.radius);t.radius+=n,ln.multiplyScalar(Fs,Fs,n/i),ln.add(t.center,t.center,Fs)}return t}static mergeAABB(t,e,n){return n.getBoundary(Us,Gs),Vs.mergePoint(t,e,Us),Vs.mergePoint(t,e,Gs),t}get center(){return this._center}set center(t){this._center=t,ss.setVec3(this._poolHandle,ns.CENTER,this._center)}get radius(){return ss.get(this._poolHandle,ns.RADIUS)}set radius(t){ss.set(this._poolHandle,ns.RADIUS,t)}get handle(){return this._poolHandle}get type(){return this._type}constructor(t=0,e=0,n=0,i=1){this._center=new ln(0,0,0),this._poolHandle=0,this._type=void 0,this._type=Ls.SHAPE_SPHERE,this._center=new ln(t,e,n),this._poolHandle=ss.alloc(),ss.setVec3(this._poolHandle,ns.CENTER,this._center),ss.set(this._poolHandle,ns.RADIUS,i)}destroy(){this._poolHandle&&(ss.free(this._poolHandle),this._poolHandle=0)}clone(){return Vs.clone(this)}copy(t){return Vs.copy(this,t)}getBoundary(t,e){ln.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),ln.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}transform(t,e,n,i,s){ln.transformMat4(s.center,this.center,t),s.radius=this.radius*Hs(i)}translateAndRotate(t,e,n){ln.transformMat4(n.center,this.center,t)}setScale(t,e){e.radius=this.radius*Hs(t)}}class ks{static create(t=1,e=0,n=0,i=0,s=0,r=0,o=0,a=0,c=1){return new ks(t,e,n,i,s,r,o,a,c)}static clone(t){return new ks(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}static copy(t,e){return ln.copy(t.a,e.a),ln.copy(t.b,e.b),ln.copy(t.c,e.c),t}static fromPoints(t,e,n,i){return ln.copy(t.a,e),ln.copy(t.b,n),ln.copy(t.c,i),t}static set(t,e,n,i,s,r,o,a,c,l){return t.a.x=e,t.a.y=n,t.a.z=i,t.b.x=s,t.b.y=r,t.b.z=o,t.c.x=a,t.c.y=c,t.c.z=l,t}get type(){return this._type}constructor(t=0,e=0,n=0,i=1,s=0,r=0,o=0,a=1,c=0){this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=Ls.SHAPE_TRIANGLE,this.a=new ln(t,e,n),this.b=new ln(i,s,r),this.c=new ln(o,a,c)}}let js,Ws,qs,Xs,Ys,Ks,$s,Zs,Js,Qs,tr,er,ir,sr,rr,or,ar,cr,lr,hr,_r,ur,dr,pr,mr,fr,gr,vr,yr,xr,Sr,Tr,Er,Cr,Ar,br,wr,Rr;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BUFFER=1]="BUFFER",t[t.TEXTURE=2]="TEXTURE",t[t.RENDER_PASS=3]="RENDER_PASS",t[t.FRAMEBUFFER=4]="FRAMEBUFFER",t[t.SAMPLER=5]="SAMPLER",t[t.SHADER=6]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=9]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=12]="COMMAND_BUFFER",t[t.FENCE=13]="FENCE",t[t.QUEUE=14]="QUEUE",t[t.WINDOW=15]="WINDOW"}(js||(js={}));class Ir{get gfxType(){return this._gfxType}constructor(t){this._gfxType=js.UNKNOWN,this._gfxType=t}}!function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(Ws||(Ws={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.COUNT=32]="COUNT"}(qs||(qs={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.D16=54]="D16",t[t.D16S8=55]="D16S8",t[t.D24=56]="D24",t[t.D24S8=57]="D24S8",t[t.D32F=58]="D32F",t[t.D32F_S8=59]="D32F_S8",t[t.BC1=60]="BC1",t[t.BC1_ALPHA=61]="BC1_ALPHA",t[t.BC1_SRGB=62]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",t[t.BC2=64]="BC2",t[t.BC2_SRGB=65]="BC2_SRGB",t[t.BC3=66]="BC3",t[t.BC3_SRGB=67]="BC3_SRGB",t[t.BC4=68]="BC4",t[t.BC4_SNORM=69]="BC4_SNORM",t[t.BC5=70]="BC5",t[t.BC5_SNORM=71]="BC5_SNORM",t[t.BC6H_UF16=72]="BC6H_UF16",t[t.BC6H_SF16=73]="BC6H_SF16",t[t.BC7=74]="BC7",t[t.BC7_SRGB=75]="BC7_SRGB",t[t.ETC_RGB8=76]="ETC_RGB8",t[t.ETC2_RGB8=77]="ETC2_RGB8",t[t.ETC2_SRGB8=78]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=81]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",t[t.EAC_R11=83]="EAC_R11",t[t.EAC_R11SN=84]="EAC_R11SN",t[t.EAC_RG11=85]="EAC_RG11",t[t.EAC_RG11SN=86]="EAC_RG11SN",t[t.PVRTC_RGB2=87]="PVRTC_RGB2",t[t.PVRTC_RGBA2=88]="PVRTC_RGBA2",t[t.PVRTC_RGB4=89]="PVRTC_RGB4",t[t.PVRTC_RGBA4=90]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=91]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=92]="PVRTC2_4BPP",t[t.ASTC_RGBA_4x4=93]="ASTC_RGBA_4x4",t[t.ASTC_RGBA_5x4=94]="ASTC_RGBA_5x4",t[t.ASTC_RGBA_5x5=95]="ASTC_RGBA_5x5",t[t.ASTC_RGBA_6x5=96]="ASTC_RGBA_6x5",t[t.ASTC_RGBA_6x6=97]="ASTC_RGBA_6x6",t[t.ASTC_RGBA_8x5=98]="ASTC_RGBA_8x5",t[t.ASTC_RGBA_8x6=99]="ASTC_RGBA_8x6",t[t.ASTC_RGBA_8x8=100]="ASTC_RGBA_8x8",t[t.ASTC_RGBA_10x5=101]="ASTC_RGBA_10x5",t[t.ASTC_RGBA_10x6=102]="ASTC_RGBA_10x6",t[t.ASTC_RGBA_10x8=103]="ASTC_RGBA_10x8",t[t.ASTC_RGBA_10x10=104]="ASTC_RGBA_10x10",t[t.ASTC_RGBA_12x10=105]="ASTC_RGBA_12x10",t[t.ASTC_RGBA_12x12=106]="ASTC_RGBA_12x12",t[t.ASTC_SRGBA_4x4=107]="ASTC_SRGBA_4x4",t[t.ASTC_SRGBA_5x4=108]="ASTC_SRGBA_5x4",t[t.ASTC_SRGBA_5x5=109]="ASTC_SRGBA_5x5",t[t.ASTC_SRGBA_6x5=110]="ASTC_SRGBA_6x5",t[t.ASTC_SRGBA_6x6=111]="ASTC_SRGBA_6x6",t[t.ASTC_SRGBA_8x5=112]="ASTC_SRGBA_8x5",t[t.ASTC_SRGBA_8x6=113]="ASTC_SRGBA_8x6",t[t.ASTC_SRGBA_8x8=114]="ASTC_SRGBA_8x8",t[t.ASTC_SRGBA_10x5=115]="ASTC_SRGBA_10x5",t[t.ASTC_SRGBA_10x6=116]="ASTC_SRGBA_10x6",t[t.ASTC_SRGBA_10x8=117]="ASTC_SRGBA_10x8",t[t.ASTC_SRGBA_10x10=118]="ASTC_SRGBA_10x10",t[t.ASTC_SRGBA_12x10=119]="ASTC_SRGBA_12x10",t[t.ASTC_SRGBA_12x12=120]="ASTC_SRGBA_12x12"}(Xs||(Xs={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(Ys||(Ys={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(Ks||(Ks={})),function(t){t[t.NONE=0]="NONE",t[t.BAKUP_BUFFER=4]="BAKUP_BUFFER"}($s||($s={})),function(t){t[t.NONE=0]="NONE",t[t.READ=1]="READ",t[t.WRITE=2]="WRITE"}(Zs||(Zs={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Js||(Js={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(Qs||(Qs={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(tr||(tr={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(er||(er={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(ir||(ir={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(sr||(sr={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(rr||(rr={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(or||(or={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}(ar||(ar={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(cr||(cr={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(lr||(lr={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(hr||(hr={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.TRANSIENT_ATTACHMENT=64]="TRANSIENT_ATTACHMENT",t[t.INPUT_ATTACHMENT=128]="INPUT_ATTACHMENT"}(_r||(_r={})),function(t){t[t.X1=0]="X1",t[t.X2=1]="X2",t[t.X4=2]="X4",t[t.X8=3]="X8",t[t.X16=4]="X16",t[t.X32=5]="X32",t[t.X64=6]="X64"}(ur||(ur={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.CUBEMAP=2]="CUBEMAP",t[t.BAKUP_BUFFER=4]="BAKUP_BUFFER",t[t.IMMUTABLE=8]="IMMUTABLE"}(dr||(dr={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}(pr||(pr={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER=16]="SAMPLER"}(mr||(mr={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(fr||(fr={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(gr||(gr={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(vr||(vr={})),function(t){t[t.UNDEFINED=0]="UNDEFINED",t[t.GENERAL=1]="GENERAL",t[t.COLOR_ATTACHMENT_OPTIMAL=2]="COLOR_ATTACHMENT_OPTIMAL",t[t.DEPTH_STENCIL_ATTACHMENT_OPTIMAL=3]="DEPTH_STENCIL_ATTACHMENT_OPTIMAL",t[t.DEPTH_STENCIL_READONLY_OPTIMAL=4]="DEPTH_STENCIL_READONLY_OPTIMAL",t[t.SHADER_READONLY_OPTIMAL=5]="SHADER_READONLY_OPTIMAL",t[t.TRANSFER_SRC_OPTIMAL=6]="TRANSFER_SRC_OPTIMAL",t[t.TRANSFER_DST_OPTIMAL=7]="TRANSFER_DST_OPTIMAL",t[t.PREINITIALIZED=8]="PREINITIALIZED",t[t.PRESENT_SRC=9]="PRESENT_SRC"}(yr||(yr={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(xr||(xr={})),function(t){t[t.NONE=0]="NONE",t[t.VIEWPORT=1]="VIEWPORT",t[t.SCISSOR=2]="SCISSOR",t[t.LINE_WIDTH=4]="LINE_WIDTH",t[t.DEPTH_BIAS=8]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}(Sr||(Sr={})),function(t){t[t.FRONT=0]="FRONT",t[t.BACK=1]="BACK",t[t.ALL=2]="ALL"}(Tr||(Tr={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(Er||(Er={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(Cr||(Cr={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(Ar||(Ar={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.WEBGL=5]="WEBGL",t[t.WEBGL2=6]="WEBGL2",t[t.WEBGPU=7]="WEBGPU"}(br||(br={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}(wr||(wr={})),function(t){t[t.COLOR_FLOAT=0]="COLOR_FLOAT",t[t.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",t[t.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",t[t.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",t[t.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",t[t.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",t[t.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",t[t.FORMAT_D16=7]="FORMAT_D16",t[t.FORMAT_D16S8=8]="FORMAT_D16S8",t[t.FORMAT_D24=9]="FORMAT_D24",t[t.FORMAT_D24S8=10]="FORMAT_D24S8",t[t.FORMAT_D32F=11]="FORMAT_D32F",t[t.FORMAT_D32FS8=12]="FORMAT_D32FS8",t[t.FORMAT_ETC1=13]="FORMAT_ETC1",t[t.FORMAT_ETC2=14]="FORMAT_ETC2",t[t.FORMAT_DXT=15]="FORMAT_DXT",t[t.FORMAT_PVRTC=16]="FORMAT_PVRTC",t[t.FORMAT_ASTC=17]="FORMAT_ASTC",t[t.FORMAT_RGB8=18]="FORMAT_RGB8",t[t.MSAA=19]="MSAA",t[t.ELEMENT_INDEX_UINT=20]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=21]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=22]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=23]="BLEND_MINMAX",t[t.DEPTH_BOUNDS=24]="DEPTH_BOUNDS",t[t.LINE_WIDTH=25]="LINE_WIDTH",t[t.STENCIL_WRITE_MASK=26]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=27]="STENCIL_COMPARE_MASK",t[t.COUNT=28]="COUNT"}(Rr||(Rr={}));class Pr{constructor(t,e,n,i,s,r,o,a){this.name=t,this.size=e,this.count=n,this.type=i,this.hasAlpha=s,this.hasDepth=r,this.hasStencil=o,this.isCompressed=a}}class Or{constructor(t=0,e=0){this.bufferSize=t,this.textureSize=e}}const Dr=Object.freeze([new Pr("UNKNOWN",0,0,Ar.NONE,!1,!1,!1,!1),new Pr("A8",1,1,Ar.UNORM,!0,!1,!1,!1),new Pr("L8",1,1,Ar.UNORM,!1,!1,!1,!1),new Pr("LA8",1,2,Ar.UNORM,!0,!1,!1,!1),new Pr("R8",1,1,Ar.UNORM,!1,!1,!1,!1),new Pr("R8SN",1,1,Ar.SNORM,!1,!1,!1,!1),new Pr("R8UI",1,1,Ar.UINT,!1,!1,!1,!1),new Pr("R8I",1,1,Ar.INT,!1,!1,!1,!1),new Pr("R16F",2,1,Ar.FLOAT,!1,!1,!1,!1),new Pr("R16UI",2,1,Ar.UINT,!1,!1,!1,!1),new Pr("R16I",2,1,Ar.INT,!1,!1,!1,!1),new Pr("R32F",4,1,Ar.FLOAT,!1,!1,!1,!1),new Pr("R32UI",4,1,Ar.UINT,!1,!1,!1,!1),new Pr("R32I",4,1,Ar.INT,!1,!1,!1,!1),new Pr("RG8",2,2,Ar.UNORM,!1,!1,!1,!1),new Pr("RG8SN",2,2,Ar.SNORM,!1,!1,!1,!1),new Pr("RG8UI",2,2,Ar.UINT,!1,!1,!1,!1),new Pr("RG8I",2,2,Ar.INT,!1,!1,!1,!1),new Pr("RG16F",4,2,Ar.FLOAT,!1,!1,!1,!1),new Pr("RG16UI",4,2,Ar.UINT,!1,!1,!1,!1),new Pr("RG16I",4,2,Ar.INT,!1,!1,!1,!1),new Pr("RG32F",8,2,Ar.FLOAT,!1,!1,!1,!1),new Pr("RG32UI",8,2,Ar.UINT,!1,!1,!1,!1),new Pr("RG32I",8,2,Ar.INT,!1,!1,!1,!1),new Pr("RGB8",3,3,Ar.UNORM,!1,!1,!1,!1),new Pr("SRGB8",3,3,Ar.UNORM,!1,!1,!1,!1),new Pr("RGB8SN",3,3,Ar.SNORM,!1,!1,!1,!1),new Pr("RGB8UI",3,3,Ar.UINT,!1,!1,!1,!1),new Pr("RGB8I",3,3,Ar.INT,!1,!1,!1,!1),new Pr("RGB16F",6,3,Ar.FLOAT,!1,!1,!1,!1),new Pr("RGB16UI",6,3,Ar.UINT,!1,!1,!1,!1),new Pr("RGB16I",6,3,Ar.INT,!1,!1,!1,!1),new Pr("RGB32F",12,3,Ar.FLOAT,!1,!1,!1,!1),new Pr("RGB32UI",12,3,Ar.UINT,!1,!1,!1,!1),new Pr("RGB32I",12,3,Ar.INT,!1,!1,!1,!1),new Pr("RGBA8",4,4,Ar.UNORM,!0,!1,!1,!1),new Pr("BGRA8",4,4,Ar.UNORM,!0,!1,!1,!1),new Pr("SRGB8_A8",4,4,Ar.UNORM,!0,!1,!1,!1),new Pr("RGBA8SN",4,4,Ar.SNORM,!0,!1,!1,!1),new Pr("RGBA8UI",4,4,Ar.UINT,!0,!1,!1,!1),new Pr("RGBA8I",4,4,Ar.INT,!0,!1,!1,!1),new Pr("RGBA16F",8,4,Ar.FLOAT,!0,!1,!1,!1),new Pr("RGBA16UI",8,4,Ar.UINT,!0,!1,!1,!1),new Pr("RGBA16I",8,4,Ar.INT,!0,!1,!1,!1),new Pr("RGBA32F",16,4,Ar.FLOAT,!0,!1,!1,!1),new Pr("RGBA32UI",16,4,Ar.UINT,!0,!1,!1,!1),new Pr("RGBA32I",16,4,Ar.INT,!0,!1,!1,!1),new Pr("R5G6B5",2,3,Ar.UNORM,!1,!1,!1,!1),new Pr("R11G11B10F",4,3,Ar.FLOAT,!1,!1,!1,!1),new Pr("RGB5A1",2,4,Ar.UNORM,!0,!1,!1,!1),new Pr("RGBA4",2,4,Ar.UNORM,!0,!1,!1,!1),new Pr("RGB10A2",2,4,Ar.UNORM,!0,!1,!1,!1),new Pr("RGB10A2UI",2,4,Ar.UINT,!0,!1,!1,!1),new Pr("RGB9E5",2,4,Ar.FLOAT,!0,!1,!1,!1),new Pr("D16",2,1,Ar.UINT,!1,!0,!1,!1),new Pr("D16S8",3,2,Ar.UINT,!1,!0,!0,!1),new Pr("D24",3,1,Ar.UINT,!1,!0,!1,!1),new Pr("D24S8",4,2,Ar.UINT,!1,!0,!0,!1),new Pr("D32F",4,1,Ar.FLOAT,!1,!0,!1,!1),new Pr("D32FS8",5,2,Ar.FLOAT,!1,!0,!0,!1),new Pr("BC1",1,3,Ar.UNORM,!1,!1,!1,!0),new Pr("BC1_ALPHA",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("BC1_SRGB",1,3,Ar.UNORM,!1,!1,!1,!0),new Pr("BC1_SRGB_ALPHA",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("BC2",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("BC2_SRGB",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("BC3",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("BC3_SRGB",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("BC4",1,1,Ar.UNORM,!1,!1,!1,!0),new Pr("BC4_SNORM",1,1,Ar.SNORM,!1,!1,!1,!0),new Pr("BC5",1,2,Ar.UNORM,!1,!1,!1,!0),new Pr("BC5_SNORM",1,2,Ar.SNORM,!1,!1,!1,!0),new Pr("BC6H_UF16",1,3,Ar.UFLOAT,!1,!1,!1,!0),new Pr("BC6H_SF16",1,3,Ar.FLOAT,!1,!1,!1,!0),new Pr("BC7",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("BC7_SRGB",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ETC_RGB8",1,3,Ar.UNORM,!1,!1,!1,!0),new Pr("ETC2_RGB8",1,3,Ar.UNORM,!1,!1,!1,!0),new Pr("ETC2_SRGB8",1,3,Ar.UNORM,!1,!1,!1,!0),new Pr("ETC2_RGB8_A1",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ETC2_SRGB8_A1",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ETC2_RGBA8",2,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ETC2_SRGB8_A8",2,4,Ar.UNORM,!0,!1,!1,!0),new Pr("EAC_R11",1,1,Ar.UNORM,!1,!1,!1,!0),new Pr("EAC_R11SN",1,1,Ar.SNORM,!1,!1,!1,!0),new Pr("EAC_RG11",2,2,Ar.UNORM,!1,!1,!1,!0),new Pr("EAC_RG11SN",2,2,Ar.SNORM,!1,!1,!1,!0),new Pr("PVRTC_RGB2",2,3,Ar.UNORM,!1,!1,!1,!0),new Pr("PVRTC_RGBA2",2,4,Ar.UNORM,!0,!1,!1,!0),new Pr("PVRTC_RGB4",2,3,Ar.UNORM,!1,!1,!1,!0),new Pr("PVRTC_RGBA4",2,4,Ar.UNORM,!0,!1,!1,!0),new Pr("PVRTC2_2BPP",2,4,Ar.UNORM,!0,!1,!1,!0),new Pr("PVRTC2_4BPP",2,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_4x4",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_5x4",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_5x5",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_6x5",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_6x6",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_8x5",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_8x6",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_8x8",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_10x5",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_10x6",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_10x8",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_10x10",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_12x10",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_RGBA_12x12",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_4x4",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_5x4",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_5x5",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_6x5",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_6x6",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_8x5",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_8x6",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_8x8",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_10x5",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_10x6",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_10x8",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_10x10",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_12x10",1,4,Ar.UNORM,!0,!1,!1,!0),new Pr("ASTC_SRGBA_12x12",1,4,Ar.UNORM,!0,!1,!1,!0)]);function Mr(t,e,n,i){if(!Dr[t].isCompressed)return e*n*i*Dr[t].size;switch(t){case Xs.BC1:case Xs.BC1_ALPHA:case Xs.BC1_SRGB:case Xs.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case Xs.BC2:case Xs.BC2_SRGB:case Xs.BC3:case Xs.BC3_SRGB:case Xs.BC4:case Xs.BC4_SNORM:case Xs.BC6H_SF16:case Xs.BC6H_UF16:case Xs.BC7:case Xs.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case Xs.BC5:case Xs.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(n/4)*32*i;case Xs.ETC_RGB8:case Xs.ETC2_RGB8:case Xs.ETC2_SRGB8:case Xs.ETC2_RGB8_A1:case Xs.EAC_R11:case Xs.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(n/4)*8*i;case Xs.ETC2_RGBA8:case Xs.ETC2_SRGB8_A1:case Xs.EAC_RG11:case Xs.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case Xs.PVRTC_RGB2:case Xs.PVRTC_RGBA2:case Xs.PVRTC2_2BPP:return Math.ceil(Math.max(e,16)*Math.max(n,8)/4)*i;case Xs.PVRTC_RGB4:case Xs.PVRTC_RGBA4:case Xs.PVRTC2_4BPP:return Math.ceil(Math.max(e,8)*Math.max(n,8)/2)*i;case Xs.ASTC_RGBA_4x4:case Xs.ASTC_SRGBA_4x4:return Math.ceil(e/4)*Math.ceil(n/4)*16*i;case Xs.ASTC_RGBA_5x4:case Xs.ASTC_SRGBA_5x4:return Math.ceil(e/5)*Math.ceil(n/4)*16*i;case Xs.ASTC_RGBA_5x5:case Xs.ASTC_SRGBA_5x5:return Math.ceil(e/5)*Math.ceil(n/5)*16*i;case Xs.ASTC_RGBA_6x5:case Xs.ASTC_SRGBA_6x5:return Math.ceil(e/6)*Math.ceil(n/5)*16*i;case Xs.ASTC_RGBA_6x6:case Xs.ASTC_SRGBA_6x6:return Math.ceil(e/6)*Math.ceil(n/6)*16*i;case Xs.ASTC_RGBA_8x5:case Xs.ASTC_SRGBA_8x5:return Math.ceil(e/8)*Math.ceil(n/5)*16*i;case Xs.ASTC_RGBA_8x6:case Xs.ASTC_SRGBA_8x6:return Math.ceil(e/8)*Math.ceil(n/6)*16*i;case Xs.ASTC_RGBA_8x8:case Xs.ASTC_SRGBA_8x8:return Math.ceil(e/8)*Math.ceil(n/8)*16*i;case Xs.ASTC_RGBA_10x5:case Xs.ASTC_SRGBA_10x5:return Math.ceil(e/10)*Math.ceil(n/5)*16*i;case Xs.ASTC_RGBA_10x6:case Xs.ASTC_SRGBA_10x6:return Math.ceil(e/10)*Math.ceil(n/6)*16*i;case Xs.ASTC_RGBA_10x8:case Xs.ASTC_SRGBA_10x8:return Math.ceil(e/10)*Math.ceil(n/8)*16*i;case Xs.ASTC_RGBA_10x10:case Xs.ASTC_SRGBA_10x10:return Math.ceil(e/10)*Math.ceil(n/10)*16*i;case Xs.ASTC_RGBA_12x10:case Xs.ASTC_SRGBA_12x10:return Math.ceil(e/12)*Math.ceil(n/10)*16*i;case Xs.ASTC_RGBA_12x12:case Xs.ASTC_SRGBA_12x12:return Math.ceil(e/12)*Math.ceil(n/12)*16*i;default:return 0}}function Nr(t,e,n,i,s){let r=0;for(let o=0;o<s;++o)r+=Mr(t,e,n,i),e=Math.max(e>>1,1),n=Math.max(n>>1,1);return r}const Lr=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function zr(t){return Lr[t]||0}function Br(t){const e=t.size/t.count;switch(t.type){case Ar.UNORM:case Ar.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Ar.SNORM:case Ar.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Ar.FLOAT:return Float32Array}return Float32Array}var Fr=Object.freeze({__proto__:null,MAX_ATTACHMENTS:4,get ObjectType(){return js},Obj:Ir,get AttributeName(){return Ws},get Type(){return qs},get Format(){return Xs},get BufferUsageBit(){return Ys},get MemoryUsageBit(){return Ks},get BufferFlagBit(){return $s},get BufferAccessBit(){return Zs},get PrimitiveMode(){return Js},get PolygonMode(){return Qs},get ShadeModel(){return tr},get CullMode(){return er},get ComparisonFunc(){return ir},get StencilOp(){return sr},get BlendOp(){return rr},get BlendFactor(){return or},get ColorMask(){return ar},get Filter(){return cr},get Address(){return lr},get TextureType(){return hr},get TextureUsageBit(){return _r},get SampleCount(){return ur},get TextureFlagBit(){return dr},get ShaderStageFlagBit(){return pr},get DescriptorType(){return mr},get CommandBufferType(){return fr},get LoadOp(){return gr},get StoreOp(){return vr},get TextureLayout(){return yr},get PipelineBindPoint(){return xr},get DynamicStateFlagBit(){return Sr},get StencilFace(){return Tr},get QueueType(){return Er},get ClearFlag(){return Cr},get FormatType(){return Ar},get API(){return br},get SurfaceTransform(){return wr},get Feature(){return Rr},FormatInfo:Pr,MemoryStatus:Or,FormatInfos:Dr,FormatSize:Mr,FormatSurfaceSize:Nr,GetTypeSize:zr,getTypedArrayConstructor:Br});class Ur{constructor(t=0,e=0,n=1,i=1){this.x=t,this.y=e,this.width=n,this.height=i}}class Gr{constructor(t=0,e=0,n=0,i=0,s=0,r=1){this.left=t,this.top=e,this.width=n,this.height=i,this.minDepth=s,this.maxDepth=r}}class Hr{constructor(t=0,e=0,n=0,i=0){this.x=t,this.y=e,this.z=n,this.w=i}}class Vr{constructor(t=0,e=0,n=0){this.x=t,this.y=e,this.z=n}}class kr{constructor(t=0,e=0,n=1){this.width=t,this.height=e,this.depth=n}}class jr{constructor(t=0,e=0,n=1){this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=n}}class Wr{constructor(t=0,e=0,n=new Vr,i=new kr,s=new jr){this.buffStride=t,this.buffTexHeight=e,this.texOffset=n,this.texExtent=i,this.texSubres=s}}class qr{constructor(t=!1,e=Qs.FILL,n=tr.GOURAND,i=er.BACK,s=!0,r=!1,o=0,a=0,c=0,l=!0,h=!1,_=1){this.h=void 0,this.h=ds.alloc(),this.assignProperties(t,e,n,i,s,r,o,a,c,l,h,_)}get isDiscard(){return!!ds.get(this.h,_s.IS_DISCARD)}set isDiscard(t){ds.set(this.h,_s.IS_DISCARD,t?1:0)}get polygonMode(){return ds.get(this.h,_s.POLYGO_MODEL)}set polygonMode(t){ds.set(this.h,_s.POLYGO_MODEL,t)}get shadeModel(){return ds.get(this.h,_s.SHADE_MODEL)}set shadeModel(t){ds.set(this.h,_s.SHADE_MODEL,t)}get cullMode(){return ds.get(this.h,_s.CULL_MODE)}set cullMode(t){ds.set(this.h,_s.CULL_MODE,t)}get isFrontFaceCCW(){return!!ds.get(this.h,_s.IS_FRONT_FACE_CCW)}set isFrontFaceCCW(t){ds.set(this.h,_s.IS_FRONT_FACE_CCW,t?1:0)}get depthBiasEnabled(){return!!ds.get(this.h,_s.DEPTH_BIAS_ENABLED)}set depthBiasEnabled(t){ds.set(this.h,_s.DEPTH_BIAS_ENABLED,t?1:0)}get depthBias(){return ds.get(this.h,_s.DEPTH_BIAS)}set depthBias(t){ds.set(this.h,_s.DEPTH_BIAS,t)}get depthBiasClamp(){return ds.get(this.h,_s.DEPTH_BIAS_CLAMP)}set depthBiasClamp(t){ds.set(this.h,_s.DEPTH_BIAS_CLAMP,t)}get depthBiasSlop(){return ds.get(this.h,_s.DEPTH_BIAS_SLOP)}set depthBiasSlop(t){ds.set(this.h,_s.DEPTH_BIAS_SLOP,t)}get isDepthClip(){return!!ds.get(this.h,_s.IS_DEPTH_CLIP)}set isDepthClip(t){ds.set(this.h,_s.IS_DEPTH_CLIP,t?1:0)}get isMultisample(){return!!ds.get(this.h,_s.IS_MULTI_SAMPLE)}set isMultisample(t){ds.set(this.h,_s.IS_MULTI_SAMPLE,t?1:0)}get lineWidth(){return ds.get(this.h,_s.LINE_WIDTH)}set lineWidth(t){ds.set(this.h,_s.LINE_WIDTH,t)}get handle(){return this.h}reset(){this.assignProperties(!1,Qs.FILL,tr.GOURAND,er.BACK,!0,!1,0,0,0,!0,!1,1)}assign(t){t&&this.assignProperties(t.isDiscard,t.polygonMode,t.shadeModel,t.cullMode,t.isFrontFaceCCW,t.depthBiasEnabled,t.depthBias,t.depthBiasClamp,t.depthBiasSlop,t.isDepthClip,t.isMultisample,t.lineWidth)}destroy(){this.h&&(ds.free(this.h),this.h=0)}assignProperties(t,e,n,i,s,r,o,a,c,l,h,_){void 0!==t&&(this.isDiscard=t),void 0!==e&&(this.polygonMode=e),void 0!==n&&(this.shadeModel=n),void 0!==i&&(this.cullMode=i),void 0!==s&&(this.isFrontFaceCCW=s),void 0!==r&&(this.depthBiasEnabled=r),void 0!==o&&(this.depthBias=o),void 0!==a&&(this.depthBiasClamp=a),void 0!==c&&(this.depthBiasSlop=c),void 0!==l&&(this.isDepthClip=l),void 0!==h&&(this.isMultisample=h),void 0!==_&&(this.lineWidth=_)}}class Xr{constructor(t=!0,e=!0,n=ir.LESS,i=!1,s=ir.ALWAYS,r=65535,o=65535,a=sr.KEEP,c=sr.KEEP,l=sr.KEEP,h=1,_=!1,u=ir.ALWAYS,d=65535,p=65535,m=sr.KEEP,f=sr.KEEP,g=sr.KEEP,v=1){this.h=void 0,this.h=fs.alloc(),this.assignProperties(t,e,n,i,s,r,o,a,c,l,h,_,u,d,p,m,f,g,v)}get depthTest(){return!!fs.get(this.h,ps.DEPTH_TEST)}set depthTest(t){fs.set(this.h,ps.DEPTH_TEST,t?1:0)}get depthWrite(){return!!fs.get(this.h,ps.DEPTH_WRITE)}set depthWrite(t){fs.set(this.h,ps.DEPTH_WRITE,t?1:0)}get depthFunc(){return fs.get(this.h,ps.DEPTH_FUNC)}set depthFunc(t){fs.set(this.h,ps.DEPTH_FUNC,t)}get stencilTestFront(){return!!fs.get(this.h,ps.STENCIL_TEST_FRONT)}set stencilTestFront(t){fs.set(this.h,ps.STENCIL_TEST_FRONT,t?1:0)}get stencilFuncFront(){return fs.get(this.h,ps.STENCIL_FUNC_FRONT)}set stencilFuncFront(t){fs.set(this.h,ps.STENCIL_FUNC_FRONT,t)}get stencilReadMaskFront(){return fs.get(this.h,ps.STENCIL_READ_MASK_FRONT)}set stencilReadMaskFront(t){fs.set(this.h,ps.STENCIL_READ_MASK_FRONT,t)}get stencilWriteMaskFront(){return fs.get(this.h,ps.STENCIL_WRITE_MASK_FRONT)}set stencilWriteMaskFront(t){fs.set(this.h,ps.STENCIL_WRITE_MASK_FRONT,t)}get stencilFailOpFront(){return fs.get(this.h,ps.STENCIL_FAIL_OP_FRONT)}set stencilFailOpFront(t){fs.set(this.h,ps.STENCIL_FAIL_OP_FRONT,t)}get stencilZFailOpFront(){return fs.get(this.h,ps.STENCIL_Z_FAIL_OP_FRONT)}set stencilZFailOpFront(t){fs.set(this.h,ps.STENCIL_Z_FAIL_OP_FRONT,t)}get stencilPassOpFront(){return fs.get(this.h,ps.STENCIL_PASS_OP_FRONT)}set stencilPassOpFront(t){fs.set(this.h,ps.STENCIL_PASS_OP_FRONT,t)}get stencilRefFront(){return fs.get(this.h,ps.STENCIL_REF_FRONT)}set stencilRefFront(t){fs.set(this.h,ps.STENCIL_REF_FRONT,t)}get stencilTestBack(){return!!fs.get(this.h,ps.STENCIL_TEST_BACK)}set stencilTestBack(t){fs.set(this.h,ps.STENCIL_TEST_BACK,t?1:0)}get stencilFuncBack(){return fs.get(this.h,ps.STENCIL_FUNC_BACK)}set stencilFuncBack(t){fs.set(this.h,ps.STENCIL_FUNC_BACK,t)}get stencilReadMaskBack(){return fs.get(this.h,ps.STENCIL_READ_MADK_BACK)}set stencilReadMaskBack(t){fs.set(this.h,ps.STENCIL_READ_MADK_BACK,t)}get stencilWriteMaskBack(){return fs.get(this.h,ps.STENCIL_WRITE_MASK_BACK)}set stencilWriteMaskBack(t){fs.set(this.h,ps.STENCIL_WRITE_MASK_BACK,t)}get stencilFailOpBack(){return fs.get(this.h,ps.STENCIL_FAIL_OP_BACK)}set stencilFailOpBack(t){fs.set(this.h,ps.STENCIL_FAIL_OP_BACK,t)}get stencilZFailOpBack(){return fs.get(this.h,ps.STENCIL_Z_FAIL_OP_BACK)}set stencilZFailOpBack(t){fs.set(this.h,ps.STENCIL_Z_FAIL_OP_BACK,t)}get stencilPassOpBack(){return fs.get(this.h,ps.STENCIL_PASS_OP_BACK)}set stencilPassOpBack(t){fs.set(this.h,ps.STENCIL_PASS_OP_BACK,t)}get stencilRefBack(){return fs.get(this.h,ps.STENCIL_REF_BACK)}set stencilRefBack(t){fs.set(this.h,ps.STENCIL_REF_BACK,t)}get handle(){return this.h}reset(){this.assignProperties(!0,!0,ir.LESS,!1,ir.ALWAYS,65535,65535,sr.KEEP,sr.KEEP,sr.KEEP,1,!1,ir.ALWAYS,65535,65535,sr.KEEP,sr.KEEP,sr.KEEP,1)}assign(t){t&&this.assignProperties(t.depthTest,t.depthWrite,t.depthFunc,t.stencilTestFront,t.stencilFuncFront,t.stencilReadMaskFront,t.stencilWriteMaskFront,t.stencilFailOpFront,t.stencilZFailOpFront,t.stencilPassOpFront,t.stencilRefFront,t.stencilTestBack,t.stencilFuncBack,t.stencilReadMaskBack,t.stencilWriteMaskBack,t.stencilFailOpBack,t.stencilZFailOpBack,t.stencilPassOpBack,t.stencilRefBack)}destroy(){fs.free(this.h),this.h=0}assignProperties(t,e,n,i,s,r,o,a,c,l,h,_,u,d,p,m,f,g,v){void 0!==t&&(this.depthTest=t),void 0!==e&&(this.depthWrite=e),void 0!==n&&(this.depthFunc=n),void 0!==i&&(this.stencilTestFront=i),void 0!==s&&(this.stencilFuncFront=s),void 0!==r&&(this.stencilReadMaskFront=r),void 0!==o&&(this.stencilWriteMaskFront=o),void 0!==a&&(this.stencilFailOpFront=a),void 0!==c&&(this.stencilZFailOpFront=c),void 0!==l&&(this.stencilPassOpFront=l),void 0!==h&&(this.stencilRefFront=h),void 0!==_&&(this.stencilTestBack=_),void 0!==u&&(this.stencilFuncBack=u),void 0!==d&&(this.stencilReadMaskBack=d),void 0!==p&&(this.stencilWriteMaskBack=p),void 0!==m&&(this.stencilFailOpBack=m),void 0!==f&&(this.stencilZFailOpBack=f),void 0!==g&&(this.stencilPassOpBack=g),void 0!==v&&(this.stencilRefBack=v)}}class Yr{constructor(t=!1,e=or.ONE,n=or.ZERO,i=rr.ADD,s=or.ONE,r=or.ZERO,o=rr.ADD,a=ar.ALL){this.h=void 0,this.h=vs.alloc(),this.assignProperties(t,e,n,i,s,r,o,a)}get blend(){return!!vs.get(this.h,gs.BLEND)}set blend(t){vs.set(this.h,gs.BLEND,t?1:0)}get blendSrc(){return vs.get(this.h,gs.BLEND_SRC)}set blendSrc(t){vs.set(this.h,gs.BLEND_SRC,t)}get blendDst(){return vs.get(this.h,gs.BLEND_DST)}set blendDst(t){vs.set(this.h,gs.BLEND_DST,t)}get blendEq(){return vs.get(this.h,gs.BLEND_EQ)}set blendEq(t){vs.set(this.h,gs.BLEND_EQ,t)}get blendSrcAlpha(){return vs.get(this.h,gs.BLEND_SRC_ALPHA)}set blendSrcAlpha(t){vs.set(this.h,gs.BLEND_SRC_ALPHA,t)}get blendDstAlpha(){return vs.get(this.h,gs.BLEND_DST_ALPHA)}set blendDstAlpha(t){vs.set(this.h,gs.BLEND_DST_ALPHA,t)}get blendAlphaEq(){return vs.get(this.h,gs.BLEND_ALPHA_EQ)}set blendAlphaEq(t){vs.set(this.h,gs.BLEND_ALPHA_EQ,t)}get blendColorMask(){return vs.get(this.h,gs.BLEND_COLOR_MASK)}set blendColorMask(t){vs.set(this.h,gs.BLEND_COLOR_MASK,t)}get handle(){return this.h}reset(){this.assignProperties(!1,or.ONE,or.ZERO,rr.ADD,or.ONE,or.ZERO,rr.ADD,ar.ALL)}destroy(){vs.free(this.h),this.h=0}assign(t){t&&this.assignProperties(t.blend,t.blendSrc,t.blendDst,t.blendEq,t.blendSrcAlpha,t.blendDstAlpha,t.blendAlphaEq,t.blendColorMask)}assignProperties(t,e,n,i,s,r,o,a){void 0!==t&&(this.blend=t),void 0!==e&&(this.blendSrc=e),void 0!==n&&(this.blendDst=n),void 0!==i&&(this.blendEq=i),void 0!==s&&(this.blendSrcAlpha=s),void 0!==r&&(this.blendDstAlpha=r),void 0!==o&&(this.blendAlphaEq=o),void 0!==a&&(this.blendColorMask=a)}}class Kr{constructor(t=!1,e=!1,n=new Hr,i=[new Yr]){this.h=void 0,this.hBt=void 0,this.targets=void 0,this._blendColor=void 0,this.h=Ss.alloc(),this.targets=i,this.blendColor=n,this.isA2c=t,this.isIndepend=e,this.blendColor=n,this.hBt=si.alloc(),Ss.set(this.h,ys.BLEND_TARGET,this.hBt);for(let t=0,e=i.length;t<e;++t)si.push(this.hBt,i[t].handle)}get isA2c(){return!!Ss.get(this.h,ys.IS_A2C)}set isA2c(t){Ss.set(this.h,ys.IS_A2C,t?1:0)}get isIndepend(){return!!Ss.get(this.h,ys.IS_INDEPEND)}set isIndepend(t){Ss.set(this.h,ys.IS_INDEPEND,t?1:0)}get blendColor(){return this._blendColor}set blendColor(t){this._blendColor=t,Ss.setVec4(this.h,ys.BLEND_COLOR,t)}get handle(){return this.h}setTarget(t,e){let n=this.targets[t];n||(n=this.targets[t]=new Yr,si.assign(this.hBt,t,n.handle)),n.assign(e)}reset(){this.isA2c=!1,this.isIndepend=!1,Ss.setVec4(this.h,ys.BLEND_COLOR,new Hr(0,0,0,0));const t=this.targets;for(let e=1,n=t.length;e<n;++e)t[e].destroy();t.length=1,t[0].reset(),si.clear(this.hBt),si.push(this.hBt,t[0].handle)}destroy(){Ss.free(this.h),this.h=0,si.free(this.hBt),this.hBt=0;for(let t=0,e=this.targets.length;t<e;++t)this.targets[t].destroy();this.targets=null}}const $r=gfx.PipelineStateInfo,Zr=gfx.InputState,Jr=gfx.PipelineState;Xt(Xs);class Qr{constructor(t=[],e=[],n=0){this.bufferOffsets=t,this.samplerOffsets=e,this.flexibleSet=n}}class to{constructor(t,e=!0,n=!0,i=1,s=1,r=1,o=new Qr){this.canvasElm=t,this.isAntialias=e,this.isPremultipliedAlpha=n,this.devicePixelRatio=i,this.nativeWidth=s,this.nativeHeight=r,this.bindingMappingInfo=o}}class eo{constructor(t,e=_r.NONE,n=Xs.UNKNOWN,i=0,s=0,r=dr.NONE,o=1,a=1,c=ur.X1,l=1){this.type=t,this.usage=e,this.format=n,this.width=i,this.height=s,this.flags=r,this.layerCount=o,this.levelCount=a,this.samples=c,this.depth=l}}function no(t){return t>0&&0==(t&t-1)}class io extends Ir{get type(){return this._type}get usage(){return this._usage}get format(){return this._format}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get layerCount(){return this._layerCount}get levelCount(){return this._levelCount}get samples(){return this._samples}get flags(){return this._flags}get size(){return this._size}get buffer(){return this._buffer}constructor(t){super(js.TEXTURE),this._device=void 0,this._type=hr.TEX2D,this._usage=_r.NONE,this._format=Xs.UNKNOWN,this._width=0,this._height=0,this._depth=1,this._layerCount=1,this._levelCount=1,this._samples=ur.X1,this._flags=dr.NONE,this._isPowerOf2=!1,this._size=0,this._buffer=null,this._device=t}}class so{constructor(t=pr.NONE,e=""){this.stage=t,this.source=e}}class ro{constructor(t="",e=qs.UNKNOWN,n=1){this.name=t,this.type=e,this.count=n}}class oo{constructor(t=-1,e=-1,n="",i=[],s=1){this.set=t,this.binding=e,this.name=n,this.members=i,this.count=s}}class ao{constructor(t=-1,e=-1,n="",i=qs.UNKNOWN,s=1){this.set=t,this.binding=e,this.name=n,this.type=i,this.count=s}}class co{constructor(t="",e=[],n=[],i=[],s=[]){this.name=t,this.stages=e,this.attributes=n,this.blocks=i,this.samplers=s}}class lo extends Ir{get id(){return this._id}get name(){return this._name}get attributes(){return this._attributes}get blocks(){return this._blocks}get samplers(){return this._samplers}constructor(t){super(js.SHADER),this._device=void 0,this._id=void 0,this._name="",this._stages=[],this._attributes=[],this._blocks=[],this._samplers=[],this._device=t,this._id=lo._shaderIdGen++}}lo._shaderIdGen=0;class ho{constructor(t=0,e=0,n=0,i=0,s=0,r=0,o=0){this.vertexCount=t,this.firstVertex=e,this.indexCount=n,this.firstIndex=i,this.vertexOffset=s,this.instanceCount=r,this.firstInstance=o}}class _o{constructor(t=[]){this.drawInfos=t}}class uo{constructor(t,e,n=0,i=0,s=$s.NONE){this.usage=t,this.memUsage=e,this.size=n,this.stride=i,this.flags=s}}class po{constructor(t,e=0,n=0){this.buffer=t,this.offset=e,this.range=n}}class mo extends Ir{get usage(){return this._usage}get memUsage(){return this._memUsage}get size(){return this._size}get stride(){return this._stride}get count(){return this._count}get flags(){return this._flags}get backupBuffer(){return this._bakcupBuffer}constructor(t){super(js.BUFFER),this._device=void 0,this._usage=Ys.NONE,this._memUsage=Ks.NONE,this._size=0,this._stride=1,this._count=0,this._flags=$s.NONE,this._bakcupBuffer=null,this._indirectBuffer=null,this._isBufferView=!1,this._device=t}}const fo=String.prototype.charCodeAt;function go(t){return this[t]}function vo(t,e){let n=t.length,i=e^n,s=0;const r="string"==typeof t?fo:go;for(;n>=4;){let e=255&r.call(t,s)|(255&r.call(t,++s))<<8|(255&r.call(t,++s))<<16|(255&r.call(t,++s))<<24;e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),e^=e>>>24,e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^e,n-=4,++s}switch(n){case 3:i^=(255&r.call(t,s+2))<<16;case 2:i^=(255&r.call(t,s+1))<<8;case 1:i^=255&r.call(t,s),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)}return i^=i>>>13,i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16),i^=i>>>15,i>>>0}class yo{constructor(t=Xs.UNKNOWN,e=1,n=gr.CLEAR,i=vr.STORE,s=yr.UNDEFINED,r=yr.PRESENT_SRC){this.format=t,this.sampleCount=e,this.loadOp=n,this.storeOp=i,this.beginLayout=s,this.endLayout=r}}class xo{constructor(t=Xs.UNKNOWN,e=1,n=gr.CLEAR,i=vr.STORE,s=gr.CLEAR,r=vr.STORE,o=yr.UNDEFINED,a=yr.DEPTH_STENCIL_ATTACHMENT_OPTIMAL){this.format=t,this.sampleCount=e,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=s,this.stencilStoreOp=r,this.beginLayout=o,this.endLayout=a}}class So{constructor(t=[],e=null,n=[]){this.colorAttachments=t,this.depthStencilAttachment=e,this.subPasses=n}}class To extends Ir{get colorAttachments(){return this._colorInfos}get depthStencilAttachment(){return this._depthStencilInfo}get subPasses(){return this._subPasses}get hash(){return this._hash}constructor(t){super(js.RENDER_PASS),this._device=void 0,this._colorInfos=[],this._depthStencilInfo=null,this._subPasses=[],this._hash=0,this._device=t}computeHash(){let t="";if(this._subPasses.length)for(let e=0;e<this._subPasses.length;++e){const n=this._subPasses[e];if(n.inputs.length){t+="ia";for(let e=0;e<n.inputs.length;++e){const i=this._colorInfos[n.inputs[e]];t+=`,${i.format},${i.sampleCount}`}}if(n.colors.length){t+="ca";for(let e=0;e<n.inputs.length;++e){const i=this._colorInfos[n.inputs[e]];t+=`,${i.format},${i.sampleCount}`}}if(n.depthStencil>=0){const e=this._colorInfos[n.depthStencil];t+=`ds,${e.format},${e.sampleCount}`}}else{t+="ca";for(let e=0;e<this._colorInfos.length;++e){const n=this._colorInfos[e];t+=`,${n.format},${n.sampleCount}`}const e=this._depthStencilInfo;e&&(t+=`ds,${e.format},${e.sampleCount}`)}return vo(t,666)}}class Eo{constructor(t=cr.LINEAR,e=cr.LINEAR,n=cr.NONE,i=lr.WRAP,s=lr.WRAP,r=lr.WRAP,o=16,a=ir.NEVER,c=new Hr,l=0,h=0,_=0){this.minFilter=t,this.magFilter=e,this.mipFilter=n,this.addressU=i,this.addressV=s,this.addressW=r,this.maxAnisotropy=o,this.cmpFunc=a,this.borderColor=c,this.minLOD=l,this.maxLOD=h,this.mipLODBias=_}}class Co extends Ir{get minFilter(){return this._minFilter}get magFilter(){return this._magFilter}get mipFilter(){return this._mipFilter}get addressU(){return this._addressU}get addressV(){return this._addressV}get addressW(){return this._addressW}get maxAnisotropy(){return this._maxAnisotropy}get cmpFunc(){return this._cmpFunc}get borderColor(){return this._borderColor}get minLOD(){return this._minLOD}get maxLOD(){return this._maxLOD}get mipLODBias(){return this._mipLODBias}constructor(t){super(js.SAMPLER),this._device=void 0,this._minFilter=cr.LINEAR,this._magFilter=cr.LINEAR,this._mipFilter=cr.NONE,this._addressU=lr.WRAP,this._addressV=lr.WRAP,this._addressW=lr.WRAP,this._maxAnisotropy=16,this._cmpFunc=ir.NEVER,this._borderColor=new Hr,this._minLOD=0,this._maxLOD=0,this._mipLODBias=0,this._device=t}}const Ao=mr.UNIFORM_BUFFER|mr.DYNAMIC_UNIFORM_BUFFER|mr.STORAGE_BUFFER|mr.DYNAMIC_STORAGE_BUFFER,bo=mr.SAMPLER;class wo{constructor(t){this.layout=t}}class Ro extends Ir{get layout(){return this._layout}constructor(t){super(js.DESCRIPTOR_SET),this._device=void 0,this._layout=null,this._buffers=[],this._textures=[],this._samplers=[],this._isDirty=!1,this._device=t}bindBuffer(t,e,n=0){const i=this._layout.bindingIndices[t],s=this._layout.bindings[i];if(s)if(s.descriptorType&Ao){const i=this._layout.descriptorIndices[t];this._buffers[i+n]!==e&&(this._buffers[i+n]=e,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.UNIFORM_BUFFER.")}bindSampler(t,e,n=0){const i=this._layout.bindingIndices[t],s=this._layout.bindings[i];if(s)if(s.descriptorType&bo){const i=this._layout.descriptorIndices[t];this._samplers[i+n]!==e&&(this._samplers[i+n]=e,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.SAMPLER.")}bindTexture(t,e,n=0){const i=this._layout.bindingIndices[t],s=this._layout.bindings[i];if(s)if(s.descriptorType&bo){const i=this._layout.descriptorIndices[t];this._textures[i+n]!==e&&(this._textures[i+n]=e,this._isDirty=!0)}else console.warn("Setting binding is not DescriptorType.SAMPLER.")}getBuffer(t,e=0){const n=this._layout.descriptorIndices[t];return this._buffers[n+e]}getSampler(t,e=0){const n=this._layout.descriptorIndices[t];return this._samplers[n+e]}getTexture(t,e=0){const n=this._layout.descriptorIndices[t];return this._textures[n+e]}}class Io{constructor(t=-1,e=mr.UNKNOWN,n=0,i=pr.NONE,s=[]){this.binding=t,this.descriptorType=e,this.count=n,this.stageFlags=i,this.immutableSamplers=s}}class Po{constructor(t=[]){this.bindings=t}}const Oo=mr.DYNAMIC_STORAGE_BUFFER|mr.DYNAMIC_UNIFORM_BUFFER;class Do extends Ir{get bindings(){return this._bindings}get bindingIndices(){return this._bindingIndices}get descriptorIndices(){return this._descriptorIndices}constructor(t){super(js.DESCRIPTOR_SET_LAYOUT),this._device=void 0,this._bindings=[],this._bindingIndices=[],this._descriptorIndices=[],this._device=t}}class Mo{constructor(t,e=fr.PRIMARY){this.queue=t,this.type=e}}class No extends Ir{get type(){return this._type}get queue(){return this._queue}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}constructor(t){super(js.COMMAND_BUFFER),this._device=void 0,this._queue=null,this._type=fr.PRIMARY,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._device=t}}class Lo{constructor(t,e=[],n=null,i=[],s=0){this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=n,this.colorMipmapLevels=i,this.depStencilMipmapLevel=s}}class zo extends Ir{get renderPass(){return this._renderPass}get colorTextures(){return this._colorTextures}get depthStencilTexture(){return this._depthStencilTexture}constructor(t){super(js.FRAMEBUFFER),this._device=void 0,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._device=t}}class Bo{constructor(t=[]){this.setLayouts=t}}class Fo extends Ir{get setLayouts(){return this._setLayouts}constructor(t){super(js.PIPELINE_LAYOUT),this._device=void 0,this._setLayouts=[],this._device=t}}class Uo extends Ir{constructor(t){super(js.FENCE),this._device=void 0,this._device=t}}class Go{constructor(t=Er.GRAPHICS){this.type=t}}class Ho extends Ir{get type(){return this._type}constructor(t){super(js.QUEUE),this._device=void 0,this._type=Er.GRAPHICS,this._isAsync=!1,this._device=t}isAsync(){return this._isAsync}}class Vo{constructor(t=[],e=[],n=null,i=null){this.attributes=t,this.vertexBuffers=e,this.indexBuffer=n,this.indirectBuffer=i}}class ko extends Ir{get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get attributes(){return this._attributes}get attributesHash(){return this._attributesHash}get vertexCount(){return this._vertexCount}set vertexCount(t){this._vertexCount=t}get firstVertex(){return this._firstVertex}set firstVertex(t){this._firstVertex=t}get indexCount(){return this._indexCount}set indexCount(t){this._indexCount=t}get firstIndex(){return this._firstIndex}set firstIndex(t){this._firstIndex=t}get vertexOffset(){return this._vertexOffset}set vertexOffset(t){this._vertexOffset=t}get instanceCount(){return this._instanceCount}set instanceCount(t){this._instanceCount=t}get firstInstance(){return this._firstInstance}set firstInstance(t){this._firstInstance=t}get indirectBuffer(){return this._indirectBuffer}constructor(t){super(js.INPUT_ASSEMBLER),this._device=void 0,this._attributes=[],this._vertexBuffers=[],this._indexBuffer=null,this._vertexCount=0,this._firstVertex=0,this._indexCount=0,this._firstIndex=0,this._vertexOffset=0,this._instanceCount=0,this._firstInstance=0,this._attributesHash=0,this._indirectBuffer=null,this._device=t}getVertexBuffer(t=0){return t<this._vertexBuffers.length?this._vertexBuffers[t]:null}computeAttributesHash(){let t="attrs";for(let e=0;e<this.attributes.length;++e){const n=this.attributes[e];t+=`,${n.name},${n.format},${n.isNormalized},${n.stream},${n.isInstanced}`}return vo(t,666)}}const jo=gfx.TextureViewInfo,Wo=gfx.Texture,qo=gfx.Device,Xo=gfx.Shader,Yo=gfx.Attribute,Ko=gfx.InputAssembler,$o=gfx.Buffer,Zo=gfx.Sampler,Jo=gfx.Fence,Qo=gfx.RenderPass,ta=gfx.Queue,ea=gfx.PipelineLayout,na=gfx.DescriptorSetLayout,ia=gfx.Framebuffer,sa=gfx.CommandBuffer;let ra;i.Device=qo,i.Buffer=$o,i.Texture=Wo,i.Sampler=Zo,i.Shader=Xo,i.InputAssembler=Ko,i.RenderPass=Qo,i.Framebuffer=ia,i.PipelineState=Jr,i.CommandBuffer=sa,i.Queue=ta,Object.assign(i,Fr),t("gfx",Object.freeze({__proto__:null,DeviceInfo:to,BindingMappingInfo:Qr,TextureInfo:eo,ShaderStage:so,UniformSampler:ao,UniformBlock:oo,Uniform:ro,ShaderInfo:co,DRAW_INFO_SIZE:28,BufferInfo:uo,BufferViewInfo:po,DrawInfo:ho,IndirectBuffer:_o,ColorAttachment:yo,DepthStencilAttachment:xo,SubPassInfo:class{constructor(t=xr.GRAPHICS,e=[],n=[],i=[],s=-1,r=[]){this.bindPoint=t,this.inputs=e,this.colors=n,this.resolves=i,this.depthStencil=s,this.preserves=r}},RenderPassInfo:So,SamplerInfo:Eo,DESCRIPTOR_BUFFER_TYPE:Ao,DESCRIPTOR_SAMPLER_TYPE:bo,DescriptorSetInfo:wo,DescriptorSetLayoutInfo:Po,DescriptorSetLayoutBinding:Io,CommandBufferInfo:Mo,FramebufferInfo:Lo,PipelineLayoutInfo:Bo,FenceInfo:class{constructor(){}},QueueInfo:Go,InputAssemblerInfo:Vo,MAX_ATTACHMENTS:4,get ObjectType(){return js},Obj:Ir,get AttributeName(){return Ws},get Type(){return qs},get Format(){return Xs},get BufferUsageBit(){return Ys},get MemoryUsageBit(){return Ks},get BufferFlagBit(){return $s},get BufferAccessBit(){return Zs},get PrimitiveMode(){return Js},get PolygonMode(){return Qs},get ShadeModel(){return tr},get CullMode(){return er},get ComparisonFunc(){return ir},get StencilOp(){return sr},get BlendOp(){return rr},get BlendFactor(){return or},get ColorMask(){return ar},get Filter(){return cr},get Address(){return lr},get TextureType(){return hr},get TextureUsageBit(){return _r},get SampleCount(){return ur},get TextureFlagBit(){return dr},get ShaderStageFlagBit(){return pr},get DescriptorType(){return mr},get CommandBufferType(){return fr},get LoadOp(){return gr},get StoreOp(){return vr},get TextureLayout(){return yr},get PipelineBindPoint(){return xr},get DynamicStateFlagBit(){return Sr},get StencilFace(){return Tr},get QueueType(){return Er},get ClearFlag(){return Cr},get FormatType(){return Ar},get API(){return br},get SurfaceTransform(){return wr},get Feature(){return Rr},FormatInfo:Pr,MemoryStatus:Or,FormatInfos:Dr,FormatSize:Mr,FormatSurfaceSize:Nr,GetTypeSize:zr,getTypedArrayConstructor:Br,Rect:Ur,Viewport:Gr,Color:Hr,Offset:Vr,Extent:kr,TextureSubres:jr,TextureCopy:class{constructor(t=new jr,e=new Vr,n=new jr,i=new Vr,s=new kr){this.srcSubres=t,this.srcOffset=e,this.dstSubres=n,this.dstOffset=i,this.extent=s}},BufferTextureCopy:Wr,RasterizerState:qr,DepthStencilState:Xr,BlendTarget:Yr,BlendState:Kr,PipelineStateInfo:$r,InputState:Zr,PipelineState:Jr,TextureViewInfo:jo,Texture:Wo,Device:qo,Shader:Xo,Attribute:Yo,InputAssembler:Ko,Buffer:$o,Sampler:Zo,Fence:Jo,RenderPass:Qo,Queue:ta,PipelineLayout:ea,DescriptorSetLayout:na,Framebuffer:ia,CommandBuffer:sa})),function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(ra||(ra={}));const oa=function(){const t=new ln(0,0,0);return function(e,n){const i=ln.dot(e.d,n.n);if(Math.abs(i)<Number.EPSILON)return 0;ln.multiplyScalar(t,n.n,n.d);const s=ln.dot(ln.subtract(t,t,e.o),n.n)/i;return s<0?0:s}}(),aa=function(){const t=new ln(0,0,0),e=new ln(0,0,0),n=new ln(0,0,0),i=new ln(0,0,0),s=new ln(0,0,0);return function(r,o,a){ln.subtract(t,o.b,o.a),ln.subtract(e,o.c,o.a),ln.cross(n,r.d,e);const c=ln.dot(t,n);if(c<Number.EPSILON&&(!a||c>-Number.EPSILON))return 0;const l=1/c;ln.subtract(i,r.o,o.a);const h=ln.dot(i,n)*l;if(h<0||h>1)return 0;ln.cross(s,i,t);const _=ln.dot(r.d,s)*l;if(_<0||h+_>1)return 0;const u=ln.dot(e,s)*l;return u<0?0:u}}(),ca=function(){const t=new ln(0,0,0);return function(e,n){const i=n.radius,s=n.center,r=e.o,o=e.d,a=i*i;ln.subtract(t,s,r);const c=t.lengthSqr(),l=ln.dot(t,o),h=a-(c-l*l);if(h<0)return 0;const _=Math.sqrt(h),u=c<a?l+_:l-_;return u<0?0:u}}(),la=function(){const t=new ln,e=new ln;return function(n,i){return ln.subtract(t,i.center,i.halfExtents),ln.add(e,i.center,i.halfExtents),ha(n,t,e)}}();function ha(t,e,n){const i=t.o,s=t.d,r=1/s.x,o=1/s.y,a=1/s.z,c=(e.x-i.x)*r,l=(n.x-i.x)*r,h=(e.y-i.y)*o,_=(n.y-i.y)*o,u=(e.z-i.z)*a,d=(n.z-i.z)*a,p=Math.max(Math.max(Math.min(c,l),Math.min(h,_)),Math.min(u,d)),m=Math.min(Math.min(Math.max(c,l),Math.max(h,_)),Math.max(u,d));return m<0||p>m?0:p>0?p:m}const _a=function(){let t=new ln,e=new ln,n=new ln;const i=new ln,s=new ln,r=new ln,o=new ln,a=new Array(3),c=new Array(3),l=new Array(3),h=new Array(6);return function(_,u){a[0]=u.halfExtents.x,a[1]=u.halfExtents.y,a[2]=u.halfExtents.z,t=u.center,e=_.o,n=_.d,ln.set(i,u.orientation.m00,u.orientation.m01,u.orientation.m02),ln.set(s,u.orientation.m03,u.orientation.m04,u.orientation.m05),ln.set(r,u.orientation.m06,u.orientation.m07,u.orientation.m08),ln.subtract(o,t,e),c[0]=ln.dot(i,n),c[1]=ln.dot(s,n),c[2]=ln.dot(r,n),l[0]=ln.dot(i,o),l[1]=ln.dot(s,o),l[2]=ln.dot(r,o);for(let t=0;t<3;++t){if(0===c[t]){if(-l[t]-a[t]>0||-l[t]+a[t]<0)return 0;c[t]=1e-7}h[2*t+0]=(l[t]+a[t])/c[t],h[2*t+1]=(l[t]-a[t])/c[t]}const d=Math.max(Math.max(Math.min(h[0],h[1]),Math.min(h[2],h[3])),Math.min(h[4],h[5])),p=Math.min(Math.min(Math.max(h[0],h[1]),Math.max(h[2],h[3])),Math.max(h[4],h[5]));return p<0||d>p?0:d>0?d:p}}(),ua=function(){const t=new ln,e=new ln,n=new ln,i=new ln,s=new ln,r=new ln,o=new ln,a=new Vs;return function(c,l){const h=l.radius*l.radius,_=ln.normalize(t,c.d),u=l.ellipseCenter0,d=l.ellipseCenter1,p=ln.subtract(e,d,u);if(p.equals(ln.ZERO))return a.radius=l.radius,a.center.set(l.ellipseCenter0),ka.raySphere(c,a);const m=c.o,f=ln.subtract(n,m,u),g=ln.cross(i,_,p),v=g.lengthSqr();if(0===v){a.radius=l.radius;const t=ln.subtract(s,d,m);return f.lengthSqr()<t.lengthSqr()?a.center.set(l.ellipseCenter0):a.center.set(l.ellipseCenter1),ka.raySphere(c,a)}const y=ln.cross(s,f,p),x=p.lengthSqr(),S=2*ln.dot(g,y),T=S*S-4*v*(y.lengthSqr()-h*x);if(T<0)return 0;const E=(-S-Math.sqrt(T))/(2*v);if(E<0){a.radius=l.radius;const t=ln.subtract(r,d,m);return f.lengthSqr()<t.lengthSqr()?a.center.set(l.ellipseCenter0):a.center.set(l.ellipseCenter1),ka.raySphere(c,a)}{const t=ln.scaleAndAdd(r,c.o,_,E),e=ln.subtract(o,t,u),n=ln.dot(e,p)/x;return n>=0&&n<=1?E:n<0?(a.radius=l.radius,a.center.set(l.ellipseCenter0),ka.raySphere(c,a)):n>1?(a.radius=l.radius,a.center.set(l.ellipseCenter1),ka.raySphere(c,a)):0}}}(),da=function(){const t=ks.create(),e={distance:1/0,doubleSided:!1,mode:ra.ANY};let n=0;const i=(t,e,i,s,r,o)=>{t===ra.CLOSEST?(n>e||0===n)&&(n=e,o&&(0===o.length?o.push({distance:e,vertexIndex0:i/3,vertexIndex1:s/3,vertexIndex2:r/3}):(o[0].distance=e,o[0].vertexIndex0=i/3,o[0].vertexIndex1=s/3,o[0].vertexIndex2=r/3))):(n=e,o&&o.push({distance:e,vertexIndex0:i/3,vertexIndex1:s/3,vertexIndex2:r/3}))};return function(s,r,o){if(n=0,0===r.geometricInfo.positions.length)return n;const a=void 0===o?e:o;if(ha(s,r.geometricInfo.boundingBox.min,r.geometricInfo.boundingBox.max)){const e=r.primitiveMode,{positions:n,indices:o}=r.geometricInfo;((e,n,s,r,o)=>{if(s===Js.TRIANGLE_LIST){const s=n.length;for(let a=0;a<s;a+=3){const s=3*n[a],c=3*n[a+1],l=3*n[a+2];ln.set(t.a,e[s],e[s+1],e[s+2]),ln.set(t.b,e[c],e[c+1],e[c+2]),ln.set(t.c,e[l],e[l+1],e[l+2]);const h=ka.rayTriangle(r,t,o.doubleSided);if(!(0===h||h>o.distance)&&(i(o.mode,h,s,c,l,o.result),o.mode===ra.ANY))return h}}else if(s===Js.TRIANGLE_STRIP){const s=n.length-2;let a=0;for(let c=0;c<s;c+=1){const s=3*n[c-a],l=3*n[c+a+1],h=3*n[c+2];ln.set(t.a,e[s],e[s+1],e[s+2]),ln.set(t.b,e[l],e[l+1],e[l+2]),ln.set(t.c,e[h],e[h+1],e[h+2]),a=~a;const _=ka.rayTriangle(r,t,o.doubleSided);if(!(0===_||_>o.distance)&&(i(o.mode,_,s,l,h,o.result),o.mode===ra.ANY))return _}}else if(s===Js.TRIANGLE_FAN){const s=n.length-1,a=3*n[0];ln.set(t.a,e[a],e[a+1],e[a+2]);for(let c=1;c<s;c+=1){const s=3*n[c],l=3*n[c+1];ln.set(t.b,e[s],e[s+1],e[s+2]),ln.set(t.c,e[l],e[l+1],e[l+2]);const h=ka.rayTriangle(r,t,o.doubleSided);if(!(0===h||h>o.distance)&&(i(o.mode,h,a,s,l,o.result),o.mode===ra.ANY))return h}}})(n,o,e,s,a)}return n}}(),pa=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:ra.ANY};return function(n,i,s){t=0;const r=void 0===s?e:s,o=i.renderingSubMeshes.length,a=i.struct.minPosition,c=i.struct.maxPosition;if(a&&c&&!ha(n,a,c))return t;for(let e=0;e<o;e++){const s=i.renderingSubMeshes[e],o=da(n,s,r);if(o)if(r.mode===ra.CLOSEST)(0===t||t>o)&&(t=o,r.subIndices&&(r.subIndices[0]=e));else if(t=o,r.subIndices&&r.subIndices.push(e),r.mode===ra.ANY)return o}return t&&r.mode===ra.CLOSEST&&(r.result&&(r.result[0].distance=t,r.result.length=1),r.subIndices&&(r.subIndices.length=1)),t}}(),ma=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:ra.ANY},n=new zs,i=new bn;return function(s,r,o){t=0;const a=void 0===o?e:o,c=r.worldBounds;if(c&&!la(s,c))return t;zs.copy(n,s),r.node&&(bn.invert(i,r.node.getWorldMatrix(i)),ln.transformMat4(n.o,s.o,i),ln.transformMat4Normal(n.d,s.d,i));const l=r.subModels;for(let e=0;e<l.length;e++){const i=l[e].subMesh,s=da(n,i,a);if(s)if(a.mode===ra.CLOSEST)(0===t||t>s)&&(t=s,a.subIndices&&(a.subIndices[0]=e));else if(t=s,a.subIndices&&a.subIndices.push(e),a.mode===ra.ANY)return s}return t&&a.mode===ra.CLOSEST&&(a.result&&(a.result[0].distance=t,a.result.length=1),a.subIndices&&(a.subIndices.length=1)),t}}(),fa=function(){const t=new ln(0,0,0);return function(e,n){ln.subtract(t,e.e,e.s);const i=(n.d-ln.dot(e.s,n.n))/ln.dot(t,n.n);return i<0||i>1?0:i}}(),ga=function(){const t=new ln(0,0,0),e=new ln(0,0,0),n=new ln(0,0,0),i=new ln(0,0,0),s=new ln(0,0,0),r=new ln(0,0,0);return function(o,a,c){ln.subtract(t,a.b,a.a),ln.subtract(e,a.c,a.a),ln.subtract(n,o.s,o.e),ln.cross(s,t,e);const l=ln.dot(n,s);if(l<=0)return 0;ln.subtract(i,o.s,a.a);const h=ln.dot(i,s);if(h<0||h>l)return 0;ln.cross(r,n,i);let _=ln.dot(e,r);if(_<0||_>l)return 0;let u=-ln.dot(t,r);if(u<0||_+u>l)return 0;if(c){const t=1/l;_*=t,u*=t;const e=1-_-u;ln.set(c,a.a.x*e+a.b.x*_+a.c.x*u,a.a.y*e+a.b.y*_+a.c.y*u,a.a.z*e+a.b.z*_+a.c.z*u)}return 1}}(),va=new zs;function ya(t,e){va.o.set(t.s),ln.subtract(va.d,t.e,t.s),va.d.normalize();const n=la(va,e);return n<=t.length()?n:0}function xa(t,e){va.o.set(t.s),ln.subtract(va.d,t.e,t.s),va.d.normalize();const n=_a(va,e);return n<=t.length()?n:0}function Sa(t,e){va.o.set(t.s),ln.subtract(va.d,t.e,t.s),va.d.normalize();const n=ca(va,e);return n<=t.length()?n:0}const Ta=function(){const t=new ln,e=new ln,n=new ln,i=new ln;return function(s,r){return ln.subtract(t,s.center,s.halfExtents),ln.add(e,s.center,s.halfExtents),ln.subtract(n,r.center,r.halfExtents),ln.add(i,r.center,r.halfExtents),t.x<=i.x&&e.x>=n.x&&t.y<=i.y&&e.y>=n.y&&t.z<=i.z&&e.z>=n.z}}();function Ea(t,e,n,i,s,r){ln.set(r[0],t.x+n.x*e.x+i.x*e.y+s.x*e.z,t.y+n.y*e.x+i.y*e.y+s.y*e.z,t.z+n.z*e.x+i.z*e.y+s.z*e.z),ln.set(r[1],t.x-n.x*e.x+i.x*e.y+s.x*e.z,t.y-n.y*e.x+i.y*e.y+s.y*e.z,t.z-n.z*e.x+i.z*e.y+s.z*e.z),ln.set(r[2],t.x+n.x*e.x-i.x*e.y+s.x*e.z,t.y+n.y*e.x-i.y*e.y+s.y*e.z,t.z+n.z*e.x-i.z*e.y+s.z*e.z),ln.set(r[3],t.x+n.x*e.x+i.x*e.y-s.x*e.z,t.y+n.y*e.x+i.y*e.y-s.y*e.z,t.z+n.z*e.x+i.z*e.y-s.z*e.z),ln.set(r[4],t.x-n.x*e.x-i.x*e.y-s.x*e.z,t.y-n.y*e.x-i.y*e.y-s.y*e.z,t.z-n.z*e.x-i.z*e.y-s.z*e.z),ln.set(r[5],t.x+n.x*e.x-i.x*e.y-s.x*e.z,t.y+n.y*e.x-i.y*e.y-s.y*e.z,t.z+n.z*e.x-i.z*e.y-s.z*e.z),ln.set(r[6],t.x-n.x*e.x+i.x*e.y-s.x*e.z,t.y-n.y*e.x+i.y*e.y-s.y*e.z,t.z-n.z*e.x+i.z*e.y-s.z*e.z),ln.set(r[7],t.x-n.x*e.x-i.x*e.y+s.x*e.z,t.y-n.y*e.x-i.y*e.y+s.y*e.z,t.z-n.z*e.x-i.z*e.y+s.z*e.z)}function Ca(t,e){let n=ln.dot(e,t[0]),i=n;for(let s=1;s<8;++s){const r=ln.dot(e,t[s]);n=r<n?r:n,i=r>i?r:i}return[n,i]}const Aa=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new ln(0,0,0);const e=new Array(8),n=new Array(8);for(let t=0;t<8;t++)e[t]=new ln(0,0,0),n[t]=new ln(0,0,0);const i=new ln,s=new ln;return function(r,o){ln.set(t[0],1,0,0),ln.set(t[1],0,1,0),ln.set(t[2],0,0,1),ln.set(t[3],o.orientation.m00,o.orientation.m01,o.orientation.m02),ln.set(t[4],o.orientation.m03,o.orientation.m04,o.orientation.m05),ln.set(t[5],o.orientation.m06,o.orientation.m07,o.orientation.m08);for(let e=0;e<3;++e)ln.cross(t[6+3*e],t[e],t[0]),ln.cross(t[7+3*e],t[e],t[1]),ln.cross(t[7+3*e],t[e],t[2]);ln.subtract(i,r.center,r.halfExtents),ln.add(s,r.center,r.halfExtents),function(t,e,n){ln.set(n[0],t.x,e.y,e.z),ln.set(n[1],t.x,e.y,t.z),ln.set(n[2],t.x,t.y,e.z),ln.set(n[3],t.x,t.y,t.z),ln.set(n[4],e.x,e.y,e.z),ln.set(n[5],e.x,e.y,t.z),ln.set(n[6],e.x,t.y,e.z),ln.set(n[7],e.x,t.y,t.z)}(i,s,e),Ea(o.center,o.halfExtents,t[3],t[4],t[5],n);for(let i=0;i<15;++i){const s=Ca(e,t[i]),r=Ca(n,t[i]);if(r[0]>s[1]||s[0]>r[1])return 0}return 1}}(),ba=function(t,e){const n=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),i=ln.dot(e.n,t.center);return i+n<e.d?-1:i-n>e.d?0:1},wa=function(t,e){for(let n=0;n<e.planes.length;n++)if(-1===ba(t,e.planes[n]))return 0;return 1},Ra=function(){const t=new Array(8);let e=0,n=0;for(let e=0;e<t.length;e++)t[e]=new ln(0,0,0);return function(i,s){let r=0,o=!1;for(let t=0;t<s.planes.length;t++){if(r=ba(i,s.planes[t]),-1===r)return 0;1===r&&(o=!0)}if(!o)return 1;for(let e=0;e<s.vertices.length;e++)ln.subtract(t[e],s.vertices[e],i.center);e=0,n=0;for(let r=0;r<s.vertices.length;r++)t[r].x>i.halfExtents.x?e++:t[r].x<-i.halfExtents.x&&n++;if(e===s.vertices.length||n===s.vertices.length)return 0;e=0,n=0;for(let r=0;r<s.vertices.length;r++)t[r].y>i.halfExtents.y?e++:t[r].y<-i.halfExtents.y&&n++;if(e===s.vertices.length||n===s.vertices.length)return 0;e=0,n=0;for(let r=0;r<s.vertices.length;r++)t[r].z>i.halfExtents.z?e++:t[r].z<-i.halfExtents.z&&n++;return e===s.vertices.length||n===s.vertices.length?0:1}}(),Ia=function(){const t=new ln(0,0,0),e=new mn;return function(n,i){return ln.subtract(t,i,n.center),ln.transformMat3(t,t,mn.transpose(e,n.orientation)),s=t,r=n.halfExtents,Math.abs(s.x)<r.x&&Math.abs(s.y)<r.y&&Math.abs(s.z)<r.z;var s,r}}(),Pa=function(){const t=function(t,e,n,i){return Math.abs(t.x*e+t.y*n+t.z*i)};return function(e,n){const i=e.halfExtents.x*t(n.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*t(n.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*t(n.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),s=ln.dot(n.n,e.center);return s+i<n.d?-1:s-i>n.d?0:1}}(),Oa=function(t,e){for(let n=0;n<e.planes.length;n++)if(-1===Pa(t,e.planes[n]))return 0;return 1},Da=function(){const t=new Array(8);let e=0,n=0,i=0;for(let e=0;e<t.length;e++)t[e]=new ln(0,0,0);const s=function(t,e,n,i){return t.x*e+t.y*n+t.z*i};return function(r,o){let a=0,c=!1;for(let t=0;t<o.planes.length;t++){if(a=Pa(r,o.planes[t]),-1===a)return 0;1===a&&(c=!0)}if(!c)return 1;for(let e=0;e<o.vertices.length;e++)ln.subtract(t[e],o.vertices[e],r.center);n=0,i=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m00,r.orientation.m01,r.orientation.m02),e>r.halfExtents.x?n++:e<-r.halfExtents.x&&i++;if(n===o.vertices.length||i===o.vertices.length)return 0;n=0,i=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m03,r.orientation.m04,r.orientation.m05),e>r.halfExtents.y?n++:e<-r.halfExtents.y&&i++;if(n===o.vertices.length||i===o.vertices.length)return 0;n=0,i=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m06,r.orientation.m07,r.orientation.m08),e>r.halfExtents.z?n++:e<-r.halfExtents.z&&i++;return n===o.vertices.length||i===o.vertices.length?0:1}}(),Ma=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new ln(0,0,0);const e=new Array(8),n=new Array(8);for(let t=0;t<8;t++)e[t]=new ln(0,0,0),n[t]=new ln(0,0,0);return function(i,s){ln.set(t[0],i.orientation.m00,i.orientation.m01,i.orientation.m02),ln.set(t[1],i.orientation.m03,i.orientation.m04,i.orientation.m05),ln.set(t[2],i.orientation.m06,i.orientation.m07,i.orientation.m08),ln.set(t[3],s.orientation.m00,s.orientation.m01,s.orientation.m02),ln.set(t[4],s.orientation.m03,s.orientation.m04,s.orientation.m05),ln.set(t[5],s.orientation.m06,s.orientation.m07,s.orientation.m08);for(let e=0;e<3;++e)ln.cross(t[6+3*e],t[e],t[0]),ln.cross(t[7+3*e],t[e],t[1]),ln.cross(t[7+3*e],t[e],t[2]);Ea(i.center,i.halfExtents,t[0],t[1],t[2],e),Ea(s.center,s.halfExtents,t[3],t[4],t[5],n);for(let i=0;i<15;++i){const s=Ca(e,t[i]),r=Ca(n,t[i]);if(r[0]>s[1]||s[0]>r[1])return 0}return 1}}(),Na=function(){const t=new Vs,e=new ln,n=new ln,i=new ln,s=new Array(8);for(let t=0;t<8;t++)s[t]=new ln;const r=new Array(8);for(let t=0;t<8;t++)r[t]=new ln;return function(o,a){if(0===ln.squaredDistance(a.ellipseCenter0,a.ellipseCenter1))return t.radius=a.radius,t.center.set(a.ellipseCenter0),ka.sphereOBB(t,o);{e.x=o.orientation.m00,e.y=o.orientation.m01,e.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,Ea(o.center,o.halfExtents,e,n,i,s);const t=r,c=ln.copy(t[0],e),l=ln.copy(t[1],n),h=ln.copy(t[2],i);ln.subtract(t[3],a.center,o.center).normalize();const _=ln.subtract(t[4],a.ellipseCenter0,a.ellipseCenter1);_.normalize(),ln.cross(t[5],c,_),ln.cross(t[6],l,_),ln.cross(t[7],h,_);for(let e=0;e<8;++e){const n=Ca(s,t[e]),i=ln.dot(t[e],a.ellipseCenter0),r=ln.dot(t[e],a.ellipseCenter1),o=Math.max(i,r),c=Math.min(i,r)-a.radius,l=o+a.radius;if(c>n[1]||n[0]>l)return 0}return 1}}}(),La=function(t,e){const n=ln.dot(e.n,t.center),i=t.radius*e.n.length();return n+i<e.d?-1:n-i>e.d?0:1},za=function(t,e){for(let n=0;n<e.planes.length;n++)if(-1===La(t,e.planes[n]))return 0;return 1},Ba=function(){const t=new ln(0,0,0),e=[1,-1,1,-1,1,-1];return function(n,i){for(let s=0;s<6;s++){const r=i.planes[s],o=n.radius,a=n.center,c=r.n,l=r.d,h=ln.dot(c,a);if(h+o<l)return 0;if(!(h-o>l)){ln.add(t,a,ln.multiplyScalar(t,c,o));for(let n=0;n<6;n++){if(n===s||n===s+e[s])continue;const r=i.planes[n];if(ln.dot(r.n,t)<r.d)return 0}}}return 1}}(),Fa=function(t,e){const n=t.radius+e.radius;return ln.squaredDistance(t.center,e.center)<n*n},Ua=function(){const t=new ln;return function(e,n){return Ds(t,e.center,n),ln.squaredDistance(e.center,t)<e.radius*e.radius}}(),Ga=function(){const t=new ln;return function(e,n){return Ms(t,e.center,n),ln.squaredDistance(e.center,t)<e.radius*e.radius}}(),Ha=function(){const t=new ln,e=new ln;return function(n,i){const s=n.radius+i.radius,r=s*s,o=ln.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===o)return ln.squaredDistance(n.center,i.center)<r;{ln.subtract(t,n.center,i.ellipseCenter0),ln.subtract(e,i.ellipseCenter1,i.ellipseCenter0);const s=ln.dot(t,e)/o;return s<0?ln.squaredDistance(n.center,i.ellipseCenter0)<r:s>1?ln.squaredDistance(n.center,i.ellipseCenter1)<r:(ln.scaleAndAdd(t,i.ellipseCenter0,e,s),ln.squaredDistance(n.center,t)<r)}}}(),Va=function(){const t=new ln,e=new ln,n=new ln,i=new ln,s=new ln,r=new ln;return function(o,a){const c=ln.subtract(t,o.ellipseCenter1,o.ellipseCenter0),l=ln.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=ln.subtract(n,o.ellipseCenter0,a.ellipseCenter0),_=ln.dot(c,c),u=ln.dot(c,l),d=ln.dot(l,l),p=ln.dot(c,h),m=ln.dot(l,h),f=_*d-u*u;let g,v,y,x,S=f,T=f;f<Fe?(v=0,S=1,x=m,T=d):(v=u*m-d*p,x=_*m-u*p,v<0?(v=0,x=m,T=d):v>S&&(v=S,x=m+u,T=d)),x<0?(x=0,-p<0?v=0:-p>_?v=S:(v=-p,S=_)):x>T&&(x=T,-p+u<0?v=0:-p+u>_?v=S:(v=-p+u,S=_)),g=Math.abs(v)<Fe?0:v/S,y=Math.abs(x)<Fe?0:x/T;const E=i;E.set(h),E.add(ln.multiplyScalar(s,c,g)),E.subtract(ln.multiplyScalar(r,l,y));const C=o.radius+a.radius;return E.lengthSqr()<C*C}}(),ka={raySphere:ca,rayAABB:la,rayOBB:_a,rayPlane:oa,rayTriangle:aa,rayCapsule:ua,raySubMesh:da,rayMesh:pa,rayModel:ma,lineSphere:Sa,lineAABB:ya,lineOBB:xa,linePlane:fa,lineTriangle:ga,sphereWithSphere:Fa,sphereAABB:Ua,sphereOBB:Ga,spherePlane:La,sphereFrustum:za,sphereFrustumAccurate:Ba,sphereCapsule:Ha,aabbWithAABB:Ta,aabbWithOBB:Aa,aabbPlane:ba,aabbFrustum:wa,aabbFrustumAccurate:Ra,obbWithOBB:Ma,obbPlane:Pa,obbFrustum:Oa,obbFrustumAccurate:Da,obbPoint:Ia,obbCapsule:Na,capsuleWithCapsule:Va,resolve(t,e,n=null){const i=t._type,s=e._type,r=this[i|s];return i<s?r(t,e,n):r(e,t,n)}};ka[Ls.SHAPE_RAY|Ls.SHAPE_SPHERE]=ca,ka[Ls.SHAPE_RAY|Ls.SHAPE_AABB]=la,ka[Ls.SHAPE_RAY|Ls.SHAPE_OBB]=_a,ka[Ls.SHAPE_RAY|Ls.SHAPE_PLANE]=oa,ka[Ls.SHAPE_RAY|Ls.SHAPE_TRIANGLE]=aa,ka[Ls.SHAPE_RAY|Ls.SHAPE_CAPSULE]=ua,ka[Ls.SHAPE_LINE|Ls.SHAPE_SPHERE]=Sa,ka[Ls.SHAPE_LINE|Ls.SHAPE_AABB]=ya,ka[Ls.SHAPE_LINE|Ls.SHAPE_OBB]=xa,ka[Ls.SHAPE_LINE|Ls.SHAPE_PLANE]=fa,ka[Ls.SHAPE_LINE|Ls.SHAPE_TRIANGLE]=ga,ka[Ls.SHAPE_SPHERE]=Fa,ka[Ls.SHAPE_SPHERE|Ls.SHAPE_AABB]=Ua,ka[Ls.SHAPE_SPHERE|Ls.SHAPE_OBB]=Ga,ka[Ls.SHAPE_SPHERE|Ls.SHAPE_PLANE]=La,ka[Ls.SHAPE_SPHERE|Ls.SHAPE_FRUSTUM]=za,ka[Ls.SHAPE_SPHERE|Ls.SHAPE_FRUSTUM_ACCURATE]=Ba,ka[Ls.SHAPE_SPHERE|Ls.SHAPE_CAPSULE]=Ha,ka[Ls.SHAPE_AABB]=Ta,ka[Ls.SHAPE_AABB|Ls.SHAPE_OBB]=Aa,ka[Ls.SHAPE_AABB|Ls.SHAPE_PLANE]=ba,ka[Ls.SHAPE_AABB|Ls.SHAPE_FRUSTUM]=wa,ka[Ls.SHAPE_AABB|Ls.SHAPE_FRUSTUM_ACCURATE]=Ra,ka[Ls.SHAPE_OBB]=Ma,ka[Ls.SHAPE_OBB|Ls.SHAPE_PLANE]=Pa,ka[Ls.SHAPE_OBB|Ls.SHAPE_FRUSTUM]=Oa,ka[Ls.SHAPE_OBB|Ls.SHAPE_FRUSTUM_ACCURATE]=Da,ka[Ls.SHAPE_OBB|Ls.SHAPE_CAPSULE]=Na,ka[Ls.SHAPE_CAPSULE]=Va;class ja{static create(t,e,n,i,s,r){return new ja(t,e,n,i,s,r)}static clone(t){return new ja(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}static copy(t,e){return ln.copy(t.s,e.s),ln.copy(t.e,e.e),t}static fromPoints(t,e,n){return ln.copy(t.s,e),ln.copy(t.e,n),t}static set(t,e,n,i,s,r,o){return t.s.x=e,t.s.y=n,t.s.z=i,t.e.x=s,t.e.y=r,t.e.z=o,t}static len(t){return ln.distance(t.s,t.e)}get type(){return this._type}constructor(t=0,e=0,n=0,i=0,s=0,r=-1){this.s=void 0,this.e=void 0,this._type=void 0,this._type=Ls.SHAPE_LINE,this.s=new ln(t,e,n),this.e=new ln(i,s,r)}length(){return ln.distance(this.s,this.e)}}const Wa=new ln(0,0,0),qa=new ln(0,0,0),Xa=i.mat4(),Ya=i.v4();class Ka{static create(t,e,n,i){return new Ka(t,e,n,i)}static clone(t){return new Ka(t.n.x,t.n.y,t.n.z,t.d)}static copy(t,e){return ln.copy(t.n,e.n),t.d=e.d,t}static fromPoints(t,e,n,i){return ln.subtract(Wa,n,e),ln.subtract(qa,i,e),ln.normalize(t.n,ln.cross(t.n,Wa,qa)),t.d=ln.dot(t.n,e),t}static set(t,e,n,i,s){return t.n.x=e,t.n.y=n,t.n.z=i,t.d=s,t}static fromNormalAndPoint(t,e,n){return ln.copy(t.n,e),t.d=ln.dot(e,n),t}static normalize(t,e){const n=e.n.length();return ln.normalize(t.n,e.n),n>0&&(t.d=e.d/n),t}get type(){return this._type}set x(t){this.n.x=t}get x(){return this.n.x}set y(t){this.n.y=t}get y(){return this.n.y}set z(t){this.n.z=t}get z(){return this.n.z}set w(t){this.d=t}get w(){return this.d}constructor(t=0,e=1,n=0,i=0){this.n=void 0,this.d=void 0,this._type=void 0,this._type=Ls.SHAPE_PLANE,this.n=new ln(t,e,n),this.d=i}transform(t){bn.invert(Xa,t),bn.transpose(Xa,Xa),dn.set(Ya,this.n.x,this.n.y,this.n.z,this.d),dn.transformMat4(Ya,Ya,Xa),ln.set(this.n,Ya.x,Ya.y,Ya.z),this.d=Ya.w}}const $a=new ln,Za=new ln,Ja=new ln,Qa=new ln,tc=new mn,ec=(t,e,n)=>{tc.m00=Math.abs(n.m00),tc.m01=Math.abs(n.m01),tc.m02=Math.abs(n.m02),tc.m03=Math.abs(n.m04),tc.m04=Math.abs(n.m05),tc.m05=Math.abs(n.m06),tc.m06=Math.abs(n.m08),tc.m07=Math.abs(n.m09),tc.m08=Math.abs(n.m10),ln.transformMat3(t,e,tc)};class nc{static create(t,e,n,i,s,r){return new nc(t,e,n,i,s,r)}static clone(t){return new nc(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}static copy(t,e){return ln.copy(t.center,e.center),ln.copy(t.halfExtents,e.halfExtents),t}static fromPoints(t,e,n){return ln.add($a,n,e),ln.subtract(Za,n,e),ln.multiplyScalar(t.center,$a,.5),ln.multiplyScalar(t.halfExtents,Za,.5),t}static set(t,e,n,i,s,r,o){return ln.set(t.center,e,n,i),ln.set(t.halfExtents,s,r,o),t}static merge(t,e,n){return ln.subtract($a,e.center,e.halfExtents),ln.subtract(Za,n.center,n.halfExtents),ln.add(Ja,e.center,e.halfExtents),ln.add(Qa,n.center,n.halfExtents),ln.max(Qa,Ja,Qa),ln.min(Ja,$a,Za),nc.fromPoints(t,Ja,Qa)}static toBoundingSphere(t,e){e.getBoundary($a,Za),t.center.set($a),t.radius=0,ln.subtract(Ja,Za,t.center);const n=Ja.length(),i=.5*n;return t.radius+=i,ln.multiplyScalar(Ja,Ja,i/n),ln.add(t.center,t.center,Ja),t}static transform(t,e,n){return ln.transformMat4(t.center,e.center,n),ec(t.halfExtents,e.halfExtents,n),t}get type(){return this._type}constructor(t=0,e=0,n=0,i=1,s=1,r=1){this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._type=Ls.SHAPE_AABB,this.center=new ln(t,e,n),this.halfExtents=new ln(i,s,r)}getBoundary(t,e){ln.subtract(t,this.center,this.halfExtents),ln.add(e,this.center,this.halfExtents)}transform(t,e,n,i,s){ln.transformMat4(s.center,this.center,t),ec(s.halfExtents,this.halfExtents,t)}clone(){return nc.clone(this)}copy(t){return nc.copy(this,t)}}const ic=new ln,sc=new ln,rc=new mn;class oc{static create(t,e,n,i,s,r,o,a,c,l,h,_,u,d,p){return new oc(t,e,n,i,s,r,o,a,c,l,h,_,u,d,p)}static clone(t){return new oc(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}static copy(t,e){return ln.copy(t.center,e.center),ln.copy(t.halfExtents,e.halfExtents),mn.copy(t.orientation,e.orientation),t}static fromPoints(t,e,n){return ln.multiplyScalar(t.center,ln.add(ic,e,n),.5),ln.multiplyScalar(t.halfExtents,ln.subtract(sc,n,e),.5),mn.identity(t.orientation),t}static set(t,e,n,i,s,r,o,a,c,l,h,_,u,d,p,m){return ln.set(t.center,e,n,i),ln.set(t.halfExtents,s,r,o),mn.set(t.orientation,a,c,l,h,_,u,d,p,m),t}get type(){return this._type}constructor(t=0,e=0,n=0,i=1,s=1,r=1,o=1,a=0,c=0,l=0,h=1,_=0,u=0,d=0,p=1){this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=Ls.SHAPE_OBB,this.center=new ln(t,e,n),this.halfExtents=new ln(i,s,r),this.orientation=new mn(o,a,c,l,h,_,u,d,p)}getBoundary(t,e){var n,i,s;n=ic,i=this.halfExtents,s=this.orientation,rc.m00=Math.abs(s.m00),rc.m01=Math.abs(s.m01),rc.m02=Math.abs(s.m02),rc.m03=Math.abs(s.m03),rc.m04=Math.abs(s.m04),rc.m05=Math.abs(s.m05),rc.m06=Math.abs(s.m06),rc.m07=Math.abs(s.m07),rc.m08=Math.abs(s.m08),ln.transformMat3(n,i,rc),ln.subtract(t,this.center,ic),ln.add(e,this.center,ic)}transform(t,e,n,i,s){ln.transformMat4(s.center,this.center,t),mn.fromQuat(s.orientation,n),ln.multiply(s.halfExtents,this.halfExtents,i)}translateAndRotate(t,e,n){ln.transformMat4(n.center,this.center,t),mn.fromQuat(n.orientation,e)}setScale(t,e){ln.multiply(e.halfExtents,this.halfExtents,t)}}const ac=new Array(8);ac[0]=new ln(1,1,1),ac[1]=new ln(-1,1,1),ac[2]=new ln(-1,-1,1),ac[3]=new ln(1,-1,1),ac[4]=new ln(1,1,-1),ac[5]=new ln(-1,1,-1),ac[6]=new ln(-1,-1,-1),ac[7]=new ln(1,-1,-1);class cc{set accurate(t){this._type=t?Ls.SHAPE_FRUSTUM_ACCURATE:Ls.SHAPE_FRUSTUM}static create(){return new cc}static clone(t){return cc.copy(new cc,t)}static copy(t,e){t._type=e._type;for(let n=0;n<6;++n)Ka.copy(t.planes[n],e.planes[n]);for(let n=0;n<8;++n)ln.copy(t.vertices[n],e.vertices[n]);return t}get type(){return this._type}constructor(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=Ls.SHAPE_FRUSTUM,this.planes=new Array(6);for(let t=0;t<6;++t)this.planes[t]=Ka.create(0,0,0,0);this.vertices=new Array(8);for(let t=0;t<8;++t)this.vertices[t]=new ln}update(t,e){if(ln.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),ln.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),ln.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),ln.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),ln.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),ln.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===Ls.SHAPE_FRUSTUM_ACCURATE){for(let t=0;t<6;t++){const e=this.planes[t],n=1/e.n.length();ln.multiplyScalar(e.n,e.n,n),e.d*=n}for(let t=0;t<8;t++)ln.transformMat4(this.vertices[t],ac[t],e)}}transform(t){if(this._type===Ls.SHAPE_FRUSTUM_ACCURATE){for(let e=0;e<8;e++)ln.transformMat4(this.vertices[e],this.vertices[e],t);Ka.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),Ka.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),Ka.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),Ka.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),Ka.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),Ka.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}function lc(t,e){if(!e||0===t)return;const n=e.vertices;let i=Fi.VERTICES;for(let e=0;e<8;++e)Gi.setVec3(t,i,n[e]),i+=3;const s=e.planes;let r=Fi.PLANES;for(let e=0;e<6;e++,r+=4)Gi.setVec4(t,r,s[e])}let hc,_c;cc.createOrtho=(()=>{const t=new ln;return(e,n,i,s,r,o)=>{const a=n/2,c=i/2;ln.set(t,a,c,s),ln.transformMat4(e.vertices[0],t,o),ln.set(t,-a,c,s),ln.transformMat4(e.vertices[1],t,o),ln.set(t,-a,-c,s),ln.transformMat4(e.vertices[2],t,o),ln.set(t,a,-c,s),ln.transformMat4(e.vertices[3],t,o),ln.set(t,a,c,r),ln.transformMat4(e.vertices[4],t,o),ln.set(t,-a,c,r),ln.transformMat4(e.vertices[5],t,o),ln.set(t,-a,-c,r),ln.transformMat4(e.vertices[6],t,o),ln.set(t,a,-c,r),ln.transformMat4(e.vertices[7],t,o),Ka.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Ka.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Ka.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Ka.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Ka.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Ka.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])}})(),function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(hc||(hc={})),function(t){t[t.Default=hc.Default]="Default",t[t.Normal=hc.Normal]="Normal",t[t.Reverse=hc.Reverse]="Reverse",t[t.Loop=hc.Loop]="Loop",t[t.LoopReverse=hc.Loop|hc.Reverse]="LoopReverse",t[t.PingPong=hc.PingPong]="PingPong",t[t.PingPongReverse=hc.PingPong|hc.Reverse]="PingPongReverse"}(_c||(_c={})),Xt(_c);class uc{constructor(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}set(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex}}const dc=jt({Default:hc.Default,Normal:hc.Normal,Clamp:hc.Clamp,Loop:hc.Loop,PingPong:hc.PingPong});class pc{constructor(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}}Me.fastDefine("cc.Keyframe",pc,{time:0,value:0,inTangent:0,outTangent:0});class mc{constructor(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}evaluate(t){return e=t-this.time,n=this.coefficient,e*(e*(e*n[0]+n[1])+n[2])+n[3];var e,n}}class fc{constructor(t=null){this.keyFrames=void 0,this.preWrapMode=dc.Loop,this.postWrapMode=dc.Clamp,this.cachedKey=void 0,this.keyFrames=t||[].concat(fc.defaultKF),this.cachedKey=new mc}addKey(t){null==this.keyFrames&&(this.keyFrames=[]),this.keyFrames.push(t)}evaluate_slow(t){let e=t;const n=t<0?this.preWrapMode:this.postWrapMode,i=this.keyFrames[0].time,s=this.keyFrames[this.keyFrames.length-1].time;switch(n){case dc.Loop:e=Qe(t-i,s-i)+i;break;case dc.PingPong:e=tn(t-i,s-i)+i;break;case dc.Default:case dc.Normal:case dc.Clamp:default:e=He(t,i,s)}let r=0;if(e>this.keyFrames[0].time)if(e>=this.keyFrames[this.keyFrames.length-1].time)r=this.keyFrames.length-2;else for(let t=0;t<this.keyFrames.length-1;t++)if(e>=this.keyFrames[0].time&&e<=this.keyFrames[t+1].time){r=t;break}const o=this.keyFrames[r],a=this.keyFrames[r+1],c=en(o.time,a.time,e),l=a.time-o.time,h=o.outTangent*l,_=a.inTangent*l,u=c*c,d=u*c,p=d-2*u+c,m=d-u,f=-2*d+3*u;return(2*d-3*u+1)*o.value+p*h+m*_+f*a.value}evaluate(t){let e=t;const n=t<0?this.preWrapMode:this.postWrapMode,i=this.keyFrames[0].time,s=this.keyFrames[this.keyFrames.length-1].time;switch(n){case dc.Loop:e=Qe(t-i,s-i)+i;break;case dc.PingPong:e=tn(t-i,s-i)+i;break;case dc.Default:case dc.Normal:case dc.Clamp:default:e=He(t,i,s)}if(e>=this.cachedKey.time&&e<this.cachedKey.endTime)return this.cachedKey.evaluate(e);const r=this.findIndex(this.cachedKey,e),o=Math.min(r+1,this.keyFrames.length-1);return this.calcOptimizedKey(this.cachedKey,r,o),this.cachedKey.evaluate(e)}calcOptimizedKey(t,e,n){const i=this.keyFrames[e],s=this.keyFrames[n];t.index=e,t.time=i.time,t.endTime=s.time;const r=s.time-i.time,o=s.value-i.value,a=1/(r*r),c=i.outTangent*r,l=s.inTangent*r;t.coefficient[0]=(c+l-o-o)*a/r,t.coefficient[1]=(o+o+o-c-c-l)*a,t.coefficient[2]=i.outTangent,t.coefficient[3]=i.value}findIndex(t,e){const n=t.index;if(-1!==n)if(e>this.keyFrames[n].time)for(let t=0;t<3;t++){const i=n+t;if(i+1<this.keyFrames.length&&this.keyFrames[i+1].time>e)return i}else for(let t=0;t<3;t++){const i=n-t;if(i>=0&&this.keyFrames[i-1].time<=e)return i-1}let i,s=0,r=this.keyFrames.length;for(;r-s>1;)i=Math.floor((s+r)/2),this.keyFrames[i].time>=e?r=i:s=i;return s}}fc.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],Me.fastDefine("cc.AnimationCurve",fc,{preWrapMode:dc.Default,postWrapMode:dc.Default,keyFrames:[]});var gc=Object.freeze({__proto__:null,distance:Ns,enums:Ls,intersect:ka,Line:ja,Plane:Ka,Ray:zs,Triangle:ks,Sphere:Vs,AABB:nc,OBB:oc,Capsule:class{get type(){return this._type}constructor(t=.5,e=.5,n=1){this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=Ls.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=n,this.center=new ln,this.rotation=new vn,this.ellipseCenter0=new ln(0,e,0),this.ellipseCenter1=new ln(0,-e,0),this.updateCache()}transform(t,e,n,i,s){const r=i,o=nn(r);s.radius=this.radius*Math.abs(o);let a=(this.halfHeight+this.radius)*Math.abs(r.y)-s.radius;a<0&&(a=0),s.halfHeight=a,ln.transformMat4(s.center,this.center,t),vn.multiply(s.rotation,this.rotation,n),s.updateCache()}updateCache(){this.updateLocalCenter(),ln.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),ln.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}updateLocalCenter(){const t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}}},Frustum:cc,Keyframe:pc,AnimationCurve:fc,get ERaycastMode(){return ra}});t("geometry",gc);const vc={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295};class yc{static makeMaskInclude(t){let e=0;for(const n of t)e|=n;return e}static makeMaskExclude(t){return~yc.makeMaskInclude(t)}static addLayer(t,e){void 0!==e?e>19||e<0?console.warn("maximum layers reached."):(yc.Enum[t]=1<<e,yc.Enum[e]=t,yc.BitMask[t]=1<<e,yc.BitMask[e]=t):console.warn("bitNum can't be undefined")}static deleteLayer(t){t>19||t<0?console.warn("do not change buildin layers."):(delete yc.Enum[yc.Enum[t]],delete yc.Enum[t],delete yc.BitMask[yc.BitMask[t]],delete yc.BitMask[t])}}let xc,Sc;t("Layers",yc),yc.Enum=jt(vc),yc.BitMask=kt({...vc}),i.Layers=yc,function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(xc||(xc={})),i.RenderPassStage=xc,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(Sc||(Sc={}));const Tc={bindings:[],layouts:{}},Ec={bindings:[],layouts:{}};let Cc;!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",t[t.COUNT=6]="COUNT"}(Cc||(Cc={}));const Ac=Cc.SAMPLER_SHADOWMAP,bc=Cc.COUNT-Ac;let wc;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=9]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",t[t.COUNT=11]="COUNT"}(wc||(wc={}));const Rc=wc.SAMPLER_JOINTS,Ic=wc.COUNT-Rc;let Pc;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}(Pc||(Pc={}));const Oc=new Qr;Oc.bufferOffsets=[0,Ac+Rc,Ac],Oc.samplerOffsets=[-Ac,bc+Ic,bc-Rc],Oc.flexibleSet=1;class Dc{}Dc.TIME_OFFSET=0,Dc.NATIVE_SIZE_OFFSET=Dc.TIME_OFFSET+4,Dc.SCREEN_SIZE_OFFSET=Dc.NATIVE_SIZE_OFFSET+4,Dc.COUNT=Dc.SCREEN_SIZE_OFFSET+4,Dc.SIZE=4*Dc.COUNT,Dc.NAME="CCGlobal",Dc.BINDING=Cc.UBO_GLOBAL,Dc.DESCRIPTOR=new Io(Dc.BINDING,mr.UNIFORM_BUFFER,1,pr.ALL),Dc.LAYOUT=new oo(Pc.GLOBAL,Dc.BINDING,Dc.NAME,[new ro("cc_time",qs.FLOAT4,1),new ro("cc_screenSize",qs.FLOAT4,1),new ro("cc_nativeSize",qs.FLOAT4,1)],1),Tc.layouts[Dc.NAME]=Dc.LAYOUT,Tc.bindings[Dc.BINDING]=Dc.DESCRIPTOR;class Mc{}Mc.MAT_VIEW_OFFSET=0,Mc.MAT_VIEW_INV_OFFSET=Mc.MAT_VIEW_OFFSET+16,Mc.MAT_PROJ_OFFSET=Mc.MAT_VIEW_INV_OFFSET+16,Mc.MAT_PROJ_INV_OFFSET=Mc.MAT_PROJ_OFFSET+16,Mc.MAT_VIEW_PROJ_OFFSET=Mc.MAT_PROJ_INV_OFFSET+16,Mc.MAT_VIEW_PROJ_INV_OFFSET=Mc.MAT_VIEW_PROJ_OFFSET+16,Mc.CAMERA_POS_OFFSET=Mc.MAT_VIEW_PROJ_INV_OFFSET+16,Mc.SCREEN_SCALE_OFFSET=Mc.CAMERA_POS_OFFSET+4,Mc.EXPOSURE_OFFSET=Mc.SCREEN_SCALE_OFFSET+4,Mc.MAIN_LIT_DIR_OFFSET=Mc.EXPOSURE_OFFSET+4,Mc.MAIN_LIT_COLOR_OFFSET=Mc.MAIN_LIT_DIR_OFFSET+4,Mc.AMBIENT_SKY_OFFSET=Mc.MAIN_LIT_COLOR_OFFSET+4,Mc.AMBIENT_GROUND_OFFSET=Mc.AMBIENT_SKY_OFFSET+4,Mc.GLOBAL_FOG_COLOR_OFFSET=Mc.AMBIENT_GROUND_OFFSET+4,Mc.GLOBAL_FOG_BASE_OFFSET=Mc.GLOBAL_FOG_COLOR_OFFSET+4,Mc.GLOBAL_FOG_ADD_OFFSET=Mc.GLOBAL_FOG_BASE_OFFSET+4,Mc.COUNT=Mc.GLOBAL_FOG_ADD_OFFSET+4,Mc.SIZE=4*Mc.COUNT,Mc.NAME="CCCamera",Mc.BINDING=Cc.UBO_CAMERA,Mc.DESCRIPTOR=new Io(Mc.BINDING,mr.UNIFORM_BUFFER,1,pr.ALL),Mc.LAYOUT=new oo(Pc.GLOBAL,Mc.BINDING,Mc.NAME,[new ro("cc_matView",qs.MAT4,1),new ro("cc_matViewInv",qs.MAT4,1),new ro("cc_matProj",qs.MAT4,1),new ro("cc_matProjInv",qs.MAT4,1),new ro("cc_matViewProj",qs.MAT4,1),new ro("cc_matViewProjInv",qs.MAT4,1),new ro("cc_cameraPos",qs.FLOAT4,1),new ro("cc_screenScale",qs.FLOAT4,1),new ro("cc_exposure",qs.FLOAT4,1),new ro("cc_mainLitDir",qs.FLOAT4,1),new ro("cc_mainLitColor",qs.FLOAT4,1),new ro("cc_ambientSky",qs.FLOAT4,1),new ro("cc_ambientGround",qs.FLOAT4,1),new ro("cc_fogColor",qs.FLOAT4,1),new ro("cc_fogBase",qs.FLOAT4,1),new ro("cc_fogAdd",qs.FLOAT4,1)],1),Tc.layouts[Mc.NAME]=Mc.LAYOUT,Tc.bindings[Mc.BINDING]=Mc.DESCRIPTOR;class Nc{}Nc.MAT_LIGHT_PLANE_PROJ_OFFSET=0,Nc.MAT_LIGHT_VIEW_PROJ_OFFSET=Nc.MAT_LIGHT_PLANE_PROJ_OFFSET+16,Nc.SHADOW_COLOR_OFFSET=Nc.MAT_LIGHT_VIEW_PROJ_OFFSET+16,Nc.SHADOW_INFO_OFFSET=Nc.SHADOW_COLOR_OFFSET+4,Nc.COUNT=Nc.SHADOW_INFO_OFFSET+4,Nc.SIZE=4*Nc.COUNT,Nc.NAME="CCShadow",Nc.BINDING=Cc.UBO_SHADOW,Nc.DESCRIPTOR=new Io(Nc.BINDING,mr.UNIFORM_BUFFER,1,pr.ALL),Nc.LAYOUT=new oo(Pc.GLOBAL,Nc.BINDING,Nc.NAME,[new ro("cc_matLightPlaneProj",qs.MAT4,1),new ro("cc_matLightViewProj",qs.MAT4,1),new ro("cc_shadowColor",qs.FLOAT4,1),new ro("cc_shadowInfo",qs.FLOAT4,1)],1),Tc.layouts[Nc.NAME]=Nc.LAYOUT,Tc.bindings[Nc.BINDING]=Nc.DESCRIPTOR;const Lc=Cc.SAMPLER_SHADOWMAP,zc=new Io(Lc,mr.SAMPLER,1,pr.FRAGMENT),Bc=new ao(Pc.GLOBAL,Lc,"cc_shadowMap",qs.SAMPLER2D,1);Tc.layouts.cc_shadowMap=Bc,Tc.bindings[Lc]=zc;const Fc=Cc.SAMPLER_ENVIRONMENT,Uc=new Io(Fc,mr.SAMPLER,1,pr.FRAGMENT),Gc=new ao(Pc.GLOBAL,Fc,"cc_environment",qs.SAMPLER_CUBE,1);Tc.layouts.cc_environment=Gc,Tc.bindings[Fc]=Uc;const Hc=Cc.SAMPLER_SPOT_LIGHTING_MAP,Vc=new Io(Hc,mr.SAMPLER,1,pr.FRAGMENT),kc=new ao(Pc.GLOBAL,Hc,"cc_spotLightingMap",qs.SAMPLER2D,1);Tc.layouts.cc_spotLightingMap=kc,Tc.bindings[Hc]=Vc;class jc{}jc.MAT_WORLD_OFFSET=0,jc.MAT_WORLD_IT_OFFSET=jc.MAT_WORLD_OFFSET+16,jc.LIGHTINGMAP_UVPARAM=jc.MAT_WORLD_IT_OFFSET+16,jc.COUNT=jc.LIGHTINGMAP_UVPARAM+4,jc.SIZE=4*jc.COUNT,jc.NAME="CCLocal",jc.BINDING=wc.UBO_LOCAL,jc.DESCRIPTOR=new Io(jc.BINDING,mr.UNIFORM_BUFFER,1,pr.VERTEX),jc.LAYOUT=new oo(Pc.LOCAL,jc.BINDING,jc.NAME,[new ro("cc_matWorld",qs.MAT4,1),new ro("cc_matWorldIT",qs.MAT4,1),new ro("cc_lightingMapUVParam",qs.FLOAT4,1)],1),Ec.layouts[jc.NAME]=jc.LAYOUT,Ec.bindings[jc.BINDING]=jc.DESCRIPTOR;class Wc{}Wc.BATCHING_COUNT=10,Wc.MAT_WORLDS_OFFSET=0,Wc.COUNT=16*Wc.BATCHING_COUNT,Wc.SIZE=4*Wc.COUNT,Wc.NAME="CCLocalBatched",Wc.BINDING=wc.UBO_LOCAL,Wc.DESCRIPTOR=new Io(Wc.BINDING,mr.UNIFORM_BUFFER,1,pr.VERTEX),Wc.LAYOUT=new oo(Pc.LOCAL,Wc.BINDING,Wc.NAME,[new ro("cc_matWorlds",qs.MAT4,Wc.BATCHING_COUNT)],1),Ec.layouts[Wc.NAME]=Wc.LAYOUT,Ec.bindings[Wc.BINDING]=Wc.DESCRIPTOR;class qc{}qc.LIGHTS_PER_PASS=1,qc.LIGHT_POS_OFFSET=0,qc.LIGHT_COLOR_OFFSET=qc.LIGHT_POS_OFFSET+4*qc.LIGHTS_PER_PASS,qc.LIGHT_SIZE_RANGE_ANGLE_OFFSET=qc.LIGHT_COLOR_OFFSET+4*qc.LIGHTS_PER_PASS,qc.LIGHT_DIR_OFFSET=qc.LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*qc.LIGHTS_PER_PASS,qc.COUNT=qc.LIGHT_DIR_OFFSET+4*qc.LIGHTS_PER_PASS,qc.SIZE=4*qc.COUNT,qc.NAME="CCForwardLight",qc.BINDING=wc.UBO_FORWARD_LIGHTS,qc.DESCRIPTOR=new Io(qc.BINDING,mr.DYNAMIC_UNIFORM_BUFFER,1,pr.FRAGMENT),qc.LAYOUT=new oo(Pc.LOCAL,qc.BINDING,qc.NAME,[new ro("cc_lightPos",qs.FLOAT4,qc.LIGHTS_PER_PASS),new ro("cc_lightColor",qs.FLOAT4,qc.LIGHTS_PER_PASS),new ro("cc_lightSizeRangeAngle",qs.FLOAT4,qc.LIGHTS_PER_PASS),new ro("cc_lightDir",qs.FLOAT4,qc.LIGHTS_PER_PASS)],1),Ec.layouts[qc.NAME]=qc.LAYOUT,Ec.bindings[qc.BINDING]=qc.DESCRIPTOR;class Xc{}Xc.JOINTS_TEXTURE_INFO_OFFSET=0,Xc.COUNT=Xc.JOINTS_TEXTURE_INFO_OFFSET+4,Xc.SIZE=4*Xc.COUNT,Xc.NAME="CCSkinningTexture",Xc.BINDING=wc.UBO_SKINNING_TEXTURE,Xc.DESCRIPTOR=new Io(Xc.BINDING,mr.UNIFORM_BUFFER,1,pr.VERTEX),Xc.LAYOUT=new oo(Pc.LOCAL,Xc.BINDING,Xc.NAME,[new ro("cc_jointTextureInfo",qs.FLOAT4,1)],1),Ec.layouts[Xc.NAME]=Xc.LAYOUT,Ec.bindings[Xc.BINDING]=Xc.DESCRIPTOR;class Yc{}Yc.JOINTS_ANIM_INFO_OFFSET=0,Yc.COUNT=Yc.JOINTS_ANIM_INFO_OFFSET+4,Yc.SIZE=4*Yc.COUNT,Yc.NAME="CCSkinningAnimation",Yc.BINDING=wc.UBO_SKINNING_ANIMATION,Yc.DESCRIPTOR=new Io(Yc.BINDING,mr.UNIFORM_BUFFER,1,pr.VERTEX),Yc.LAYOUT=new oo(Pc.LOCAL,Yc.BINDING,Yc.NAME,[new ro("cc_jointAnimInfo",qs.FLOAT4,1)],1),Ec.layouts[Yc.NAME]=Yc.LAYOUT,Ec.bindings[Yc.BINDING]=Yc.DESCRIPTOR;class Kc{}Kc.JOINTS_OFFSET=0,Kc.COUNT=Kc.JOINTS_OFFSET+360,Kc.SIZE=4*Kc.COUNT,Kc.NAME="CCSkinning",Kc.BINDING=wc.UBO_SKINNING_TEXTURE,Kc.DESCRIPTOR=new Io(Kc.BINDING,mr.UNIFORM_BUFFER,1,pr.VERTEX),Kc.LAYOUT=new oo(Pc.LOCAL,Kc.BINDING,Kc.NAME,[new ro("cc_joints",qs.FLOAT4,90)],1),Ec.layouts[Kc.NAME]=Kc.LAYOUT,Ec.bindings[Kc.BINDING]=Kc.DESCRIPTOR;class $c{}$c.MAX_MORPH_TARGET_COUNT=60,$c.OFFSET_OF_WEIGHTS=0,$c.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*$c.MAX_MORPH_TARGET_COUNT,$c.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=$c.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH+4,$c.OFFSET_OF_VERTICES_COUNT=$c.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT+4,$c.COUNT_BASE_4_BYTES=4*Math.ceil($c.MAX_MORPH_TARGET_COUNT/4)+4,$c.SIZE=4*$c.COUNT_BASE_4_BYTES,$c.NAME="CCMorph",$c.BINDING=wc.UBO_MORPH,$c.DESCRIPTOR=new Io($c.BINDING,mr.UNIFORM_BUFFER,1,pr.VERTEX),$c.LAYOUT=new oo(Pc.LOCAL,$c.BINDING,$c.NAME,[new ro("cc_displacementWeights",qs.FLOAT4,$c.MAX_MORPH_TARGET_COUNT/4),new ro("cc_displacementTextureInfo",qs.FLOAT4,1)],1),Ec.layouts[$c.NAME]=$c.LAYOUT,Ec.bindings[$c.BINDING]=$c.DESCRIPTOR;const Zc=wc.SAMPLER_JOINTS,Jc=new Io(Zc,mr.SAMPLER,1,pr.VERTEX),Qc=new ao(Pc.LOCAL,Zc,"cc_jointTexture",qs.SAMPLER2D,1);Ec.layouts.cc_jointTexture=Qc,Ec.bindings[Zc]=Jc;const tl=wc.SAMPLER_MORPH_POSITION,el=new Io(tl,mr.SAMPLER,1,pr.VERTEX),nl=new ao(Pc.LOCAL,tl,"cc_PositionDisplacements",qs.SAMPLER2D,1);Ec.layouts.cc_PositionDisplacements=nl,Ec.bindings[tl]=el;const il=wc.SAMPLER_MORPH_NORMAL,sl=new Io(il,mr.SAMPLER,1,pr.VERTEX),rl=new ao(Pc.LOCAL,il,"cc_NormalDisplacements",qs.SAMPLER2D,1);Ec.layouts.cc_NormalDisplacements=rl,Ec.bindings[il]=sl;const ol=wc.SAMPLER_MORPH_TANGENT,al=new Io(ol,mr.SAMPLER,1,pr.VERTEX),cl=new ao(Pc.LOCAL,ol,"cc_TangentDisplacements",qs.SAMPLER2D,1);Ec.layouts.cc_TangentDisplacements=cl,Ec.bindings[ol]=al;const ll=wc.SAMPLER_LIGHTMAP,hl=new Io(ll,mr.SAMPLER,1,pr.FRAGMENT),_l=new ao(Pc.LOCAL,ll,"cc_lightingMap",qs.SAMPLER2D,1);Ec.layouts.cc_lightingMap=_l,Ec.bindings[ll]=hl;const ul=wc.SAMPLER_SPRITE,dl=new Io(ul,mr.SAMPLER,1,pr.FRAGMENT),pl=new ao(Pc.LOCAL,ul,"cc_spriteTexture",qs.SAMPLER2D,1);Ec.layouts.cc_spriteTexture=pl,Ec.bindings[ul]=dl;const ml=yc.makeMaskExclude([yc.BitMask.UI_2D,yc.BitMask.GIZMOS,yc.BitMask.EDITOR,yc.BitMask.SCENE_GIZMO,yc.BitMask.PROFILER]);let fl,gl,vl,yl,xl;yc.makeMaskExclude([yc.BitMask.UI_2D,yc.BitMask.PROFILER]),yc.Enum.ALL,function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(fl||(fl={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(gl||(gl={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(vl||(vl={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(yl||(yl={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(xl||(xl={}));const Sl=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Tl=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],El=[100,200,400,800],Cl=new ln,Al=new ln,bl=new bn,wl=Cr.STENCIL<<1,Rl=[];class Il{constructor(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=fl.VERTICAL,this._fov=je(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new Hr(.2,.2,.2,1),this._viewport=new Mn(0,0,1,1),this._curTransform=wr.IDENTITY,this._isProjDirty=!0,this._matView=new bn,this._matViewInv=null,this._matProj=new bn,this._matProjInv=new bn,this._matViewProj=new bn,this._matViewProjInv=new bn,this._frustum=new cc,this._forward=new ln,this._position=new ln,this._priority=0,this._aperture=vl.F16_0,this._apertureValue=void 0,this._shutter=xl.D125,this._shutterValue=0,this._iso=yl.ISO100,this._isoValue=0,this._ec=0,this._poolHandle=0,this._frustumHandle=0,this._window=null,this._device=t,this._apertureValue=Sl[this._aperture],this._shutterValue=Tl[this._shutter],this._isoValue=El[this._iso],this._aspect=this.screenScale=1,!Rl.length){const e=t.screenSpaceSignY;Rl[wr.IDENTITY]=new bn(1,0,0,0,0,e),Rl[wr.ROTATE_90]=new bn(0,1,0,0,-e,0),Rl[wr.ROTATE_180]=new bn(-1,0,0,0,0,-e),Rl[wr.ROTATE_270]=new bn(0,-1,0,0,e,0)}}initialize(t){this._name=t.name,this._node=t.node,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1;const e=this._poolHandle=Ri.alloc();Ri.set(e,bi.WIDTH,1),Ri.set(e,bi.HEIGHT,1),Ri.set(e,bi.CLEAR_FLAG,Cr.NONE),Ri.set(e,bi.CLEAR_DEPTH,1),Ri.set(e,bi.NODE,this._node.handle),Ri.set(e,bi.VISIBILITY,ml),this._scene&&Ri.set(e,bi.SCENE,this._scene.handle),this._frustumHandle=Gi.alloc(),Ri.set(e,bi.FRUSTUM,this._frustumHandle),this.updateExposure(),this.changeTargetWindow(t.window),console.log(`Created Camera: ${this._name} ${Ri.get(e,bi.WIDTH)}x${Ri.get(e,bi.HEIGHT)}`)}destroy(){this._window&&this._window.detachCamera(this),this._name=null,this._poolHandle&&(Ri.free(this._poolHandle),this._poolHandle=0,this._frustumHandle&&(Gi.free(this._frustumHandle),this._frustumHandle=0))}attachToScene(t){this._scene=t,this._enabled=!0,Ri.set(this._poolHandle,bi.SCENE,t.handle)}detachFromScene(){this._scene=null,this._enabled=!1,Ri.set(this._poolHandle,bi.SCENE,0)}resize(t,e){const n=this._poolHandle;Ri.set(n,bi.WIDTH,t),Ri.set(n,bi.HEIGHT,e),this._aspect=t*this._viewport.width/(e*this._viewport.height),this._isProjDirty=!0}setFixedSize(t,e){const n=this._poolHandle;Ri.set(n,bi.WIDTH,t),Ri.set(n,bi.HEIGHT,e),this._aspect=t*this._viewport.width/(e*this._viewport.height),this.isWindowSize=!1}update(t=!1){if(!this._node)return;let e=!1;(this._node.hasChangedFlags||t)&&(bn.invert(this._matView,this._node.worldMatrix),Ri.setMat4(this._poolHandle,bi.MAT_VIEW,this._matView),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),Ri.setVec3(this._poolHandle,bi.POSITION,this._position),Ri.setVec3(this._poolHandle,bi.FORWARD,this._forward),e=!0);let n=this._device.surfaceTransform;if(this._isProjDirty||this._curTransform!==n){this._curTransform=n;let t=this._device.screenSpaceSignY;if(this._window&&this._window.hasOffScreenAttachments&&(t*=this._device.UVSpaceSignY,n=wr.IDENTITY),this._proj===gl.PERSPECTIVE)bn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===fl.VERTICAL,this._device.clipSpaceMinZ,t,n);else{const e=this._orthoHeight*this._aspect,i=this._orthoHeight;bn.ortho(this._matProj,-e,e,-i,i,this._nearClip,this._farClip,this._device.clipSpaceMinZ,t,n)}bn.invert(this._matProjInv,this._matProj),Ri.setMat4(this._poolHandle,bi.MAT_PROJ,this._matProj),Ri.setMat4(this._poolHandle,bi.MAT_PROJ_INV,this._matProjInv),e=!0,this._isProjDirty=!1}e&&(bn.multiply(this._matViewProj,this._matProj,this._matView),bn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv),Ri.setMat4(this._poolHandle,bi.MAT_VIEW_PROJ,this._matViewProj),Ri.setMat4(this._poolHandle,bi.MAT_VIEW_PROJ_INV,this._matViewProjInv),lc(this._frustumHandle,this._frustum))}set node(t){this._node=t}get node(){return this._node}set enabled(t){this._enabled=t}get enabled(){return this._enabled}set orthoHeight(t){this._orthoHeight=t,this._isProjDirty=!0}get orthoHeight(){return this._orthoHeight}set projectionType(t){this._proj=t,this._isProjDirty=!0}get projectionType(){return this._proj}set fovAxis(t){this._fovAxis=t,this._isProjDirty=!0}get fovAxis(){return this._fovAxis}set fov(t){this._fov=t,this._isProjDirty=!0}get fov(){return this._fov}set nearClip(t){this._nearClip=t,this._isProjDirty=!0}get nearClip(){return this._nearClip}set farClip(t){this._farClip=t,this._isProjDirty=!0}get farClip(){return this._farClip}set clearColor(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w,Ri.setVec4(this._poolHandle,bi.CLEAR_COLOR,t)}get clearColor(){return this._clearColor}get viewport(){return this._viewport}set viewport(t){const{x:e,width:n,height:i}=t,s=this._device.screenSpaceSignY<0?1-t.y-i:t.y;switch(this._device.surfaceTransform){case wr.ROTATE_90:this._viewport.x=1-s-i,this._viewport.y=e,this._viewport.width=i,this._viewport.height=n;break;case wr.ROTATE_180:this._viewport.x=1-e-n,this._viewport.y=1-s-i,this._viewport.width=n,this._viewport.height=i;break;case wr.ROTATE_270:this._viewport.x=s,this._viewport.y=1-e-n,this._viewport.width=i,this._viewport.height=n;break;case wr.IDENTITY:this._viewport.x=e,this._viewport.y=s,this._viewport.width=n,this._viewport.height=i}Ri.setVec4(this._poolHandle,bi.VIEW_PORT,this._viewport),this.resize(this.width,this.height)}get scene(){return this._scene}get name(){return this._name}get width(){return Ri.get(this._poolHandle,bi.WIDTH)}get height(){return Ri.get(this._poolHandle,bi.HEIGHT)}get aspect(){return this._aspect}set matView(t){this._matView=t,Ri.setMat4(this._poolHandle,bi.MAT_VIEW,this._matView)}get matView(){return this._matView}set matViewInv(t){this._matViewInv=t}get matViewInv(){return this._matViewInv||this._node.worldMatrix}set matProj(t){this._matProj=t,Ri.setMat4(this._poolHandle,bi.MAT_PROJ,this._matProj)}get matProj(){return this._matProj}set matProjInv(t){this._matProjInv=t,Ri.setMat4(this._poolHandle,bi.MAT_PROJ_INV,this._matProjInv)}get matProjInv(){return this._matProjInv}set matViewProj(t){this._matViewProj=t,Ri.setMat4(this._poolHandle,bi.MAT_VIEW_PROJ,this._matViewProj)}get matViewProj(){return this._matViewProj}set matViewProjInv(t){this._matViewProjInv=t,Ri.setMat4(this._poolHandle,bi.MAT_VIEW_PROJ_INV,this._matViewProjInv)}get matViewProjInv(){return this._matViewProjInv}set frustum(t){this._frustum=t,lc(this._frustumHandle,t)}get frustum(){return this._frustum}set window(t){this._window=t,t&&Ri.set(this._poolHandle,bi.WINDOW,t.handle)}get window(){return this._window}set forward(t){this._forward=t,Ri.setVec3(this._poolHandle,bi.FORWARD,this._forward)}get forward(){return this._forward}set position(t){this._position=t,Ri.setVec3(this._poolHandle,bi.POSITION,this._position)}get position(){return this._position}set visibility(t){Ri.set(this._poolHandle,bi.VISIBILITY,t)}get visibility(){return Ri.get(this._poolHandle,bi.VISIBILITY)}get priority(){return this._priority}set priority(t){this._priority=t}set aperture(t){this._aperture=t,this._apertureValue=Sl[this._aperture],this.updateExposure()}get aperture(){return this._aperture}get apertureValue(){return this._apertureValue}set shutter(t){this._shutter=t,this._shutterValue=Tl[this._shutter],this.updateExposure()}get shutter(){return this._shutter}get shutterValue(){return this._shutterValue}set iso(t){this._iso=t,this._isoValue=El[this._iso],this.updateExposure()}get iso(){return this._iso}get isoValue(){return this._isoValue}set ec(t){this._ec=t}get ec(){return this._ec}get exposure(){return Ri.get(this._poolHandle,bi.EXPOSURE)}get clearFlag(){return Ri.get(this._poolHandle,bi.CLEAR_FLAG)}set clearFlag(t){Ri.set(this._poolHandle,bi.CLEAR_FLAG,t)}get clearDepth(){return Ri.get(this._poolHandle,bi.CLEAR_DEPTH)}set clearDepth(t){Ri.set(this._poolHandle,bi.CLEAR_DEPTH,t)}get clearStencil(){return Ri.get(this._poolHandle,bi.CLEAR_STENCIL)}set clearStencil(t){Ri.set(this._poolHandle,bi.CLEAR_STENCIL,t)}get handle(){return this._poolHandle}changeTargetWindow(t=null){this._window&&this._window.detachCamera(this);const e=t||i.director.root.mainWindow;e&&(e.attachCamera(this),this.resize(e.width,e.height),this._window=e,Ri.set(this._poolHandle,bi.WINDOW,e.handle))}detachCamera(){this._window&&this._window.detachCamera(this)}screenPointToRay(t,e,n){if(!this._node)return null;const i=this._poolHandle,s=Ri.get(i,bi.WIDTH),r=Ri.get(i,bi.HEIGHT),o=this._viewport.x*s,a=this._viewport.y*r,c=this._viewport.width*s,l=this._viewport.height*r,h=this._proj===gl.PERSPECTIVE,_=this._device.screenSpaceSignY,u=An[this._curTransform];ln.set(Cl,(e-o)/c*2-1,(n-a)/l*2-1,h?1:-1);const{x:d,y:p}=Cl;return Cl.x=d*u[0]+p*u[2]*_,Cl.y=d*u[1]+p*u[3]*_,ln.transformMat4(h?Cl:t.o,Cl,this._matViewProjInv),h?(this._node.getWorldPosition(Al),zs.fromPoints(t,Al,Cl)):ln.transformQuat(t.d,ln.FORWARD,this._node.worldRotation),t}screenToWorld(t,e){const n=this._poolHandle,i=Ri.get(n,bi.WIDTH),s=Ri.get(n,bi.HEIGHT),r=this._viewport.x*i,o=this._viewport.y*s,a=this._viewport.width*i,c=this._viewport.height*s,l=this._device.screenSpaceSignY,h=An[this._curTransform];if(this._proj===gl.PERSPECTIVE){ln.set(t,(e.x-r)/a*2-1,(e.y-o)/c*2-1,1);const{x:n,y:i}=t;t.x=n*h[0]+i*h[2]*l,t.y=n*h[1]+i*h[3]*l,ln.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(Cl),ln.lerp(t,Cl,t,ke(this._nearClip/this._farClip,1,e.z))}else{ln.set(t,(e.x-r)/a*2-1,(e.y-o)/c*2-1,2*e.z-1);const{x:n,y:i}=t;t.x=n*h[0]+i*h[2]*l,t.y=n*h[1]+i*h[3]*l,ln.transformMat4(t,t,this._matViewProjInv)}return t}worldToScreen(t,e){const n=this._poolHandle,i=Ri.get(n,bi.WIDTH),s=Ri.get(n,bi.HEIGHT),r=this._viewport.x*i,o=this._viewport.y*s,a=this._viewport.width*i,c=this._viewport.height*s,l=this._device.screenSpaceSignY,h=An[this._curTransform];ln.transformMat4(t,e,this._matViewProj);const{x:_,y:u}=t;return t.x=_*h[0]+u*h[2]*l,t.y=_*h[1]+u*h[3]*l,t.x=r+.5*(t.x+1)*a,t.y=o+.5*(t.y+1)*c,t.z=.5*t.z+.5,t}worldMatrixToScreen(t,e,n,i){bn.multiply(t,this._matViewProj,e),bn.multiply(t,Rl[this._curTransform],t);const s=n/2,r=i/2;return bn.identity(bl),bn.transform(bl,bl,ln.set(Cl,s,r,0)),bn.scale(bl,bl,ln.set(Cl,s,r,1)),bn.multiply(t,bl,t),t}updateExposure(){const t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);Ri.set(this._poolHandle,bi.EXPOSURE,.833333/2**t)}}let Pl,Ol,Dl;function Ml(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);const n=e*e,i=(.860117757+.000154118254*e+1.28641212e-7*n)/(1+.000842420235*e+7.08145163e-7*n),s=(.317398726+422806245e-13*e+4.20481691e-8*n)/(1-289741816e-13*e+1.61456053e-7*n),r=2*i-8*s+4,o=3*i/r,a=2*s/r,c=1/a*o,l=1/a*(1-o-a);t.x=3.2404542*c-1.5371385+-.4985314*l,t.y=-.969266*c+1.8760108+.041556*l,t.z=.0556434*c-.2040259+1.0572252*l}!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(Pl||(Pl={})),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}(Ol||(Ol={})),i.internal.TransformBit=Ol,function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(Dl||(Dl={}));const Nl=t=>4*Math.PI*Math.PI*t*t;class Ll{constructor(){this._baked=!1,this._color=new ln(1,1,1),this._colorTemp=6550,this._colorTempRGB=new ln(1,1,1),this._scene=null,this._node=null,this._name=null,this._handle=0}get baked(){return this._baked}set baked(t){this._baked=t}set color(t){this._color.set(t),es.setVec3(this._handle,Qi.COLOR,t)}get color(){return this._color}set useColorTemperature(t){es.set(this._handle,Qi.USE_COLOR_TEMPERATURE,t?1:0)}get useColorTemperature(){return 1===es.get(this._handle,Qi.USE_COLOR_TEMPERATURE)}set colorTemperature(t){this._colorTemp=t,Ml(this._colorTempRGB,this._colorTemp),es.setVec3(this._handle,Qi.COLOR_TEMPERATURE_RGB,this._colorTempRGB)}get colorTemperature(){return this._colorTemp}get colorTemperatureRGB(){return this._colorTempRGB}set node(t){this._node=t,this._node&&(this._node.hasChangedFlags|=Ol.ROTATION,es.set(this._handle,Qi.NODE,this._node.handle))}get node(){return this._node}get type(){return es.get(this._handle,Qi.TYPE)}get name(){return this._name}set name(t){this._name=t}get scene(){return this._scene}get handle(){return this._handle}initialize(){this._handle=es.alloc(),es.setVec3(this._handle,Qi.COLOR,this._color),es.setVec3(this._handle,Qi.COLOR_TEMPERATURE_RGB,this._colorTempRGB),es.set(this._handle,Qi.TYPE,Dl.UNKNOWN)}attachToScene(t){this._scene=t}detachFromScene(){this._scene=null}destroy(){this._name=null,this._node=null,this._handle&&(es.free(this._handle),this._handle=0)}update(){}}const zl=new ln(0,0,-1),Bl=new ln;class Fl extends Ll{set shadowRange(t){this._shadowRange=t}get shadowRange(){return this._shadowRange}set shadowIntensitywRange(t){this._shadowIntensity=t}get shadowIntensity(){return this._shadowIntensity}set shadowFadeDistance(t){this._shadowFadeDistance=t}get shadowFadeDistance(){return this._shadowFadeDistance}set shadowDistance(t){this._shadowDistance=t}get shadowDistance(){return this._shadowDistance}set fadeStart(t){this._fadeStart=t}get fadeStart(){return this._fadeStart}set splits(t){this._splits=t}get splits(){return this._splits}set biasAutoAdjust(t){this._biasAutoAdjust=t}get biasAutoAdjust(){return this._biasAutoAdjust}set direction(t){ln.normalize(this._dir,t),es.setVec3(this._handle,Qi.DIRECTION,this._dir)}get direction(){return this._dir}set illuminance(t){es.set(this._handle,Qi.ILLUMINANCE,t)}get illuminance(){return es.get(this._handle,Qi.ILLUMINANCE)}constructor(){super(),this._dir=new ln(1,-1,-1),this._shadowRange=1e3,this._shadowIntensity=0,this._shadowFadeDistance=0,this._shadowDistance=0,this._fadeStart=.8,this._splits=new dn(1,0,0,0),this._biasAutoAdjust=1}initialize(){super.initialize(),es.set(this._handle,Qi.ILLUMINANCE,Ts.SUN_ILLUM),es.setVec3(this._handle,Qi.DIRECTION,this._dir),es.set(this._handle,Qi.TYPE,Dl.DIRECTIONAL)}update(){this._node&&this._node.hasChangedFlags&&(this.direction=ln.transformQuat(Bl,zl,this._node.worldRotation))}}function Ul(t,e,n,i){n&&Object.defineProperty(t,e,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function Gl(t,e,n,i,s){var r={};return Object.keys(i).forEach((function(t){r[t]=i[t]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=n.slice().reverse().reduce((function(n,i){return i(t,e,n)||n}),r),s&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(s):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(t,e,r),r=null),r}const Hl=()=>{},Vl=()=>Hl,kl=jl(()=>{});function jl(t){return function(e){return"function"==typeof e?t(e):function(n){return t(n,e)}}}function Wl(t){return e=>n=>{!function(t,e,n){const i=ql(t);if(i){const t=Xl(i,"proto");Xl(t,"editor")[e]=n}}(n,t,e)}}function ql(t){return Xl(t,"__ccclassCache__")}function Xl(t,e){return t[e]||(t[e]={})}const Yl=jl((t,e)=>{let n=Vt.getSuper(t);n===Object&&(n=null);const i={name:e,extends:n,ctor:t},s=t.__ccclassCache__;if(s){const e=s.proto;e&&Vt.mixin(i,e),t.__ccclassCache__=void 0}return Me(i)}),Kl=Wl("requireComponent"),$l=Wl("executionOrder"),Zl=kl;function Jl(t,e,n){let i=null;function s(t,e,n){const s=ql(t.constructor);if(s){const r=Xl(s,"proto"),o=Xl(r,"properties");!function(t,e,n,i,s,r){let o;const a=s&&(s.get||s.set);i&&(o=Ce(i,a));const c=e[n],l=Vt.mixin(c||{},o||i||{});if(a)s.get&&(l.get=s.get),s.set&&(l.set=s.set);else if(s)s.initializer&&(l.default=function(t){let e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}(s.initializer));else{const e=r.default||(r.default=function(t){let e;try{e=new t}catch(t){return{}}return e}(t));e.hasOwnProperty(n)&&(l.default=e[n])}e[n]=l}(t.constructor,o,e,i,n,s)}}return void 0===t?Jl({type:void 0}):void 0===e?(i=t,s):void s(t,e,n)}const Ql=(t,e,n)=>Jl(eh({}))(t,e,n),th=(t,e,n)=>Jl({editorOnly:!0})(t,e,n);function eh(t){return t.__noImplicit=!0,"serializable"in t||(t.serializable=!0),t}const nh=kl,ih=Vl,sh=kl,rh=Vl,oh=Vl,ah=Vl,ch=Hl,lh=Vl,hh=Vl,_h=Vl,uh=Vl,dh=Vl,ph=Vl,mh=Vl,fh=Hl,gh=Vl,vh=Vl,yh=Hl,xh=Hl,Sh=Ah(pe),Th=Ah(me),Eh=Ah(fe),Ch=Ah(ge);function Ah(t){return Jl({type:t})}const bh=(t,e,n)=>Jl({__noImplicit:!0,override:!0})(t,e,n);class wh{constructor(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=Vt.createMap(!0),this._count=0)}add(t,e){return t in this._map||this._count++,this._map[t]=e}get(t){return this._map[t]}has(t){return t in this._map}remove(t){const e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e}clear(){0!==this._count&&(this._map=Vt.createMap(!0),this._count=0)}forEach(t){for(const e in this._map)t(this._map[e],e)}find(t){for(const e in this._map)if(t(this._map[e],e))return this._map[e];return null}get count(){return this._count}destroy(){this._map=null}}class Rh{constructor(t,e){this.id=Rh._pipelineId++,this.name="",this.pipes=[],this.name=t;for(let t=0,n=e.length;t<n;t++)this.pipes.push(e[t])}insert(t,e){return e>this.pipes.length?(x(4921),this):(this.pipes.splice(e,0,t),this)}append(t){return this.pipes.push(t),this}remove(t){return this.pipes.splice(t,1),this}sync(t){const e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(let n=0,i=e.length;n<i;){const s=(0,e[n])(t);if(s)return t.isFinish=!0,s;n++,n!==i&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output}async(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))}_flow(t,e){(0,this.pipes[t])(e,n=>{n?(e.isFinish=!0,e.dispatch("complete",n)):++t<this.pipes.length?(e.input=e.output,e.output=null,this._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",n,e.output))})}}Rh._pipelineId=0;const Ih=new wh,Ph=new wh,Oh=new wh,Dh=new wh,Mh=new Rh("normal load",[]),Nh=new Rh("fetch",[]),Lh=new Rh("transform url",[]);let zh;!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(zh||(zh={}));const Bh={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};let Fh;!function(t){t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(Fh||(Fh={}));class Uh{static create(t){let e;return 0!==Uh._deadPool.length?(e=Uh._deadPool.pop(),e.set(t)):e=new Uh(t),e}constructor(t){this.id=Uh._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}set(t=Object.create(null)){this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)}dispatch(t,e,n,i,s){switch(t){case"complete":this.onComplete&&this.onComplete(e,n);break;case"progress":this.onProgress&&this.onProgress(e,n,i,s);break;case"error":this.onError&&this.onError(e,n,i,s);break;default:{const r=`on${t[0].toUpperCase()}${t.substr(1)}`;"function"==typeof this[r]&&this[r](e,n,i,s);break}}}recycle(){Uh._deadPool.length!==Uh.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,Uh._deadPool.push(this))}}Uh.MAX_DEAD_NUM=500,Uh._taskId=0,Uh._deadPool=[];const Gh="0123456789abcdef".split(""),Hh=["","","",""],Vh=Hh.concat(Hh,"-",Hh,"-",Hh,"-",Hh,"-",Hh,Hh,Hh),kh=Vh.map((t,e)=>"-"===t?NaN:e).filter(isFinite);function jh(t){const e=t.split("@")[0];if(22!==e.length)return t;Vh[0]=t[0],Vh[1]=t[1];for(let e=2,n=2;e<22;e+=2){const i=Jt[t.charCodeAt(e)],s=Jt[t.charCodeAt(e+1)];Vh[kh[n++]]=Gh[i>>2],Vh[kh[n++]]=Gh[(3&i)<<2|s>>4],Vh[kh[n++]]=Gh[15&s]}return t.replace(e,Vh.join(""))}const Wh=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function qh(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.ext=e.nativeExt;const n=Dh.find(e=>!!e.getAssetInfo(t));return n&&(e.bundle=n.name),Kh(t,e)}function Xh(t){return t&&(t instanceof i.SceneAsset||t instanceof i.Scene)}function Yh(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function Kh(t,e){const n=Uh.create({input:t,options:e}),i=[];try{const t=Lh.sync(n);for(const e of t){const t=e.url;e.recycle(),i.push(t)}}catch(t){for(const t of n.output)t.recycle();u(t.message,t.stack)}return n.recycle(),i.length>1?i:i[0]}var $h=Object.freeze({__proto__:null,getUuidFromURL:function(t){const e=Wh.exec(t);return e?e[1]:""},getUrlWithUuid:qh,isScene:Xh,normalize:Yh,transform:Kh,decodeUuid:jh});class Zh{constructor(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}unuse(){this.type=Zh.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=Zh.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}reuse(t,e){this.type=t,this.bubbles=e||!1}isStopped(){return this.propagationStopped||this.propagationImmediateStopped}getCurrentTarget(){return this.currentTarget}getType(){return this.type}}t("Event",Zh),Zh.NO_TYPE="no_type",Zh.TOUCH="touch",Zh.MOUSE="mouse",Zh.KEYBOARD="keyboard",Zh.ACCELERATION="acceleration",Zh.NONE=0,Zh.CAPTURING_PHASE=1,Zh.AT_TARGET=2,Zh.BUBBLING_PHASE=3,i.Event=Zh;class Jh{constructor(t,e){this._ctor=void 0,this._elementsPerBatch=void 0,this._nextAvail=void 0,this._freepool=[],this._ctor=t,this._elementsPerBatch=Math.max(e,1),this._nextAvail=this._elementsPerBatch-1;for(let e=0;e<this._elementsPerBatch;++e)this._freepool.push(t())}alloc(){if(this._nextAvail<0){const t=this._elementsPerBatch;for(let e=0;e<t;e++)this._freepool.push(this._ctor());this._nextAvail=t-1}const t=this._freepool[this._nextAvail--];return this._freepool.length--,t}free(t){this._freepool.push(t),this._nextAvail++}freeArray(t){Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length}destroy(t){if(t)for(let e=0;e<=this._nextAvail;e++)t(this._freepool[e]);this._freepool.length=0,this._nextAvail=-1}}t("Pool",Jh);class Qh{constructor(t,e){this._fn=void 0,this._count=0,this._data=void 0,this._fn=t,this._data=new Array(e);for(let n=0;n<e;++n)this._data[n]=t()}get length(){return this._count}get data(){return this._data}reset(){this._count=0}resize(t){if(t>this._data.length)for(let e=this._data.length;e<t;++e)this._data[e]=this._fn()}add(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}removeAt(t){if(t>=this._count)return;const e=this._count-1,n=this._data[t];this._data[t]=this._data[e],this._data[e]=n,this._count-=1}}t("RecyclePool",Qh);class t_{constructor(t,e){this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(t),this.length=0,this._compareFn=void 0!==e?e:(t,e)=>t-e}push(t){this.array[this.length++]=t}pop(){return this.array[--this.length]}get(t){return this.array[t]}clear(){this.length=0}destroy(){this.length=0,this.array.length=0}sort(){this.array.length=this.length,this.array.sort(this._compareFn)}concat(t){for(let e=0;e<t.length;++e)this.array[this.length++]=t[e]}fastRemove(t){if(t>=this.length||t<0)return;const e=--this.length;this.array[t]=this.array[e]}indexOf(t){return this.array.indexOf(t)}}t("CachedArray",t_),t("memop",Object.freeze({__proto__:null,Pool:Jh,RecyclePool:Qh,CachedArray:t_}));const e_=[];class n_{static _deferredDestroy(){const t=e_.length;for(let e=0;e<t;++e){const t=e_[e];1&t._objFlags||t._destroyImmediate()}t===e_.length?e_.length=0:e_.splice(0,t)}constructor(t=""){this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}get name(){return this._name}set name(t){this._name=t}get isValid(){return!(1&this._objFlags)}destroy(){return 1&this._objFlags?(x(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,e_.push(this),0))}_destruct(){const t=this.constructor;let e=t.__destruct__;e||(e=function(t,e){const n=t instanceof i._BaseNode||t instanceof i.Component,s=n?"_id":null;let r;const o={};for(r in t)if(t.hasOwnProperty(r)){if(r===s)continue;switch(typeof t[r]){case"string":o[r]="";break;case"object":case"function":o[r]=null}}if(Me._isCCClass(e)){const t=i.Class.Attr.getClassAttrs(e),s=e.__props__;for(let e=0;e<s.length;e++){r=s[e];const a=r+i.Class.Attr.DELIMETER+"default";if(a in t){if(n&&"_id"===r)continue;switch(typeof t[a]){case"string":o[r]="";break;case"object":case"function":o[r]=null;break;case"undefined":o[r]=void 0}}}}{let t="";for(r in o){let e;e=Me.IDENTIFIER_RE.test(r)?`o.${r}=`:`o[${Me.escapeForJS(r)}]=`;let n=o[r];""===n&&(n='""'),t+=e+n+";\n"}return Function("o",t)}}(this,t),lt(t,"__destruct__",e,!0)),e(this)}_destroyImmediate(){1&this._objFlags?T(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}}t("CCObject",n_);const i_=n_.prototype;function s_(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}i_._deserialize=null,i_._onPreDestroy=null,Me.fastDefine("cc.Object",n_,{_name:"",_objFlags:0}),lt(n_,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),i.isValid=s_,i.Object=n_;const r_=Ht.fastRemoveAt;function o_(){}class a_{constructor(){this.callback=o_,this.target=void 0,this.once=!1}set(t,e,n){this.callback=t||o_,this.target=e,this.once=!!n}reset(){this.target=void 0,this.callback=o_,this.once=!1}check(){return!(this.target instanceof n_&&!s_(this.target,!0))}}const c_=new Jh(()=>new a_,32);class l_{constructor(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}removeByCallback(t){for(let e=0;e<this.callbackInfos.length;++e){const n=this.callbackInfos[e];n&&n.callback===t&&(n.reset(),c_.free(n),r_(this.callbackInfos,e),--e)}}removeByTarget(t){for(let e=0;e<this.callbackInfos.length;++e){const n=this.callbackInfos[e];n&&n.target===t&&(n.reset(),c_.free(n),r_(this.callbackInfos,e),--e)}}cancel(t){const e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:r_(this.callbackInfos,t),c_.free(e)),this.containCanceled=!0}cancelAll(){for(let t=0;t<this.callbackInfos.length;t++){const e=this.callbackInfos[t];e&&(e.reset(),c_.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0}purgeCanceled(){for(let t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||r_(this.callbackInfos,t);this.containCanceled=!1}clear(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}const h_=new Jh(()=>new l_,16);class __{constructor(){this._callbackTable=dt(!0)}on(t,e,n,i){if(!this.hasEventListener(t,e,n)){let s=this._callbackTable[t];s||(s=this._callbackTable[t]=h_.alloc());const r=c_.alloc();r.set(e,n,i),s.callbackInfos.push(r)}return e}hasEventListener(t,e,n){const i=this._callbackTable&&this._callbackTable[t];if(!i)return!1;const s=i.callbackInfos;if(!e){if(i.isInvoking){for(let t=0;t<s.length;++t)if(s[t])return!0;return!1}return s.length>0}for(let t=0;t<s.length;++t){const i=s[t];if(i&&i.check()&&i.callback===e&&i.target===n)return!0}return!1}removeAll(t){if("string"==typeof t){const e=this._callbackTable&&this._callbackTable[t];e&&(e.isInvoking?e.cancelAll():(e.clear(),h_.free(e),delete this._callbackTable[t]))}else if(t)for(const e in this._callbackTable){const n=this._callbackTable[e];if(n.isInvoking){const e=n.callbackInfos;for(let i=0;i<e.length;++i){const s=e[i];s&&s.target===t&&n.cancel(i)}}else n.removeByTarget(t)}}off(t,e,n){const i=this._callbackTable&&this._callbackTable[t];if(i){const s=i.callbackInfos;if(e)for(let t=0;t<s.length;++t){const r=s[t];if(r&&r.callback===e&&r.target===n){i.cancel(t);break}}else this.removeAll(t)}}emit(t,e,n,i,s,r){const o=this._callbackTable&&this._callbackTable[t];if(o){const a=!o.isInvoking;o.isInvoking=!0;const c=o.callbackInfos;for(let o=0,a=c.length;o<a;++o){const a=c[o];if(a){const o=a.callback,c=a.target;a.once&&this.off(t,o,c),a.check()?c?o.call(c,e,n,i,s,r):o(e,n,i,s,r):this.off(t,o,c)}}a&&(o.isInvoking=!1,o.containCanceled&&o.purgeCanceled())}}clear(){for(const t in this._callbackTable){const e=this._callbackTable[t];e&&(e.clear(),h_.free(e),delete this._callbackTable[t])}}}function u_(t){class e extends t{constructor(...t){super(...t),this._callbackTable=dt(!0)}once(t,e,n){return this.on(t,e,n,!0)}targetOff(t){this.removeAll(t)}}const n=__.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n));for(let t=0;t<i.length;++t){const s=i[t];if(!(s in e.prototype)){const t=Object.getOwnPropertyDescriptor(n,s);t&&Object.defineProperty(e.prototype,s,t)}}return e}const d_=t("EventTarget",u_(class{}));var p_,m_,f_,g_,v_;i.EventTarget=d_;let y_=t("Asset",Yl("cc.Asset")((v_=g_=class extends(u_(n_)){static deserialize(t){return i.deserialize(t)}get nativeUrl(){if(!this._nativeUrl){if(!this._native)return"";const t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=qh(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=qh(this._uuid,{__nativeName__:t,nativeExt:N(t),isNative:!0})}return this._nativeUrl}get _nativeAsset(){return this._file}set _nativeAsset(t){this._file=t}constructor(...t){super(...t),this.loaded=!0,Ul(this,"_native",f_,this),this._nativeUrl="",this.__onLoadedInvoked__=!1,this.__nativeDepend__=null,this.__asyncLoadAssets__=!1,this.__depends__=null,this._file=null,this._ref=0,Object.defineProperty(this,"_uuid",{value:"",writable:!0})}toString(){return this.nativeUrl}serialize(){}_setRawAsset(t,e=!0){this._native=!1!==e?t||"":"/"+t}get _nativeDep(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}get refCount(){return this._ref}addRef(){return this._ref++,this}decRef(t=!0){return this._ref>0&&this._ref--,t&&i.assetManager._releaseManager.tryRelease(this),this}onLoaded(){}},g_.preventDeferredLoadDependents=!1,g_.preventPreloadNativeObject=!1,f_=Gl((m_=v_).prototype,"_native",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Gl(m_.prototype,"_nativeAsset",[Jl],Object.getOwnPropertyDescriptor(m_.prototype,"_nativeAsset"),m_.prototype),p_=m_))||p_);y_.prototype.createNode=null,i.Asset=y_;let x_,S_,T_,E_=1024;var C_,A_,b_,w_;function R_(t){return i.sys.capabilities.imageBitmap&&t instanceof ImageBitmap}!function(t){t[t.RGB565=Xs.R5G6B5]="RGB565",t[t.RGB5A1=Xs.RGB5A1]="RGB5A1",t[t.RGBA4444=Xs.RGBA4]="RGBA4444",t[t.RGB888=Xs.RGB8]="RGB888",t[t.RGB32F=Xs.RGB32F]="RGB32F",t[t.RGBA8888=Xs.RGBA8]="RGBA8888",t[t.RGBA32F=Xs.RGBA32F]="RGBA32F",t[t.A8=Xs.A8]="A8",t[t.I8=Xs.L8]="I8",t[t.AI8=Xs.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=Xs.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=Xs.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=E_++]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=Xs.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=Xs.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=E_++]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=Xs.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=E_++]="RGBA_ETC1",t[t.RGB_ETC2=Xs.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=Xs.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=Xs.ASTC_RGBA_4x4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=Xs.ASTC_RGBA_5x4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=Xs.ASTC_RGBA_5x5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=Xs.ASTC_RGBA_6x5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=Xs.ASTC_RGBA_6x6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=Xs.ASTC_RGBA_8x5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=Xs.ASTC_RGBA_8x6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=Xs.ASTC_RGBA_8x8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=Xs.ASTC_RGBA_10x5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=Xs.ASTC_RGBA_10x6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=Xs.ASTC_RGBA_10x8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=Xs.ASTC_RGBA_10x10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=Xs.ASTC_RGBA_12x10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=Xs.ASTC_RGBA_12x12]="RGBA_ASTC_12x12"}(x_||(x_={})),function(t){t[t.REPEAT=lr.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=lr.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=lr.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=lr.BORDER]="CLAMP_TO_BORDER"}(S_||(S_={})),function(t){t[t.NONE=cr.NONE]="NONE",t[t.LINEAR=cr.LINEAR]="LINEAR",t[t.NEAREST=cr.POINT]="NEAREST"}(T_||(T_={}));let I_,P_=t("ImageAsset",Yl("cc.ImageAsset")((w_=b_=class t extends y_{get _nativeAsset(){return this._nativeData}set _nativeAsset(t){t instanceof HTMLElement||R_(t)||(t.format=t.format||this._format),this.reset(t)}get data(){return this._nativeData&&!0!==(t=this._nativeData)._compressed&&(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||R_(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}get width(){return this._nativeData.width||this._width}get height(){return this._nativeData.height||this._height}get format(){return this._format}get isCompressed(){return this._format>=x_.RGB_ETC1&&this._format<=x_.RGBA_ASTC_12x12||this._format>=x_.RGB_A_PVRTC_2BPPV1&&this._format<=x_.RGBA_ETC1}get url(){return this.nativeUrl}set _texture(t){this._tex=t}get _texture(){if(!this._tex){const t=new i.Texture2D;t.name=this.nativeUrl,t.image=this,this._tex=t}return this._tex}constructor(t){super(),this._nativeData=void 0,this._tex=void 0,this._exportedExts=void 0,this._format=x_.RGBA8888,this._width=0,this._height=0,this.loaded=!1,this._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&this.reset(t)}reset(t){R_(t)?(this._nativeData=t,this._onDataComplete()):t instanceof HTMLElement?(this._nativeData=t,t.complete||t instanceof HTMLCanvasElement?this._onDataComplete():(this.loaded=!1,t.addEventListener("load",()=>{this._onDataComplete()}),t.addEventListener("error",t=>{x(3119,t.message)}))):(this._nativeData=t,this._format=t.format,this._onDataComplete())}destroy(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset(""),this.data.destroy()):R_(this.data)&&this.data.close&&this.data.close(),super.destroy()}_serialize(){}_deserialize(e){let n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);const s=i.director.root?i.director.root.device:null,r=n.split("_");let o="",a=Number.MAX_VALUE,c=this._format,l="";const h=i.macro.SUPPORT_TEXTURE_FORMATS;for(const e of r){const n=e.split("@"),r=parseInt(n[0],void 0),_=t.extnames[r]||n[0],u=h.indexOf(_);if(-1!==u&&u<a){const t=n[1]?parseInt(n[1]):this._format;if(!(".astc"!==_||s&&s.hasFeature(Rr.FORMAT_ASTC)))continue;if(!(".pvr"!==_||s&&s.hasFeature(Rr.FORMAT_PVRTC)))continue;if(!(t!==x_.RGB_ETC1&&t!==x_.RGBA_ETC1||s&&s.hasFeature(Rr.FORMAT_ETC1)))continue;if(!(t!==x_.RGB_ETC2&&t!==x_.RGBA_ETC2||s&&s.hasFeature(Rr.FORMAT_ETC2)))continue;if(".webp"===_&&!i.sys.capabilities.webp)continue;a=u,l=_,c=t}else o||(o=_)}l?(this._setRawAsset(l),this._format=c):o?(this._setRawAsset(o),x(3120,o,o)):x(3121)}_onDataComplete(){this.loaded=!0,this.emit("load")}},b_.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Gl((A_=w_).prototype,"_nativeAsset",[bh],Object.getOwnPropertyDescriptor(A_.prototype,"_nativeAsset"),A_.prototype),C_=A_))||C_);i.ImageAsset=P_,function(t){t[t.minFilter=0]="minFilter",t[t.magFilter=1]="magFilter",t[t.mipFilter=2]="mipFilter",t[t.addressU=3]="addressU",t[t.addressV=4]="addressV",t[t.addressW=5]="addressW",t[t.maxAnisotropy=6]="maxAnisotropy",t[t.cmpFunc=7]="cmpFunc",t[t.minLOD=8]="minLOD",t[t.maxLOD=9]="maxLOD",t[t.mipLODBias=10]="mipLODBias",t[t.total=11]="total"}(I_||(I_={}));const O_=[cr.LINEAR,cr.LINEAR,cr.NONE,lr.WRAP,lr.WRAP,lr.WRAP,8,ir.NEVER,0,0,0],D_=L_(O_),M_=new Hr,N_=new Eo;function L_(t){let e=0,n=0;for(let i=0;i<O_.length;i++)switch(e=t[i]||O_[i],i){case I_.minFilter:n|=e;break;case I_.magFilter:n|=e<<2;break;case I_.mipFilter:n|=e<<4;break;case I_.addressU:n|=e<<6;break;case I_.addressV:n|=e<<8;break;case I_.addressW:n|=e<<10;break;case I_.maxAnisotropy:n|=e<<12;break;case I_.cmpFunc:n|=e<<16;break;case I_.minLOD:n|=e<<20;break;case I_.maxLOD:n|=e<<24;break;case I_.mipLODBias:n|=e<<28}return n}const z_=new class{constructor(){this._cache={}}getSampler(t,e){e||(e=D_);const n=this._cache[e];return n||(N_.minFilter=3&e,N_.magFilter=e>>2&3,N_.mipFilter=e>>4&3,N_.addressU=e>>6&3,N_.addressV=e>>8&3,N_.addressW=e>>10&3,N_.maxAnisotropy=e>>12&15,N_.cmpFunc=e>>16&15,N_.minLOD=e>>20&15,N_.maxLOD=e>>24&15,N_.mipLODBias=e>>28&15,N_.borderColor=M_,this._cache[e]=t.createSampler(N_))}};var B_,F_,U_,G_,H_,V_,k_,j_,W_,q_,X_,Y_;i.samplerLib=z_;const K_=new it("Tex");let $_=Yl("cc.TextureBase")((Y_=X_=class extends y_{get isCompressed(){return this._format>=x_.RGB_ETC1&&this._format<=x_.RGBA_ASTC_12x12||this._format>=x_.RGB_A_PVRTC_2BPPV1&&this._format<=x_.RGBA_ETC1}get width(){return this._width}get height(){return this._height}constructor(){super(),Ul(this,"_format",U_,this),Ul(this,"_minFilter",G_,this),Ul(this,"_magFilter",H_,this),Ul(this,"_mipFilter",V_,this),Ul(this,"_wrapS",k_,this),Ul(this,"_wrapT",j_,this),Ul(this,"_wrapR",W_,this),Ul(this,"_anisotropy",q_,this),this._width=1,this._height=1,this._id=void 0,this._samplerInfo=[],this._samplerHash=0,this._gfxSampler=null,this._gfxDevice=null,this._textureHash=0,this._id=K_.getNewId(),this.loaded=!1,this._gfxDevice=this._getGFXDevice(),this._textureHash=vo(this._id,666)}getId(){return this._id}getPixelFormat(){return this._format}getAnisotropy(){return this._anisotropy}setWrapMode(t,e,n){this._wrapS=t,this._samplerInfo[I_.addressU]=t,this._wrapT=e,this._samplerInfo[I_.addressV]=e,void 0!==n&&(this._wrapR=n,this._samplerInfo[I_.addressW]=n),this._samplerHash=L_(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=z_.getSampler(this._gfxDevice,this._samplerHash))}setFilters(t,e){this._minFilter=t,this._samplerInfo[I_.minFilter]=t,this._magFilter=e,this._samplerInfo[I_.magFilter]=e,this._samplerHash=L_(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=z_.getSampler(this._gfxDevice,this._samplerHash))}setMipFilter(t){this._mipFilter=t,this._samplerInfo[I_.mipFilter]=t,this._samplerInfo[I_.maxLOD]=t===T_.NONE?0:15,this._samplerHash=L_(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=z_.getSampler(this._gfxDevice,this._samplerHash))}setAnisotropy(t){this._anisotropy=t,this._samplerInfo[I_.maxAnisotropy]=t,this._samplerHash=L_(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=z_.getSampler(this._gfxDevice,this._samplerHash))}destroy(){const t=super.destroy();return t&&i.director.root&&i.director.root.batcher2D&&i.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),t}getHash(){return this._textureHash}getGFXTexture(){return null}getSamplerHash(){return this._samplerHash}getGFXSampler(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=z_.getSampler(this._gfxDevice,this._samplerHash):T(9302)),this._gfxSampler}_serialize(t){return""}_deserialize(t,e){const n=t.split(",");n.unshift(""),n.length>=5&&(this.setFilters(parseInt(n[1]),parseInt(n[2])),this.setWrapMode(parseInt(n[3]),parseInt(n[4]))),n.length>=7&&(this.setMipFilter(parseInt(n[5])),this.setAnisotropy(parseInt(n[6])))}_getGFXDevice(){return i.director.root?i.director.root.device:null}_getGFXFormat(){return this._getGFXPixelFormat(this._format)}_setGFXFormat(t){this._format=void 0===t?x_.RGBA8888:t}_getGFXPixelFormat(t){return t===x_.RGBA_ETC1?t=x_.RGB_ETC1:t===x_.RGB_A_PVRTC_4BPPV1?t=x_.RGB_PVRTC_4BPPV1:t===x_.RGB_A_PVRTC_2BPPV1&&(t=x_.RGB_PVRTC_2BPPV1),t}},X_.PixelFormat=x_,X_.WrapMode=S_,X_.Filter=T_,U_=Gl((F_=Y_).prototype,"_format",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return x_.RGBA8888}}),G_=Gl(F_.prototype,"_minFilter",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return T_.LINEAR}}),H_=Gl(F_.prototype,"_magFilter",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return T_.LINEAR}}),V_=Gl(F_.prototype,"_mipFilter",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return T_.NONE}}),k_=Gl(F_.prototype,"_wrapS",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return S_.REPEAT}}),j_=Gl(F_.prototype,"_wrapT",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return S_.REPEAT}}),W_=Gl(F_.prototype,"_wrapR",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return S_.REPEAT}}),q_=Gl(F_.prototype,"_anisotropy",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),B_=F_))||B_;i.TextureBase=$_;const Z_=[rn,ln,dn,vn,Ln,On,Mn,bn];function J_(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}const Q_=[(t,e)=>{t.x=e[1],t.y=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.z=e[3]},J_,J_,(t,e)=>{t._val=e[1]},(t,e)=>{t.width=e[1],t.height=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},(t,e)=>{bn.fromArray(t,e,1)}];class tu{constructor(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null}init(t){this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]}reset(){this.uuidList=null,this.uuidObjList=null,this.uuidPropList=null}push(t,e,n){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(n)}}function eu(t,e){const n=t[4][e[0]],i=n[0],s=new(0,i[0]),r=i[1],o=i[2],a=n[n.length-1];let c=1;for(;c<a;++c)s[r[n[c]]]=e[c];for(;c<e.length;++c){const a=r[n[c]],l=i[n[c]+o];(0,au[l])(t,s,a,e[c])}return s}function nu(t,e,n){const i=new e;return i._deserialize?i._deserialize(n,t[0]):T(5303,pt(e)),i}function iu(t,e,n,i){i>=0?e[n]=t[5][i]:t[7][3*~i]=e}function su(t){return(e,n,i,s)=>{n[i]=s;for(let n=0;n<s.length;++n)t(e,s,n,s[n])}}function ru(t,e,n,i){e[n]=null,t[8][i]=e}function ou(t,e,n,i){e[n]=eu(t,i)}t("Details",tu),tu.pool=new Gt(t=>{t.reset()},5),tu.pool.get=function(){return this._get()||new tu};const au=new Array(13);function cu(t,e){return t||uu.reportMissingClass(e),Object}function lu(t,e,n,i,s,r){let o=t(e);if(!o){if(s)return void(n[i]=(a=n,c=i,l=e,function(){const e=t(l)||cu(r,l);return a[c]=e,new e}));o=cu(r,e)}var a,c,l;n[i]=o}function hu(t,e,n){const i=n||Bt,s=t[3];for(let t=0;t<s.length;++t){const r=s[t];"string"!=typeof r?lu(i,r[0],r,0,e,n):lu(i,r,s,t,e,n)}}function _u(t){const e=t[4];if(e){const n=t[3];for(let t=0;t<e.length;++t){const i=e[t];i[0]=n[i[0]]}}}function uu(t,e,n){"string"==typeof t&&(t=JSON.parse(t));const s=!e;let r;{(e=e||tu.pool.get()).init(t),n=n||{};let s=t[0],c=!1;if("object"==typeof s&&(c=s.preprocessed,s=s.version),s<1)throw new Error(b(5304,s));n._version=s,n.result=e,t[0]=n,c||(hu(t,!1,n.classFinder),_u(t)),i.game._isCloning=!0;const l=t[5],h=function(t){const e=t[5],n=t[6],i=0===n?0:n.length;let s=e[e.length-1],r=e.length-i;"number"!=typeof s?s=0:(s<0&&(s=~s),--r);let o=0;for(;o<r;++o)e[o]=eu(t,e[o]);const a=t[3];for(let s=0;s<i;++s,++o){let i=n[s];const r=e[o];if(i>=0){const n=a[i];e[o]=nu(t,n,r)}else i=~i,(0,au[i])(t,e,o,r)}return s}(t);i.game._isCloning=!1,t[7]&&function(t,e,n){const i=t.length-1;let s=0;const r=3*t[i];for(;s<r;s+=3){const i=t[s],r=e[t[s+2]],o=t[s+1];o>=0?i[n[o]]=r:i[~o]=r}for(;s<i;s+=3){const i=e[t[s]],r=e[t[s+2]],o=t[s+1];o>=0?i[n[o]]=r:i[~o]=r}}(t[7],l,t[2]),function(t){const e=t[5],n=t[2],i=t[1],s=t[8],r=t[9],o=t[10];for(let t=0;t<s.length;++t){const a=s[t];"number"==typeof a&&(s[t]=e[a]);let c=r[t];"number"==typeof c&&(c=c>=0?n[c]:~c,r[t]=c);const l=o[t];"number"==typeof l&&(o[t]=i[l])}}(t);for(let t=0;t<l.length;++t){var o,a;null===(o=l[t])||void 0===o||null===(a=o.onAfterDeserialize_JSB)||void 0===a||a.call(o)}r=l[h]}return s&&tu.pool.put(e),r}au[0]=function(t,e,n,i){e[n]=i},au[1]=iu,au[2]=su(iu),au[3]=su(ru),au[4]=ou,au[5]=function(t,e,n,i){Q_[i[0]](e[n],i)},au[6]=ru,au[7]=function(t,e,n,i){e[n].set(i)},au[8]=function(t,e,n,i){const s=new Z_[i[0]];Q_[i[0]](s,i),e[n]=s},au[9]=su(ou),au[10]=function(t,e,n,i){const s=t[3][i[0]];e[n]=nu(t,s,i[1])},au[11]=function(t,e,n,i){const s=i[0];e[n]=s;for(let e=1;e<i.length;e+=3){const n=i[e],r=i[e+1],o=i[e+2];(0,au[r])(t,s,n,o)}},au[12]=function(t,e,n,i){const s=i[0];e[n]=s;for(let e=0;e<s.length;++e){const n=s[e],r=i[e+1];0!==r&&(0,au[r])(t,s,e,n)}},uu.Details=tu,uu.reportMissingClass=t=>{x(5302,t)};class du{constructor(t){this.preprocessed=!0,this.version=t}}function pu(t,e,n){return[1,0,0,[t],0,n?[e,-1]:[e],[0],0,[],[],[]]}var mu,fu,gu;i.deserialize=uu;let vu=t("Script",Yl("cc.Script")(mu=class extends y_{})||mu);i._Script=vu;let yu=t("JavaScript",Yl("cc.JavaScript")(fu=class extends vu{})||fu);i._JavaScript=yu;let xu=t("TypeScript",Yl("cc.TypeScript")(gu=class extends vu{})||gu);var Su,Tu,Eu,Cu,Au,bu,wu,Ru,Iu,Pu,Ou;i._TypeScript=xu;const Du=new it("Comp"),Mu=n_.Flags.IsOnLoadCalled;let Nu=t("Component",(Su=Yl("cc.Component"),Tu=hh(),Eu=Ah(vu),Cu=_h(),Su((Ou=Pu=class extends n_{constructor(...t){super(...t),Ul(this,"node",wu,this),Ul(this,"_enabled",Ru,this),Ul(this,"__prefab",Iu,this),this._sceneGetter=null,this._id=Du.getNewId()}get name(){if(this._name)return this._name;let t=pt(this);const e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),`${this.node.name}<${t}>`}set name(t){this._name=t}get uuid(){return this._id}get __scriptAsset(){return null}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){const e=i.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}get enabledInHierarchy(){return this._enabled&&this.node&&this.node.activeInHierarchy}get _isOnLoadCalled(){return this._objFlags&Mu}_getRenderScene(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}addComponent(t){return this.node.addComponent(t)}getComponent(t){return this.node.getComponent(t)}getComponents(t){return this.node.getComponents(t)}getComponentInChildren(t){return this.node.getComponentInChildren(t)}getComponentsInChildren(t){return this.node.getComponentsInChildren(t)}destroy(){return!!super.destroy()&&(this._enabled&&this.node.activeInHierarchy&&i.director._compScheduler.disableComp(this),!0)}_onPreDestroy(){this.unscheduleAllCallbacks(),i.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}_instantiate(t){return t||(t=i.instantiate._clone(this,this)),t.node=null,t}schedule(t,e=0,n=i.macro.REPEAT_FOREVER,s=0){C(t,1619),C((e=e||0)>=0,1620),n=isNaN(n)?i.macro.REPEAT_FOREVER:n,s=s||0;const r=i.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(t,this,e,n,s,o)}scheduleOnce(t,e=0){this.schedule(t,0,0,e)}unschedule(t){t&&i.director.getScheduler().unschedule(t,this)}unscheduleAllCallbacks(){i.director.getScheduler().unscheduleAllForTarget(this)}},Pu.system=null,Gl((bu=Ou).prototype,"__scriptAsset",[Tu,Eu,Cu,xh],Object.getOwnPropertyDescriptor(bu.prototype,"__scriptAsset"),bu.prototype),wu=Gl(bu.prototype,"node",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ru=Gl(bu.prototype,"_enabled",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Iu=Gl(bu.prototype,"__prefab",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Au=bu))||Au));const Lu=Nu.prototype;var zu,Bu,Fu;Lu.update=null,Lu.lateUpdate=null,Lu.__preload=null,Lu.onLoad=null,Lu.start=null,Lu.onEnable=null,Lu.onDisable=null,Lu.onDestroy=null,Lu.onFocusInEditor=null,Lu.onLostFocusInEditor=null,Lu.resetInEditor=null,Lu._getLocalBounds=null,Lu.onRestore=null,Nu._requireComponent=null,Nu._executionOrder=0,lt(Nu,"_registerEditorProps",(t,e)=>{const n=e.requireComponent;n&&(t._requireComponent=n);const i=e.executionOrder;i&&"number"==typeof i&&(t._executionOrder=i)}),i.Component=Nu;let Uu=t("MissingScript",Yl("cc.MissingScript")(zu=rh()((Fu=Gl((Bu=class extends Nu{static safeFindClass(t){const e=Bt(t);if(e)return e;i.deserialize.reportMissingClass(t)}constructor(){super(),Ul(this,"_$erialized",Fu,this)}onLoad(){x(4600,this.node.name)}}).prototype,"_$erialized",[Ql,th],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zu=Bu))||zu)||zu);function Gu(t,e){let n;n=Uu.safeFindClass;const i=tu.pool.get();let s;try{s=uu(t,i,{classFinder:n,customEnv:e})}catch(t){throw u(t),tu.pool.put(i),t}s._uuid=e.__uuid__||"";const r=i.uuidList,o=i.uuidObjList,a=i.uuidPropList,c=[];for(let t=0;t<r.length;t++){const e=r[t];c[t]={uuid:jh(e),owner:o[t],prop:a[t]}}return s.__depends__=c,s._native&&(s.__nativeDepend__=!0),tu.pool.put(i),s}i._MissingScript=Uu;var Hu,Vu=new class{constructor(){this._depends=new wh}init(){this._depends.clear()}getNativeDep(t){const e=this._depends.get(t);return e&&e.nativeDep?{...e.nativeDep}:null}getDeps(t){return this._depends.has(t)?this._depends.get(t).deps:[]}getDepsRecursively(t){const e=Object.create(null),n=[];return this._descend(t,e,n),n}remove(t){this._depends.remove(t)}parse(t,e){let n=null;if(Array.isArray(e)||e.__type__){if(this._depends.has(t))return this._depends.get(t);if(Array.isArray(e)&&!function(t){const e=t[5],n=e[e.length-1];return"number"==typeof n&&n<0}(e))n={deps:this._parseDepsFromJson(e)};else try{const i=Gu(e,{__uuid__:t});n=this._parseDepsFromAsset(i),n.nativeDep&&(n.nativeDep.uuid=t),Oh.add(t+"@import",i)}catch(e){Ph.remove(t+"@import"),n={deps:[]}}}else{if(this._depends.has(t)&&(n=this._depends.get(t),n.parsedFromExistAsset))return n;n=this._parseDepsFromAsset(e)}return this._depends.add(t,n),n}_parseDepsFromAsset(t){const e={deps:[],parsedFromExistAsset:!0,preventPreloadNativeObject:t.constructor.preventPreloadNativeObject,preventDeferredLoadDependents:t.constructor.preventDeferredLoadDependents},n=t.__depends__;for(let t=0,i=n.length;t<i;t++)e.deps.push(n[t].uuid);return t.__nativeDepend__&&(e.nativeDep=t._nativeDep),e}_parseDepsFromJson(t){let e=null;return e=function(t){const e=t[1];return t[10].map(t=>e[t])}(t),e.forEach((t,n)=>e[n]=jh(t)),e}_descend(t,e,n){const i=this.getDeps(t);for(let t=0;t<i.length;t++){const s=i[t];e[s]||(e[s]=!0,n.push(s),this._descend(s,e,n))}}};const ku=[new Wr];function ju(t){return t&&0==(t&t-1)}let Wu=Yl("cc.SimpleTexture")(Hu=class extends $_{constructor(...t){super(...t),this._gfxTexture=null,this._mipmapLevel=1,this._textureWidth=0,this._textureHeight=0}get mipmapLevel(){return this._mipmapLevel}getGFXTexture(){return this._gfxTexture}destroy(){return this._tryDestroyTexture(),super.destroy()}updateImage(){this.updateMipmaps(0)}updateMipmaps(t=0,e){}uploadData(t,e=0,n=0){if(!this._gfxTexture||this._mipmapLevel<=e)return;const i=this._getGFXDevice();if(!i)return;const s=ku[0];s.texExtent.width=this._textureWidth>>e,s.texExtent.height=this._textureHeight>>e,s.texSubres.mipLevel=e,s.texSubres.baseArrayLayer=n,ArrayBuffer.isView(t)?i.copyBuffersToTexture([t],this._gfxTexture,ku):i.copyTexImagesToTexture([t],this._gfxTexture,ku)}_assignImage(t,e,n){const s=()=>{const i=t.data;if(i&&(this.uploadData(i,e,n),this._checkTextureLoaded(),Kt.CLEANUP_IMAGE_CACHE)){const e=Vu.getDeps(this._uuid),n=e.indexOf(t._uuid);-1!==n&&(Q(e,n),t.decRef())}};if(t.loaded)s();else{if(t.once("load",()=>{s()}),!this.isCompressed){const t=i.builtinResMgr.get("black-texture").image;this.uploadData(t.data,e,n)}i.assetManager.postLoadNative(t)}}_checkTextureLoaded(){this._textureReady()}_textureReady(){this.loaded=!0,this.emit("load")}_setMipmapLevel(t){this._mipmapLevel=t<1?1:t}_getGfxTextureCreateInfo(t){return null}_tryReset(){if(this._tryDestroyTexture(),0===this._mipmapLevel)return;const t=this._getGFXDevice();t&&this._createTexture(t)}_createTexture(t){if(0===this._width||0===this._height)return;let e=dr.NONE;this._mipFilter!==T_.NONE&&function(t,e,n){return!(t.gfxAPI===br.WEBGL)||ju(e)&&ju(n)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){let n=Math.max(t,e),i=0;for(;n;)n>>=1,i++;return i}(this._width,this._height),e=dr.GEN_MIPMAP);const n=this._getGfxTextureCreateInfo({usage:_r.SAMPLED|_r.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e|dr.IMMUTABLE});if(!n)return;const i=t.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}_tryDestroyTexture(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}})||Hu;var qu,Xu,Yu,Ku,$u;i.SimpleTexture=Wu;let Zu=t("Texture2D",(qu=Yl("cc.Texture2D"),Xu=Ah([P_]),qu(($u=Gl((Ku=class extends Wu{constructor(...t){super(...t),Ul(this,"_mipmaps",$u,this)}get mipmaps(){return this._mipmaps}set mipmaps(t){if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const t=this._mipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((t,e)=>{this._assignImage(t,e)})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}initialize(){this.mipmaps=this._mipmaps}onLoaded(){this.initialize()}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()}create(t,e,n=x_.RGBA8888,i=1){this.reset({width:t,height:e,format:n,mipmapLevel:i})}toString(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}updateMipmaps(t=0,e){if(t>=this._mipmaps.length)return;const n=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t);for(let e=0;e<n;++e){const n=t+e;this._assignImage(this._mipmaps[n],n)}}getHtmlElementObj(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}destroy(){return this._mipmaps=[],super.destroy()}description(){return`<cc.Texture2D | Name = ${this._mipmaps[0]?this._mipmaps[0].url:""} | Dimension = ${this.width} x ${this.height}>`}releaseTexture(){this.destroy()}_serialize(t){}_deserialize(t,e){const n=t;super._deserialize(n.base,e),this._mipmaps=new Array(n.mipmaps.length);for(let t=0;t<n.mipmaps.length;++t){if(this._mipmaps[t]=new P_,!n.mipmaps[t])continue;const i=n.mipmaps[t];e.result.push(this._mipmaps,""+t,i),this._mipmaps[t]._texture=this}}_getGfxTextureCreateInfo(t){const e=new eo(hr.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t)}_checkTextureLoaded(){let t=!0;for(let e=0;e<this._mipmaps.length;++e)if(!this._mipmaps[e].loaded){t=!1;break}t&&super._textureReady()}}).prototype,"_mipmaps",[Xu],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yu=Ku))||Yu));var Ju,Qu,td,ed,nd,id;i.Texture2D=Zu,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(id||(id={}));let sd=t("TextureCube",Yl("cc.TextureCube")((nd=ed=class t extends Wu{constructor(...t){super(...t),Ul(this,"_mipmaps",td,this)}get mipmaps(){return this._mipmaps}set mipmaps(t){if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const t=this._mipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((t,e)=>{rd(t,(t,n)=>{this._assignImage(t,e,n)})})}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}static fromTexture2DArray(e,n){const i=[],s=e.length/6;for(let t=0;t<s;t++){const n=6*t;i.push({front:e[n+id.front].image,back:e[n+id.back].image,left:e[n+id.left].image,right:e[n+id.right].image,top:e[n+id.top].image,bottom:e[n+id.bottom].image})}return(n=n||new t).mipmaps=i,n}onLoaded(){this.mipmaps=this._mipmaps,this.loaded=!0,this.emit("load")}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()}updateMipmaps(t=0,e){if(t>=this._mipmaps.length)return;const n=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t);for(let e=0;e<n;++e){const n=t+e;rd(this._mipmaps[n],(t,e)=>{this._assignImage(t,n,e)})}}destroy(){return this._mipmaps=[],super.destroy()}releaseTexture(){this.mipmaps=[]}_serialize(t){}_deserialize(t,e){const n=t;super._deserialize(n.base,e),this._mipmaps=new Array(n.mipmaps.length);for(let t=0;t<n.mipmaps.length;++t){this._mipmaps[t]={front:new P_,back:new P_,left:new P_,right:new P_,top:new P_,bottom:new P_};const i=n.mipmaps[t];e.result.push(this._mipmaps[t],"front",i.front),e.result.push(this._mipmaps[t],"back",i.back),e.result.push(this._mipmaps[t],"left",i.left),e.result.push(this._mipmaps[t],"right",i.right),e.result.push(this._mipmaps[t],"top",i.top),e.result.push(this._mipmaps[t],"bottom",i.bottom)}}_getGfxTextureCreateInfo(t){const e=new eo(hr.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e.flags|=dr.CUBEMAP,e}},ed.FaceIndex=id,td=Gl((Qu=nd).prototype,"_mipmaps",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ju=Qu))||Ju);function rd(t,e){e(t.front,id.front),e(t.back,id.back),e(t.left,id.left),e(t.right,id.right),e(t.top,id.top),e(t.bottom,id.bottom)}i.TextureCube=sd;var od=t("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2143664850,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:1062464958,builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0}]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:3946667351,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:3696836305,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:4115155772,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:66662317,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:4078504952,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[{name:"cc_spriteTexture",defines:[]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color2",type:16,count:1,defines:["TWO_COLORED"],stageFlags:1,format:44,location:3}]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:3990469549,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplers:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs:vert|standard-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs:vert|standard-fs:frag",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs:vert|standard-fs:frag",hash:2668109714,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3020491,builtins:{globals:{blocks:[{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplers:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs:vert|terrain-fs:frag",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal-texture",type:28},normalMap1:{value:"normal-texture",type:28},normalMap2:{value:"normal-texture",type:28},normalMap3:{value:"normal-texture",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs:vert|terrain-fs:frag",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal-texture",type:28},normalMap1:{value:"normal-texture",type:28},normalMap2:{value:"normal-texture",type:28},normalMap3:{value:"normal-texture",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs:vert|terrain-fs:frag",hash:2952542850,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplers:[{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplers:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplers:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3874167763,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplers:[]}},defines:[],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3822871803,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:2901856202,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplers:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplers:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_SUPPORT_FLOAT_TEXTURE",type:"boolean"},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:12,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:42,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12}]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:2319917655,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplers:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplers:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:2029303284,builtins:{globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"splash-screen",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:2106901053,builtins:{globals:{blocks:[],samplers:[]},locals:{blocks:[],samplers:[]}},defines:[],blocks:[{name:"splashFrag",defines:[],binding:0,stageFlags:16,members:[{name:"u_precent",type:13,count:1}]}],samplers:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]);let ad;!function(t){t[t.UBO=0]="UBO",t[t.SAMPLER=1]="SAMPLER"}(ad||(ad={}));const cd=(t,e,n,i,s=0)=>t<<28&4026531840|i<<22&264241152|e<<20&3145728|n<<14&1032192|16383&s,ld=t=>(4026531840&t)>>>28,hd=t=>(264241152&t)>>>22,_d=t=>(1032192&t)>>>14,ud=t=>16383&t,dd=(t,e)=>-264241153&t|e<<22&264241152,pd={[qs.UNKNOWN]:()=>console.warn("illegal uniform handle"),[qs.INT]:(t,e,n=0)=>t[n],[qs.INT2]:(t,e,n=0)=>rn.fromArray(e,t,n),[qs.INT3]:(t,e,n=0)=>ln.fromArray(e,t,n),[qs.INT4]:(t,e,n=0)=>dn.fromArray(e,t,n),[qs.FLOAT]:(t,e,n=0)=>t[n],[qs.FLOAT2]:(t,e,n=0)=>rn.fromArray(e,t,n),[qs.FLOAT3]:(t,e,n=0)=>ln.fromArray(e,t,n),[qs.FLOAT4]:(t,e,n=0)=>dn.fromArray(e,t,n),[qs.MAT3]:(t,e,n=0)=>mn.fromArray(e,t,n),[qs.MAT4]:(t,e,n=0)=>bn.fromArray(e,t,n)},md={[qs.UNKNOWN]:()=>console.warn("illegal uniform handle"),[qs.INT]:(t,e,n=0)=>t[n]=e,[qs.INT2]:(t,e,n=0)=>rn.toArray(t,e,n),[qs.INT3]:(t,e,n=0)=>ln.toArray(t,e,n),[qs.INT4]:(t,e,n=0)=>dn.toArray(t,e,n),[qs.FLOAT]:(t,e,n=0)=>t[n]=e,[qs.FLOAT2]:(t,e,n=0)=>rn.toArray(t,e,n),[qs.FLOAT3]:(t,e,n=0)=>ln.toArray(t,e,n),[qs.FLOAT4]:(t,e,n=0)=>dn.toArray(t,e,n),[qs.MAT3]:(t,e,n=0)=>mn.toArray(t,e,n),[qs.MAT4]:(t,e,n=0)=>bn.toArray(t,e,n)},fd=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function gd(t){switch(t){case qs.BOOL:case qs.INT:case qs.UINT:case qs.FLOAT:return fd[0];case qs.BOOL2:case qs.INT2:case qs.UINT2:case qs.FLOAT2:return fd[1];case qs.BOOL4:case qs.INT4:case qs.UINT4:case qs.FLOAT4:return fd[2];case qs.MAT4:return fd[3];case qs.SAMPLER2D:return"default-texture";case qs.SAMPLER_CUBE:return"default-cube-texture"}return fd[0]}function vd(t,e){const n=Object.entries(e);let i=!1;for(let e=0;e<n.length;e++)t[n[e][0]]!==n[e][1]&&(t[n[e][0]]=n[e][1],i=!0);return i}const yd=new Po;function xd(t){return Math.ceil(Math.log2(Math.max(t,2)))}function Sd(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn(`unknown define type '${t.type}'`),"-1"}}function Td(t,e,n,i,s){const r=t.builtins[i],o=[];for(let t=0;t<r.blocks.length;t++){const e=r.blocks[t],i=n.layouts[e.name],a=i&&n.bindings.find(t=>t.binding===i.binding);i&&a&&a.descriptorType&Ao?(o.push(i),s&&!s.includes(a)&&s.push(a)):console.warn(`builtin UBO '${e.name}' not available!`)}Array.prototype.unshift.apply(e.gfxBlocks,o);const a=[];for(let t=0;t<r.samplers.length;t++){const e=r.samplers[t],i=n.layouts[e.name],o=i&&n.bindings.find(t=>t.binding===i.binding);i&&o&&o.descriptorType&bo?(a.push(i),s&&!s.includes(o)&&s.push(o)):console.warn(`builtin sampler '${e.name}' not available!`)}Array.prototype.unshift.apply(e.gfxSamplers,a),s&&s.sort((t,e)=>t.binding-e.binding)}function Ed(t){return t.members.reduce((t,e)=>t+zr(e.type)*e.count,0)}function Cd(t,e){for(let n=0;n<t.length;n++){const i=t[n];if("!"===i[0]){if(e[i.slice(1)])return!1}else if(!e[i])return!1}return!0}function Ad(t){switch(t.gfxAPI){case br.GLES2:case br.WEBGL:return"glsl1";case br.GLES3:case br.WEBGL2:return"glsl3";default:return"glsl4"}}const bd=new class{constructor(){this._templates={},this._cache={},this._templateInfos={}}register(t){for(let e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name}define(t){const e=this._templates[t.name];if(e&&e.hash===t.hash)return e;const n={...t};let i=0;for(let t=0;t<n.defines.length;t++){const e=n.defines[t];let s=1;if("number"===e.type){const t=e.range;s=xd(t[1]-t[0]+1),e._map=e=>e-t[0]}else"string"===e.type?(s=xd(e.options.length),e._map=t=>Math.max(0,e.options.findIndex(e=>e===t))):"boolean"===e.type&&(e._map=t=>t?1:0);e._offset=i,i+=s}if(i>31&&(n.uber=!0),this._templates[t.name]=n,!this._templateInfos[n.hash]){const t={};t.samplerStartBinding=n.blocks.length,t.gfxBlocks=[],t.gfxSamplers=[],t.bindings=[],t.blockSizes=[];for(let e=0;e<n.blocks.length;e++){const i=n.blocks[e];t.blockSizes.push(Ed(i)),t.bindings.push(new Io(i.binding,i.descriptorType||mr.UNIFORM_BUFFER,1,i.stageFlags)),t.gfxBlocks.push(new oo(Pc.MATERIAL,i.binding,i.name,i.members.map(t=>new ro(t.name,t.type,t.count)),1))}for(let e=0;e<n.samplers.length;e++){const i=n.samplers[e];t.bindings.push(new Io(i.binding,i.descriptorType||mr.SAMPLER,i.count,i.stageFlags)),t.gfxSamplers.push(new ao(Pc.MATERIAL,i.binding,i.name,i.type,i.count))}t.gfxAttributes=[];for(let e=0;e<n.attributes.length;e++){const i=n.attributes[e];t.gfxAttributes.push(new Yo(i.name,i.format,i.isNormalized,0,i.isInstanced,i.location))}Td(n,t,Ec,"locals"),t.gfxStages=[],t.gfxStages.push(new so(pr.VERTEX,"")),t.gfxStages.push(new so(pr.FRAGMENT,"")),t.handleMap=function(t){const e={};for(let n=0;n<t.blocks.length;n++){const i=t.blocks[n],s=i.members;let r=0;for(let t=0;t<s.length;t++){const n=s[t];e[n.name]=cd(ad.UBO,Pc.MATERIAL,i.binding,n.type,r),r+=(zr(n.type)>>2)*n.count}}for(let n=0;n<t.samplers.length;n++){const i=t.samplers[n];e[i.name]=cd(ad.SAMPLER,Pc.MATERIAL,i.binding,i.type)}return e}(n),t.hPipelineLayout=0,t.setLayouts=[],this._templateInfos[n.hash]=t}return n}getTemplate(t){return this._templates[t]}getTemplateInfo(t){const e=this._templates[t].hash;return this._templateInfos[e]}getDescriptorSetLayout(t,e,n=!1){const i=this._templates[e],s=this._templateInfos[i.hash];return s.setLayouts.length||(yd.bindings=s.bindings,s.setLayouts[Pc.MATERIAL]=t.createDescriptorSetLayout(yd),yd.bindings=Ec.bindings,s.setLayouts[Pc.LOCAL]=t.createDescriptorSetLayout(yd)),s.setLayouts[n?Pc.LOCAL:Pc.MATERIAL]}hasProgram(t){return void 0!==this._templates[t]}getKey(t,e){const n=this._templates[t],i=n.defines;if(n.uber){let t="";for(let n=0;n<i.length;n++){const s=i[n],r=e[s.name];if(!r||!s._map)continue;const o=s._map(r);t+=`${s._offset}${o}|`}return`${t}${n.hash}`}let s=0;for(let t=0;t<i.length;t++){const n=i[t],r=e[n.name];r&&n._map&&(s|=n._map(r)<<n._offset)}return`${s.toString(16)}|${n.hash}`}destroyShaderByDefines(t){const e=Object.keys(t);if(!e.length)return;const n=e.map(e=>{let n=t[e];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(`${e}${n}`)}),i=Object.keys(this._cache).filter(t=>n.every(e=>e.test(Yn.get(this._cache[t]).name)));for(let t=0;t<i.length;t++){const e=i[t],n=Yn.get(this._cache[e]);console.log("destroyed shader "+n.name),n.destroy(),delete this._cache[e]}}getGFXShader(t,e,n,i,s){Object.assign(n,i.macros),s||(s=this.getKey(e,n));const r=this._cache[s];if(r)return r;const o=this._templates[e],a=this._templateInfos[o.hash];a.hPipelineLayout||(this.getDescriptorSetLayout(t,e),Td(o,a,Tc,"globals"),a.setLayouts[Pc.GLOBAL]=i.descriptorSetLayout,a.hPipelineLayout=Zn.alloc(t,new Bo(a.setLayouts)));const c=function(t,e){const n=[];for(let i=0;i<e.length;i++){const s=e[i],r=s.name,o=t[r],a=Sd(s,o),c=!o||"0"===o;n.push({name:r,value:a,isDefault:c})}return n}(n,o.defines),l=c.reduce((t,e)=>`${t}#define ${e.name} ${e.value}\n`,"")+"\n";let h=o.glsl3;const _=Ad(t);_?h=o[_]:console.error("Invalid GFX API!"),a.gfxStages[0].source=l+h.vert,a.gfxStages[1].source=l+h.frag;const u=function(t,e,n){const i=[],s=t.attributes,r=e.gfxAttributes;for(let t=0;t<s.length;t++)Cd(s[t].defines,n)&&i.push(r[t]);return i}(o,a,n),d=function(t,e){return t+e.reduce((t,e)=>e.isDefault?t:`${t}|${e.name}${e.value}`,"")}(e,c),p=new co(d,a.gfxStages,u,a.gfxBlocks,a.gfxSamplers);return this._cache[s]=Yn.alloc(t,p)}};i.programLib=bd;const wd={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\n  vec4 o = vec4(1.0);\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    #ifdef GL_OES_standard_derivatives\n      float aa = fwidth(v_dist);\n    #else\n      float aa = 0.05;\n    #endif\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord;\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture2D(tex, coord);\n    vec4 b = texture2D(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  uniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  uniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  uniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  uniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  uniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  uniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture2D(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  varying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  varying vec2 uv;\n  varying vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    varying vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  uniform vec4 tintColor;\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\n  attribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  attribute vec3 a_texCoord3;\n  attribute vec3 a_normal;\n  attribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n  return CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\n  attribute vec4 a_color2;\n  varying vec4 v_dark;\n#endif\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  pos = cc_matViewProj * pos;\n  uv0 = a_texCoord;\n  v_light = a_color;\n  #if TWO_COLORED\n    v_dark = a_color2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\n  uniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n  #if USE_ALPHA_TEST\n      if (color.a < alphaThreshold) discard;\n  #endif\n}\nvoid ALPHA_TEST (in float alpha) {\n  #if USE_ALPHA_TEST\n      if (alpha < alphaThreshold) discard;\n  #endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\n  varying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if TWO_COLORED\n    vec4 texColor = vec4(1, 1, 1, 1);\n    texColor *= texture2D(cc_spriteTexture, uv0);\n     o.a = texColor.a * v_light.a;\n    o.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n  #else\n    o *= texture2D(cc_spriteTexture, uv0);\n    o *= v_light;\n  #endif\n  ALPHA_TEST(o);\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\n  uniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n  #if USE_ALPHA_TEST\n      if (color.a < alphaThreshold) discard;\n  #endif\n}\nvoid ALPHA_TEST (in float alpha) {\n  #if USE_ALPHA_TEST\n      if (alpha < alphaThreshold) discard;\n  #endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\n  varying vec2 uv0;\n  uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  ALPHA_TEST(o);\n  return o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  attribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 0\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 1\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 2\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 3\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if USE_VERTEX_COLOR\n  attribute vec4 a_color;\n  varying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying float v_fog_factor;\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  attribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  varying vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(pos);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform lowp vec4 cc_shadowColor;\nuniform lowp vec4 cc_shadowInfo;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return texture2DLodEXT(tex, coord, lod);\n    #else\n      return texture2D(tex, coord, lod);\n    #endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return textureCubeLodEXT(tex, coord, lod);\n    #else\n      return textureCube(tex, coord, lod);\n    #endif\n}\n#endif\n#if CC_RECEIVE_SHADOW\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n  uniform sampler2D cc_shadowMap;\n  uniform sampler2D cc_spotLightingMap;\n  float CCGetShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow / 5.0;\n  }\n  float CCGetShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n  float CCGetDirLightShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetDirLightShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    return shadow / 5.0;\n  }\n  float CCGetDirLightShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetDirLightShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n#endif\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  vec4 lightmap;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nuniform highp vec4 cc_lightPos[1];\nuniform vec4 cc_lightColor[1];\nuniform vec4 cc_lightSizeRangeAngle[1];\nuniform vec4 cc_lightDir[1];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      vec3 lightColor = cc_lightColor[i].rgb;\n    #if CC_RECEIVE_SHADOW\n      if (cc_lightPos[i].w > 0.0) {\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5();\n      else shadowAttenuation = CCGetDirLightShadowFactorX1();\n      lightColor *= 1.0 - shadowAttenuation;\n    }\n      }\n    #endif\n      finalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      finalColor = s.lightmap.a * s.lightmap.rgb + (1.0 - s.lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5();\n      else shadowAttenuation = CCGetShadowFactorX1();\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\n      finalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n    }\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  varying vec2 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\nvarying float v_fog_factor;\n#if USE_VERTEX_COLOR\n  varying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  varying vec3 v_tangent;\n  varying vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture2D(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    s.lightmap = texture2D(cc_lightingMap, v_luv);\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture2D(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture2D(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  attribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  attribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying float v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture2D(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 0\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 1\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 2\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 3\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\n  varying mediump vec3 v_tangent;\n  varying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec2 luv;\nvarying mediump vec3 diffuse;\nvarying mediump float v_fog_factor;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvec4 vert () {\n  vec3 worldPos;\n  worldPos.x = cc_matWorld[3][0] + a_position.x;\n  worldPos.y = cc_matWorld[3][1] + a_position.y;\n  worldPos.z = cc_matWorld[3][2] + a_position.z;\n  vec4 pos = vec4(worldPos, 1.0);\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  #if USE_LIGHTMAP\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n  #endif\n  v_position = worldPos;\n  v_normal = a_normal;\n  v_fog_factor = CC_TRANSFER_FOG(vec4(worldPos, 1.0));\n  #if USE_NORMALMAP\n    v_tangent = vec3(1.0, 0.0, 0.0);\n    v_binormal = vec3(0.0, 0.0, 1.0);\n    v_binormal = cross(v_tangent, a_normal);\n    v_tangent = cross(a_normal, v_binormal);\n  #endif\n    v_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform lowp vec4 cc_shadowColor;\nuniform lowp vec4 cc_shadowInfo;\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return texture2DLodEXT(tex, coord, lod);\n    #else\n      return texture2D(tex, coord, lod);\n    #endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    #ifdef GL_EXT_shader_texture_lod\n      return textureCubeLodEXT(tex, coord, lod);\n    #else\n      return textureCube(tex, coord, lod);\n    #endif\n}\n#endif\n#if CC_RECEIVE_SHADOW\nvarying highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n  uniform sampler2D cc_shadowMap;\n  uniform sampler2D cc_spotLightingMap;\n  float CCGetShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow / 5.0;\n  }\n  float CCGetShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture2D(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n  float CCGetDirLightShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetDirLightShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    return shadow / 5.0;\n  }\n  float CCGetDirLightShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetDirLightShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n#endif\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  vec4 lightmap;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nuniform highp vec4 cc_lightPos[1];\nuniform vec4 cc_lightColor[1];\nuniform vec4 cc_lightSizeRangeAngle[1];\nuniform vec4 cc_lightDir[1];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      vec3 lightColor = cc_lightColor[i].rgb;\n    #if CC_RECEIVE_SHADOW\n      if (cc_lightPos[i].w > 0.0) {\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5();\n      else shadowAttenuation = CCGetDirLightShadowFactorX1();\n      lightColor *= 1.0 - shadowAttenuation;\n    }\n      }\n    #endif\n      finalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      finalColor = s.lightmap.a * s.lightmap.rgb + (1.0 - s.lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5();\n      else shadowAttenuation = CCGetShadowFactorX1();\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\n      finalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n    }\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\n  varying mediump vec3 v_tangent;\n  varying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec2 luv;\nvarying mediump float v_fog_factor;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n  #if LAYERS > 1\n    vec4 w = texture2D(weightMap, uvw);\n  #endif\n  vec4 baseColor = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    baseColor = texture2D(detailMap0, uv0);\n  #elif LAYERS == 2\n    baseColor += texture2D(detailMap0, uv0) * w.r;\n    baseColor += texture2D(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    baseColor += texture2D(detailMap0, uv0) * w.r;\n    baseColor += texture2D(detailMap1, uv1) * w.g;\n    baseColor += texture2D(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    baseColor += texture2D(detailMap0, uv0) * w.r;\n    baseColor += texture2D(detailMap1, uv1) * w.g;\n    baseColor += texture2D(detailMap2, uv2) * w.b;\n    baseColor += texture2D(detailMap3, uv3) * w.a;\n  #else\n    baseColor = texture2D(detailMap0, uv0);\n  #endif\n  s.position = v_position;\n  #if USE_NORMALMAP\n    vec4 baseNormal = vec4(0, 0, 0, 0);\n    #if LAYERS == 1\n      baseNormal = texture2D(normalMap0, uv0);\n    #elif LAYERS == 2\n      baseNormal += texture2D(normalMap0, uv0) * w.r;\n      baseNormal += texture2D(normalMap1, uv1) * w.g;\n    #elif LAYERS == 3\n      baseNormal += texture2D(normalMap0, uv0) * w.r;\n      baseNormal += texture2D(normalMap1, uv1) * w.g;\n      baseNormal += texture2D(normalMap2, uv2) * w.b;\n    #elif LAYERS == 4\n      baseNormal += texture2D(normalMap0, uv0) * w.r;\n      baseNormal += texture2D(normalMap1, uv1) * w.g;\n      baseNormal += texture2D(normalMap2, uv2) * w.b;\n      baseNormal += texture2D(normalMap3, uv3) * w.a;\n    #else\n      baseNormal = texture2D(normalMap0, uv0);\n    #endif\n    vec3 nmmp = baseNormal.xyz - vec3(0.5);\n    s.normal =\n      nmmp.x * normalize(v_tangent) +\n      nmmp.y * normalize(v_binormal) +\n      nmmp.z * normalize(v_normal);\n  #else\n    s.normal = v_normal;\n  #endif\n  s.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\n  s.occlusion = 1.0;\n  #if USE_PBR\n    s.roughness = 0.0;\n    #if LAYERS == 1\n      s.roughness = roughness.x;\n    #elif LAYERS == 2\n      s.roughness += roughness.x * w.r;\n      s.roughness += roughness.y * w.g;\n    #elif LAYERS == 3\n      s.roughness += roughness.x * w.r;\n      s.roughness += roughness.y * w.g;\n      s.roughness += roughness.z * w.b;\n    #elif LAYERS == 4\n      s.roughness += roughness.x * w.r;\n      s.roughness += roughness.y * w.g;\n      s.roughness += roughness.z * w.b;\n      s.roughness += roughness.w * w.a;\n    #else\n      s.roughness = 1.0;\n    #endif\n    s.metallic = 0.0;\n    #if LAYERS == 1\n      s.metallic = metallic.x;\n    #elif LAYERS == 2\n      s.metallic += metallic.x * w.r;\n      s.metallic += metallic.y * w.g;\n    #elif LAYERS == 3\n      s.metallic += metallic.x * w.r;\n      s.metallic += metallic.y * w.g;\n      s.metallic += metallic.z * w.b;\n    #elif LAYERS == 4\n      s.metallic += metallic.x * w.r;\n      s.metallic += metallic.y * w.g;\n      s.metallic += metallic.z * w.b;\n      s.metallic += metallic.w * w.a;\n    #else\n      s.metallic = 0.0;\n    #endif\n  #else\n    s.roughness = 1.0;\n    s.metallic = 0.0;\n  #endif\n  s.emissive = vec3(0.0, 0.0, 0.0);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    s.lightmap = texture2D(lightMap, luv);\n  #else\n    s.lightmap = vec4(0.0, 0.0, 0.0, 0.0);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nvoid main() { gl_FragColor = frag(); }"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\n  vec4 worldPos;\n  worldPos.x = cc_matWorld[3][0] + a_position.x;\n  worldPos.y = cc_matWorld[3][1] + a_position.y;\n  worldPos.z = cc_matWorld[3][2] + a_position.z;\n  worldPos.w = 1.0;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  attribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 0\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 1\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 2\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 3\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  attribute lowp vec4 a_color;\n  varying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform vec4 tilingOffset;\n#endif\nvarying float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  varying vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\n  varying lowp vec4 v_color;\n#endif\nvarying float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture2D(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\n    attribute float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n            int pixelIndex = elementIndex;\n            vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n            vec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\n            return texture2D(tex, uv);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture2D(tex, x)),\n            decode32(texture2D(tex, y)),\n            decode32(texture2D(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  attribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    attribute highp vec4 a_jointAnimInfo;\n  #endif\n  uniform highp vec4 cc_jointTextureInfo;\n  uniform highp vec4 cc_jointAnimInfo;\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  uniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\n  attribute vec4 a_matWorld0;\n  attribute vec4 a_matWorld1;\n  attribute vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    attribute vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  attribute float a_dyn_batch_id;\n  uniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  mat4 matProj = cc_matProj;\n  if (matProj[3].w > 0.0) {\n    vec2 scale = vec2(48.0, 24.0);\n    matProj[0].xy *= scale;\n    matProj[1].xy *= scale;\n    matProj[2].zw = vec2(-1.0);\n    matProj[3].zw = vec2(0.0);\n  }\n  vec4 pos = matProj * matViewRotOnly * viewDir;\n  pos.z = 0.99999 * pos.w;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = cc_matViewProj * vec4(a_position, 1.0);\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nuniform float u_precent;\nvec4 frag () {\n  vec4 color = texture2D(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\n  vec4 o = vec4(1.0);\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    float aa = fwidth(v_dist);\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\n  vec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\n  vec4 u_worldRot;\n  vec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord;\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D color_over_time_tex0;\n  layout(std140) uniform ColorConstant {\n    int u_color_mode;\n  };\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D rotation_over_time_tex0;\n  layout(std140) uniform RotationConstant {\n    int u_rotation_mode;\n  };\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D size_over_time_tex0;\n  layout(std140) uniform SizeConstant {\n    int u_size_mode;\n  };\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D force_over_time_tex0;\n  layout(std140) uniform ForceConstant {\n    int u_force_mode;\n    int u_force_space;\n  };\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  uniform sampler2D velocity_over_time_tex0;\n  layout(std140) uniform VelocityConstant {\n    int u_velocity_mode;\n    int u_velocity_space;\n  };\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  uniform sampler2D texture_animation_tex0;\n  layout(std140) uniform AnimationConstant {\n    vec4 u_anim_info;\n  };\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  in vec2 uv;\n  in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    in vec3 vBarycentric;\n  #endif\n  uniform sampler2D mainTexture;\n  layout(std140) uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(std140) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\n  in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  in vec3 a_texCoord3;\n  in vec3 a_normal;\n  in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\n  in vec4 a_color2;\n  out vec4 v_dark;\n#endif\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  pos = cc_matViewProj * pos;\n  uv0 = a_texCoord;\n  v_light = a_color;\n  #if TWO_COLORED\n    v_dark = a_color2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\n  layout(std140) uniform ALPHA_TEST_DATA {\n    float alphaThreshold;\n  };\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n  #if USE_ALPHA_TEST\n      if (color.a < alphaThreshold) discard;\n  #endif\n}\nvoid ALPHA_TEST (in float alpha) {\n  #if USE_ALPHA_TEST\n      if (alpha < alphaThreshold) discard;\n  #endif\n}\nin vec4 v_light;\n#if TWO_COLORED\n  in vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if TWO_COLORED\n    vec4 texColor = vec4(1, 1, 1, 1);\n    texColor *= texture(cc_spriteTexture, uv0);\n     o.a = texColor.a * v_light.a;\n    o.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n  #else\n    o *= texture(cc_spriteTexture, uv0);\n    o *= v_light;\n  #endif\n  ALPHA_TEST(o);\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\n  layout(std140) uniform ALPHA_TEST_DATA {\n    float alphaThreshold;\n  };\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n  #if USE_ALPHA_TEST\n      if (color.a < alphaThreshold) discard;\n  #endif\n}\nvoid ALPHA_TEST (in float alpha) {\n  #if USE_ALPHA_TEST\n      if (alpha < alphaThreshold) discard;\n  #endif\n}\nin vec4 color;\n#if USE_TEXTURE\n  in vec2 uv0;\n  uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  ALPHA_TEST(o);\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  in vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 0\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 1\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 2\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 3\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\n#if USE_VERTEX_COLOR\n  in vec4 a_color;\n  out vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\nout float v_fog_factor;\n#if USE_NORMAL_MAP\n  out vec3 v_tangent;\n  out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  out vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(pos);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if CC_RECEIVE_SHADOW\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n  uniform sampler2D cc_shadowMap;\n  uniform sampler2D cc_spotLightingMap;\n  float CCGetShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow / 5.0;\n  }\n  float CCGetShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n  float CCGetDirLightShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetDirLightShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    return shadow / 5.0;\n  }\n  float CCGetDirLightShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetDirLightShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n#endif\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  vec4 lightmap;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(std140) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      vec3 lightColor = cc_lightColor[i].rgb;\n    #if CC_RECEIVE_SHADOW\n      if (cc_lightPos[i].w > 0.0) {\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5();\n      else shadowAttenuation = CCGetDirLightShadowFactorX1();\n      lightColor *= 1.0 - shadowAttenuation;\n    }\n      }\n    #endif\n      finalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      finalColor = s.lightmap.a * s.lightmap.rgb + (1.0 - s.lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5();\n      else shadowAttenuation = CCGetShadowFactorX1();\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\n      finalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n    }\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  in vec2 v_luv;\nuniform sampler2D cc_lightingMap;\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\nin float v_fog_factor;\n#if USE_VERTEX_COLOR\n  in vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  in vec3 v_tangent;\n  in vec3 v_bitangent;\n  uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    s.lightmap = texture(cc_lightingMap, v_luv);\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  in vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  in vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout float v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nin vec2 v_uv;\nin vec2 v_uv1;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\n  uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 0\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 1\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 2\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 3\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\n  out mediump vec3 v_tangent;\n  out mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec2 luv;\nout mediump vec3 diffuse;\nout mediump float v_fog_factor;\nlayout(std140) uniform TexCoords {\n  vec4 UVScale;\n  vec4 lightMapUVParam;\n};\nvec4 vert () {\n  vec3 worldPos;\n  worldPos.x = cc_matWorld[3][0] + a_position.x;\n  worldPos.y = cc_matWorld[3][1] + a_position.y;\n  worldPos.z = cc_matWorld[3][2] + a_position.z;\n  vec4 pos = vec4(worldPos, 1.0);\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  #if USE_LIGHTMAP\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n  #endif\n  v_position = worldPos;\n  v_normal = a_normal;\n  v_fog_factor = CC_TRANSFER_FOG(vec4(worldPos, 1.0));\n  #if USE_NORMALMAP\n    v_tangent = vec3(1.0, 0.0, 0.0);\n    v_binormal = vec3(0.0, 0.0, 1.0);\n    v_binormal = cross(v_tangent, a_normal);\n    v_tangent = cross(a_normal, v_binormal);\n  #endif\n    v_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if CC_RECEIVE_SHADOW\nin highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n  uniform sampler2D cc_shadowMap;\n  uniform sampler2D cc_spotLightingMap;\n  float CCGetShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow / 5.0;\n  }\n  float CCGetShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n  float CCGetDirLightShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetDirLightShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    return shadow / 5.0;\n  }\n  float CCGetDirLightShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetDirLightShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n#endif\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  vec4 lightmap;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(std140) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      vec3 lightColor = cc_lightColor[i].rgb;\n    #if CC_RECEIVE_SHADOW\n      if (cc_lightPos[i].w > 0.0) {\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5();\n      else shadowAttenuation = CCGetDirLightShadowFactorX1();\n      lightColor *= 1.0 - shadowAttenuation;\n    }\n      }\n    #endif\n      finalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      finalColor = s.lightmap.a * s.lightmap.rgb + (1.0 - s.lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5();\n      else shadowAttenuation = CCGetShadowFactorX1();\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\n      finalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n    }\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\n  in mediump vec3 v_tangent;\n  in mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec2 luv;\nin mediump float v_fog_factor;\nlayout(std140) uniform PbrParams {\n  vec4 metallic;\n  vec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n  #if LAYERS > 1\n    vec4 w = texture(weightMap, uvw);\n  #endif\n  vec4 baseColor = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    baseColor = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    baseColor += texture(detailMap0, uv0) * w.r;\n    baseColor += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    baseColor += texture(detailMap0, uv0) * w.r;\n    baseColor += texture(detailMap1, uv1) * w.g;\n    baseColor += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    baseColor += texture(detailMap0, uv0) * w.r;\n    baseColor += texture(detailMap1, uv1) * w.g;\n    baseColor += texture(detailMap2, uv2) * w.b;\n    baseColor += texture(detailMap3, uv3) * w.a;\n  #else\n    baseColor = texture(detailMap0, uv0);\n  #endif\n  s.position = v_position;\n  #if USE_NORMALMAP\n    vec4 baseNormal = vec4(0, 0, 0, 0);\n    #if LAYERS == 1\n      baseNormal = texture(normalMap0, uv0);\n    #elif LAYERS == 2\n      baseNormal += texture(normalMap0, uv0) * w.r;\n      baseNormal += texture(normalMap1, uv1) * w.g;\n    #elif LAYERS == 3\n      baseNormal += texture(normalMap0, uv0) * w.r;\n      baseNormal += texture(normalMap1, uv1) * w.g;\n      baseNormal += texture(normalMap2, uv2) * w.b;\n    #elif LAYERS == 4\n      baseNormal += texture(normalMap0, uv0) * w.r;\n      baseNormal += texture(normalMap1, uv1) * w.g;\n      baseNormal += texture(normalMap2, uv2) * w.b;\n      baseNormal += texture(normalMap3, uv3) * w.a;\n    #else\n      baseNormal = texture(normalMap0, uv0);\n    #endif\n    vec3 nmmp = baseNormal.xyz - vec3(0.5);\n    s.normal =\n      nmmp.x * normalize(v_tangent) +\n      nmmp.y * normalize(v_binormal) +\n      nmmp.z * normalize(v_normal);\n  #else\n    s.normal = v_normal;\n  #endif\n  s.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\n  s.occlusion = 1.0;\n  #if USE_PBR\n    s.roughness = 0.0;\n    #if LAYERS == 1\n      s.roughness = roughness.x;\n    #elif LAYERS == 2\n      s.roughness += roughness.x * w.r;\n      s.roughness += roughness.y * w.g;\n    #elif LAYERS == 3\n      s.roughness += roughness.x * w.r;\n      s.roughness += roughness.y * w.g;\n      s.roughness += roughness.z * w.b;\n    #elif LAYERS == 4\n      s.roughness += roughness.x * w.r;\n      s.roughness += roughness.y * w.g;\n      s.roughness += roughness.z * w.b;\n      s.roughness += roughness.w * w.a;\n    #else\n      s.roughness = 1.0;\n    #endif\n    s.metallic = 0.0;\n    #if LAYERS == 1\n      s.metallic = metallic.x;\n    #elif LAYERS == 2\n      s.metallic += metallic.x * w.r;\n      s.metallic += metallic.y * w.g;\n    #elif LAYERS == 3\n      s.metallic += metallic.x * w.r;\n      s.metallic += metallic.y * w.g;\n      s.metallic += metallic.z * w.b;\n    #elif LAYERS == 4\n      s.metallic += metallic.x * w.r;\n      s.metallic += metallic.y * w.g;\n      s.metallic += metallic.z * w.b;\n      s.metallic += metallic.w * w.a;\n    #else\n      s.metallic = 0.0;\n    #endif\n  #else\n    s.roughness = 1.0;\n    s.metallic = 0.0;\n  #endif\n  s.emissive = vec3(0.0, 0.0, 0.0);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    s.lightmap = texture(lightMap, luv);\n  #else\n    s.lightmap = vec4(0.0, 0.0, 0.0, 0.0);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\n  vec4 worldPos;\n  worldPos.x = cc_matWorld[3][0] + a_position.x;\n  worldPos.y = cc_matWorld[3][1] + a_position.y;\n  worldPos.z = cc_matWorld[3][2] + a_position.z;\n  worldPos.w = 1.0;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  in vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 0\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 1\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 2\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 3\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  in lowp vec4 a_color;\n  out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  out vec2 v_uv;\n  layout(std140) uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nout float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  in vec2 v_uv;\n  uniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  in lowp vec4 v_color;\n#endif\nin float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\n    in float a_vertexId;\n    int getVertexId() {\n        return int(a_vertexId);\n    }\nlayout(std140) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  in vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(std140) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(std140) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(std140) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  in vec4 a_matWorld0;\n  in vec4 a_matWorld1;\n  in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  in float a_dyn_batch_id;\n  layout(std140) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(std140) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  mat4 matProj = cc_matProj;\n  if (matProj[3].w > 0.0) {\n    vec2 scale = vec2(48.0, 24.0);\n    matProj[0].xy *= scale;\n    matProj[1].xy *= scale;\n    matProj[2].zw = vec2(-1.0);\n    matProj[3].zw = vec2(0.0);\n  }\n  vec4 pos = matProj * matViewRotOnly * viewDir;\n  pos.z = 0.99999 * pos.w;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\n  vec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\n  vec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = cc_matViewProj * vec4(a_position, 1.0);\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nlayout(std140) uniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]],glsl4:[[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n  , mat4 viewInv\n) {\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(set = 1, binding = 1) uniform builtin {\n  vec4 cc_size_rotation;\n};\nvec4 vs_main() {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matWorld * pos;\n  vec2 vertOffset = a_texCoord.xy - 0.5;\n  computeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.xy;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 3) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 2) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(location = 0) in vec3 a_position;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\n  vec4 o = vec4(1.0);\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 2) in float a_dist;\nlayout(location = 1) out float v_dist;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  pos = cc_matViewProj * cc_matWorld * pos;\n  v_color = a_color;\n  v_dist = a_dist;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_dist;\nvec4 frag () {\n  vec4 o = v_color;\n    float aa = fwidth(v_dist);\n  float alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\n  o.rgb *= o.a;\n  o *= alpha;\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(set = 1, binding = 1) uniform SampleConstants {\n  vec4 u_sampleInfo;\n};\nlayout(set = 1, binding = 2) uniform TickConstants {\n  vec4 u_worldRot;\n  vec4 u_timeDelta;\n};\nlayout(location = 0) in vec4 a_position_starttime;\nlayout(location = 1) in vec4 a_size_uv;\nlayout(location = 2) in vec4 a_rotation_uv;\nlayout(location = 3) in vec4 a_color;\nlayout(location = 4) in vec4 a_dir_life;\nlayout(location = 5) in float a_rndSeed;\n#if CC_RENDER_MODE == 4\n  layout(location = 6) in vec3 a_texCoord;\n  layout(location = 7) in vec3 a_texCoord3;\n  layout(location = 8) in vec3 a_normal;\n  layout(location = 9) in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    return mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\n    vec4 a = texture(tex, coord);\n    vec4 b = texture(tex, coord + u_sampleInfo.y);\n    float c = fract(coord.x * u_sampleInfo.x);\n    w = mix(a.w, b.w, c);\n    return mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\n  seed = mod(seed, 233280.);\n  float q = (seed * 9301. + 49297.) / 233280.;\n  return fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 10) uniform sampler2D color_over_time_tex0;\n  layout(set = 1, binding = 3) uniform ColorConstant {\n    int u_color_mode;\n  };\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 11) uniform sampler2D rotation_over_time_tex0;\n  layout(set = 1, binding = 4) uniform RotationConstant {\n    int u_rotation_mode;\n  };\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 12) uniform sampler2D size_over_time_tex0;\n  layout(set = 1, binding = 5) uniform SizeConstant {\n    int u_size_mode;\n  };\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 13) uniform sampler2D force_over_time_tex0;\n  layout(set = 1, binding = 6) uniform ForceConstant {\n    int u_force_mode;\n    int u_force_space;\n  };\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\n  layout(set = 1, binding = 14) uniform sampler2D velocity_over_time_tex0;\n  layout(set = 1, binding = 7) uniform VelocityConstant {\n    int u_velocity_mode;\n    int u_velocity_space;\n  };\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\n  layout(set = 1, binding = 15) uniform sampler2D texture_animation_tex0;\n  layout(set = 1, binding = 8) uniform AnimationConstant {\n    vec4 u_anim_info;\n  };\n#endif\nfloat repeat (float t, float length) {\n  return t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\n  vec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\n  vec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\n  return vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\n  float activeTime = u_timeDelta.x - a_position_starttime.w;\n  float normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\n  vec2 timeCoord0 = vec2(normalizedTime, 0.);\n  vec2 timeCoord1 = vec2(normalizedTime, 1.);\n  #if CC_RENDER_MODE == 4\n    vec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n  #else\n    vec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n  #endif\n  vec4 velocity = vec4(a_dir_life.xyz, 0.);\n  vec4 pos = vec4(a_position_starttime.xyz, 1.);\n  vec3 size = a_size_uv.xyz;\n  #if SIZE_OVER_TIME_MODULE_ENABLE\n    if (u_size_mode == 1) {\n      size *= unpackCurveData(size_over_time_tex0, timeCoord0);\n    } else {\n      vec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\n      vec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\n      float factor_s = pseudoRandom(a_rndSeed + 39825.);\n      size *= mix(size_0, size_1, factor_s);\n    }\n  #endif\n  vec3 compScale = scale.xyz * size;\n  #if FORCE_OVER_TIME_MODULE_ENABLE\n    vec3 forceAnim = vec3(0.);\n    if (u_force_mode == 1) {\n      forceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n    } else {\n      vec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\n      vec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\n      float factor_f =  pseudoRandom(a_rndSeed + 212165.);\n      forceAnim = mix(force_0, force_1, factor_f);\n    }\n    vec4 forceTrack = vec4(forceAnim, 0.);\n    if (u_force_space == 0) {\n      forceTrack = rotateQuat(forceTrack, u_worldRot);\n    }\n    velocity.xyz += forceTrack.xyz;\n  #endif\n  #if VELOCITY_OVER_TIME_MODULE_ENABLE\n    float speedModifier0 = 1.;\n    float speedModifier1 = 1.;\n    vec3 velocityAnim = vec3(0.);\n    if (u_velocity_mode == 1) {\n      velocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n    } else {\n      vec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n      vec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\n      float factor_v = pseudoRandom(a_rndSeed + 197866.);\n      velocityAnim = mix(vectory_0, vectory_1, factor_v);\n      speedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n    }\n    vec4 velocityTrack = vec4(velocityAnim, 0.);\n    if (u_velocity_space == 0) {\n      velocityTrack = rotateQuat(velocityTrack, u_worldRot);\n    }\n    velocity.xyz += velocityTrack.xyz;\n    velocity.xyz *= speedModifier0;\n  #endif\n  pos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = rotateQuat(velocity, u_worldRot);\n    #endif\n  #endif\n  vec3 rotation = a_rotation_uv.xyz;\n  #if ROTATION_OVER_TIME_MODULE_ENABLE\n    if (u_rotation_mode == 1) {\n      rotation += unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\n    } else {\n      vec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\n      vec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\n      float factor_r = pseudoRandom(a_rndSeed + 125292.);\n      rotation += mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n    }\n  #endif\n  #if COLOR_OVER_TIME_MODULE_ENABLE\n    if (u_color_mode == 1) {\n      color = a_color * texture(color_over_time_tex0, timeCoord0);\n    } else {\n      vec4 color_0 = texture(color_over_time_tex0, timeCoord0);\n      vec4 color_1 = texture(color_over_time_tex0, timeCoord1);\n      float factor_c = pseudoRandom(a_rndSeed + 91041.);\n      color = a_color * mix(color_0, color_1, factor_c);\n    }\n  #else\n    color = a_color;\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((vertIdx - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = rotation.xyz;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., rotation.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n      #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n        , cc_matViewInv\n      #endif\n      #if CC_RENDER_MODE == 1\n        , cc_cameraPos.xyz\n        , velocity\n        , frameTile_velLenScale.z\n        , frameTile_velLenScale.w\n        , a_size_uv.w\n      #endif\n    );\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(rotation), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(rotation), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color *= a_color1;\n  #endif\n  pos = cc_matViewProj * pos;\n  float frameIndex = 0.;\n  #if TEXTURE_ANIMATION_MODULE_ENABLE\n    float startFrame = 0.;\n    vec3 frameInfo = vec3(0.);\n    if (int(u_anim_info.x) == 1) {\n      frameInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n    } else {\n      vec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\n      vec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\n      float factor_t = pseudoRandom(a_rndSeed + 90794.);\n      frameInfo = mix(frameInfo0, frameInfo1, factor_t);\n    }\n    startFrame = frameInfo.x / u_anim_info.y;\n    frameIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n  #endif\n  uv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  return pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 16) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 9) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\n  layout(location = 2) out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\n  highp vec4 pos = vec4(a_position, 1);\n  vec4 velocity = vec4(a_texCoord1.xyz, 0);\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    velocity = cc_matWorld * velocity;\n  #endif\n  float vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\n  vec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\n  pos.xyz += camUp * vertOffset;\n  pos = cc_matViewProj * pos;\n  uv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\n  color = a_color;\n  #if CC_DRAW_WIRE_FRAME\n    vBarycentric = a_texCoord2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\n  precision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n  layout(location = 0) in vec2 uv;\n  layout(location = 1) in vec4 color;\n  #if CC_DRAW_WIRE_FRAME\n    layout(location = 2) in vec3 vBarycentric;\n  #endif\n  layout(set = 1, binding = 2) uniform sampler2D mainTexture;\n  layout(set = 1, binding = 1) uniform FragConstants {\n    vec4 tintColor;\n  };\n  vec4 add () {\n    vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\n    if (any(lessThan(vBarycentric, vec3(0.02)))) {\n        col = vec4(0., 1., 1., 1.);\n    }\n#endif\n    return CCFragOutput(col);\n  }\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\n  mat3 m = mat3(xAxis,yAxis,zAxis);\n  float trace = m[0][0] + m[1][1] + m[2][2];\n  vec4 quat;\n  if (trace > 0.) {\n    float s = 0.5 / sqrt(trace + 1.0);\n    quat.w = 0.25 / s;\n    quat.x = (m[2][1] - m[1][2]) * s;\n    quat.y = (m[0][2] - m[2][0]) * s;\n    quat.z = (m[1][0] - m[0][1]) * s;\n  } else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\n    float s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\n    quat.w = (m[2][1] - m[1][2]) / s;\n    quat.x = 0.25 * s;\n    quat.y = (m[0][1] + m[1][0]) / s;\n    quat.z = (m[0][2] + m[2][0]) / s;\n  } else if (m[1][1] > m[2][2]) {\n    float s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\n    quat.w = (m[0][2] - m[2][0]) / s;\n    quat.x = (m[0][1] + m[1][0]) / s;\n    quat.y = 0.25 * s;\n    quat.z = (m[1][2] + m[2][1]) / s;\n  } else {\n    float s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\n    quat.w = (m[1][0] - m[0][1]) / s;\n    quat.x = (m[0][2] + m[2][0]) / s;\n    quat.y = (m[1][2] + m[2][1]) / s;\n    quat.z = 0.25 * s;\n  }\n  float len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\n  if (len > 0.) {\n    len = 1. / sqrt(len);\n    quat.x = quat.x * len;\n    quat.y = quat.y * len;\n    quat.z = quat.z * len;\n    quat.w = quat.w * len;\n  }\n  return quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\n  float x = angle.x / 2.;\n  float y = angle.y / 2.;\n  float z = angle.z / 2.;\n  float sx = sin(x);\n  float cx = cos(x);\n  float sy = sin(y);\n  float cy = cos(y);\n  float sz = sin(z);\n  float cz = cos(z);\n  vec4 quat = vec4(0);\n  quat.x = sx * cy * cz + cx * sy * sz;\n  quat.y = cx * sy * cz + sx * cy * sz;\n  quat.z = cx * cy * sz - sx * sy * cz;\n  quat.w = cx * cy * cz - sx * sy * sz;\n  return quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\n  float x2 = q.x + q.x;\n  float y2 = q.y + q.y;\n  float z2 = q.z + q.z;\n  float xx = q.x * x2;\n  float xy = q.x * y2;\n  float xz = q.x * z2;\n  float yy = q.y * y2;\n  float yz = q.y * z2;\n  float zz = q.z * z2;\n  float wx = q.w * x2;\n  float wy = q.w * y2;\n  float wz = q.w * z2;\n  return mat4(\n    1. - (yy + zz), xy + wz, xz - wy, 0,\n    xy - wz, 1. - (xx + zz), yz + wx, 0,\n    xz + wy, yz - wx, 1. - (xx + yy), 0,\n    p.x, p.y, p.z, 1\n  );\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\n  float x = q.x, y = q.y, z = q.z, w = q.w;\n  float x2 = x + x;\n  float y2 = y + y;\n  float z2 = z + z;\n  float xx = x * x2;\n  float xy = x * y2;\n  float xz = x * z2;\n  float yy = y * y2;\n  float yz = y * z2;\n  float zz = z * z2;\n  float wx = w * x2;\n  float wy = w * y2;\n  float wz = w * z2;\n  float sx = s.x;\n  float sy = s.y;\n  float sz = s.z;\n  return mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n    (xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n    (xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\n    t.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\n  vec4 quat;\n  quat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\n  quat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\n  quat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\n  quat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\n  return quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\n  float ix = q.w * v.x + q.y * v.z - q.z * v.y;\n  float iy = q.w * v.y + q.z * v.x - q.x * v.z;\n  float iz = q.w * v.z + q.x * v.y - q.y * v.x;\n  float iw = -q.x * v.x - q.y * v.y - q.z * v.z;\n  v.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\n  v.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\n  v.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\n  vec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\n  vec4 rotQuat = quatMultiply(viewQuat, q);\n  rotateVecFromQuat(pos, rotQuat);\n  return pos;\n}\nvoid rotateCorner (inout vec2 corner, float angle){\n  float xOS = cos(angle) * corner.x - sin(angle) * corner.y;\n  float yOS = sin(angle) * corner.x + cos(angle) * corner.y;\n  corner.x = xOS;\n  corner.y = yOS;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 mainTiling_Offset;\n  vec4 frameTile_velLenScale;\n  vec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n  , mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n  , vec3 eye\n  , vec4 velocity\n  , float velocityScale\n  , float lengthScale\n  , float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\n  vec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\n  vec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\n  vec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\n  vec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\n  pos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\n  vec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\n  vec3 camX = vec3(1, 0, 0);\n  vec3 camY = vec3(0, 0, -1);\n  pos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\n  vec2 viewSpaceVert = vec2(vertOffset.x * s.x, vertOffset.y * s.y);\n  rotateCorner(viewSpaceVert, q.z);\n  vec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\n  vec3 camY = vec3(0, 1, 0);\n  vec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\n  pos.xyz += offset;\n#else\n  pos.x += vertOffset.x;\n  pos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\n  vec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\n  aniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\n  vertIndex.y = 1. - vertIndex.y;\n#endif\n  return (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_RENDER_MODE == 1\n  layout(location = 8) in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\n  layout(location = 6) in vec3 a_texCoord3;\n  layout(location = 7) in vec3 a_normal;\n  layout(location = 8) in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\n  vec3 compScale = scale.xyz * a_texCoord1;\n  vec4 pos = vec4(a_position, 1);\n  #if CC_RENDER_MODE == 1\n    vec4 velocity = vec4(a_color1.xyz, 0);\n  #endif\n  #if !CC_USE_WORLD_SPACE\n    pos = cc_matWorld * pos;\n    #if CC_RENDER_MODE == 1\n      velocity = cc_matWorld * velocity;\n    #endif\n  #endif\n  #if CC_RENDER_MODE != 4\n    vec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n    #if CC_RENDER_MODE == 0\n      vec3 rotEuler = a_texCoord2;\n    #elif CC_RENDER_MODE == 1\n      vec3 rotEuler = vec3(0.);\n    #else\n      vec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n    #endif\n    computeVertPos(pos, cornerOffset, quaternionFromEuler(rotEuler), compScale\n    #if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n      , cc_matViewInv\n    #endif\n    #if CC_RENDER_MODE == 1\n      , cc_cameraPos.xyz\n      , velocity\n      , frameTile_velLenScale.z\n      , frameTile_velLenScale.w\n      , a_texCoord.x\n    #endif\n    );\n    color = a_color;\n  #else\n    mat4 xformNoScale = matrixFromRT(quaternionFromEuler(a_texCoord2), pos.xyz);\n    mat4 xform = matFromRTS(quaternionFromEuler(a_texCoord2), pos.xyz, compScale);\n    pos = xform * vec4(a_texCoord3, 1);\n    vec4 normal = xformNoScale * vec4(a_normal, 0);\n    color = a_color * a_color1;\n  #endif\n  uv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\n  pos = cc_matViewProj * pos;\n  return pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\n  vec4 tintColor;\n};\nvec4 add () {\n  vec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n  return CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 v_light;\nlayout(location = 1) out vec2 uv0;\n#if TWO_COLORED\n  layout(location = 3) in vec4 a_color2;\n  layout(location = 2) out vec4 v_dark;\n#endif\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  pos = cc_matViewProj * pos;\n  uv0 = a_texCoord;\n  v_light = a_color;\n  #if TWO_COLORED\n    v_dark = a_color2;\n  #endif\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\n  layout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\n    float alphaThreshold;\n  };\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n  #if USE_ALPHA_TEST\n      if (color.a < alphaThreshold) discard;\n  #endif\n}\nvoid ALPHA_TEST (in float alpha) {\n  #if USE_ALPHA_TEST\n      if (alpha < alphaThreshold) discard;\n  #endif\n}\nlayout(location = 0) in vec4 v_light;\n#if TWO_COLORED\n  layout(location = 2) in vec4 v_dark;\n#endif\nlayout(location = 1) in vec2 uv0;\nlayout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if TWO_COLORED\n    vec4 texColor = vec4(1, 1, 1, 1);\n    texColor *= texture(cc_spriteTexture, uv0);\n     o.a = texColor.a * v_light.a;\n    o.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n  #else\n    o *= texture(cc_spriteTexture, uv0);\n    o *= v_light;\n  #endif\n  ALPHA_TEST(o);\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 color;\nlayout(location = 1) out vec2 uv0;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 1);\n  #if USE_LOCAL\n    pos = cc_matWorld * pos;\n  #endif\n  #if USE_PIXEL_ALIGNMENT\n    pos = cc_matView * pos;\n    pos.xyz = floor(pos.xyz);\n    pos = cc_matProj * pos;\n  #else\n    pos = cc_matViewProj * pos;\n  #endif\n  uv0 = a_texCoord;\n  color = a_color;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\n    return vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\n    return texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\n  layout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\n    float alphaThreshold;\n  };\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n  #if USE_ALPHA_TEST\n      if (color.a < alphaThreshold) discard;\n  #endif\n}\nvoid ALPHA_TEST (in float alpha) {\n  #if USE_ALPHA_TEST\n      if (alpha < alphaThreshold) discard;\n  #endif\n}\nlayout(location = 0) in vec4 color;\n#if USE_TEXTURE\n  layout(location = 1) in vec2 uv0;\n  layout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\n  vec4 o = vec4(1, 1, 1, 1);\n  #if USE_TEXTURE\n    o *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n    #if IS_GRAY\n      float gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\n      o.r = o.g = o.b = gray;\n    #endif\n  #endif\n  o *= color;\n  ALPHA_TEST(o);\n  return o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int16: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  layout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 0\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 1\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 2\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 3\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nlayout(location = 0) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\n#if USE_VERTEX_COLOR\n  layout(location = 13) in vec4 a_color;\n  layout(location = 1) out vec4 v_color;\n#endif\nlayout(location = 2) out vec3 v_position;\nlayout(location = 3) out vec3 v_normal;\nlayout(location = 4) out vec2 v_uv;\nlayout(location = 5) out vec2 v_uv1;\nlayout(location = 6) out float v_fog_factor;\n#if USE_NORMAL_MAP\n  layout(location = 7) out vec3 v_tangent;\n  layout(location = 8) out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  layout(location = 14) in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  layout(location = 9) out vec2 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\n      v_luv = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\n#else\n      v_luv = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\n#endif\n}\n#endif\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 pos = matWorld * In.position;\n  v_position = pos.xyz;\n  v_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n  #if USE_NORMAL_MAP\n    v_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\n    v_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n  #endif\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  v_fog_factor = CC_TRANSFER_FOG(pos);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    CCLightingMapCaclUV();\n  #endif\n    v_shadowPos = cc_matLightViewProj * pos;\n  return cc_matProj * (cc_matView * matWorld) * In.position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 0) in highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n  layout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\n  layout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\n  float CCGetShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow / 5.0;\n  }\n  float CCGetShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n  float CCGetDirLightShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetDirLightShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    return shadow / 5.0;\n  }\n  float CCGetDirLightShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetDirLightShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n#endif\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  vec4 lightmap;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(set = 2, binding = 1) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      vec3 lightColor = cc_lightColor[i].rgb;\n    #if CC_RECEIVE_SHADOW\n      if (cc_lightPos[i].w > 0.0) {\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5();\n      else shadowAttenuation = CCGetDirLightShadowFactorX1();\n      lightColor *= 1.0 - shadowAttenuation;\n    }\n      }\n    #endif\n      finalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      finalColor = s.lightmap.a * s.lightmap.rgb + (1.0 - s.lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5();\n      else shadowAttenuation = CCGetShadowFactorX1();\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\n      finalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n    }\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n  layout(location = 9) in vec2 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\n#endif\nlayout(location = 2) in vec3 v_position;\nlayout(location = 4) in vec2 v_uv;\nlayout(location = 5) in vec2 v_uv1;\nlayout(location = 3) in vec3 v_normal;\nlayout(location = 6) in float v_fog_factor;\n#if USE_VERTEX_COLOR\n  layout(location = 1) in vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\n  layout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\n  layout(location = 7) in vec3 v_tangent;\n  layout(location = 8) in vec3 v_bitangent;\n  layout(set = 1, binding = 2) uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\n  layout(set = 1, binding = 3) uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\n  layout(set = 1, binding = 4) uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\n  layout(set = 1, binding = 5) uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\n  layout(set = 1, binding = 6) uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\n  vec4 baseColor = albedo;\n  #if USE_VERTEX_COLOR\n    baseColor *= v_color;\n  #endif\n  #if USE_ALBEDO_MAP\n    vec4 texColor = texture(albedoMap, ALBEDO_UV);\n    texColor.rgb = SRGBToLinear(texColor.rgb);\n    baseColor *= texColor;\n  #endif\n  s.albedo = baseColor;\n  s.albedo.rgb *= albedoScaleAndCutoff.xyz;\n  #if USE_ALPHA_TEST\n    if (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    s.lightmap = texture(cc_lightingMap, v_luv);\n  #endif\n  s.normal = v_normal;\n  #if USE_NORMAL_MAP\n    vec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\n    s.normal =\n      (nmmp.x * pbrParams.w) * normalize(v_tangent) +\n      (nmmp.y * pbrParams.w) * normalize(v_bitangent) +\n      nmmp.z * normalize(s.normal);\n  #endif\n  s.position = v_position;\n  vec4 pbr = pbrParams;\n  #if USE_PBR_MAP\n    vec4 res = texture(pbrMap, PBR_UV);\n    pbr.x *= res.r;\n    pbr.y *= res.g;\n    pbr.z *= res.b;\n  #endif\n  #if USE_METALLIC_ROUGHNESS_MAP\n    vec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\n    pbr.z *= metallicRoughness.b;\n    pbr.y *= metallicRoughness.g;\n  #endif\n  #if USE_OCCLUSION_MAP\n    pbr.x *= texture(occlusionMap, PBR_UV).r;\n  #endif\n  s.occlusion = clamp(pbr.x, 0.0, 0.96);\n  s.roughness = clamp(pbr.y, 0.04, 1.0);\n  s.metallic = pbr.z;\n  s.emissive = emissive.rgb * emissiveScaleParam.xyz;\n  #if USE_EMISSIVE_MAP\n    s.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int16: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  layout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\n  layout(location = 13) in vec2 a_texCoord1;\n#endif\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out vec2 v_uv1;\nlayout(location = 2) out float v_clip_depth;\nvec4 vert () {\n  StandardVertInput In;\n  In.position = vec4(a_position, 1.0);\n  In.normal = a_normal;\n  In.tangent = a_tangent;\n  #if CC_USE_MORPH\n    applyMorph(In);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(In);\n  #endif\n  mat4 matWorld, matWorldIT;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n    matWorldIT = matWorld;\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n    matWorldIT = matWorld;\n  #else\n    matWorld = cc_matWorld;\n    matWorldIT = cc_matWorldIT;\n  #endif\n  vec4 worldPos = matWorld * In.position;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #if HAS_SECOND_UV\n    v_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  v_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 tilingOffset;\n  vec4 albedo;\n  vec4 albedoScaleAndCutoff;\n  vec4 pbrParams;\n  vec4 emissive;\n  vec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in vec2 v_uv1;\nlayout(location = 2) in float v_clip_depth;\n#if USE_ALBEDO_MAP\n  layout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\n  vec4 baseColor = albedo;\n  #if USE_ALBEDO_MAP\n    baseColor *= texture(albedoMap, ALBEDO_UV);\n  #endif\n  #if USE_ALPHA_TEST\n    if (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n  #endif\n  return packDepthToRGBA(v_clip_depth);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 0\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 1\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 2\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 3\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\nlayout(location = 0) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 1) out highp vec3 v_position;\nlayout(location = 2) out mediump vec3 v_normal;\n#if USE_NORMALMAP\n  layout(location = 3) out mediump vec3 v_tangent;\n  layout(location = 4) out mediump vec3 v_binormal;\n#endif\nlayout(location = 5) out mediump vec2 uvw;\nlayout(location = 6) out mediump vec2 uv0;\nlayout(location = 7) out mediump vec2 uv1;\nlayout(location = 8) out mediump vec2 uv2;\nlayout(location = 9) out mediump vec2 uv3;\nlayout(location = 10) out mediump vec2 luv;\nlayout(location = 11) out mediump vec3 diffuse;\nlayout(location = 12) out mediump float v_fog_factor;\nlayout(set = 1, binding = 0) uniform TexCoords {\n  vec4 UVScale;\n  vec4 lightMapUVParam;\n};\nvec4 vert () {\n  vec3 worldPos;\n  worldPos.x = cc_matWorld[3][0] + a_position.x;\n  worldPos.y = cc_matWorld[3][1] + a_position.y;\n  worldPos.z = cc_matWorld[3][2] + a_position.z;\n  vec4 pos = vec4(worldPos, 1.0);\n  pos = cc_matViewProj * pos;\n  uvw = a_texCoord;\n  uv0 = a_position.xz * UVScale.x;\n  uv1 = a_position.xz * UVScale.y;\n  uv2 = a_position.xz * UVScale.z;\n  uv3 = a_position.xz * UVScale.w;\n  #if USE_LIGHTMAP\n    luv = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\n  #endif\n  v_position = worldPos;\n  v_normal = a_normal;\n  v_fog_factor = CC_TRANSFER_FOG(vec4(worldPos, 1.0));\n  #if USE_NORMALMAP\n    v_tangent = vec3(1.0, 0.0, 0.0);\n    v_binormal = vec3(0.0, 0.0, 1.0);\n    v_binormal = cross(v_tangent, a_normal);\n    v_tangent = cross(a_normal, v_binormal);\n  #endif\n    v_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n    return textureLod(tex, coord, lod);\n}\n#endif\n#if CC_RECEIVE_SHADOW\nlayout(location = 0) in highp vec4 v_shadowPos;\n#if CC_RECEIVE_SHADOW\n  layout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\n  layout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\n  float CCGetShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_shadowMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow / 5.0;\n  }\n  float CCGetShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture(cc_shadowMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n  float CCGetDirLightShadowFactorX1 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    float shadow = step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    return shadow;\n  }\n  float CCGetDirLightShadowFactorX5 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    float closestDepth = 0.0;\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n    closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n    return shadow / 5.0;\n  }\n  float CCGetDirLightShadowFactorX9 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -1; i <= 1; i++) {\n      for (int j = -1; j <= 1; j++) {\n        float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 9.0;\n  }\n  float CCGetDirLightShadowFactorX25 () {\n    vec3 clipPos = v_shadowPos.xyz / v_shadowPos.w * 0.5 + 0.5;\n    if (clipPos.x < 0.0 || clipPos.x > 1.0 ||\n        clipPos.y < 0.0 || clipPos.y > 1.0 ||\n        clipPos.z <-1.0 || clipPos.z > 1.0) { return 0.0; }\n    float offsetx = 1.0 / cc_shadowInfo.x;\n    float offsety = 1.0 / cc_shadowInfo.y;\n    float shadow = 0.0;\n    for (int i = -2; i <= 2; i++) {\n      for (int j = -2; j <= 2; j++) {\n        float closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n        shadow += step(closestDepth, clipPos.z - cc_shadowInfo.w);\n      }\n    }\n    return shadow / 25.0;\n  }\n#endif\n#endif\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\n  vec3 NxH = cross(N, H);\n  float OneMinusNoHSqr = dot(NxH, NxH);\n  float a = roughness * roughness;\n  float n = NoH * a;\n  float p = a / (OneMinusNoHSqr + n * n);\n  return p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\n  return (roughness*0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\n  const vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\n  const vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\n  vec4 r = roughness * c0 + c1;\n  float a004 = min( r.x * r.x, exp2( -9.28 * NoV ) ) * r.x + r.y;\n  vec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n  AB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\n  return specular * AB.x + AB.y;\n}\nstruct StandardSurface {\n  vec4 albedo;\n  vec3 position;\n  vec3 normal;\n  vec3 emissive;\n  vec4 lightmap;\n  float roughness;\n  float metallic;\n  float occlusion;\n};\n#if CC_FORWARD_ADD\nlayout(set = 2, binding = 1) uniform CCForwardLight {\n  highp vec4 cc_lightPos[1];\n  vec4 cc_lightColor[1];\n  vec4 cc_lightSizeRangeAngle[1];\n  vec4 cc_lightDir[1];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\n  float factor = distSqr * invSqrAttRadius;\n  float smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\n  return smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\n  float attenuation = 1.0 / max(distSqr, 0.01*0.01);\n  attenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\n  return attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\n  float cd = dot(litDir, L);\n  float attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\n  return (attenuation * attenuation);\n}\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 finalColor = vec3(0.0);\n    for (int i = 0; i < 1; i++) {\n      vec3 SLU = cc_lightPos[i].xyz - s.position;\n      vec3 SL = normalize(SLU);\n      vec3 SH = normalize(SL + V);\n      float SNL = max(dot(N, SL), 0.001);\n      float SNH = max(dot(N, SH), 0.0);\n      float distSqr = dot(SLU, SLU);\n      float litRadius = cc_lightSizeRangeAngle[i].x;\n      float litRadiusSqr = litRadius * litRadius;\n      float illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\n      float attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\n      attRadiusSqrInv *= attRadiusSqrInv;\n      float att = GetDistAtt(distSqr, attRadiusSqrInv);\n      vec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\n      if (cc_lightPos[i].w > 0.0) {\n        float cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\n        float cosOuter = cc_lightSizeRangeAngle[i].z;\n        float litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\n        float litAngleOffset = -cosOuter * litAngleScale;\n        att *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n      }\n      vec3 lightColor = cc_lightColor[i].rgb;\n    #if CC_RECEIVE_SHADOW\n      if (cc_lightPos[i].w > 0.0) {\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetDirLightShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetDirLightShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetDirLightShadowFactorX5();\n      else shadowAttenuation = CCGetDirLightShadowFactorX1();\n      lightColor *= 1.0 - shadowAttenuation;\n    }\n      }\n    #endif\n      finalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n    }\n    finalColor = finalColor * s.occlusion;\n    return vec4(finalColor, 0.0);\n  }\n#else\n  vec4 CCStandardShading (StandardSurface s) {\n    vec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\n    vec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\n    vec3 N = normalize(s.normal);\n    vec3 V = normalize(cc_cameraPos.xyz - s.position);\n    float NV = max(abs(dot(N, V)), 0.001);\n    specular = BRDFApprox(specular, s.roughness, NV);\n    vec3 L = normalize(-cc_mainLitDir.xyz);\n    vec3 H = normalize(L+V);\n    float NH = max(dot(N, H), 0.0);\n    float NL = max(dot(N, L), 0.001);\n    vec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\n    #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n      finalColor = s.lightmap.a * s.lightmap.rgb + (1.0 - s.lightmap.a) * finalColor;\n    #endif\n    vec3 diffuseContrib = diffuse / 3.14159265359;\n    vec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\n    finalColor *= (diffuseContrib + specularContrib);\n    float fAmb = 0.5 - N.y * 0.5;\n    vec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\n    finalColor += (ambDiff.rgb * diffuse);\n    #if CC_USE_IBL\n      vec3 R = normalize(reflect(-V, N));\n      vec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n      #if CC_USE_IBL == 2\n        vec3 env = unpackRGBE(envmap);\n      #else\n        vec3 env = SRGBToLinear(envmap.rgb);\n      #endif\n      finalColor += env * cc_ambientSky.w * specular;\n    #endif\n    finalColor = finalColor * s.occlusion;\n    #if CC_USE_HDR\n      s.emissive *= cc_exposure.w;\n    #endif\n    finalColor += s.emissive;\n    #if CC_RECEIVE_SHADOW\n    {\n      float pcf = cc_shadowInfo.z + 0.001;\n      float shadowAttenuation = 0.0;\n      if (pcf > 3.0) shadowAttenuation = CCGetShadowFactorX25();\n      else if (3.0 > pcf && pcf > 2.0) shadowAttenuation = CCGetShadowFactorX9();\n      else if (2.0 > pcf && pcf > 1.0) shadowAttenuation = CCGetShadowFactorX5();\n      else shadowAttenuation = CCGetShadowFactorX1();\n      vec3 shadowColor = cc_shadowColor.rgb * cc_shadowColor.a + finalColor.rgb * (1.0 - cc_shadowColor.a);\n      finalColor.rgb = shadowColor.rgb * shadowAttenuation * NL + finalColor.rgb * (1.0 - shadowAttenuation * NL);\n    }\n    #endif\n    return vec4(finalColor, s.albedo.a);\n  }\n#endif\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(location = 1) in highp vec3 v_position;\nlayout(location = 2) in mediump vec3 v_normal;\n#if USE_NORMALMAP\n  layout(location = 3) in mediump vec3 v_tangent;\n  layout(location = 4) in mediump vec3 v_binormal;\n#endif\nlayout(location = 5) in mediump vec2 uvw;\nlayout(location = 6) in mediump vec2 uv0;\nlayout(location = 7) in mediump vec2 uv1;\nlayout(location = 8) in mediump vec2 uv2;\nlayout(location = 9) in mediump vec2 uv3;\nlayout(location = 11) in mediump vec3 diffuse;\nlayout(location = 10) in mediump vec2 luv;\nlayout(location = 12) in mediump float v_fog_factor;\nlayout(set = 1, binding = 1) uniform PbrParams {\n  vec4 metallic;\n  vec4 roughness;\n};\nlayout(set = 1, binding = 2) uniform sampler2D weightMap;\nlayout(set = 1, binding = 3) uniform sampler2D detailMap0;\nlayout(set = 1, binding = 4) uniform sampler2D detailMap1;\nlayout(set = 1, binding = 5) uniform sampler2D detailMap2;\nlayout(set = 1, binding = 6) uniform sampler2D detailMap3;\nlayout(set = 1, binding = 7) uniform sampler2D normalMap0;\nlayout(set = 1, binding = 8) uniform sampler2D normalMap1;\nlayout(set = 1, binding = 9) uniform sampler2D normalMap2;\nlayout(set = 1, binding = 10) uniform sampler2D normalMap3;\nlayout(set = 1, binding = 11) uniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n  #if LAYERS > 1\n    vec4 w = texture(weightMap, uvw);\n  #endif\n  vec4 baseColor = vec4(0, 0, 0, 0);\n  #if LAYERS == 1\n    baseColor = texture(detailMap0, uv0);\n  #elif LAYERS == 2\n    baseColor += texture(detailMap0, uv0) * w.r;\n    baseColor += texture(detailMap1, uv1) * w.g;\n  #elif LAYERS == 3\n    baseColor += texture(detailMap0, uv0) * w.r;\n    baseColor += texture(detailMap1, uv1) * w.g;\n    baseColor += texture(detailMap2, uv2) * w.b;\n  #elif LAYERS == 4\n    baseColor += texture(detailMap0, uv0) * w.r;\n    baseColor += texture(detailMap1, uv1) * w.g;\n    baseColor += texture(detailMap2, uv2) * w.b;\n    baseColor += texture(detailMap3, uv3) * w.a;\n  #else\n    baseColor = texture(detailMap0, uv0);\n  #endif\n  s.position = v_position;\n  #if USE_NORMALMAP\n    vec4 baseNormal = vec4(0, 0, 0, 0);\n    #if LAYERS == 1\n      baseNormal = texture(normalMap0, uv0);\n    #elif LAYERS == 2\n      baseNormal += texture(normalMap0, uv0) * w.r;\n      baseNormal += texture(normalMap1, uv1) * w.g;\n    #elif LAYERS == 3\n      baseNormal += texture(normalMap0, uv0) * w.r;\n      baseNormal += texture(normalMap1, uv1) * w.g;\n      baseNormal += texture(normalMap2, uv2) * w.b;\n    #elif LAYERS == 4\n      baseNormal += texture(normalMap0, uv0) * w.r;\n      baseNormal += texture(normalMap1, uv1) * w.g;\n      baseNormal += texture(normalMap2, uv2) * w.b;\n      baseNormal += texture(normalMap3, uv3) * w.a;\n    #else\n      baseNormal = texture(normalMap0, uv0);\n    #endif\n    vec3 nmmp = baseNormal.xyz - vec3(0.5);\n    s.normal =\n      nmmp.x * normalize(v_tangent) +\n      nmmp.y * normalize(v_binormal) +\n      nmmp.z * normalize(v_normal);\n  #else\n    s.normal = v_normal;\n  #endif\n  s.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\n  s.occlusion = 1.0;\n  #if USE_PBR\n    s.roughness = 0.0;\n    #if LAYERS == 1\n      s.roughness = roughness.x;\n    #elif LAYERS == 2\n      s.roughness += roughness.x * w.r;\n      s.roughness += roughness.y * w.g;\n    #elif LAYERS == 3\n      s.roughness += roughness.x * w.r;\n      s.roughness += roughness.y * w.g;\n      s.roughness += roughness.z * w.b;\n    #elif LAYERS == 4\n      s.roughness += roughness.x * w.r;\n      s.roughness += roughness.y * w.g;\n      s.roughness += roughness.z * w.b;\n      s.roughness += roughness.w * w.a;\n    #else\n      s.roughness = 1.0;\n    #endif\n    s.metallic = 0.0;\n    #if LAYERS == 1\n      s.metallic = metallic.x;\n    #elif LAYERS == 2\n      s.metallic += metallic.x * w.r;\n      s.metallic += metallic.y * w.g;\n    #elif LAYERS == 3\n      s.metallic += metallic.x * w.r;\n      s.metallic += metallic.y * w.g;\n      s.metallic += metallic.z * w.b;\n    #elif LAYERS == 4\n      s.metallic += metallic.x * w.r;\n      s.metallic += metallic.y * w.g;\n      s.metallic += metallic.z * w.b;\n      s.metallic += metallic.w * w.a;\n    #else\n      s.metallic = 0.0;\n    #endif\n  #else\n    s.roughness = 1.0;\n    s.metallic = 0.0;\n  #endif\n  s.emissive = vec3(0.0, 0.0, 0.0);\n  #if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\n    s.lightmap = texture(lightMap, luv);\n  #else\n    s.lightmap = vec4(0.0, 0.0, 0.0, 0.0);\n  #endif\n}\nvec4 frag () {\n  StandardSurface s; surf(s);\n  vec4 color = CCStandardShading(s);\n  color = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\n  return CCFragOutput(color);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"},{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_clip_depth;\nvec4 vert () {\n  vec4 worldPos;\n  worldPos.x = cc_matWorld[3][0] + a_position.x;\n  worldPos.y = cc_matWorld[3][1] + a_position.y;\n  worldPos.z = cc_matWorld[3][2] + a_position.z;\n  worldPos.w = 1.0;\n  vec4 clipPos = cc_matLightViewProj * worldPos;\n  v_clip_depth = clipPos.zw;\n  return clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\n  vec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\n  ret = fract(ret);\n  ret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\n  return ret;\n}\nlayout(location = 0) in vec2 v_clip_depth;\nvec4 frag () {\n  return packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int16: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  layout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\n    vec4 wPos = pos;\n    float cam_dis = distance(cc_cameraPos, wPos);\n    float fogStart = cc_fogBase.x;\n    float fogEnd = cc_fogBase.y;\n    return clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * fogDensity);\n    return f;\n}\nfloat ExpSquaredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float fogDensity = cc_fogBase.z;\n    float cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\n    float f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\n    return f;\n}\nfloat LayeredFog(vec4 pos) {\n    vec4 wPos = pos;\n    float fogAtten = cc_fogAdd.z;\n    float _FogTop = cc_fogAdd.x;\n    float _FogRange = cc_fogAdd.y;\n    vec3 camWorldProj = cc_cameraPos.xyz;\n    camWorldProj.y = 0.;\n    vec3 worldPosProj = wPos.xyz;\n    worldPosProj.y = 0.;\n    float fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\n    float fDeltaY, fDensityIntegral;\n    if (cc_cameraPos.y > _FogTop) {\n        if (wPos.y < _FogTop) {\n            fDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\n            fDensityIntegral = fDeltaY * fDeltaY * 0.5;\n        } else {\n            fDeltaY = 0.;\n            fDensityIntegral = 0.;\n        }\n    } else {\n        if (wPos.y < _FogTop) {\n            float fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            float fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\n            fDeltaY = abs(fDeltaA - fDeltaB);\n            fDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n        } else {\n            fDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\n            fDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n        }\n    }\n    float fDensity;\n    if (fDeltaY != 0.) {\n        fDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n    } else {\n        fDensity = 0.;\n    }\n    float f = exp(-fDensity);\n    return f;\n}\nfloat CC_TRANSFER_FOG(vec4 pos) {\n    #if CC_USE_FOG == 0\n        return LinearFog(pos);\n\t#elif CC_USE_FOG == 1\n        return ExpFog(pos);\n    #elif CC_USE_FOG == 2\n        return ExpSquaredFog(pos);\n    #elif CC_USE_FOG == 3\n        return LayeredFog(pos);\n    #endif\n    return 1.;\n}\n#if USE_VERTEX_COLOR\n  layout(location = 13) in lowp vec4 a_color;\n  layout(location = 0) out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\n  layout(location = 1) out vec2 v_uv;\n  layout(set = 1, binding = 0) uniform TexCoords {\n    vec4 tilingOffset;\n  };\n#endif\nlayout(location = 2) out float factor_fog;\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  #if USE_TEXTURE\n    v_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n  #endif\n  #if USE_VERTEX_COLOR\n    v_color = a_color;\n  #endif\n  factor_fog = CC_TRANSFER_FOG(matWorld * position);\n  return cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\n  layout(location = 1) in vec2 v_uv;\n  layout(set = 1, binding = 2) uniform sampler2D mainTexture;\n#endif\nlayout(set = 1, binding = 1) uniform Constant {\n  vec4 mainColor;\n  vec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\n  layout(location = 0) in lowp vec4 v_color;\n#endif\nlayout(location = 2) in float factor_fog;\nvec4 frag () {\n  vec4 o = mainColor;\n  o.rgb *= colorScaleAndCutoff.xyz;\n  #if USE_VERTEX_COLOR\n    o *= v_color;\n  #endif\n  #if USE_TEXTURE\n    o *= texture(mainTexture, v_uv);\n  #endif\n  #if USE_ALPHA_TEST\n    if (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n  #endif\n  o = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, factor_fog), o.a);\n  return CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int16: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\n  rgba = rgba * 255.0;\n  highp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\n  highp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\n  highp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\n  return Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\n    int getVertexId() {\n        return gl_VertexIndex;\n    }\nlayout(set = 2, binding = 4) uniform CCMorph {\n    vec4 cc_displacementWeights[15];\n    vec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\n    float pixelIndexF = float(pixelIndex);\n    float x = mod(pixelIndexF, textureResolution.x);\n    float y = floor(pixelIndexF / textureResolution.x);\n    return vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\n    return (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_SUPPORT_FLOAT_TEXTURE\n        vec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\n            ivec2 texSize = textureSize(tex, 0);\n            return texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n        }\n#else\n    vec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\n        int pixelIndex = elementIndex * 4;\n        vec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\n        vec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\n        vec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\n        return vec4(\n            decode32(texture(tex, x)),\n            decode32(texture(tex, y)),\n            decode32(texture(tex, z)),\n            1.0\n        );\n    }\n#endif\nfloat getDisplacementWeight(int index) {\n    int quot = index / 4;\n    int remainder = index - quot * 4;\n    if (remainder == 0) {\n        return cc_displacementWeights[quot].x;\n    } else if (remainder == 1) {\n        return cc_displacementWeights[quot].y;\n    } else if (remainder == 2) {\n        return cc_displacementWeights[quot].z;\n    } else {\n        return cc_displacementWeights[quot].w;\n    }\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\n    return fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\n    vec3 result = vec3(0, 0, 0);\n    int nVertices = int(cc_displacementTextureInfo.z);\n    for (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\n        result += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n    }\n    return result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\n    layout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\n    vec3 getPositionDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    layout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\n    vec3 getNormalDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n    }\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    layout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\n    vec3 getTangentDisplacement(int vertexId) {\n        return getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n    }\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\n    int vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\n    attr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\n    attr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\n    attr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\n    position.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\n  layout(location = 4) in u16vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n  #if USE_INSTANCING\n    layout(location = 7) in highp vec4 a_jointAnimInfo;\n  #endif\n  layout(set = 2, binding = 3) uniform CCSkinningTexture {\n    highp vec4 cc_jointTextureInfo;\n  };\n  layout(set = 2, binding = 2) uniform CCSkinningAnimation {\n    highp vec4 cc_jointAnimInfo;\n  };\n  layout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n  #else\n  layout(set = 2, binding = 3) uniform CCSkinning {\n    highp vec4 cc_joints[30 * 3];\n  };\n#endif\n#if CC_USE_BAKED_ANIMATION\n  #if CC_SUPPORT_FLOAT_TEXTURE\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\n      vec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\n      vec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #else\n    mat4 getJointMatrix (float i) {\n    #if USE_INSTANCING\n      highp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n    #else\n      highp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n    #endif\n    highp float invSize = cc_jointTextureInfo.w;\n    highp float y = floor(j * invSize);\n    highp float x = j - y * cc_jointTextureInfo.x;\n    y = (y + 0.5) * invSize;\n      vec4 v1 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n      );\n      vec4 v2 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n      );\n      vec4 v3 = vec4(\n        decode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\n        decode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n      );\n      return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n    }\n  #endif\n#else\n  mat4 getJointMatrix (float i) {\n    int idx = int(i);\n    vec4 v1 = cc_joints[idx * 3];\n    vec4 v2 = cc_joints[idx * 3 + 1];\n    vec4 v3 = cc_joints[idx * 3 + 2];\n    return mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n  }\n#endif\nmat4 skinMatrix () {\n  vec4 joints = vec4(a_joints);\n  return getJointMatrix(joints.x) * a_weights.x\n       + getJointMatrix(joints.y) * a_weights.y\n       + getJointMatrix(joints.z) * a_weights.z\n       + getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\n  mat4 m = skinMatrix();\n  position = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\n  mat4 m = skinMatrix();\n  attr.position = m * attr.position;\n  attr.normal = (m * vec4(attr.normal, 0.0)).xyz;\n  attr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\n  layout(location = 8) in vec4 a_matWorld0;\n  layout(location = 9) in vec4 a_matWorld1;\n  layout(location = 10) in vec4 a_matWorld2;\n  #if USE_LIGHTMAP\n    layout(location = 11) in vec4 a_lightingMapUVParam;\n  #endif\n#elif USE_BATCHING\n  layout(location = 12) in float a_dyn_batch_id;\n  layout(set = 2, binding = 0) uniform CCLocalBatched {\n    highp mat4 cc_matWorlds[10];\n  };\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\n  highp mat4 cc_matWorld;\n  highp mat4 cc_matWorldIT;\n  highp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 0, binding = 2) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\nvec4 vert () {\n  vec4 position;\n  position = vec4(a_position, 1.0);\n  #if CC_USE_MORPH\n    applyMorph(position);\n  #endif\n  #if CC_USE_SKINNING\n    CCSkin(position);\n  #endif\n  mat4 matWorld;\n  #if USE_INSTANCING\n    matWorld = mat4(\n      vec4(a_matWorld0.xyz, 0.0),\n      vec4(a_matWorld1.xyz, 0.0),\n      vec4(a_matWorld2.xyz, 0.0),\n      vec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n    );\n  #elif USE_BATCHING\n    matWorld = cc_matWorlds[int(a_dyn_batch_id)];\n  #else\n    matWorld = cc_matWorld;\n  #endif\n  position = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\n  position.z -= 0.0001;\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 2) uniform CCShadow {\n  highp mat4 cc_matLightPlaneProj;\n  highp mat4 cc_matLightViewProj;\n  lowp  vec4 cc_shadowColor;\n  lowp  vec4 cc_shadowInfo;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nvec4 frag () {\n  return CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\n  highp vec4 position;\n  vec3 normal;\n  vec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(location = 0) out mediump vec4 viewDir;\nvec4 vert () {\n  viewDir = vec4(a_position, 1.0);\n  mat4 matViewRotOnly = mat4(mat3(cc_matView));\n  mat4 matProj = cc_matProj;\n  if (matProj[3].w > 0.0) {\n    vec2 scale = vec2(48.0, 24.0);\n    matProj[0].xy *= scale;\n    matProj[1].xy *= scale;\n    matProj[2].zw = vec2(-1.0);\n    matProj[3].zw = vec2(0.0);\n  }\n  vec4 pos = matProj * matViewRotOnly * viewDir;\n  pos.z = 0.99999 * pos.w;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\n  return rgbe.rgb * pow(2.0, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\n  color = min(color, vec3(8.0));\n  const float A = 2.51;\n  const float B = 0.03;\n  const float C = 2.43;\n  const float D = 0.59;\n  const float E = 0.14;\n  return (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n  #if !CC_USE_HDR\n    color.rgb = sqrt(ACESToneMap(color.rgb));\n  #endif\n  return color;\n}\nlayout(location = 0) in mediump vec4 viewDir;\nvec4 frag () {\n  #if USE_RGBE_CUBEMAP\n    vec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n  #else\n    vec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n  #endif\n  return CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform Constants {\n  vec4 offset;\n};\nlayout(set = 1, binding = 1) uniform PerFrameInfo {\n  vec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\n  if (i < 1.0) { return v.x; }\n  else if (i < 2.0) { return v.y; }\n  else if (i < 3.0) { return v.z; }\n  else { return v.w; }\n}\nvec4 vert () {\n  vec4 position = cc_matViewProj * vec4(a_position, 1.0);\n  position.xy += offset.xy;\n  v_uv = a_color.xy;\n  if (a_color.z >= 0.0) {\n    float n = getComponent(digits[int(a_color.z)], a_color.w);\n    v_uv += vec2(offset.z * n, 0.0);\n  }\n  return position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\n  highp   vec4 cc_time;\n  mediump vec4 cc_screenSize;\n  mediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\n  highp   mat4 cc_matView;\n  highp   mat4 cc_matViewInv;\n  highp   mat4 cc_matProj;\n  highp   mat4 cc_matProjInv;\n  highp   mat4 cc_matViewProj;\n  highp   mat4 cc_matViewProjInv;\n  highp   vec4 cc_cameraPos;\n  mediump vec4 cc_screenScale;\n  mediump vec4 cc_exposure;\n  mediump vec4 cc_mainLitDir;\n  mediump vec4 cc_mainLitColor;\n  mediump vec4 cc_ambientSky;\n  mediump vec4 cc_ambientGround;\n  mediump vec4 cc_fogColor;\n  mediump vec4 cc_fogBase;\n  mediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\n  return gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n  #if CC_USE_HDR\n    color.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n  #endif\n  return color;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nvec4 frag () {\n  return CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(location = 0) in vec2 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_uv;\nvec4 vert () {\n  vec4 pos = vec4(a_position, 0, 1);\n  v_uv = a_texCoord;\n  return pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 1) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 0) uniform splashFrag {\n  float u_precent;\n};\nvec4 frag () {\n  vec4 color = texture(mainTexture, v_uv);\n  float precent = clamp(u_precent, 0.0, 1.0);\n  color.xyz *= precent;\n  return color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Rd=t("builtinResMgr",i.builtinResMgr=new class{constructor(){this._device=null,this._resources={}}initBuiltinRes(t){this._device=t;const e=this._resources,n=document.createElement("canvas"),s=n.getContext("2d"),r=new P_(n),o=n.width=n.height=2;s.fillStyle="#000",s.fillRect(0,0,o,o);const a=new Zu;a._uuid="black-texture",a.image=r,e[a._uuid]=a,s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,o,o);const c=new Uint8Array(16);for(let t=0;t<c.length;++t)c[t]=0;const l=new Zu;l._uuid="empty-texture",l.image=r,l.uploadData(c),e[l._uuid]=l;const h=new sd;h._uuid="black-cube-texture",h.setMipFilter(sd.Filter.NEAREST),h.image={front:new P_(n),back:new P_(n),left:new P_(n),right:new P_(n),top:new P_(n),bottom:new P_(n)},e[h._uuid]=h,s.fillStyle="#777",s.fillRect(0,0,o,o);const _=new Zu;_._uuid="grey-texture",_.image=r,e[_._uuid]=_,s.fillStyle="#fff",s.fillRect(0,0,o,o);const u=new Zu;u._uuid="white-texture",u.image=r,e[u._uuid]=u;const d=new sd;d._uuid="white-cube-texture",d.setMipFilter(sd.Filter.NEAREST),d.image={front:new P_(n),back:new P_(n),left:new P_(n),right:new P_(n),top:new P_(n),bottom:new P_(n)},e[d._uuid]=d,s.fillStyle="#7f7fff",s.fillRect(0,0,o,o);const p=new Zu;p._uuid="normal-texture",p.image=r,e[p._uuid]=p,n.width=n.height=16,s.fillStyle="#ddd",s.fillRect(0,0,16,16),s.fillStyle="#555",s.fillRect(0,0,8,8),s.fillStyle="#555",s.fillRect(8,8,8,8);const m=new Zu;m._uuid="default-texture",m.image=r,e[m._uuid]=m;const f=new sd;if(f.setMipFilter(sd.Filter.NEAREST),f._uuid="default-cube-texture",f.image={front:new P_(n),back:new P_(n),left:new P_(n),right:new P_(n),top:new P_(n),bottom:new P_(n)},e[f._uuid]=f,i.SpriteFrame){const t=new i.SpriteFrame,n=r._texture;t.texture=n,t._uuid="default-spriteframe",e[t._uuid]=t}const g=Ad(t);if(!g)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));const v=wd[g];return v?Promise.resolve().then(()=>{od.forEach((t,e)=>{const n=Object.assign(new i.EffectAsset,t);n.shaders.forEach((t,n)=>{const i=v[e][n];i&&(t[g]=i)}),n.hideInEditor=!0,n.onLoaded()}),this._initMaterials()}):Promise.reject(Error(`Current device is requiring builtin shaders of version ${g} but shaders of that version are not assembled in this build.`))}get(t){return this._resources[t]}_initMaterials(){const t=this._resources,e=[],n=new i.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),t[n._uuid]=n,e.push(n);const s=new i.Material;s._uuid="missing-effect-material",s.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),s.setProperty("mainColor",i.color("#ffff00")),t[s._uuid]=s,e.push(s);const r=new i.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",i.color("#ff00ff")),t[r._uuid]=r,e.push(r);const o=new i.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),t[o._uuid]=o,e.push(o);const a=new i.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),t[a._uuid]=a,e.push(a);const c=new i.Material;c._uuid="ui-sprite-material",c.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[c._uuid]=c,e.push(c);const l=new i.Material;l._uuid="ui-alpha-test-material",l.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[l._uuid]=l,e.push(l);const h=new i.Material;h._uuid="ui-sprite-gray-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),t[h._uuid]=h,e.push(h);const _=new i.Material;_._uuid="ui-sprite-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),t[_._uuid]=_,e.push(_);const u=new i.Material;u._uuid="ui-sprite-gray-alpha-sep-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),t[u._uuid]=u,e.push(u);const d=new i.Material;d._uuid="ui-graphics-material",d.initialize({effectName:"graphics"}),t[d._uuid]=d,e.push(d);const p=new i.Material;p._uuid="default-particle-material",p.initialize({effectName:"particle"}),t[p._uuid]=p,e.push(p);const m=new i.Material;m._uuid="default-particle-gpu-material",m.initialize({effectName:"particle-gpu"}),t[m._uuid]=m,e.push(m);const f=new i.Material;f._uuid="default-trail-material",f.initialize({effectName:"particle-trail"}),t[f._uuid]=f,e.push(f);const g=new i.Material;g._uuid="default-billboard-material",g.initialize({effectName:"billboard"}),t[g._uuid]=g,e.push(g);const v=new i.Material;v._uuid="default-spine-material",v.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),t[v._uuid]=v,e.push(v),i.game.on(i.Game.EVENT_RENDERER_INITED,()=>{for(let t=0;t<e.length;++t){const n=e[t];for(let t=0;t<n.passes.length;++t)n.passes[t].tryCompile()}})}}),Id=(()=>{const t=new Map;let e=0;return n=>"number"==typeof n?n:(t.has(n)||(t.set(n,1<<e),e++),t.get(n))})(),Pd=new uo(Ys.UNIFORM|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE),Od=new po(null),Dd=new wo(null);let Md;!function(t){t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(Md||(Md={}));class Nd{static fillPipelineInfo(t,e){const n=t.handle;void 0!==e.priority&&hi.set(n,ci.PRIORITY,e.priority),void 0!==e.primitive&&hi.set(n,ci.PRIMITIVE,e.primitive),void 0!==e.stage&&hi.set(n,ci.STAGE,e.stage),void 0!==e.dynamicStates&&hi.set(n,ci.DYNAMIC_STATES,e.dynamicStates),void 0!==e.phase&&hi.set(n,ci.PHASE,Id(e.phase));const i=t._bs;if(e.blendState){const t=e.blendState,{targets:n}=t;n&&n.forEach((t,e)=>{i.setTarget(e,t)}),void 0!==t.isA2C&&(i.isA2C=t.isA2C),void 0!==t.isIndepend&&(i.isIndepend=t.isIndepend),void 0!==t.blendColor&&(i.blendColor=t.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)}static getPassHash(t,e){const n=t.handle;let i=`${e},${hi.get(n,ci.PRIMITIVE)},${hi.get(n,ci.DYNAMIC_STATES)}`;var s;return i+=function(t){let e=",bs,"+t.isA2C;for(const n of t.targets)e+=`,bt,${n.blend},${n.blendEq},${n.blendAlphaEq},${n.blendColorMask}`,e+=`,${n.blendSrc},${n.blendDst},${n.blendSrcAlpha},${n.blendDstAlpha}`;return e}(t._bs),i+=function(t){let e=`,dss,${t.depthTest},${t.depthWrite},${t.depthFunc}`;return e+=`,${t.stencilTestFront},${t.stencilFuncFront},${t.stencilRefFront},${t.stencilReadMaskFront}`,e+=`,${t.stencilFailOpFront},${t.stencilZFailOpFront},${t.stencilPassOpFront},${t.stencilWriteMaskFront}`,e+=`,${t.stencilTestBack},${t.stencilFuncBack},${t.stencilRefBack},${t.stencilReadMaskBack}`,e+=`,${t.stencilFailOpBack},${t.stencilZFailOpBack},${t.stencilPassOpBack},${t.stencilWriteMaskBack}`,e}(t._dss),i+=`,rs,${(s=t._rs).cullMode},${s.depthBias},${s.isFrontFaceCCW}`,vo(i,666)}constructor(t){this._rootBuffer=null,this._rootBufferDirty=!1,this._buffers=[],this._descriptorSet=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._root=void 0,this._device=void 0,this._hShaderDefault=0,this._handle=0,this._bs=new Kr,this._dss=new Xr,this._rs=new qr,this._root=t,this._device=t.device}initialize(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()}getHandle(t,e=0,n=qs.UNKNOWN){let i=this._propertyHandleMap[t];return i?(n?i=dd(i,n):e&&(i=dd(i,hd(i)-e)),i+e):0}getBinding(t){const e=this.getHandle(t);return e?Nd.getBindingFromHandle(e):-1}setUniform(t,e){const n=Nd.getBindingFromHandle(t),i=Nd.getTypeFromHandle(t),s=Nd.getOffsetFromHandle(t),r=this._blocks[n];md[i](r,e,s),this._rootBufferDirty=!0}getUniform(t,e){const n=Nd.getBindingFromHandle(t),i=Nd.getTypeFromHandle(t),s=Nd.getOffsetFromHandle(t),r=this._blocks[n];return pd[i](r,e,s)}setUniformArray(t,e){const n=Nd.getBindingFromHandle(t),i=Nd.getTypeFromHandle(t),s=zr(i)>>2,r=this._blocks[n];let o=Nd.getOffsetFromHandle(t);for(let t=0;t<e.length;t++,o+=s)null!==e[t]&&md[i](r,e[t],o);this._rootBufferDirty=!0}bindTexture(t,e,n){this._descriptorSet.bindTexture(t,e,n||0)}bindSampler(t,e,n){this._descriptorSet.bindSampler(t,e,n||0)}setDynamicState(t,e){const n=this._dynamics[t];n&&n.value===e||(n.value=e,n.dirty=!0)}overridePipelineStates(t,e){console.warn("base pass cannot override states, please use pass instance instead.")}update(){this._rootBufferDirty&&this._rootBuffer&&(this._rootBuffer.update(this._rootBlock),this._rootBufferDirty=!1),this._descriptorSet.update()}destroy(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBlock=null),this._descriptorSet=null,this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._handle&&(Kn.free(hi.get(this._handle,ci.DESCRIPTOR_SET)),hi.free(this._handle),this._handle=0)}resetUniform(t){const e=this.getHandle(t);if(!e)return;const n=Nd.getTypeFromHandle(e),i=Nd.getBindingFromHandle(e),s=Nd.getOffsetFromHandle(e),r=this._blocks[i],o=this._properties[t],a=o&&o.value||gd(n);md[n](r,a,s),this._rootBufferDirty=!0}resetTexture(t,e){const n=this.getHandle(t);if(!n)return;const i=Nd.getTypeFromHandle(n),s=Nd.getBindingFromHandle(n),r=this._properties[t],o=r&&r.value,a=o?o+"-texture":gd(i),c=Rd.get(a),l=c&&c.getGFXTexture(),h=r&&void 0!==r.samplerHash?r.samplerHash:c&&c.getSamplerHash(),_=z_.getSampler(this._device,h);this._descriptorSet.bindSampler(s,_,e),this._descriptorSet.bindTexture(s,l,e)}resetUBOs(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t],n=this._blocks[e.binding];let i=0;for(let t=0;t<e.members.length;t++){const s=e.members[t],r=this._properties[s.name],o=r&&r.value||gd(s.type),a=(zr(s.type)>>2)*s.count;for(let t=0;t+o.length<=a;t+=o.length)n.set(o,i+t);i+=a}}this._rootBufferDirty=!0}resetTextures(){for(let t=0;t<this._shaderInfo.samplers.length;t++){const e=this._shaderInfo.samplers[t];for(let t=0;t<e.count;t++)this.resetTexture(e.name,t)}}tryCompile(){const{pipeline:t}=this._root;return!!t&&(this._syncBatchingScheme(),this._hShaderDefault=bd.getGFXShader(this._device,this._programName,this._defines,t),this._hShaderDefault?(hi.set(this._handle,ci.PIPELINE_LAYOUT,bd.getTemplateInfo(this._programName).hPipelineLayout),hi.set(this._handle,ci.HASH,Nd.getPassHash(this,this._hShaderDefault)),!0):(console.warn(`create shader ${this._programName} failed`),!1))}getShaderVariant(t=null){if(!this._hShaderDefault&&!this.tryCompile())return console.warn("pass resources incomplete"),0;if(!t)return this._hShaderDefault;const{pipeline:e}=this._root;for(let e=0;e<t.length;e++){const n=t[e];this._defines[n.name]=n.value}const n=bd.getGFXShader(this._device,this._programName,this._defines,e);for(let e=0;e<t.length;e++){const n=t[e];delete this._defines[n.name]}return n}beginChangeStatesSilently(){}endChangeStatesSilently(){}_doInit(t,e=!1){const n=this._handle=hi.alloc();hi.set(n,ci.PRIORITY,Sc.DEFAULT),hi.set(n,ci.STAGE,xc.DEFAULT),hi.set(n,ci.PHASE,Id("default")),hi.set(n,ci.PRIMITIVE,Js.TRIANGLE_LIST),hi.set(n,ci.RASTERIZER_STATE,this._rs.handle),hi.set(n,ci.DEPTH_STENCIL_STATE,this._dss.handle),hi.set(n,ci.BLEND_STATE,this._bs.handle),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=e?{...t.defines}:t.defines,this._shaderInfo=bd.getTemplate(t.program),this._properties=t.properties||this._properties;const i=this._device;Nd.fillPipelineInfo(this,t),t.stateOverrides&&Nd.fillPipelineInfo(this,t.stateOverrides),Dd.layout=bd.getDescriptorSetLayout(this._device,t.program);const s=Kn.alloc(this._device,Dd);hi.set(this._handle,ci.DESCRIPTOR_SET,s),this._descriptorSet=Kn.get(s);const r=this._shaderInfo.blocks,o=bd.getTemplateInfo(t.program),{blockSizes:a,handleMap:c}=o,l=i.uboOffsetAlignment,h=[];let _=0,u=0;for(let t=0;t<r.length;t++){const e=a[t];h.push(u),u+=Math.ceil(e/l)*l,_=e}const d=h[h.length-1]+_;d&&(Pd.size=16*Math.ceil(d/16),this._rootBuffer=i.createBuffer(Pd),this._rootBlock=new ArrayBuffer(d));for(let t=0,e=0;t<r.length;t++){const{binding:n}=r[t],s=a[t];Od.buffer=this._rootBuffer,Od.offset=h[e++],Od.range=16*Math.ceil(s/16);const o=this._buffers[n]=i.createBuffer(Od);this._blocks[n]=new Float32Array(this._rootBlock,Od.offset,s/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(n,o)}const p=this._propertyHandleMap=c,m={};for(const t in this._properties){const e=this._properties[t];e.handleInfo&&(m[t]=this.getHandle.apply(this,e.handleInfo))}Object.assign(p,m)}_syncBatchingScheme(){this._defines.USE_INSTANCING?this._device.hasFeature(Rr.INSTANCED_ARRAYS)?hi.set(this._handle,ci.BATCHING_SCHEME,Md.INSTANCING):(this._defines.USE_INSTANCING=!1,hi.set(this._handle,ci.BATCHING_SCHEME,0)):this._defines.USE_BATCHING?hi.set(this._handle,ci.BATCHING_SCHEME,Md.VB_MERGING):hi.set(this._handle,ci.BATCHING_SCHEME,0)}_destroyHandle(){this._handle&&(hi.free(this._handle),this._handle=0)}_initPassFromTarget(t,e,n,i){hi.set(this.handle,ci.PRIORITY,t.priority),hi.set(this.handle,ci.STAGE,t.stage),hi.set(this.handle,ci.PHASE,t.phase),hi.set(this.handle,ci.BATCHING_SCHEME,t.batchingScheme),hi.set(this.handle,ci.PRIMITIVE,t.primitive),hi.set(this.handle,ci.DYNAMIC_STATES,t.dynamicStates),this._descriptorSet=t.descriptorSet,hi.set(this.handle,ci.DESCRIPTOR_SET,hi.get(t.handle,ci.DESCRIPTOR_SET)),this._bs=n,hi.set(this.handle,ci.BLEND_STATE,n.handle),this._rs=t.rasterizerState,hi.set(this.handle,ci.RASTERIZER_STATE,hi.get(t.handle,ci.RASTERIZER_STATE)),this._dss=e,hi.set(this.handle,ci.DEPTH_STENCIL_STATE,e.handle),this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._dynamics=t._dynamics,this._hShaderDefault=t._hShaderDefault,hi.set(this._handle,ci.PIPELINE_LAYOUT,bd.getTemplateInfo(this._programName).hPipelineLayout);const s=hi.get(t.handle,ci.HASH);hi.set(this._handle,ci.HASH,s^i)}get root(){return this._root}get device(){return this._device}get shaderInfo(){return this._shaderInfo}get localSetLayout(){return bd.getDescriptorSetLayout(this._device,this._programName,!0)}get program(){return this._programName}get properties(){return this._properties}get defines(){return this._defines}get passIndex(){return this._passIndex}get propertyIndex(){return this._propertyIndex}get dynamics(){return this._dynamics}get blocks(){return this._blocks}get handle(){return this._handle}get priority(){return hi.get(this._handle,ci.PRIORITY)}get primitive(){return hi.get(this._handle,ci.PRIMITIVE)}get stage(){return hi.get(this._handle,ci.STAGE)}get phase(){return hi.get(this._handle,ci.PHASE)}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get dynamicStates(){return hi.get(this._handle,ci.DYNAMIC_STATES)}get batchingScheme(){return hi.get(this._handle,ci.BATCHING_SCHEME)}get descriptorSet(){return this._descriptorSet}get hash(){return hi.get(this._handle,ci.HASH)}get rootBufferDirty(){return this._rootBufferDirty}}Nd.PropertyType=ad,Nd.getPropertyTypeFromHandle=ld,Nd.getTypeFromHandle=hd,Nd.getBindingFromHandle=_d,Nd.getOffsetFromHandle=ud;const Ld=new wo(null);class zd{constructor(){this._device=null,this._passes=null,this._subMesh=null,this._patches=null,this._handle=0,this._priority=Sc.DEFAULT,this._inputAssembler=null,this._descriptorSet=null}set passes(t){if(this._passes=t,this._flushPassInfo(),this._descriptorSet){Kn.free(di.get(this._handle,_i.DESCRIPTOR_SET)),Ld.layout=t[0].localSetLayout;const e=Kn.alloc(this._device,Ld);di.set(this._handle,_i.DESCRIPTOR_SET,e),this._descriptorSet=Kn.get(e)}}get passes(){return this._passes}set subMesh(t){this._subMesh=t,this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===Md.VB_MERGING&&this._subMesh.genFlatBuffers(),di.set(this._handle,_i.SUB_MESH,t.handle)}get subMesh(){return this._subMesh}set priority(t){this._priority=t,di.set(this._handle,_i.PRIORITY,t)}get priority(){return this._priority}get handle(){return this._handle}get inputAssembler(){return this._inputAssembler}get descriptorSet(){return this._descriptorSet}get patches(){return this._patches}get planarShaderHandel(){return di.get(this._handle,_i.PLANAR_SHADER)}initialize(t,e,n=null){this._device=i.director.root.device,this._subMesh=t,this._patches=n,this._passes=e,this._handle=di.alloc(),this._flushPassInfo(),e[0].batchingScheme===Md.VB_MERGING&&this._subMesh.genFlatBuffers(),Ld.layout=e[0].localSetLayout;const s=Kn.alloc(this._device,Ld),r=$n.alloc(this._device,t.iaInfo);di.set(this._handle,_i.PRIORITY,Sc.DEFAULT),di.set(this._handle,_i.INPUT_ASSEMBLER,r),di.set(this._handle,_i.DESCRIPTOR_SET,s),di.set(this._handle,_i.SUB_MESH,t.handle),this._inputAssembler=$n.get(r),this._descriptorSet=Kn.get(s)}initPlanarShadowShader(){const t=i.director.root.pipeline.shadows.getPlanarShader(this._patches);di.set(this._handle,_i.PLANAR_SHADER,t)}destroy(){Kn.free(di.get(this._handle,_i.DESCRIPTOR_SET)),$n.free(di.get(this._handle,_i.INPUT_ASSEMBLER)),di.free(this._handle),this._descriptorSet=null,this._inputAssembler=null,this._priority=Sc.DEFAULT,this._handle=0,this._patches=null,this._subMesh=null,this._passes=null}update(){for(let t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update()}onPipelineStateChanged(){const t=this._passes;if(t){for(let e=0;e<t.length;e++){const n=t[e];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}}onMacroPatchesStateChanged(t){this._patches=t;const e=this._passes;if(e){for(let t=0;t<e.length;t++){const n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}}_flushPassInfo(){const t=this._passes;if(!t)return;di.set(this._handle,_i.PASS_COUNT,t.length);let e=_i.PASS_0,n=_i.SHADER_0;for(let i=0;i<t.length;i++,e++,n++)di.set(this._handle,e,t[i].handle),di.set(this._handle,n,t[i].getShaderVariant(this._patches))}}class Bd{static get(t,e=0){const n=Bd._buffers;n.has(t)||n.set(t,{});const i=n.get(t);return i[e]||(i[e]=new Bd(t))}constructor(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}destroy(){for(let t=0;t<this.instances.length;++t){const e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0}merge(t,e,n,i=null){const s=e.buffer.length;if(!s)return;const r=t.inputAssembler,o=t.descriptorSet.getTexture(ll),a=di.get(t.handle,_i.SHADER_0+n),c=di.get(t.handle,_i.DESCRIPTOR_SET);for(let t=0;t<this.instances.length;++t){const n=this.instances[t];if(!(n.ia.indexBuffer!==r.indexBuffer||n.count>=1024)&&n.lightingMap===o){if(n.stride!==s)return;if(n.count>=n.capacity){n.capacity<<=1;const t=n.stride*n.capacity,e=n.data;n.data=new Uint8Array(t),n.data.set(e),n.vb.resize(t)}return n.hShader!==a&&(n.hShader=a),n.hDescriptorSet!==c&&(n.hDescriptorSet=c),n.data.set(e.buffer,n.stride*n.count++),void(this.hasPendingModels=!0)}}const l=this._device.createBuffer(new uo(Ys.VERTEX|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,32*s,s)),h=new Uint8Array(32*s),_=r.vertexBuffers.slice(),u=r.attributes.slice(),d=r.indexBuffer;for(let t=0;t<e.attributes.length;t++){const n=e.attributes[t],i=new Yo(n.name,n.format,n.isNormalized,_.length,!0);u.push(i)}h.set(e.buffer),_.push(l);const p=new Vo(u,_,d),m=this._device.createInputAssembler(p);this.instances.push({count:1,capacity:32,vb:l,data:h,ia:m,stride:s,hShader:a,hDescriptorSet:c,lightingMap:o}),this.hasPendingModels=!0}uploadBuffers(t){for(let e=0;e<this.instances.length;++e){const n=this.instances[e];n.count&&(n.ia.instanceCount=n.count,t.updateBuffer(n.vb,n.data))}}clear(){for(let t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1}}Bd._buffers=new Map;const Fd=new kn(Xn.ATTRIBUTE,(t,e)=>e||new Yo),Ud=new bn,Gd=new Jh(()=>new zd,32),Hd=[{name:"CC_RECEIVE_SHADOW",value:!0}];let Vd;!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(Vd||(Vd={}));const kd=L_([cr.LINEAR,cr.LINEAR,cr.NONE,lr.CLAMP,lr.CLAMP,lr.CLAMP]),jd=L_([cr.LINEAR,cr.LINEAR,cr.LINEAR,lr.CLAMP,lr.CLAMP,lr.CLAMP]);class Wd{get subModels(){return this._subModels}get inited(){return this._inited}get worldBounds(){return this._worldBounds}get modelBounds(){return this._modelBounds}get localBuffer(){return this._localBuffer}get updateStamp(){return this._updateStamp}get isInstancingEnabled(){return this._instMatWorldIdx>=0}get receiveShadow(){return!!fi.get(this._handle,pi.RECEIVE_SHADOW)}set receiveShadow(t){fi.set(this._handle,pi.RECEIVE_SHADOW,t?1:0),this.onMacroPatchesStateChanged()}get castShadow(){return!!fi.get(this._handle,pi.CAST_SHADOW)}set castShadow(t){fi.set(this._handle,pi.CAST_SHADOW,t?1:0)}get handle(){return this._handle}get node(){return this._node}set node(t){this._node=t,fi.set(this._handle,pi.NODE,t.handle)}get transform(){return this._transform}set transform(t){this._transform=t,fi.set(this._handle,pi.TRANSFORM,t.handle)}get visFlags(){return fi.get(this._handle,pi.VIS_FLAGS)}set visFlags(t){fi.set(this._handle,pi.VIS_FLAGS,t)}get enabled(){return!!fi.get(this._handle,pi.ENABLED)}set enabled(t){fi.set(this._handle,pi.ENABLED,t?1:0)}constructor(){this.type=Vd.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._handle=0,this._hWorldBounds=0,this._localData=new Float32Array(jc.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new dn,this._device=i.director.root.device}initialize(){if(!this._inited){this._handle=fi.alloc();const t=Qn.alloc(),e=ei.alloc();fi.set(this._handle,pi.INSTANCED_ATTR_ARRAY,e),fi.set(this._handle,pi.SUB_MODEL_ARRAY,t),fi.set(this._handle,pi.VIS_FLAGS,yc.Enum.NONE),fi.set(this._handle,pi.ENABLED,1),fi.set(this._handle,pi.RECEIVE_SHADOW,1),fi.set(this._handle,pi.CAST_SHADOW,0),this._inited=!0}}destroy(){const t=this._subModels;for(let e=0;e<t.length;e++){const t=this._subModels[e];t.destroy(),Gd.free(t)}if(this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._handle){const t=fi.get(this._handle,pi.SUB_MODEL_ARRAY);t&&Qn.free(t);const e=fi.get(this._handle,pi.INSTANCED_BUFFER);e&&oi.free(e);const n=fi.get(this._handle,pi.INSTANCED_ATTR_ARRAY);n&&qn(n,ei,Fd),fi.free(this._handle),this._handle=0}this._hWorldBounds&&(Ti.free(this._hWorldBounds),this._hWorldBounds=0)}attachToScene(t){this.scene=t}detachFromScene(){this.scene=null}updateTransform(t){const e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._transformUpdated=!0;const t=this._worldBounds;this._modelBounds&&t&&(this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t),Ti.setVec3(this._hWorldBounds,xi.CENTER,t.center),Ti.setVec3(this._hWorldBounds,xi.HALF_EXTENSION,t.halfExtents))}}updateWorldBound(){const t=this.transform;if(null!==t){t.updateWorldTransform(),this._transformUpdated=!0;const e=this._worldBounds;this._modelBounds&&e&&(this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e),Ti.setVec3(this._hWorldBounds,xi.CENTER,e.center),Ti.setVec3(this._hWorldBounds,xi.HALF_EXTENSION,e.halfExtents))}}updateUBOs(t){const e=this._subModels;for(let t=0;t<e.length;t++)e[t].update();if(this._updateStamp=t,!this._transformUpdated)return;this._transformUpdated=!1;const n=this.transform._mat,i=this._instMatWorldIdx;if(i>=0){const t=this.instancedAttributes.views;!function(t,e,n,i){e[0]=t.m00,e[1]=t.m01,e[2]=t.m02,e[3]=t.m12,n[0]=t.m04,n[1]=t.m05,n[2]=t.m06,n[3]=t.m13,i[0]=t.m08,i[1]=t.m09,i[2]=t.m10,i[3]=t.m14}(n,t[i],t[i+1],t[i+2])}else this._localBuffer&&(bn.toArray(this._localData,n,jc.MAT_WORLD_OFFSET),bn.inverseTranspose(Ud,n),bn.toArray(this._localData,Ud,jc.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData))}createBoundingShape(t,e){t&&e&&(this._modelBounds=nc.fromPoints(nc.create(),t,e),this._worldBounds=nc.clone(this._modelBounds),0===this._hWorldBounds&&(this._hWorldBounds=Ti.alloc(),fi.set(this._handle,pi.WORLD_BOUNDS,this._hWorldBounds)),Ti.setVec3(this._hWorldBounds,xi.CENTER,this._worldBounds.center),Ti.setVec3(this._hWorldBounds,xi.HALF_EXTENSION,this._worldBounds.halfExtents))}initSubModel(t,e,n){this.initialize();let i=!1;if(null==this._subModels[t]?(this._subModels[t]=Gd.alloc(),i=!0):this._subModels[t].destroy(),this._subModels[t].initialize(e,n.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._updateAttributesAndBinding(t),i){const e=fi.get(this._handle,pi.SUB_MODEL_ARRAY);Qn.assign(e,t,this._subModels[t].handle)}}setSubModelMesh(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)}setSubModelMaterial(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))}onGlobalPipelineStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onPipelineStateChanged()}onMacroPatchesStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))}updateLightingmap(t,e){dn.toArray(this._localData,e,jc.LIGHTINGMAP_UVPARAM),this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=Rd.get("empty-texture"));const n=t.getGFXTexture();if(n){const e=z_.getSampler(this._device,t.mipmaps.length>1?jd:kd),i=this._subModels;for(let t=0;t<i.length;t++){const{descriptorSet:s}=i[t];s.bindTexture(ll,n),s.bindSampler(ll,e),s.update()}}}getMacroPatches(t){return this.receiveShadow?Hd:null}_updateAttributesAndBinding(t){const e=this._subModels[t];if(!e)return;this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet);const n=Yn.get(di.get(e.handle,_i.SHADER_0));this._updateInstancedAttributes(n.attributes,e.passes[0])}_getInstancedAttributeIndex(t){const{attributes:e}=this.instancedAttributes;for(let n=0;n<e.length;n++)if(e[n].name===t)return n;return-1}_updateInstancedAttributes(t,e){if(!e.device.hasFeature(Rr.INSTANCED_ARRAYS))return;const n=fi.get(this._handle,pi.INSTANCED_BUFFER);n&&oi.free(n);const i=fi.get(this._handle,pi.INSTANCED_ATTR_ARRAY);i&&qn(i,ei,Fd,!1);let s=0;for(let e=0;e<t.length;e++){const n=t[e];n.isInstanced&&(s+=Dr[n.format].size)}const r=oi.alloc(s),o=oi.getBuffer(r);fi.set(this._handle,pi.INSTANCED_BUFFER,r);const a=this.instancedAttributes;a.buffer=new Uint8Array(o),a.views.length=a.attributes.length=0;let c=0;for(let e=0;e<t.length;e++){const n=t[e];if(!n.isInstanced)continue;const s=Fd.alloc(),r=Fd.get(s);r.format=n.format,r.name=n.name,r.isNormalized=n.isNormalized,r.location=n.location,a.attributes.push(r),ei.push(i,s);const l=Dr[n.format];a.views.push(new(Br(l))(o,c,l.count)),c+=l.size}e.batchingScheme===Md.INSTANCING&&Bd.get(e).destroy(),this._instMatWorldIdx=this._getInstancedAttributeIndex("a_matWorld0"),this._transformUpdated=!0}_initLocalDescriptors(t){this._localBuffer||(this._localBuffer=this._device.createBuffer(new uo(Ys.UNIFORM|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,jc.SIZE,jc.SIZE)))}_updateLocalDescriptors(t,e){this._localBuffer&&e.bindBuffer(jc.BINDING,this._localBuffer)}}var qd,Xd,Yd,Kd,$d,Zd,Jd,Qd;let tp=t("EffectAsset",Yl("cc.EffectAsset")((Qd=Jd=class t extends y_{constructor(...t){super(...t),Ul(this,"techniques",Yd,this),Ul(this,"shaders",Kd,this),Ul(this,"combinations",$d,this),Ul(this,"hideInEditor",Zd,this)}static register(e){t._effects[e.name]=e}static remove(e){if(t._effects[e])delete t._effects[e];else for(const n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}static get(e){if(t._effects[e])return t._effects[e];for(const n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null}static getAll(){return t._effects}onLoaded(){bd.register(this),t.register(this),i.game.once(i.Game.EVENT_ENGINE_INITED,this._precompile,this)}_precompile(){const t=i.director.root;for(let e=0;e<this.shaders.length;e++){const n=this.shaders[e],i=this.combinations[e];i&&Object.keys(i).reduce((t,e)=>t.reduce((t,n)=>{const s=i[e],r=[n].concat([...Array(s.length-1)].map(()=>({...n})));return r.forEach((t,n)=>t[e]=s[n]),t.concat(r)},[]),[{}]).forEach(e=>bd.getGFXShader(t.device,n.name,e,t.pipeline))}}destroy(){return t.remove(this.name),super.destroy()}},Jd._effects={},Yd=Gl((Xd=Qd).prototype,"techniques",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kd=Gl(Xd.prototype,"shaders",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$d=Gl(Xd.prototype,"combinations",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zd=Gl(Xd.prototype,"hideInEditor",[Ql,th],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qd=Xd))||qd);var ep,np,ip,sp,rp,op,ap,cp,lp;i.EffectAsset=tp;const hp=new it("RenderTex"),_p=new yo;_p.endLayout=yr.SHADER_READONLY_OPTIMAL;const up=new xo,dp=new So([_p],up),pp={width:1,height:1,renderPassInfo:dp};let mp=t("RenderTexture",(ep=Yl("cc.RenderTexture"),np=dh(),ip=ph(),sp=dh(),rp=ph(),ep((cp=Gl((ap=class extends y_{constructor(){super(),Ul(this,"_width",cp,this),Ul(this,"_height",lp,this),this._textureHash=0,this._id=void 0,this._window=null,this._id=hp.getNewId(),this._textureHash=vo(this._id,666)}getHash(){return this._textureHash}get width(){return this._width}get height(){return this._height}get window(){return this._window}initialize(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)}reset(t){this.initialize(t)}destroy(){return this._window&&(i.director.root.destroyWindow(this._window),this._window=null),super.destroy()}resize(t,e){this._width=t,this._height=e,this._window&&this._window.resize(t,e),this.emit("resize",this._window)}getGFXTexture(){return this._window&&this._window.framebuffer.colorTextures[0]}getGFXSampler(){const t=i.director.root;return z_.getSampler(t.device,D_)}getSamplerHash(){return D_}onLoaded(){this._initWindow(),this.loaded=!0,this.emit("load")}_initWindow(t){const e=i.director.root;pp.title=this._name,pp.width=this._width,pp.height=this._height,pp.renderPassInfo=t&&t.passInfo?t.passInfo:dp,this._window?(this._window.destroy(),this._window.initialize(e.device,pp)):this._window=e.createWindow(pp)}}).prototype,"_width",[Ql,np,ip],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lp=Gl(ap.prototype,"_height",[Ql,sp,rp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),op=ap))||op));var fp,gp,vp,yp,xp,Sp,Tp,Ep,Cp;i.RenderTexture=mp;let Ap=t("Material",(fp=Yl("cc.Material"),gp=Ah(tp),fp((xp=Gl((yp=class t extends y_{static getHash(t){let e=0;for(const n of t.passes)e^=n.hash;return e}constructor(){super(),Ul(this,"_effectAsset",xp,this),Ul(this,"_techIdx",Sp,this),Ul(this,"_defines",Tp,this),Ul(this,"_states",Ep,this),Ul(this,"_props",Cp,this),this._passes=[],this._hash=0,this.loaded=!1}get effectAsset(){return this._effectAsset}get effectName(){return this._effectAsset?this._effectAsset.name:""}get technique(){return this._techIdx}get passes(){return this._passes}get hash(){return this._hash}get parent(){return null}get owner(){return null}initialize(t){this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=tp.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states),this._update()}reset(t){this.initialize(t)}destroy(){return this._doDestroy(),super.destroy()}recompileShaders(t,e){console.warn(`Shaders in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}overridePipelineStates(t,e){console.warn(`Pipeline states in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}onLoaded(){this._update(),this.loaded=!0,this.emit("load")}resetUniforms(t=!0){this._props.length=this._passes.length;for(let t=0;t<this._props.length;t++)this._props[t]={};if(t)for(const t of this._passes)t.resetUBOs(),t.resetTextures()}setProperty(t,e,n){let i=!1;if(void 0===n){const n=this._passes,s=n.length;for(let r=0;r<s;r++){const s=n[r];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,i=!0)}}else{if(n>=this._passes.length)return void console.warn(`illegal pass index: ${n}.`);const s=this._passes[n];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,i=!0)}i||console.warn(`illegal property name: ${t}.`)}getProperty(t,e){if(void 0===e){const e=this._props,n=e.length;for(let i=0;i<n;i++){const n=e[i];if(t in n)return n[t]}}else{if(e>=this._props.length)return console.warn(`illegal pass index: ${e}.`),null;const n=this._props[this._passes[e].propertyIndex];if(t in n)return n[t]}return null}copy(t){this._techIdx=t._techIdx,this._props.length=t._props.length;for(let e=0;e<t._props.length;e++)this._props[e]={...t._props[e]};this._defines.length=t._defines.length;for(let e=0;e<t._defines.length;e++)this._defines[e]={...t._defines[e]};this._states.length=t._states.length;for(let e=0;e<t._states.length;e++)this._states[e]={...t._states[e]};this._effectAsset=t._effectAsset,this._update()}_prepareInfo(t,e){let n=t;if(!Array.isArray(n)){const t=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(t).fill(n)}for(let t=0;t<n.length;++t)Object.assign(e[t]||(e[t]={}),n[t])}_createPasses(){const t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];const e=t.passes.length,n=[];for(let s=0;s<e;++s){const e=t.passes[s],r=e.passIndex=s,o=e.defines=this._defines[r]||(this._defines[r]={}),a=e.stateOverrides=this._states[r]||(this._states[r]={});if(void 0!==e.propertyIndex&&(Object.assign(o,this._defines[e.propertyIndex]),Object.assign(a,this._states[e.propertyIndex])),void 0!==e.embeddedMacros&&Object.assign(o,e.embeddedMacros),e.switch&&!o[e.switch])continue;const c=new Nd(i.director.root);c.initialize(e),n.push(c)}return n}_update(e=!0){if(this._effectAsset){if(this._passes&&this._passes.length)for(const t of this._passes)t.destroy();this._passes=this._createPasses();const t=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=t,e)this._passes.forEach((t,e)=>{let n=this._props[e];n||(n=this._props[e]={}),void 0!==t.propertyIndex&&Object.assign(n,this._props[t.propertyIndex]);for(const e in n)this._uploadProperty(t,e,n[e])});else for(let t=0;t<this._props.length;t++)this._props[t]={}}else{const t=Rd.get("missing-effect-material");t&&(this._passes=t._passes.slice())}this._hash=t.getHash(this)}_uploadProperty(t,e,n){const i=t.getHandle(e);if(!i)return!1;const s=Nd.getPropertyTypeFromHandle(i);if(s===ad.UBO)Array.isArray(n)?t.setUniformArray(i,n):null!==n?t.setUniform(i,n):t.resetUniform(e);else if(s===ad.SAMPLER)if(Array.isArray(n))for(let e=0;e<n.length;e++)this._bindTexture(t,i,n[e],e);else n?this._bindTexture(t,i,n):t.resetTexture(e);return!0}_bindTexture(t,e,n,i){const s=Nd.getBindingFromHandle(e);if(n instanceof Wo)t.bindTexture(s,n,i);else if(n instanceof $_||n instanceof mp){const e=n.getGFXTexture();if(!e||!e.width||!e.height)return;t.bindTexture(s,e,i),t.bindSampler(s,n.getGFXSampler(),i)}}_doDestroy(){if(this._passes&&this._passes.length)for(const t of this._passes)t.destroy();this._effectAsset=null,this._passes.length=0,this._props.length=0,this._defines.length=0,this._states.length=0}}).prototype,"_effectAsset",[gp],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sp=Gl(yp.prototype,"_techIdx",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Tp=Gl(yp.prototype,"_defines",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ep=Gl(yp.prototype,"_states",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cp=Gl(yp.prototype,"_props",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vp=yp))||vp));i.Material=Ap;const bp=jt({Planar:0,ShadowMap:1}),wp=jt({HARD:0,FILTER_X5:1,FILTER_X9:2,FILTER_X25:3}),Rp=bp.ShadowMap+1;class Ip{get enabled(){return!!Ji.get(this._handle,$i.ENABLE)}set enabled(t){Ji.set(this._handle,$i.ENABLE,t?1:0),t||Ji.set(this._handle,$i.TYPE,Rp),this.activate()}get normal(){return this._normal}set normal(t){ln.copy(this._normal,t),Ji.setVec3(this._handle,$i.NORMAL,this._normal)}get distance(){return Ji.get(this._handle,$i.DISTANCE)}set distance(t){Ji.set(this._handle,$i.DISTANCE,t)}get shadowColor(){return this._shadowColor}set shadowColor(t){this._shadowColor=t,Ji.setVec4(this._handle,$i.COLOR,t)}get type(){return Ji.get(this._handle,$i.TYPE)}set type(t){Ji.set(this._handle,$i.TYPE,this.enabled?t:Rp),this.activate()}get near(){return Ji.get(this._handle,$i.NEAR)}set near(t){Ji.set(this._handle,$i.NEAR,t)}get far(){return Ji.get(this._handle,$i.FAR)}set far(t){Ji.set(this._handle,$i.FAR,t)}get aspect(){return Ji.get(this._handle,$i.ASPECT)}set aspect(t){Ji.set(this._handle,$i.ASPECT,t)}get orthoSize(){return Ji.get(this._handle,$i.ORTHO_SIZE)}set orthoSize(t){Ji.set(this._handle,$i.ORTHO_SIZE,t)}get size(){return this._size}set size(t){this._size=t,Ji.setVec2(this._handle,$i.SIZE,this._size)}get pcf(){return Ji.get(this._handle,$i.PCF_TYPE)}set pcf(t){Ji.set(this._handle,$i.PCF_TYPE,t)}get shadowMapDirty(){return!!Ji.get(this._handle,$i.SHADOW_MAP_DIRTY)}set shadowMapDirty(t){Ji.set(this._handle,$i.SHADOW_MAP_DIRTY,t?1:0)}get bias(){return Ji.get(this._handle,$i.BIAS)}set bias(t){Ji.set(this._handle,$i.BIAS,t)}get autoAdapt(){return!!Ji.get(this._handle,$i.AUTO_ADAPT)}set autoAdapt(t){Ji.set(this._handle,$i.AUTO_ADAPT,t?1:0)}get matLight(){return this._matLight}get material(){return this._material}get instancingMaterial(){return this._instancingMaterial}get handle(){return this._handle}constructor(){this.sphere=new Vs(0,0,0,.01),this.maxReceived=4,this._normal=new ln(0,1,0),this._shadowColor=new Ln(0,0,0,76),this._matLight=new bn,this._material=null,this._instancingMaterial=null,this._size=new rn(512,512),this._handle=0,this._handle=Ji.alloc()}getPlanarShader(t){return this._material||(this._material=new Ap,this._material.initialize({effectName:"planar-shadow"}),Ji.set(this._handle,$i.PLANAR_PASS,this._material.passes[0].handle)),this._material.passes[0].getShaderVariant(t)}initialize(t){Ji.set(this._handle,$i.TYPE,t.enabled?t.type:Rp),Ji.set(this._handle,$i.NEAR,t.near),Ji.set(this._handle,$i.FAR,t.far),Ji.set(this._handle,$i.ASPECT,t.aspect),Ji.set(this._handle,$i.ORTHO_SIZE,t.orthoSize),this._size=t.shadowMapSize,Ji.setVec2(this._handle,$i.SIZE,this._size),Ji.set(this._handle,$i.PCF_TYPE,t.pcf),ln.copy(this._normal,t.normal),Ji.setVec3(this._handle,$i.NORMAL,this._normal),Ji.set(this._handle,$i.DISTANCE,t.distance),this._shadowColor.set(t.shadowColor),Ji.setVec4(this._handle,$i.COLOR,this._shadowColor),Ji.set(this._handle,$i.BIAS,t.bias),Ji.set(this._handle,$i.ENABLE,t.enabled?1:0),this.maxReceived=t.maxReceived,Ji.set(this._handle,$i.AUTO_ADAPT,t.autoAdapt?1:0)}activate(){if(this.enabled)this.type===bp.ShadowMap?this._updatePipeline():this._updatePlanarInfo();else{const t=i.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=0,t.onGlobalPipelineStateChanged()}}_updatePlanarInfo(){this._material||(this._material=new Ap,this._material.initialize({effectName:"planar-shadow"}),Ji.set(this._handle,$i.PLANAR_PASS,this._material.passes[0].handle)),this._instancingMaterial||(this._instancingMaterial=new Ap,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),Ji.set(this._handle,$i.INSTANCE_PASS,this._instancingMaterial.passes[0].handle));const t=i.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=0,t.onGlobalPipelineStateChanged()}_updatePipeline(){const t=i.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=1,t.onGlobalPipelineStateChanged()}destroy(){this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this._handle&&(Ji.free(this._handle),this._handle=0),this.sphere.destroy()}}Ip.MAX_FAR=2e3,Ip.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),i.Shadows=Ip;class Pp{get root(){return this._root}get name(){return this._name}get cameras(){return this._cameras}get mainLight(){return this._mainLight}get sphereLights(){return this._sphereLights}get spotLights(){return this._spotLights}get models(){return this._models}get handle(){return this._scenePoolHandle}get batches(){return this._batches}static registerCreateFunc(t){t._createSceneFun=t=>new Pp(t)}constructor(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._scenePoolHandle=0,this._modelArrayHandle=0,this._batchArrayHandle=0,this._sphereLightsHandle=0,this._spotLightsHandle=0,this._root=t,this._createHandles()}initialize(t){return this._name=t.name,this._createHandles(),!0}update(t){const e=this._mainLight;e&&e.update();const n=this._sphereLights;for(let t=0;t<n.length;t++)n[t].update();const i=this._spotLights;for(let t=0;t<i.length;t++)i[t].update();const s=this._models;for(let e=0;e<s.length;e++){const n=s[e];n.enabled&&(n.updateTransform(t),n.updateUBOs(t))}}destroy(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._modelArrayHandle&&(ti.free(this._modelArrayHandle),this._modelArrayHandle=0),this._scenePoolHandle&&(Ai.free(this._scenePoolHandle),this._scenePoolHandle=0),this._sphereLightsHandle&&(ii.free(this._sphereLightsHandle),this._sphereLightsHandle=0),this._spotLightsHandle&&(ii.free(this._spotLightsHandle),this._spotLightsHandle=0),this._batchArrayHandle&&(ri.free(this._batchArrayHandle),this._batchArrayHandle=0)}addCamera(t){t.attachToScene(this),this._cameras.push(t)}removeCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()}removeCameras(){for(const t of this._cameras)t.detachFromScene();this._cameras.splice(0)}setMainLight(t){this._mainLight=t,Ai.set(this._scenePoolHandle,Ei.MAIN_LIGHT,t.handle)}unsetMainLight(t){if(this._mainLight===t){const t=this._directionalLights;t.length?(this._mainLight=t[t.length-1],this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Ol.ROTATION)):this._mainLight=null}}addDirectionalLight(t){t.attachToScene(this),this._directionalLights.push(t)}removeDirectionalLight(t){for(let e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)}addSphereLight(t){t.attachToScene(this),this._sphereLights.push(t),ii.push(this._sphereLightsHandle,t.handle)}removeSphereLight(t){for(let e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),this._sphereLights.splice(e,1),void ii.erase(this._sphereLightsHandle,e)}addSpotLight(t){t.attachToScene(this),this._spotLights.push(t),ii.push(this._spotLightsHandle,t.handle)}removeSpotLight(t){for(let e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),this._spotLights.splice(e,1),void ii.erase(this._spotLightsHandle,e)}removeSphereLights(){for(let t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0,ii.clear(this._sphereLightsHandle)}removeSpotLights(){for(let t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[],ii.clear(this._spotLightsHandle)}addModel(t){t.attachToScene(this),this._models.push(t),ti.push(this._modelArrayHandle,t.handle)}removeModel(t){for(let e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),this._models.splice(e,1),void ti.erase(this._modelArrayHandle,e)}removeModels(){for(const t of this._models)t.detachFromScene(),t.destroy();this._models.length=0,ti.clear(this._modelArrayHandle)}addBatch(t){this._batches.push(t),ri.push(this._batchArrayHandle,t.handle)}removeBatch(t){for(let e=0;e<this._batches.length;++e)if(this._batches[e]===t)return this._batches.splice(e,1),void ri.erase(this._batchArrayHandle,e)}removeBatches(){this._batches.length=0,ri.clear(this._batchArrayHandle)}onGlobalPipelineStateChanged(){for(const t of this._models)t.onGlobalPipelineStateChanged()}generateModelId(){return this._modelId++}_createHandles(){this._modelArrayHandle||(this._modelArrayHandle=ti.alloc(),this._scenePoolHandle=Ai.alloc(),Ai.set(this._scenePoolHandle,Ei.MODEL_ARRAY,this._modelArrayHandle),this._spotLightsHandle=ii.alloc(),Ai.set(this._scenePoolHandle,Ei.SPOT_LIGHT_ARRAY,this._spotLightsHandle),this._sphereLightsHandle=ii.alloc(),Ai.set(this._scenePoolHandle,Ei.SPHERE_LIGHT_ARRAY,this._sphereLightsHandle)),this._batchArrayHandle||(this._batchArrayHandle=ri.alloc(),Ai.set(this._scenePoolHandle,Ei.BATCH_ARRAY_2D,this._batchArrayHandle))}}class Op extends Nd{get parent(){return this._parent}constructor(t,e){super(t.root),this._parent=void 0,this._owner=void 0,this._dontNotify=!1,this._parent=t,this._owner=e,this._doInit(this._parent,!0);for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t],n=this._blocks[e.binding],i=this._parent.blocks[e.binding];n.set(i)}this._rootBufferDirty=!0;const n=this._parent;for(let t=0;t<this._shaderInfo.samplers.length;t++){const e=this._shaderInfo.samplers[t];for(let t=0;t<e.count;t++){const i=n._descriptorSet.getSampler(e.binding,t),s=n._descriptorSet.getTexture(e.binding,t);this._descriptorSet.bindSampler(e.binding,i,t),this._descriptorSet.bindTexture(e.binding,s,t)}}super.tryCompile()}overridePipelineStates(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),Nd.fillPipelineInfo(this,t),Nd.fillPipelineInfo(this,e),this._onStateChange()}tryCompile(t){if(t&&!vd(this._defines,t))return!1;const e=super.tryCompile();return this._onStateChange(),e}beginChangeStatesSilently(){this._dontNotify=!0}endChangeStatesSilently(){this._dontNotify=!1}_syncBatchingScheme(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,hi.set(this._handle,ci.BATCHING_SCHEME,0)}_onStateChange(){hi.set(this._handle,ci.HASH,Nd.getPassHash(this,this._hShaderDefault)),this._owner.onPassStateChange(this._dontNotify)}}class Dp extends Ap{get parent(){return this._parent}get owner(){return this._owner}constructor(t){super(),this._passes=[],this._parent=void 0,this._owner=void 0,this._subModelIdx=0,this._parent=t.parent,this._owner=t.owner||null,this._subModelIdx=t.subModelIdx||0,this.copy(this._parent)}recompileShaders(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(const e of this._passes)e.tryCompile(t);else this._passes[e].tryCompile(t)}overridePipelineStates(t,e){if(!this._passes||!this.effectAsset)return;const n=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(let e=0;e<this._passes.length;e++){const i=this._passes[e],s=this._states[e]||(this._states[e]={});for(const e in t)s[e]=t[e];i.overridePipelineStates(n[i.passIndex],s)}else{const i=this._states[e]||(this._states[e]={});for(const e in t)i[e]=t[e];this._passes[e].overridePipelineStates(n[e],i)}}destroy(){return this._doDestroy(),!0}onPassStateChange(t){this._hash=Ap.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}_createPasses(){const t=[],e=this._parent.passes;if(!e)return t;for(let n=0;n<e.length;++n)t.push(new Op(e[n],this));return t}}let Mp=null,Np=null;class Lp{get model(){return this._model}get enabled(){return qi.get(this._handle,ji.ENABLE)}set enabled(t){t?this.activate():this._updatePipeline(),qi.set(this._handle,ji.ENABLE,t?1:0)}get useIBL(){return qi.get(this._handle,ji.USE_IBL)}set useIBL(t){qi.set(this._handle,ji.USE_IBL,t?1:0),this._updatePipeline()}get isRGBE(){return qi.get(this._handle,ji.IS_RGBE)}set isRGBE(t){t&&(Np&&Np.recompileShaders({USE_RGBE_CUBEMAP:t}),this._model&&this._model.setSubModelMaterial(0,Np)),qi.set(this._handle,ji.IS_RGBE,t?1:0),this._updatePipeline()}get envmap(){return this._envmap}set envmap(t){this._envmap=t||this._default,this._envmap&&(i.director.root.pipeline.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}get handle(){return this._handle}constructor(){this._envmap=null,this._globalDescriptorSet=null,this._model=null,this._default=null,this._handle=0,this._handle=qi.alloc()}initialize(t){qi.set(this._handle,ji.ENABLE,t.enabled?1:0),qi.set(this._handle,ji.USE_IBL,t.useIBL?1:0),qi.set(this._handle,ji.IS_RGBE,t.isRGBE?1:0),this._envmap=t.envmap}activate(){const t=i.director.root.pipeline;if(this._globalDescriptorSet=t.descriptorSet,this._default=Rd.get("default-cube-texture"),this._model||(this._model=i.director.root.createModel(i.renderer.scene.Model),this._model._initLocalDescriptors=()=>{}),qi.set(this._handle,ji.MODEL,this._model.handle),this._envmap||(this._envmap=this._default),t.ambient.groundAlbedo[3]=this._envmap.mipmapLevel,Np)Np.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{const t=new Ap;t.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),Np=new Dp({parent:t})}this.enabled&&(Mp||(Mp=i.utils.createMesh(i.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,Mp.renderingSubMeshes[0],Np)),this._updateGlobalBinding(),this._updatePipeline()}_updatePipeline(){const t=this.useIBL?this.isRGBE?2:1:0,e=i.director.root,n=e.pipeline;n.macros.CC_USE_IBL!==t&&(n.macros.CC_USE_IBL=t,e.onGlobalPipelineStateChanged())}_updateGlobalBinding(){const t=this.envmap.getGFXTexture(),e=z_.getSampler(i.director._device,this.envmap.getSamplerHash());this._globalDescriptorSet.bindSampler(Fc,e),this._globalDescriptorSet.bindTexture(Fc,t)}destroy(){this._handle&&(qi.free(this._handle),this._handle=0)}}i.Skybox=Lp;class zp extends Ll{get position(){return this._pos}set size(t){es.set(this._handle,Qi.SIZE,t)}get size(){return es.get(this._handle,Qi.SIZE)}set range(t){es.set(this._handle,Qi.RANGE,t),this._needUpdate=!0}get range(){return es.get(this._handle,Qi.RANGE)}set luminance(t){es.set(this._handle,Qi.ILLUMINANCE,t)}get luminance(){return es.get(this._handle,Qi.ILLUMINANCE)}get aabb(){return this._aabb}constructor(){super(),this._needUpdate=!1,this._pos=void 0,this._aabb=void 0,this._hAABB=0,this._aabb=nc.create(),this._pos=new ln}initialize(){super.initialize(),this._hAABB=Ti.alloc(),es.set(this._handle,Qi.TYPE,Dl.SPHERE),es.set(this._handle,Qi.SIZE,.15),es.set(this._handle,Qi.RANGE,1),es.set(this._handle,Qi.AABB,this._hAABB),es.set(this._handle,Qi.ILLUMINANCE,1700/Nl(.15))}update(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);const t=es.get(this._handle,Qi.RANGE);nc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1,es.setVec3(this._handle,Qi.POSITION,this._pos),Ti.setVec3(this._hAABB,xi.CENTER,this._aabb.center),Ti.setVec3(this._hAABB,xi.HALF_EXTENSION,this._aabb.halfExtents)}}destroy(){return this._hAABB&&(Ti.free(this._hAABB),this._hAABB=0),super.destroy()}}const Bp=new ln(0,0,-1),Fp=new vn,Up=new bn,Gp=new bn,Hp=new bn,Vp=new bn;class kp extends Ll{get position(){return this._pos}set size(t){es.set(this._handle,Qi.SIZE,t)}get size(){return es.get(this._handle,Qi.SIZE)}set range(t){this._range=t,es.set(this._handle,Qi.RANGE,t),this._needUpdate=!0}get range(){return es.get(this._handle,Qi.RANGE)}set luminance(t){es.set(this._handle,Qi.ILLUMINANCE,t)}get luminance(){return es.get(this._handle,Qi.ILLUMINANCE)}get direction(){return this._dir}get spotAngle(){return es.get(this._handle,Qi.SPOT_ANGLE)}set spotAngle(t){this._angle=t,es.set(this._handle,Qi.SPOT_ANGLE,Math.cos(.5*t)),this._needUpdate=!0}set aspect(t){es.set(this._handle,Qi.ASPECT,t),this._needUpdate=!0}get aspect(){return es.get(this._handle,Qi.ASPECT)}get aabb(){return this._aabb}get frustum(){return this._frustum}constructor(){super(),this._dir=new ln(1,-1,-1),this._range=5,this._spotAngle=Math.cos(Math.PI/6),this._pos=void 0,this._aabb=void 0,this._frustum=void 0,this._angle=0,this._needUpdate=!1,this._hAABB=0,this._hFrustum=0,this._aabb=nc.create(),this._frustum=cc.create(),this._pos=new ln}initialize(){super.initialize(),this._hAABB=Ti.alloc(),this._hFrustum=Gi.alloc(),es.set(this._handle,Qi.TYPE,Dl.SPOT),es.set(this._handle,Qi.SIZE,.15),es.set(this._handle,Qi.AABB,this._hAABB),es.set(this._handle,Qi.ILLUMINANCE,1700/Nl(.15)),es.set(this._handle,Qi.RANGE,Math.cos(Math.PI/6)),es.set(this._handle,Qi.ASPECT,1),es.setVec3(this._handle,Qi.DIRECTION,this._dir)}update(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),ln.transformQuat(this._dir,Bp,this._node.getWorldRotation(Fp)),ln.normalize(this._dir,this._dir),es.setVec3(this._handle,Qi.DIRECTION,this._dir),nc.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(Up),bn.invert(Up,Up),bn.perspective(Gp,this._angle,1,.001,this._range),bn.multiply(Hp,Gp,Up),this._frustum.update(Hp,Vp),this._needUpdate=!1,es.setVec3(this._handle,Qi.POSITION,this._pos),Ti.setVec3(this._hAABB,xi.CENTER,this._aabb.center),Ti.setVec3(this._hAABB,xi.HALF_EXTENSION,this._aabb.halfExtents),lc(this._hFrustum,this._frustum))}destroy(){return this._hAABB&&(Ti.free(this._hAABB),this._hAABB=0),this._hFrustum&&(Gi.free(this._hFrustum),this._hFrustum=0),super.destroy()}}var jp=Object.freeze({__proto__:null,Ambient:Ts,get CameraFOVAxis(){return fl},get CameraProjection(){return gl},get CameraAperture(){return vl},get CameraISO(){return yl},get CameraShutter(){return xl},SKYBOX_FLAG:wl,Camera:Il,DirectionalLight:Fl,ColorTemperatureToRGB:Ml,get LightType(){return Dl},nt2lm:Nl,Light:Ll,get ModelType(){return Vd},Model:Wd,ShadowType:bp,PCFType:wp,Shadows:Ip,RenderScene:Pp,Skybox:Lp,SphereLight:zp,SpotLight:kp,SubModel:zd});let Wp,qp;function Xp(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function Yp(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(Wp||(Wp={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}(qp||(qp={}));class Kp{constructor(t){this._device=void 0,this._format=Xs.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Wr,this._region1=new Wr,this._region2=new Wr,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}initialize(t){const e=Dr[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=Br(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)}destroy(){for(let t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0}alloc(t,e){t=Yp(t,this._alignment);let n=-1,i=-1;if(void 0!==e&&(n=e,i=this._findAvailableSpace(t,n)),i<0)for(let e=0;e<this._chunkCount&&(n=e,i=this._findAvailableSpace(t,n),!(i>=0));++e);if(i>=0){const e=this._chunks[n];e.start+=t;const s={chunkIdx:n,start:i,end:i+t,texture:e.texture};return this._handles.push(s),s}const s=Math.sqrt(t/this._formatSize),r=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,Xp(s)),o=this._chunks[this.createChunk(r)];o.start+=t;const a={chunkIdx:this._chunkCount-1,start:0,end:t,texture:o.texture};return this._handles.push(a),a}free(t){for(let e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)}createChunk(t){const e=t*t*this._formatSize;console.info(`TextureBufferPool: Allocate chunk ${this._chunkCount}, size: ${e}, format: ${this._format}`);const n={texture:this._device.createTexture(new eo(hr.TEX2D,_r.SAMPLED|_r.TRANSFER_DST,this._format,t,t,dr.IMMUTABLE)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=n,this._chunkCount++}update(t,e){const n=[],i=[],s=t.start/this._formatSize;let r=e.byteLength/this._formatSize,o=s%t.texture.width,a=Math.floor(s/t.texture.width),c=Math.min(t.texture.width-o,r),l=0;o>0&&(this._region0.texOffset.x=o,this._region0.texOffset.y=a,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region0),o=0,a+=1,r-=c,l+=c),r>0&&(this._region1.texOffset.x=o,this._region1.texOffset.y=a,r>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(r/t.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=r,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(e,l*this._formatSize,c*this._channels)),i.push(this._region1),o=0,a+=this._region1.texExtent.height,r-=c,l+=c),r>0&&(this._region2.texOffset.x=o,this._region2.texOffset.y=a,this._region2.texExtent.width=r,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(e,l*this._formatSize,r*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,t.texture,i)}_findAvailableSpace(t,e){const n=this._chunks[e];let i=!1,s=n.start;if(s+t<=n.size)i=!0;else{s=0;const r=this._handles.filter(t=>t.chunkIdx===e).sort((t,e)=>t.start-e.start);for(let e=0;e<r.length;e++){const n=r[e];if(s+t<=n.start){i=!0;break}s=n.end}!i&&s+t<=n.size&&(i=!0)}return i?s:-1}_McDonaldAlloc(t){t=Yp(t,this._alignment);for(let e=0;e<this._chunkCount;++e){const n=this._chunks[e];let i=!1,s=n.start;if(s+t<=n.end?i=!0:s>n.end?s+t<=n.size?i=!0:t<=n.end&&(n.start=s=0,i=!0):s===n.end&&(n.start=s=0,n.end=n.size,t<=n.end&&(i=!0)),i){n.start+=t;const i={chunkIdx:e,start:s,end:s+t,texture:n.texture};return this._handles.push(i),i}}const e=Math.sqrt(t/this._formatSize),n=this._roundUpFn&&this._roundUpFn(e,this._formatSize)||Math.max(1024,Xp(e)),i=this._chunks[this.createChunk(n)];i.start+=t;const s={chunkIdx:this._chunkCount,start:0,end:t,texture:i.texture};return this._handles.push(s),s}}const $p=W.addStage;var Zp=Object.freeze({__proto__:null,addStage:$p,scene:jp,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;const n=[],i=e.positions.length/3;for(let t=0;t<i;++t)n.push(e.positions[3*t],e.positions[3*t+1],e.positions[3*t+2]),e.normals&&n.push(e.normals[3*t],e.normals[3*t+1],e.normals[3*t+2]),e.uvs&&n.push(e.uvs[2*t],e.uvs[2*t+1]),e.colors&&n.push(e.colors[3*t],e.colors[3*t+1],e.colors[3*t+2]);const s=[];s.push(new Yo(Ws.ATTR_POSITION,Xs.RGB32F)),e.normals&&s.push(new Yo(Ws.ATTR_NORMAL,Xs.RGB32F)),e.uvs&&s.push(new Yo(Ws.ATTR_TEX_COORD,Xs.RG32F)),e.colors&&s.push(new Yo(Ws.ATTR_COLOR,Xs.RGB32F));const r=t.createBuffer(new uo(Ys.VERTEX|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,4*n.length,4*n.length/i));r.update(new Float32Array(n));let o=null;return e.indices&&(o=t.createBuffer(new uo(Ys.INDEX|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,2*e.indices.length,2)),o.update(new Uint16Array(e.indices))),t.createInputAssembler(new Vo(s,[r],o))},get RenderQueue(){return Wp},get PassStage(){return qp},get PropertyType(){return ad},genHandle:cd,getPropertyTypeFromHandle:ld,getTypeFromHandle:hd,getSetIndexFromHandle:t=>(3145728&t)>>>20,getBindingFromHandle:_d,getOffsetFromHandle:ud,customizeType:dd,type2reader:pd,type2writer:md,getDefaultFromType:gd,overrideMacros:vd,get BatchingSchemes(){return Md},Pass:Nd,getDeviceShaderVersion:Ad,programLib:bd,get SamplerInfoIndex(){return I_},defaultSamplerHash:D_,genSamplerHash:L_,samplerLib:z_,nearestPOT:Xp,TextureBufferPool:Kp,MaterialInstance:Dp,PassInstance:Op,ObjectPool:kn,freeHandleArray:qn,get PoolType(){return Xn},NULL_HANDLE:0,ShaderPool:Yn,DSPool:Kn,IAPool:$n,PipelineLayoutPool:Zn,FramebufferPool:Jn,SubModelArrayPool:Qn,ModelArrayPool:ti,AttributeArrayPool:ei,FlatBufferArrayPool:ni,LightArrayPool:ii,BlendTargetArrayPool:si,UIBatchArrayPool:ri,RawBufferPool:oi,RawObjectPool:ai,get PassView(){return ci},PassPool:hi,get SubModelView(){return _i},SubModelPool:di,get ModelView(){return pi},ModelPool:fi,get BatchView2D(){return gi},BatchPool2D:yi,get AABBView(){return xi},AABBPool:Ti,get SceneView(){return Ei},ScenePool:Ai,get CameraView(){return bi},CameraPool:Ri,get NodeView(){return Ii},NodePool:Oi,get RootView(){return Di},RootPool:Ni,get RenderWindowView(){return Li},RenderWindowPool:Bi,get FrustumView(){return Fi},FrustumPool:Gi,get AmbientView(){return Hi},AmbientPool:ki,get SkyboxView(){return ji},SkyboxPool:qi,get FogView(){return Xi},FogPool:Ki,get ShadowsView(){return $i},ShadowsPool:Ji,get LightView(){return Qi},LightPool:es,get SphereView(){return ns},SpherePool:ss,get FlatBufferView(){return rs},FlatBufferPool:as,get SubMeshView(){return cs},SubMeshPool:hs,get RasterizerStateView(){return _s},RasterizerStatePool:ds,get DepthStencilStateView(){return ps},DepthStencilStatePool:fs,get BlendTargetView(){return gs},BlendTargetPool:vs,get BlendStateView(){return ys},BlendStatePool:Ss});function Jp(t){return t*t}function Qp(t){return t*(2-t)}function tm(t){return t*t*t}function em(t){return--t*t*t+1}function nm(t){return t*t*t*t}function im(t){return 1- --t*t*t*t}function sm(t){return t*t*t*t*t}function rm(t){return--t*t*t*t*t+1}function om(t){return 1-Math.cos(t*Math.PI/2)}function am(t){return Math.sin(t*Math.PI/2)}function cm(t){return 0===t?0:Math.pow(1024,t-1)}function lm(t){return 1===t?1:1-Math.pow(2,-10*t)}function hm(t){return 1-Math.sqrt(1-t*t)}function _m(t){return Math.sqrt(1- --t*t)}function um(t){let e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function dm(t){let e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function pm(t){const e=1.70158;return t*t*((e+1)*t-e)}function mm(t){const e=1.70158;return--t*t*((e+1)*t+e)+1}function fm(t){return 1-gm(1-t)}function gm(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}t("renderer",Zp);const vm=Rm(Jp,Qp),ym=Rm(tm,em),xm=Rm(nm,im),Sm=Rm(sm,rm),Tm=Rm(om,am),Em=Rm(cm,lm),Cm=Rm(hm,_m),Am=Rm(um,dm),bm=Rm(pm,mm),wm=Rm(fm,gm);function Rm(t,e){return n=>n<.5?e(2*n)/2:t(2*n-1)/2+.5}var Im,Pm=Object.freeze({__proto__:null,constant:function(){return 0},linear:function(t){return t},quadIn:Jp,quadOut:Qp,quadInOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)},cubicIn:tm,cubicOut:em,cubicInOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)},quartIn:nm,quartOut:im,quartInOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)},quintIn:sm,quintOut:rm,quintInOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)},sineIn:om,sineOut:am,sineInOut:function(t){return.5*(1-Math.cos(Math.PI*t))},expoIn:cm,expoOut:lm,expoInOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))},circIn:hm,circOut:_m,circInOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)},elasticIn:um,elasticOut:dm,elasticInOut:function(t){let e,n=.1;return 0===t?0:1===t?1:(!n||n<1?(n=1,e=.1):e=.4*Math.asin(1/n)/(2*Math.PI),(t*=2)<1?n*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)},backIn:pm,backOut:mm,backInOut:function(t){const e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)},bounceIn:fm,bounceOut:gm,bounceInOut:function(t){return t<.5?.5*fm(2*t):.5*gm(2*t-1)+.5},smooth:function(t){return t<=0?0:t>=1?1:t*t*(3-2*t)},fade:function(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)},quadOutIn:vm,cubicOutIn:ym,quartOutIn:xm,quintOutIn:Sm,sineOutIn:Tm,expoOutIn:Em,circOutIn:Cm,elasticOutIn:Am,backOutIn:bm,bounceOutIn:wm});t("easing",Pm),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(Im||(Im={}));const Om=t("sys",{NetworkType:Im,LANGUAGE_ENGLISH:"en",LANGUAGE_CHINESE:"zh",LANGUAGE_FRENCH:"fr",LANGUAGE_ITALIAN:"it",LANGUAGE_GERMAN:"de",LANGUAGE_SPANISH:"es",LANGUAGE_DUTCH:"du",LANGUAGE_RUSSIAN:"ru",LANGUAGE_KOREAN:"ko",LANGUAGE_JAPANESE:"ja",LANGUAGE_HUNGARIAN:"hu",LANGUAGE_PORTUGUESE:"pt",LANGUAGE_ARABIC:"ar",LANGUAGE_NORWEGIAN:"no",LANGUAGE_POLISH:"pl",LANGUAGE_TURKISH:"tr",LANGUAGE_UKRAINIAN:"uk",LANGUAGE_ROMANIAN:"ro",LANGUAGE_BULGARIAN:"bg",LANGUAGE_UNKNOWN:"unknown",OS_IOS:"iOS",OS_ANDROID:"Android",OS_WINDOWS:"Windows",OS_LINUX:"Linux",OS_OSX:"OS X",OS_UNKNOWN:"Unknown",UNKNOWN:-1,WIN32:0,LINUX:1,MACOS:2,ANDROID:3,IPHONE:4,IPAD:5,BLACKBERRY:6,NACL:7,EMSCRIPTEN:8,TIZEN:9,WINRT:10,WP8:11,MOBILE_BROWSER:100,DESKTOP_BROWSER:101,EDITOR_PAGE:102,EDITOR_CORE:103,WECHAT_GAME:104,QQ_PLAY:105,FB_PLAYABLE_ADS:106,BAIDU_MINI_GAME:107,VIVO_MINI_GAME:108,OPPO_MINI_GAME:109,HUAWEI_QUICK_GAME:110,XIAOMI_QUICK_GAME:111,COCOSPLAY:112,ALIPAY_MINI_GAME:113,QTT_MINI_GAME:116,BYTEDANCE_MINI_GAME:117,LINKSURE_MINI_GAME:119,BROWSER_TYPE_WECHAT:"wechat",BROWSER_TYPE_ANDROID:"androidbrowser",BROWSER_TYPE_IE:"ie",BROWSER_TYPE_EDGE:"edge",BROWSER_TYPE_QQ:"qqbrowser",BROWSER_TYPE_MOBILE_QQ:"mqqbrowser",BROWSER_TYPE_UC:"ucbrowser",BROWSER_TYPE_UCBS:"ucbs",BROWSER_TYPE_360:"360browser",BROWSER_TYPE_BAIDU_APP:"baiduboxapp",BROWSER_TYPE_BAIDU:"baidubrowser",BROWSER_TYPE_MAXTHON:"maxthon",BROWSER_TYPE_OPERA:"opera",BROWSER_TYPE_OUPENG:"oupeng",BROWSER_TYPE_MIUI:"miuibrowser",BROWSER_TYPE_FIREFOX:"firefox",BROWSER_TYPE_SAFARI:"safari",BROWSER_TYPE_CHROME:"chrome",BROWSER_TYPE_LIEBAO:"liebao",BROWSER_TYPE_QZONE:"qzone",BROWSER_TYPE_SOUGOU:"sogou",BROWSER_TYPE_HUAWEI:"huawei",BROWSER_TYPE_UNKNOWN:"unknown",isNative:!1,isBrowser:"object"==typeof window&&"object"==typeof document,isMobile:!1,isLittleEndian:(()=>{const t=new ArrayBuffer(2);return new DataView(t).setInt16(0,256,!0),256===new Int16Array(t)[0]})(),platform:-1,language:"unknown",languageCode:"unknown",os:"Unknown",osVersion:"",osMainVersion:0,browserType:"unknown",browserVersion:"",windowPixelResolution:null,capabilities:null,localStorage:null,__audioSupport:null,__videoSupport:null,getNetworkType:()=>Im.LAN,getBatteryLevel:()=>1,garbageCollect(){},isObjectValid:t=>null!=t,dump(){let t="";t+=`isMobile : ${this.isMobile}\r\n`,t+=`language : ${this.language}\r\n`,t+=`browserType : ${this.browserType}\r\n`,t+=`browserVersion : ${this.browserVersion}\r\n`,t+=`capabilities : ${JSON.stringify(this.capabilities)}\r\n`,t+=`os : ${this.os}\r\n`,t+=`osVersion : ${this.osVersion}\r\n`,t+=`platform : ${this.platform}\r\n`,t+=`Using ${i.game.renderType===i.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS"} renderer.\r\n`,h(t)},openURL(t){window.open(t)},now:()=>Date.now?Date.now():+new Date,restartVM(){},getSafeAreaRect(){const t=i.view.getVisibleSize();return i.rect(0,0,t.width,t.height)},__init(){const t=window,e=t.navigator,n=document,i=n.documentElement,s=e.userAgent.toLowerCase();Om.isMobile=/mobile|android|iphone|ipad/.test(s),Om.platform=Om.isMobile?Om.MOBILE_BROWSER:Om.DESKTOP_BROWSER;let r=e.language;Om.languageCode=r.toLowerCase(),r=r||e.browserLanguage,r=r?r.split("-")[0]:Om.LANGUAGE_ENGLISH,Om.language=r;let o=!1,a=!1,c="",l=0,h=/android\s*(\d+(?:\.\d+)*)/i.exec(s)||/android\s*(\d+(?:\.\d+)*)/i.exec(e.platform);h&&(o=!0,c=h[1]||"",l=parseInt(c)||0),h=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(s),h?(a=!0,c=h[2]||"",l=parseInt(c)||0):(/(iPhone|iPad|iPod)/.exec(e.platform)||"MacIntel"===e.platform&&e.maxTouchPoints&&e.maxTouchPoints>1)&&(a=!0,c="",l=0);let _=Om.OS_UNKNOWN;-1!==e.appVersion.indexOf("Win")?_=Om.OS_WINDOWS:a?_=Om.OS_IOS:-1!==e.appVersion.indexOf("Mac")?_=Om.OS_OSX:-1!==e.appVersion.indexOf("X11")&&-1===e.appVersion.indexOf("Linux")?_=Om.OS_UNIX:o?_=Om.OS_ANDROID:-1===e.appVersion.indexOf("Linux")&&-1===s.indexOf("ubuntu")||(_=Om.OS_LINUX),Om.os=_,Om.osVersion=c,Om.osMainVersion=l,Om.browserType=Om.BROWSER_TYPE_UNKNOWN,function(){const t=/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(s)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(s)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(s);let e=t?t[0].toLowerCase():Om.BROWSER_TYPE_UNKNOWN;("safari"===e&&o||"qq"===e&&/android.*applewebkit/i.test(s))&&(e=Om.BROWSER_TYPE_ANDROID);const n={micromessenger:Om.BROWSER_TYPE_WECHAT,trident:Om.BROWSER_TYPE_IE,edge:Om.BROWSER_TYPE_EDGE,"360 aphone":Om.BROWSER_TYPE_360,mxbrowser:Om.BROWSER_TYPE_MAXTHON,"opr/":Om.BROWSER_TYPE_OPERA,ubrowser:Om.BROWSER_TYPE_UC,huaweibrowser:Om.BROWSER_TYPE_HUAWEI};Om.browserType=n[e]||e}(),Om.browserVersion="",function(){let t=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(s);t||(t=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(s)),Om.browserVersion=t?t[4]:""}();const u=window.innerWidth||document.documentElement.clientWidth,d=window.innerHeight||document.documentElement.clientHeight,p=window.devicePixelRatio||1;Om.windowPixelResolution={width:p*u,height:p*d};const m=document.createElement("canvas");try{let e=Om.localStorage=t.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(t){const e=function(){x(5200)};Om.localStorage={getItem:e,setItem:e,removeItem:e,clear:e}}let f;try{f=m.toDataURL("image/webp").startsWith("data:image/webp")}catch(t){f=!1}const g=!!m.getContext("2d");let y=!1;t.WebGLRenderingContext&&(y=!0);const S=Om.capabilities={canvas:g,opengl:y,webp:f,imageBitmap:!1,touches:!1,mouse:!1,keyboard:!1,accelerometer:!1};let T;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(m.width=m.height=2,createImageBitmap(m,{}).then(t=>{S.imageBitmap=!0,t.close&&t.close()}).catch(()=>{})),(void 0!==i.ontouchstart||void 0!==n.ontouchstart||e.msPointerEnabled)&&(S.touches=!0),void 0!==i.onmouseup&&(S.mouse=!0),void 0!==i.onkeyup&&(S.keyboard=!0),(t.DeviceMotionEvent||t.DeviceOrientationEvent)&&(S.accelerometer=!0),function(){const t=!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext);T={ONLY_ONE:!1,WEB_AUDIO:t,DELAY_CREATE_CTX:!1},Om.os===Om.OS_IOS&&(T.USE_LOADER_EVENT="loadedmetadata"),Om.browserType===Om.BROWSER_TYPE_FIREFOX&&(T.DELAY_CREATE_CTX=!0,T.USE_LOADER_EVENT="canplay"),Om.os===Om.OS_ANDROID&&Om.browserType===Om.BROWSER_TYPE_UC&&(T.ONE_SOURCE=!0)}();try{T.WEB_AUDIO&&(T._context=null,Object.defineProperty(T,"context",{get(){return this._context?this._context:this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}}))}catch(t){T.WEB_AUDIO=!1,v(5201)}const E=[];!function(){const t=document.createElement("audio");t.canPlayType&&(t.canPlayType('audio/ogg; codecs="vorbis"')&&E.push(".ogg"),t.canPlayType("audio/mpeg")&&E.push(".mp3"),t.canPlayType('audio/wav; codecs="1"')&&E.push(".wav"),t.canPlayType("audio/mp4")&&E.push(".mp4"),t.canPlayType("audio/x-m4a")&&E.push(".m4a"))}(),T.format=E,Om.__audioSupport=T,Om.__videoSupport={format:[]},function(){const t=document.createElement("video");if(t.canPlayType){const e=["mp4","webm"],n=Om.__videoSupport.format;e.forEach(e=>{t.canPlayType("video/"+e)&&n.push("."+e)}),Om.__videoSupport.format=n}}(),Om.__isWebIOS14OrIPadOS14Env=(Om.os===Om.OS_IOS||Om.os===Om.MACOS)&&Om.isBrowser&&/(OS 1[4-9])|(Version\/1[4-9])/.test(window.navigator.userAgent)}});i.sys=Om,nr.getPhaseID=Id;const Dm=t("RenderPipeline",nr.RenderPipeline),Mm=(t("RenderFlow",nr.RenderFlow),t("RenderStage",nr.RenderStage),t("ForwardPipeline",nr.ForwardPipeline)),Nm=(t("ForwardFlow",nr.ForwardFlow),t("ForwardStage",nr.ForwardStage),t("ShadowFlow",nr.ShadowFlow),t("ShadowStage",nr.ShadowStage),t("InstancedBuffer",nr.InstancedBuffer),t("PipelineStateManager",nr.PipelineStateManager)),Lm={topLeft:i.v2(0,0),topRight:i.v2(0,0),top:i.v2(0,0),bottomLeft:i.v2(0,0),bottomRight:i.v2(0,0),bottom:i.v2(0,0),center:i.v2(0,0),left:i.v2(0,0),right:i.v2(0,0),width:0,height:0,init(t){const e=this.width=t.width,n=this.height=t.height,i=t.x,s=t.y,r=s+n,o=i+e;this.topLeft.x=i,this.topLeft.y=r,this.topRight.x=o,this.topRight.y=r,this.top.x=i+e/2,this.top.y=r,this.bottomLeft.x=i,this.bottomLeft.y=s,this.bottomRight.x=o,this.bottomRight.y=s,this.bottom.x=i+e/2,this.bottom.y=s,this.center.x=i+e/2,this.center.y=s+n/2,this.left.x=i,this.left.y=s+n/2,this.right.x=o,this.right.y=s+n/2}};i.visibleRect=Lm;const zm=new rn;class Bm extends Zh{constructor(t,e,n){super(Zh.MOUSE,e),this.movementX=0,this.movementY=0,this.eventType=void 0,this._button=Bm.BUTTON_MISSING,this._x=0,this._y=0,this._prevX=0,this._prevY=0,this._scrollX=0,this._scrollY=0,this.eventType=t,n&&(this._prevX=n.x,this._prevY=n.y)}setScrollData(t,e){this._scrollX=t,this._scrollY=e}getScrollX(){return this._scrollX}getScrollY(){return this._scrollY}setLocation(t,e){this._x=t,this._y=e}getLocation(t){return t||(t=new rn),rn.set(t,this._x,this._y),t}getLocationInView(t){return t||(t=new rn),rn.set(t,this._x,i.view._designResolutionSize.height-this._y),t}getUILocation(t){return t||(t=new rn),rn.set(t,this._x,this._y),i.view._convertPointWithScale(t),t}getPreviousLocation(t){return t||(t=new rn),rn.set(t,this._prevX,this._prevY),t}getUIPreviousLocation(t){return t||(t=new rn),rn.set(t,this._prevX,this._prevY),i.view._convertPointWithScale(t),t}getDelta(t){return t||(t=new rn),rn.set(t,this._x-this._prevX,this._y-this._prevY),t}getDeltaX(){return this._x-this._prevX}getDeltaY(){return this._y-this._prevY}getUIDelta(t){return t||(t=new rn),rn.set(t,(this._x-this._prevX)/i.view.getScaleX(),(this._y-this._prevY)/i.view.getScaleY()),t}getUIDeltaX(){return(this._x-this._prevX)/i.view.getScaleX()}getUIDeltaY(){return(this._y-this._prevY)/i.view.getScaleY()}setButton(t){this._button=t}getButton(){return this._button}getLocationX(){return this._x}getLocationY(){return this._y}getUILocationX(){const t=i.view.getViewportRect();return(this._x-t.x)/i.view.getScaleX()}getUILocationY(){const t=i.view.getViewportRect();return(this._y-t.y)/i.view.getScaleY()}}t("EventMouse",Bm),Bm.NONE=0,Bm.DOWN=1,Bm.UP=2,Bm.MOVE=3,Bm.SCROLL=4,Bm.BUTTON_MISSING=-1,Bm.BUTTON_LEFT=0,Bm.BUTTON_RIGHT=2,Bm.BUTTON_MIDDLE=1,Bm.BUTTON_4=3,Bm.BUTTON_5=4,Bm.BUTTON_6=5,Bm.BUTTON_7=6,Bm.BUTTON_8=7;class Fm extends Zh{constructor(t,e,n,i){super(Zh.TOUCH,e),this.touch=null,this.simulate=!1,this._eventCode=void 0,this._touches=void 0,this._allTouches=void 0,this._eventCode=n||0,this._touches=t||[],this._allTouches=i||[]}getEventCode(){return this._eventCode}getTouches(){return this._touches}getAllTouches(){return this._allTouches}setLocation(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)}getLocation(t){return this.touch?this.touch.getLocation(t):new rn}getUILocation(t){return this.touch?this.touch.getUILocation(t):new rn}getLocationInView(t){return this.touch?this.touch.getLocationInView(t):new rn}getPreviousLocation(t){return this.touch?this.touch.getPreviousLocation(t):new rn}getStartLocation(t){return this.touch?this.touch.getStartLocation(t):new rn}getUIStartLocation(t){return this.touch?this.touch.getUIStartLocation(t):new rn}getID(){return this.touch?this.touch.getID():null}getDelta(t){return this.touch?this.touch.getDelta(t):new rn}getUIDelta(t){return this.touch?this.touch.getUIDelta(t):new rn}getDeltaX(){return this.touch?this.touch.getDelta(zm).x:0}getDeltaY(){return this.touch?this.touch.getDelta(zm).y:0}getLocationX(){return this.touch?this.touch.getLocationX():0}getLocationY(){return this.touch?this.touch.getLocationY():0}}t("EventTouch",Fm),Fm.MAX_TOUCHES=5,Fm.BEGAN=0,Fm.MOVED=1,Fm.ENDED=2,Fm.CANCELLED=3;class Um extends Zh{constructor(t,e){super(Zh.ACCELERATION,e),this.acc=void 0,this.acc=t}}t("EventAcceleration",Um);class Gm extends Zh{constructor(t,e,n){super(Zh.KEYBOARD,n),this.keyCode=void 0,this.rawEvent=void 0,this.isPressed=void 0,"number"==typeof t?this.keyCode=t:(this.keyCode=t.keyCode,this.rawEvent=t),this.isPressed=e}}t("EventKeyboard",Gm),Zh.EventMouse=Bm,Zh.EventTouch=Fm,Zh.EventAcceleration=Um,Zh.EventKeyboard=Gm;class Hm{static create(t){C(t&&t.event,1900);const e=t.event;delete t.event;let n=null;if(e===i.EventListener.TOUCH_ONE_BY_ONE?n=new jm:e===i.EventListener.TOUCH_ALL_AT_ONCE?n=new Wm:e===i.EventListener.MOUSE?n=new km:e===i.EventListener.KEYBOARD?n=new Xm:e===i.EventListener.ACCELERATION&&(n=new qm(t.callback),delete t.callback),n)for(const e of Object.keys(t))n[e]=t[e];return n}get onEvent(){return this._onEvent}constructor(t,e,n){this._cameraPriority=0,this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=n,this._type=t||0,this._listenerID=e||""}_setPaused(t){this._paused=t}_isPaused(){return this._paused}_setRegistered(t){this._registered=t}_isRegistered(){return this._registered}_getType(){return this._type}_getListenerID(){return this._listenerID}_setFixedPriority(t){this._fixedPriority=t}_getFixedPriority(){return this._fixedPriority}_setSceneGraphPriority(t){this._target=t,this._node=t}_getSceneGraphPriority(){return this._node}checkAvailable(){return null!==this._onEvent}clone(){return null}setEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}}Hm.UNKNOWN=0,Hm.TOUCH_ONE_BY_ONE=1,Hm.TOUCH_ALL_AT_ONCE=2,Hm.KEYBOARD=3,Hm.MOUSE=4,Hm.ACCELERATION=6,Hm.CUSTOM=8,Hm.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};const Vm=Hm.ListenerID;class km extends Hm{constructor(){super(Hm.MOUSE,Vm.MOUSE,null),this.onMouseDown=null,this.onMouseUp=null,this.onMouseMove=null,this.onMouseScroll=null,this._onEvent=t=>this._callback(t)}_callback(t){const e=i.Event.EventMouse;switch(t.eventType){case e.DOWN:this.onMouseDown&&this.onMouseDown(t);break;case e.UP:this.onMouseUp&&this.onMouseUp(t);break;case e.MOVE:this.onMouseMove&&this.onMouseMove(t);break;case e.SCROLL:this.onMouseScroll&&this.onMouseScroll(t)}}clone(){const t=new km;return t.onMouseDown=this.onMouseDown,t.onMouseUp=this.onMouseUp,t.onMouseMove=this.onMouseMove,t.onMouseScroll=this.onMouseScroll,t}checkAvailable(){return!0}}class jm extends Hm{constructor(){super(Hm.TOUCH_ONE_BY_ONE,Vm.TOUCH_ONE_BY_ONE,null),this.swallowTouches=!1,this.onTouchBegan=null,this.onTouchMoved=null,this.onTouchEnded=null,this.onTouchCancelled=null,this._claimedTouches=[]}setSwallowTouches(t){this.swallowTouches=t}isSwallowTouches(){return this.swallowTouches}clone(){const t=new jm;return t.onTouchBegan=this.onTouchBegan,t.onTouchMoved=this.onTouchMoved,t.onTouchEnded=this.onTouchEnded,t.onTouchCancelled=this.onTouchCancelled,t.swallowTouches=this.swallowTouches,t}checkAvailable(){return!!this.onTouchBegan||(v(1801),!1)}}class Wm extends Hm{constructor(){super(Hm.TOUCH_ALL_AT_ONCE,Vm.TOUCH_ALL_AT_ONCE,null),this.onTouchesBegan=null,this.onTouchesMoved=null,this.onTouchesEnded=null,this.onTouchesCancelled=null}clone(){const t=new Wm;return t.onTouchesBegan=this.onTouchesBegan,t.onTouchesMoved=this.onTouchesMoved,t.onTouchesEnded=this.onTouchesEnded,t.onTouchesCancelled=this.onTouchesCancelled,t}checkAvailable(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(v(1802),!1)}}class qm extends Hm{constructor(t){super(Hm.ACCELERATION,Vm.ACCELERATION,null),this._onAccelerationEvent=null,this._onEvent=t=>this._callback(t),this._onAccelerationEvent=t}_callback(t){this._onAccelerationEvent&&this._onAccelerationEvent(t.acc,t)}checkAvailable(){return C(this._onAccelerationEvent,1803),!0}clone(){return new qm(this._onAccelerationEvent)}}class Xm extends Hm{constructor(){super(Hm.KEYBOARD,Vm.KEYBOARD,null),this.onKeyPressed=null,this.onKeyReleased=null,this._onEvent=t=>this._callback(t)}_callback(t){t.isPressed?this.onKeyPressed&&this.onKeyPressed(t.keyCode,t):this.onKeyReleased&&this.onKeyReleased(t.keyCode,t)}clone(){const t=new Xm;return t.onKeyPressed=this.onKeyPressed,t.onKeyReleased=this.onKeyReleased,t}checkAvailable(){return null!==this.onKeyPressed||null!==this.onKeyReleased||(v(1800),!1)}}i.EventListener=Hm;const Ym=Hm.ListenerID;class Km{constructor(){this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}size(){return this._fixedListeners.length+this._sceneGraphListeners.length}empty(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}push(t){0===t._getFixedPriority()?this._sceneGraphListeners.push(t):this._fixedListeners.push(t)}clearSceneGraphListeners(){this._sceneGraphListeners.length=0}clearFixedListeners(){this._fixedListeners.length=0}clear(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}getFixedPriorityListeners(){return this._fixedListeners}getSceneGraphPriorityListeners(){return this._sceneGraphListeners}}const $m=t("eventManager",new class{constructor(){this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners={},this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}pauseTarget(t,e=!1){if(!(t instanceof i._BaseNode))return void x(3506);const n=this._nodeListenersMap[t.uuid];if(n)for(let t=0;t<n.length;++t)n[t]._setPaused(!0);if(!0===e){const e=t.children;if(e)for(let t=0;t<e.length;++t){const n=e[t];this.pauseTarget(n,!0)}}}resumeTarget(t,e=!1){if(!(t instanceof i._BaseNode))return void x(3506);const n=this._nodeListenersMap[t.uuid];if(n)for(let t=0;t<n.length;++t)n[t]._setPaused(!1);if(this._setDirtyForNode(t),!0===e&&t.children.length>0){const e=t.children;if(e)for(let t=0;t<e.length;++t){const n=e[t];this.resumeTarget(n,!0)}}}frameUpdateListeners(){const t=this._listenersMap,e=this._priorityDirtyFlagMap;for(const n in t)t[n].empty()&&(delete e[n],delete t[n]);const n=this._toAddedListeners;if(0!==n.length){for(let t=0,e=n.length;t<e;t++)this._forceAddEventListener(n[t]);n.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}hasEventListener(t){return!!this._getListeners(t)}addListener(t,e){if(C(t&&e,3503),!(i.js.isNumber(e)||e instanceof i._BaseNode))return x(3506),null;if(t instanceof i.EventListener){if(t._isRegistered())return v(3505),null}else C(!i.js.isNumber(e),3504),t=i.EventListener.create(t);if(!t.checkAvailable())return null;if(i.js.isNumber(e)){if(0===e)return v(3500),null;t._setSceneGraphPriority(null),t._setFixedPriority(e),t._setRegistered(!0),t._setPaused(!1),this._addListener(t)}else{if(!(n=e)||!n.getComponent("cc.UITransform"))return v(3512),null;t._setSceneGraphPriority(e),t._setFixedPriority(0),t._setRegistered(!0),this._addListener(t)}var n;return t}addCustomListener(t,e){const n=Hm.create({event:i.EventListener.CUSTOM,eventName:t,callback:e});return this.addListener(n,1),n}removeListener(t){if(null==t)return;let e=!1;const n=this._listenersMap;for(const i in n){const s=n[i],r=s.getFixedPriorityListeners(),o=s.getSceneGraphPriorityListeners();if(e=this._removeListenerInVector(o,t),e?this._setDirty(t._getListenerID(),2):(e=this._removeListenerInVector(r,t),e&&this._setDirty(t._getListenerID(),1)),s.empty()&&(delete this._priorityDirtyFlagMap[t._getListenerID()],delete n[i]),e)break}if(!e){const e=this._toAddedListeners;for(let n=e.length-1;n>=0;n--){const s=e[n];if(s===t){i.js.array.removeAt(e,n),s._setRegistered(!1);break}}}}removeListeners(t,e=!1){if(i.js.isNumber(t)||t instanceof i._BaseNode)if(void 0!==t._id){const n=this._nodeListenersMap[t._id];if(n){const e=i.js.array.copy(n);for(let t=0;t<e.length;++t){const n=e[t];this.removeListener(n)}delete this._nodeListenersMap[t._id]}const s=this._toAddedListeners;for(let e=0;e<s.length;){const n=s[e];n._getSceneGraphPriority()===t?(n._setSceneGraphPriority(null),n._setRegistered(!1),s.splice(e,1)):++e}if(!0===e){const e=t.getChildren();for(let t=0;t<e.length;++t){const n=e[t];this.removeListeners(n,!0)}}}else t===i.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(Ym.TOUCH_ONE_BY_ONE):t===i.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(Ym.TOUCH_ALL_AT_ONCE):t===i.EventListener.MOUSE?this._removeListenersForListenerID(Ym.MOUSE):t===i.EventListener.ACCELERATION?this._removeListenersForListenerID(Ym.ACCELERATION):t===i.EventListener.KEYBOARD?this._removeListenersForListenerID(Ym.KEYBOARD):v(3501);else x(3506)}removeCustomListeners(t){this._removeListenersForListenerID(t)}removeAllListeners(){const t=this._listenersMap,e=this._internalCustomListenerIDs;for(const n in t)-1===e.indexOf(n)&&this._removeListenersForListenerID(n)}setPriority(t,e){if(null==t)return;const n=this._listenersMap;for(const i in n){const s=n[i].getFixedPriorityListeners();if(s&&-1!==s.indexOf(t))return null!=t._getSceneGraphPriority()&&v(3502),void(t._getFixedPriority()!==e&&(t._setFixedPriority(e),this._setDirty(t._getListenerID(),1)))}}setEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}dispatchEvent(t){if(!this._isEnabled)return;if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,!t||!t.getType)return void T(3511);if(t.getType().startsWith(i.Event.TOUCH))return this._dispatchTouchEvent(t),void this._inDispatch--;const e=function(t){const e=Zh,n=t.type;return n===e.ACCELERATION?Ym.ACCELERATION:n===e.KEYBOARD?Ym.KEYBOARD:n.startsWith(e.MOUSE)?Ym.MOUSE:(n.startsWith(e.TOUCH)&&v(2e3),"")}(t);this._sortEventListeners(e);const n=this._listenersMap[e];null!=n&&(this._dispatchEventToListeners(n,this._onListenerCallback,t),this._onUpdateListeners(n)),this._inDispatch--}_onListenerCallback(t,e){e.currentTarget=t._target;const n=t.onEvent;return n&&n(e),e.isStopped()}dispatchCustomEvent(t,e){const n=new i.Event.EventCustom(t);n.setUserData(e),this.dispatchEvent(n)}_setDirtyForNode(t){const e=this._nodeListenersMap[t._id];if(void 0!==e)for(let t=0,n=e.length;t<n;t++){const n=e[t]._getListenerID();this._dirtyListeners[n]||(this._dirtyListeners[n]=!0)}if(t.children.length>0){const e=t.children;for(let t=0,n=e?e.length:0;t<n;t++)this._setDirtyForNode(e[t])}}_addListener(t){0===this._inDispatch?this._forceAddEventListener(t):this._toAddedListeners.push(t)}_forceAddEventListener(t){const e=t._getListenerID();let n=this._listenersMap[e];if(n||(n=new Km,this._listenersMap[e]=n),n.push(t),0===t._getFixedPriority()){this._setDirty(e,2);const n=t._getSceneGraphPriority();null===n&&v(3507),this._associateNodeAndEventListener(n,t),n.activeInHierarchy&&this.resumeTarget(n)}else this._setDirty(e,1)}_getListeners(t){return this._listenersMap[t]}_updateDirtyFlagForSceneGraph(){const t=this._dirtyListeners;for(const e in t)this._setDirty(e,2),t[e]=!1}_removeAllListenersInVector(t){if(!t)return;let e;for(let n=t.length-1;n>=0;n--)e=t[n],e._setRegistered(!1),null!=e._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(e._getSceneGraphPriority(),e),e._setSceneGraphPriority(null)),0===this._inDispatch&&i.js.array.removeAt(t,n)}_removeListenersForListenerID(t){const e=this._listenersMap[t];if(e){const n=e.getFixedPriorityListeners(),i=e.getSceneGraphPriorityListeners();this._removeAllListenersInVector(i),this._removeAllListenersInVector(n),delete this._priorityDirtyFlagMap[t],this._inDispatch||(e.clear(),delete this._listenersMap[t])}const n=this._toAddedListeners;for(let e=n.length-1;e>=0;e--){const s=n[e];s&&s._getListenerID()===t&&i.js.array.removeAt(n,e)}}_sortEventListeners(t){let e=0;const n=this._priorityDirtyFlagMap;n[t]&&(e=n[t]),0!==e&&(n[t]=0,1&e&&this._sortListenersOfFixedPriority(t),2&e)&&i.director.getScene()&&this._sortListenersOfSceneGraphPriority(t)}_sortListenersOfSceneGraphPriority(t){const e=this._getListeners(t);if(!e)return;const n=e.getSceneGraphPriorityListeners();if(!n||0===n.length)return;const i=e.getSceneGraphPriorityListeners();i.forEach(t=>{const e=t._getSceneGraphPriority()._uiProps.uiTransformComp;t._cameraPriority=e.cameraPriority}),i.sort(this._sortEventListenersOfSceneGraphPriorityDes)}_sortEventListenersOfSceneGraphPriorityDes(t,e){const n=t._getSceneGraphPriority(),i=e._getSceneGraphPriority();if(!(e&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(t&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return 1;let s=n,r=i,o=!1;if(t._cameraPriority!==e._cameraPriority)return e._cameraPriority-t._cameraPriority;for(;s.parent._id!==r.parent._id;)s=null===s.parent.parent?(o=!0)&&i:s.parent,r=null===r.parent.parent?(o=!0)&&n:r.parent;if(s._id===r._id){if(s._id===i._id)return-1;if(s._id===n._id)return 1}const a=s.getSiblingIndex(),c=r.getSiblingIndex();return o?a-c:c-a}_sortListenersOfFixedPriority(t){const e=this._listenersMap[t];if(!e)return;const n=e.getFixedPriorityListeners();if(!n||0===n.length)return;n.sort(this._sortListenersOfFixedPriorityAsc);let i=0;for(const t=n.length;i<t&&!(n[i]._getFixedPriority()>=0);)++i;e.gt0Index=i}_sortListenersOfFixedPriorityAsc(t,e){return t._getFixedPriority()-e._getFixedPriority()}_onUpdateListeners(t){const e=t.getFixedPriorityListeners(),n=t.getSceneGraphPriorityListeners(),s=this._toRemovedListeners;if(n)for(let t=n.length-1;t>=0;t--){const e=n[t];if(!e._isRegistered()){i.js.array.removeAt(n,t);const r=s.indexOf(e);-1!==r&&s.splice(r,1)}}if(e)for(let t=e.length-1;t>=0;t--){const n=e[t];if(!n._isRegistered()){i.js.array.removeAt(e,t);const r=s.indexOf(n);-1!==r&&s.splice(r,1)}}n&&0===n.length&&t.clearSceneGraphListeners(),e&&0===e.length&&t.clearFixedListeners()}_updateTouchListeners(t){const e=this._inDispatch;if(C(e>0,3508),e>1)return;let n;n=this._listenersMap[Ym.TOUCH_ONE_BY_ONE],n&&this._onUpdateListeners(n),n=this._listenersMap[Ym.TOUCH_ALL_AT_ONCE],n&&this._onUpdateListeners(n),C(1===e,3509);const i=this._toAddedListeners;if(0!==i.length){for(let t=0,e=i.length;t<e;t++)this._forceAddEventListener(i[t]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}_cleanToRemovedListeners(){const t=this._toRemovedListeners;for(let e=0;e<t.length;++e){const n=t[e],i=this._listenersMap[n._getListenerID()];if(!i)continue;const s=i.getFixedPriorityListeners(),r=i.getSceneGraphPriorityListeners();if(r){const t=r.indexOf(n);-1!==t&&r.splice(t,1)}if(s){const t=s.indexOf(n);-1!==t&&s.splice(t,1)}}t.length=0}_onTouchEventCallback(t,e){if(!t._isRegistered())return!1;const n=e.event,i=n.touch;n.currentTarget=t._getSceneGraphPriority();let s=!1,r=-1;const o=n.getEventCode();if(o===Fm.BEGAN){if(!Kt.ENABLE_MULTI_TOUCH&&$m._currentTouch){const t=$m._currentTouchListener._node;if(!t||t.activeInHierarchy)return!1}t.onTouchBegan&&(s=t.onTouchBegan(i,n),s&&t._isRegistered()&&(t._claimedTouches.push(i),!Kt.ENABLE_MULTI_TOUCH&&$m._currentTouch||($m._currentTouch=i),$m._currentTouchListener=t))}else if(t._claimedTouches.length>0&&(r=t._claimedTouches.indexOf(i),-1!==r)){if(s=!0,!Kt.ENABLE_MULTI_TOUCH&&$m._currentTouch&&$m._currentTouch!==i)return!1;o===Fm.MOVED&&t.onTouchMoved?t.onTouchMoved(i,n):o===Fm.ENDED?(t.onTouchEnded&&t.onTouchEnded(i,n),t._isRegistered()&&t._claimedTouches.splice(r,1),(Kt.ENABLE_MULTI_TOUCH||$m._currentTouch===i)&&($m._currentTouch=null),$m._currentTouchListener=null):o===Fm.CANCELLED&&(t.onTouchCancelled&&t.onTouchCancelled(i,n),t._isRegistered()&&t._claimedTouches.splice(r,1),(Kt.ENABLE_MULTI_TOUCH||$m._currentTouch===i)&&($m._currentTouch=null),$m._currentTouchListener=null)}return n.isStopped()?($m._updateTouchListeners(n),!0):!!(s&&t._isRegistered()&&t.swallowTouches)&&(e.needsMutableSet&&e.touches.splice(i,1),!0)}_dispatchTouchEvent(t){this._sortEventListeners(Ym.TOUCH_ONE_BY_ONE),this._sortEventListeners(Ym.TOUCH_ALL_AT_ONCE);const e=this._getListeners(Ym.TOUCH_ONE_BY_ONE),n=this._getListeners(Ym.TOUCH_ALL_AT_ONCE);if(null===e&&null===n)return;const s=t.getTouches(),r=i.js.array.copy(s),o={event:t,needsMutableSet:e&&n,touches:r,selTouch:null};if(e)for(let n=0;n<s.length;++n){const i=s[n];t.touch=i,t.propagationStopped=t.propagationImmediateStopped=!1,this._dispatchEventToListeners(e,this._onTouchEventCallback,o)}n&&r.length>0&&(this._dispatchEventToListeners(n,this._onTouchesEventCallback,{event:t,touches:r}),t.isStopped())||this._updateTouchListeners(t)}_onTouchesEventCallback(t,e){if(!t._isRegistered())return!1;const n=e.event,i=e.touches,s=n.getEventCode();return n.currentTarget=t._getSceneGraphPriority(),s===Fm.BEGAN&&t.onTouchesBegan?t.onTouchesBegan(i,n):s===Fm.MOVED&&t.onTouchesMoved?t.onTouchesMoved(i,n):s===Fm.ENDED&&t.onTouchesEnded?t.onTouchesEnded(i,n):s===Fm.CANCELLED&&t.onTouchesCancelled&&t.onTouchesCancelled(i,n),!!n.isStopped()&&($m._updateTouchListeners(n),!0)}_associateNodeAndEventListener(t,e){let n=this._nodeListenersMap[t.uuid];n||(n=[],this._nodeListenersMap[t.uuid]=n),n.push(e)}_dissociateNodeAndEventListener(t,e){const n=this._nodeListenersMap[t.uuid];n&&(i.js.array.remove(n,e),0===n.length&&delete this._nodeListenersMap[t.uuid])}_dispatchEventToListeners(t,e,n){let i=!1;const s=t.getFixedPriorityListeners(),r=t.getSceneGraphPriorityListeners();let o=0;if(s&&0!==s.length)for(;o<t.gt0Index;++o){const t=s[o];if(t.isEnabled()&&!t._isPaused()&&t._isRegistered()&&e(t,n)){i=!0;break}}if(r&&!i)for(let t=0;t<r.length;++t){const s=r[t];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&e(s,n)){i=!0;break}}if(s&&!i)for(;o<s.length;++o){const t=s[o];if(t.isEnabled()&&!t._isPaused()&&t._isRegistered()&&e(t,n)){i=!0;break}}}_setDirty(t,e){const n=this._priorityDirtyFlagMap;null==n[t]?n[t]=e:n[t]|=e}_sortNumberAsc(t,e){return t-e}_removeListenerInCallback(t,e){if(null==t)return!1;for(let n=t.length-1;n>=0;n--){const s=t[n];if(s._onCustomEvent===e||s.onEvent===e)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?i.js.array.removeAt(t,n):this._toRemovedListeners.push(s),!0}return!1}_removeListenerInVector(t,e){if(null==t)return!1;for(let n=t.length-1;n>=0;n--){const s=t[n];if(s===e)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?i.js.array.removeAt(t,n):this._toRemovedListeners.push(s),!0}return!1}});i.eventManager=$m;const Zm=new rn;class Jm{get lastModified(){return this._lastModified}constructor(t,e,n=0){this._point=new rn,this._prevPoint=new rn,this._lastModified=0,this._id=0,this._startPoint=new rn,this._startPointCaptured=!1,this.setTouchInfo(n,t,e)}getLocation(t){return t||(t=new rn),t.set(this._point.x,this._point.y),t}getLocationX(){return this._point.x}getLocationY(){return this._point.y}getUILocation(t){return t||(t=new rn),t.set(this._point.x,this._point.y),i.view._convertPointWithScale(t),t}getUILocationX(){const t=i.view.getViewportRect();return(this._point.x-t.x)/i.view.getScaleX()}getUILocationY(){const t=i.view.getViewportRect();return(this._point.y-t.y)/i.view.getScaleY()}getPreviousLocation(t){return t||(t=new rn),t.set(this._prevPoint.x,this._prevPoint.y),t}getUIPreviousLocation(t){return t||(t=new rn),t.set(this._prevPoint.x,this._prevPoint.y),i.view._convertPointWithScale(t),t}getStartLocation(t){return t||(t=new rn),t.set(this._startPoint.x,this._startPoint.y),t}getUIStartLocation(t){return t||(t=new rn),t.set(this._startPoint.x,this._startPoint.y),i.view._convertPointWithScale(t),t}getDelta(t){return t||(t=new rn),t.set(this._point),t.subtract(this._prevPoint),t}getUIDelta(t){return t||(t=new rn),Zm.set(this._point),Zm.subtract(this._prevPoint),t.set(i.view.getScaleX(),i.view.getScaleY()),rn.divide(t,Zm,t),t}getLocationInView(t){return t||(t=new rn),t.set(this._point.x,i.view._designResolutionSize.height-this._point.y),t}getPreviousLocationInView(t){return t||(t=new rn),t.set(this._prevPoint.x,i.view._designResolutionSize.height-this._prevPoint.y),t}getStartLocationInView(t){return t||(t=new rn),t.set(this._startPoint.x,i.view._designResolutionSize.height-this._startPoint.y),t}getID(){return this._id}setTouchInfo(t=0,e,n){this._prevPoint=this._point,this._point=new rn(e||0,n||0),this._id=t,this._startPointCaptured||(this._startPoint=new rn(this._point),this._startPointCaptured=!0)}setPoint(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=i.director.getCurrentTime()}setPrevPoint(t,e){this._prevPoint="object"==typeof t?new rn(t.x,t.y):new rn(t||0,e||0),this._lastModified=i.director.getCurrentTime()}}t("Touch",Jm),i.Touch=Jm;const Qm=Kt.TOUCH_TIMEOUT;let tf;const ef=new rn,nf=new rn;class sf{constructor(t=0,e=0,n=0,i=0){this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=n,this.timestamp=i}}t("Acceleration",sf),i.internal.Acceleration=sf;const rf=new class{constructor(){this._mousePressed=!1,this._isRegisterEvent=!1,this._preTouchPoint=new rn,this._prevMousePoint=new rn,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._accelEnabled=!1,this._accelInterval=.2,this._accelMinus=1,this._accelCurTime=0,this._acceleration=null,this._accelDeviceEvent=null,this._glView=null,this._pointLocked=!1}handleTouchesBegin(t){const e=[],n=this._touchesIntegerDict;for(let i=0;i<t.length;++i){const s=t[i],r=s.getID();if(null!==r&&void 0===n[r]){const t=this._getUnUsedIndex();if(-1===t){v(2300,t);continue}s.getLocation(ef);const i=new Jm(ef.x,ef.y,r);this._touches[t]=i,s.getPreviousLocation(ef),i.setPrevPoint(ef),n[r]=t,e.push(i)}}if(e.length>0){const t=new Fm(e,!1,Fm.BEGAN,Kt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);$m.dispatchEvent(t)}}handleTouchesMove(t){const e=[],n=this._touches;for(let i=0;i<t.length;++i){const s=t[i],r=s.getID();if(null===r)continue;const o=this._touchesIntegerDict[r];void 0!==o&&n[o]&&(s.getLocation(ef),n[o].setPoint(ef),s.getPreviousLocation(ef),n[o].setPrevPoint(ef),e.push(n[o]))}if(e.length>0){const t=new Fm(e,!1,Fm.MOVED,Kt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);$m.dispatchEvent(t)}}handleTouchesEnd(t){const e=this.getSetOfTouchesEndOrCancel(t);if(e.length>0){const t=new Fm(e,!1,Fm.ENDED,Kt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);$m.dispatchEvent(t)}this._preTouchPool.length=0}handleTouchesCancel(t){const e=this.getSetOfTouchesEndOrCancel(t);if(e.length>0){const t=new Fm(e,!1,Fm.CANCELLED,Kt.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);$m.dispatchEvent(t)}this._preTouchPool.length=0}getSetOfTouchesEndOrCancel(t){const e=[],n=this._touches,i=this._touchesIntegerDict;for(let s=0;s<t.length;++s){const r=t[s],o=r.getID();if(null===o)continue;const a=i[o];void 0!==a&&n[a]&&(r.getLocation(ef),n[a].setPoint(ef),r.getPreviousLocation(ef),n[a].setPrevPoint(ef),e.push(n[a]),this._removeUsedIndexBit(a),delete i[o])}return e}getHTMLElementPosition(t){const e=document.documentElement;let n=Om.os===Om.OS_IOS&&Om.isBrowser?window.screenLeft:window.pageXOffset;n-=e.clientLeft;let i=Om.os===Om.OS_IOS&&Om.isBrowser?window.screenTop:window.pageYOffset;if(i-=e.clientTop,t.getBoundingClientRect){const e=t.getBoundingClientRect();return{left:e.left+n,top:e.top+i,width:e.width,height:e.height}}return t instanceof HTMLCanvasElement?{left:n,top:i,width:t.width,height:t.height}:{left:n,top:i,width:parseInt(t.style.width||"0",void 0),height:parseInt(t.style.height||"0",void 0)}}getPreTouch(t){let e=null;const n=this._preTouchPool,i=t.getID();for(let t=n.length-1;t>=0;t--)if(n[t].getID()===i){e=n[t];break}return e||(e=t),e}setPreTouch(t){let e=!1;const n=this._preTouchPool,i=t.getID();for(let s=n.length-1;s>=0;s--)if(n[s].getID()===i){n[s]=t,e=!0;break}e||(n.length<=50?n.push(t):(n[this._preTouchPoolPointer]=t,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}getTouchByXY(t,e,n,i){const s=this._preTouchPoint,r=this._glView.convertToLocationInView(e,n,i);this._pointLocked&&(r.x=s.x+t.movementX,r.y=s.y-t.movementY);const o=new Jm(r.x,r.y,0);return o.setPrevPoint(s.x,s.y),s.x=r.x,s.y=r.y,o}getMouseEvent(t,e,n){const i=this._prevMousePoint,s=new Bm(n,!1,i);return i.x=t.x,i.y=t.y,this._glView._convertMouseToLocation(i,e),s.setLocation(i.x,i.y),s}getPointByEvent(t,e){return null!=t.pageX?{x:t.pageX,y:t.pageY}:(e.left-=document.body.scrollLeft,e.top-=document.body.scrollTop,{x:t.clientX,y:t.clientY})}getTouchesByEvent(t,e){const n=[],i=this._glView,s=this._preTouchPoint,r=t.changedTouches.length;for(let o=0;o<r;o++){const r=t.changedTouches[o];if(!r)continue;let a,c;if(a=Om.BROWSER_TYPE_FIREFOX===Om.browserType?i.convertToLocationInView(r.pageX,r.pageY,e,ef):i.convertToLocationInView(r.clientX,r.clientY,e,ef),null!=r.identifier?(c=new Jm(a.x,a.y,r.identifier),this.getPreTouch(c).getLocation(nf),c.setPrevPoint(nf.x,nf.y),this.setPreTouch(c)):(c=new Jm(a.x,a.y),c.setPrevPoint(s.x,s.y)),s.x=a.x,s.y=a.y,n.push(c),!Kt.ENABLE_MULTI_TOUCH)break}return n}registerSystemEvent(t){if(this._isRegisterEvent||!t)return;this._glView=i.view;const e=Om.isMobile,n=Om.capabilities.mouse,s=Om.capabilities.touches;n&&this._registerMouseEvents(t,e),window.navigator.msPointerEnabled&&this._registerMousePointerEvents(t),s&&this._registerTouchEvents(t),this._registerKeyboardEvent(),this._isRegisterEvent=!0}setAccelerometerEnabled(t){if(this._accelEnabled===t)return;this._accelEnabled=t;const e=i.director.getScheduler();e.enableForTarget(this),this._accelEnabled?(this._registerAccelerometerEvent(),this._accelCurTime=0,e.scheduleUpdate(this)):(this._unregisterAccelerometerEvent(),this._accelCurTime=0,e.unscheduleUpdate(this)),jsb.device.setMotionEnabled(t)}didAccelerate(t){if(!this._accelEnabled)return;const e=this._acceleration;let n=0,s=0,r=0;if(this._accelDeviceEvent===window.DeviceMotionEvent){const e=t.accelerationIncludingGravity;e&&(n=this._accelMinus*(e.x||0)*.1,s=this._accelMinus*(e.y||0)*.1,r=.1*(e.z||0))}else{const e=t;n=(e.gamma||0)/90*.981,s=-(e.beta||0)/90*.981,r=(e.alpha||0)/90*.981}if(i.view._isRotated){const t=n;n=-s,s=t}e.x=n,e.y=s,e.z=r,e.timestamp=t.timeStamp||Date.now();const o=e.x;90===window.orientation?(e.x=-e.y,e.y=o):-90===window.orientation?(e.x=e.y,e.y=-o):180===window.orientation&&(e.x=-e.x,e.y=-e.y),i.sys.os===i.sys.OS_ANDROID&&i.sys.browserType!==i.sys.BROWSER_TYPE_MOBILE_QQ&&(e.x=-e.x,e.y=-e.y)}update(t){this._accelCurTime>this._accelInterval&&(this._accelCurTime-=this._accelInterval,$m.dispatchEvent(new Um(this._acceleration))),this._accelCurTime+=t}setAccelerometerInterval(t){this._accelInterval!==t&&(this._accelInterval=t,jsb.device&&jsb.device.setMotionInterval&&jsb.device.setMotionInterval(t))}_getUnUsedIndex(){let t=this._indexBitsUsed;const e=i.director.getCurrentTime();for(let n=0;n<this._maxTouches;n++){if(!(1&t))return this._indexBitsUsed|=1<<n,n;{const t=this._touches[n];if(e-t.lastModified>Qm){this._removeUsedIndexBit(n);const e=t.getID();return null!==e&&delete this._touchesIntegerDict[e],n}}t>>=1}return-1}_removeUsedIndexBit(t){if(t<0||t>=this._maxTouches)return;let e=1<<t;e=~e,this._indexBitsUsed&=e}_registerMouseEvents(t,e){this._registerPointerLockEvent(),e||this._registerWindowMouseEvents(t),this._registerElementMouseEvents(t,e)}_registerPointerLockEvent(){const t=()=>{const t=i.game.canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?this._pointLocked=!0:this._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)}_registerWindowMouseEvents(t){window.addEventListener("mousedown",()=>{this._mousePressed=!0},!1),window.addEventListener("mouseup",e=>{if(!this._mousePressed)return;this._mousePressed=!1;const n=this.getHTMLElementPosition(t),i=this.getPointByEvent(e,n);if(!Nn(n.left,n.top,n.width,n.height).contains(new rn(i.x,i.y))){this.handleTouchesEnd([this.getTouchByXY(e,i.x,i.y,n)]);const t=this.getMouseEvent(i,n,Bm.UP);t.setButton(e.button),$m.dispatchEvent(t)}},!1)}_registerElementMouseEvents(t,e){const n=(e,n,i)=>{t.addEventListener(e,e=>{const s=this.getHTMLElementPosition(t),r=this.getPointByEvent(e,s),o=this.getMouseEvent(r,s,n);o.setButton(e.button),i(e,o,r,s),$m.dispatchEvent(o),e.stopPropagation(),e.preventDefault()})};e||(n("mousedown",Bm.DOWN,(e,n,i,s)=>{this._mousePressed=!0,this.handleTouchesBegin([this.getTouchByXY(e,i.x,i.y,s)]),t.focus()}),n("mouseup",Bm.UP,(t,e,n,i)=>{this._mousePressed=!1,this.handleTouchesEnd([this.getTouchByXY(t,n.x,n.y,i)])}),n("mousemove",Bm.MOVE,(t,e,n,i)=>{this.handleTouchesMove([this.getTouchByXY(t,n.x,n.y,i)]),this._mousePressed||e.setButton(Bm.BUTTON_MISSING),void 0!==t.movementX&&void 0!==t.movementY&&(e.movementX=t.movementX,e.movementY=t.movementY)})),n("mousewheel",Bm.SCROLL,(t,e)=>{e.setScrollData(0,t.wheelDelta)}),n("DOMMouseScroll",Bm.SCROLL,(t,e)=>{e.setScrollData(0,-120*t.detail)})}_registerMousePointerEvents(t){const e={MSPointerDown:this.handleTouchesBegin,MSPointerMove:this.handleTouchesMove,MSPointerUp:this.handleTouchesEnd,MSPointerCancel:this.handleTouchesCancel};for(const n in e){const i=e[n];t.addEventListener(n,e=>{const n=this.getHTMLElementPosition(t);n.left-=document.documentElement.scrollLeft,n.top-=document.documentElement.scrollTop,i.call(this,[this.getTouchByXY(e,e.clientX,e.clientY,n)]),e.stopPropagation()},!1)}}_registerTouchEvents(t){const e=e=>n=>{if(!n.changedTouches)return;const i=this.getHTMLElementPosition(t),s=document.body;i.left-=s.scrollLeft||0,i.top-=s.scrollTop||0,e(this.getTouchesByEvent(n,i)),n.stopPropagation(),n.preventDefault()};t.addEventListener("touchstart",e(e=>{this.handleTouchesBegin(e),t.focus()}),!1),t.addEventListener("touchmove",e(t=>{this.handleTouchesMove(t)}),!1),t.addEventListener("touchend",e(t=>{this.handleTouchesEnd(t)}),!1),t.addEventListener("touchcancel",e(t=>{this.handleTouchesCancel(t)}),!1)}_registerKeyboardEvent(){const t=i.game.canvas;t.addEventListener("keydown",t=>{$m.dispatchEvent(new Gm(t,!0)),t.stopPropagation(),t.preventDefault()},!1),t.addEventListener("keyup",t=>{$m.dispatchEvent(new Gm(t,!1)),t.stopPropagation(),t.preventDefault()},!1)}_registerAccelerometerEvent(){this._acceleration=new sf,this._accelDeviceEvent=window.DeviceMotionEvent||window.DeviceOrientationEvent,i.sys.browserType===i.sys.BROWSER_TYPE_MOBILE_QQ&&(this._accelDeviceEvent=window.DeviceOrientationEvent);const t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";tf=(...t)=>this.didAccelerate(...t),window.addEventListener(t,tf,!1)}_unregisterAccelerometerEvent(){const t=this._accelDeviceEvent===window.DeviceMotionEvent?"devicemotion":"deviceorientation";tf&&window.removeEventListener(t,tf,!1)}_getUsefulTouches(){const t=[],e=this._touchesIntegerDict;for(const n in e){const i=e[parseInt(n)];if(null==i)continue;const s=this._touches[i];t.push(s)}return t}};i.internal.inputManager=rf;class of extends d_{constructor(...t){super(...t),this.frame=null,this.container=null,this.canvas=null,this.renderType=-1,this.eventTargetOn=super.on,this.eventTargetOnce=super.once,this.config={},this.onStart=null,this.collisionMatrix=[],this.groupList=[],this._persistRootNodes={},this._paused=!0,this._configLoaded=!1,this._isCloning=!1,this._inited=!1,this._engineInited=!1,this._rendererInitialized=!1,this._gfxDevice=null,this._intervalId=null}get inited(){return this._inited}get frameTime(){return this._frameTime}setFrameRate(t){const e=this.config;"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),e.frameRate=t,this._paused=!0,this._setAnimFrame(),this._runMainLoop()}getFrameRate(){return this.config.frameRate||0}step(){i.director.mainLoop()}pause(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))}resume(){this._paused&&this._runMainLoop()}isPaused(){return this._paused}restart(){return new Promise(t=>i.director.once(i.Director.EVENT_AFTER_DRAW,()=>t())).then(()=>{for(const t in this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[t]);return i.director.getScene().destroy(),i.Object._deferredDestroy(),i.director.reset(),this.pause(),this._setRenderPipelineNShowSplash().then(()=>{this.resume(),this._safeEmit(of.EVENT_RESTART)})})}end(){this._gfxDevice&&(this._gfxDevice.destroy(),this._gfxDevice=null),window.close()}on(t,e,n,i){return this._engineInited&&t===of.EVENT_ENGINE_INITED?e.call(n):this.eventTargetOn(t,e,n,i)}once(t,e,n){return this._engineInited&&t===of.EVENT_ENGINE_INITED?e.call(n):this.eventTargetOnce(t,e,n)}init(t){return this._initConfig(t),this.config.assetOptions&&i.assetManager.init(this.config.assetOptions),this._initEngine().then(()=>(this._initEvents(),i.director.root.dataPoolManager&&i.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(t.customJointTextureLayouts),this._engineInited))}run(t,e){let n;return"function"!=typeof t&&t?(n=this.init(t),this.onStart=null!=e?e:null):this.onStart=null!=t?t:null,Promise.resolve(n).then(()=>(af.config.registerSystemEvent&&rf.registerSystemEvent(af.canvas),this._setRenderPipelineNShowSplash()))}addPersistRootNode(t){if(!i.Node.isNode(t)||!t.uuid)return void x(3800);const e=t.uuid;if(!this._persistRootNodes[e]){const n=i.director._scene;if(i.isValid(n))if(t.parent){if(!(t.parent instanceof i.Scene))return void x(3801);if(t.parent!==n)return void x(3802)}else t.parent=n;this._persistRootNodes[e]=t,t._persistNode=!0,i.assetManager._releaseManager._addPersistNodeRef(t)}}removePersistRootNode(t){const e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,i.assetManager._releaseManager._removePersistNodeRef(t))}isPersistRootNode(t){return!!t._persistNode}_initEngine(){return this._initDevice(),Promise.resolve(i.director._init()).then(()=>{h("Cocos Creator v3.0.0"),this.emit(of.EVENT_ENGINE_INITED),this._engineInited=!0,i.internal.dynamicAtlasManager.enabled=!Kt.CLEANUP_IMAGE_CACHE})}_setAnimFrame(){this._lastTime=performance.now();const t=this.config.frameRate;this._frameTime=1e3/t,jsb.setPreferredFramesPerSecond(t),window.rAF=window.requestAnimationFrame,window.cAF=window.cancelAnimationFrame}_stTimeWithRAF(t){const e=performance.now(),n=Math.max(0,e-af._lastTime),i=Math.max(0,af._frameTime-n),s=window.setTimeout(()=>{window.requestAnimationFrame(t)},i);return af._lastTime=e+i,s}_stTime(t){const e=performance.now(),n=Math.max(0,e-af._lastTime),i=Math.max(0,af._frameTime-n),s=window.setTimeout(t,i);return af._lastTime=e+i,s}_ctTime(t){window.clearTimeout(t)}_runMainLoop(){if(!this._inited)return;const t=this.config,e=i.director;let n;t.frameRate,R(!!t.showFPS),e.startAnimation(),n=t=>{this._intervalId=window.rAF(n),e.mainLoop(t)},this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._intervalId=window.rAF(n),this._paused=!1}_initConfig(t){"number"!=typeof t.debugMode&&(t.debugMode=A.NONE),t.exposeClassName=!!t.exposeClassName,"number"!=typeof t.frameRate&&(t.frameRate=60);const e=t.renderMode;("number"!=typeof e||e>2||e<0)&&(t.renderMode=0),"boolean"!=typeof t.registerSystemEvent&&(t.registerSystemEvent=!0),t.showFPS=!!t.showFPS,this.collisionMatrix=t.collisionMatrix||[],this.groupList=t.groupList||[],p(t.debugMode),this.config=t,this._configLoaded=!0,this._setAnimFrame()}_determineRenderType(){const t=this.config,e=parseInt(t.renderMode,10);this.renderType=of.RENDER_TYPE_CANVAS;let n=!1;if(0===e?i.sys.capabilities.opengl?(this.renderType=of.RENDER_TYPE_WEBGL,n=!0):i.sys.capabilities.canvas&&(this.renderType=of.RENDER_TYPE_CANVAS,n=!0):1===e&&i.sys.capabilities.canvas?(this.renderType=of.RENDER_TYPE_CANVAS,n=!0):2===e&&i.sys.capabilities.opengl&&(this.renderType=of.RENDER_TYPE_WEBGL,n=!0),!n)throw new Error(b(3820,e))}_initDevice(){if(!this._rendererInitialized){if(this.canvas=this.config.adapter.canvas,this.frame=this.config.adapter.frame,this.container=this.config.adapter.container,this._determineRenderType(),this.renderType===of.RENDER_TYPE_WEBGL){const t=[];if(window.gfx){const e=Om.os;e===Om.OS_OSX||e===Om.OS_IOS?(gfx.CCMTLDevice&&t.push(gfx.CCMTLDevice),gfx.GLES3Device&&t.push(gfx.GLES3Device)):(gfx.GLES3Device&&t.push(gfx.GLES3Device),gfx.CCVKDevice&&t.push(gfx.CCVKDevice),gfx.GLES2Device&&t.push(gfx.GLES2Device))}else{let e=!!window.WebGL2RenderingContext;const n=window.navigator.userAgent.toLowerCase();(-1!==n.indexOf("safari")&&-1===n.indexOf("chrome")||Om.browserType===Om.BROWSER_TYPE_UC)&&(e=!1),e&&i.WebGL2Device&&t.push(i.WebGL2Device),i.WebGLDevice&&t.push(i.WebGLDevice)}const e=new to(this.canvas,Kt.ENABLE_WEBGL_ANTIALIAS,!1,window.devicePixelRatio,Om.windowPixelResolution.width,Om.windowPixelResolution.height,Oc);for(let n=0;n<t.length&&(this._gfxDevice=new t[n],!this._gfxDevice.initialize(e));n++);}if(!this._gfxDevice)return u("can not support canvas rendering in 3D"),void(this.renderType=of.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=()=>!1}}_initEvents(){const t=window;let e;void 0!==document.hidden?e="hidden":void 0!==document.mozHidden?e="mozHidden":void 0!==document.msHidden?e="msHidden":void 0!==document.webkitHidden&&(e="webkitHidden");let n=!1;const i=this;function s(){n||(n=!0,i.emit(of.EVENT_HIDE))}function r(t,e,s,r,o){n&&(n=!1,i.emit(of.EVENT_SHOW,t,e,s,r,o))}if(e){const t=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"];for(let n=0;n<t.length;n++)document.addEventListener(t[n],t=>{let n=document[e];n=n||t.hidden,n?s():r()})}else t.addEventListener("blur",s),t.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(t.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(t.addEventListener("pagehide",s),t.addEventListener("pageshow",r),document.addEventListener("pagehide",s),document.addEventListener("pageshow",r)),this.on(of.EVENT_HIDE,()=>{this.pause()}),this.on(of.EVENT_SHOW,()=>{this.resume()})}_setRenderPipelineNShowSplash(){return Promise.resolve(this._setupRenderPipeline()).then(()=>Promise.resolve(this._showSplashScreen()).then(()=>{this._inited=!0,this._setAnimFrame(),this._runMainLoop(),this._safeEmit(of.EVENT_GAME_INITED),this.onStart&&this.onStart()}))}_setupRenderPipeline(){const{renderPipeline:t}=this.config;return t?new Promise((e,n)=>{i.assetManager.loadAny(t,(t,i)=>!t&&i instanceof Dm?e(i):n(t))}).then(t=>{this._setRenderPipeline(t)}).catch(e=>{_(e),_(`Failed load render pipeline: ${t}, engine failed to initialize, will fallback to default pipeline`),this._setRenderPipeline()}):this._setRenderPipeline()}_showSplashScreen(){if(i.internal.SplashScreen){const t=i.internal.SplashScreen.instance;return t.main(i.director.root),new Promise(e=>{t.setOnFinish(()=>e()),t.loadFinish=!0})}return null}_setRenderPipeline(t){i.director.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(of.EVENT_RENDERER_INITED)}_safeEmit(t){this.emit(t)}}t("Game",of),of.EVENT_HIDE="game_on_hide",of.EVENT_SHOW="game_on_show",of.EVENT_LOW_MEMORY="game_on_low_memory",of.EVENT_GAME_INITED="game_inited",of.EVENT_ENGINE_INITED="engine_inited",of.EVENT_RENDERER_INITED="renderer_inited",of.EVENT_RESTART="game_on_restart",of.RENDER_TYPE_CANVAS=0,of.RENDER_TYPE_WEBGL=1,of.RENDER_TYPE_OPENGL=2,i.Game=of;const af=t("game",i.game=new of),cf=new class{constructor(){this.html=void 0,this.meta={width:"device-width"},this.adaptationType=i.sys.browserType}init(){this.html=document.getElementsByTagName("html")[0]}availWidth(t){return i.sys.isMobile||!t||t===this.html?window.innerWidth:t.clientWidth}availHeight(t){return i.sys.isMobile||!t||t===this.html?window.innerHeight:t.clientHeight}};switch(i.sys.os===i.sys.OS_IOS&&(cf.adaptationType=i.sys.BROWSER_TYPE_SAFARI),cf.adaptationType){case i.sys.BROWSER_TYPE_SAFARI:cf.meta["minimal-ui"]="true",cf.availWidth=t=>t.clientWidth,cf.availHeight=t=>t.clientHeight;break;case i.sys.BROWSER_TYPE_SOUGOU:case i.sys.BROWSER_TYPE_UC:cf.availWidth=t=>t.clientWidth,cf.availHeight=t=>t.clientHeight}class lf extends d_{constructor(){super(),this._resizeWithBrowserSize=void 0,this._designResolutionSize=void 0,this._originalDesignResolutionSize=void 0,this._frameSize=void 0,this._scaleX=void 0,this._scaleY=void 0,this._viewportRect=void 0,this._visibleRect=void 0,this._autoFullScreen=void 0,this._devicePixelRatio=void 0,this._maxPixelRatio=void 0,this._retinaEnabled=void 0,this._resizeCallback=void 0,this._resizing=void 0,this._orientationChanging=void 0,this._isRotated=void 0,this._orientation=void 0,this._isAdjustViewport=void 0,this._resolutionPolicy=void 0,this._rpExactFit=void 0,this._rpShowAll=void 0,this._rpNoBorder=void 0,this._rpFixedHeight=void 0,this._rpFixedWidth=void 0;const t=hf,e=_f;this._frameSize=new On(0,0),this._designResolutionSize=new On(0,0),this._originalDesignResolutionSize=new On(0,0),this._scaleX=1,this._scaleY=1,this._viewportRect=new Mn(0,0,0,0),this._visibleRect=new Mn(0,0,0,0),this._autoFullScreen=!1,this._devicePixelRatio=1,this._maxPixelRatio=4,this._retinaEnabled=!1,this._resizeCallback=null,this._resizing=!1,this._resizeWithBrowserSize=!1,this._orientationChanging=!0,this._isRotated=!1,this._orientation=i.macro.ORIENTATION_AUTO,this._isAdjustViewport=!0,this._rpExactFit=new uf(t.EQUAL_TO_FRAME,e.EXACT_FIT),this._rpShowAll=new uf(t.EQUAL_TO_FRAME,e.SHOW_ALL),this._rpNoBorder=new uf(t.EQUAL_TO_FRAME,e.NO_BORDER),this._rpFixedHeight=new uf(t.EQUAL_TO_FRAME,e.FIXED_HEIGHT),this._rpFixedWidth=new uf(t.EQUAL_TO_FRAME,e.FIXED_WIDTH),this._resolutionPolicy=this._rpShowAll,i.game.once(i.Game.EVENT_ENGINE_INITED,this.init,this)}init(){cf.init(),this._initFrameSize();const t=i.game.canvas.width,e=i.game.canvas.height;this._designResolutionSize.width=t,this._designResolutionSize.height=e,this._originalDesignResolutionSize.width=t,this._originalDesignResolutionSize.height=e,this._viewportRect.width=t,this._viewportRect.height=e,this._visibleRect.width=t,this._visibleRect.height=e,i.winSize.width=this._visibleRect.width,i.winSize.height=this._visibleRect.height,i.visibleRect&&i.visibleRect.init(this._visibleRect)}resizeWithBrowserSize(t){t?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,window.addEventListener("resize",this._resizeEvent),window.addEventListener("orientationchange",this._orientationChange)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,window.removeEventListener("resize",this._resizeEvent),window.removeEventListener("orientationchange",this._orientationChange))}setResizeCallback(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)}setOrientation(t){(t&=i.macro.ORIENTATION_AUTO)&&this._orientation!==t&&(this._orientation=t)}adjustViewportMeta(t){this._isAdjustViewport=t}enableRetina(t){this._retinaEnabled=!!t}isRetinaEnabled(){return this._retinaEnabled}enableAutoFullScreen(t){t&&t!==this._autoFullScreen&&i.sys.isMobile&&i.sys.browserType!==i.sys.BROWSER_TYPE_WECHAT?(this._autoFullScreen=!0,i.screen.autoFullScreen(i.game.frame)):this._autoFullScreen=!1}isAutoFullScreenEnabled(){return this._autoFullScreen}setCanvasSize(t,e){const n=i.game.canvas,s=i.game.container;this._devicePixelRatio=window.devicePixelRatio,n.width=Om.windowPixelResolution.width,n.height=Om.windowPixelResolution.height,n.style.width=t+"px",n.style.height=e+"px",s.style.width=t+"px",s.style.height=e+"px",this._resizeEvent()}getCanvasSize(){return new On(i.game.canvas.width,i.game.canvas.height)}getFrameSize(){return new On(this._frameSize.width,this._frameSize.height)}setFrameSize(t,e){this._frameSize.width=t,this._frameSize.height=e,i.game.frame.style.width=t+"px",i.game.frame.style.height=e+"px",this._resizeEvent()}getVisibleSize(){return new On(this._visibleRect.width,this._visibleRect.height)}getVisibleSizeInPixel(){return new On(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}getVisibleOrigin(){return new rn(this._visibleRect.x,this._visibleRect.y)}getVisibleOriginInPixel(){return new rn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}getResolutionPolicy(){return this._resolutionPolicy}setResolutionPolicy(t){if(t instanceof uf)this._resolutionPolicy=t;else{const e=uf;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}}setDesignResolutionSize(t,e,n){if(!(t>0&&e>0))return void T(2200);this.setResolutionPolicy(n);const s=this._resolutionPolicy;if(s&&s.preApply(this),i.sys.isMobile&&this._adjustViewportMeta(),this._orientationChanging=!0,this._resizing||this._initFrameSize(),!s)return void v(2201);this._originalDesignResolutionSize.width=this._designResolutionSize.width=t,this._originalDesignResolutionSize.height=this._designResolutionSize.height=e;const r=s.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){const t=this._viewportRect,e=this._visibleRect,n=r.viewport;t.x=n.x,t.y=n.y,t.width=n.width,t.height=n.height,e.x=0,e.y=0,e.width=n.width/this._scaleX,e.height=n.height/this._scaleY}s.postApply(this),i.winSize.width=this._visibleRect.width,i.winSize.height=this._visibleRect.height,Lm&&Lm.init(this._visibleRect),this.emit("design-resolution-changed")}getDesignResolutionSize(){return new On(this._designResolutionSize.width,this._designResolutionSize.height)}setRealPixelResolution(t,e,n){this.setDesignResolutionSize(t,e,n)}getViewportRect(){return this._viewportRect}getScaleX(){return this._scaleX}getScaleY(){return this._scaleY}getDevicePixelRatio(){return this._devicePixelRatio}convertToLocationInView(t,e,n,s){const r=s||new rn,o=this._devicePixelRatio*(t-n.left),a=this._devicePixelRatio*(n.top+n.height-e);return this._isRotated?(r.x=i.game.canvas.width-a,r.y=o):(r.x=o,r.y=a),i.GAME_VIEW&&(r.x/=i.gameView.canvas.width/i.game.canvas.width,r.y/=i.gameView.canvas.height/i.game.canvas.height),r}_convertPointWithScale(t){const e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY}_resizeEvent(){const t=i.view;if(t._frameSize.width,t._frameSize.height,t._isRotated,i.sys.isMobile){const e=i.game.container.style,n=e.margin;e.margin="0",e.display="none",t._initFrameSize(),e.margin=n,e.display="block"}else t._initFrameSize();const e=t._originalDesignResolutionSize.width,n=t._originalDesignResolutionSize.height;t._resizing=!0,e>0&&t.setDesignResolutionSize(e,n,t._resolutionPolicy),t._resizing=!1,t.emit("canvas-resize"),t._resizeCallback&&t._resizeCallback.call()}_orientationChange(){i.view._orientationChanging=!0,i.view._resizeEvent()}_initFrameSize(){const t=this._frameSize,e=cf.availWidth(i.game.frame),n=cf.availHeight(i.game.frame),s=e>=n;!i.sys.isMobile||s&&this._orientation&i.macro.ORIENTATION_LANDSCAPE||!s&&this._orientation&i.macro.ORIENTATION_PORTRAIT?(t.width=e,t.height=n,i.game.container.style["-webkit-transform"]="rotate(0deg)",i.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(t.width=n,t.height=e,i.game.container.style["-webkit-transform"]="rotate(90deg)",i.game.container.style.transform="rotate(90deg)",i.game.container.style["-webkit-transform-origin"]="0px 0px 0px",i.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,i.game.canvas.style["-webkit-transform"]="translateZ(0px)",i.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout(()=>{i.view._orientationChanging=!1},1e3)}_adjustSizeKeepCanvasSize(){const t=this._originalDesignResolutionSize.width,e=this._originalDesignResolutionSize.height;t>0&&this.setDesignResolutionSize(t,e,this._resolutionPolicy)}_setViewportMeta(t,e){let n=document.getElementById("cocosMetaElement");n&&e&&document.head.removeChild(n);const i=document.getElementsByName("viewport"),s=i?i[0]:null;let r,o,a;for(o in r=s?s.content:"",n=n||document.createElement("meta"),n.id="cocosMetaElement",n.name="viewport",n.content="",t)-1===r.indexOf(o)?r+=`,${o}=${t[o]}`:e&&(a=new RegExp(o+"s*=s*[^,]+"),r=r.replace(a,`${o}=${t[o]}`));/^,/.test(r)&&(r=r.substr(1)),n.content=r,s&&(s.content=r),document.head.appendChild(n)}_adjustViewportMeta(){this._isAdjustViewport}_convertMouseToLocation(t,e){t.x=this._devicePixelRatio*(t.x-e.left),t.y=this._devicePixelRatio*(e.top+e.height-t.y),i.GAME_VIEW&&(t.x/=i.gameView.canvas.width/i.game.canvas.width,t.y/=i.gameView.canvas.height/i.game.canvas.height)}_convertTouchWidthScale(t){const e=this._viewportRect,n=this._scaleX,i=this._scaleY;t._point.x=(t._point.x-e.x)/n,t._point.y=(t._point.y-e.y)/i,t._prevPoint.x=(t._prevPoint.x-e.x)/n,t._prevPoint.y=(t._prevPoint.y-e.y)/i}_convertTouchesWithScale(t){const e=this._viewportRect,n=this._scaleX,i=this._scaleY;let s,r;for(let o=0;o<t.length;o++){const a=t[o];s=a._point,r=a._prevPoint,s.x=(s.x-e.x)/n,s.y=(s.y-e.y)/i,r.x=(r.x-e.x)/n,r.y=(r.y-e.y)/i}}}t("View",lf),lf.instance=void 0;class hf{constructor(){this.name="ContainerStrategy"}preApply(t){}apply(t,e){}postApply(t){}_setupContainer(t,e,n){const s=i.game.canvas,r=i.game.container;i.sys.os===i.sys.OS_ANDROID&&(document.body.style.width=(t._isRotated?n:e)+"px",document.body.style.height=(t._isRotated?e:n)+"px"),r.style.width=s.style.width=e+"px",r.style.height=s.style.height=n+"px",t._devicePixelRatio=1,t.isRetinaEnabled()&&(t._devicePixelRatio=Math.min(t._maxPixelRatio,window.devicePixelRatio||1)),s.width=Om.windowPixelResolution.width,s.height=Om.windowPixelResolution.height}_fixContainer(){document.body.insertBefore(i.game.container,document.body.firstChild);const t=document.body.style;t.width=window.innerWidth+"px",t.height=window.innerHeight+"px",t.overflow="hidden";const e=i.game.container.style;e.position="fixed",e.left=e.top="0px",document.body.scrollTop=0}}hf.EQUAL_TO_FRAME=void 0,hf.PROPORTION_TO_FRAME=void 0;class _f{constructor(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}preApply(t){}apply(t,e){return{scale:[1,1]}}postApply(t){}_buildResult(t,e,n,i,s,r){Math.abs(t-n)<2&&(n=t),Math.abs(e-i)<2&&(i=e);const o=new Mn(Math.round((t-n)/2),Math.round((e-i)/2),n,i);return this._result.scale=[s,r],this._result.viewport=o,this._result}}_f.EXACT_FIT=void 0,_f.SHOW_ALL=void 0,_f.NO_BORDER=void 0,_f.FIXED_HEIGHT=void 0,_f.FIXED_WIDTH=void 0,(()=>{const t=("undefined"==typeof window?global:window).__globalAdapter;t&&(t.adaptContainerStrategy&&t.adaptContainerStrategy(hf.prototype),t.adaptView&&t.adaptView(lf.prototype)),hf.EQUAL_TO_FRAME=new class extends hf{constructor(...t){super(...t),this.name="EqualToFrame"}apply(t){const e=t._frameSize.height,n=i.game.container.style;this._setupContainer(t,t._frameSize.width,t._frameSize.height),t._isRotated?n.margin=`0 0 0 ${e}px`:n.margin="0px",n.padding="0px"}},hf.PROPORTION_TO_FRAME=new class extends hf{constructor(...t){super(...t),this.name="ProportionalToFrame"}apply(t,e){const n=t._frameSize.width,s=t._frameSize.height,r=i.game.container.style,o=e.width,a=e.height,c=n/o,l=s/a;let h,_;c<l?(h=n,_=a*c):(h=o*l,_=s);const u=Math.round((n-h)/2),d=Math.round((s-_)/2);h=n-2*u,_=s-2*d,this._setupContainer(t,h,_),t._isRotated?r.margin=`0 0 0 ${s}px`:r.margin="0px",r.paddingLeft=u+"px",r.paddingRight=u+"px",r.paddingTop=d+"px",r.paddingBottom=d+"px"}},_f.EXACT_FIT=new class extends _f{constructor(...t){super(...t),this.name="ExactFit"}apply(t,e){const n=i.game.canvas.width,s=i.game.canvas.height,r=n/e.width,o=s/e.height;return this._buildResult(n,s,n,s,r,o)}},_f.SHOW_ALL=new class extends _f{constructor(...t){super(...t),this.name="ShowAll"}apply(t,e){const n=i.game.canvas.width,s=i.game.canvas.height,r=e.width,o=e.height,a=n/r,c=s/o;let l,h,_=0;return a<c?(_=a,l=n,h=o*_):(_=c,l=r*_,h=s),this._buildResult(n,s,l,h,_,_)}},_f.NO_BORDER=new class extends _f{constructor(...t){super(...t),this.name="NoBorder"}apply(t,e){const n=i.game.canvas.width,s=i.game.canvas.height,r=e.width,o=e.height,a=n/r,c=s/o;let l,h,_;return a<c?(l=c,h=r*l,_=s):(l=a,h=n,_=o*l),this._buildResult(n,s,h,_,l,l)}},_f.FIXED_HEIGHT=new class extends _f{constructor(...t){super(...t),this.name="FixedHeight"}apply(t,e){const n=i.game.canvas.width,s=i.game.canvas.height,r=s/e.height,o=n,a=s;return this._buildResult(n,s,o,a,r,r)}},_f.FIXED_WIDTH=new class extends _f{constructor(...t){super(...t),this.name="FixedWidth"}apply(t,e){const n=i.game.canvas.width,s=i.game.canvas.height,r=n/e.width,o=n,a=s;return this._buildResult(n,s,o,a,r,r)}}})();class uf{constructor(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}get canvasSize(){return new rn(i.game.canvas.width,i.game.canvas.height)}preApply(t){this._containerStrategy.preApply(t),this._contentStrategy.preApply(t)}apply(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)}postApply(t){this._containerStrategy.postApply(t),this._contentStrategy.postApply(t)}setContainerStrategy(t){t instanceof hf&&(this._containerStrategy=t)}setContentStrategy(t){t instanceof _f&&(this._contentStrategy=t)}}t("ResolutionPolicy",uf),uf.EXACT_FIT=0,uf.NO_BORDER=1,uf.SHOW_ALL=2,uf.FIXED_HEIGHT=3,uf.FIXED_WIDTH=4,uf.UNKNOWN=5,uf.ContainerStrategy=hf,uf.ContentStrategy=_f,i.ResolutionPolicy=uf;const df=t("view",lf.instance=i.view=new lf);let pf;i.winSize=new On,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(pf||(pf=t("SystemEventType",{}))),Xt(pf),i.SystemEventType=pf;let mf=null,ff=null,gf=null,vf=null;class yf extends d_{constructor(){super()}setAccelerometerEnabled(t){t&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then(t=>{v(3520,t),rf.setAccelerometerEnabled("granted"===t)}).catch(t=>{x(3521,t.message),rf.setAccelerometerEnabled(!1)}):rf.setAccelerometerEnabled(t)}setAccelerometerInterval(t){rf.setAccelerometerInterval(t)}on(t,e,n,s){return super.on(t,e,n,s),t!==pf.KEY_DOWN&&t!==pf.KEY_UP||mf||(mf=Hm.create({event:Hm.KEYBOARD,onKeyPressed(t,e){e.type=pf.KEY_DOWN,xf.emit(e.type,e)},onKeyReleased(t,e){e.type=pf.KEY_UP,xf.emit(e.type,e)}}),$m.addListener(mf,256)),t===pf.DEVICEMOTION&&(ff||(ff=Hm.create({event:Hm.ACCELERATION,callback(t,e){e.type=pf.DEVICEMOTION,i.systemEvent.emit(e.type,e)}}),$m.addListener(ff,256))),t!==pf.TOUCH_START&&t!==pf.TOUCH_MOVE&&t!==pf.TOUCH_END&&t!==pf.TOUCH_CANCEL||gf||(gf=Hm.create({event:Hm.TOUCH_ONE_BY_ONE,onTouchBegan:(t,e)=>(e.type=pf.TOUCH_START,i.systemEvent.emit(e.type,t,e),!0),onTouchMoved(t,e){e.type=pf.TOUCH_MOVE,i.systemEvent.emit(e.type,t,e)},onTouchEnded(t,e){e.type=pf.TOUCH_END,i.systemEvent.emit(e.type,t,e)},onTouchCancelled(t,e){e.type=pf.TOUCH_CANCEL,i.systemEvent.emit(e.type,t,e)}}),$m.addListener(gf,256)),t!==pf.MOUSE_DOWN&&t!==pf.MOUSE_MOVE&&t!==pf.MOUSE_UP&&t!==pf.MOUSE_WHEEL||vf||(vf=Hm.create({event:Hm.MOUSE,onMouseDown(t){t.type=pf.MOUSE_DOWN,i.systemEvent.emit(t.type,t)},onMouseMove(t){t.type=pf.MOUSE_MOVE,i.systemEvent.emit(t.type,t)},onMouseUp(t){t.type=pf.MOUSE_UP,i.systemEvent.emit(t.type,t)},onMouseScroll(t){t.type=pf.MOUSE_WHEEL,i.systemEvent.emit(t.type,t)}}),$m.addListener(vf,256)),e}off(t,e,n){if(super.off(t,e,n),mf&&(t===pf.KEY_DOWN||t===pf.KEY_UP)){const t=this.hasEventListener(pf.KEY_DOWN),e=this.hasEventListener(pf.KEY_UP);t||e||($m.removeListener(mf),mf=null)}if(ff&&t===pf.DEVICEMOTION&&($m.removeListener(ff),ff=null),gf&&(t===pf.TOUCH_START||t===pf.TOUCH_MOVE||t===pf.TOUCH_END||t===pf.TOUCH_CANCEL)){const t=this.hasEventListener(pf.TOUCH_START),e=this.hasEventListener(pf.TOUCH_MOVE),n=this.hasEventListener(pf.TOUCH_END),i=this.hasEventListener(pf.TOUCH_CANCEL);t||e||n||i||($m.removeListener(gf),gf=null)}if(vf&&(t===pf.MOUSE_DOWN||t===pf.MOUSE_MOVE||t===pf.MOUSE_UP||t===pf.MOUSE_WHEEL)){const t=this.hasEventListener(pf.MOUSE_DOWN),e=this.hasEventListener(pf.MOUSE_MOVE),n=this.hasEventListener(pf.MOUSE_UP),i=this.hasEventListener(pf.MOUSE_WHEEL);t||e||n||i||($m.removeListener(vf),vf=null)}}}t("SystemEvent",yf),yf.EventType=pf,i.SystemEvent=yf;const xf=t("systemEvent",new yf);i.systemEvent=xf;const Sf=t("screen",{_supportsFullScreen:!1,_onfullscreenchange:null,_onfullscreenerror:null,_preOnFullScreenError:null,_preOnTouch:null,_touchEvent:"",_fn:null,_fnMap:[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement"]],init(){let t,e,n;this._fn={};const i=this._fnMap;let s;for(t=0,e=i.length;t<e;t++)if(n=i[t],n&&void 0!==document[n[1]]){for(t=0,s=n.length;t<s;t++)this._fn[i[0][t]]=n[t];break}this._supportsFullScreen=void 0!==this._fn.requestFullscreen,this._touchEvent="ontouchstart"in window?"touchstart":"mousedown"},get supportsFullScreen(){return this._supportsFullScreen},fullScreen(){return!!this._supportsFullScreen&&void 0!==document[this._fn.fullscreenElement]&&null!==document[this._fn.fullscreenElement]},requestFullScreen(t,e,n){if(!this._supportsFullScreen)return;if(t=t||document.documentElement,e){const t=this._fn.fullscreenchange;this._onfullscreenchange&&document.removeEventListener(t,this._onfullscreenchange),this._onfullscreenchange=e,document.addEventListener(t,e,!1)}if(n){const t=this._fn.fullscreenerror;this._onfullscreenerror&&document.removeEventListener(t,this._onfullscreenerror),this._onfullscreenerror=n,document.addEventListener(t,n,{once:!0})}const i=t[this._fn.requestFullscreen]();return window.Promise&&i instanceof Promise&&i.catch(()=>{}),i},exitFullScreen(){let t;return this.fullScreen()&&(t=document[this._fn.exitFullscreen](),t.catch(()=>{})),t},autoFullScreen(t,e){t=t||document.body,this._ensureFullScreen(t,e),this.requestFullScreen(t,e)},disableAutoFullScreen(t){if(this._preOnTouch){const e=i.game.canvas||t,n=this._touchEvent;e.removeEventListener(n,this._preOnTouch),this._preOnTouch=null}},_ensureFullScreen(t,e){const n=i.game.canvas||t,s=this._fn.fullscreenerror,r=this._touchEvent,o=()=>{this._preOnFullScreenError=null,this._preOnTouch&&n.removeEventListener(r,this._preOnTouch),this._preOnTouch=()=>{this._preOnTouch=null,this.requestFullScreen(t,e)},n.addEventListener(r,this._preOnTouch,{once:!0})};this._preOnFullScreenError&&t.removeEventListener(s,this._preOnFullScreenError),this._preOnFullScreenError=o,t.addEventListener(s,o,{once:!0})}});Sf.init(),i.screen=Sf;class Tf{set splashFinish(t){this._splashFinish=t,this._tryToStart()}set loadFinish(t){this._loadFinish=t,this._tryToStart()}main(t){if(null!=t){if(window._CCSettings&&window._CCSettings.splashScreen){const t=this.setting=window._CCSettings.splashScreen;t.totalTime=null!=this.setting.totalTime?this.setting.totalTime:3e3,t.base64src=this.setting.base64src||"",t.effect=this.setting.effect||"FADE-INOUT",t.clearColor=this.setting.clearColor||new Hr(.88,.88,.88,1),t.displayRatio=null!=this.setting.displayRatio?this.setting.displayRatio:.4,t.displayWatermark=null==this.setting.displayWatermark||this.setting.displayWatermark}else this.setting={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new Hr(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.setting.base64src||this.setting.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.setting=null,this._directCall=!0;else{i.view.enableRetina(!0);const e=window._CCSettings.designResolution;e?i.view.setDesignResolutionSize(e.width,e.height,e.policy):i.view.setDesignResolutionSize(960,640,4),this.root=t,this.device=t.device,i.game.once(i.Game.EVENT_GAME_INITED,()=>{i.director._lateUpdate=performance.now()},i.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1;const n=this.setting.clearColor;this.clearColors=[new Hr(n.x,n.y,n.z,n.w)];const{width:s,height:r,surfaceTransform:o}=this.device;this.screenWidth=o%2?r:s,this.screenHeight=o%2?s:r,this.image=new Image,this.image.onload=this.init.bind(this),this.image.src=this.setting.base64src}}else u("RENDER ROOT IS NULL.")}setOnFinish(t){if(this._directCall&&t)return Tf._ins=void 0,void t();this.callBack=t}_tryToStart(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),i.game.resume())}init(){if(Om.os===i.sys.OS_OSX||Om.os===i.sys.OS_IOS){const t=screen.width*devicePixelRatio,e=screen.height*devicePixelRatio;this.device.resize(t,e),this.screenWidth=this.device.width,this.screenHeight=this.device.height}this.initCMD(),this.initIA(),this.initPSO(),this.setting.displayWatermark&&this.initText();const t=e=>{if(this.cancelAnimate)return;this.startTime<0&&(this.startTime=e);const n=e-this.startTime;let i=em(Ve(n/this.setting.totalTime));"NONE"===this.setting.effect&&(i=1),this.material.setProperty("u_precent",i),this.material.passes[0].update(),this.setting.displayWatermark&&this.textMaterial&&(this.textMaterial.setProperty("u_precent",i),this.textMaterial.passes[0].update()),this.frame(e),n>this.setting.totalTime&&(this.splashFinish=!0),requestAnimationFrame(t)};i.game.pause(),this.handle=requestAnimationFrame(t)}hide(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))}frame(t){if(this.cancelAnimate)return;const e=this.device;e.acquire();const n=this.cmdBuff,s=this.framebuffer,r=this.renderArea;Om.os===i.sys.OS_OSX||Om.os===i.sys.OS_IOS?(r.height=e.nativeHeight,r.width=e.nativeWidth):(r.height=e.height,r.width=e.width),n.begin(),n.beginRenderPass(s.renderPass,s,r,this.clearColors,1,0);const o=this.material.passes[0],a=Nm.getOrCreatePipelineState(e,o,this.shader,s.renderPass,this.assmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(Pc.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.assmebler),n.draw(this.assmebler),this.setting.displayWatermark&&this.textShader&&this.textAssmebler){const t=this.textMaterial.passes[0],i=Nm.getOrCreatePipelineState(e,t,this.textShader,s.renderPass,this.textAssmebler);n.bindPipelineState(i),n.bindDescriptorSet(Pc.MATERIAL,t.descriptorSet),n.bindInputAssembler(this.textAssmebler),n.draw(this.textAssmebler)}n.endRenderPass(),n.end(),e.queue.submit([n]),e.present()}initText(){this.textImg=document.createElement("canvas"),this.textImg.width=330,this.textImg.height=30,this.textImg.style.width=""+this.textImg.width,this.textImg.style.height=""+this.textImg.height;const t=this.textImg.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";const e="Powered by Cocos Creator",n=t.measureText(e);t.fillText(e,(330-n.width)/2,6),this.textRegion=new Wr,this.textRegion.texExtent.width=this.textImg.width,this.textRegion.texExtent.height=this.textImg.height,this.textRegion.texExtent.depth=1,this.textTexture=this.device.createTexture(new eo(hr.TEX2D,_r.SAMPLED|_r.TRANSFER_DST,Xs.RGBA8,this.textImg.width,this.textImg.height)),this.device.copyTexImagesToTexture([this.textImg],this.textTexture,[this.textRegion]),this.textMaterial=new Ap,this.textMaterial.initialize({effectName:"splash-screen"});const i=this.textMaterial.passes[0],s=i.getBinding("mainTexture");i.bindTexture(s,this.textTexture),this.textShader=Yn.get(i.getShaderVariant()),Kn.get(hi.get(i.handle,ci.DESCRIPTOR_SET)).update();const r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.textVB=this.device.createBuffer(new uo(Ys.VERTEX|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,o,r));const a=new Float32Array(16);let c=-this.textImg.width/2,l=-this.textImg.height/2;this.screenWidth<this.screenHeight?(c=-this.screenWidth/2*.5,l=c/(this.textImg.width/this.textImg.height)):(c=-this.screenHeight/2*.5,l=c/(this.textImg.width/this.textImg.height));let h=0;a[h++]=c,a[h++]=l,a[h++]=0,a[h++]=1,a[h++]=-c,a[h++]=l,a[h++]=1,a[h++]=1,a[h++]=c,a[h++]=-l,a[h++]=0,a[h++]=0,a[h++]=-c,a[h++]=-l,a[h++]=1,a[h++]=0;for(let t=0;t<a.length;t+=4)a[t]+=this.screenWidth/2,a[t+1]+=.1*this.screenHeight;const _=this.device.screenSpaceSignY,u=An[this.device.surfaceTransform];for(let t=0;t<a.length;t+=4){const e=a[t]/this.screenWidth*2-1,n=(a[t+1]/this.screenHeight*2-1)*_;a[t]=u[0]*e+u[2]*n,a[t+1]=u[1]*e+u[3]*n}this.textVB.update(a);const d=Uint16Array.BYTES_PER_ELEMENT,p=6*d;this.textIB=this.device.createBuffer(new uo(Ys.INDEX|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,p,d));const m=new Uint16Array(6);m[0]=0,m[1]=1,m[2]=2,m[3]=1,m[4]=3,m[5]=2,this.textIB.update(m);const f=[new Yo("a_position",Xs.RG32F),new Yo("a_texCoord",Xs.RG32F)],g=new Vo(f,[this.textVB],this.textIB);this.textAssmebler=this.device.createInputAssembler(g)}initCMD(){const t=this.device;Om.os===i.sys.OS_OSX||Om.os===i.sys.OS_IOS?this.renderArea=new Ur(0,0,t.nativeWidth,t.nativeHeight):this.renderArea=new Ur(0,0,t.width,t.height),this.framebuffer=this.root.mainWindow.framebuffer,this.cmdBuff=t.commandBuffer}initIA(){const t=this.device,e=4*Float32Array.BYTES_PER_ELEMENT,n=4*e;this.vertexBuffers=t.createBuffer(new uo(Ys.VERTEX|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,n,e));const i=new Float32Array(16);let s=-this.image.width/2,r=-this.image.height/2;this.screenWidth<this.screenHeight?(s=-this.screenWidth/2*this.setting.displayRatio,r=s/(this.image.width/this.image.height)):(s=-this.screenHeight/2*this.setting.displayRatio,r=s/(this.image.width/this.image.height));let o=0;i[o++]=s,i[o++]=r,i[o++]=0,i[o++]=1,i[o++]=-s,i[o++]=r,i[o++]=1,i[o++]=1,i[o++]=s,i[o++]=-r,i[o++]=0,i[o++]=0,i[o++]=-s,i[o++]=-r,i[o++]=1,i[o++]=0;for(let t=0;t<i.length;t+=4)i[t]+=this.screenWidth/2,i[t+1]+=this.screenHeight/2;const a=this.device.screenSpaceSignY,c=An[this.device.surfaceTransform];for(let t=0;t<i.length;t+=4){const e=i[t]/this.screenWidth*2-1,n=(i[t+1]/this.screenHeight*2-1)*a;i[t]=c[0]*e+c[2]*n,i[t+1]=c[1]*e+c[3]*n}this.vertexBuffers.update(i);const l=Uint16Array.BYTES_PER_ELEMENT,h=6*l;this.indicesBuffers=t.createBuffer(new uo(Ys.INDEX|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,h,l));const _=new Uint16Array(6);_[0]=0,_[1]=1,_[2]=2,_[3]=1,_[4]=3,_[5]=2,this.indicesBuffers.update(_);const u=[new Yo("a_position",Xs.RG32F),new Yo("a_texCoord",Xs.RG32F)],d=new Vo(u,[this.vertexBuffers],this.indicesBuffers);this.assmebler=t.createInputAssembler(d)}initPSO(){const t=this.device;this.material=new Ap,this.material.initialize({effectName:"splash-screen"});const e=new Eo;e.addressU=lr.CLAMP,e.addressV=lr.CLAMP,this.sampler=t.createSampler(e),this.texture=t.createTexture(new eo(hr.TEX2D,_r.SAMPLED|_r.TRANSFER_DST,Xs.RGBA8,this.image.width,this.image.height));const n=this.material.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.texture),this.shader=Yn.get(n.getShaderVariant());const s=Kn.get(hi.get(n.handle,ci.DESCRIPTOR_SET));s.bindSampler(i,this.sampler),s.update(),this.region=new Wr,this.region.texExtent.width=this.image.width,this.region.texExtent.height=this.image.height,this.region.texExtent.depth=1,t.copyTexImagesToTexture([this.image],this.texture,[this.region])}destroy(){this.callBack=null,this.clearColors=null,this.device=null,this.image.destroy(),this.image=null,this.framebuffer=null,this.renderArea=null,this.region=null,this.cmdBuff=null,this.shader=null,this.material.destroy(),this.material=null,this.texture.destroy(),this.texture=null,this.assmebler.destroy(),this.assmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler.destroy(),this.sampler=null,this.textImg&&(this.textImg=null,this.textRegion=null,this.textShader=null,this.textMaterial.destroy(),this.textMaterial=null,this.textTexture.destroy(),this.textTexture=null,this.textAssmebler.destroy(),this.textAssmebler=null,this.textVB.destroy(),this.textVB=null,this.textIB.destroy(),this.textIB=null),this.setting=null,Tf._ins=void 0}static get instance(){return Tf._ins||(Tf._ins=new Tf),Tf._ins}constructor(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}}Tf._ins=void 0,i.internal.SplashScreen=Tf;let Ef,Cf,Af,bf,wf,Rf,If=10,Pf=0;const Of=new Map;bf=(t,e,n,i,s,r)=>{const o=Of.get(r);o&&o.logTimes>o.count&&(s("'%s' is deprecated, please use '%s' instead.",`${t}.${e}`,`${n}.${i}`),o.count++)},Ef=t("replaceProperty",(t,e,n)=>{null!=t&&n.forEach(n=>{const i=Pf++;Of.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:If});const s=null!=n.target?n.target:t,r=null!=n.newName?n.newName:n.name,o=null!=n.targetName?n.targetName:e,a=s==t;if(null!=n.customFunction)t[n.name]=function(){return bf(e,n.name,o,r,_,i),n.customFunction.call(this,...arguments)};else if(null!=n.customSetter||null!=n.customGetter){const s=null!=n.customSetter,a=null!=n.customGetter;s&&a?Object.defineProperty(t,n.name,{get(){return bf(e,n.name,o,r,_,i),n.customGetter.call(this)},set(t){bf(e,n.name,o,r,_,i),n.customSetter.call(this,t)},enumerable:!1}):s?Object.defineProperty(t,n.name,{set(t){bf(e,n.name,o,r,_,i),n.customSetter.call(this,t)},enumerable:!1}):a&&Object.defineProperty(t,n.name,{get(){return bf(e,n.name,o,r,_,i),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,n.name,{get(){return bf(e,n.name,o,r,_,i),a?this[r]:s[r]},set(t){bf(e,n.name,o,r,_,i),a?this[r]=t:s[r]=t},enumerable:!1})})}),Rf=(t,e,n,i,s)=>{const r=Of.get(i),o=void 0===s?"":`(${s})`;r&&r.logTimes>r.count&&(n("'%s' has been removed. "+o,`${t}.${e}`),r.count++)},Cf=t("removeProperty",(t,e,n)=>{null!=t&&n.forEach(n=>{const i=Pf++;Of.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:If}),Object.defineProperty(t,n.name,{get:()=>Rf(e,n.name,u,i,n.suggest),set(){Rf(e,n.name,u,i,n.suggest)},enumerable:!1})})}),wf=(t,e,n,i,s)=>{const r=Of.get(i),o=void 0===s?"":`(${s})`;r&&r.logTimes>r.count&&(n("'%s' is deprecated. "+o,`${t}.${e}`),r.count++)},Af=t("markAsWarning",(t,e,n)=>{if(null==t)return;const i=(t,e,n,i,s,r)=>{if(t.get){const o=t.get();t.get=function(){return wf(e,n,i,s,r),o.call(this)}}if(t.set){const o=Object.create(t.set);t.set=function(t){wf(e,n,i,s,r),o.call(this,t)}}};n.forEach(n=>{const s=n.name,r=Object.getOwnPropertyDescriptor(t,s);if(!r)return;const o=Pf++;if(Of.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:If}),null!=r.value)if("function"==typeof r.value){const i=r.value;t[s]=function(){return wf(e,s,_,o,n.suggest),i.call(this,...arguments)}}else i(r,e,s,_,o,n.suggest);else i(r,e,s,_,o,n.suggest);Object.defineProperty(t,s,{enumerable:!1})})});const Df=n_.Flags.Destroyed,Mf=n_.Flags.PersistentMask,Nf=Me.IDENTIFIER_RE,Lf={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},zf=Me.escapeForJS;class Bf{constructor(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}toString(){return`${"var "+this.varName}=${this.expression};`}}function Ff(t,e){return e instanceof Bf?new Bf(e.varName,t+e.expression):t+e}function Uf(t,e,n){Array.isArray(n)?(n[0]=Ff(e,n[0]),t.push(n)):t.push(Ff(e,n)+";")}class Gf{constructor(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}append(t,e){this._exps.push([t,e])}writeCode(t){let e;if(this._exps.length>1)t.push(`t=${this._targetExp};`),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(let n=0;n<this._exps.length;n++){const i=this._exps[n];Uf(t,e+Hf(i[0])+"=",i[1])}}}function Hf(t){return Nf.test(t)?"."+t:`[${zf(t)}]`}Gf.pool=void 0,Gf.pool=new Gt(t=>{t._exps.length=0,t._targetExp=null},1),Gf.pool.get=function(t){const e=this._get()||new Gf;return e._targetExp=t,e};class Vf{constructor(t,e){let n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=dt(),Ct(this.funcModuleCache,Lf),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{",`o=R=new ${this.getFuncModule(t.constructor,!0)}();`,"}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(n="var "+this.globalVariables.join(",")+";");const i=function(t){const e=[];return function t(e,n){for(const i of n)Array.isArray(i)?t(e,i):e.push(i)}(e,t),e.join("")}(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(let t=0,e=this.objsToClear_iN$t.length;t<e;++t)this.objsToClear_iN$t[t]._iN$t=null;this.objsToClear_iN$t.length=0}getFuncModule(t,e){const n=pt(t);if(n){const e=this.funcModuleCache[n];if(e)return e;if(void 0===e){let e=-1!==n.indexOf(".");if(e)try{if(e=t===Function("return "+n)(),e)return this.funcModuleCache[n]=n,n}catch(t){}}}let i=this.funcs.indexOf(t);i<0&&(i=this.funcs.length,this.funcs.push(t));let s=`F[${i}]`;return e&&(s=`(${s})`),this.funcModuleCache[n]=s,s}getObjRef(t){let e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),`O[${e}]`}setValueType(t,e,n,i){const s=Gf.pool.get(i);let r=e.constructor.__props__;r||(r=Object.keys(e));for(let t=0;t<r.length;t++){const i=r[t],o=n[i];if(e[i]===o)continue;const a=this.enumerateField(n,i,o);s.append(i,a)}s.writeCode(t),Gf.pool.put(s)}enumerateCCClass(t,e,n){const s=n.__values__,r=_e(n);for(let n=0;n<s.length;n++){const o=s[n],a=e[o];let c=r[o+"$_$default"];if(!kf(c,a))if("object"==typeof a&&a instanceof i.ValueType&&(c=Me.getDefault(c),c&&c.constructor===a.constructor)){const e="o"+Hf(o);this.setValueType(t,c,a,e)}else this.setObjProp(t,e,o,a)}}instantiateArray(t){if(0===t.length)return"[]";const e="a"+ ++this.localVariableId,n=[new Bf(e,`new Array(${t.length})`)];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(let i=0;i<t.length;++i)Uf(n,`${e}[${i}]=`,this.enumerateField(t,i,t[i]));return n}instantiateTypedArray(t){const e=t.constructor.name;if(0===t.length)return"new "+e;const n="a"+ ++this.localVariableId,i=[new Bf(n,`new ${e}(${t.length})`)];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(let e=0;e<t.length;++e)0!==t[e]&&Uf(i,`${n}[${e}]=`,t[e]);return i}enumerateField(t,e,n){if("object"==typeof n&&n){const t=n._iN$t;if(t){let e=t.globalVar;if(!e){e=t.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(e);const n=t.source[0];t.source[0]=Ff(e+"=",n)}return e}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?zf(n):("_objFlags"===e&&t instanceof n_&&(n&=Mf),n)}setObjProp(t,e,n,i){Uf(t,"o"+Hf(n)+"=",this.enumerateField(e,n,i))}enumerateObject(t,e){const n=e.constructor;if(i.Class._isCCClass(n))this.enumerateCCClass(t,e,n);else for(const n in e){if(!e.hasOwnProperty(n)||95===n.charCodeAt(0)&&95===n.charCodeAt(1)&&"__type__"!==n)continue;const i=e[n];"object"==typeof i&&i&&i===e._iN$t||this.setObjProp(t,e,n,i)}}instantiateObj(t){if(t instanceof i.ValueType)return Me.getNewValueTypeCode(t);if(t instanceof i.Asset)return this.getObjRef(t);if(t._objFlags&Df)return null;let e;const n=t.constructor;if(i.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof i.Component){if(t instanceof i._BaseNode||t instanceof i.Component)return this.getObjRef(t)}else if(this.parent instanceof i._BaseNode)if(t instanceof i._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof i.Component&&!t.node.isChildOf(this.parent))return this.getObjRef(t);e=new Bf("o",`new ${this.getFuncModule(n,!0)}()`)}else if(n===Object)e=new Bf("o","{}");else{if(n)return this.getObjRef(t);e=new Bf("o","Object.create(null)")}const s=[e];return t._iN$t={globalVar:"",source:s},this.objsToClear_iN$t.push(t),this.enumerateObject(s,t),["(function(){",s,"return o;})();"]}}function kf(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof i.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return ct(t)&&ct(e)}return!1}var jf=Object.freeze({__proto__:null,ccclass:Yl,property:Jl,requireComponent:Kl,executionOrder:$l,disallowMultiple:Zl,executeInEditMode:nh,menu:ih,playOnFocus:sh,inspector:rh,icon:oh,help:ah,type:Ah,integer:Sh,float:Th,boolean:Eh,string:Ch});t("_decorator",jf);const Wf=n_.Flags.Destroyed,qf=n_.Flags.PersistentMask,Xf=[];function Yf(t){let e;if(t instanceof n_){if(t._instantiate)return i.game._isCloning=!0,e=t._instantiate(null,!0),i.game._isCloning=!1,e;if(t instanceof i.Asset)throw new TypeError(b(6903))}return i.game._isCloning=!0,e=Kf(t),i.game._isCloning=!1,e}function Kf(t,e){let n;n=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),$f(t,n,e);for(let t=0,e=Xf.length;t<e;++t)Xf[t]._iN$t=null;return Xf.length=0,n}function $f(t,e,n){Vt.value(t,"_iN$t",e,!0),Xf.push(t);const s=t.constructor;if(i.Class._isCCClass(s))!function(t,e,n,i){const s=t.__values__;for(let t=0;t<s.length;t++){const r=s[t],o=e[r];if("object"==typeof o&&o){const t=n[r];t instanceof Yt&&t.constructor===o.constructor?t.set(o):n[r]=o._iN$t||Zf(o,i)}else n[r]=o}}(s,t,e,n);else for(const i in t){if(!t.hasOwnProperty(i)||95===i.charCodeAt(0)&&95===i.charCodeAt(1)&&"__type__"!==i)continue;const s=t[i];if("object"==typeof s&&s){if(s===e)continue;e[i]=s._iN$t||Zf(s,n)}else e[i]=s}t instanceof n_&&(e._objFlags&=qf)}function Zf(t,e){if(t instanceof Yt)return t.clone();if(t instanceof i.Asset)return t;let n;if(ArrayBuffer.isView(t)){const e=t.length;n=new t.constructor(e),t._iN$t=n,Xf.push(t);for(let i=0;i<e;++i)n[i]=t[i];return n}if(Array.isArray(t)){const i=t.length;n=new Array(i),t._iN$t=n,Xf.push(t);for(let s=0;s<i;++s){const i=t[s];n[s]="object"==typeof i&&i?i._iN$t||Zf(i,e):i}return n}if(t._objFlags&Wf)return null;const s=t.constructor;if(i.Class._isCCClass(s)){if(e)if(e instanceof i.Component){if(t instanceof i._BaseNode||t instanceof i.Component)return t}else if(e instanceof i._BaseNode)if(t instanceof i._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof i.Component&&!t.node.isChildOf(e))return t;n=new s}else if(s===Object)n={};else{if(s)return t;n=Object.create(null)}return $f(t,n,e),n}var Jf,Qf,tg,eg,ng,ig,sg,rg;let og,ag;function cg(t,e){return(e<<3)+t}Yf._clone=Kf,i.instantiate=Yf,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(og||(og={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}(ag||(ag={}));let lg=t("CompactValueTypeArray",Yl("cc.CompactValueTypeArray")((rg=sg=class t{constructor(){Ul(this,"_byteOffset",tg,this),Ul(this,"_unitCount",eg,this),Ul(this,"_unitElement",ng,this),Ul(this,"_length",ig,this)}static lengthFor(t,e,n){return hg(e).requiredUnits*t.length*_g(n).BYTES_PER_ELEMENT}static compress(e,n,i,s,r,o){const a=hg(n),c=_g(i),l=a.requiredUnits*e.length,h=new c(s,r,l);for(let t=0;t<e.length;++t)a.compress(h,t,e[t]);const _=new t;return _._unitElement=cg(i,n),_._byteOffset=o,_._unitCount=l,_._length=e.length,_}decompress(t){const{storageUnit:e,elementType:n}={storageUnit:7&(i=this._unitElement),elementType:i>>3};var i;const s=hg(n),r=new(_g(e))(t,this._byteOffset,this._unitCount),o=new Array(this._length);for(let t=0;t<this._length;++t)o[t]=s.decompress(r,t);return o}},sg.StorageUnit=og,sg.ElementType=ag,tg=Gl((Qf=rg).prototype,"_byteOffset",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eg=Gl(Qf.prototype,"_unitCount",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ng=Gl(Qf.prototype,"_unitElement",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cg(og.Uint8,ag.Scalar)}}),ig=Gl(Qf.prototype,"_length",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jf=Qf))||Jf);function hg(t){return ug[t]}function _g(t){switch(t){case og.Uint8:return Uint8Array;case og.Uint16:return Uint16Array;case og.Uint32:return Uint32Array;case og.Int8:return Int8Array;case og.Int16:return Int16Array;case og.Int32:return Int32Array;case og.Float32:return Float32Array;case og.Float64:return Float64Array}}const ug={[ag.Scalar]:{requiredUnits:1,compress(t,e,n){t[e]=n},decompress:(t,e)=>t[e]},[ag.Vec2]:{requiredUnits:2,compress(t,e,n){t[2*e]=n.x,t[2*e+1]=n.y},decompress:(t,e)=>new ln(t[2*e],t[2*e+1])},[ag.Vec3]:{requiredUnits:3,compress(t,e,n){t[3*e]=n.x,t[3*e+1]=n.y,t[3*e+2]=n.z},decompress:(t,e)=>new ln(t[3*e],t[3*e+1],t[3*e+2])},[ag.Vec4]:{requiredUnits:4,compress(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:(t,e)=>new dn(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},[ag.Quat]:{requiredUnits:4,compress(t,e,n){t[4*e]=n.x,t[4*e+1]=n.y,t[4*e+2]=n.z,t[4*e+3]=n.w},decompress:(t,e)=>new vn(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},[ag.Mat4]:{requiredUnits:16,compress(t,e,n){bn.toArray(t,n,16*e)},decompress:(t,e)=>bn.fromArray(new bn,t,16*e)}};var dg,pg,mg,fg,gg,vg,yg,xg,Sg,Tg,Eg,Cg,Ag,bg,wg,Rg,Ig,Pg,Og,Dg,Mg,Ng,Lg,zg,Bg,Fg,Ug,Gg,Hg,Vg,kg,jg,Wg,qg,Xg,Yg,Kg,$g,Zg,Jg,Qg,tv,ev,nv,iv,sv,rv,ov,av,cv,lv,hv,_v;i._decorator=jf;let uv=Yl("cc.TargetInfo")((mg=Gl((pg=class{constructor(){Ul(this,"localID",mg,this)}}).prototype,"localID",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dg=pg))||dg,dv=(fg=Yl("cc.TargetOverrideInfo"),gg=Ah(n_),vg=Ah(uv),yg=Ah(i.Node),xg=Ah(uv),fg((Eg=Gl((Tg=class{constructor(){Ul(this,"source",Eg,this),Ul(this,"sourceInfo",Cg,this),Ul(this,"propertyPath",Ag,this),Ul(this,"target",bg,this),Ul(this,"targetInfo",wg,this)}}).prototype,"source",[Ql,gg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cg=Gl(Tg.prototype,"sourceInfo",[Ql,vg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ag=Gl(Tg.prototype,"propertyPath",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bg=Gl(Tg.prototype,"target",[Ql,yg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wg=Gl(Tg.prototype,"targetInfo",[Ql,xg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sg=Tg))||Sg),pv=(Rg=Yl("cc.PrefabInfo"),Ig=Ah([dv]),Rg((Dg=Gl((Og=class{constructor(){Ul(this,"root",Dg,this),Ul(this,"asset",Mg,this),Ul(this,"fileId",Ng,this),Ul(this,"instance",Lg,this),Ul(this,"targetOverrides",zg,this)}}).prototype,"root",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Mg=Gl(Og.prototype,"asset",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ng=Gl(Og.prototype,"fileId",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Lg=Gl(Og.prototype,"instance",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),zg=Gl(Og.prototype,"targetOverrides",[Ql,Ig],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Pg=Og))||Pg);i._PrefabInfo=pv;let mv=Yl("cc.CompPrefabInfo")((Ug=Gl((Fg=class{constructor(){Ul(this,"fileId",Ug,this)}}).prototype,"fileId",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Bg=Fg))||Bg,fv=(Gg=Yl("CCPropertyOverrideInfo"),Hg=Ah(uv),Gg((jg=Gl((kg=class{constructor(){Ul(this,"targetInfo",jg,this),Ul(this,"propertyPath",Wg,this),Ul(this,"value",qg,this)}isTarget(t,e){}}).prototype,"targetInfo",[Ql,Hg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wg=Gl(kg.prototype,"propertyPath",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qg=Gl(kg.prototype,"value",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Vg=kg))||Vg),gv=(Xg=Yl("cc.MountedChildrenInfo"),Yg=Ah(uv),Kg=Ah([i.Node]),Xg((Jg=Gl((Zg=class{constructor(){Ul(this,"targetInfo",Jg,this),Ul(this,"nodes",Qg,this)}isTarget(t){}}).prototype,"targetInfo",[Ql,Yg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Qg=Gl(Zg.prototype,"nodes",[Ql,Kg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$g=Zg))||$g),vv=(tv=Yl("cc.PrefabInstance"),ev=Ah(i.Node),nv=Ah([gv]),iv=Ah([fv]),sv=Ah([uv]),tv((av=Gl((ov=class{constructor(){Ul(this,"fileId",av,this),Ul(this,"prefabRootNode",cv,this),Ul(this,"mountedChildren",lv,this),Ul(this,"propertyOverrides",hv,this),Ul(this,"removedComponents",_v,this),this.targetMap={}}findPropertyOverride(t,e){}removePropertyOverride(t,e){}}).prototype,"fileId",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cv=Gl(ov.prototype,"prefabRootNode",[Ql,ev],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lv=Gl(ov.prototype,"mountedChildren",[Ql,nv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hv=Gl(ov.prototype,"propertyOverrides",[Ql,iv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_v=Gl(ov.prototype,"removedComponents",[Ql,sv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rv=ov))||rv);function yv(t){const e=t._prefab;if(!e)return;if(!e.instance)return;if(!e.asset)return T(3701,t.name),void(e.instance=null);const n=t._objFlags,s=t._parent,r=t._id,o=t._prefab;i.game._isCloning=!0,e.asset._doInstantiate(t),i.game._isCloning=!1,t._objFlags=n,t._parent=s,t._id=r,t._prefab&&(t._prefab.instance=null==o?void 0:o.instance)}function xv(t,e,n){var i;let s=e;const r=null===(i=t._prefab)||void 0===i?void 0:i.instance;!n&&r&&(e[r.fileId]={},s=e[r.fileId]);const o=t._prefab;o&&(s[o.fileId]=t);const a=t.components;for(let t=0;t<a.length;t++){const e=a[t];e.__prefab&&(s[e.__prefab.fileId]=e)}for(let e=0;e<t.children.length;e++)xv(t.children[e],s,!1)}function Sv(t,e){if(!t)return null;let n=null,i=e;for(let e=0;e<t.length;e++){if(!i)return null;i=i[t[e]]}return n=i,n}function Tv(t,e,n){if(e)for(let t=0;t<e.length;t++){const i=e[t];if(i&&i.targetInfo){const t=Sv(i.targetInfo.localID,n);if(!t)continue;if(i.nodes)for(let e=0;e<i.nodes.length;e++){const n=i.nodes[e];t._children.push(n),n._parent=t,n._onBatchCreated(!1)}}}}function Ev(t,e,n){if(e.length<=0)return;let i=null;for(let t=0;t<e.length;t++){const s=e[t];if(s&&s.targetInfo){if(i=Sv(s.targetInfo.localID,n),!i)continue;let t=i;const e=s.propertyPath.slice();if(e.length>0){const n=e.pop();if(!n)continue;for(let n=0;n<e.length&&(t=t[e[n]],t);n++);if(!t)continue;if(Array.isArray(t))if("length"===n)t[n]=s.value;else{const e=Number.parseInt(n);Number.isInteger(e)&&e<t.length&&(t[n]=s.value)}else t[n]=s.value}}}}function Cv(t){var e;const n=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(n)for(let t=0;t<n.length;t++){var i,s;const e=n[t];let a=e.source;const c=e.sourceInfo;if(c){var r,o;const t=null===(r=e.source)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(t&&t.targetMap&&(a=Sv(c.localID,t.targetMap)),!a)continue}let l=null;const h=e.targetInfo;if(!h)continue;const _=null===(i=e.target)||void 0===i||null===(s=i._prefab)||void 0===s?void 0:s.instance;if(!_||!_.targetMap)continue;if(l=Sv(h.localID,_.targetMap),!l)continue;const u=e.propertyPath.slice();let d=a;if(u.length>0){const t=u.pop();if(!t)return;for(let t=0;t<u.length;t++)d=d[u[t]];d[t]=l}}}var Av,bv,wv,Rv,Iv,Pv,Ov,Dv=Object.freeze({__proto__:null,TargetInfo:uv,TargetOverrideInfo:dv,PrefabInfo:pv,CompPrefabInfo:mv,PropertyOverrideInfo:fv,MountedChildrenInfo:gv,PrefabInstance:vv,createNodeWithPrefab:yv,generateTargetMap:xv,getTarget:Sv,applyMountedChildren:Tv,applyPropertyOverrides:Ev,applyTargetOverrides:Cv});const Mv=jt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2});let Nv=t("Prefab",Yl("cc.Prefab")((Ov=Pv=class t extends y_{constructor(){super(),Ul(this,"data",wv,this),Ul(this,"optimizationPolicy",Rv,this),Ul(this,"asyncLoadAssets",Iv,this),this._createFunction=void 0,this._instantiatedTimes=void 0,this._createFunction=null,this._instantiatedTimes=0}createNode(t){const e=i.instantiate(this);e.name=this.name,t(null,e)}compileCreateFunction(){this._createFunction=function(t){const e=t instanceof i._BaseNode&&t;return new Vf(t,e).result}(this.data)}_doInstantiate(t){return this.data._prefab||x(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)}_instantiate(){let e,n=!1;return n=this.optimizationPolicy!==Mv.SINGLE_INSTANCE&&(this.optimizationPolicy===Mv.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold),n?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e}},Pv.OptimizationPolicy=Mv,Pv.OptimizationPolicyThreshold=3,wv=Gl((bv=Ov).prototype,"data",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Rv=Gl(bv.prototype,"optimizationPolicy",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mv.AUTO}}),Iv=Gl(bv.prototype,"asyncLoadAssets",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Av=bv))||Av);var Lv,zv,Bv,Fv,Uv,Gv;Vt.value(Nv,"_utils",Dv),i.Prefab=Nv,mt(i,"cc._Prefab","Prefab"),t("PrefabLink",(Lv=Yl("cc.PrefabLink"),zv=Ah(Nv),Bv=lh(),Lv((Gv=Gl((Uv=class extends Nu{constructor(...t){super(...t),Ul(this,"prefab",Gv,this)}}).prototype,"prefab",[zv,Ql,Bv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fv=Uv))||Fv));const Hv=new ln;function Vv(t,e,n,i){i||(i=new ln),t.convertToUINode(e,n,i);const s=n.position;return i.add(s),i}function kv(t,e,n){return n||(n=new ln),t.worldToScreen(e,n),n.x/=i.view.getScaleX(),n.y/=i.view.getScaleY(),n}const jv=t("convertUtils",{WorldNode3DToLocalNodeUI:Vv,WorldNode3DToWorldNodeUI:kv});var Wv,qv;i.pipelineUtils=jv,Ef(i.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction(...t){const e=t[0],n=t[3]||Hv;return e.convertToUINode(t[1],t[2],n),n.add(t[2].position),t[3]||n.clone()}}]),Cf($_.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),Ef(mp.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction(){return this._window}}]);let Xv=t("BufferAsset",Yl("cc.BufferAsset")((Gl((qv=class extends y_{constructor(...t){super(...t),this._buffer=null}get _nativeAsset(){return this._buffer}set _nativeAsset(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}buffer(){return this._buffer}}).prototype,"_nativeAsset",[bh],Object.getOwnPropertyDescriptor(qv.prototype,"_nativeAsset"),qv.prototype),Wv=qv))||Wv);i.BufferAsset=Xv;const Yv={[Ar.UNORM]:"Uint",[Ar.SNORM]:"Int",[Ar.UINT]:"Uint",[Ar.INT]:"Int",[Ar.UFLOAT]:"Float",[Ar.FLOAT]:"Float",default:"Uint"};function Kv(t){return(Yv[t.type]||Yv.default)+t.size/t.count*8}function $v(t,e,n=Xs.R32F,i=0,s=0){const r=Dr[n];s||(s=r.size);const o="set"+Kv(r),a=r.size/r.count,c=Math.floor(e.length/r.count),l=Om.isLittleEndian;for(let n=0;n<c;++n){const c=i+s*n;for(let i=0;i<r.count;++i){const s=c+a*i;t[o](s,e[r.count*n+i],l)}}}function Zv(t,e=Xs.R32F,n=0,i=t.byteLength-n,s=0,r=[]){const o=Dr[e];s||(s=o.size);const a="get"+Kv(o),c=o.size/o.count,l=Math.floor(i/s),h=Om.isLittleEndian;for(let e=0;e<l;++e){const i=n+s*e;for(let n=0;n<o.count;++n){const s=i+c*n;r[o.count*e+n]=t[a](s,h)}}return r}function Jv(t,e,n=Xs.R32F,i=0,s=t.byteLength-i,r=0,o){o||(o=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));const a=Dr[n];r||(r=a.size);const c="set"+Kv(a),l="get"+Kv(a),h=a.size/a.count,_=Math.floor(s/r),u=Om.isLittleEndian;for(let n=0;n<_;++n){const s=i+r*n;for(let n=0;n<a.count;++n){const i=s+h*n,r=t[l](i,u);o[c](i,e(r,n,t),u)}}return o}class Qv{constructor(t,e,n,i=null,s=null){this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._handle=0,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=i,this._indirectBuffer=s,this._primitiveMode=n,this._iaInfo=new Vo(e,t,i,s),this._handle=hs.alloc();const r=ni.alloc();hs.set(this._handle,cs.FLAT_BUFFER_ARRAY,r)}get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get indirectBuffer(){return this._indirectBuffer}get primitiveMode(){return this._primitiveMode}get geometricInfo(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:ln.ZERO,max:ln.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:ln.ZERO,max:ln.ZERO}};const{mesh:t}=this,e=this.subMeshIdx,n=t.readAttribute(e,Ws.ATTR_POSITION),i=t.readIndices(e),s=new ln,r=new ln,o=this.attributes.find(t=>t.name===Ws.ATTR_POSITION);if(o){const t=Dr[o.format].count;2===t?(s.set(n[0],n[1],0),r.set(n[0],n[1],0)):(s.set(n[0],n[1],n[2]),r.set(n[0],n[1],n[2]));for(let e=0;e<n.length;e+=t)2===t?(s.x=n[e]>s.x?n[e]:s.x,s.y=n[e+1]>s.y?n[e+1]:s.y,r.x=n[e]<r.x?n[e]:r.x,r.y=n[e+1]<r.y?n[e+1]:r.y):(s.x=n[e]>s.x?n[e]:s.x,s.y=n[e+1]>s.y?n[e+1]:s.y,s.z=n[e+2]>s.z?n[e+2]:s.z,r.x=n[e]<r.x?n[e]:r.x,r.y=n[e+1]<r.y?n[e+1]:r.y,r.z=n[e+2]<r.z?n[e+2]:r.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:s,min:r}},this._geometricInfo}get flatBuffers(){return this._flatBuffers}genFlatBuffers(){if(this._flatBuffers.length||!this.mesh||void 0===this.subMeshIdx)return;const{mesh:t}=this;let e=0;const n=t.struct.primitives[this.subMeshIdx],i=hs.get(this._handle,cs.FLAT_BUFFER_ARRAY);n.indexView&&(e=n.indexView.count);for(let s=0;s<n.vertexBundelIndices.length;s++){const r=n.vertexBundelIndices[s],o=t.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,c=o.view.stride,l=c*a,h=new Uint8Array(t.data.buffer,o.view.offset,o.view.length),_=oi.alloc(n.indexView?l:o.view.length),u=as.alloc();as.set(u,rs.STRIDE,c),as.set(u,rs.AMOUNT,a),as.set(u,rs.BUFFER,_),ni.push(i,u);const d=oi.getBuffer(_),p=new Uint8Array(d);if(!n.indexView){p.set(t.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:c,count:a,buffer:p});continue}const m=t.readIndices(this.subMeshIdx);for(let t=0;t<e;++t){const e=t*c,n=m[t]*c;for(let t=0;t<c;++t)p[e+t]=h[n+t]}this._flatBuffers.push({stride:c,count:a,buffer:p})}}get jointMappedBuffers(){if(this._jointMappedBuffers)return this._jointMappedBuffers;const t=this._jointMappedBuffers=[],e=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;const{struct:n}=this.mesh,s=n.primitives[this.subMeshIdx];if(!n.jointMaps||void 0===s.jointMapIndex||!n.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;let r,o;const{device:a}=i.director.root;for(let i=0;i<s.vertexBundelIndices.length;i++){const c=n.vertexBundles[s.vertexBundelIndices[i]];o=0,r=Xs.UNKNOWN;for(let t=0;t<c.attributes.length;t++){const e=c.attributes[t];if(e.name===Ws.ATTR_JOINTS){r=e.format;break}o+=Dr[e.format].size}if(r){const l=new Uint8Array(this.mesh.data.buffer,c.view.offset,c.view.length),h=new DataView(l.slice().buffer),_=n.jointMaps[s.jointMapIndex];Jv(h,t=>_.indexOf(t),r,o,c.view.length,c.view.stride,h);const u=a.createBuffer(new uo(Ys.VERTEX|Ys.TRANSFER_DST,Ks.DEVICE,c.view.length,c.view.stride));u.update(h.buffer),t.push(u),e.push(i)}else t.push(this.vertexBuffers[s.vertexBundelIndices[i]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(a)),t}get iaInfo(){return this._iaInfo}get handle(){return this._handle}destroy(){for(let t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(let t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null),this._handle&&(qn(hs.get(this._handle,cs.FLAT_BUFFER_ARRAY),ni,as),hs.free(this._handle),this._handle=0)}enableVertexIdChannel(t){if(this._vertexIdChannel)return;const e=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(t);this._vertexBuffers.push(i),this._attributes.push(new Yo("a_vertexId",Xs.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:n}}_allocVertexIdBuffer(t){const e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(e);for(let t=0;t<e;++t)n[t]=t+.5;const i=t.createBuffer(new uo(Ys.VERTEX|Ys.TRANSFER_DST,Ks.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return i.update(n),i}}var ty,ey,ny,iy;t("RenderingSubMesh",Qv);let sy=t("SceneAsset",Yl("cc.SceneAsset")((ny=Gl((ey=class extends y_{constructor(...t){super(...t),Ul(this,"scene",ny,this),Ul(this,"asyncLoadAssets",iy,this)}}).prototype,"scene",[ch,Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iy=Gl(ey.prototype,"asyncLoadAssets",[ch,Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ty=ey))||ty);var ry,oy,ay;i.SceneAsset=sy;let cy=t("TextAsset",Yl("cc.TextAsset")((ay=Gl((oy=class extends y_{constructor(...t){super(...t),Ul(this,"text",ay,this)}toString(){return this.text}}).prototype,"text",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ry=oy))||ry);var ly,hy,_y;i.TextAsset=cy;let uy=t("JsonAsset",Yl("cc.JsonAsset")((_y=Gl((hy=class extends y_{constructor(...t){super(...t),Ul(this,"json",_y,this)}}).prototype,"json",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ly=hy))||ly);i.JsonAsset=uy;class dy{constructor(){this._id="",this._priority=0,this._executeInEditMode=!1}set priority(t){this._priority=t}get priority(){return this._priority}set id(t){this._id=t}get id(){return this._id}static sortByPriority(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0}init(){}update(t){}postUpdate(t){}}t("System",dy);const py=new it("Scheduler");class my{constructor(t,e,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=n,this.markedForDeletion=i}}my.get=(t,e,n,i)=>{let s=my._listEntries.pop();return s?(s.target=t,s.priority=e,s.paused=n,s.markedForDeletion=i):s=new my(t,e,n,i),s},my.put=t=>{my._listEntries.length<20&&(t.target=null,my._listEntries.push(t))},my._listEntries=[];class fy{constructor(t,e,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=n,this.callback=i}}fy.get=(t,e,n,i)=>{let s=fy._hashUpdateEntries.pop();return s?(s.list=t,s.entry=e,s.target=n,s.callback=i):s=new fy(t,e,n,i),s},fy.put=t=>{fy._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,fy._hashUpdateEntries.push(t))},fy._hashUpdateEntries=[];class gy{constructor(t,e,n,i,s,r){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=s,this.paused=r}}gy.get=(t,e,n,i,s,r)=>{let o=gy._hashTimerEntries.pop();return o?(o.timers=t,o.target=e,o.timerIndex=n,o.currentTimer=i,o.currentTimerSalvaged=s,o.paused=r):o=new gy(t,e,n,i,s,r),o},gy.put=t=>{gy._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,gy._hashTimerEntries.push(t))},gy._hashTimerEntries=[];class vy{constructor(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}initWithCallback(t,e,n,s,r,o){return this._lock=!1,this._scheduler=t,this._target=n,this._callback=e,this._elapsed=-1,this._interval=s,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===i.macro.REPEAT_FOREVER,!0}getInterval(){return this._interval}setInterval(t){this._interval=t}update(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}getCallback(){return this._callback}trigger(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}cancel(){this._scheduler.unschedule(this._callback,this._target)}}vy._timers=[],vy.get=()=>vy._timers.pop()||new vy,vy.put=t=>{vy._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,vy._timers.push(t))};class yy extends dy{static enableForTarget(t){let e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?x(1513):t.id=py.getNewId())}constructor(){super(),this._timeScale=void 0,this._updatesNegList=void 0,this._updates0List=void 0,this._updatesPosList=void 0,this._hashForUpdates=void 0,this._hashForTimers=void 0,this._currentTarget=void 0,this._currentTargetSalvaged=void 0,this._updateHashLocked=void 0,this._arrayForTimers=void 0,this._timeScale=1,this._updatesNegList=[],this._updates0List=[],this._updatesPosList=[],this._hashForUpdates=dt(!0),this._hashForTimers=dt(!0),this._currentTarget=null,this._currentTargetSalvaged=!1,this._updateHashLocked=!1,this._arrayForTimers=[]}setTimeScale(t){this._timeScale=t}getTimeScale(){return this._timeScale}update(t){let e,n,i,s,r;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,n=this._updatesNegList,i=n.length;e<i;e++)s=n[e],s.paused||s.markedForDeletion||s.target.update(t);for(e=0,n=this._updates0List,i=n.length;e<i;e++)s=n[e],s.paused||s.markedForDeletion||s.target.update(t);for(e=0,n=this._updatesPosList,i=n.length;e<i;e++)s=n[e],s.paused||s.markedForDeletion||s.target.update(t);const o=this._arrayForTimers;for(e=0;e<o.length;e++){if(r=o[e],this._currentTarget=r,this._currentTargetSalvaged=!1,!r.paused)for(r.timerIndex=0;r.timerIndex<r.timers.length;++r.timerIndex)r.currentTimer=r.timers[r.timerIndex],r.currentTimerSalvaged=!1,r.currentTimer.update(t),r.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,n=this._updatesNegList;e<n.length;)s=n[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;for(e=0,n=this._updates0List;e<n.length;)s=n[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;for(e=0,n=this._updatesPosList;e<n.length;)s=n[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;this._updateHashLocked=!1,this._currentTarget=null}schedule(t,e,n,s,r,o){if("function"!=typeof t){const n=t;t=e,e=n}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!s,s=i.macro.REPEAT_FOREVER,r=0),C(e,1502);const a=e.uuid||e.id;if(!a)return void T(1510);let c,l,h=this._hashForTimers[a];if(h?h.paused!==o&&x(1511):(h=gy.get(null,e,0,null,null,o),this._arrayForTimers.push(h),this._hashForTimers[a]=h),null==h.timers)h.timers=[];else for(l=0;l<h.timers.length;++l)if(c=h.timers[l],c&&t===c._callback)return v(1507,c.getInterval(),n),void(c._interval=n);c=vy.get(),c.initWithCallback(this,t,e,n,s,r),h.timers.push(c),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}scheduleUpdate(t,e,n){const i=t.uuid||t.id;if(!i)return void T(1510);const s=this._hashForUpdates[i];if(s&&s.entry){if(s.entry.priority===e)return s.entry.markedForDeletion=!1,void(s.entry.paused=n);if(this._updateHashLocked)return v(1506),s.entry.markedForDeletion=!1,void(s.entry.paused=n);this.unscheduleUpdate(t)}const r=my.get(t,e,n,!1);let o;0===e?(o=this._updates0List,this._appendIn(o,r)):(o=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,r,e)),this._hashForUpdates[i]=fy.get(o,r,t,null)}unschedule(t,e){if(!e||!t)return;const n=e.uuid||e.id;if(!n)return void T(1510);const i=this,s=i._hashForTimers[n];if(s){const e=s.timers;for(let n=0,r=e.length;n<r;n++){const r=e[n];if(t===r._callback)return r!==s.currentTimer||s.currentTimerSalvaged||(s.currentTimerSalvaged=!0),e.splice(n,1),vy.put(r),s.timerIndex>=n&&s.timerIndex--,void(0===e.length&&(i._currentTarget===s?i._currentTargetSalvaged=!0:i._removeHashElement(s)))}}}unscheduleUpdate(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void T(1510);const n=this._hashForUpdates[e];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}unscheduleAllForTarget(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void T(1510);const n=this._hashForTimers[e];if(n){const t=n.timers;t.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(let e=0,n=t.length;e<n;e++)vy.put(t[e]);t.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(t)}unscheduleAll(){this.unscheduleAllWithMinPriority(i.Scheduler.PRIORITY_SYSTEM)}unscheduleAllWithMinPriority(t){let e,n;const i=this._arrayForTimers;for(e=i.length-1;e>=0;e--)n=i[e],this.unscheduleAllForTarget(n.target);let s,r=0;if(t<0)for(e=0;e<this._updatesNegList.length;)r=this._updatesNegList.length,s=this._updatesNegList[e],s&&s.priority>=t&&this.unscheduleUpdate(s.target),r===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)r=this._updates0List.length,s=this._updates0List[e],s&&this.unscheduleUpdate(s.target),r===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)r=this._updatesPosList.length,s=this._updatesPosList[e],s&&s.priority>=t&&this.unscheduleUpdate(s.target),r===this._updatesPosList.length&&e++}isScheduled(t,e){C(t,1508),C(e,1509);const n=e.uuid||e.id;if(!n)return void T(1510);const i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;{const e=i.timers;for(let n=0;n<e.length;++n)if(t===e[n]._callback)return!0;return!1}}pauseAllTargets(){return this.pauseAllTargetsWithMinPriority(i.Scheduler.PRIORITY_SYSTEM)}pauseAllTargetsWithMinPriority(t){const e=[];let n;const i=this._arrayForTimers;let s,r,o;for(s=0,r=i.length;s<r;s++)n=i[s],n&&(n.paused=!0,e.push(n.target));if(t<0)for(s=0;s<this._updatesNegList.length;s++)o=this._updatesNegList[s],o&&o.priority>=t&&(o.paused=!0,e.push(o.target));if(t<=0)for(s=0;s<this._updates0List.length;s++)o=this._updates0List[s],o&&(o.paused=!0,e.push(o.target));for(s=0;s<this._updatesPosList.length;s++)o=this._updatesPosList[s],o&&o.priority>=t&&(o.paused=!0,e.push(o.target));return e}resumeTargets(t){if(t)for(let e=0;e<t.length;e++)this.resumeTarget(t[e])}pauseTarget(t){C(t,1503);const e=t.uuid||t.id;if(!e)return void T(1510);const n=this._hashForTimers[e];n&&(n.paused=!0);const i=this._hashForUpdates[e];i&&(i.entry.paused=!0)}resumeTarget(t){C(t,1504);const e=t.uuid||t.id;if(!e)return void T(1510);const n=this._hashForTimers[e];n&&(n.paused=!1);const i=this._hashForUpdates[e];i&&(i.entry.paused=!1)}isTargetPaused(t){C(t,1505);const e=t.uuid||t.id;if(!e)return T(1510),!1;const n=this._hashForTimers[e];if(n)return n.paused;const i=this._hashForUpdates[e];return!!i&&i.entry.paused}_removeHashElement(t){const e=t.target.uuid||t.target.id;delete this._hashForTimers[e];const n=this._arrayForTimers;for(let e=0,i=n.length;e<i;e++)if(n[e]===t){n.splice(e,1);break}gy.put(t)}_removeUpdateFromHash(t){const e=t.target.uuid||t.target.id,n=this,i=n._hashForUpdates[e];if(i){const t=i.list,s=i.entry;for(let e=0,n=t.length;e<n;e++)if(t[e]===s){t.splice(e,1);break}delete n._hashForUpdates[e],my.put(s),fy.put(i)}}_priorityIn(t,e,n){for(let i=0;i<t.length;i++)if(n<t[i].priority)return void t.splice(i,0,e);t.push(e)}_appendIn(t,e){t.push(e)}}t("Scheduler",yy),yy.PRIORITY_SYSTEM=1<<31,yy.PRIORITY_NON_SYSTEM=yy.PRIORITY_SYSTEM+1,yy.ID="scheduler",i.Scheduler=yy;class xy{get width(){return this._width}get height(){return this._height}get framebuffer(){return Jn.get(Bi.get(this._poolHandle,Li.FRAMEBUFFER))}get shouldSyncSizeWithSwapchain(){return this._shouldSyncSizeWithSwapchain}get hasOnScreenAttachments(){return 1===Bi.get(this._poolHandle,Li.HAS_ON_SCREEN_ATTACHMENTS)}get hasOffScreenAttachments(){return 1===Bi.get(this._poolHandle,Li.HAS_OFF_SCREEN_ATTACHMENTS)}get handle(){return this._poolHandle}get cameras(){return this._cameras}static registerCreateFunc(t){t._createWindowFun=t=>new xy(t)}constructor(t){this._title="",this._width=1,this._height=1,this._nativeWidth=1,this._nativeHeight=1,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._swapchainBufferIndices=0,this._shouldSyncSizeWithSwapchain=!1,this._poolHandle=0,this._cameras=[]}initialize(t,e){this._poolHandle=Bi.alloc(),void 0!==e.title&&(this._title=e.title),void 0!==e.swapchainBufferIndices&&(this._swapchainBufferIndices=e.swapchainBufferIndices),void 0!==e.shouldSyncSizeWithSwapchain&&(this._shouldSyncSizeWithSwapchain=e.shouldSyncSizeWithSwapchain),this._width=e.width,this._height=e.height,this._nativeWidth=this._width,this._nativeHeight=this._height;const{colorAttachments:n,depthStencilAttachment:i}=e.renderPassInfo;for(let e=0;e<n.length;e++)n[e].format===Xs.UNKNOWN&&(n[e].format=t.colorFormat);i&&i.format===Xs.UNKNOWN&&(i.format=t.depthStencilFormat),this._renderPass=t.createRenderPass(e.renderPassInfo);for(let e=0;e<n.length;e++){let i=null;this._swapchainBufferIndices&1<<e?Bi.set(this._poolHandle,Li.HAS_ON_SCREEN_ATTACHMENTS,1):(i=t.createTexture(new eo(hr.TEX2D,_r.COLOR_ATTACHMENT|_r.SAMPLED,n[e].format,this._width,this._height)),Bi.set(this._poolHandle,Li.HAS_OFF_SCREEN_ATTACHMENTS,1)),this._colorTextures.push(i)}i&&(this._swapchainBufferIndices>=0?(this._depthStencilTexture=t.createTexture(new eo(hr.TEX2D,_r.DEPTH_STENCIL_ATTACHMENT|_r.SAMPLED,i.format,this._width,this._height)),Bi.set(this._poolHandle,Li.HAS_OFF_SCREEN_ATTACHMENTS,1)):Bi.set(this._poolHandle,Li.HAS_ON_SCREEN_ATTACHMENTS,1));const s=Jn.alloc(t,new Lo(this._renderPass,this._colorTextures,this._depthStencilTexture));return Bi.set(this._poolHandle,Li.FRAMEBUFFER,s),!0}destroy(){this.clearCameras(),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(let t=0;t<this._colorTextures.length;t++){const e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._poolHandle&&(Jn.get(Bi.get(this._poolHandle,Li.FRAMEBUFFER)).destroy(),this._poolHandle=0)}resize(t,e){if(this._width=t,this._height=e,t>this._nativeWidth||e>this._nativeHeight){this._nativeWidth=t,this._nativeHeight=e;let n=!1;this._depthStencilTexture&&(this._depthStencilTexture.resize(t,e),n=!0);for(let i=0;i<this._colorTextures.length;i++){const s=this._colorTextures[i];s&&(s.resize(t,e),n=!0)}const i=Jn.get(Bi.get(this._poolHandle,Li.FRAMEBUFFER));n&&i&&(i.destroy(),i.initialize(new Lo(this._renderPass,this._colorTextures,this._depthStencilTexture)))}for(const n of this._cameras)n.isWindowSize&&n.resize(t,e)}extractRenderCameras(){const t=[];for(let e=0;e<this._cameras.length;e++){const n=this._cameras[e];n.enabled&&(n.update(),t.push(n))}return t}attachCamera(t){for(let e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()}detachCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)}clearCameras(){this._cameras.length=0}sortCameras(){this._cameras.sort((t,e)=>t.priority-e.priority)}}class Sy{get device(){return this._device}get mainWindow(){return this._mainWindow}set curWindow(t){this._curWindow=t}get curWindow(){return this._curWindow}set tempWindow(t){this._tempWindow=t}get tempWindow(){return this._tempWindow}get windows(){return this._windows}get pipeline(){return this._pipeline}get batcher2D(){return this._batcher}get scenes(){return this._scenes}get cumulativeTime(){return Ni.get(this._poolHandle,Di.CUMULATIVE_TIME)}get frameTime(){return Ni.get(this._poolHandle,Di.FRAME_TIME)}get frameCount(){return this._frameCount}get fps(){return this._fps}set fixedFPS(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}get fixedFPS(){return this._fixedFPS}get dataPoolManager(){return this._dataPoolMgr}get handle(){return this._poolHandle}constructor(t){this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._fixedFPSFrameTime=0,this._poolHandle=0,this._device=t,this._dataPoolMgr=i.internal.DataPoolManager&&new i.internal.DataPoolManager(t),Pp.registerCreateFunc(this),xy.registerCreateFunc(this),this._cameraPool=new Jh(()=>new Il(this._device),4)}initialize(t){this._poolHandle=Ni.alloc();const e=new yo,n=new xo;n.depthStoreOp=vr.DISCARD,n.stencilStoreOp=vr.DISCARD;const s=new So([e],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:this._device.width,height:this._device.height,renderPassInfo:s,swapchainBufferIndices:-1}),this._curWindow=this._mainWindow,Promise.resolve(Rd.initBuiltinRes(this._device)).then(()=>{i.view.on("design-resolution-changed",()=>{const t=i.game.canvas.width,e=i.game.canvas.height;this.resize(t,e)},this)})}destroy(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._poolHandle&&(Ni.free(this._poolHandle),this._poolHandle=0)}resize(t,e){this._device.resize(t,e),this._mainWindow.resize(t,e);for(const n of this._windows)n.shouldSyncSizeWithSwapchain&&n.resize(t,e)}setRenderPipeline(t){if(t||(t=this.createDefaultPipeline()),this._pipeline=t,!this._pipeline.activate())return!1;const e=i.director.getScene();return e&&e.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&i.internal.Batcher2D&&(this._batcher=new i.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))}createDefaultPipeline(){const t=new Mm;return t.initialize({flows:[]}),t}onGlobalPipelineStateChanged(){for(let t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged()}activeWindow(t){this._curWindow=t}resetCumulativeTime(){Ni.set(this._poolHandle,Di.CUMULATIVE_TIME,0)}frameMove(t){Ni.set(this._poolHandle,Di.FRAME_TIME,t),++this._frameCount,Ni.set(this._poolHandle,Di.CUMULATIVE_TIME,Ni.get(this._poolHandle,Di.CUMULATIVE_TIME)+t),this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(let t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();if(this._batcher&&this._batcher.update(),this._pipeline){this._device.acquire();const t=this._windows,e=this._scenes,n=i.director.getTotalFrames();this._batcher&&this._batcher.uploadBuffers();for(let t=0;t<e.length;t++)e[t].update(n);i.director.emit(i.Director.EVENT_BEFORE_COMMIT);const s=[];for(let e=0;e<t.length;e++)t[e].extractRenderCameras().forEach(t=>{s.push(t)});s.sort((t,e)=>t.priority-e.priority),this._pipeline.render(s),this._device.present()}this._batcher&&this._batcher.reset()}createWindow(t){const e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e}destroyWindow(t){for(let e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)}destroyWindows(){for(const t of this._windows)t.destroy();this._windows=[]}createScene(t){const e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e}destroyScene(t){for(let e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)}destroyScenes(){for(const t of this._scenes)t.destroy();this._scenes=[]}createModel(t){let e=this._modelPools.get(t);e||(this._modelPools.set(t,new Jh(()=>new t,10)),e=this._modelPools.get(t));const n=e.alloc();return n.initialize(),n}destroyModel(t){const e=this._modelPools.get(t.constructor);e?(e.free(t),t.destroy(),t.scene&&t.scene.removeModel(t)):x(1300,t.constructor.name)}createCamera(){return this._cameraPool.alloc()}createLight(t){let e=this._lightPools.get(t);e||(this._lightPools.set(t,new Jh(()=>new t,4)),e=this._lightPools.get(t));const n=e.alloc();return n.initialize(),n}destroyLight(t){const e=this._lightPools.get(t.constructor);if(t.destroy(),e&&(e.free(t),t.scene))switch(t.type){case Dl.SPHERE:t.scene.removeSphereLight(t);break;case Dl.SPOT:t.scene.removeSpotLight(t)}}}i.Root=Sy;class Ty{get uiTransformComp(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp}set uiTransformComp(t){this._uiTransformComp=t}get uiComp(){return this._uiComp}set uiComp(t){this._uiComp&&t?x(12002):this._uiComp=t}constructor(t){this._uiComp=null,this.opacity=1,this._uiTransformComp=null,this._node=void 0,this._node=t}}var Ey,Cy,Ay,by,wy,Ry,Iy,Py,Oy;n_.Flags.Destroying;const Dy=n_.Flags.Destroying,My=n_.Flags.DontDestroy,Ny=n_.Flags.Deactivating,Ly=new it("Node");function zy(t){return t?"string"==typeof t?Ft(t):t:(T(3804),null)}let By=t("BaseNode",Yl("cc.BaseNode")((Oy=Py=class t extends n_{get components(){return this._components}get _persistNode(){return(this._objFlags&My)>0}set _persistNode(t){t?this._objFlags|=My:this._objFlags&=~My}get name(){return this._name}set name(t){this._name=t}get uuid(){return this._id}get children(){return this._children}get active(){return this._active}set active(t){if(this._active!==t){this._active=t;const e=this._parent;e&&e._activeInHierarchy&&i.director._nodeActivator.activateNode(this,t)}}get activeInHierarchy(){return this._activeInHierarchy}get parent(){return this._parent}set parent(t){this.setParent(t)}get scene(){return this._scene}get eventProcessor(){return this._eventProcessor}static _setScene(t){t._updateScene()}static _findComponent(t,e){const n=e,i=t._components;if(n._sealed)for(let t=0;t<i.length;++t){const n=i[t];if(n.constructor===e)return n}else for(let t=0;t<i.length;++t){const n=i[t];if(n instanceof e)return n}return null}static _findComponents(t,e,n){const i=e,s=t._components;if(i._sealed)for(let t=0;t<s.length;++t){const i=s[t];i.constructor===e&&n.push(i)}else for(let t=0;t<s.length;++t){const i=s[t];i instanceof e&&n.push(i)}}static _findChildComponent(e,n){for(let i=0;i<e.length;++i){const s=e[i];let r=t._findComponent(s,n);if(r)return r;if(s._children.length>0&&(r=t._findChildComponent(s._children,n),r))return r}return null}static _findChildComponents(e,n,i){for(let s=0;s<e.length;++s){const r=e[s];t._findComponents(r,n,i),r._children.length>0&&t._findChildComponents(r._children,n,i)}}_updateScene(){null==this._parent?u("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene}constructor(t){super(t),Ul(this,"_parent",Ay,this),Ul(this,"_children",by,this),Ul(this,"_active",wy,this),Ul(this,"_components",Ry,this),Ul(this,"_prefab",Iy,this),this._scene=null,this._activeInHierarchy=!1,this._id=Ly.getNewId(),this._name=void 0,this._eventProcessor=new i.NodeEventProcessor(this),this._eventMask=0,this._siblingIndex=0,this._registerIfAttached=void 0,this._name=void 0!==t?t:"New Node"}attr(t){Ct(this,t)}getParent(){return this._parent}setParent(t,e=!1){if(this._parent===t)return;const n=this._parent,i=t;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,e),this.emit&&this.emit(pf.PARENT_CHANGED,n),n&&!(n._objFlags&Dy)){const t=n._children.indexOf(this);n._children.splice(t,1),n._updateSiblingIndex(),n.emit&&n.emit(pf.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(pf.CHILD_ADDED,this)),this._onHierarchyChanged(n)}getChildByUuid(t){if(!t)return h("Invalid uuid"),null;const e=this._children;for(let n=0,i=e.length;n<i;n++)if(e[n]._id===t)return e[n];return null}getChildByName(t){if(!t)return h("Invalid name"),null;const e=this._children;for(let n=0,i=e.length;n<i;n++)if(e[n]._name===t)return e[n];return null}getChildByPath(t){const e=t.split("/");let n=this;for(let t=0;t<e.length;++t){const i=e[t];if(0===i.length)continue;const s=n.children.find(t=>t.name===i);if(!s)return null;n=s}return n}addChild(t){t.setParent(this)}insertChild(t,e){t.parent=this,t.setSiblingIndex(e)}getSiblingIndex(){return this._siblingIndex}setSiblingIndex(t){if(!this._parent)return;if(this._parent._objFlags&Ny)return void T(3821);const e=this._parent._children;t=-1!==t?t:e.length-1;const n=e.indexOf(this);t!==n&&(e.splice(n,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}walk(e,n){let i=1,s=null,r=null,o=0,a=t._stacks[t._stackId];a||(a=[],t._stacks.push(a)),t._stackId++,a.length=0,a[0]=this;let c=null,l=!1;for(;i;)if(i--,r=a[i],r)if(!l&&e?e(r):l&&n&&n(r),a[i]=null,l){if(c===this._parent)break;if(l=!1,s)if(o++,s[o])a[i]=s[o],i++;else if(c&&(a[i]=c,i++,l=!0,c._parent?(s=c._parent._children,o=s.indexOf(c),c=c._parent):(c=null,s=null),o<0))break}else r._children.length>0?(c=r,s=r._children,o=0,a[i]=s[o],i++):(a[i]=r,i++,l=!0);a.length=0,t._stackId--}removeFromParent(){this._parent&&this._parent.removeChild(this)}removeChild(t){this._children.indexOf(t)>-1&&(t.parent=null)}removeAllChildren(){const t=this._children;for(let e=t.length-1;e>=0;e--){const n=t[e];n&&(n.parent=null)}this._children.length=0}isChildOf(t){let e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1}getComponent(e){const n=zy(e);return n?t._findComponent(this,n):null}getComponents(e){const n=zy(e),i=[];return n&&t._findComponents(this,n,i),i}getComponentInChildren(e){const n=zy(e);return n?t._findChildComponent(this._children,n):null}getComponentsInChildren(e){const n=zy(e),i=[];return n&&(t._findComponents(this,n,i),t._findChildComponents(this._children,n,i)),i}addComponent(t){let e;if("string"==typeof t){if(e=Ft(t),!e)throw i._RF.peek()&&T(3808,t),TypeError(b(3807,t))}else{if(!t)throw TypeError(b(3804));e=t}if("function"!=typeof e)throw TypeError(b(3809));if(!wt(e,i.Component))throw TypeError(b(3810));const n=e._requireComponent;n&&!this.getComponent(n)&&this.addComponent(n);const s=new e;return s.node=this,this._components.push(s),this._activeInHierarchy&&i.director._nodeActivator.activateComp(s),s}removeComponent(t){if(!t)return void T(3813);let e=null;e=t instanceof Nu?t:this.getComponent(t),e&&e.destroy()}on(t,e,n,i=!1){switch(t){case pf.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,n,i)}off(t,e,n,i=!1){if(this._eventProcessor.off(t,e,n,i),!this._eventProcessor.hasEventListener(t))switch(t){case pf.TRANSFORM_CHANGED:this._eventMask&=-2}}once(t,e,n,i){this._eventProcessor.once(t,e,n,i)}emit(t,e,n,i,s,r){this._eventProcessor.emit(t,e,n,i,s,r)}dispatchEvent(t){this._eventProcessor.dispatchEvent(t)}hasEventListener(t,e,n){return this._eventProcessor.hasEventListener(t,e,n)}targetOff(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(pf.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}destroy(){return!!super.destroy()&&(this.active=!1,!0)}destroyAllChildren(){const t=this._children;for(let e=0;e<t.length;++e)t[e].destroy()}_removeComponent(t){if(t){if(!(this._objFlags&Dy)){const e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&T(3815)}}else T(3814)}_updateSiblingIndex(){for(let t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(pf.SIBLING_ORDER_CHANGED)}_onSetParent(e,n=!1){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(t._setScene))}_onPostActivated(t){}_onBatchCreated(t){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}_onPreDestroy(){this._onPreDestroyBase()}_onHierarchyChanged(t){return this._onHierarchyChangedBase(t)}_instantiate(t,e){return t||(t=i.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t}_onHierarchyChangedBase(t){const e=this._parent;!this._persistNode||e instanceof i.Scene||i.game.removePersistRootNode(this);const n=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==n&&i.director._nodeActivator.activateNode(this,n)}_onPreDestroyBase(){this._objFlags|=Dy;const t=this._parent,e=!!t&&0!=(t._objFlags&Dy);if(this._persistNode&&i.game.removePersistRootNode(this),!e&&t){this.emit(pf.PARENT_CHANGED,this);const e=t._children.indexOf(this);t._children.splice(e,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(pf.CHILD_REMOVED,this)}this.emit(pf.NODE_DESTROYED,this),this._eventProcessor.destroy();const n=this._children;for(let t=0;t<n.length;++t)n[t]._destroyImmediate();const s=this._components;for(let t=0;t<s.length;++t)s[t]._destroyImmediate();return e}},Py.idGenerator=Ly,Py._stacks=[[]],Py._stackId=0,Gl((Cy=Oy).prototype,"_persistNode",[Jl],Object.getOwnPropertyDescriptor(Cy.prototype,"_persistNode"),Cy.prototype),Gl(Cy.prototype,"name",[ch],Object.getOwnPropertyDescriptor(Cy.prototype,"name"),Cy.prototype),Gl(Cy.prototype,"children",[ch],Object.getOwnPropertyDescriptor(Cy.prototype,"children"),Cy.prototype),Gl(Cy.prototype,"active",[ch],Object.getOwnPropertyDescriptor(Cy.prototype,"active"),Cy.prototype),Gl(Cy.prototype,"activeInHierarchy",[ch],Object.getOwnPropertyDescriptor(Cy.prototype,"activeInHierarchy"),Cy.prototype),Gl(Cy.prototype,"parent",[ch],Object.getOwnPropertyDescriptor(Cy.prototype,"parent"),Cy.prototype),Ay=Gl(Cy.prototype,"_parent",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),by=Gl(Cy.prototype,"_children",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wy=Gl(Cy.prototype,"_active",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ry=Gl(Cy.prototype,"_components",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Iy=Gl(Cy.prototype,"_prefab",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ey=Cy))||Ey);var Fy,Uy,Gy,Hy,Vy,ky,jy,Wy,qy,Xy,Yy;i._BaseNode=By;const Ky=new ln,$y=new vn,Zy=new vn,Jy=new Array(10),Qy=new vn,tx=new mn,ex=new mn,nx=new bn,ix=new Map;let sx=t("Node",(Fy=Yl("cc.Node"),Uy=Ah(ln),Fy((Yy=Xy=class t extends By{constructor(t){super(t),this._uiProps=new Ty(this),this._static=!1,this._pos=new ln,this._rot=new vn,this._scale=new ln(1,1,1),this._mat=new bn,Ul(this,"_lpos",Vy,this),Ul(this,"_lrot",ky,this),Ul(this,"_lscale",jy,this),Ul(this,"_layer",Wy,this),Ul(this,"_euler",qy,this),this._dirtyFlags=Ol.NONE,this._eulerDirty=!1,this._poolHandle=0,this._poolHandle=Oi.alloc(),Oi.set(this._poolHandle,Ii.LAYER,this._layer)}static isNode(e){return e instanceof t&&(e.constructor===t||!(e instanceof i.Scene))}destroy(){return this._poolHandle&&(Oi.free(this._poolHandle),this._poolHandle=0),super.destroy()}get handle(){return this._poolHandle}get position(){return this._lpos}set position(t){this.setPosition(t)}get worldPosition(){return this.updateWorldTransform(),this._pos}set worldPosition(t){this.setWorldPosition(t)}get rotation(){return this._lrot}set rotation(t){this.setRotation(t)}set eulerAngles(t){this.setRotationFromEuler(t.x,t.y,t.z)}get eulerAngles(){return this._eulerDirty&&(vn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}get angle(){return this._euler.z}set angle(t){ln.set(this._euler,0,0,t),vn.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(Ol.ROTATION),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.ROTATION)}get worldRotation(){return this.updateWorldTransform(),this._rot}set worldRotation(t){this.setWorldRotation(t)}get scale(){return this._lscale}set scale(t){this.setScale(t)}get worldScale(){return this.updateWorldTransform(),this._scale}set worldScale(t){this.setWorldScale(t)}set matrix(t){bn.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Ol.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.TRS)}get worldMatrix(){return this.updateWorldTransform(),this._mat}get forward(){return ln.transformQuat(new ln,ln.FORWARD,this.worldRotation)}set forward(t){const e=t.length();ln.multiplyScalar(Ky,t,-1/e),vn.fromViewUp($y,Ky),this.setWorldRotation($y)}set layer(t){this._layer=t,Oi.set(this._poolHandle,Ii.LAYER,this._layer),this.emit(pf.LAYER_CHANGED,this._layer)}get layer(){return this._layer}get hasChangedFlags(){return ix.get(this)||0}set hasChangedFlags(t){ix.set(this,t),Oi.set(this._poolHandle,Ii.FLAGS_CHANGED,t)}setParent(t,e=!1){e&&this.updateWorldTransform(),super.setParent(t,e)}_onSetParent(t,e){if(super._onSetParent(t,e),e){const t=this._parent;t?(t.updateWorldTransform(),bn.multiply(nx,bn.invert(nx,t._mat),this._mat),bn.toRTS(nx,this._lrot,this._lpos,this._lscale)):(ln.copy(this._lpos,this._pos),vn.copy(this._lrot,this._rot),ln.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Ol.TRS)}_onBatchCreated(t){var e;super._onBatchCreated(t),Oi.set(this._poolHandle,Ii.LAYER,this._layer),Oi.setVec3(this._poolHandle,Ii.WORLD_SCALE,this._scale);const n=null===(e=this._prefab)||void 0===e?void 0:e.instance;!t&&n&&yv(this),this.hasChangedFlags=Ol.TRS,this._dirtyFlags=Ol.TRS;const i=this._children.length;for(let e=0;e<i;++e)this._children[e]._onBatchCreated(t);if(!t&&n){const t={};n.targetMap=t,xv(this,t,!0),Tv(0,n.mountedChildren,t),Ev(0,n.propertyOverrides,t)}Cv(this)}_onBeforeSerialize(){this.eulerAngles}_onPostActivated(t){t?($m.resumeTarget(this),this.eventProcessor.reattach(),this.invalidateChildren(Ol.TRS)):$m.pauseTarget(this)}translate(t,e){const n=e||Pl.LOCAL;if(n===Pl.LOCAL)ln.transformQuat(Ky,t,this._lrot),this._lpos.x+=Ky.x,this._lpos.y+=Ky.y,this._lpos.z+=Ky.z;else if(n===Pl.WORLD)if(this._parent){vn.invert($y,this._parent.worldRotation),ln.transformQuat(Ky,t,$y);const e=this.worldScale;this._lpos.x+=Ky.x/e.x,this._lpos.y+=Ky.y/e.y,this._lpos.z+=Ky.z/e.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(Ol.POSITION),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.POSITION)}rotate(t,e){const n=e||Pl.LOCAL;if(vn.normalize($y,t),n===Pl.LOCAL)vn.multiply(this._lrot,this._lrot,$y);else if(n===Pl.WORLD){const t=this.worldRotation;vn.multiply(Zy,$y,t),vn.invert($y,t),vn.multiply(Zy,$y,Zy),vn.multiply(this._lrot,this._lrot,Zy)}this._eulerDirty=!0,this.invalidateChildren(Ol.ROTATION),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.ROTATION)}lookAt(t,e){this.getWorldPosition(Ky),ln.subtract(Ky,Ky,t),ln.normalize(Ky,Ky),vn.fromViewUp($y,Ky,e),this.setWorldRotation($y)}invalidateChildren(t){const e=this.hasChangedFlags;if((this._dirtyFlags&e&t)===t)return;this._dirtyFlags|=t,this.hasChangedFlags=e|t;const n=t|Ol.POSITION,i=this._children.length;for(let t=0;t<i;++t){const e=this._children[t];e.isValid&&e.invalidateChildren(n)}}updateWorldTransform(){if(!this._dirtyFlags)return;let t,e=this,n=0;for(;e&&e._dirtyFlags;)Jy[n++]=e,e=e._parent;let i=0;for(;n;)t=Jy[--n],i|=t._dirtyFlags,e?(i&Ol.POSITION&&(ln.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z,Oi.setVec3(t._poolHandle,Ii.WORLD_POSITION,t._pos)),i&Ol.RS&&(bn.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),bn.multiply(t._mat,e._mat,t._mat),i&Ol.ROTATION&&(vn.multiply(t._rot,e._rot,t._lrot),Oi.setVec4(t._poolHandle,Ii.WORLD_ROTATION,t._rot)),mn.fromQuat(tx,vn.conjugate(Qy,t._rot)),mn.multiplyMat4(tx,tx,t._mat),t._scale.x=tx.m00,t._scale.y=tx.m04,t._scale.z=tx.m08,Oi.setVec3(t._poolHandle,Ii.WORLD_SCALE,t._scale))):(i&Ol.POSITION&&(ln.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z,Oi.setVec3(t._poolHandle,Ii.WORLD_POSITION,t._pos)),i&Ol.RS&&(i&Ol.ROTATION&&(vn.copy(t._rot,t._lrot),Oi.setVec4(t._poolHandle,Ii.WORLD_ROTATION,t._rot)),i&Ol.SCALE&&(ln.copy(t._scale,t._lscale),Oi.setVec3(t._poolHandle,Ii.WORLD_SCALE,t._scale),bn.fromRTS(t._mat,t._rot,t._pos,t._scale)))),i!==Ol.NONE&&Oi.setMat4(t._poolHandle,Ii.WORLD_MATRIX,t._mat),t._dirtyFlags=Ol.NONE,e=t}setPosition(t,e,n){void 0===e&&void 0===n?ln.copy(this._lpos,t):void 0===n?ln.set(this._lpos,t,e,this._lpos.z):ln.set(this._lpos,t,e,n),this.invalidateChildren(Ol.POSITION),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.POSITION)}getPosition(t){return t?ln.set(t,this._lpos.x,this._lpos.y,this._lpos.z):ln.copy(new ln,this._lpos)}setRotation(t,e,n,i){void 0===e||void 0===n||void 0===i?vn.copy(this._lrot,t):vn.set(this._lrot,t,e,n,i),this._eulerDirty=!0,this.invalidateChildren(Ol.ROTATION),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.ROTATION)}setRotationFromEuler(t,e,n){const i=void 0===n?this._euler.z:n;void 0===e?(ln.copy(this._euler,t),vn.fromEuler(this._lrot,t.x,t.y,t.z)):(ln.set(this._euler,t,e,i),vn.fromEuler(this._lrot,t,e,i)),this._eulerDirty=!1,this.invalidateChildren(Ol.ROTATION),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.ROTATION)}getRotation(t){return t?vn.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):vn.copy(new vn,this._lrot)}setScale(t,e,n){void 0===e&&void 0===n?ln.copy(this._lscale,t):void 0===n?ln.set(this._lscale,t,e,this._lscale.z):ln.set(this._lscale,t,e,n),this.invalidateChildren(Ol.SCALE),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.SCALE)}getScale(t){return t?ln.set(t,this._lscale.x,this._lscale.y,this._lscale.z):ln.copy(new ln,this._lscale)}inverseTransformPoint(t,e){ln.copy(t,e);let n=this,i=0;for(;n._parent;)Jy[i++]=n,n=n._parent;for(;i>=0;)ln.transformInverseRTS(t,t,n._lrot,n._lpos,n._lscale),n=Jy[--i];return t}setWorldPosition(t,e,n){void 0===e||void 0===n?ln.copy(this._pos,t):ln.set(this._pos,t,e,n),Oi.setVec3(this._poolHandle,Ii.WORLD_POSITION,this._pos);const i=this._parent,s=this._lpos;i?(i.updateWorldTransform(),ln.transformMat4(s,this._pos,bn.invert(nx,i._mat))):ln.copy(s,this._pos),this.invalidateChildren(Ol.POSITION),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.POSITION)}getWorldPosition(t){return this.updateWorldTransform(),t?ln.copy(t,this._pos):ln.copy(new ln,this._pos)}setWorldRotation(t,e,n,i){void 0===e||void 0===n||void 0===i?vn.copy(this._rot,t):vn.set(this._rot,t,e,n,i),Oi.setVec4(this._poolHandle,Ii.WORLD_ROTATION,this._rot),this._parent?(this._parent.updateWorldTransform(),vn.multiply(this._lrot,vn.conjugate(this._lrot,this._parent._rot),this._rot)):vn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Ol.ROTATION),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.ROTATION)}setWorldRotationFromEuler(t,e,n){vn.fromEuler(this._rot,t,e,n),this._parent?(this._parent.updateWorldTransform(),vn.multiply(this._lrot,vn.conjugate(this._lrot,this._parent._rot),this._rot)):vn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Ol.ROTATION),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.ROTATION)}getWorldRotation(t){return this.updateWorldTransform(),t?vn.copy(t,this._rot):vn.copy(new vn,this._rot)}setWorldScale(t,e,n){void 0===e||void 0===n?ln.copy(this._scale,t):ln.set(this._scale,t,e,n),Oi.setVec3(this._poolHandle,Ii.WORLD_SCALE,this._scale);const i=this._parent;i?(i.updateWorldTransform(),mn.fromQuat(tx,vn.conjugate(Qy,i._rot)),mn.multiplyMat4(tx,tx,i._mat),ex.m00=this._scale.x,ex.m04=this._scale.y,ex.m08=this._scale.z,mn.multiply(tx,ex,mn.invert(tx,tx)),this._lscale.x=ln.set(Ky,tx.m00,tx.m01,tx.m02).length(),this._lscale.y=ln.set(Ky,tx.m03,tx.m04,tx.m05).length(),this._lscale.z=ln.set(Ky,tx.m06,tx.m07,tx.m08).length()):ln.copy(this._lscale,this._scale),this.invalidateChildren(Ol.SCALE),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,Ol.SCALE)}getWorldScale(t){return this.updateWorldTransform(),t?ln.copy(t,this._scale):ln.copy(new ln,this._scale)}getWorldMatrix(t){this.updateWorldTransform();const e=t||new bn;return bn.copy(e,this._mat)}getWorldRS(t){this.updateWorldTransform();const e=t||new bn;return bn.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}getWorldRT(t){this.updateWorldTransform();const e=t||new bn;return bn.fromRT(e,this._rot,this._pos)}setRTS(t,e,n){let i=0;t&&(i|=Ol.ROTATION,void 0!==t.w?(vn.copy(this._lrot,t),this._eulerDirty=!0):(ln.copy(this._euler,t),vn.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(ln.copy(this._lpos,e),i|=Ol.POSITION),n&&(ln.copy(this._lscale,n),i|=Ol.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(pf.TRANSFORM_CHANGED,i))}pauseSystemEvents(t){$m.pauseTarget(this,t)}resumeSystemEvents(t){$m.resumeTarget(this,t)}},Xy.bookOfChange=ix,Xy.EventType=pf,Xy.NodeSpace=Pl,Xy.TransformDirtyBit=Ol,Xy.TransformBit=Ol,Vy=Gl((Hy=Yy).prototype,"_lpos",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ln}}),ky=Gl(Hy.prototype,"_lrot",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new vn}}),jy=Gl(Hy.prototype,"_lscale",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ln(1,1,1)}}),Wy=Gl(Hy.prototype,"_layer",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yc.Enum.DEFAULT}}),qy=Gl(Hy.prototype,"_euler",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ln}}),Gl(Hy.prototype,"eulerAngles",[Uy],Object.getOwnPropertyDescriptor(Hy.prototype,"eulerAngles"),Hy.prototype),Gl(Hy.prototype,"angle",[ch],Object.getOwnPropertyDescriptor(Hy.prototype,"angle"),Hy.prototype),Gl(Hy.prototype,"layer",[ch],Object.getOwnPropertyDescriptor(Hy.prototype,"layer"),Hy.prototype),Gy=Hy))||Gy));i.Node=sx;const rx=new Array(16);let ox=null,ax=new rn;const cx=[pf.TOUCH_START.toString(),pf.TOUCH_MOVE.toString(),pf.TOUCH_END.toString(),pf.TOUCH_CANCEL.toString()],lx=[pf.MOUSE_DOWN.toString(),pf.MOUSE_ENTER.toString(),pf.MOUSE_MOVE.toString(),pf.MOUSE_LEAVE.toString(),pf.MOUSE_UP.toString(),pf.MOUSE_WHEEL.toString()];function hx(t,e){const n=this.owner;return!(!n||!n._uiProps.uiTransformComp||(t.getUILocation(ax),!n._uiProps.uiTransformComp.isHit(ax,this)||(e.type=pf.TOUCH_START.toString(),e.touch=t,e.bubbles=!0,n.dispatchEvent(e),0)))}function _x(t,e){const n=this.owner;return!(!n||!n._uiProps.uiTransformComp||(e.type=pf.TOUCH_MOVE.toString(),e.touch=t,e.bubbles=!0,n.dispatchEvent(e),0))}function ux(t,e){const n=this.owner;n&&n._uiProps.uiTransformComp&&(t.getUILocation(ax),n._uiProps.uiTransformComp.isHit(ax,this)?e.type=pf.TOUCH_END.toString():e.type=pf.TOUCH_CANCEL.toString(),e.touch=t,e.bubbles=!0,n.dispatchEvent(e))}function dx(t,e){const n=this.owner;n&&n._uiProps.uiTransformComp&&(e.type=pf.TOUCH_CANCEL.toString(),e.touch=t,e.bubbles=!0,n.dispatchEvent(e))}function px(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(ax=t.getUILocation(),e._uiProps.uiTransformComp.isHit(ax,this)&&(t.type=pf.MOUSE_DOWN.toString(),t.bubbles=!0,e.dispatchEvent(t)))}function mx(t){const e=this.owner;if(e&&e._uiProps.uiTransformComp){if(ax=t.getUILocation(),e._uiProps.uiTransformComp.isHit(ax,this))this._previousIn||(ox&&ox.eventProcessor.mouseListener&&(t.type=pf.MOUSE_LEAVE,ox.dispatchEvent(t),ox.eventProcessor.mouseListener&&(ox.eventProcessor.mouseListener._previousIn=!1)),ox=e,t.type=pf.MOUSE_ENTER.toString(),e.dispatchEvent(t),this._previousIn=!0),t.type=pf.MOUSE_MOVE.toString(),t.bubbles=!0,e.dispatchEvent(t);else{if(!this._previousIn)return;t.type=pf.MOUSE_LEAVE.toString(),e.dispatchEvent(t),this._previousIn=!1,ox=null}t.propagationStopped=!0}}function fx(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(ax=t.getUILocation(),e._uiProps.uiTransformComp.isHit(ax,this)&&(t.type=pf.MOUSE_UP.toString(),t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0))}function gx(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(ax=t.getUILocation(),e._uiProps.uiTransformComp.isHit(ax,this)&&(t.type=pf.MOUSE_WHEEL.toString(),t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0))}function vx(t,e){if(e){let n=0,i=[];for(let s=t;s&&sx.isNode(s);s=s.parent,++n){const t=s.getComponent(e);if(t){const e={index:n,comp:t};i?i.push(e):i=[e]}}return i.length>0?i:null}return null}function yx(t,e){if(!t._persistNode){if(t.eventProcessor.bubblingTargets)for(let n=0;n<e.length;++n)if(t.eventProcessor.bubblingTargets.hasEventListener(e[n]))return!0;if(t.eventProcessor.capturingTargets)for(let n=0;n<e.length;++n)if(t.eventProcessor.capturingTargets.hasEventListener(e[n]))return!0;return!1}return!0}i.NodeEventProcessor=class{get node(){return this._node}constructor(t){this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._comp=null,this._node=t}reattach(){if(this._comp)if(this.touchListener){const t=this.touchListener.mask=vx(this._node,this._comp);this.mouseListener&&(this.mouseListener.mask=t)}else this.mouseListener&&(this.mouseListener.mask=vx(this._node,this._comp))}registerComponentHitList(t){this._comp=t}destroy(){ox===this._node&&(ox=null),(this.touchListener||this.mouseListener)&&($m.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()}on(t,e,n,i){return this._checknSetupSysEvent(t)?this._onDispatch(t,e,n,i):(this.bubblingTargets||(this.bubblingTargets=new __),this.bubblingTargets.on(t,e,n))}once(t,e,n,i){let s;s=this._checknSetupSysEvent(t)&&i?this.capturingTargets=this.capturingTargets||new __:this.bubblingTargets=this.bubblingTargets||new __,s.on(t,e,n,!0),s.on(t,()=>{this.off(t,e,n)},void 0,!0)}off(t,e,n,i){const s=-1!==cx.indexOf(t),r=!s&&-1!==lx.indexOf(t);s||r?(this._offDispatch(t,e,n,i),s?this.touchListener&&!yx(this._node,cx)&&($m.removeListener(this.touchListener),this.touchListener=null):r&&this.mouseListener&&!yx(this._node,lx)&&($m.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(t,e,n)}emit(t,e,n,i,s,r){this.bubblingTargets&&this.bubblingTargets.emit(t,e,n,i,s,r)}dispatchEvent(t){!function(t,e){let n,i=0;for(e.target=t,rx.length=0,t.eventProcessor.getCapturingTargets(e.type,rx),e.eventPhase=1,i=rx.length-1;i>=0;--i)if(n=rx[i],n.eventProcessor.capturingTargets&&(e.currentTarget=n,n.eventProcessor.capturingTargets.emit(e.type,e,rx),e.propagationStopped))return void(rx.length=0);if(rx.length=0,e.eventPhase=2,e.currentTarget=t,t.eventProcessor.capturingTargets&&t.eventProcessor.capturingTargets.emit(e.type,e),!e.propagationImmediateStopped&&t.eventProcessor.bubblingTargets&&t.eventProcessor.bubblingTargets.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(t.eventProcessor.getBubblingTargets(e.type,rx),e.eventPhase=3,i=0;i<rx.length;++i)if(n=rx[i],n.eventProcessor.bubblingTargets&&(e.currentTarget=n,n.eventProcessor.bubblingTargets.emit(e.type,e),e.propagationStopped))return void(rx.length=0);rx.length=0}(this._node,t),rx.length=0}hasEventListener(t,e,n){let i=!1;return this.bubblingTargets&&(i=this.bubblingTargets.hasEventListener(t,e,n)),!i&&this.capturingTargets&&(i=this.capturingTargets.hasEventListener(t,e,n)),i}targetOff(t){this.capturingTargets&&this.capturingTargets.removeAll(t),this.bubblingTargets&&this.bubblingTargets.removeAll(t),this.touchListener&&!yx(this.node,cx)&&($m.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!yx(this.node,lx)&&($m.removeListener(this.mouseListener),this.mouseListener=null)}getCapturingTargets(t,e){let n=this._node.parent;for(;n;)n.eventProcessor.capturingTargets&&n.eventProcessor.capturingTargets.hasEventListener(t)&&e.push(n),n=n.parent}getBubblingTargets(t,e){let n=this._node.parent;for(;n;)n.eventProcessor.bubblingTargets&&n.eventProcessor.bubblingTargets.hasEventListener(t)&&e.push(n),n=n.parent}_checknSetupSysEvent(t){let e=!1,n=!1;return-1!==cx.indexOf(t)?(this.touchListener||(this.touchListener=i.EventListener.create({event:i.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:vx(this._node,this._comp),onTouchBegan:hx,onTouchMoved:_x,onTouchEnded:ux,onTouchCancelled:dx}),$m.addListener(this.touchListener,this._node),e=!0),n=!0):-1!==lx.indexOf(t)&&(this.mouseListener||(this.mouseListener=i.EventListener.create({event:i.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:vx(this._node,this._comp),onMouseDown:px,onMouseMove:mx,onMouseUp:fx,onMouseScroll:gx}),$m.addListener(this.mouseListener,this._node),e=!0),n=!0),e&&!this._node.activeInHierarchy&&i.director.getScheduler().schedule(()=>{this._node.activeInHierarchy||$m.pauseTarget(this._node)},this._node,0,0,0,!1),n}_onDispatch(t,e,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,!e)return void T(6800);let s=null;return s=i?this.capturingTargets=this.capturingTargets||new __:this.bubblingTargets=this.bubblingTargets||new __,s.hasEventListener(t,e,n)||s.on(t,e,n),e}_offDispatch(t,e,n,i){if("boolean"==typeof n?(i=n,n=void 0):i=!!i,e){const s=i?this.capturingTargets:this.bubblingTargets;s&&s.off(t,e,n)}else this.capturingTargets&&this.capturingTargets.removeAll(t),this.bubblingTargets&&this.bubblingTargets.removeAll(t)}};const xx=jt({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),Sx=xx.LAYERED+1;var Tx,Ex,Cx,Ax,bx,wx,Rx,Ix,Px,Ox,Dx,Mx,Nx,Lx,zx,Bx,Fx,Ux,Gx,Hx,Vx,kx,jx,Wx,qx,Xx,Yx,Kx,$x,Zx,Jx,Qx,tS,eS,nS,iS,sS,rS,oS,aS,cS,lS,hS,_S,uS,dS,pS,mS,fS,gS,vS,yS,xS,SS,TS,ES,CS,AS,bS,wS,RS,IS,PS,OS,DS,MS,NS,LS,zS,BS,FS,US,GS,HS,VS,kS,jS,WS,qS,XS,YS,KS,$S,ZS,JS,QS,tT,eT,nT,iT,sT,rT,oT,aT,cT,lT,hT,_T,uT,dT,pT,mT,fT;i.Fog=class{set enabled(t){Ki.set(this._handle,Xi.ENABLE,t?1:0),t||Ki.set(this._handle,Xi.TYPE,Sx),t?this.activate():this._updatePipeline()}get enabled(){return Ki.get(this._handle,Xi.ENABLE)}set fogColor(t){this._fogColor.set(t),Ln.toArray(this._colorArray,this._fogColor),Ki.setVec4(this._handle,Xi.COLOR,this._fogColor)}get fogColor(){return this._fogColor}get type(){return Ki.get(this._handle,Xi.TYPE)}set type(t){Ki.set(this._handle,Xi.TYPE,this.enabled?t:Sx),this.enabled&&this._updatePipeline()}get fogDensity(){return Ki.get(this._handle,Xi.DENSITY)}set fogDensity(t){Ki.set(this._handle,Xi.DENSITY,t)}get fogStart(){return Ki.get(this._handle,Xi.START)}set fogStart(t){Ki.set(this._handle,Xi.START,t)}get fogEnd(){return Ki.get(this._handle,Xi.END)}set fogEnd(t){Ki.set(this._handle,Xi.END,t)}get fogAtten(){return Ki.get(this._handle,Xi.ATTEN)}set fogAtten(t){Ki.set(this._handle,Xi.ATTEN,t)}get fogTop(){return Ki.get(this._handle,Xi.TOP)}set fogTop(t){Ki.set(this._handle,Xi.TOP,t)}get fogRange(){return Ki.get(this._handle,Xi.RANGE)}set fogRange(t){Ki.set(this._handle,Xi.RANGE,t)}get colorArray(){return this._colorArray}get handle(){return this._handle}constructor(){this._fogColor=new Ln("#C8C8C8"),this._colorArray=new Float32Array([.2,.2,.2,1]),this._handle=0,this._handle=Ki.alloc()}initialize(t){Ki.set(this._handle,Xi.ENABLE,t.enabled?1:0),Ki.set(this._handle,Xi.TYPE,t.enabled?t.type:Sx),this._fogColor.set(t.fogColor),Ln.toArray(this._colorArray,this._fogColor),Ki.setVec4(this._handle,Xi.COLOR,this._fogColor),Ki.set(this._handle,Xi.DENSITY,t.fogDensity),Ki.set(this._handle,Xi.START,t.fogStart),Ki.set(this._handle,Xi.END,t.fogEnd),Ki.set(this._handle,Xi.ATTEN,t.fogAtten),Ki.set(this._handle,Xi.TOP,t.fogTop),Ki.set(this._handle,Xi.RANGE,t.fogRange)}activate(){this._updatePipeline()}_updatePipeline(){const t=i.director.root,e=this.enabled?this.type:Sx,n=t.pipeline;n.macros.CC_USE_FOG!==e&&(n.macros.CC_USE_FOG=e,t.onGlobalPipelineStateChanged())}destroy(){this._handle&&(Ki.free(this._handle),this._handle=0)}};const gT=new ln(0,1,0),vT=new ln,yT=new vn;let xT=(Tx=Yl("cc.AmbientInfo"),Ex=Ah(me),Tx((bx=Gl((Ax=class{constructor(){Ul(this,"_skyColor",bx,this),Ul(this,"_skyIllum",wx,this),Ul(this,"_groundAlbedo",Rx,this),this._resource=null}set skyColor(t){this._skyColor.set(t),this._resource&&(this._resource.skyColor=this._skyColor)}get skyColor(){return this._skyColor}set skyIllum(t){this._skyIllum=t,this._resource&&(this._resource.skyIllum=this.skyIllum)}get skyIllum(){return this._skyIllum}set groundAlbedo(t){this._groundAlbedo.set(t),this._resource&&(this._resource.groundAlbedo=this._groundAlbedo)}get groundAlbedo(){return this._groundAlbedo}activate(t){this._resource=t,this._resource.initialize(this)}}).prototype,"_skyColor",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln(51,128,204,1)}}),wx=Gl(Ax.prototype,"_skyIllum",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ts.SKY_ILLUM}}),Rx=Gl(Ax.prototype,"_groundAlbedo",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln(51,51,51,255)}}),Gl(Ax.prototype,"skyColor",[ch],Object.getOwnPropertyDescriptor(Ax.prototype,"skyColor"),Ax.prototype),Gl(Ax.prototype,"skyIllum",[ch,Ex],Object.getOwnPropertyDescriptor(Ax.prototype,"skyIllum"),Ax.prototype),Gl(Ax.prototype,"groundAlbedo",[ch],Object.getOwnPropertyDescriptor(Ax.prototype,"groundAlbedo"),Ax.prototype),Cx=Ax))||Cx);i.AmbientInfo=xT;let ST=(Ix=Yl("cc.SkyboxInfo"),Px=Ah(sd),Ox=Ah(sd),Ix((Nx=Gl((Mx=class{constructor(){Ul(this,"_envmap",Nx,this),Ul(this,"_isRGBE",Lx,this),Ul(this,"_enabled",zx,this),Ul(this,"_useIBL",Bx,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}get enabled(){return this._enabled}set useIBL(t){this._useIBL=t,this._resource&&(this._resource.useIBL=this._useIBL)}get useIBL(){return this._useIBL}set envmap(t){this._envmap=t,this._resource&&(this._resource.envmap=this._envmap)}get envmap(){return this._envmap}set isRGBE(t){this._isRGBE=t,this._resource&&(this._resource.isRGBE=this._isRGBE)}get isRGBE(){return this._isRGBE}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}}).prototype,"_envmap",[Px],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Lx=Gl(Mx.prototype,"_isRGBE",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zx=Gl(Mx.prototype,"_enabled",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Bx=Gl(Mx.prototype,"_useIBL",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gl(Mx.prototype,"enabled",[ch],Object.getOwnPropertyDescriptor(Mx.prototype,"enabled"),Mx.prototype),Gl(Mx.prototype,"useIBL",[ch],Object.getOwnPropertyDescriptor(Mx.prototype,"useIBL"),Mx.prototype),Gl(Mx.prototype,"envmap",[ch,Ox],Object.getOwnPropertyDescriptor(Mx.prototype,"envmap"),Mx.prototype),Gl(Mx.prototype,"isRGBE",[ch],Object.getOwnPropertyDescriptor(Mx.prototype,"isRGBE"),Mx.prototype),Dx=Mx))||Dx);i.SkyboxInfo=ST;let TT=(Fx=Yl("cc.FogInfo"),Ux=Ah(xx),Gx=lh(),Hx=Ah(me),Vx=uh(),kx=mh(),jx=gh(),Wx=lh(),qx=Ah(me),Xx=mh(),Yx=gh(),Kx=lh(),$x=Ah(me),Zx=mh(),Jx=gh(),Qx=lh(),tS=Ah(me),eS=dh(),nS=mh(),iS=gh(),sS=lh(),rS=Ah(me),oS=mh(),aS=gh(),cS=lh(),lS=Ah(me),hS=mh(),_S=gh(),Fx((CS=ES=class{constructor(){Ul(this,"_type",pS,this),Ul(this,"_fogColor",mS,this),Ul(this,"_enabled",fS,this),Ul(this,"_fogDensity",gS,this),Ul(this,"_fogStart",vS,this),Ul(this,"_fogEnd",yS,this),Ul(this,"_fogAtten",xS,this),Ul(this,"_fogTop",SS,this),Ul(this,"_fogRange",TS,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set fogColor(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}get fogColor(){return this._fogColor}get type(){return this._type}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get fogDensity(){return this._fogDensity}set fogDensity(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}get fogStart(){return this._fogStart}set fogStart(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}get fogEnd(){return this._fogEnd}set fogEnd(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}get fogAtten(){return this._fogAtten}set fogAtten(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}get fogTop(){return this._fogTop}set fogTop(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}get fogRange(){return this._fogRange}set fogRange(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}},ES.FogType=xx,pS=Gl((dS=CS).prototype,"_type",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xx.LINEAR}}),mS=Gl(dS.prototype,"_fogColor",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln("#C8C8C8")}}),fS=Gl(dS.prototype,"_enabled",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gS=Gl(dS.prototype,"_fogDensity",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),vS=Gl(dS.prototype,"_fogStart",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),yS=Gl(dS.prototype,"_fogEnd",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),xS=Gl(dS.prototype,"_fogAtten",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),SS=Gl(dS.prototype,"_fogTop",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),TS=Gl(dS.prototype,"_fogRange",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Gl(dS.prototype,"enabled",[ch],Object.getOwnPropertyDescriptor(dS.prototype,"enabled"),dS.prototype),Gl(dS.prototype,"fogColor",[ch],Object.getOwnPropertyDescriptor(dS.prototype,"fogColor"),dS.prototype),Gl(dS.prototype,"type",[ch,Ux],Object.getOwnPropertyDescriptor(dS.prototype,"type"),dS.prototype),Gl(dS.prototype,"fogDensity",[Gx,Hx,Vx,kx,fh,jx],Object.getOwnPropertyDescriptor(dS.prototype,"fogDensity"),dS.prototype),Gl(dS.prototype,"fogStart",[Wx,qx,Xx,Yx],Object.getOwnPropertyDescriptor(dS.prototype,"fogStart"),dS.prototype),Gl(dS.prototype,"fogEnd",[Kx,$x,Zx,Jx],Object.getOwnPropertyDescriptor(dS.prototype,"fogEnd"),dS.prototype),Gl(dS.prototype,"fogAtten",[Qx,tS,eS,nS,iS],Object.getOwnPropertyDescriptor(dS.prototype,"fogAtten"),dS.prototype),Gl(dS.prototype,"fogTop",[sS,rS,oS,aS],Object.getOwnPropertyDescriptor(dS.prototype,"fogTop"),dS.prototype),Gl(dS.prototype,"fogRange",[cS,lS,hS,_S],Object.getOwnPropertyDescriptor(dS.prototype,"fogRange"),dS.prototype),uS=dS))||uS),ET=(AS=Yl("cc.ShadowsInfo"),bS=Ah(bp),wS=lh(),RS=Ah(me),IS=lh(),PS=Ah(wp),OS=lh(),DS=Ah(fe),MS=lh(),NS=Ah(me),LS=lh(),zS=Ah(me),BS=lh(),FS=Ah(me),US=lh(),GS=Ah(pe),HS=lh(),VS=lh(),kS=Ah(me),jS=lh(),WS=Ah(me),qS=lh(),AS((KS=Gl((YS=class{constructor(){Ul(this,"_type",KS,this),Ul(this,"_enabled",$S,this),Ul(this,"_normal",ZS,this),Ul(this,"_distance",JS,this),Ul(this,"_shadowColor",QS,this),Ul(this,"_autoAdapt",tT,this),Ul(this,"_pcf",eT,this),Ul(this,"_bias",nT,this),Ul(this,"_near",iT,this),Ul(this,"_far",sT,this),Ul(this,"_aspect",rT,this),Ul(this,"_orthoSize",oT,this),Ul(this,"_maxReceived",aT,this),Ul(this,"_size",cT,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get type(){return this._type}set shadowColor(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}get shadowColor(){return this._shadowColor}set normal(t){ln.copy(this._normal,t),this._resource&&(this._resource.normal=t)}get normal(){return this._normal}set distance(t){this._distance=t,this._resource&&(this._resource.distance=t)}get distance(){return this._distance}set pcf(t){this._pcf=t,this._resource&&(this._resource.pcf=t)}get pcf(){return this._pcf}set autoAdapt(t){this._autoAdapt=t,this._resource&&(this._resource.autoAdapt=t)}get autoAdapt(){return this._autoAdapt}set near(t){this._near=t,this._resource&&(this._resource.near=t)}get near(){return this._near}set far(t){this._far=t,this._resource&&(this._resource.far=t)}get far(){return this._far}set orthoSize(t){this._orthoSize=t,this._resource&&(this._resource.orthoSize=t)}get orthoSize(){return this._orthoSize}set maxReceived(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}get maxReceived(){return this._maxReceived}set shadowMapSize(t){this._size.set(t),this._resource&&(this._resource.size=t,this._resource.shadowMapDirty=!0)}get shadowMapSize(){return this._size}set aspect(t){this._aspect=t,this._resource&&(this._resource.aspect=t)}get aspect(){return this._aspect}set bias(t){this._bias=t,this._resource&&(this._resource.bias=t)}get bias(){return this._bias}setPlaneFromNode(t){t.getWorldRotation(yT),this.normal=ln.transformQuat(vT,gT,yT),t.getWorldPosition(vT),this.distance=ln.dot(this._normal,vT)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}}).prototype,"_type",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bp.Planar}}),$S=Gl(YS.prototype,"_enabled",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ZS=Gl(YS.prototype,"_normal",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ln(0,1,0)}}),JS=Gl(YS.prototype,"_distance",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),QS=Gl(YS.prototype,"_shadowColor",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln(0,0,0,76)}}),tT=Gl(YS.prototype,"_autoAdapt",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eT=Gl(YS.prototype,"_pcf",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wp.HARD}}),nT=Gl(YS.prototype,"_bias",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),iT=Gl(YS.prototype,"_near",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sT=Gl(YS.prototype,"_far",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),rT=Gl(YS.prototype,"_aspect",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oT=Gl(YS.prototype,"_orthoSize",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),aT=Gl(YS.prototype,"_maxReceived",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),cT=Gl(YS.prototype,"_size",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rn(512,512)}}),Gl(YS.prototype,"enabled",[ch],Object.getOwnPropertyDescriptor(YS.prototype,"enabled"),YS.prototype),Gl(YS.prototype,"type",[ch,bS],Object.getOwnPropertyDescriptor(YS.prototype,"type"),YS.prototype),Gl(YS.prototype,"shadowColor",[ch],Object.getOwnPropertyDescriptor(YS.prototype,"shadowColor"),YS.prototype),Gl(YS.prototype,"normal",[wS],Object.getOwnPropertyDescriptor(YS.prototype,"normal"),YS.prototype),Gl(YS.prototype,"distance",[RS,IS],Object.getOwnPropertyDescriptor(YS.prototype,"distance"),YS.prototype),Gl(YS.prototype,"pcf",[PS,OS],Object.getOwnPropertyDescriptor(YS.prototype,"pcf"),YS.prototype),Gl(YS.prototype,"autoAdapt",[DS,MS],Object.getOwnPropertyDescriptor(YS.prototype,"autoAdapt"),YS.prototype),Gl(YS.prototype,"near",[NS,LS],Object.getOwnPropertyDescriptor(YS.prototype,"near"),YS.prototype),Gl(YS.prototype,"far",[zS,BS],Object.getOwnPropertyDescriptor(YS.prototype,"far"),YS.prototype),Gl(YS.prototype,"orthoSize",[FS,US],Object.getOwnPropertyDescriptor(YS.prototype,"orthoSize"),YS.prototype),Gl(YS.prototype,"maxReceived",[GS,HS],Object.getOwnPropertyDescriptor(YS.prototype,"maxReceived"),YS.prototype),Gl(YS.prototype,"shadowMapSize",[VS],Object.getOwnPropertyDescriptor(YS.prototype,"shadowMapSize"),YS.prototype),Gl(YS.prototype,"aspect",[kS,jS],Object.getOwnPropertyDescriptor(YS.prototype,"aspect"),YS.prototype),Gl(YS.prototype,"bias",[WS,qS],Object.getOwnPropertyDescriptor(YS.prototype,"bias"),YS.prototype),XS=YS))||XS);i.ShadowsInfo=ET;let CT=(lT=Yl("cc.SceneGlobals"),hT=Ah(ST),lT((dT=Gl((uT=class{constructor(){Ul(this,"ambient",dT,this),Ul(this,"shadows",pT,this),Ul(this,"_skybox",mT,this),Ul(this,"fog",fT,this)}get skybox(){return this._skybox}set skybox(t){this._skybox=t}activate(){const t=i.director.root.pipeline;this.ambient.activate(t.ambient),this.skybox.activate(t.skybox),this.shadows.activate(t.shadows),this.fog.activate(t.fog)}}).prototype,"ambient",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xT}}),pT=Gl(uT.prototype,"shadows",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ET}}),mT=Gl(uT.prototype,"_skybox",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ST}}),fT=Gl(uT.prototype,"fog",[ch,Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new TT}}),Gl(uT.prototype,"skybox",[ch,hT],Object.getOwnPropertyDescriptor(uT.prototype,"skybox"),uT.prototype),_T=uT))||_T);var AT,bT,wT,RT;i.SceneGlobals=CT;let IT=t("Scene",Yl("cc.Scene")((Gl((bT=class extends By{get renderScene(){return this._renderScene}get globals(){return this._globals}_updateScene(){this._scene=this}constructor(t){super(t),Ul(this,"autoReleaseAssets",wT,this),Ul(this,"_globals",RT,this),this._renderScene=null,this.dependAssets=null,this._inited=void 0,this._prefabSyncedInLiveReload=!1,this._pos=ln.ZERO,this._rot=vn.IDENTITY,this._scale=ln.ONE,this._mat=bn.IDENTITY,this._dirtyFlags=0,this._activeInHierarchy=!1,i.director&&i.director.root&&(this._renderScene=i.director.root.createScene({})),this._inited=!i.game||!i.game._isCloning}destroy(){const t=n_.prototype.destroy.call(this);if(t){const t=this._children;for(let e=0;e<t.length;++e)t[e].active=!1}return i.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t}addComponent(){throw new Error(b(3822))}_onHierarchyChanged(){}_onBatchCreated(t){super._onBatchCreated(t);const e=this._children.length;for(let n=0;n<e;++n)this._children[n]._onBatchCreated(t);Cv(this)}getPosition(t){return ln.copy(t||new ln,ln.ZERO)}getRotation(t){return vn.copy(t||new vn,vn.IDENTITY)}getScale(t){return ln.copy(t||new ln,ln.ONE)}getWorldPosition(t){return ln.copy(t||new ln,ln.ZERO)}getWorldRotation(t){return vn.copy(t||new vn,vn.IDENTITY)}getWorldScale(t){return ln.copy(t||new ln,ln.ONE)}getWorldMatrix(t){return bn.copy(t||new bn,bn.IDENTITY)}getWorldRS(t){return bn.copy(t||new bn,bn.IDENTITY)}getWorldRT(t){return bn.copy(t||new bn,bn.IDENTITY)}get position(){return ln.ZERO}get worldPosition(){return ln.ZERO}get rotation(){return vn.IDENTITY}get worldRotation(){return vn.IDENTITY}get scale(){return ln.ONE}get worldScale(){return ln.ONE}get eulerAngles(){return ln.ZERO}get worldMatrix(){return bn.IDENTITY}updateWorldTransform(){}_instantiate(){}_load(){this._inited||(this._onBatchCreated(!1),this._inited=!0),this.walk(By._setScene)}_activate(t){t=!1!==t,i.director._nodeActivator.activateNode(this,t),this._globals.activate()}}).prototype,"globals",[ch],Object.getOwnPropertyDescriptor(bT.prototype,"globals"),bT.prototype),wT=Gl(bT.prototype,"autoReleaseAssets",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RT=Gl(bT.prototype,"_globals",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CT}}),AT=bT))||AT);function PT(t,e){if(!e){const t=i.director.getScene();if(!t)return null;e=t}return e.getChildByPath(t)}var OT;i.Scene=IT,i.find=PT,n_.Flags.HideInHierarchy;let DT=t("PrivateNode",Yl("cc.PrivateNode")(OT=class extends sx{constructor(t){super(t)}})||OT);i.PrivateNode=DT;const MT=Ht.fastRemoveAt,NT=n_.Flags.IsStartCalled,LT=n_.Flags.IsOnEnableCalled;function zT(t,e){const n=e.constructor._executionOrder,i=e._id;let s=0;for(let e=t.length-1,r=e>>>1;s<=e;r=s+e>>>1){const o=t[r],a=o.constructor._executionOrder;if(a>n)e=r-1;else if(a<n)s=r+1;else{const t=o._id;if(t>i)e=r-1;else{if(!(t<i))return r;s=r+1}}}return~s}function BT(t,e){const n=t.array;let i=t.i+1;for(;i<n.length;){const s=n[i];s._enabled&&s.node._activeInHierarchy?++i:(t.removeAt(i),e&&(s._objFlags&=~e))}}n_.Flags.IsEditorOnEnableCalled;class FT{constructor(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;const e=Z;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t}}function UT(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}FT.stableRemoveInactive=BT;class GT extends FT{add(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)}remove(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)}cancelInactive(t){BT(this._zero,t),BT(this._neg,t),BT(this._pos,t)}invoke(){const t=this._neg;t.array.length>0&&(t.array.sort(UT),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;const e=this._pos;e.array.length>0&&(e.array.sort(UT),this._invoke(e),e.array.length=0)}}class HT extends FT{add(t){const e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{const n=e<0?this._neg.array:this._pos.array,i=zT(n,t);i<0&&n.splice(~i,0,t)}}remove(t){const e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{const n=e<0?this._neg:this._pos,i=zT(n.array,t);i>=0&&n.removeAt(i)}}invoke(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)}}function VT(t,e,n){const s=`var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];${t}}`,r=e?Function("it","dt",s):Function("it",s);return function(t,e,n){return(s,r)=>{try{e(s,r)}catch(e){i._throw(e);const o=s.array;for(n&&(o[s.i]._objFlags|=n),++s.i;s.i<o.length;++s.i)try{t(o[s.i],r)}catch(t){i._throw(t),n&&(o[s.i]._objFlags|=n)}}}}(Function("c","dt",t),r,n)}const kT=VT("c.start();c._objFlags|="+NT,!1,NT),jT=VT("c.update(dt)",!0),WT=VT("c.lateUpdate(dt)",!0),qT=t=>{const e=i.director._compScheduler,n=t.array;for(t.i=0;t.i<n.length;++t.i){const i=n[t.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||e._onEnabled(i))}};class XT{constructor(){this._deferredComps=[],this.unscheduleAll()}unscheduleAll(){this.startInvoker=new GT(kT),this.updateInvoker=new HT(jT),this.lateUpdateInvoker=new HT(WT),this._updating=!1}_onEnabled(t){i.director.getScheduler().resumeTarget(t),t._objFlags|=LT,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)}_onDisabled(t){i.director.getScheduler().pauseTarget(t),t._objFlags&=~LT;const e=this._deferredComps.indexOf(t);e>=0?MT(this._deferredComps,e):(!t.start||t._objFlags&NT||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))}enableComp(t,e){if(!(t._objFlags&LT)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}}disableComp(t){t._objFlags&LT&&(t.onDisable&&t.onDisable(),this._onDisabled(t))}startPhase(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}updatePhase(t){this.updateInvoker.invoke(t)}lateUpdatePhase(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()}_startForNewComps(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}_scheduleImmediate(t){"function"!=typeof t.start||t._objFlags&NT||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)}_deferredSchedule(){const t=this._deferredComps;for(let e=0,n=t.length;e<n;e++)this._scheduleImmediate(t[e]);t.length=0}}const YT=n_.Flags.IsPreloadStarted,KT=n_.Flags.IsOnLoadStarted,$T=n_.Flags.IsOnLoadCalled,ZT=n_.Flags.Deactivating;class JT extends FT{add(t){this._zero.array.push(t)}remove(t){this._zero.fastRemove(t)}cancelInactive(t){FT.stableRemoveInactive(this._zero,t)}invoke(){this._invoke(this._zero),this._zero.array.length=0}}const QT=VT("c.__preload();"),tE=VT("c.onLoad();c._objFlags|="+$T,!1,$T),eE=new Gt(4);function nE(t,e,n){e?t._removeComponent(e):Ht.removeAt(t._components,n)}eE.get=function(){const t=this._get()||{preload:new JT(QT),onLoad:new GT(tE),onEnable:new GT(qT)};t.preload._zero.i=-1;let e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,e=t.onEnable,e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};class iE{constructor(){this.resetComp=void 0,this.reset()}reset(){this._activatingStack=[]}activateNode(t,e){if(e){const e=eE.get();this._activatingStack.push(e),this._activateNodeRecursively(t,e.preload,e.onLoad,e.onEnable),e.preload.invoke(),e.onLoad.invoke(),e.onEnable.invoke(),this._activatingStack.pop(),eE.put(e)}else{this._deactivateNodeRecursively(t);const e=this._activatingStack;for(const t of e)t.preload.cancelInactive(YT),t.onLoad.cancelInactive(KT),t.onEnable.cancelInactive()}t.emit("active-in-hierarchy-changed",t)}activateComp(t,e,n,s){if(s_(t,!0)&&(t._objFlags&YT||(t._objFlags|=YT,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&KT||(t._objFlags|=KT,t.onLoad?n?n.add(t):(t.onLoad(),t._objFlags|=$T):t._objFlags|=$T),t._enabled)){if(!t.node._activeInHierarchy)return;i.director._compScheduler.enableComp(t,s)}}destroyComp(t){i.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&$T&&t.onDestroy()}_activateNodeRecursively(t,e,n,s){if(t._objFlags&ZT)return void T(3816,t.name);t._activeInHierarchy=!0;let r=t._components.length;for(let o=0;o<r;++o){const a=t._components[o];a instanceof i.Component?this.activateComp(a,e,n,s):(nE(t,a,o),--o,--r)}t._childArrivalOrder=t._children.length;for(let i=0,r=t._children.length;i<r;++i){const r=t._children[i];r._active&&this._activateNodeRecursively(r,e,n,s)}t._onPostActivated(!0)}_deactivateNodeRecursively(t){t._objFlags|=ZT,t._activeInHierarchy=!1;const e=t._components.length;for(let n=0;n<e;++n){const e=t._components[n];if(e._enabled&&(i.director._compScheduler.disableComp(e),t._activeInHierarchy))return void(t._objFlags&=~ZT)}for(let e=0,n=t._children.length;e<n;++e){const n=t._children[e];if(n._activeInHierarchy&&(this._deactivateNodeRecursively(n),t._activeInHierarchy))return void(t._objFlags&=~ZT)}t._onPostActivated(!1),t._objFlags&=~ZT}}t("NodeActivator",iE);class sE extends d_{constructor(){super(),this._compScheduler=void 0,this._nodeActivator=void 0,this._invalid=void 0,this._paused=void 0,this._purgeDirectorInNextLoop=void 0,this._root=void 0,this._loadingScene=void 0,this._scene=void 0,this._totalFrames=void 0,this._lastUpdate=void 0,this._deltaTime=void 0,this._startTime=void 0,this._scheduler=void 0,this._systems=void 0,this._invalid=!1,this._paused=!1,this._purgeDirectorInNextLoop=!1,this._root=null,this._loadingScene="",this._scene=null,this._totalFrames=0,this._lastUpdate=0,this._deltaTime=0,this._startTime=0,this._scheduler=new yy,this._compScheduler=new XT,this._nodeActivator=new iE,this._systems=[],i.game.once(of.EVENT_RENDERER_INITED,this._initOnRendererInitialized,this)}calculateDeltaTime(t){t||(t=performance.now()),this._deltaTime=t>this._lastUpdate?(t-this._lastUpdate)/1e3:0,this._lastUpdate=t}convertToGL(t){const e=i.game.container,n=i.view,s=e.getBoundingClientRect(),r=s.left+window.pageXOffset-e.clientLeft,o=s.top+window.pageYOffset-e.clientTop,a=n._devicePixelRatio*(t.x-r),c=n._devicePixelRatio*(o+s.height-t.y);return n._isRotated?cn(n._viewportRect.width-c,a):cn(a,c)}convertToUI(t){const e=i.game.container,n=i.view,s=e.getBoundingClientRect(),r=s.left+window.pageXOffset-e.clientLeft,o=s.top+window.pageYOffset-e.clientTop,a=cn(0,0);return n._isRotated?(a.x=r+t.y/n._devicePixelRatio,a.y=o+s.height-(n._viewportRect.width-t.x)/n._devicePixelRatio):(a.x=r+t.x*n._devicePixelRatio,a.y=o+s.height-t.y*n._devicePixelRatio),a}end(){this._purgeDirectorInNextLoop=!0}getWinSize(){return Dn(i.winSize)}getWinSizeInPixels(){return Dn(i.winSize)}pause(){this._paused||(this._paused=!0)}purgeCachedData(){i.assetManager.releaseAll()}purgeDirector(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),$m&&$m.setEnabled(!1),i.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),i.assetManager.releaseAll()}reset(){this.purgeDirector(),this.emit(sE.EVENT_RESET),$m&&$m.setEnabled(!0),this.startAnimation()}runSceneImmediate(t,e,n){t instanceof sy&&(t=t.scene),C(t instanceof IT,1216),t._load();const s=Object.keys(i.game._persistRootNodes).map(t=>i.game._persistRootNodes[t]);for(let e=0;e<s.length;e++){const n=s[e];n.emit(i.Node.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);const r=t.getChildByUuid(n.uuid);if(r){const e=r.getSiblingIndex();r._destroyImmediate(),t.insertChild(n,e)}else n.parent=t}const r=this._scene;i.isValid(r)&&r.destroy(),i.assetManager._releaseManager._autoRelease(r,t,s),this._scene=null,n_._deferredDestroy(),e&&e(),this.emit(i.Director.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,t),this.emit(i.Director.EVENT_AFTER_SCENE_LAUNCH,t)}runScene(t,e,n){t instanceof sy&&(t=t.scene),C(t,1205),C(t instanceof IT,1216),t._load(),this.once(i.Director.EVENT_AFTER_DRAW,()=>{this.runSceneImmediate(t,e,n)})}loadScene(t,e,n){if(this._loadingScene)return x(1208,t,this._loadingScene),!1;const s=i.assetManager.bundles.find(e=>e.getSceneInfo(t));return s?(this.emit(i.Director.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time("LoadScene "+t),s.loadScene(t,(i,s)=>{console.timeEnd("LoadScene "+t),this._loadingScene="",i?(u(i),e&&e(i)):this.runSceneImmediate(s,n,e)}),!0):(T(1209,t),!1)}preloadScene(t,e,n){const s=i.assetManager.bundles.find(e=>e.getSceneInfo(t));if(s)s.preloadScene(t,null,e,n);else{const e=`Can not preload the scene "${t}" because it is not in the build settings.`;n&&n(new Error(e)),u("preloadScene: "+e)}}resume(){this._paused&&(this._lastUpdate=performance.now(),this._lastUpdate||v(1200),this._paused=!1,this._deltaTime=0)}setDepthTest(t){i.Camera.main&&(i.Camera.main.depth=!!t)}setClearColor(t){i.Camera.main&&(i.Camera.main.backgroundColor=t)}get root(){return this._root}getRunningScene(){return this._scene}getScene(){return this._scene}getAnimationInterval(){return 1e3/i.game.getFrameRate()}setAnimationInterval(t){i.game.setFrameRate(Math.round(1e3/t))}getDeltaTime(){return this._deltaTime}getTotalTime(){return performance.now()-this._startTime}getCurrentTime(){return this._lastUpdate}getTotalFrames(){return this._totalFrames}isPaused(){return this._paused}getScheduler(){return this._scheduler}setScheduler(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(yy.ID,t,200))}registerSystem(t,e,n){e.id=t,e.priority=n,e.init(),this._systems.push(e),this._systems.sort(dy.sortByPriority)}unregisterSystem(t){Ht.fastRemove(this._systems,t),this._systems.sort(dy.sortByPriority)}getSystem(t){return this._systems.find(e=>e.id===t)}getAnimationManager(){return this.getSystem(i.AnimationManager.ID)}startAnimation(){this._invalid=!1,this._lastUpdate=performance.now()}stopAnimation(){this._invalid=!0}mainLoop(t){if(this._purgeDirectorInNextLoop)this._purgeDirectorInNextLoop=!1,this.purgeDirector();else if(!this._invalid){this.calculateDeltaTime(t);const e=this._deltaTime;if(!this._paused){this.emit(sE.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(let t=0;t<this._systems.length;++t)this._systems[t].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(sE.EVENT_AFTER_UPDATE),n_._deferredDestroy();for(let t=0;t<this._systems.length;++t)this._systems[t].postUpdate(e)}this.emit(sE.EVENT_BEFORE_DRAW),this._root.frameMove(this._deltaTime),this.emit(sE.EVENT_AFTER_DRAW),$m.frameUpdateListeners(),sx.bookOfChange.clear(),this._totalFrames++}}_initOnRendererInitialized(){this._totalFrames=0,this._lastUpdate=performance.now(),this._startTime=this._lastUpdate,this._paused=!1,this._purgeDirectorInNextLoop=!1,$m&&$m.setEnabled(!0),this.registerSystem(yy.ID,this._scheduler,200),this.emit(sE.EVENT_INIT)}_init(){return this._root=new Sy(i.game._gfxDevice),this._root.initialize({}).catch(t=>(T(1217),Promise.reject(t)))}}t("Director",sE),sE.EVENT_INIT="director_init",sE.EVENT_RESET="director_reset",sE.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",sE.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",sE.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",sE.EVENT_BEFORE_UPDATE="director_before_update",sE.EVENT_AFTER_UPDATE="director_after_update",sE.EVENT_BEFORE_DRAW="director_before_draw",sE.EVENT_AFTER_DRAW="director_after_draw",sE.EVENT_BEFORE_COMMIT="director_before_commit",sE.EVENT_BEFORE_PHYSICS="director_before_physics",sE.EVENT_AFTER_PHYSICS="director_after_physics",sE.instance=void 0,i.Director=sE;const rE=t("director",sE.instance=i.director=new sE);class oE{constructor(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new wh,this.scenes=new wh,this.paths=new wh}init(t){(t=>{let e=t.uuids;const n=t.paths,i=t.types,s=t.deps,r=t.paths=Object.create(null);if(!1===t.debug){for(let t=0,n=e.length;t<n;t++)e[t]=jh(e[t]);for(const t in n){const e=n[t],s=e[1];e[1]=i[s]}}else{const t=Object.create(null);for(let n=0,i=e.length;n<i;n++){const i=e[n];e[n]=t[i]=jh(i)}e=t}for(const t in n){const i=n[t];r[e[t]]=i}const o=t.scenes;for(const t in o){const n=o[t];o[t]=e[n]}const a=t.packs;for(const t in a){const n=a[t];for(let t=0;t<n.length;++t)n[t]=e[n[t]]}const c=t.versions;if(c)for(const t in c){const n=c[t];for(let t=0;t<n.length;t+=2){const i=n[t];n[t]=e[i]||i}}const l=t.redirect;if(l)for(let t=0;t<l.length;t+=2)l[t]=e[l[t]],l[t+1]=s[l[t+1]]})(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect)}getInfoWithPath(t,e){if(!t)return null;t=Yh(t);const n=this.paths.get(t);if(n){if(!e)return n[0];for(let t=0,i=n.length;t<i;t++){const i=n[t];if(Vt.isChildClassOf(i.ctor,e))return i}}return null}getDirWithPath(t,e,n){"/"===(t=Yh(t))[t.length-1]&&(t=t.slice(0,-1));const i=n||[];return this.paths.forEach((n,s)=>{if(s.startsWith(t)&&((t,e)=>!(t.length>e.length)||47===t.charCodeAt(e.length))(s,t)||!t)for(let t=0,s=n.length;t<s;t++){const s=n[t];e&&!Vt.isChildClassOf(s.ctor,e)||i.push(s)}}),i}getAssetInfo(t){return this.assetInfos.get(t)||null}getSceneInfo(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t="/"+t),this.scenes.find((e,n)=>n.endsWith(t))}destroy(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()}_initUuid(t){if(t){this.assetInfos.clear();for(let e=0,n=t.length;e<n;e++){const n=t[e];this.assetInfos.add(n,{uuid:n})}}}_initPath(t){if(!t)return;const e=this.paths;e.clear();for(const n in t){const i=t[n],s=i[0],r=i[1],o=3===i.length,a=this.assetInfos.get(n);a.path=s,a.ctor=Vt._getClassById(r),e.has(s)?o?e.get(s).push(a):e.get(s).splice(0,0,a):e.add(s,[a])}}_initScene(t){if(!t)return;const e=this.scenes;e.clear();const n=this.assetInfos;for(const i in t){const s=t[i],r=n.get(s);r.url=i,e.add(i,r)}}_initPackage(t){if(!t)return;const e=this.assetInfos;for(const n in t){const i=t[n],s={uuid:n,packedUuids:i,ext:".json"};e.add(n,s);for(let t=0,n=i.length;t<n;t++){const r=i[t],o=e.get(r),a=o.packs;a?1===n?a.splice(0,0,s):a.push(s):o.packs=[s]}}}_initVersion(t){if(!t)return;const e=this.assetInfos;let n=t.import;if(n)for(let t=0,i=n.length;t<i;t+=2){const i=n[t];e.get(i).ver=n[t+1]}if(n=t.native,n)for(let t=0,i=n.length;t<i;t+=2){const i=n[t];e.get(i).nativeVer=n[t+1]}}_initRedirect(t){if(!t)return;const e=this.assetInfos;for(let n=0,i=t.length;n<i;n+=2){const i=t[n];e.get(i).redirect=t[n+1]}}}function aE(t,e){t._uuid&&e.push(t._uuid)}function cE(t,e){const n=Object.getOwnPropertyNames(t);for(let i=0;i<n.length;i++){const s=n[i];if("node"===s||"__eventTargets"===s)continue;const r=t[s];if("object"==typeof r&&r)if(Array.isArray(r))for(let t=0;t<r.length;t++){const n=r[t];n instanceof y_&&aE(n,e)}else if(r.constructor&&r.constructor!==Object)r instanceof y_&&aE(r,e);else{const t=Object.getOwnPropertyNames(r);for(let n=0;n<t.length;n++){const i=r[t[n]];i instanceof y_&&aE(i,e)}}}}function lE(t,e,n,i){n.push(t._uuid);const s=Vu.getDeps(t._uuid);for(let t=0,r=s.length;t<r;t++){const r=Ih.get(s[t]);if(!r)continue;const o=r._uuid;o in e?e[o]+=i:e[o]=r.refCount+i,n.includes(o)||lE(r,e,n,i)}}const hE=[];var _E=new class{constructor(){this._persistNodeDeps=new wh,this._toDelete=new wh,this._eventListener=!1}init(){this._persistNodeDeps.clear(),this._toDelete.clear()}_addPersistNodeRef(t){const e=[];!function t(e,n){for(let t=0;t<e._components.length;t++)cE(e._components[t],n);for(let i=0;i<e._children.length;i++)t(e._children[i],n)}(t,e);for(let t=0,n=e.length;t<n;t++){const n=Ih.get(e[t]);n&&n.addRef()}this._persistNodeDeps.add(t.uuid,e)}_removePersistNodeRef(t){if(!this._persistNodeDeps.has(t.uuid))return;const e=this._persistNodeDeps.get(t.uuid);for(let t=0,n=e.length;t<n;t++){const n=Ih.get(e[t]);n&&n.decRef()}this._persistNodeDeps.remove(t.uuid)}_autoRelease(t,e,n){if(t){const n=Vu.getDeps(t.uuid);for(let e=0,i=n.length;e<i;e++){const i=Ih.get(n[e]);i&&i.decRef(t.autoReleaseAssets)}const i=Vu._depends.get(t.uuid);if(i&&i.persistDeps){const e=i.persistDeps;for(let n=0,i=e.length;n<i;n++){const i=Ih.get(e[n]);i&&i.decRef(t.autoReleaseAssets)}}t.uuid!==e.uuid&&Vu.remove(t.uuid)}const i=Vu._depends.get(e.uuid);i&&(i.persistDeps=[]);for(let t=0,e=n.length;t<e;t++){const e=n[t],s=this._persistNodeDeps.get(e.uuid);for(const t of s){const e=Ih.get(t);e&&e.addRef()}i&&i.persistDeps.push(...s)}}tryRelease(t,e=!1){t instanceof y_&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,ie(this._freeAssets.bind(this)))))}_freeAssets(){this._eventListener=!1,this._toDelete.forEach(t=>{this._free(t)}),this._toDelete.clear()}_free(t,e=!1){const n=t._uuid;if(this._toDelete.remove(n),!s_(t,!0))return;if(!e&&t.refCount>0&&function(t){const e=Object.create(null);if(e[t._uuid]=t.refCount,lE(t,e,hE,-1),hE.length=0,0!==e[t._uuid])return e[t._uuid];for(const t in e)0!==e[t]&&lE(Ih.get(t),e,hE,1);return hE.length=0,e[t._uuid]}(t)>0)return;Ih.remove(n);const i=Vu.getDeps(n);for(let t=0,e=i.length;t<e;t++){const e=Ih.get(i[t]);e&&(e.decRef(!1),this._free(e,!1))}t.destroy(),Vu.remove(n)}};function uE(t,e){for(let n=0,i=t.input.length;n<i;n++){const i=t.input[n];e&&!i.isNative&&i.content instanceof y_&&i.content.decRef(!1),i.recycle()}t.input=null}function dE(t,e){return e?/\?/.test(t)?`${t}&_t=${Date.now()}`:`${t}?_t=${Date.now()}`:t}function pE(t,e,n,i,s,r,o){try{const a=Vu.parse(t,e);let c=!0;if(e instanceof y_&&!e.__nativeDepend__&&(c=!1),s){for(let t=0,e=a.deps.length;t<e;t++){const e=a.deps[t];e in n||(n[e]=!0,i.push({uuid:e,bundle:o&&o.name}))}c&&a.nativeDep&&(o&&(a.nativeDep.bundle=o.name),i.push({...a.nativeDep}))}else{r=!!e.asyncLoadAssets||r&&!a.preventDeferredLoadDependents;for(let t=0,e=a.deps.length;t<e;t++){const e=a.deps[t];e in n||(n[e]=!0,i.push({uuid:e,__asyncLoadAssets__:r,bundle:o&&o.name}))}c&&!r&&!a.preventPreloadNativeObject&&a.nativeDep&&(o&&(a.nativeDep.bundle=o.name),i.push({...a.nativeDep}))}}catch(t){u(t.message,t.stack)}}function mE(t,e,n){e&&(n=void 0!==n?n:i.assetManager.cacheAsset,!Xh(e)&&n&&Ih.add(t,e))}function fE(t,e,n){let i=!1;const s=e.__depends__;if(s){for(let t=0,e=s.length;t<e;t++){const e=s[t],r=n[e.uuid+"@import"];r?e.owner[e.prop]=r.addRef():(u(`The asset ${e.uuid} is missing!`),i=!0)}e.__depends__=null}return e.__nativeDepend__&&(n[t+"@native"]?e._nativeAsset=n[t+"@native"]:i=!0,e.__nativeDepend__=!1),i}function gE(t,e,n){let i=0;const s=[],r=t.length;0===r&&n&&n(s);const o=t=>{t&&s.push(t),i++,i===r&&n&&n(s)};for(let n=0;n<r;n++)e(t[n],o)}function vE(t,e,n){let i=t,s=e,r=n;if(void 0===n){const n="function"==typeof t;e?(r=e,n||(s=null)):void 0===e&&n&&(r=t,i=null,s=null),void 0!==e&&n&&(s=t,i=null)}return{options:i||Object.create(null),onProgress:s,onComplete:r}}function yE(t,e,n){let i=t,s=e,r=n;if(void 0===n){const n=Vt.isChildClassOf(t,y_);e?(r=e,n&&(s=null)):void 0!==e||n||(r=t,s=null,i=null),void 0===e||n||(s=t,i=null)}return{type:i,onProgress:s||null,onComplete:r}}function xE(t){return(e,n)=>{if(!t)return;const i=[];Array.isArray(n)?n.forEach(t=>t instanceof y_&&i.push(t.addRef())):n instanceof y_&&i.push(n.addRef()),ie(()=>{i.forEach(t=>t.decRef(!1)),t(e,n)})}}class SE{constructor(){this._config=new oE}get config(){return this._config}get name(){return this._config.name}get deps(){return this._config.deps}get base(){return this._config.base}getInfoWithPath(t,e){return this._config.getInfoWithPath(t,e)}getDirWithPath(t,e,n){return this._config.getDirWithPath(t,e,n)}getAssetInfo(t){return this._config.getAssetInfo(t)}getSceneInfo(t){return this._config.getSceneInfo(t)}init(t){this._config.init(t),Dh.add(t.name,this)}load(t,e,n,s){const{type:r,onProgress:o,onComplete:a}=yE(e,n,s),c={__requestType__:zh.PATH,type:r,bundle:this.name,__outputAsArray__:Array.isArray(t)};i.assetManager.loadAny(t,c,o,a)}preload(t,e,n,s){const{type:r,onProgress:o,onComplete:a}=yE(e,n,s);i.assetManager.preloadAny(t,{__requestType__:zh.PATH,type:r,bundle:this.name},o,a)}loadDir(t,e,n,s){const{type:r,onProgress:o,onComplete:a}=yE(e,n,s);i.assetManager.loadAny(t,{__requestType__:zh.DIR,type:r,bundle:this.name,__outputAsArray__:!0},o,a)}preloadDir(t,e,n,s){const{type:r,onProgress:o,onComplete:a}=yE(e,n,s);i.assetManager.preloadAny(t,{__requestType__:zh.DIR,type:r,bundle:this.name},o,a)}loadScene(t,e,n,s){const{options:r,onProgress:o,onComplete:a}=vE(e,n,s);r.preset=r.preset||"scene",r.bundle=this.name,i.assetManager.loadAny({scene:t},r,o,(t,e)=>{if(t)u(t.message,t.stack);else if(e instanceof sy&&e.scene){const t=e.scene;t._id=e._uuid,t.name=e.name}else t=new Error(`The asset ${e._uuid} is not a scene`);a&&a(t,e)})}preloadScene(t,e,n,s){const{options:r,onProgress:o,onComplete:a}=vE(e,n,s);r.bundle=this.name,i.assetManager.preloadAny({scene:t},r,o,e=>{e&&T(1210,t,e.message),a&&a(e)})}get(t,e){const n=this.getInfoWithPath(t,e);return n&&Ih.get(n.uuid)||null}release(t,e){const n=this.get(t,e);n&&_E.tryRelease(n,!0)}releaseUnusedAssets(){Ih.forEach(t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&_E.tryRelease(t)})}releaseAll(){Ih.forEach(t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&_E.tryRelease(t,!0)})}_destroy(){this._config.destroy()}}const TE=t("resources",new SE);function EE(t,e,n){const i=new Image;function s(){i.removeEventListener("load",s),i.removeEventListener("error",r),n&&n(null,i)}function r(){i.removeEventListener("load",s),i.removeEventListener("error",r),n&&n(new Error(b(4930,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",s),i.addEventListener("error",r),i.src=t,i}function CE(t,e,n,i){const s=new XMLHttpRequest,r=`download failed: ${t}, status: `;if(s.open("GET",t,!0),void 0!==e.xhrResponseType&&(s.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(s.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&s.overrideMimeType&&s.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(s.timeout=e.xhrTimeout),e.xhrHeader)for(const t in e.xhrHeader)s.setRequestHeader(t,e.xhrHeader[t]);return s.onload=()=>{200===s.status||0===s.status?i&&i(null,s.response):i&&i(new Error(`${r}${s.status}(no response)`))},n&&(s.onprogress=t=>{t.lengthComputable&&n(t.loaded,t.total)}),s.onerror=()=>{i&&i(new Error(`${r}${s.status}(error)`))},s.ontimeout=()=>{i&&i(new Error(`${r}${s.status}(time out)`))},s.onabort=()=>{i&&i(new Error(`${r}${s.status}(abort)`))},s.send(null),s}i.resources=TE;const AE={};function bE(t,e,n){if(AE[t])return n&&n(null),null;const i=document.createElement("script");function s(){i.parentNode.removeChild(i),i.removeEventListener("load",s,!1),i.removeEventListener("error",r,!1),AE[t]=!0,n&&n(null)}function r(){i.parentNode.removeChild(i),i.removeEventListener("load",s,!1),i.removeEventListener("error",r,!1),n&&n(new Error(b(4928,t)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=e.scriptAsyncLoading||!1,i.src=t,i.addEventListener("load",s,!1),i.addEventListener("error",r,!1),document.body.appendChild(i),i}const wE=/^(?:\w+:\/\/|\.+\/).+/,RE=(t,e,n)=>{(Om.capabilities.imageBitmap&&i.assetManager.allowImageBitmap?IE:EE)(t,e,n)},IE=(t,e,n)=>{e.xhrResponseType="blob",CE(t,e,e.onFileProgress,n)},PE=(t,e,n)=>{e.xhrResponseType="json",CE(t,e,e.onFileProgress,n)},OE=(t,e,n)=>{e.xhrResponseType="arraybuffer",CE(t,e,e.onFileProgress,n)},DE=(t,e,n)=>{e.xhrResponseType="text",CE(t,e,e.onFileProgress,n)},ME=(t,e,n)=>{const i=z(t);let s=t;wE.test(s)||(s=-1!==NE.remoteBundles.indexOf(i)?`${NE.remoteServerAddress}remote/${i}`:"assets/"+i);const r=e.version||NE.bundleVers[i];let o=0,a=null,c=null;PE(`${s}/config.${r?r+".":""}json`,e,(t,e)=>{t&&(c=t),a=e,a&&(a.base=s+"/"),o++,2===o&&n(c,a)}),bE(`${s}/index.${r?r+".":""}js`,e,t=>{t?(c=t,o++,2===o&&n(t)):NE.importBundleEntry(i).then(()=>{o++,2===o&&n(c,a)}).catch(t=>{c=t,o++,2===o&&n(c)})})},NE=new class{constructor(){this.maxConcurrency=16,this.maxRequestsPerFrame=16,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=EE,this.downloadDomAudio=null,this.downloadFile=CE,this.downloadScript=bE,this._downloaders={".png":RE,".jpg":RE,".bmp":RE,".jpeg":RE,".gif":RE,".ico":RE,".tiff":RE,".webp":RE,".image":RE,".pvr":OE,".pkm":OE,".astc":OE,".txt":DE,".xml":DE,".vsh":DE,".fsh":DE,".atlas":DE,".tmx":DE,".tsx":DE,".json":PE,".ExportJson":PE,".plist":DE,".fnt":DE,".binary":OE,".bin":OE,".dbbin":OE,".skel":OE,".js":bE,bundle:ME,default:DE},this._downloading=new wh,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}get remoteServerAddress(){return this._remoteServerAddress}init(t="",e={},n=[]){this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=n}register(t,e){"object"==typeof t?Ct(this._downloaders,t):this._downloaders[t]=e}importBundleEntry(t){return e.import("virtual:///prerequisite-imports/"+t)}download(t,e,n,i,s){const r=Ph.get(t);if(r)return void s(null,r);const o=this._downloading.get(t);if(o){o.push(s);const e=this._queue.find(e=>e.id===t);if(!e)return;const n=i.priority||0;return void(e.priority<n&&(e.priority=n,this._queueDirty=!0))}const a=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,c=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,l=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,h=this._downloaders[n]||this._downloaders.default;!function t(e,n,i,s,r=0){e(r,(o,a)=>{r++,!o||r>n?s&&s(o,a):setTimeout(()=>{t(e,n,i,s,r)},i)})}((n,r)=>{if(0===n&&this._downloading.add(t,[s]),!this.limited)return void h(dE(e,this.appendTimeStamp),i,r);this._updateTime();const o=(t,e)=>{this._totalNum--,this._handleQueueInNextFrame(c,l),r(t,e)};this._totalNum<c&&this._totalNumThisPeriod<l?(h(dE(e,this.appendTimeStamp),i,o),this._totalNum++,this._totalNumThisPeriod++):(this._queue.push({id:t,priority:i.priority||0,url:e,options:i,done:o,handler:h}),this._queueDirty=!0,this._totalNum<c&&this._handleQueueInNextFrame(c,l))},a,this.retryInterval,(e,n)=>{e||Ph.add(t,n);const i=this._downloading.remove(t);for(let t=0,s=i.length;t<s;t++)i[t](e,n)})}loadSubpackage(t,e){i.assetManager.loadBundle(t,null,e)}_updateTime(){const t=Date.now(),e=i.director.getDeltaTime(),n=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=t)}_handleQueue(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort((t,e)=>t.priority-e.priority),this._queueDirty=!1);const t=this._queue.pop();if(!t)break;this._totalNum++,this._totalNumThisPeriod++,t.handler(dE(t.url,this.appendTimeStamp),t.options,t.done)}this._handleQueueInNextFrame(t,e)}_handleQueueInNextFrame(t,e){!this._checkNextPeriod&&this._queue.length>0&&(ie(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)}};function LE(t,e,n,i){let s=null,r=null;try{s=new P_,s._nativeUrl=t,s._nativeAsset=e}catch(t){r=t}i(r,s)}function zE(t,e,n,i){const s=new uy;s.json=e,i(null,s)}function BE(t,e,n,i){const s=new cy;s.text=e,i(null,s)}function FE(t,e,n,i){const s=new Xv;s._nativeUrl=t,s._nativeAsset=e,i(null,s)}function UE(t,e,n,i){const s=new y_;s._nativeUrl=t,s._nativeAsset=e,i(null,s)}function GE(t,e,n,i){let s=Dh.get(e.name);s||(s=e.name===Fh.RESOURCES?TE:new SE,e.base=e.base||t+"/",s.init(e)),i(null,s)}var HE=new class{constructor(){this._creating=new wh,this._producers={".png":LE,".jpg":LE,".bmp":LE,".jpeg":LE,".gif":LE,".ico":LE,".tiff":LE,".webp":LE,".image":LE,".pvr":LE,".pkm":LE,".txt":BE,".xml":BE,".vsh":BE,".fsh":BE,".atlas":BE,".tmx":BE,".tsx":BE,".fnt":BE,".json":zE,".ExportJson":zE,".binary":FE,".bin":FE,".dbbin":FE,".skel":FE,bundle:GE,default:UE}}register(t,e){"object"==typeof t?Vt.mixin(this._producers,t):this._producers[t]=e}create(t,e,n,i,s){const r=this._producers[n]||this._producers.default,o=Ih.get(t);if(!i.reloadAsset&&o)return void s(null,o);const a=this._creating.get(t);a?a.push(s):(this._creating.add(t,[s]),r(t,e,i,(e,n)=>{!e&&n instanceof y_&&(n._uuid=t,mE(t,n,i.cacheAsset));const s=this._creating.remove(t);for(let t=0,i=s.length;t<i;t++)s[t](e,n)}))}},VE=new class{constructor(){this._loading=new wh,this._unpackers={".json":this.unpackJson}}unpackJson(t,e,n,i){let s=Vt.createMap(!0),r=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(b(5304,t[0]));hu(t,!0,void 0),_u(t);const e=new du(t[0]),n=t[1],i=t[2],s=t[3],r=t[4],o=t[5];for(let t=0;t<o.length;++t)o[t].unshift(e,n,i,s,r);return o}(e)).length!==t.length&&T(4915);for(let n=0;n<t.length;n++)s[t[n]+"@import"]=e[n]}else{const n=Vt._getClassId(Zu);if(e.type===n&&e.data){const i=e.data;i.length!==t.length&&T(4915);for(let e=0;e<t.length;e++)s[t[e]+"@import"]=pu(n,{base:i[e][0],mipmaps:i[e][1]})}else r=new Error("unmatched type pack!"),s=null}i(r,s)}init(){this._loading.clear()}register(t,e){"object"==typeof t?Vt.mixin(this._unpackers,t):this._unpackers[t]=e}unpack(t,e,n,i,s){e?(0,this._unpackers[n])(t,e,i,s):s(new Error("package data is wrong!"))}load(t,e,n){if(t.isNative||!t.info||!t.info.packs)return void NE.download(t.id,t.url,t.ext,t.options,n);if(Ph.has(t.id))return void n(null,Ph.get(t.id));const i=t.info.packs;let s=i.find(t=>this._loading.has(t.uuid));if(s)return void this._loading.get(s.uuid).push({onComplete:n,id:t.id});s=i[0],this._loading.add(s.uuid,[{onComplete:n,id:t.id}]);const r=Kh(s.uuid,{ext:s.ext,bundle:t.config.name});NE.download(s.uuid,r,s.ext,t.options,(e,n)=>{Ph.remove(s.uuid),e&&u(e.message,e.stack),this.unpack(s.packedUuids,n,s.ext,t.options,(t,n)=>{if(!t)for(const t in n)Ph.add(t,n[t]);const i=this._loading.remove(s.uuid);for(let s=0,r=i.length;s<r;s++){const r=i[s];if(e||t){r.onComplete(e||t);continue}const o=n[r.id];o?r.onComplete(null,o):r.onComplete(new Error("can not retrieve data from package"))}})})}};function kE(t,e){let n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);const{options:s,progress:r}=t,o=[],a=r.total;s.__exclude__=s.__exclude__||Object.create(null),t.output=[],gE(t.input,(s,c)=>{if(!s.isNative&&Ih.has(s.uuid)){const e=Ih.get(s.uuid);return e.addRef(),WE(s,t,e,null,e.__asyncLoadAssets__,o,a),void c()}VE.load(s,t.options,(l,h)=>{l?t.isFinish||(!i.assetManager.force||n?(u(l.message,l.stack),r.canInvoke=!1,e(l)):WE(s,t,null,null,!1,o,a)):t.isFinish||WE(s,t,null,h,!s.isNative,o,a),c()})},()=>{if(t.isFinish)return uE(t,!0),void t.dispatch("error");if(o.length>0){const i=Uh.create({input:o,progress:r,options:s,onProgress:t.onProgress,onError:Uh.prototype.recycle,onComplete:s=>{s||(t.output.push(...i.output),i.recycle()),n&&jE(t),e(s)}});Nh.async(i)}else n&&jE(t),e()})}function jE(t){const e=t.output;for(let t=0,n=e.length;t<n;t++)e[t].content&&e[t].content.decRef(!1)}function WE(t,e,n,i,s,r,o){const a=e.options.__exclude__,c=e.progress;t.content=n,t.file=i,e.output.push(t),s&&(a[t.uuid]=!0,pE(t.uuid,i||n,a,r,!0,!1,t.config),c.total=o+r.length),c.canInvoke&&e.dispatch("progress",++c.finish,c.total,t)}const qE=new class extends class{constructor(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}parse(t){return this._parseXML(t)}_parseXML(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")}}{parse(t){const e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return x(5100),{};let n=null;for(let t=0,i=e.childNodes.length;t<i&&(n=e.childNodes[t],1!==n.nodeType);t++);return this._parseNode(n)}_parseNode(t){let e=null;const n=t.tagName;if("dict"===n)e=this._parseDict(t);else if("array"===n)e=this._parseArray(t);else if("string"===n)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(let n=0;n<t.childNodes.length;n++)e+=t.childNodes[n].nodeValue}else"false"===n?e=!1:"true"===n?e=!0:"real"===n?e=parseFloat(t.firstChild.nodeValue):"integer"===n&&(e=parseInt(t.firstChild.nodeValue,10));return e}_parseArray(t){const e=[];for(let n=0,i=t.childNodes.length;n<i;n++){const i=t.childNodes[n];1===i.nodeType&&e.push(this._parseNode(i))}return e}_parseDict(t){const e={};let n="";for(let i=0,s=t.childNodes.length;i<s;i++){const s=t.childNodes[i];1===s.nodeType&&("key"===s.tagName?n=s.firstChild.nodeValue:e[n]=this._parseNode(s))}return e}};function XE(t,e){return t[e]<<8|t[e+1]}var YE=new class{constructor(){this._parsing=new wh,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".mp3":this.parseAudio,".ogg":this.parseAudio,".wav":this.parseAudio,".m4a":this.parseAudio,".plist":this.parsePlist,import:this.parseImport}}parseImage(t,e,n){t instanceof HTMLImageElement?n(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then(t=>{n(null,t)},t=>{n(t,null)})}parseAudio(t,e,n){t instanceof ArrayBuffer?Om.__audioSupport.context.decodeAudioData(t,t=>{n(null,t)},t=>{n(new Error("Error with decoding audio data"+t.err),null)}):n(null,t)}parsePVRTex(t,e,n){let i=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,n=new Int32Array(e,0,13);if(55727696===n[0]){const t=n[7],i=n[6],r=n[12]+52;s={_data:new Uint8Array(e,r),_compressed:!0,width:t,height:i,format:0}}else{if(559044176!==n[11])throw new Error("Invalid magic number in PVR header");{const t=n[0],i=n[1],r=n[2];s={_data:new Uint8Array(e,t),_compressed:!0,width:r,height:i,format:0}}}}catch(t){i=t}n(i,s)}parsePKMTex(t,e,n){let i=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,n=new Uint8Array(e),i=XE(n,6);if(0!==i&&1!==i&&3!==i)throw new Error("Invalid magic number in ETC header");const r=XE(n,12),o=XE(n,14);XE(n,8),XE(n,10),s={_data:new Uint8Array(e,16),_compressed:!0,width:r,height:o,format:0}}catch(t){i=t}n(i,s)}parseASTCTex(t,e,n){let i=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,n=new Uint8Array(e);if(1554098963!==n[0]+(n[1]<<8)+(n[2]<<16)+(n[3]<<24))throw new Error("Invalid magic number in ASTC header");const i=n[4],r=n[5],o=n[6];if((i<3||i>6||r<3||r>6||o<3||o>6)&&(i<4||7===i||9===i||11===i||i>12||r<4||7===r||9===r||11===r||r>12||1!==o))throw new Error("Invalid block number in ASTC header");const a=function(t,e){return 4===t?x_.RGBA_ASTC_4x4:5===t?4===e?x_.RGBA_ASTC_5x4:x_.RGBA_ASTC_5x5:6===t?5===e?x_.RGBA_ASTC_6x5:x_.RGBA_ASTC_6x6:8===t?5===e?x_.RGBA_ASTC_8x5:6===e?x_.RGBA_ASTC_8x6:x_.RGBA_ASTC_8x8:10===t?5===e?x_.RGBA_ASTC_10x5:6===e?x_.RGBA_ASTC_10x6:8===e?x_.RGBA_ASTC_10x8:x_.RGBA_ASTC_10x10:10===e?x_.RGBA_ASTC_12x10:x_.RGBA_ASTC_12x12}(i,r),c=n[7]+(n[8]<<8)+(n[9]<<16),l=n[10]+(n[11]<<8)+(n[12]<<16);n[13],n[14],n[15],s={_data:new Uint8Array(e,16),_compressed:!0,width:c,height:l,format:a}}catch(t){i=t}n(i,s)}parsePlist(t,e,n){let i=null;const s=qE.parse(t);s||(i=new Error("parse failed")),n(i,s)}parseImport(t,e,n){if(!t)return void n(new Error(`The json file of asset ${e.__uuid__} is empty or missing`));let i=null,s=null;try{i=Gu(t,e)}catch(t){s=t}n(s,i)}init(){this._parsing.clear()}register(t,e){"object"==typeof t?Ct(this._parsers,t):this._parsers[t]=e}parse(t,e,n,i,s){const r=Oh.get(t);if(r)return void s(null,r);const o=this._parsing.get(t);if(o)return void o.push(s);const a=this._parsers[n];a?(this._parsing.add(t,[s]),a(e,i,(e,n)=>{e?Ph.remove(t):Xh(n)||Oh.add(t,n);const i=this._parsing.remove(t);for(let t=0,s=i.length;t<s;t++)i[t](e,n)})):s(null,e)}};function KE(t,e){let n=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},n=!0);const{options:s,progress:r}=t;s.__exclude__=s.__exclude__||Object.create(null),t.output=[],gE(t.input,(o,a)=>{const c=Uh.create({input:o,onProgress:t.onProgress,options:s,progress:r,onComplete:(s,l)=>{s&&!t.isFinish&&(!i.assetManager.force||n?(u(s.message,s.stack),r.canInvoke=!1,e(s)):r.canInvoke&&t.dispatch("progress",++r.finish,r.total,o)),t.output.push(l),c.recycle(),a(null)}});$E.async(c)},()=>{if(s.__exclude__=null,t.isFinish)return uE(t,!0),void t.dispatch("error");!function(t){const e=t.source;if(t.options.__outputAsArray__||1!==e.length){const n=t.output=[];for(let t=0,i=e.length;t<i;t++)n.push(e[t].content)}else t.output=e[0].content}(t),uE(t,!0),e()})}const $E=new Rh("loadOneAsset",[function(t,e){const n=t.output=t.input,{options:i,isNative:s,uuid:r,file:o}=n,{reloadAsset:a}=i;o||!a&&!s&&Ih.has(r)?e():VE.load(n,t.options,(t,i)=>{n.file=i,e(t)})},function(t,e){const n=t.output=t.input,i=t.progress,s=t.options.__exclude__,{id:r,file:o,options:a}=n;if(n.isNative)YE.parse(r,o,n.ext,a,(s,o)=>{s?e(s):(n.content=o,i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),Ph.remove(r),Oh.remove(r),e())});else{const{uuid:c}=n;if(c in s){const{finish:r,content:o,err:a,callbacks:l}=s[c];i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),r||function t(e,n,i,s={}){if(!i[n]||s[n])return!1;s[n]=!0;let r=!1;const o=Vu.getDeps(n);if(o)for(let n=0,a=o.length;n<a;n++){const a=o[n];if(a===e||t(e,a,i,s)){r=!0;break}}return r}(c,c,s)?(o&&o.addRef(),n.content=o,e(a)):l.push({done:e,item:n})}else if(!a.reloadAsset&&Ih.has(c)){const s=Ih.get(c);a.__asyncLoadAssets__||!s.__asyncLoadAssets__?(n.content=s.addRef(),i.canInvoke&&t.dispatch("progress",++i.finish,i.total,n),e()):ZE(t,s,e,!1)}else a.__uuid__=c,YE.parse(r,o,"import",a,(n,i)=>{n?e(n):ZE(t,i,e,!0)})}}]);function ZE(t,e,n,i){const{input:s,progress:r}=t,{uuid:o,id:a,options:c,config:l}=s,{__asyncLoadAssets__:h,cacheAsset:_}=c,d=[];e.addRef&&e.addRef(),pE(o,e,Object.create(null),d,!1,h,l),r.canInvoke&&t.dispatch("progress",++r.finish,r.total+=d.length,s);const p=t.options.__exclude__[o]={content:e,finish:!1,callbacks:[{done:n,item:s}]},m=Uh.create({input:d,options:t.options,onProgress:t.onProgress,onError:Uh.prototype.recycle,progress:r,onComplete:t=>{if(e.decRef&&e.decRef(!1),e.__asyncLoadAssets__=h,p.finish=!0,p.err=t,!t){const t=Array.isArray(m.output)?m.output:[m.output],n=Object.create(null);for(const e of t)e&&(n[e instanceof y_?e._uuid+"@import":o+"@native"]=e);if(i){fE(o,e,n);try{!e.onLoaded||e.__onLoadedInvoked__||e.__nativeDepend__||(e.onLoaded(),e.__onLoadedInvoked__=!0)}catch(t){u(t.message,t.stack)}Ph.remove(a),Oh.remove(a),mE(o,e,_)}else if(e.__nativeDepend__){fE(o,e,n);try{!e.onLoaded||e.__onLoadedInvoked__||e.__nativeDepend__||(e.onLoaded(),e.__onLoadedInvoked__=!0)}catch(t){u(t.message,t.stack)}}m.recycle()}const n=p.callbacks;for(let i=0,s=n.length;i<s;i++){const s=n[i];e.addRef&&e.addRef(),s.item.content=e,s.done(t)}n.length=0}});Mh.async(m)}function JE(t,e){const n=t.options,i=Object.create(null),s=Object.create(null);for(const t in n)switch(t){case zh.PATH:case zh.UUID:case zh.DIR:case zh.SCENE:case zh.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[t]=n[t];break;case"__exclude__":case"__outputAsArray__":s[t]=n[t];break;default:i[t]=n[t],s[t]=n[t]}t.options=s;const r=Uh.create({input:t.input,options:i});let o=null;try{t.output=t.source=Lh.sync(r)}catch(t){o=t;for(let t=0,e=r.output.length;t<e;t++)r.output[t].recycle()}r.recycle(),e(o)}class QE{constructor(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}get id(){return this._id||(this._id=`${this.uuid}@${this.isNative?"native":"import"}`),this._id}static create(){let t;return t=0!==QE._deadPool.length?QE._deadPool.pop():new QE,t}recycle(){QE._deadPool.length!==QE.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),QE._deadPool.push(this))}}QE.MAX_DEAD_NUM=500,QE._deadPool=[];const tC=[];function eC(t){const e=t.options,n=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(let i=0;i<n.length;i++){let s=n[i],r=QE.create(),o=null,a=null;if("string"==typeof s&&(s=Object.create(null),s[e.__requestType__||zh.UUID]=n[i]),"object"==typeof s){Et(s,e),s.preset&&Et(s,Bh[s.preset]);for(const t in s){switch(t){case zh.UUID:{const t=r.uuid=jh(s.uuid);if(!s.bundle){const e=Dh.find(e=>!!e.getAssetInfo(t));s.bundle=e&&e.name}if(Dh.has(s.bundle)){if(o=Dh.get(s.bundle).config,a=o.getAssetInfo(t),a&&a.redirect){if(!Dh.has(a.redirect))throw new Error(`Please load bundle ${a.redirect} first`);o=Dh.get(a.redirect).config,a=o.getAssetInfo(t)}r.config=o,r.info=a}r.ext=s.ext||".json";break}case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case zh.DIR:if(Dh.has(s.bundle)){Dh.get(s.bundle).config.getDirWithPath(s.dir,s.type,tC);for(const t of tC)n.push({uuid:t.uuid,__isNative__:!1,ext:".json",bundle:s.bundle});tC.length=0}r.recycle(),r=null;break;case zh.PATH:if(Dh.has(s.bundle)){if(o=Dh.get(s.bundle).config,a=o.getInfoWithPath(s.path,s.type),a&&a.redirect){if(!Dh.has(a.redirect))throw new Error(`you need to load bundle ${a.redirect} first`);o=Dh.get(a.redirect).config,a=o.getAssetInfo(a.uuid)}if(!a)throw r.recycle(),new Error(`Bundle ${s.bundle} doesn't contain ${s.path}`);r.config=o,r.uuid=a.uuid,r.info=a}r.ext=s.ext||".json";break;case zh.SCENE:if(!s.bundle){const t=Dh.find(t=>!!t.getSceneInfo(s.scene));s.bundle=t&&t.name}if(Dh.has(s.bundle)){if(o=Dh.get(s.bundle).config,a=o.getSceneInfo(s.scene),a&&a.redirect){if(!Dh.has(a.redirect))throw new Error(`you need to load bundle ${a.redirect} first`);o=Dh.get(a.redirect).config,a=o.getAssetInfo(a.uuid)}if(!a)throw r.recycle(),new Error(`Bundle ${o.name} doesn't contain scene ${s.scene}`);r.config=o,r.uuid=a.uuid,r.info=a}break;case"__isNative__":r.isNative=s.__isNative__;break;case zh.URL:r.url=s.url,r.uuid=s.uuid||s.url,r.ext=s.ext||N(s.url),r.isNative=void 0===s.__isNative__||s.__isNative__;break;default:r.options[t]=s[t]}if(!r)break}}if(r&&(t.output.push(r),!r.uuid&&!r.url))throw new Error("Can not parse this input:"+JSON.stringify(s))}return null}function nC(t){const e=t.output=t.input;for(let t=0;t<e.length;t++){const n=e[t];if(n.url)continue;let s="",r="";const o=n.config;r=n.isNative?o&&o.nativeBase?o.base+o.nativeBase:i.assetManager.generalNativeBase:o&&o.importBase?o.base+o.importBase:i.assetManager.generalImportBase;const a=n.uuid;let c="";n.info&&(c=n.isNative?n.info.nativeVer?"."+n.info.nativeVer:"":n.info.ver?"."+n.info.ver:""),s=".ttf"===n.ext?`${r}/${a.slice(0,2)}/${a}${c}/${n.options.__nativeName__}`:`${r}/${a.slice(0,2)}/${a}${c}${n.ext}`,n.url=s}return null}class iC{constructor(){this.pipeline=Mh.append(JE).append(KE),this.fetchPipeline=Nh.append(JE).append(kE),this.transformPipeline=Lh.append(eC).append(nC),this.bundles=Dh,this.assets=Ih,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=Vu,this.force=!1,this.allowImageBitmap=!Om.isMobile,this.utils=$h,this.downloader=NE,this.parser=YE,this.packManager=VE,this.cacheAsset=!0,this.cacheManager=null,this.presets=Bh,this.factory=HE,this.preprocessPipe=JE,this.fetchPipe=kE,this.loadPipe=KE,this.references=null,this._releaseManager=_E,this._files=Ph,this._parsed=Oh,this._parsePipeline=null}get main(){return Dh.get(Fh.MAIN)||null}get resources(){return Dh.get(Fh.RESOURCES)||null}init(t={}){this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t.server,t.bundleVers,t.remoteBundles),this.parser.init(),this.dependUtil.init();let e=t.importBase||"";e&&e.endsWith("/")&&(e=e.substr(0,e.length-1));let n=t.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=e,this.generalNativeBase=n}getBundle(t){return Dh.get(t)||null}removeBundle(t){t._destroy(),Dh.remove(t.name)}loadAny(t,e,n,i){const{options:s,onProgress:r,onComplete:o}=vE(e,n,i);s.preset=s.preset||"default",t=Array.isArray(t)?t.slice():t;const a=new Uh({input:t,onProgress:r,onComplete:xE(o),options:s});Mh.async(a)}preloadAny(t,e,n,i){const{options:s,onProgress:r,onComplete:o}=vE(e,n,i);s.preset=s.preset||"preload",t=Array.isArray(t)?t.slice():t;const a=new Uh({input:t,onProgress:r,onComplete:xE(o),options:s});Nh.async(a)}postLoadNative(t,e,n){const{options:i,onComplete:s}=vE(e,void 0,n);if(!t._native||!t.__nativeDepend__)return void xE(s)(null);const r=Vu.getNativeDep(t._uuid);if(r){if(!Dh.has(r.bundle)){const e=Dh.find(e=>!!e.getAssetInfo(t._uuid));e&&(r.bundle=e.name)}this.loadAny(r,i,(e,n)=>{e?u(e.message,e.stack):t.isValid&&t.__nativeDepend__&&(t._nativeAsset=n,t.__nativeDepend__=!1),s&&s(e)})}}loadRemote(t,e,n){const{options:i,onComplete:s}=vE(e,void 0,n);i.reloadAsset||!this.assets.has(t)?(i.__isNative__=!0,i.preset=i.preset||"remote",this.loadAny({url:t},i,null,(e,n)=>{e?(u(e.message,e.stack),s&&s(e,n)):HE.create(t,n,i.ext||N(t),i,(t,e)=>{s&&s(t,e)})})):xE(s)(null,this.assets.get(t))}loadBundle(t,e,n){const{options:i,onComplete:s}=vE(e,void 0,n),r=z(t);this.bundles.has(r)?xE(s)(null,this.getBundle(r)):(i.preset=i.preset||"bundle",i.ext="bundle",i.__isNative__=!0,this.loadAny({url:t},i,null,(e,n)=>{e?(u(e.message,e.stack),s&&s(e,n)):HE.create(t,n,"bundle",i,(t,e)=>{s&&s(t,e)})}))}releaseAsset(t){_E.tryRelease(t,!0)}releaseUnusedAssets(){Ih.forEach(t=>{_E.tryRelease(t)})}releaseAll(){Ih.forEach(t=>{_E.tryRelease(t,!0)})}loadWithJson(t,e,n,i){throw new Error("Only valid in Editor")}}t("AssetManager",iC),iC.Pipeline=Rh,iC.Task=Uh,iC.Cache=wh,iC.RequestItem=QE,iC.Bundle=SE,iC.BuiltinBundleName=Fh;var sC,rC,oC,aC,cC,lC,hC,_C,uC,dC=t("assetManager",i.assetManager=new iC);i.AssetManager=iC;let pC=t("EventHandler",(sC=Yl("cc.ClickEvent"),rC=Ah(i.Node),sC((cC=Gl((aC=class t{constructor(){Ul(this,"target",cC,this),Ul(this,"component",lC,this),Ul(this,"_componentId",hC,this),Ul(this,"handler",_C,this),Ul(this,"customEventData",uC,this)}get _componentName(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)}set _componentName(t){this._componentId=this._compName2Id(t)}static emitEvents(e,...n){for(let i=0,s=e.length;i<s;i++){const s=e[i];s instanceof t&&s.emit(n)}}emit(t){const e=this.target;if(!i.isValid(e))return;this._genCompIdIfNeeded();const n=i.js._getClassById(this._componentId),s=e.getComponent(n);if(!i.isValid(s))return;const r=s[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),r.apply(s,t))}_compName2Id(t){const e=i.js.getClassByName(t);return i.js._getClassId(e)}_compId2Name(t){const e=i.js._getClassById(t);return i.js.getClassName(e)}_genCompIdIfNeeded(){this._componentId||(this._componentName=this.component,this.component="")}}).prototype,"target",[rC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lC=Gl(aC.prototype,"component",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hC=Gl(aC.prototype,"_componentId",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_C=Gl(aC.prototype,"handler",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uC=Gl(aC.prototype,"customEventData",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),oC=aC))||oC));var mC,fC,gC,vC,yC,xC,SC,TC,EC,CC,AC,bC,wC,RC,IC,PC,OC,DC,MC,NC,LC,zC,BC,FC,UC,GC,HC,VC,kC,jC,WC,qC,XC,YC,KC,$C,ZC,JC,QC,tA,eA,nA,iA,sA,rA,oA,aA,cA,lA,hA,_A,uA,dA,pA,mA,fA,gA,vA,yA,xA,SA,TA,EA,CA,AA,bA,wA;i.Component.EventHandler=pC;const RA=new ln,IA=jt(gl),PA=jt(fl),OA=jt(vl),DA=jt(xl),MA=jt(yl),NA=jt({SKYBOX:wl|Cr.DEPTH_STENCIL,SOLID_COLOR:Cr.ALL,DEPTH_ONLY:Cr.DEPTH_STENCIL,DONT_CLEAR:Cr.NONE});let LA=t("Camera",(mC=Yl("cc.Camera"),fC=ah(),gC=ih(),vC=gh(),yC=_h(),xC=Ah(yc.BitMask),SC=gh(),TC=_h(),EC=Ah(NA),CC=gh(),AC=_h(),bC=gh(),wC=_h(),RC=gh(),IC=_h(),PC=gh(),OC=_h(),DC=Ah(IA),MC=gh(),NC=_h(),LC=Ah(PA),zC=gh(),BC=_h(),FC=gh(),UC=_h(),GC=gh(),HC=_h(),VC=gh(),kC=_h(),jC=gh(),WC=_h(),qC=Ah(OA),XC=gh(),YC=_h(),KC=Ah(DA),$C=gh(),ZC=_h(),JC=Ah(MA),QC=gh(),tA=_h(),eA=gh(),nA=_h(),iA=Ah(mp),sA=gh(),rA=_h(),mC(oA=fC(oA=gC(oA=nh((wA=bA=class extends Nu{constructor(...t){super(...t),Ul(this,"_projection",cA,this),Ul(this,"_priority",lA,this),Ul(this,"_fov",hA,this),Ul(this,"_fovAxis",_A,this),Ul(this,"_orthoHeight",uA,this),Ul(this,"_near",dA,this),Ul(this,"_far",pA,this),Ul(this,"_color",mA,this),Ul(this,"_depth",fA,this),Ul(this,"_stencil",gA,this),Ul(this,"_clearFlags",vA,this),Ul(this,"_rect",yA,this),Ul(this,"_aperture",xA,this),Ul(this,"_shutter",SA,this),Ul(this,"_iso",TA,this),Ul(this,"_screenScale",EA,this),Ul(this,"_visibility",CA,this),Ul(this,"_targetTexture",AA,this),this._camera=null,this._inEditorMode=!1,this._flows=void 0}get camera(){return this._camera}get priority(){return this._priority}set priority(t){this._priority=t,this._camera&&(this._camera.priority=t)}get visibility(){return this._visibility}set visibility(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}get clearFlags(){return this._clearFlags}set clearFlags(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}get clearColor(){return this._color}set clearColor(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}get clearDepth(){return this._depth}set clearDepth(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}get clearStencil(){return this._stencil}set clearStencil(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}get projection(){return this._projection}set projection(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}get fovAxis(){return this._fovAxis}set fovAxis(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===fl.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}get fov(){return this._fov}set fov(t){this._fov=t,this._camera&&(this._camera.fov=je(t))}get orthoHeight(){return this._orthoHeight}set orthoHeight(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}get near(){return this._near}set near(t){this._near=t,this._camera&&(this._camera.nearClip=t)}get far(){return this._far}set far(t){this._far=t,this._camera&&(this._camera.farClip=t)}get aperture(){return this._aperture}set aperture(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}get shutter(){return this._shutter}set shutter(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}get iso(){return this._iso}set iso(t){this._iso=t,this._camera&&(this._camera.iso=t)}get rect(){return this._rect}set rect(t){this._rect=t,this._camera&&(this._camera.viewport=t)}get targetTexture(){return this._targetTexture}set targetTexture(t){if(this._targetTexture===t)return;const e=this._targetTexture;this._targetTexture=t,this._chechTargetTextureEvent(e),this._updateTargetTexture(),!t&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0)}get screenScale(){return this._screenScale}set screenScale(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}get inEditorMode(){return this._inEditorMode}set inEditorMode(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow)}onLoad(){this._createCamera()}onEnable(){this.node.hasChangedFlags|=Ol.POSITION,this._camera&&this._attachToScene()}onDisable(){this._camera&&this._detachFromScene()}onDestroy(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}screenPointToRay(t,e,n){return n||(n=zs.create()),this._camera&&this._camera.screenPointToRay(n,t,e),n}worldToScreen(t,e){return e||(e=new ln),this._camera&&this._camera.worldToScreen(e,t),e}screenToWorld(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e}convertToUINode(t,e,n){if(n||(n=new ln),!this._camera)return n;this.worldToScreen(t,RA);const s=e.getComponent("cc.UITransform"),r=df.getVisibleSize(),o=RA.x-.5*this._camera.width,a=RA.y-.5*this._camera.height;return RA.x=o/i.view.getScaleX()+.5*r.width,RA.y=a/i.view.getScaleY()+.5*r.height,s&&s.convertToNodeSpaceAR(RA,n),n}_createCamera(){this._camera||(this._camera=i.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?i.director.root&&i.director.root.mainWindow:i.director.root&&i.director.root.tempWindow,priority:this._priority}),this._camera.viewport=this._rect,this._camera.fovAxis=this._fovAxis,this._camera.fov=je(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()}_attachToScene(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}_detachFromScene(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}_chechTargetTextureEvent(t){t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",t=>{this._camera&&this._camera.setFixedSize(t.width,t.height)},this)}_updateTargetTexture(){if(this._camera&&this._targetTexture){const t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}}},bA.ProjectionType=IA,bA.FOVAxis=PA,bA.ClearFlag=NA,bA.Aperture=OA,bA.Shutter=DA,bA.ISO=MA,cA=Gl((aA=wA).prototype,"_projection",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return IA.PERSPECTIVE}}),lA=Gl(aA.prototype,"_priority",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hA=Gl(aA.prototype,"_fov",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),_A=Gl(aA.prototype,"_fovAxis",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return PA.VERTICAL}}),uA=Gl(aA.prototype,"_orthoHeight",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),dA=Gl(aA.prototype,"_near",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pA=Gl(aA.prototype,"_far",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),mA=Gl(aA.prototype,"_color",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln("#333333")}}),fA=Gl(aA.prototype,"_depth",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),gA=Gl(aA.prototype,"_stencil",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vA=Gl(aA.prototype,"_clearFlags",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return NA.SOLID_COLOR}}),yA=Gl(aA.prototype,"_rect",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Mn(0,0,1,1)}}),xA=Gl(aA.prototype,"_aperture",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return OA.F16_0}}),SA=Gl(aA.prototype,"_shutter",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DA.D125}}),TA=Gl(aA.prototype,"_iso",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MA.ISO100}}),EA=Gl(aA.prototype,"_screenScale",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),CA=Gl(aA.prototype,"_visibility",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ml}}),AA=Gl(aA.prototype,"_targetTexture",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gl(aA.prototype,"priority",[vC,yC],Object.getOwnPropertyDescriptor(aA.prototype,"priority"),aA.prototype),Gl(aA.prototype,"visibility",[xC,SC,TC],Object.getOwnPropertyDescriptor(aA.prototype,"visibility"),aA.prototype),Gl(aA.prototype,"clearFlags",[EC,CC,AC],Object.getOwnPropertyDescriptor(aA.prototype,"clearFlags"),aA.prototype),Gl(aA.prototype,"clearColor",[bC,wC],Object.getOwnPropertyDescriptor(aA.prototype,"clearColor"),aA.prototype),Gl(aA.prototype,"clearDepth",[RC,IC],Object.getOwnPropertyDescriptor(aA.prototype,"clearDepth"),aA.prototype),Gl(aA.prototype,"clearStencil",[PC,OC],Object.getOwnPropertyDescriptor(aA.prototype,"clearStencil"),aA.prototype),Gl(aA.prototype,"projection",[DC,MC,NC],Object.getOwnPropertyDescriptor(aA.prototype,"projection"),aA.prototype),Gl(aA.prototype,"fovAxis",[LC,zC,BC],Object.getOwnPropertyDescriptor(aA.prototype,"fovAxis"),aA.prototype),Gl(aA.prototype,"fov",[FC,UC],Object.getOwnPropertyDescriptor(aA.prototype,"fov"),aA.prototype),Gl(aA.prototype,"orthoHeight",[GC,HC],Object.getOwnPropertyDescriptor(aA.prototype,"orthoHeight"),aA.prototype),Gl(aA.prototype,"near",[VC,kC],Object.getOwnPropertyDescriptor(aA.prototype,"near"),aA.prototype),Gl(aA.prototype,"far",[jC,WC],Object.getOwnPropertyDescriptor(aA.prototype,"far"),aA.prototype),Gl(aA.prototype,"aperture",[qC,XC,YC],Object.getOwnPropertyDescriptor(aA.prototype,"aperture"),aA.prototype),Gl(aA.prototype,"shutter",[KC,$C,ZC],Object.getOwnPropertyDescriptor(aA.prototype,"shutter"),aA.prototype),Gl(aA.prototype,"iso",[JC,QC,tA],Object.getOwnPropertyDescriptor(aA.prototype,"iso"),aA.prototype),Gl(aA.prototype,"rect",[eA,nA],Object.getOwnPropertyDescriptor(aA.prototype,"rect"),aA.prototype),Gl(aA.prototype,"targetTexture",[iA,sA,rA],Object.getOwnPropertyDescriptor(aA.prototype,"targetTexture"),aA.prototype),oA=aA))||oA)||oA)||oA)||oA));var zA,BA,FA,UA,GA,HA,VA,kA,jA;i.Camera=LA;const WA={parent:null,owner:null,subModelIdx:0};let qA=t("RenderableComponent",(zA=Yl("cc.RenderableComponent"),BA=Ah([Ap]),FA=Ah(Ap),UA=gh(),GA=hh(),zA((kA=Gl((VA=class extends Nu{constructor(...t){super(...t),Ul(this,"_materials",kA,this),Ul(this,"_visFlags",jA,this),this._materialInstances=[],this._models=[]}get visibility(){return this._visFlags}set visibility(t){this._visFlags=t,this._onVisibilityChange(t)}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setMaterial(null,e);this._materials.splice(t.length)}}get materials(){for(let t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances}set materials(t){const e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(let t=this._materials.length-e;t<this._materials.length;++t)this.setMaterialInstance(t,null);for(let e=0;e<this._materialInstances.length;e++)this._materialInstances[e]!=t[e]&&this.setMaterialInstance(e,t[e])}get sharedMaterial(){return this.getMaterial(0)}getMaterial(t){return t<0||t>=this._materials.length?null:this._materials[t]}setMaterial(t,e){t&&t instanceof Dp&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;const n=this._materialInstances[e];n?n.parent!==this._materials[e]&&(n.destroy(),this._materialInstances[e]=null,this._onMaterialModified(e,this._materials[e])):this._onMaterialModified(e,this._materials[e])}get material(){return this.getMaterialInstance(0)}set material(t){1===this._materials.length&&this._materials[0]===t||this.setMaterialInstance(0,t)}getMaterialInstance(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){WA.parent=this._materials[t],WA.owner=this,WA.subModelIdx=t;const e=new Dp(WA);this.setMaterialInstance(t,e)}return this._materialInstances[t]}setMaterialInstance(t,e){e&&e.parent?e!==this._materialInstances[t]&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):e!==this._materials[t]&&this.setMaterial(e,t)}getRenderMaterial(t){return this._materialInstances[t]||this._materials[t]}_collectModels(){return this._models}_attachToScene(){}_detachFromScene(){}_onMaterialModified(t,e){}_onRebuildPSO(t,e){}_clearMaterials(){}_onVisibilityChange(t){}}).prototype,"_materials",[BA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jA=Gl(VA.prototype,"_visFlags",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yc.Enum.NONE}}),Gl(VA.prototype,"sharedMaterials",[FA,UA,GA],Object.getOwnPropertyDescriptor(VA.prototype,"sharedMaterials"),VA.prototype),HA=VA))||HA));var XA,YA,KA,$A,ZA,JA;function QA(t){return"string"==typeof t||"number"==typeof t}function tb(t,e){return t instanceof e}i.RenderableComponent=qA;let eb=Yl("cc.animation.HierarchyPath")((KA=Gl((YA=class{constructor(t){Ul(this,"path",KA,this),this.path=t||""}get(t){if(!(t instanceof sx))return _("Target of hierarchy path should be of type Node."),null;return t.getChildByPath(this.path)||(_(`Node "${t.name}" has no path "${this.path}"`),null)}}).prototype,"path",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),XA=YA))||XA,nb=Yl("cc.animation.ComponentPath")((JA=Gl((ZA=class{constructor(t){Ul(this,"component",JA,this),this.component=t||""}get(t){if(!(t instanceof sx))return _("Target of component path should be of type Node."),null;return t.getComponent(this.component)||(_(`Node "${t.name}" has no component "${this.component}"`),null)}}).prototype,"component",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$A=ZA))||$A;function ib(t,...e){let n=t;for(let t=0;t<e.length;++t){const i=e[t];if(QA(i)){if(!(i in n))return _(`Target object has no property "${i}"`),null;n=n[i]}else n=i.get(n);if(null===n)break}return n}var sb,rb,ob,ab,cb;let lb=Yl("cc.animation.UniformProxyFactory")((ob=Gl((rb=class{constructor(t,e){Ul(this,"passIndex",ob,this),Ul(this,"uniformName",ab,this),Ul(this,"channelIndex",cb,this),this.passIndex=e||0,this.uniformName=t||""}forTarget(t){const e=t.passes[this.passIndex],n=e.getHandle(this.uniformName);if(!n)throw new Error(`Material "${t.name}" has no uniform "${this.uniformName}"`);const s=Nd.getPropertyTypeFromHandle(n);if(s===ad.UBO){const i=void 0===this.channelIndex?n:e.getHandle(this.uniformName,this.channelIndex,qs.FLOAT);if(!i)throw new Error(`Uniform "${this.uniformName} (in material ${t.name}) has no channel ${this.channelIndex}"`);return function(t,e){for(const n of t.shaderInfo.blocks)for(const t of n.members)if(t.name===e)return t.count>1;return!1}(e,this.uniformName)?{set:t=>{e.setUniformArray(i,t)}}:{set:t=>{e.setUniform(i,t)}}}if(s===ad.SAMPLER){const t=Nd.getBindingFromHandle(n),s=e.properties[this.uniformName],r=s&&s.value?s.value+"-texture":gd(s.type);let o=Rd.get(r);return o||(_(`Illegal texture default value: ${r}.`),o=Rd.get("default-texture")),{set:n=>{n||(n=o);const s=n.getGFXTexture();s&&s.width&&s.height&&(e.bindTexture(t,s),n instanceof $_&&e.bindSampler(t,z_.getSampler(i.game._gfxDevice,n.getSamplerHash())))}}}throw new Error(`Animations are not available for uniforms with property type ${s}.`)}}).prototype,"passIndex",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ab=Gl(rb.prototype,"uniformName",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cb=Gl(rb.prototype,"channelIndex",[Th],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),sb=rb))||sb;var hb,_b,ub,db;let pb=Yl("cc.animation.MorphWeightsValueProxy")((ub=Gl((_b=class{constructor(){Ul(this,"subMeshIndex",ub,this)}forTarget(t){return{set:e=>{t.setWeights(e,this.subMeshIndex)}}}}).prototype,"subMeshIndex",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),hb=_b))||hb,mb=Yl("cc.animation.MorphWeightsAllValueProxy")(db=class{forTarget(t){return{set:e=>{var n,i;const s=null!==(n=null===(i=t.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0;for(let n=0;n<s;++n)t.setWeights(e,n)}}}})||db;var fb,gb,vb,yb,xb;function Sb(t,e,n,i){var s,r,o,a,c;let l=new e,h=new e,_=new e,u=Yl(t)((o=Gl((r=class{constructor(t,n,i){Ul(this,"dataPoint",o,this),Ul(this,"inTangent",a,this),Ul(this,"outTangent",c,this),this.dataPoint=t||new e,this.inTangent=n||new e,this.outTangent=i||new e}lerp(t,e,s){const r=this.dataPoint,o=t.dataPoint;h=n(h,this.inTangent,s),_=n(_,t.outTangent,s);const a=e*e*e,c=e*e,u=a-2*c+e,d=-2*a+3*c,p=a-c;return l=n(l,r,2*a-3*c+1),l=i(l,l,h,u),l=i(l,l,o,d),l=i(l,l,_,p),l}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),a=Gl(r.prototype,"inTangent",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),c=Gl(r.prototype,"outTangent",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),s=r))||s;if(e===vn){const t=u.prototype.lerp;u.prototype.lerp=function(e,n,i){const s=t.call(this,e,n,i);return vn.normalize(s,s),s}}return u}const Tb=t("CubicSplineVec2Value",Sb("cc.CubicSplineVec2Value",rn,rn.multiplyScalar,rn.scaleAndAdd));i.CubicSplineVec2Value=Tb;const Eb=t("CubicSplineVec3Value",Sb("cc.CubicSplineVec3Value",ln,ln.multiplyScalar,ln.scaleAndAdd));i.CubicSplineVec3Value=Eb;const Cb=t("CubicSplineVec4Value",Sb("cc.CubicSplineVec4Value",dn,dn.multiplyScalar,dn.scaleAndAdd));i.CubicSplineVec4Value=Cb;const Ab=t("CubicSplineQuatValue",Sb("cc.CubicSplineQuatValue",vn,vn.multiplyScalar,vn.scaleAndAdd));i.CubicSplineQuatValue=Ab;let bb=t("CubicSplineNumberValue",Yl("cc.CubicSplineNumberValue")((vb=Gl((gb=class{constructor(t,e,n){Ul(this,"dataPoint",vb,this),Ul(this,"inTangent",yb,this),Ul(this,"outTangent",xb,this),this.dataPoint=t,this.inTangent=e,this.outTangent=n}lerp(t,e,n){const i=this.dataPoint,s=t.dataPoint,r=e*e*e,o=e*e;return i*(2*r-3*o+1)+this.outTangent*n*(r-2*o+e)+s*(-2*r+3*o)+t.inTangent*n*(r-o)}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yb=Gl(gb.prototype,"inTangent",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xb=Gl(gb.prototype,"outTangent",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fb=gb))||fb);function wb(t,e,n,i,s){const r=1-s;return r*(r*(t+(3*e-t)*s)+3*n*s*s)+i*s*s*s}i.CubicSplineNumberValue=bb,t("animation",Object.freeze({__proto__:null,UniformProxyFactory:lb,MorphWeightsValueProxy:pb,MorphWeightsAllValueProxy:mb,isPropertyPath:QA,isCustomPath:tb,HierarchyPath:eb,ComponentPath:nb,evaluatePath:ib,CubicSplineVec2Value:Tb,CubicSplineVec3Value:Eb,CubicSplineVec4Value:Cb,CubicSplineQuatValue:Ab,CubicSplineNumberValue:bb})),i.bezier=wb;const Rb=Math.cos,Ib=Math.acos,Pb=Math.max,Ob=2*Math.PI,Db=Math.sqrt;function Mb(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function Nb(t,e){const n=function(t,e){const n=e-0,i=e-t[0],s=3*n,r=3*i,o=3*(e-t[2]),a=1/(-n+r-o+(e-1)),c=(s-6*i+o)*a,l=c*(1/3),h=(-s+r)*a,_=1/3*(3*h-c*c),u=_*(1/3),d=(2*c*c*c-9*c*h+n*a*27)/27,p=d/2,m=p*p+u*u*u;let f,g,v,y,x;if(m<0){const t=1/3*-_,e=Db(t*t*t),n=-d/(2*e),i=Ib(n<-1?-1:n>1?1:n),s=2*Mb(e);return v=s*Rb(i*(1/3))-l,y=s*Rb((i+Ob)*(1/3))-l,x=s*Rb((i+2*Ob)*(1/3))-l,v>=0&&v<=1?y>=0&&y<=1?x>=0&&x<=1?Pb(v,y,x):Pb(v,y):x>=0&&x<=1?Pb(v,x):v:y>=0&&y<=1?x>=0&&x<=1?Pb(y,x):y:x}if(0===m)return f=p<0?Mb(-p):-Mb(p),v=2*f-l,y=-f-l,v>=0&&v<=1?y>=0&&y<=1?Pb(v,y):v:y;{const t=Db(m);return f=Mb(-p+t),g=Mb(p+t),v=f-g-l,v}}(t,e),i=t[1];return((1-n)*(i+(t[3]-i)*n)*3+n*n)*n}function Lb(t,e,n=1e-6){let i=0,s=t.length-1,r=s>>>1;for(;i<=s;r=i+s>>>1){const o=t[r];if(o>e+n)s=r-1;else{if(!(o<e-n))return r;i=r+1}}return~i}i.bezierByTime=Nb;class zb{constructor(t){let e,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;let i=!0;for(let s=1,r=t.length;s<r;s++)if(e=t[s]-t[s-1],1===s)n=e;else if(Math.abs(e-n)>1e-6){i=!1;break}this._findRatio=i?Gb:Lb}sample(t){return this._findRatio(this.ratios,t)}}t("RatioSampler",zb),i.RatioSampler=zb;class Bb{static Bezier(t){return t}constructor(t,e){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=e,this._values=t.values;const n=t=>"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?Bb.Linear:Bb.Bezier(t):Bb.Linear;if(void 0!==t.easingMethod)this.type=n(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(n);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(const e of Object.keys(t.easingMethods))this.types[e]=n(t.easingMethods[e])}else this.type=null;const i=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=Hb(i)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}hasLerp(){return!!this._lerp}valueAt(t){if(void 0===this._array){const e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(let e=0;e<this._array.length;++e)this._array[e]=this._values[this._array.length*t+e];return this._array}valueBetween(t,e,n,i,s){if(this._lerp){const r=this.types?this.types[e]:this.type,o=s-n;let a=(t-n)/o;if(r&&(a=Ub(a,r)),void 0===this._array){const t=this._values[e],n=this._values[i];return this._lerp(t,n,a,o*this._duration)}for(let t=0;t<this._array.length;++t){const n=this._values[this._array.length*e+t],s=this._values[this._array.length*i+t];this._array[t]=this._lerp(n,s,a,o*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(let t=0;t<this._array.length;++t)this._array[t]=this._values[this._array.length*e+t];return this._array}empty(){return 0===this._values.length}constant(){return 1===this._values.length}}function Fb(t,e,n){let i=e.sample(n);if(i<0)if(i=~i,i<=0)i=0;else{if(!(i>=e.ratios.length))return t.valueBetween(n,i-1,e.ratios[i-1],i,e.ratios[i]);i=e.ratios.length-1}return t.valueAt(i)}function Ub(t,e){if("string"==typeof e){const n=Pm[e];n?t=n(t):T(3906,e)}else Array.isArray(e)&&(t=Nb(e,t));return t}function Gb(t,e){const n=t.length-1;if(0===n)return 0;const i=t[0];if(e<i)return 0;const s=t[n];if(e>s)return n;const r=(e=(e-i)/(s-i))/(1/n),o=0|r;return r-o<1e-6?o:o+1-r<1e-6?o+1:~(o+1)}t("AnimCurve",Bb),Bb.Linear=null,i.AnimCurve=Bb,t("EventInfo",class{constructor(){this.events=[]}add(t,e){this.events.push({func:t||"",params:e||[]})}}),i.sampleAnimationCurve=Fb;const Hb=(()=>{function t(t,e,n,i){return t.lerp(e,n,i)}return e=>{if(null!==e){if("number"==typeof e)return ke;if("object"==typeof e&&e.constructor){if(e instanceof vn)return function(){const t=new vn;return(e,n,i)=>vn.slerp(t,e,n,i)}();if(e instanceof Yt)return function(t){const e=new t;return(n,i,s)=>(t.lerp(e,n,i,s),e)}(e.constructor);if(e.constructor===Number)return ke;if("function"==typeof e.lerp)return t}}}})();class Vb{static getOrExtract(t){let e=Vb.pool.get(t);return e&&e.info.sample===t.sample||(e&&i.director.root.dataPoolManager.releaseAnimationClip(t),e=function(t){const e={};t.curves.forEach(t=>{if(!t.valueAdapter&&tb(t.modifiers[0],eb)&&QA(t.modifiers[1])){const{path:n}=t.modifiers[0];let i=e[n];i||(i=e[n]={}),i[t.modifiers[1]]={values:t.data.values,keys:t.data.keys}}});const n=Math.ceil(t.sample*t.duration)+1;for(const i of Object.keys(e)){const s=e[i];s&&Object.defineProperty(s,"worldMatrix",{get:()=>{if(!s._worldMatrix){const{position:r,rotation:o,scale:a}=s;kb(t,r,n),kb(t,o,n),kb(t,a,n),jb(e,i,s)}return s._worldMatrix}})}return{info:{frames:n,sample:t.sample},data:e}}(t),Vb.pool.set(t,e)),e}static destroy(t){Vb.pool.delete(t)}}function kb(t,e,n){const i=t.keys[e.keys],s=[];if(i&&1!==i.length){const r=e.values[0]instanceof vn;for(let o=0,a=0;o<n;o++){let n=o/t.sample;for(;i[a]<=n;)a++;a>i.length-1?(a=i.length-1,n=i[a]):0===a&&(a=1);const c=e.values[a-1].clone(),l=i[a]-i[a-1],h=l?Ve((n-i[a-1])/l):1;r?c.slerp(e.values[a],h):c.lerp(e.values[a],h),s[o]=c}}else for(let t=0;t<n;t++)s[t]=e.values[0].clone();e.values=s}function jb(t,e,n){const i=n.position.values,s=n.rotation.values,r=n.scale.values,o=i.map(()=>new bn),a=e.lastIndexOf("/");let c=null;if(a>0){const n=t[e.substring(0,a)];if(!n)return void console.warn("no data for parent bone?");c=n.worldMatrix.values}for(let t=0;t<i.length;t++){const e=i[t],n=s[t],a=r[t],l=o[t];bn.fromRTS(l,n,e,a),c&&bn.multiply(l,c[t],l)}Object.keys(n).forEach(t=>delete n[t]),n._worldMatrix={keys:0,interpolate:!1,values:o}}var Wb,qb,Xb,Yb,Kb,$b,Zb,Jb,Qb,tw,ew,nw,iw,sw;t("SkelAnimDataHub",Vb),Vb.pool=new Map;let rw=t("AnimationClip",Yl("cc.AnimationClip")((sw=iw=class t extends y_{constructor(...t){super(...t),Ul(this,"sample",Xb,this),Ul(this,"speed",Yb,this),Ul(this,"wrapMode",Kb,this),Ul(this,"events",$b,this),Ul(this,"_duration",Zb,this),Ul(this,"_keys",Jb,this),Ul(this,"_stepness",Qb,this),Ul(this,"_curves",tw,this),Ul(this,"_commonTargets",ew,this),Ul(this,"_hash",nw,this),this.frameRate=0,this._ratioSamplers=[],this._runtimeCurves=void 0,this._runtimeEvents=void 0,this._data=null}static createWithSpriteFrames(e,n){if(!Array.isArray(e))return T(3905),null;const i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;const s=1/i.sample,r=new Array(e.length),o=new Array(r.length);for(let t=0;t<e.length;t++)r[t]=t*s,o[t]=e[t];return i.keys=[r],i.curves=[{modifiers:[new nb("cc.Sprite"),"spriteFrame"],data:{keys:0,values:o}}],i}get duration(){return this._duration}set duration(t){this._duration=t}get keys(){return this._keys}set keys(t){this._keys=t}get eventGroups(){return this._runtimeEvents||this._createRuntimeEvents(),this._runtimeEvents.eventGroups}get stepness(){return this._stepness}set stepness(t){this._stepness=t,this._applyStepness()}get hash(){if(this._hash)return this._hash;const t=this._nativeAsset,e=new Uint8Array(ArrayBuffer.isView(t)?t.buffer:t);return this._hash=vo(e,666)}get curves(){return this._curves}set curves(t){this._curves=t,delete this._runtimeCurves}get data(){return this._data}get commonTargets(){return this._commonTargets}set commonTargets(t){this._commonTargets=t}onLoaded(){this.frameRate=this.sample,this._decodeCVTAs()}getPropertyCurves(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}updateEventDatas(){delete this._runtimeEvents}getEventGroupIndexAtRatio(t){return this._runtimeEvents||this._createRuntimeEvents(),Lb(this._runtimeEvents.ratios,t)}hasEvents(){return 0!==this.events.length}destroy(){return i.director.root.dataPoolManager&&i.director.root.dataPoolManager.releaseAnimationClip(this),Vb.destroy(this),super.destroy()}_createPropertyCurves(){this._ratioSamplers=this._keys.map(t=>new zb(t.map(t=>t/this._duration))),this._runtimeCurves=this._curves.map(t=>({curve:new Bb(t.data,this._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:this._ratioSamplers[t.data.keys],commonTarget:t.commonTarget})),this._applyStepness()}_createRuntimeEvents(){const t=[],e=[],n=this.events.sort((t,e)=>t.frame-e.frame);for(const i of n){const n=i.frame/this._duration;let s=t.findIndex(t=>t===n);s<0&&(s=t.length,t.push(n),e.push({events:[]})),e[s].events.push({functionName:i.func,parameters:i.params})}this._runtimeEvents={ratios:t,eventGroups:e}}_applyStepness(){}_decodeCVTAs(){const t=ArrayBuffer.isView(this._nativeAsset)?this._nativeAsset.buffer:this._nativeAsset;if(!t)return;const e=this._keys;for(let n=0;n<e.length;++n){const i=e[n];i instanceof lg&&(e[n]=i.decompress(t))}for(let e=0;e<this._curves.length;++e){const n=this._curves[e];n.data.values instanceof lg&&(n.data.values=n.data.values.decompress(t))}}},iw.preventDeferredLoadDependents=!0,iw.WrapMode=_c,Xb=Gl((qb=sw).prototype,"sample",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Yb=Gl(qb.prototype,"speed",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Kb=Gl(qb.prototype,"wrapMode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _c.Normal}}),$b=Gl(qb.prototype,"events",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zb=Gl(qb.prototype,"_duration",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jb=Gl(qb.prototype,"_keys",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Qb=Gl(qb.prototype,"_stepness",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tw=Gl(qb.prototype,"_curves",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ew=Gl(qb.prototype,"_commonTargets",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nw=Gl(qb.prototype,"_hash",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wb=qb))||Wb);i.AnimationClip=rw;class ow{constructor(){this._nodeBlendStates=new Map,this._states=new Set}ref(t,e){let n=this._nodeBlendStates.get(t);n||(n={dirty:!1,properties:{}},this._nodeBlendStates.set(t,n));let i=n.properties[e];return i||(i=n.properties[e]=new cw(n,aw(e)?new ln:new vn)),++i.refCount,i}deRef(t,e){const n=this._nodeBlendStates.get(t);if(!n)return;const i=n.properties[e];i&&(--i.refCount,i.refCount>0||(delete n.properties[e],function(t){return!(t.properties.position||t.properties.rotation||t.properties.eulerAngles||t.properties.scale)}(n)&&this._nodeBlendStates.delete(t)))}apply(){this._nodeBlendStates.forEach((t,e)=>{if(!t.dirty)return;t.dirty=!1;const{position:n,scale:i,rotation:s,eulerAngles:r}=t.properties;let o,a,c,l=!1;n&&0!==n.weight&&(n.weight=0,o=n.value,l=!0),i&&0!==i.weight&&(i.weight=0,a=i.value,l=!0),s&&0!==s.weight&&(s.weight=0,c=s.value,l=!0),r&&0!==r.weight&&(r.weight=0,c=r.value,l=!0),l&&e.setRTS(c,o,a)}),this._states.forEach(t=>{t.onBlendFinished()})}bindState(t){this._states.add(t)}unbindState(t){this._states.delete(t)}}function aw(t){return!function(t){return"rotation"===t}(t)}class cw{constructor(t,e){this.weight=0,this.value=void 0,this.refCount=0,this._node=void 0,this._node=t,this.value=e}markAsDirty(){this._node.dirty=!0}}function lw(t,e,n){return 0===n.weight&&ln.zero(n.value),0===e?n.value:1===e?ln.copy(n.value,t):ln.scaleAndAdd(n.value,n.value,t,e)}function hw(t,e,n){if(0===n.weight&&vn.identity(n.value),0===e)return n.value;if(1===e)return vn.copy(n.value,t);const i=e/(n.weight+e);return vn.slerp(n.value,n.value,t,i)}const _w=[],uw=new Map;function dw(t,e){let n=0,i=bn.IDENTITY;for(;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){i=t.world,t.stamp=e;break}t.stamp=e,_w[n++]=t,t=t.parent}for(;n>0;){const e=(t=_w[--n]).node;bn.fromRTS(t.local,e.rotation,e.position,e.scale),i=bn.multiply(t.world,i,t.local)}return i}function pw(t,e){let n,i=null,s=0;for(;t!==e;){const e=t.uuid;if(uw.has(e)){i=uw.get(e);break}i={node:t,local:new bn,world:new bn,stamp:-1,parent:null},uw.set(e,i),_w[s++]=i,t=t.parent,i=null}for(;s>0;)n=_w[--s],n.parent=i,i=n;return i}function mw(t){let e=uw.get(t.uuid)||null;for(;e;)uw.delete(e.node.uuid),e=e.parent}var fw,gw,vw;let yw=t("AnimationManager",Yl((vw=gw=class extends dy{constructor(...t){super(...t),this._anims=new Z([]),this._delayEvents=[],this._blendStateBuffer=new ow,this._crossFades=[],this._sockets=[]}get blendState(){return this._blendStateBuffer}addCrossFade(t){this._crossFades.push(t)}removeCrossFade(t){tt(this._crossFades,t)}update(t){const{_delayEvents:e,_crossFades:n,_sockets:s}=this;for(let e=0,i=n.length;e<i;e++)n[e].update(t);const r=this._anims,o=r.array;for(r.i=0;r.i<o.length;++r.i){const e=o[r.i];e.isMotionless||e.update(t)}this._blendStateBuffer.apply();const a=i.director.getTotalFrames();for(let t=0,e=s.length;t<e;t++){const{target:e,transform:n}=s[t];e.matrix=dw(n,a)}for(let t=0,n=e.length;t<n;t++){const n=e[t];n.fn.apply(n.thisArg,n.args)}e.length=0}destruct(){}addAnimation(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)}removeAnimation(t){const e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):T(3907)}pushDelayEvent(t,e,n){this._delayEvents.push({fn:t,thisArg:e,args:n})}addSockets(t,e){for(let n=0;n<e.length;++n){const i=e[n];if(this._sockets.find(t=>t.target===i.target))continue;const s=t.getChildByPath(i.path),r=i.target&&s&&pw(s,t);r&&this._sockets.push({target:i.target,transform:r})}}removeSockets(t,e){for(let t=0;t<e.length;++t){const n=e[t];for(let t=0;t<this._sockets.length;++t){const e=this._sockets[t];if(e.target===n.target){mw(e.transform.node),this._sockets[t]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}}},gw.ID="animation",fw=vw))||fw);function xw(t,e,n){let i;const s=e[e.length-1];if(0!==e.length&&QA(s)&&!n){const n=ib(t,...e.slice(0,e.length-1));if(null===n)return null;i={isProxy:!1,object:n,property:s}}else{if(!n)return u("Empty animation curve."),null;{const s=ib(t,...e);if(null===s)return null;i={isProxy:!0,proxy:n.forTarget(s)}}}return{setValue:t=>{i.isProxy?i.proxy.set(t):i.object[i.property]=t},getValue:()=>i.isProxy?i.proxy.get?i.proxy.get():(u("Target doesn't provide a get method."),null):i.object[i.property]}}function Sw(t,e,n){const i=xw(t,e,n);if(null===i)return null;const s=i.getValue(),r=Ew(s);if(!r)return u("Value is not copyable!"),null;const o=r.createBuffer(),a=r.copy;return Object.assign(i,{peek:()=>o,pull:()=>{const t=i.getValue();a(o,t)},push:()=>{i.setValue(o)}})}function Tw(t,e){return t.set(e)}rE.on(sE.EVENT_INIT,()=>{const t=new yw;rE.registerSystem(yw.ID,t,yy.PRIORITY_SYSTEM)}),i.AnimationManager=yw;const Ew=(()=>{const t=new Map;return t.set(rn,{createBuffer:()=>new rn,copy:rn.copy}),t.set(ln,{createBuffer:()=>new ln,copy:ln.copy}),t.set(dn,{createBuffer:()=>new dn,copy:dn.copy}),t.set(Ln,{createBuffer:()=>new Ln,copy:Ln.copy}),t.set(On,{createBuffer:()=>new On,copy:Tw}),e=>t.get(null==e?void 0:e.constructor)})();class Cw{constructor(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get isMotionless(){return!this.isPlaying||this.isPaused}play(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(b(3912)):(this._isPlaying=!0,this.onPlay())}stop(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}pause(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}resume(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}step(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}update(t){}onPlay(){}onPause(){}onResume(){}onStop(){}onError(t){}}let Aw;!function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.RESUME="resume",t.LASTFRAME="lastframe",t.FINISHED="finished"}(Aw||(Aw={})),Xt(Aw);class bw{constructor(t,e,n){this.commonTargetIndex=void 0,this._curve=void 0,this._boundTarget=void 0,this._rootTargetProperty=void 0,this._curveDetail=void 0,this._curve=t.curve,this._curveDetail=t,this._boundTarget=n}applySample(t,e,n,i,s){if(this._curve.empty())return;let r;r=this._curve.hasLerp()&&n?this._curve.valueBetween(t,i.from,i.fromRatio,i.to,i.toRatio):this._curve.valueAt(e),this._setValue(r,s)}_setValue(t,e){this._boundTarget.setValue(t)}get propertyName(){return this._rootTargetProperty||""}get curveDetail(){return this._curveDetail}}class ww extends Cw{get clip(){return this._clip}get name(){return this._name}get length(){return this.duration}get wrapMode(){return this._wrapMode}set wrapMode(t){this._wrapMode=t,this.time=0,t&hc.Loop?this.repeatCount=1/0:this.repeatCount=1}get repeatCount(){return this._repeatCount}set repeatCount(t){this._repeatCount=t;const e=this._wrapMode&hc.ShouldWrap,n=(this.wrapMode&hc.Reverse)===hc.Reverse;this._process=t!==1/0||e||n?this.process:this.simpleProcess}get delay(){return this._delay}set delay(t){this._delayTime=this._delay=t}get current(){return this.getWrappedInfo(this.time).time}get ratio(){return this.current/this.duration}constructor(t,e=""){super(),this.duration=1,this.speed=1,this.time=0,this.weight=0,this.frameRate=0,this._targetNode=null,this._curveLoaded=!1,this._clip=void 0,this._process=this.process,this._samplerSharedGroups=[],this._target=null,this._ignoreIndex=-1,this._commonTargetStatuses=[],this._wrapMode=_c.Normal,this._repeatCount=1,this._delay=0,this._delayTime=0,this._currentFramePlayed=!1,this._name=void 0,this._lastIterations=void 0,this._lastWrapInfo=null,this._lastWrapInfoEvent=null,this._wrappedInfo=new uc,this._blendStateBuffer=null,this._blendStateWriters=[],this._allowLastFrame=!1,this._blendStateWriterHost={weight:0,enabled:!1},this._clip=t,this._name=e||t&&t.name}get curveLoaded(){return this._curveLoaded}initialize(t,e){var n,s;if(this._curveLoaded)return;this._curveLoaded=!0,this._destroyBlendStateWriters(),this._samplerSharedGroups.length=0,this._blendStateBuffer=null!==(n=null===(s=i.director.getAnimationManager())||void 0===s?void 0:s.blendState)&&void 0!==n?n:null,this._blendStateBuffer&&this._blendStateBuffer.bindState(this),this._targetNode=t;const r=this._clip;this.duration=r.duration,this.speed=r.speed,this.wrapMode=r.wrapMode,this.frameRate=r.sample,(this.wrapMode&hc.Loop)===hc.Loop?this.repeatCount=1/0:this.repeatCount=1;const o=(t,e,n,i,s)=>{if(!function(t){let e;if(1===t.length&&"string"==typeof t[0])e=t[0];else if(t.length>1){for(let e=0;e<t.length-1;++e)if(!(t[e]instanceof eb))return!1;e=t[t.length-1]}switch(e){case"position":case"scale":case"rotation":case"eulerAngles":return!0;default:return!1}}(n)||!this._blendStateBuffer)return t(e,n,i);{const i=ib(e,...n.slice(0,n.length-1));if(null!==i&&i instanceof sx){const r=n[n.length-1],o=function(t,e,n,i,s){const r=aw(n)?lw:hw;let o=t.ref(e,n),a=!1,c=-1;return{destroy(){o&&(t.deRef(e,n),o=null)},forTarget:()=>({get:()=>e[n],set:t=>{if(!o||!i.enabled)return;const e=i.weight;if(s)if(1!==e||e!==c)a=!1;else if(a)return;r(t,e,o),o.weight+=e,o.markAsDirty(),a=!0,c=e}})}}(this._blendStateBuffer,i,r,this._blendStateWriterHost,s);return this._blendStateWriters.push(o),t(e,[],o)}}return null};this._commonTargetStatuses=r.commonTargets.map(e=>{const n=o(Sw,t,e.modifiers,e.valueAdapter,!1);return null===n?null:{target:n,changed:!1}}),e||(e=r.getPropertyCurves());for(let n=0;n<e.length;++n){const i=e[n];let s,r=this._samplerSharedGroups.find(t=>t.sampler===i.sampler);if(r||(r={sampler:i.sampler,curves:[],samplerResultCache:{from:0,fromRatio:0,to:0,toRatio:0}},this._samplerSharedGroups.push(r)),void 0===i.commonTarget)s=t;else{const t=this._commonTargetStatuses[i.commonTarget];if(!t)continue;s=t.target.peek()}const a=o(xw,s,i.modifiers,i.valueAdapter,i.curve.constant());if(null===a);else{const t=new bw(i,s,a);t.commonTargetIndex=i.commonTarget,r.curves.push(t)}}}destroy(){this._destroyBlendStateWriters()}onBlendFinished(){this._blendStateWriterHost.enabled=!1}emit(...t){i.director.getAnimationManager().pushDelayEvent(this._emit,this,t)}on(t,e,n){return this._target&&this._target.isValid?this._target.on(t,e,n):null}once(t,e,n){return this._target&&this._target.isValid?this._target.once(t,e,n):null}off(t,e,n){this._target&&this._target.isValid&&this._target.off(t,e,n)}allowLastFrameEvent(t){this._allowLastFrame=t}_setEventTarget(t){this._target=t}setTime(t){this._currentFramePlayed=!1,this.time=t||0;{this._lastWrapInfoEvent=null,this._ignoreIndex=-1;const e=this.getWrappedInfo(t,this._wrappedInfo),n=e.direction;let i=this._clip.getEventGroupIndexAtRatio(e.ratio);i<0&&(i=~i-1,n<0&&(i+=1),this._ignoreIndex=i)}}update(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this.speed:this._currentFramePlayed=!0,this._process())}sample(){const t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.ratio),this._sampleEvents(t),t}onPlay(){this.setTime(0),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(Aw.PLAY,this)}onStop(){this.isPaused||this._onPauseOrStop(),this.emit(Aw.STOP,this)}onResume(){this._onReplayOrResume(),this.emit(Aw.RESUME,this)}onPause(){this._onPauseOrStop(),this.emit(Aw.PAUSE,this)}_sampleCurves(t){this._blendStateWriterHost.weight=this.weight,this._blendStateWriterHost.enabled=!0;for(let t=0;t<this._commonTargetStatuses.length;++t){const e=this._commonTargetStatuses[t];e&&(e.target.pull(),e.changed=!1)}for(let e=0,n=this._samplerSharedGroups.length;e<n;++e){const n=this._samplerSharedGroups[e],i=n.sampler,{samplerResultCache:s}=n;let r=0,o=!1;i?(r=i.sample(t),r<0&&(r=~r,r<=0?r=0:r>=i.ratios.length?r=i.ratios.length-1:(o=!0,s.from=r-1,s.fromRatio=i.ratios[s.from],s.to=r,s.toRatio=i.ratios[s.to],r=s.from))):r=0;for(let e=0,i=n.curves.length;e<i;++e){const i=n.curves[e];if(i.applySample(t,r,o,s,this.weight),void 0!==i.commonTargetIndex){const t=this._commonTargetStatuses[i.commonTargetIndex];t&&(t.changed=!0)}}}for(let t=0;t<this._commonTargetStatuses.length;++t){const e=this._commonTargetStatuses[t];e&&e.changed&&e.target.push()}}process(){const t=this.sample();if(this._allowLastFrame){let e;e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new uc(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(Aw.LASTFRAME,this),e.set(t)}t.stopped&&(this.stop(),this.emit(Aw.FINISHED,this))}simpleProcess(){const t=this.duration;let e=this.time%t;e<0&&(e+=t);const n=e/t;this._sampleCurves(n),this._clip.hasEvents()&&this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(void 0===this._lastIterations&&(this._lastIterations=n),(this.time>0&&this._lastIterations>n||this.time<0&&this._lastIterations<n)&&this.emit(Aw.LASTFRAME,this),this._lastIterations=n)}cache(t){}_needReverse(t){const e=this.wrapMode;let n=!1;return(e&hc.PingPong)===hc.PingPong&&(t-(0|t)==0&&t>0&&(t-=1),1&t&&(n=!n)),(e&hc.Reverse)===hc.Reverse&&(n=!n),n}getWrappedInfo(t,e){e=e||new uc;let n=!1;const i=this.duration,s=this.repeatCount;let r=t>0?t/i:-t/i;if(r>=s){r=s,n=!0;let e=s-(0|s);0===e&&(e=1),t=e*i*(t>0?1:-1)}if(t>i){const e=t%i;t=0===e?i:e}else t<0&&0!=(t%=i)&&(t+=i);let o=!1;const a=this._wrapMode&hc.ShouldWrap;a&&(o=this._needReverse(r));let c=o?-1:1;return this.speed<0&&(c*=-1),a&&o&&(t=i-t),e.ratio=t/i,e.time=t,e.direction=c,e.stopped=n,e.iterations=r,e}_sampleEvents(t){const e=this._clip.eventGroups.length;let n=t.direction,s=this._clip.getEventGroupIndexAtRatio(t.ratio);if(s<0&&(s=~s-1,n<0&&(s+=1)),this._ignoreIndex!==s&&(this._ignoreIndex=-1),t.frameIndex=s,!this._lastWrapInfoEvent)return this._fireEvent(s),void(this._lastWrapInfoEvent=new uc(t));const r=this.wrapMode,o=Rw(t.iterations),a=this._lastWrapInfoEvent;let c=Rw(a.iterations),l=a.frameIndex;const h=a.direction,_=-1!==c&&o!==c;if(l===s&&_&&1===e)this._fireEvent(0);else if(l!==s||_){n=h;do{if(l!==s){if(-1===n&&0===l&&s>0?((r&hc.PingPong)===hc.PingPong?n*=-1:l=e,c++):1===n&&l===e-1&&s<e-1&&((r&hc.PingPong)===hc.PingPong?n*=-1:l=-1,c++),l===s)break;if(c>o)break}l+=n,i.director.getAnimationManager().pushDelayEvent(this._fireEvent,this,[l])}while(l!==s&&l>-1&&l<e)}this._lastWrapInfoEvent.set(t)}_emit(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)}_fireEvent(t){if(!this._targetNode||!this._targetNode.isValid)return;const{eventGroups:e}=this._clip;if(t<0||t>=e.length||this._ignoreIndex===t)return;const n=e[t],i=this._targetNode.components;for(const t of n.events){const{functionName:e}=t;for(const n of i){const i=n[e];"function"==typeof i&&i.apply(n,t.parameters)}}}_onReplayOrResume(){i.director.getAnimationManager().addAnimation(this)}_onPauseOrStop(){i.director.getAnimationManager().removeAnimation(this)}_destroyBlendStateWriters(){for(let t=0;t<this._blendStateWriters.length;++t)this._blendStateWriters[t].destroy();this._blendStateWriters.length=0,this._blendStateBuffer&&(this._blendStateBuffer.unbindState(this),this._blendStateBuffer=null),this._blendStateWriterHost.enabled=!1}}function Rw(t){return t-(0|t)==0&&(t-=1),0|t}t("AnimationState",ww),i.AnimationState=ww;class Iw extends Cw{constructor(){super(),this._managedStates=[],this._fadings=[]}update(t){if(this.isMotionless)return;for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&(e.weight=0)}let e=1,n=this._fadings.length;for(let i=0;i<this._fadings.length;++i){const s=this._fadings[i];s.easeTime+=t;const r=0===s.easeDuration?1:Ve(s.easeTime/s.easeDuration),o=r*e;if(e*=1-r,s.target.state&&(s.target.state.weight+=o),s.easeTime>=s.easeDuration){n=i+1,s.easeTime=s.easeDuration;break}}if(n!==this._fadings.length){for(let t=n;t<this._fadings.length;++t){const e=this._fadings[t];--e.target.reference,e.target.reference<=0&&(e.target.state&&e.target.state.stop(),tt(this._managedStates,e.target))}this._fadings.splice(n)}for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.isMotionless&&e.sample()}}crossFade(t,e){var n;0===this._managedStates.length&&(e=0),0===e&&this.clear();let i=this._managedStates.find(e=>e.state===t);i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:t,reference:0},t&&t.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:i})}clear(){for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0}onPlay(){super.onPlay(),i.director.getAnimationManager().addCrossFade(this)}onPause(){super.onPause(),i.director.getAnimationManager().removeCrossFade(this);for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.pause()}}onResume(){super.onResume(),i.director.getAnimationManager().addCrossFade(this);for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.resume()}}onStop(){super.onStop(),i.director.getAnimationManager().removeCrossFade(this),this.clear()}}var Pw,Ow,Dw,Mw,Nw,Lw,zw,Bw,Fw,Uw,Gw,Hw,Vw,kw,jw,Ww,qw;let Xw=t("Animation",(Pw=Yl("cc.Animation"),Ow=ah(),Dw=$l(99),Mw=ih(),Nw=Ah([rw]),Lw=_h(),zw=Ah(rw),Bw=_h(),Fw=_h(),Uw=Ah([rw]),Pw(Gw=Ow(Gw=Dw(Gw=nh(Gw=Mw((qw=Ww=class extends(u_(Nu)){constructor(...t){super(...t),Ul(this,"playOnLoad",Vw,this),this._crossFade=new Iw,this._nameToState=dt(!0),Ul(this,"_clips",kw,this),Ul(this,"_defaultClip",jw,this),this._hasBeenPlayed=!1}get clips(){return this._clips}set clips(t){this._crossFade&&this._crossFade.clear();for(const t of this._clips)t&&this._removeStateOfAutomaticClip(t);for(const e of t)e&&this.createState(e);const e=t.find(t=>Yw(t,this._defaultClip));this._defaultClip=e||null,this._clips=t}get defaultClip(){return this._defaultClip}set defaultClip(t){this._defaultClip=t,t&&(this._clips.findIndex(e=>Yw(e,t))>=0||(this._clips.push(t),this.createState(t)))}onLoad(){this.clips=this._clips;for(const t in this._nameToState)this._nameToState[t].initialize(this.node)}start(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}onEnable(){this._crossFade.resume()}onDisable(){this._crossFade.pause()}onDestroy(){this._crossFade.stop();for(const t in this._nameToState)this._nameToState[t].destroy();this._nameToState=dt(!0)}play(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)}crossFade(t,e=.3){this._hasBeenPlayed=!0;const n=this._nameToState[t];n&&(this._crossFade.play(),this._crossFade.crossFade(n,e))}pause(){this._crossFade.pause()}resume(){this._crossFade.resume()}stop(){this._crossFade.stop()}getAnimationState(t){return this.getState(t)}getState(t){const e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null}createState(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)}removeState(t){const e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])}addClip(t,e){return et(this._clips,t)||this._clips.push(t),this.createState(t,e)}removeClip(t,e){let n;for(const e in this._nameToState){const i=this._nameToState[e];if(i.clip===t){n=i;break}}if(t===this._defaultClip){if(!e)return void x(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!e)return void x(3903);n.stop()}this._clips=this._clips.filter(e=>e!==t),n&&delete this._nameToState[n.name]}on(t,e,n,i){const s=super.on(t,e,n,i);return t===Aw.LASTFRAME&&this._syncAllowLastFrameEvent(),s}once(t,e,n){const i=super.once(t,e,n);return t===Aw.LASTFRAME&&this._syncAllowLastFrameEvent(),i}off(t,e,n){super.off(t,e,n),t===Aw.LASTFRAME&&this._syncDisallowLastFrameEvent()}_createState(t,e){return new ww(t,e)}_doCreateState(t,e){const n=this._createState(t,e);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(Aw.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n}_getStateByNameOrDefaultClip(t){if(!t){if(!this._defaultClip)return null;t=this._defaultClip.name}return this._nameToState[t]||null}_removeStateOfAutomaticClip(t){for(const e in this._nameToState){const n=this._nameToState[e];Yw(t,n.clip)&&(n.stop(),delete this._nameToState[e])}}_syncAllowLastFrameEvent(){if(this.hasEventListener(Aw.LASTFRAME))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)}_syncDisallowLastFrameEvent(){if(!this.hasEventListener(Aw.LASTFRAME))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)}},Ww.EventType=Aw,Gl((Hw=qw).prototype,"clips",[Nw,Lw],Object.getOwnPropertyDescriptor(Hw.prototype,"clips"),Hw.prototype),Gl(Hw.prototype,"defaultClip",[zw,Bw],Object.getOwnPropertyDescriptor(Hw.prototype,"defaultClip"),Hw.prototype),Vw=Gl(Hw.prototype,"playOnLoad",[Ql,Fw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),kw=Gl(Hw.prototype,"_clips",[Uw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jw=Gl(Hw.prototype,"_defaultClip",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gw=Hw))||Gw)||Gw)||Gw)||Gw)||Gw));function Yw(t,e){return t===e||!(!t||!e||t.name!==e.name&&t._uuid!==e._uuid)}const Kw=new bn;function $w(t,e,n){for(bn.identity(n);t!==e;)bn.fromRTS(Kw,t.rotation,t.position,t.scale),bn.multiply(n,Kw,n),t=t.parent;return n}var Zw,Jw,Qw,tR;i.easing=Pm;let eR=t("HierachyModifier",Yl("cc.HierachyModifier")(Zw=class extends eb{})||Zw);i.HierachyModifier=eR;let nR=t("ComponentModifier",Yl("cc.ComponentModifier")(Jw=class extends nb{})||Jw);i.ComponentModifier=nR;let iR=t("CurveValueAdapter",Yl("cc.CurveValueAdapter")(Qw=class{forTarget(t){return{set:()=>{}}}})||Qw);i.CurveValueAdapter=iR;let sR,rR=t("UniformCurveValueAdapter",Yl("cc.UniformCurveValueAdapter")(tR=class extends lb{})||tR);function oR(t){return"string"==typeof t}function aR(t){return"number"==typeof t}function cR(t,e){return t instanceof e}i.UniformCurveValueAdapter=rR,i.isPropertyModifier=oR,i.isElementModifier=aR,i.isCustomTargetModifier=cR,i.math=Bn,i.geometry=gc;class lR{constructor(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}size(){return this._pool.length}clear(){const t=this._pool.length;for(let e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0}put(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();const e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}}get(...t){const e=this._pool.length-1;if(e<0)return null;{const t=this._pool[e];this._pool.length=e;const n=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;return n&&n.reuse&&n.reuse(arguments),t}}}t("NodePool",lR),i.NodePool=lR,i.renderer=Zp;class hR extends Ro{constructor(...t){super(...t),this._gpuDescriptorSet=null}get gpuDescriptorSet(){return this._gpuDescriptorSet}initialize(t){this._layout=t.layout;const{bindings:e,descriptorIndices:n,descriptorCount:i}=t.layout.gpuDescriptorSetLayout;this._buffers=Array(i).fill(null),this._textures=Array(i).fill(null),this._samplers=Array(i).fill(null);const s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:n};for(let t=0;t<e.length;++t){const n=e[t];for(let t=0;t<n.count;t++)s.push({type:n.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}return!0}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const t=this._gpuDescriptorSet.gpuDescriptors;for(let e=0;e<t.length;++e)if(t[e].type&Ao){const n=this._buffers[e];n&&(t[e].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else t[e].type&bo&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}}}function _R(t,e){switch(t){case Xs.R8:return e.UNSIGNED_BYTE;case Xs.R8SN:return e.BYTE;case Xs.R8UI:return e.UNSIGNED_BYTE;case Xs.R8I:return e.BYTE;case Xs.R16F:return sR.HALF_FLOAT_OES;case Xs.R16UI:return e.UNSIGNED_SHORT;case Xs.R16I:return e.SHORT;case Xs.R32F:return e.FLOAT;case Xs.R32UI:return e.UNSIGNED_INT;case Xs.R32I:return e.INT;case Xs.RG8:return e.UNSIGNED_BYTE;case Xs.RG8SN:return e.BYTE;case Xs.RG8UI:return e.UNSIGNED_BYTE;case Xs.RG8I:return e.BYTE;case Xs.RG16F:return sR.HALF_FLOAT_OES;case Xs.RG16UI:return e.UNSIGNED_SHORT;case Xs.RG16I:return e.SHORT;case Xs.RG32F:return e.FLOAT;case Xs.RG32UI:return e.UNSIGNED_INT;case Xs.RG32I:return e.INT;case Xs.RGB8:case Xs.SRGB8:return e.UNSIGNED_BYTE;case Xs.RGB8SN:return e.BYTE;case Xs.RGB8UI:return e.UNSIGNED_BYTE;case Xs.RGB8I:return e.BYTE;case Xs.RGB16F:return sR.HALF_FLOAT_OES;case Xs.RGB16UI:return e.UNSIGNED_SHORT;case Xs.RGB16I:return e.SHORT;case Xs.RGB32F:return e.FLOAT;case Xs.RGB32UI:return e.UNSIGNED_INT;case Xs.RGB32I:return e.INT;case Xs.BGRA8:case Xs.RGBA8:case Xs.SRGB8_A8:return e.UNSIGNED_BYTE;case Xs.RGBA8SN:return e.BYTE;case Xs.RGBA8UI:return e.UNSIGNED_BYTE;case Xs.RGBA8I:return e.BYTE;case Xs.RGBA16F:return sR.HALF_FLOAT_OES;case Xs.RGBA16UI:return e.UNSIGNED_SHORT;case Xs.RGBA16I:return e.SHORT;case Xs.RGBA32F:return e.FLOAT;case Xs.RGBA32UI:return e.UNSIGNED_INT;case Xs.RGBA32I:return e.INT;case Xs.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case Xs.R11G11B10F:return e.FLOAT;case Xs.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case Xs.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case Xs.RGB10A2:return e.UNSIGNED_BYTE;case Xs.RGB10A2UI:return e.UNSIGNED_INT;case Xs.RGB9E5:return e.UNSIGNED_BYTE;case Xs.D16:return e.UNSIGNED_SHORT;case Xs.D16S8:return sR.UNSIGNED_INT_24_8_WEBGL;case Xs.D24:return e.UNSIGNED_INT;case Xs.D24S8:return sR.UNSIGNED_INT_24_8_WEBGL;case Xs.D32F:return e.UNSIGNED_INT;case Xs.D32F_S8:return sR.UNSIGNED_INT_24_8_WEBGL;case Xs.BC1:case Xs.BC1_SRGB:case Xs.BC2:case Xs.BC2_SRGB:case Xs.BC3:case Xs.BC3_SRGB:case Xs.BC4:return e.UNSIGNED_BYTE;case Xs.BC4_SNORM:return e.BYTE;case Xs.BC5:return e.UNSIGNED_BYTE;case Xs.BC5_SNORM:return e.BYTE;case Xs.BC6H_SF16:case Xs.BC6H_UF16:return e.FLOAT;case Xs.BC7:case Xs.BC7_SRGB:case Xs.ETC_RGB8:case Xs.ETC2_RGB8:case Xs.ETC2_SRGB8:case Xs.ETC2_RGB8_A1:case Xs.ETC2_SRGB8_A1:case Xs.EAC_R11:return e.UNSIGNED_BYTE;case Xs.EAC_R11SN:return e.BYTE;case Xs.EAC_RG11:return e.UNSIGNED_BYTE;case Xs.EAC_RG11SN:return e.BYTE;case Xs.PVRTC_RGB2:case Xs.PVRTC_RGBA2:case Xs.PVRTC_RGB4:case Xs.PVRTC_RGBA4:case Xs.PVRTC2_2BPP:case Xs.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case Xs.ASTC_RGBA_4x4:case Xs.ASTC_RGBA_5x4:case Xs.ASTC_RGBA_5x5:case Xs.ASTC_RGBA_6x5:case Xs.ASTC_RGBA_6x6:case Xs.ASTC_RGBA_8x5:case Xs.ASTC_RGBA_8x6:case Xs.ASTC_RGBA_8x8:case Xs.ASTC_RGBA_10x5:case Xs.ASTC_RGBA_10x6:case Xs.ASTC_RGBA_10x8:case Xs.ASTC_RGBA_10x10:case Xs.ASTC_RGBA_12x10:case Xs.ASTC_RGBA_12x12:case Xs.ASTC_SRGBA_4x4:case Xs.ASTC_SRGBA_5x4:case Xs.ASTC_SRGBA_5x5:case Xs.ASTC_SRGBA_6x5:case Xs.ASTC_SRGBA_6x6:case Xs.ASTC_SRGBA_8x5:case Xs.ASTC_SRGBA_8x6:case Xs.ASTC_SRGBA_8x8:case Xs.ASTC_SRGBA_10x5:case Xs.ASTC_SRGBA_10x6:case Xs.ASTC_SRGBA_10x8:case Xs.ASTC_SRGBA_10x10:case Xs.ASTC_SRGBA_12x10:case Xs.ASTC_SRGBA_12x12:default:return e.UNSIGNED_BYTE}}function uR(t,e){switch(t){case Xs.A8:return e.ALPHA;case Xs.L8:return e.LUMINANCE;case Xs.LA8:return e.LUMINANCE_ALPHA;case Xs.RGB8:case Xs.RGB16F:case Xs.RGB32F:return e.RGB;case Xs.BGRA8:case Xs.RGBA8:case Xs.RGBA16F:case Xs.RGBA32F:return e.RGBA;case Xs.R5G6B5:return e.RGB565;case Xs.RGB5A1:return e.RGB5_A1;case Xs.RGBA4:return e.RGBA4;case Xs.D16:return e.DEPTH_COMPONENT;case Xs.D16S8:return e.DEPTH_STENCIL;case Xs.D24:return e.DEPTH_COMPONENT;case Xs.D24S8:return e.DEPTH_STENCIL;case Xs.D32F:return e.DEPTH_COMPONENT;case Xs.D32F_S8:return e.DEPTH_STENCIL;case Xs.BC1:return sR.COMPRESSED_RGB_S3TC_DXT1_EXT;case Xs.BC1_ALPHA:return sR.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Xs.BC1_SRGB:return sR.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Xs.BC1_SRGB_ALPHA:return sR.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Xs.BC2:return sR.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Xs.BC2_SRGB:return sR.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Xs.BC3:return sR.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Xs.BC3_SRGB:return sR.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Xs.ETC_RGB8:return sR.COMPRESSED_RGB_ETC1_WEBGL;case Xs.ETC2_RGB8:return sR.COMPRESSED_RGB8_ETC2;case Xs.ETC2_SRGB8:return sR.COMPRESSED_SRGB8_ETC2;case Xs.ETC2_RGB8_A1:return sR.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Xs.ETC2_SRGB8_A1:return sR.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Xs.ETC2_RGBA8:return sR.COMPRESSED_RGBA8_ETC2_EAC;case Xs.ETC2_SRGB8_A8:return sR.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Xs.EAC_R11:return sR.COMPRESSED_R11_EAC;case Xs.EAC_R11SN:return sR.COMPRESSED_SIGNED_R11_EAC;case Xs.EAC_RG11:return sR.COMPRESSED_RG11_EAC;case Xs.EAC_RG11SN:return sR.COMPRESSED_SIGNED_RG11_EAC;case Xs.PVRTC_RGB2:return sR.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Xs.PVRTC_RGBA2:return sR.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Xs.PVRTC_RGB4:return sR.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Xs.PVRTC_RGBA4:return sR.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Xs.ASTC_RGBA_4x4:return sR.COMPRESSED_RGBA_ASTC_4x4_KHR;case Xs.ASTC_RGBA_5x4:return sR.COMPRESSED_RGBA_ASTC_5x4_KHR;case Xs.ASTC_RGBA_5x5:return sR.COMPRESSED_RGBA_ASTC_5x5_KHR;case Xs.ASTC_RGBA_6x5:return sR.COMPRESSED_RGBA_ASTC_6x5_KHR;case Xs.ASTC_RGBA_6x6:return sR.COMPRESSED_RGBA_ASTC_6x6_KHR;case Xs.ASTC_RGBA_8x5:return sR.COMPRESSED_RGBA_ASTC_8x5_KHR;case Xs.ASTC_RGBA_8x6:return sR.COMPRESSED_RGBA_ASTC_8x6_KHR;case Xs.ASTC_RGBA_8x8:return sR.COMPRESSED_RGBA_ASTC_8x8_KHR;case Xs.ASTC_RGBA_10x5:return sR.COMPRESSED_RGBA_ASTC_10x5_KHR;case Xs.ASTC_RGBA_10x6:return sR.COMPRESSED_RGBA_ASTC_10x6_KHR;case Xs.ASTC_RGBA_10x8:return sR.COMPRESSED_RGBA_ASTC_10x8_KHR;case Xs.ASTC_RGBA_10x10:return sR.COMPRESSED_RGBA_ASTC_10x10_KHR;case Xs.ASTC_RGBA_12x10:return sR.COMPRESSED_RGBA_ASTC_12x10_KHR;case Xs.ASTC_RGBA_12x12:return sR.COMPRESSED_RGBA_ASTC_12x12_KHR;case Xs.ASTC_SRGBA_4x4:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Xs.ASTC_SRGBA_5x4:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Xs.ASTC_SRGBA_5x5:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Xs.ASTC_SRGBA_6x5:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Xs.ASTC_SRGBA_6x6:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Xs.ASTC_SRGBA_8x5:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Xs.ASTC_SRGBA_8x6:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Xs.ASTC_SRGBA_8x8:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Xs.ASTC_SRGBA_10x5:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Xs.ASTC_SRGBA_10x6:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Xs.ASTC_SRGBA_10x8:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Xs.ASTC_SRGBA_10x10:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Xs.ASTC_SRGBA_12x10:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Xs.ASTC_SRGBA_12x12:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}function dR(t,e){switch(t){case Xs.A8:return e.ALPHA;case Xs.L8:return e.LUMINANCE;case Xs.LA8:return e.LUMINANCE_ALPHA;case Xs.RGB8:case Xs.RGB16F:case Xs.RGB32F:return e.RGB;case Xs.BGRA8:case Xs.RGBA8:case Xs.RGBA16F:case Xs.RGBA32F:return e.RGBA;case Xs.R5G6B5:return e.RGB;case Xs.RGB5A1:case Xs.RGBA4:return e.RGBA;case Xs.D16:return e.DEPTH_COMPONENT;case Xs.D16S8:return e.DEPTH_STENCIL;case Xs.D24:return e.DEPTH_COMPONENT;case Xs.D24S8:return e.DEPTH_STENCIL;case Xs.D32F:return e.DEPTH_COMPONENT;case Xs.D32F_S8:return e.DEPTH_STENCIL;case Xs.BC1:return sR.COMPRESSED_RGB_S3TC_DXT1_EXT;case Xs.BC1_ALPHA:return sR.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Xs.BC1_SRGB:return sR.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Xs.BC1_SRGB_ALPHA:return sR.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Xs.BC2:return sR.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Xs.BC2_SRGB:return sR.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Xs.BC3:return sR.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Xs.BC3_SRGB:return sR.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Xs.ETC_RGB8:return sR.COMPRESSED_RGB_ETC1_WEBGL;case Xs.ETC2_RGB8:return sR.COMPRESSED_RGB8_ETC2;case Xs.ETC2_SRGB8:return sR.COMPRESSED_SRGB8_ETC2;case Xs.ETC2_RGB8_A1:return sR.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Xs.ETC2_SRGB8_A1:return sR.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Xs.ETC2_RGBA8:return sR.COMPRESSED_RGBA8_ETC2_EAC;case Xs.ETC2_SRGB8_A8:return sR.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Xs.EAC_R11:return sR.COMPRESSED_R11_EAC;case Xs.EAC_R11SN:return sR.COMPRESSED_SIGNED_R11_EAC;case Xs.EAC_RG11:return sR.COMPRESSED_RG11_EAC;case Xs.EAC_RG11SN:return sR.COMPRESSED_SIGNED_RG11_EAC;case Xs.PVRTC_RGB2:return sR.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Xs.PVRTC_RGBA2:return sR.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Xs.PVRTC_RGB4:return sR.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Xs.PVRTC_RGBA4:return sR.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Xs.ASTC_RGBA_4x4:return sR.COMPRESSED_RGBA_ASTC_4x4_KHR;case Xs.ASTC_RGBA_5x4:return sR.COMPRESSED_RGBA_ASTC_5x4_KHR;case Xs.ASTC_RGBA_5x5:return sR.COMPRESSED_RGBA_ASTC_5x5_KHR;case Xs.ASTC_RGBA_6x5:return sR.COMPRESSED_RGBA_ASTC_6x5_KHR;case Xs.ASTC_RGBA_6x6:return sR.COMPRESSED_RGBA_ASTC_6x6_KHR;case Xs.ASTC_RGBA_8x5:return sR.COMPRESSED_RGBA_ASTC_8x5_KHR;case Xs.ASTC_RGBA_8x6:return sR.COMPRESSED_RGBA_ASTC_8x6_KHR;case Xs.ASTC_RGBA_8x8:return sR.COMPRESSED_RGBA_ASTC_8x8_KHR;case Xs.ASTC_RGBA_10x5:return sR.COMPRESSED_RGBA_ASTC_10x5_KHR;case Xs.ASTC_RGBA_10x6:return sR.COMPRESSED_RGBA_ASTC_10x6_KHR;case Xs.ASTC_RGBA_10x8:return sR.COMPRESSED_RGBA_ASTC_10x8_KHR;case Xs.ASTC_RGBA_10x10:return sR.COMPRESSED_RGBA_ASTC_10x10_KHR;case Xs.ASTC_RGBA_12x10:return sR.COMPRESSED_RGBA_ASTC_12x10_KHR;case Xs.ASTC_RGBA_12x12:return sR.COMPRESSED_RGBA_ASTC_12x12_KHR;case Xs.ASTC_SRGBA_4x4:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Xs.ASTC_SRGBA_5x4:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Xs.ASTC_SRGBA_5x5:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Xs.ASTC_SRGBA_6x5:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Xs.ASTC_SRGBA_6x6:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Xs.ASTC_SRGBA_8x5:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Xs.ASTC_SRGBA_8x6:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Xs.ASTC_SRGBA_8x8:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Xs.ASTC_SRGBA_10x5:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Xs.ASTC_SRGBA_10x6:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Xs.ASTC_SRGBA_10x8:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Xs.ASTC_SRGBA_10x10:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Xs.ASTC_SRGBA_12x10:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Xs.ASTC_SRGBA_12x12:return sR.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}function pR(t,e){switch(t){case qs.BOOL:return e.BOOL;case qs.BOOL2:return e.BOOL_VEC2;case qs.BOOL3:return e.BOOL_VEC3;case qs.BOOL4:return e.BOOL_VEC4;case qs.INT:return e.INT;case qs.INT2:return e.INT_VEC2;case qs.INT3:return e.INT_VEC3;case qs.INT4:return e.INT_VEC4;case qs.UINT:return e.UNSIGNED_INT;case qs.FLOAT:return e.FLOAT;case qs.FLOAT2:return e.FLOAT_VEC2;case qs.FLOAT3:return e.FLOAT_VEC3;case qs.FLOAT4:return e.FLOAT_VEC4;case qs.MAT2:return e.FLOAT_MAT2;case qs.MAT3:return e.FLOAT_MAT3;case qs.MAT4:return e.FLOAT_MAT4;case qs.SAMPLER2D:return e.SAMPLER_2D;case qs.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),qs.UNKNOWN}}function mR(t){switch(t){case qs.BOOL:case qs.BOOL2:case qs.BOOL3:case qs.BOOL4:case qs.INT:case qs.INT2:case qs.INT3:case qs.INT4:case qs.UINT:return Int32Array;case qs.FLOAT:case qs.FLOAT2:case qs.FLOAT3:case qs.FLOAT4:case qs.MAT2:case qs.MAT3:case qs.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function fR(t,e){switch(t){case e.BOOL:return qs.BOOL;case e.BOOL_VEC2:return qs.BOOL2;case e.BOOL_VEC3:return qs.BOOL3;case e.BOOL_VEC4:return qs.BOOL4;case e.INT:return qs.INT;case e.INT_VEC2:return qs.INT2;case e.INT_VEC3:return qs.INT3;case e.INT_VEC4:return qs.INT4;case e.UNSIGNED_INT:return qs.UINT;case e.FLOAT:return qs.FLOAT;case e.FLOAT_VEC2:return qs.FLOAT2;case e.FLOAT_VEC3:return qs.FLOAT3;case e.FLOAT_VEC4:return qs.FLOAT4;case e.FLOAT_MAT2:return qs.MAT2;case e.FLOAT_MAT3:return qs.MAT3;case e.FLOAT_MAT4:return qs.MAT4;case e.SAMPLER_2D:return qs.SAMPLER2D;case e.SAMPLER_CUBE:return qs.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),qs.UNKNOWN}}function gR(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function vR(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(sR||(sR={}));const yR=[512,513,514,515,516,517,518,519],xR=[0,7680,7681,7682,7683,5386,34055,34056],SR=[32774,32778,32779,32775,32776],TR=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];let ER;!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(ER||(ER={}));class CR{constructor(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t}}class AR extends CR{constructor(){super(ER.BEGIN_RENDER_PASS),this.gpuRenderPass=null,this.gpuFramebuffer=null,this.renderArea=new Ur,this.clearFlag=Cr.NONE,this.clearColors=[],this.clearDepth=1,this.clearStencil=0}clear(){this.gpuFramebuffer=null,this.clearColors.length=0}}class bR extends CR{constructor(){super(ER.BIND_STATES),this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets=[],this.dynamicOffsets=[],this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants=[],this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}clear(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0,this.viewport=null,this.scissor=null,this.lineWidth=null,this.depthBias=null,this.blendConstants.length=0,this.depthBounds=null,this.stencilWriteMask=null,this.stencilCompareMask=null}}class wR extends CR{constructor(){super(ER.DRAW),this.drawInfo=new ho}clear(){}}class RR extends CR{constructor(){super(ER.UPDATE_BUFFER),this.gpuBuffer=null,this.buffer=null,this.offset=0,this.size=0}clear(){this.gpuBuffer=null,this.buffer=null}}class IR extends CR{constructor(){super(ER.COPY_BUFFER_TO_TEXTURE),this.gpuTexture=null,this.buffers=[],this.regions=[]}clear(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}class PR{constructor(){this.cmds=new t_(1),this.beginRenderPassCmds=new t_(1),this.bindStatesCmds=new t_(1),this.drawCmds=new t_(1),this.updateBufferCmds=new t_(1),this.copyBufferToTextureCmds=new t_(1)}clearCmds(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}function OR(t,e,n,i,s){if(e.usage&Ys.UNIFORM)ArrayBuffer.isView(n)?e.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&Ys.INDIRECT)e.indirects.length=i,Array.prototype.push.apply(e.indirects,n.drawInfos);else{const r=n,{gl:o}=t,a=t.stateCache;switch(e.glTarget){case o.ARRAY_BUFFER:t.useVAO&&a.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=DR.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case o.ELEMENT_ARRAY_BUFFER:t.useVAO&&a.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=DR.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}s===r.byteLength?o.bufferSubData(e.glTarget,i,r):o.bufferSubData(e.glTarget,i,r.slice(0,s))}}const DR={gpuPipelineState:null,gpuInputAssembler:null,reverseCW:!1,glPrimitive:0};function MR(t,e,n,i,s,r,o){const{gl:a}=t,c=t.stateCache;let l=0;if(n&&e){if(c.glFramebuffer!==n.glFramebuffer){a.bindFramebuffer(a.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer;const e=!!n.glFramebuffer;if(e!==DR.reverseCW){DR.reverseCW=e;const n=!t.stateCache.rs.isFrontFaceCCW;a.frontFace(n?a.CCW:a.CW),t.stateCache.rs.isFrontFaceCCW=n}}c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(a.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(a.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);let h=s.length;t.WEBGL_draw_buffers||(h=1);for(let t=0;t<h;++t){const n=e.colorAttachments[t];if(n.format!==Xs.UNKNOWN)switch(n.loadOp){case gr.LOAD:break;case gr.CLEAR:{c.bs.targets[0].blendColorMask!==ar.ALL&&a.colorMask(!0,!0,!0,!0);const t=s[0];a.clearColor(t.x,t.y,t.z,t.w),l|=a.COLOR_BUFFER_BIT;break}case gr.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==Xs.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case gr.LOAD:break;case gr.CLEAR:c.dss.depthWrite||a.depthMask(!0),a.clearDepth(r),l|=a.DEPTH_BUFFER_BIT;break;case gr.DISCARD:}if(Dr[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case gr.LOAD:break;case gr.CLEAR:c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,65535),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,65535),a.clearStencil(o),l|=a.STENCIL_BUFFER_BIT;break;case gr.DISCARD:}}if(l&&a.clear(l),l&a.COLOR_BUFFER_BIT){const t=c.bs.targets[0].blendColorMask;if(t!==ar.ALL){const e=(t&ar.R)!==ar.NONE,n=(t&ar.G)!==ar.NONE,i=(t&ar.B)!==ar.NONE,s=(t&ar.A)!==ar.NONE;a.colorMask(e,n,i,s)}}l&a.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&a.depthMask(!1),l&a.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,0),c.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,0))}}function NR(t,e,n,i,s,r,o,a,c,l,h,_,d){const{gl:p}=t,m=t.stateCache,f=e&&e.gpuShader;let g,v,y,x=!1;if(e&&DR.gpuPipelineState!==e){if(DR.gpuPipelineState=e,DR.glPrimitive=e.glPrimitive,e.gpuShader){const{glProgram:t}=e.gpuShader;m.glProgram!==t&&(p.useProgram(t),m.glProgram=t,x=!0)}const{rs:t}=e;if(t){if(m.rs.cullMode!==t.cullMode){switch(t.cullMode){case er.NONE:p.disable(p.CULL_FACE);break;case er.FRONT:p.enable(p.CULL_FACE),p.cullFace(p.FRONT);break;case er.BACK:p.enable(p.CULL_FACE),p.cullFace(p.BACK)}m.rs.cullMode=t.cullMode}const e=DR.reverseCW?!t.isFrontFaceCCW:t.isFrontFaceCCW;m.rs.isFrontFaceCCW!==e&&(p.frontFace(e?p.CCW:p.CW),m.rs.isFrontFaceCCW=e),m.rs.depthBias===t.depthBias&&m.rs.depthBiasSlop===t.depthBiasSlop||(p.polygonOffset(t.depthBias,t.depthBiasSlop),m.rs.depthBias=t.depthBias,m.rs.depthBiasSlop=t.depthBiasSlop),m.rs.lineWidth!==t.lineWidth&&(p.lineWidth(t.lineWidth),m.rs.lineWidth=t.lineWidth)}const{dss:n}=e;n&&(m.dss.depthTest!==n.depthTest&&(n.depthTest?p.enable(p.DEPTH_TEST):p.disable(p.DEPTH_TEST),m.dss.depthTest=n.depthTest),m.dss.depthWrite!==n.depthWrite&&(p.depthMask(n.depthWrite),m.dss.depthWrite=n.depthWrite),m.dss.depthFunc!==n.depthFunc&&(p.depthFunc(yR[n.depthFunc]),m.dss.depthFunc=n.depthFunc),m.dss.stencilTestFront===n.stencilTestFront&&m.dss.stencilTestBack===n.stencilTestBack||(n.stencilTestFront||n.stencilTestBack?p.enable(p.STENCIL_TEST):p.disable(p.STENCIL_TEST),m.dss.stencilTestFront=n.stencilTestFront,m.dss.stencilTestBack=n.stencilTestBack),m.dss.stencilFuncFront===n.stencilFuncFront&&m.dss.stencilRefFront===n.stencilRefFront&&m.dss.stencilReadMaskFront===n.stencilReadMaskFront||(p.stencilFuncSeparate(p.FRONT,yR[n.stencilFuncFront],n.stencilRefFront,n.stencilReadMaskFront),m.dss.stencilFuncFront=n.stencilFuncFront,m.dss.stencilRefFront=n.stencilRefFront,m.dss.stencilReadMaskFront=n.stencilReadMaskFront),m.dss.stencilFailOpFront===n.stencilFailOpFront&&m.dss.stencilZFailOpFront===n.stencilZFailOpFront&&m.dss.stencilPassOpFront===n.stencilPassOpFront||(p.stencilOpSeparate(p.FRONT,xR[n.stencilFailOpFront],xR[n.stencilZFailOpFront],xR[n.stencilPassOpFront]),m.dss.stencilFailOpFront=n.stencilFailOpFront,m.dss.stencilZFailOpFront=n.stencilZFailOpFront,m.dss.stencilPassOpFront=n.stencilPassOpFront),m.dss.stencilWriteMaskFront!==n.stencilWriteMaskFront&&(p.stencilMaskSeparate(p.FRONT,n.stencilWriteMaskFront),m.dss.stencilWriteMaskFront=n.stencilWriteMaskFront),m.dss.stencilFuncBack===n.stencilFuncBack&&m.dss.stencilRefBack===n.stencilRefBack&&m.dss.stencilReadMaskBack===n.stencilReadMaskBack||(p.stencilFuncSeparate(p.BACK,yR[n.stencilFuncBack],n.stencilRefBack,n.stencilReadMaskBack),m.dss.stencilFuncBack=n.stencilFuncBack,m.dss.stencilRefBack=n.stencilRefBack,m.dss.stencilReadMaskBack=n.stencilReadMaskBack),m.dss.stencilFailOpBack===n.stencilFailOpBack&&m.dss.stencilZFailOpBack===n.stencilZFailOpBack&&m.dss.stencilPassOpBack===n.stencilPassOpBack||(p.stencilOpSeparate(p.BACK,xR[n.stencilFailOpBack],xR[n.stencilZFailOpBack],xR[n.stencilPassOpBack]),m.dss.stencilFailOpBack=n.stencilFailOpBack,m.dss.stencilZFailOpBack=n.stencilZFailOpBack,m.dss.stencilPassOpBack=n.stencilPassOpBack),m.dss.stencilWriteMaskBack!==n.stencilWriteMaskBack&&(p.stencilMaskSeparate(p.BACK,n.stencilWriteMaskBack),m.dss.stencilWriteMaskBack=n.stencilWriteMaskBack));const{bs:i}=e;if(i){m.bs.isA2C!==i.isA2C&&(i.isA2C?p.enable(p.SAMPLE_ALPHA_TO_COVERAGE):p.disable(p.SAMPLE_ALPHA_TO_COVERAGE),m.bs.isA2C=i.isA2C),m.bs.blendColor.x===i.blendColor.x&&m.bs.blendColor.y===i.blendColor.y&&m.bs.blendColor.z===i.blendColor.z&&m.bs.blendColor.w===i.blendColor.w||(p.blendColor(i.blendColor.x,i.blendColor.y,i.blendColor.z,i.blendColor.w),m.bs.blendColor.x=i.blendColor.x,m.bs.blendColor.y=i.blendColor.y,m.bs.blendColor.z=i.blendColor.z,m.bs.blendColor.w=i.blendColor.w);const t=i.targets[0],e=m.bs.targets[0];e.blend!==t.blend&&(t.blend?p.enable(p.BLEND):p.disable(p.BLEND),e.blend=t.blend),e.blendEq===t.blendEq&&e.blendAlphaEq===t.blendAlphaEq||(p.blendEquationSeparate(SR[t.blendEq],SR[t.blendAlphaEq]),e.blendEq=t.blendEq,e.blendAlphaEq=t.blendAlphaEq),e.blendSrc===t.blendSrc&&e.blendDst===t.blendDst&&e.blendSrcAlpha===t.blendSrcAlpha&&e.blendDstAlpha===t.blendDstAlpha||(p.blendFuncSeparate(TR[t.blendSrc],TR[t.blendDst],TR[t.blendSrcAlpha],TR[t.blendDstAlpha]),e.blendSrc=t.blendSrc,e.blendDst=t.blendDst,e.blendSrcAlpha=t.blendSrcAlpha,e.blendDstAlpha=t.blendDstAlpha),e.blendColorMask!==t.blendColorMask&&(p.colorMask((t.blendColorMask&ar.R)!==ar.NONE,(t.blendColorMask&ar.G)!==ar.NONE,(t.blendColorMask&ar.B)!==ar.NONE,(t.blendColorMask&ar.A)!==ar.NONE),e.blendColorMask=t.blendColorMask)}}if(e&&e.gpuPipelineLayout&&f){const n=f.glBlocks.length,{dynamicOffsetIndices:r}=e.gpuPipelineLayout;for(let t=0;t<n;t++){const e=f.glBlocks[t],n=i[e.set],o=n&&n.descriptorIndices[e.binding],a=o>=0&&n.gpuDescriptors[o];let c=null,l=0;if(a&&a.gpuBuffer){const{gpuBuffer:t}=a,n=r[e.set],i=n&&n[e.binding];i>=0&&(l=s[i]),"vf32"in t?c=t.vf32:(l+=t.offset,c=t.gpuBuffer.vf32),l>>=2}if(!c){u(`Buffer binding '${e.name}' at set ${e.set} binding ${e.binding} is not bounded`);continue}const h=e.glActiveUniforms.length;for(let t=0;t<h;t++){const n=e.glActiveUniforms[t];switch(n.glType){case p.BOOL:case p.INT:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];p.uniform1iv(n.glLoc,n.array);break}}break;case p.BOOL_VEC2:case p.INT_VEC2:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];p.uniform2iv(n.glLoc,n.array);break}}break;case p.BOOL_VEC3:case p.INT_VEC3:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];p.uniform3iv(n.glLoc,n.array);break}}break;case p.BOOL_VEC4:case p.INT_VEC4:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];p.uniform4iv(n.glLoc,n.array);break}}break;case p.FLOAT:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];p.uniform1fv(n.glLoc,n.array);break}}break;case p.FLOAT_VEC2:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];p.uniform2fv(n.glLoc,n.array);break}}break;case p.FLOAT_VEC3:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];p.uniform3fv(n.glLoc,n.array);break}}break;case p.FLOAT_VEC4:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];p.uniform4fv(n.glLoc,n.array);break}}break;case p.FLOAT_MAT2:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];p.uniformMatrix2fv(n.glLoc,!1,n.array);break}}break;case p.FLOAT_MAT3:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];p.uniformMatrix3fv(n.glLoc,!1,n.array);break}}break;case p.FLOAT_MAT4:for(let t=0;t<n.array.length;++t){const e=n.begin+l+t;if(c[e]!==n.array[t]){for(let i=t,s=e;i<n.array.length;++i,++s)n.array[i]=c[s];p.uniformMatrix4fv(n.glLoc,!1,n.array);break}}}}}const o=f.glSamplers.length;for(let e=0;e<o;e++){const n=f.glSamplers[e],s=i[n.set];let r=s&&s.descriptorIndices[n.binding],o=r>=0&&s.gpuDescriptors[r];const a=n.units.length;for(let e=0;e<a;e++){const i=n.units[e];if(o&&o.gpuSampler){if(o.gpuTexture&&o.gpuTexture.size>0){const{gpuTexture:e}=o,n=m.glTexUnits[i];n.glTexture!==e.glTexture&&(m.texUnit!==i&&(p.activeTexture(p.TEXTURE0+i),m.texUnit=i),e.glTexture?p.bindTexture(e.glTarget,e.glTexture):p.bindTexture(e.glTarget,t.nullTex2D.gpuTexture.glTexture),n.glTexture=e.glTexture);const{gpuSampler:s}=o;e.isPowerOf2?(g=s.glWrapS,v=s.glWrapT):(g=p.CLAMP_TO_EDGE,v=p.CLAMP_TO_EDGE),y=e.isPowerOf2?e.mipLevel<=1&&(s.glMinFilter===p.LINEAR_MIPMAP_NEAREST||s.glMinFilter===p.LINEAR_MIPMAP_LINEAR)?p.LINEAR:s.glMinFilter:s.glMinFilter===p.LINEAR||s.glMinFilter===p.LINEAR_MIPMAP_NEAREST||s.glMinFilter===p.LINEAR_MIPMAP_LINEAR?p.LINEAR:p.NEAREST,e.glWrapS!==g&&(m.texUnit!==i&&(p.activeTexture(p.TEXTURE0+i),m.texUnit=i),p.texParameteri(e.glTarget,p.TEXTURE_WRAP_S,g),e.glWrapS=g),e.glWrapT!==v&&(m.texUnit!==i&&(p.activeTexture(p.TEXTURE0+i),m.texUnit=i),p.texParameteri(e.glTarget,p.TEXTURE_WRAP_T,v),e.glWrapT=v),e.glMinFilter!==y&&(m.texUnit!==i&&(p.activeTexture(p.TEXTURE0+i),m.texUnit=i),p.texParameteri(e.glTarget,p.TEXTURE_MIN_FILTER,y),e.glMinFilter=y),e.glMagFilter!==s.glMagFilter&&(m.texUnit!==i&&(p.activeTexture(p.TEXTURE0+i),m.texUnit=i),p.texParameteri(e.glTarget,p.TEXTURE_MAG_FILTER,s.glMagFilter),e.glMagFilter=s.glMagFilter)}o=s.gpuDescriptors[++r]}else u(`Sampler binding '${n.name}' at set ${n.set} binding ${n.binding} index ${e} is not bounded`)}}}if(n&&f&&(x||DR.gpuInputAssembler!==n)){DR.gpuInputAssembler=n;const e=t.ANGLE_instanced_arrays;if(t.useVAO){const i=t.OES_vertex_array_object;let s=n.glVAOs.get(f.glProgram);if(!s){let t;s=i.createVertexArrayOES(),n.glVAOs.set(f.glProgram,s),i.bindVertexArrayOES(s),p.bindBuffer(p.ARRAY_BUFFER,null),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,null),m.glArrayBuffer=null,m.glElementArrayBuffer=null;const r=f.glInputs.length;for(let i=0;i<r;i++){const s=f.glInputs[i];t=null;const r=n.glAttribs.length;for(let e=0;e<r;e++){const i=n.glAttribs[e];if(i.name===s.name){t=i;break}}if(t){m.glArrayBuffer!==t.glBuffer&&(p.bindBuffer(p.ARRAY_BUFFER,t.glBuffer),m.glArrayBuffer=t.glBuffer);for(let n=0;n<t.componentCount;++n){const i=s.glLoc+n,r=t.offset+t.size*n;p.enableVertexAttribArray(i),m.glCurrentAttribLocs[i]=!0,p.vertexAttribPointer(i,t.count,t.glType,t.isNormalized,t.stride,r),e&&e.vertexAttribDivisorANGLE(i,t.isInstanced?1:0)}}}const o=n.gpuIndexBuffer;o&&p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,o.glBuffer),i.bindVertexArrayOES(null),p.bindBuffer(p.ARRAY_BUFFER,null),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,null),m.glArrayBuffer=null,m.glElementArrayBuffer=null}m.glVAO!==s&&(i.bindVertexArrayOES(s),m.glVAO=s)}else{for(let e=0;e<t.maxVertexAttributes;++e)m.glCurrentAttribLocs[e]=!1;const i=f.glInputs.length;for(let t=0;t<i;t++){const i=f.glInputs[t];let s=null;const r=n.glAttribs.length;for(let t=0;t<r;t++){const e=n.glAttribs[t];if(e.name===i.name){s=e;break}}if(s){m.glArrayBuffer!==s.glBuffer&&(p.bindBuffer(p.ARRAY_BUFFER,s.glBuffer),m.glArrayBuffer=s.glBuffer);for(let t=0;t<s.componentCount;++t){const n=i.glLoc+t,r=s.offset+s.size*t;!m.glEnabledAttribLocs[n]&&n>=0&&(p.enableVertexAttribArray(n),m.glEnabledAttribLocs[n]=!0),m.glCurrentAttribLocs[n]=!0,p.vertexAttribPointer(n,s.count,s.glType,s.isNormalized,s.stride,r),e&&e.vertexAttribDivisorANGLE(n,s.isInstanced?1:0)}}}const s=n.gpuIndexBuffer;s&&m.glElementArrayBuffer!==s.glBuffer&&(p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,s.glBuffer),m.glElementArrayBuffer=s.glBuffer);for(let e=0;e<t.maxVertexAttributes;++e)m.glEnabledAttribLocs[e]!==m.glCurrentAttribLocs[e]&&(p.disableVertexAttribArray(e),m.glEnabledAttribLocs[e]=!1)}}if(e&&e.dynamicStates.length){const t=e.dynamicStates.length;for(let n=0;n<t;n++)switch(e.dynamicStates[n]){case Sr.VIEWPORT:r&&(m.viewport.left===r.left&&m.viewport.top===r.top&&m.viewport.width===r.width&&m.viewport.height===r.height||(p.viewport(r.left,r.top,r.width,r.height),m.viewport.left=r.left,m.viewport.top=r.top,m.viewport.width=r.width,m.viewport.height=r.height));break;case Sr.SCISSOR:o&&(m.scissorRect.x===o.x&&m.scissorRect.y===o.y&&m.scissorRect.width===o.width&&m.scissorRect.height===o.height||(p.scissor(o.x,o.y,o.width,o.height),m.scissorRect.x=o.x,m.scissorRect.y=o.y,m.scissorRect.width=o.width,m.scissorRect.height=o.height));break;case Sr.LINE_WIDTH:a&&m.rs.lineWidth!==a&&(p.lineWidth(a),m.rs.lineWidth=a);break;case Sr.DEPTH_BIAS:c&&(m.rs.depthBias===c.constantFactor&&m.rs.depthBiasSlop===c.slopeFactor||(p.polygonOffset(c.constantFactor,c.slopeFactor),m.rs.depthBias=c.constantFactor,m.rs.depthBiasSlop=c.slopeFactor));break;case Sr.BLEND_CONSTANTS:m.bs.blendColor.x===l[0]&&m.bs.blendColor.y===l[1]&&m.bs.blendColor.z===l[2]&&m.bs.blendColor.w===l[3]||(p.blendColor(l[0],l[1],l[2],l[3]),[m.bs.blendColor.x,m.bs.blendColor.y,m.bs.blendColor.z,m.bs.blendColor.w]=l);break;case Sr.STENCIL_WRITE_MASK:if(_)switch(_.face){case Tr.FRONT:m.dss.stencilWriteMaskFront!==_.writeMask&&(p.stencilMaskSeparate(p.FRONT,_.writeMask),m.dss.stencilWriteMaskFront=_.writeMask);break;case Tr.BACK:m.dss.stencilWriteMaskBack!==_.writeMask&&(p.stencilMaskSeparate(p.BACK,_.writeMask),m.dss.stencilWriteMaskBack=_.writeMask);break;case Tr.ALL:m.dss.stencilWriteMaskFront===_.writeMask&&m.dss.stencilWriteMaskBack===_.writeMask||(p.stencilMask(_.writeMask),m.dss.stencilWriteMaskFront=_.writeMask,m.dss.stencilWriteMaskBack=_.writeMask)}break;case Sr.STENCIL_COMPARE_MASK:if(d)switch(d.face){case Tr.FRONT:m.dss.stencilRefFront===d.reference&&m.dss.stencilReadMaskFront===d.compareMask||(p.stencilFuncSeparate(p.FRONT,yR[m.dss.stencilFuncFront],d.reference,d.compareMask),m.dss.stencilRefFront=d.reference,m.dss.stencilReadMaskFront=d.compareMask);break;case Tr.BACK:m.dss.stencilRefBack===d.reference&&m.dss.stencilReadMaskBack===d.compareMask||(p.stencilFuncSeparate(p.BACK,yR[m.dss.stencilFuncBack],d.reference,d.compareMask),m.dss.stencilRefBack=d.reference,m.dss.stencilReadMaskBack=d.compareMask);break;case Tr.ALL:m.dss.stencilRefFront===d.reference&&m.dss.stencilReadMaskFront===d.compareMask&&m.dss.stencilRefBack===d.reference&&m.dss.stencilReadMaskBack===d.compareMask||(p.stencilFunc(yR[m.dss.stencilFuncBack],d.reference,d.compareMask),m.dss.stencilRefFront=d.reference,m.dss.stencilReadMaskFront=d.compareMask,m.dss.stencilRefBack=d.reference,m.dss.stencilReadMaskBack=d.compareMask)}}}}function LR(t,e){const{gl:n}=t,i=t.ANGLE_instanced_arrays,{gpuInputAssembler:s,glPrimitive:r}=DR;if(s)if(s.gpuIndirectBuffer){const t=s.gpuIndirectBuffer.indirects.length;for(let e=0;e<t;e++){const t=s.gpuIndirectBuffer.indirects[e],o=s.gpuIndexBuffer;if(t.instanceCount&&i)if(o){if(t.indexCount>0){const e=t.firstIndex*o.stride;i.drawElementsInstancedANGLE(r,t.indexCount,s.glIndexType,e,t.instanceCount)}}else t.vertexCount>0&&i.drawArraysInstancedANGLE(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(o){if(t.indexCount>0){const e=t.firstIndex*o.stride;n.drawElements(r,t.indexCount,s.glIndexType,e)}}else t.vertexCount>0&&n.drawArrays(r,t.firstVertex,t.vertexCount)}}else{const t=s.gpuIndexBuffer;if(e.instanceCount&&i)if(t){if(e.indexCount>0){const n=e.firstIndex*t.stride;i.drawElementsInstancedANGLE(r,e.indexCount,s.glIndexType,n,e.instanceCount)}}else e.vertexCount>0&&i.drawArraysInstancedANGLE(r,e.firstVertex,e.vertexCount,e.instanceCount);else if(t){if(e.indexCount>0){const i=e.firstIndex*t.stride;n.drawElements(r,e.indexCount,s.glIndexType,i)}}else e.vertexCount>0&&n.drawArrays(r,e.firstVertex,e.vertexCount)}}const zR=new Array(ER.COUNT);function BR(t,e){zR.fill(0);for(let n=0;n<e.cmds.length;++n){const i=e.cmds.array[n],s=zR[i]++;switch(i){case ER.BEGIN_RENDER_PASS:{const n=e.beginRenderPassCmds.array[s];MR(t,n.gpuRenderPass,n.gpuFramebuffer,n.renderArea,n.clearColors,n.clearDepth,n.clearStencil);break}case ER.BIND_STATES:{const n=e.bindStatesCmds.array[s];NR(t,n.gpuPipelineState,n.gpuInputAssembler,n.gpuDescriptorSets,n.dynamicOffsets,n.viewport,n.scissor,n.lineWidth,n.depthBias,n.blendConstants,n.depthBounds,n.stencilWriteMask,n.stencilCompareMask);break}case ER.DRAW:LR(t,e.drawCmds.array[s].drawInfo);break;case ER.UPDATE_BUFFER:{const n=e.updateBufferCmds.array[s];OR(t,n.gpuBuffer,n.buffer,n.offset,n.size);break}case ER.COPY_BUFFER_TO_TEXTURE:{const n=e.copyBufferToTextureCmds.array[s];FR(t,n.buffers,n.gpuTexture,n.regions);break}}}}function FR(t,e,n,i){const{gl:s}=t,r=t.stateCache.glTexUnits[t.stateCache.texUnit];r.glTexture!==n.glTexture&&(s.bindTexture(n.glTarget,n.glTexture),r.glTexture=n.glTexture);let o=0,a=1,c=1,l=0;const h=Dr[n.format],{isCompressed:_}=h;switch(n.glTarget){case s.TEXTURE_2D:for(let r=0;r<i.length;r++){const l=i[r];a=l.texExtent.width,c=l.texExtent.height;const h=e[o++];_?n.glInternalFmt===sR.COMPRESSED_RGB_ETC1_WEBGL||t.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,n.glInternalFmt,a,c,0,h):s.compressedTexSubImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,a,c,n.glFormat,h):s.texSubImage2D(s.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,a,c,n.glFormat,n.glType,h)}break;case s.TEXTURE_CUBE_MAP:for(let r=0;r<i.length;r++){const h=i[r],u=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(l=h.texSubres.baseArrayLayer;l<u;++l){a=h.texExtent.width,c=h.texExtent.height;const i=e[o++];_?n.glInternalFmt===sR.COMPRESSED_RGB_ETC1_WEBGL||t.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,n.glInternalFmt,a,c,0,i):s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,c,n.glFormat,i):s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,c,n.glFormat,n.glType,i)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&dr.GEN_MIPMAP&&s.generateMipmap(n.glTarget)}class UR extends mo{constructor(...t){super(...t),this._gpuBuffer=null,this._gpuBufferView=null,this._uniformBuffer=null}get gpuBuffer(){return this._gpuBuffer}get gpuBufferView(){return this._gpuBufferView}initialize(t){if("buffer"in t){this._isBufferView=!0;const e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&Ys.INDIRECT&&(this._indirectBuffer=new _o),this._flags&$s.BAKUP_BUFFER&&(this._bakcupBuffer=new Uint8Array(this._size),this._device.memoryStatus.bufferSize+=this._size),this._usage&Ys.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:this._bakcupBuffer,vf32:null,indirects:[],glTarget:0,glBuffer:null},t.usage&Ys.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),this._usage&Ys.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){const{gl:n}=t,i=t.stateCache,s=e.memUsage&Ks.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(e.usage&Ys.VERTEX){e.glTarget=n.ARRAY_BUFFER;const r=n.createBuffer();r&&(e.glBuffer=r,e.size>0&&(t.useVAO&&i.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=DR.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),n.bufferData(n.ARRAY_BUFFER,e.size,s),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&Ys.INDEX){e.glTarget=n.ELEMENT_ARRAY_BUFFER;const r=n.createBuffer();r&&(e.glBuffer=r,e.size>0&&(t.useVAO&&i.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=DR.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&Ys.UNIFORM?(e.glTarget=n.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&Ys.INDIRECT||e.usage&Ys.TRANSFER_DST||e.usage&Ys.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0}destroy(){var t,e;this._gpuBuffer&&(t=this._device,(e=this._gpuBuffer).glBuffer&&(t.gl.deleteBuffer(e.glBuffer),e.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null),this._bakcupBuffer=null}resize(t){if(this._isBufferView)return void console.warn("cannot resize buffer views!");const e=this._size;if(e!==t){if(this._size=t,this._count=this._size/this._stride,this._bakcupBuffer){const n=this._bakcupBuffer;this._bakcupBuffer=new Uint8Array(this._size),this._bakcupBuffer.set(n),this._device.memoryStatus.bufferSize-=e,this._device.memoryStatus.bufferSize+=t}this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer?this._gpuBuffer.buffer=this._uniformBuffer:this._bakcupBuffer&&(this._gpuBuffer.buffer=this._bakcupBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){const{gl:n}=t,i=t.stateCache,s=e.memUsage&Ks.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;e.usage&Ys.VERTEX?(t.useVAO&&i.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=DR.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ARRAY_BUFFER,e.buffer,s):n.bufferData(n.ARRAY_BUFFER,e.size,s),n.bindBuffer(n.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&Ys.INDEX?(t.useVAO&&i.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=DR.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.buffer,s):n.bufferData(n.ELEMENT_ARRAY_BUFFER,e.size,s),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&Ys.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&Ys.INDIRECT||e.usage&Ys.TRANSFER_DST||e.usage&Ys.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=n.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=e,this._device.memoryStatus.bufferSize+=t))}}update(t,e){if(this._isBufferView)return void console.warn("cannot update through buffer views!");let n;if(n=void 0!==e?e:this._usage&Ys.INDIRECT?0:t.byteLength,this._bakcupBuffer&&t!==this._bakcupBuffer.buffer){const n=new Uint8Array(t,0,e);this._bakcupBuffer.set(n)}OR(this._device,this._gpuBuffer,t,0,n)}}class GR{constructor(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new t_(e);for(let n=0;n<e;++n)this._frees[n]=new t;this._freeIdx=e-1}alloc(t){if(this._freeIdx<0){const e=2*this._frees.length,n=this._frees;this._frees=new Array(e);const i=e-n.length;for(let e=0;e<i;++e)this._frees[e]=new t;for(let t=i,s=0;t<e;++t,++s)this._frees[t]=n[s];this._freeIdx+=i}const e=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++e.refCount,e}free(t){0==--t.refCount&&this._freeCmds.push(t)}freeCmds(t){for(let e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])}release(){for(let t=0;t<this._freeCmds.length;++t){const e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()}}class HR{constructor(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new GR(AR,1),this.bindStatesCmdPool=new GR(bR,1),this.drawCmdPool=new GR(wR,1),this.updateBufferCmdPool=new GR(RR,1),this.copyBufferToTextureCmdPool=new GR(IR,1)}clearCmds(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()}releaseCmds(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}class VR extends No{constructor(...t){super(...t),this.cmdPackage=new PR,this._webGLAllocator=null,this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets=[],this._curDynamicOffsets=[],this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants=[],this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._isStateInvalied=!1}initialize(t){this._type=t.type,this._queue=t.queue,this._webGLAllocator=this._device.cmdAllocator;const e=this._device.bindingMappingInfo.bufferOffsets.length;for(let t=0;t<e;t++)this._curGPUDescriptorSets.push(null),this._curDynamicOffsets.push([]);return!0}destroy(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)}begin(t,e=0,n){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0;for(let t=0;t<this._curDynamicOffsets.length;t++)this._curDynamicOffsets[t].length=0;this._curViewport=null,this._curScissor=null,this._curLineWidth=null,this._curDepthBias=null,this._curBlendConstants.length=0,this._curDepthBounds=null,this._curStencilWriteMask=null,this._curStencilCompareMask=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(t,e,n,i,s,r){const o=this._webGLAllocator.beginRenderPassCmdPool.alloc(AR);o.gpuRenderPass=t.gpuRenderPass,o.gpuFramebuffer=e.gpuFramebuffer,o.renderArea=n,o.clearColors.length=i.length;for(let t=0;t<i.length;++t)o.clearColors[t]=i[t];o.clearDepth=s,o.clearStencil=r,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(ER.BEGIN_RENDER_PASS),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(t){const e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)}bindDescriptorSet(t,e,n){const i=e.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=i,this._isStateInvalied=!0),n){const e=this._curDynamicOffsets[t];for(let t=0;t<n.length;t++)e[t]=n[t];e.length=n.length,this._isStateInvalied=!0}}bindInputAssembler(t){const e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0}setViewport(t){this._curViewport?this._curViewport.left===t.left&&this._curViewport.top===t.top&&this._curViewport.width===t.width&&this._curViewport.height===t.height&&this._curViewport.minDepth===t.minDepth&&this._curViewport.maxDepth===t.maxDepth||(this._curViewport.left=t.left,this._curViewport.top=t.top,this._curViewport.width=t.width,this._curViewport.height=t.height,this._curViewport.minDepth=t.minDepth,this._curViewport.maxDepth=t.maxDepth,this._isStateInvalied=!0):this._curViewport=new Gr(t.left,t.top,t.width,t.height,t.minDepth,t.maxDepth)}setScissor(t){this._curScissor?this._curScissor.x===t.x&&this._curScissor.y===t.y&&this._curScissor.width===t.width&&this._curScissor.height===t.height||(this._curScissor.x=t.x,this._curScissor.y=t.y,this._curScissor.width=t.width,this._curScissor.height=t.height,this._isStateInvalied=!0):this._curScissor=new Ur(t.x,t.y,t.width,t.height)}setLineWidth(t){this._curLineWidth!==t&&(this._curLineWidth=t,this._isStateInvalied=!0)}setDepthBias(t,e,n){this._curDepthBias?this._curDepthBias.constantFactor===t&&this._curDepthBias.clamp===e&&this._curDepthBias.slopeFactor===n||(this._curDepthBias.constantFactor=t,this._curDepthBias.clamp=e,this._curDepthBias.slopeFactor=n,this._isStateInvalied=!0):(this._curDepthBias={constantFactor:t,clamp:e,slopeFactor:n},this._isStateInvalied=!0)}setBlendConstants(t){4!==t.length||this._curBlendConstants[0]===t[0]&&this._curBlendConstants[1]===t[1]&&this._curBlendConstants[2]===t[2]&&this._curBlendConstants[3]===t[3]||(this._curBlendConstants.length=0,Array.prototype.push.apply(this._curBlendConstants,t),this._isStateInvalied=!0)}setDepthBound(t,e){this._curDepthBounds&&this._curDepthBounds.minBounds===t&&this._curDepthBounds.maxBounds===e||(this._curDepthBounds={minBounds:t,maxBounds:e},this._isStateInvalied=!0)}setStencilWriteMask(t,e){this._curStencilWriteMask?this._curStencilWriteMask.face===t&&this._curStencilWriteMask.writeMask===e||(this._curStencilWriteMask.face=t,this._curStencilWriteMask.writeMask=e,this._isStateInvalied=!0):(this._curStencilWriteMask={face:t,writeMask:e},this._isStateInvalied=!0)}setStencilCompareMask(t,e,n){this._curStencilCompareMask?this._curStencilCompareMask.face===t&&this._curStencilCompareMask.reference===e&&this._curStencilCompareMask.compareMask===n||(this._curStencilCompareMask.face=t,this._curStencilCompareMask.reference=e,this._curStencilCompareMask.compareMask=n,this._isStateInvalied=!0):(this._curStencilCompareMask={face:t,reference:e,compareMask:n},this._isStateInvalied=!0)}draw(t){if(this._type===fr.PRIMARY&&this._isInRenderPass||this._type===fr.SECONDARY){this._isStateInvalied&&this.bindStates();const e=this._webGLAllocator.drawCmdPool.alloc(wR);e.drawInfo.vertexCount=t.vertexCount,e.drawInfo.firstVertex=t.firstVertex,e.drawInfo.indexCount=t.indexCount,e.drawInfo.firstIndex=t.firstIndex,e.drawInfo.vertexOffset=t.vertexOffset,e.drawInfo.instanceCount=t.instanceCount,e.drawInfo.firstInstance=t.firstInstance,this.cmdPackage.drawCmds.push(e),this.cmdPackage.cmds.push(ER.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;const n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(t,e,n){if(this._type===fr.PRIMARY&&!this._isInRenderPass||this._type===fr.SECONDARY){const i=t.gpuBuffer;if(i){const s=this._webGLAllocator.updateBufferCmdPool.alloc(RR);let r=0,o=null;t.usage&Ys.INDIRECT||(r=void 0!==n?n:e.byteLength),o=e,s.gpuBuffer=i,s.buffer=o,s.offset=0,s.size=r,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(ER.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}copyBuffersToTexture(t,e,n){if(this._type===fr.PRIMARY&&!this._isInRenderPass||this._type===fr.SECONDARY){const i=e.gpuTexture;if(i){const e=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(IR);e&&(e.gpuTexture=i,e.regions=n,e.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(e),this.cmdPackage.cmds.push(ER.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}execute(t,e){for(let n=0;n<e;++n){const e=t[n];for(let t=0;t<e.cmdPackage.beginRenderPassCmds.length;++t){const n=e.cmdPackage.beginRenderPassCmds.array[t];++n.refCount,this.cmdPackage.beginRenderPassCmds.push(n)}for(let t=0;t<e.cmdPackage.bindStatesCmds.length;++t){const n=e.cmdPackage.bindStatesCmds.array[t];++n.refCount,this.cmdPackage.bindStatesCmds.push(n)}for(let t=0;t<e.cmdPackage.drawCmds.length;++t){const n=e.cmdPackage.drawCmds.array[t];++n.refCount,this.cmdPackage.drawCmds.push(n)}for(let t=0;t<e.cmdPackage.updateBufferCmds.length;++t){const n=e.cmdPackage.updateBufferCmds.array[t];++n.refCount,this.cmdPackage.updateBufferCmds.push(n)}for(let t=0;t<e.cmdPackage.copyBufferToTextureCmds.length;++t){const n=e.cmdPackage.copyBufferToTextureCmds.array[t];++n.refCount,this.cmdPackage.copyBufferToTextureCmds.push(n)}this.cmdPackage.cmds.concat(e.cmdPackage.cmds.array),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}get webGLDevice(){return this._device}bindStates(){const t=this._webGLAllocator.bindStatesCmdPool.alloc(bR);if(t){t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets);for(let e=0;e<this._curDynamicOffsets.length;e++)Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets[e]);t.gpuInputAssembler=this._curGPUInputAssembler,t.viewport=this._curViewport,t.scissor=this._curScissor,t.lineWidth=this._curLineWidth,t.depthBias=this._curDepthBias,Array.prototype.push.apply(t.blendConstants,this._curBlendConstants),t.depthBounds=this._curDepthBounds,t.stencilWriteMask=this._curStencilWriteMask,t.stencilCompareMask=this._curStencilCompareMask,this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(ER.BIND_STATES),this._isStateInvalied=!1}}}class kR extends Uo{initialize(t){return!0}destroy(){}wait(){}reset(){}}class jR extends zo{constructor(...t){super(...t),this._gpuFramebuffer=null}get gpuFramebuffer(){return this._gpuFramebuffer}initialize(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null,0!==t.depStencilMipmapLevel&&console.warn("The mipmap level of th texture image to be attached of depth stencil attachment should be 0. Convert to 0.");for(let e=0;e<t.colorMipmapLevels.length;++e)0!==t.colorMipmapLevels[e]&&console.warn(`The mipmap level of th texture image to be attached of color attachment ${e} should be 0. Convert to 0.`);const e=[];for(let n=0;n<t.colorTextures.length;++n){const i=t.colorTextures[n];i&&e.push(i.gpuTexture)}let n=null;return t.depthStencilTexture&&(n=t.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:n,glFramebuffer:null},function(t,e){if(!e.gpuColorTextures.length&&!e.gpuDepthStencilTexture)return;const{gl:n}=t,i=[],s=n.createFramebuffer();if(s){e.glFramebuffer=s,t.stateCache.glFramebuffer!==e.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,e.glFramebuffer);for(let t=0;t<e.gpuColorTextures.length;++t){const s=e.gpuColorTextures[t];s&&(s.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+t,s.glTarget,s.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0+t,n.RENDERBUFFER,s.glRenderbuffer),i.push(n.COLOR_ATTACHMENT0+t))}const r=e.gpuDepthStencilTexture;if(r){const t=Dr[r.format].hasStencil?n.DEPTH_STENCIL_ATTACHMENT:n.DEPTH_ATTACHMENT;r.glTexture?n.framebufferTexture2D(n.FRAMEBUFFER,t,r.glTarget,r.glTexture,0):n.framebufferRenderbuffer(n.FRAMEBUFFER,t,n.RENDERBUFFER,r.glRenderbuffer)}t.WEBGL_draw_buffers&&t.WEBGL_draw_buffers.drawBuffersWEBGL(i);const o=n.checkFramebufferStatus(n.FRAMEBUFFER);if(o!==n.FRAMEBUFFER_COMPLETE)switch(o){case n.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case n.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case n.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&n.bindFramebuffer(n.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(this._device,this._gpuFramebuffer),!0}destroy(){var t,e;this._gpuFramebuffer&&(t=this._device,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),e.glFramebuffer=null),this._gpuFramebuffer=null)}}class WR extends ko{constructor(...t){super(...t),this._gpuInputAssembler=null}get gpuInputAssembler(){return this._gpuInputAssembler}initialize(t){if(0===t.vertexBuffers.length)return console.error("InputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{const t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;const e=new Array(t.vertexBuffers.length);for(let n=0;n<t.vertexBuffers.length;++n){const i=t.vertexBuffers[n];i.gpuBuffer&&(e[n]=i.gpuBuffer)}let n=null,i=0;if(t.indexBuffer&&(n=t.indexBuffer.gpuBuffer,n))switch(n.stride){case 1:i=5121;break;case 2:i=5123;break;case 4:i=5125;break;default:console.error("Error index buffer stride.")}let s=null;return t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:e,gpuIndexBuffer:n,gpuIndirectBuffer:s,glAttribs:[],glIndexType:i,glVAOs:new Map},function(t,e){const{gl:n}=t;e.glAttribs=new Array(e.attributes.length);const i=[0,0,0,0,0,0,0,0];for(let t=0;t<e.attributes.length;++t){const s=e.attributes[t],r=void 0!==s.stream?s.stream:0,o=e.gpuVertexBuffers[r],a=_R(s.format,n),{size:c}=Dr[s.format];e.glAttribs[t]={name:s.name,glBuffer:o.glBuffer,glType:a,size:c,count:Dr[s.format].count,stride:o.stride,componentCount:vR(a,n),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:i[r]},i[r]+=c}}(this._device,this._gpuInputAssembler),!0}destroy(){const t=this._device;this._gpuInputAssembler&&t.useVAO&&function(t,e){const n=e.glVAOs.values();let i=n.next();for(;!i.done;)t.OES_vertex_array_object.deleteVertexArrayOES(i.value),i=n.next();e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null}}class qR extends Do{constructor(...t){super(...t),this._gpuDescriptorSetLayout=null}get gpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}initialize(t){Array.prototype.push.apply(this._bindings,t.bindings);let e=0,n=-1;const i=[];for(let t=0;t<this._bindings.length;t++){const s=this._bindings[t];i.push(e),e+=s.count,s.binding>n&&(n=s.binding)}this._bindingIndices=Array(n+1).fill(-1);const s=this._descriptorIndices=Array(n+1).fill(-1);for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];this._bindingIndices[e.binding]=t,s[e.binding]=i[t]}const r=[];for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];if(e.descriptorType&Oo)for(let t=0;t<e.count;t++)r.push(e.binding)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:r,descriptorIndices:s,descriptorCount:e},!0}destroy(){this._bindings.length=0}}class XR extends Fo{constructor(...t){super(...t),this._gpuPipelineLayout=null}get gpuPipelineLayout(){return this._gpuPipelineLayout}initialize(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);const e=[],n=[];let i=0;for(let t=0;t<this._setLayouts.length;t++){const s=this._setLayouts[t],r=s.gpuDescriptorSetLayout.dynamicBindings,o=Array(s.bindingIndices.length).fill(-1);for(let t=0;t<r.length;t++){const e=r[t];o[e]<0&&(o[e]=i+t)}n.push(s.gpuDescriptorSetLayout),e.push(o),i+=r.length}return this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:e,dynamicOffsetCount:i},!0}destroy(){this._setLayouts.length=0}}const YR=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class KR extends Jr{constructor(...t){super(...t),this._gpuPipelineState=null}get gpuPipelineState(){return this._gpuPipelineState}initialize(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;const e=this._bs;if(t.blendState){const n=t.blendState,{targets:i}=n;i&&i.forEach((t,n)=>{e.setTarget(n,t)}),void 0!==n.isA2C&&(e.isA2C=n.isA2C),void 0!==n.isIndepend&&(e.isIndepend=n.isIndepend),void 0!==n.blendColor&&(e.blendColor=n.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;const n=[];for(let t=0;t<31;t++)this._dynamicStates&1<<t&&n.push(1<<t);return this._gpuPipelineState={glPrimitive:YR[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:n},!0}destroy(){this._gpuPipelineState=null}}const $R=[];class ZR extends VR{beginRenderPass(t,e,n,i,s,r){MR(this._device,t.gpuRenderPass,e.gpuFramebuffer,n,i,s,r),this._isInRenderPass=!0}draw(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),LR(this._device,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;const e=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=e/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(e-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(t,e,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{const i=t.gpuBuffer;if(i){let s;s=void 0!==n?n:t.usage&Ys.INDIRECT?0:e.byteLength,OR(this._device,i,e,0,s)}}}copyBuffersToTexture(t,e,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{const i=e.gpuTexture;i&&FR(this._device,t,i,n)}}execute(t,e){for(let n=0;n<e;++n){const e=t[n];BR(this._device,e.cmdPackage),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}bindStates(){$R.length=0;for(let t=0;t<this._curDynamicOffsets.length;t++)Array.prototype.push.apply($R,this._curDynamicOffsets[t]);NR(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,$R,this._curViewport,this._curScissor,this._curLineWidth,this._curDepthBias,this._curBlendConstants,this._curDepthBounds,this._curStencilWriteMask,this._curStencilCompareMask),this._isStateInvalied=!1}}class JR extends Ho{constructor(...t){super(...t),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(t){return this._type=t.type,!0}destroy(){}submit(t,e){if(!this._isAsync){const e=t.length;for(let n=0;n<e;n++){const e=t[n];this.numDrawCalls+=e.numDrawCalls,this.numInstances+=e.numInstances,this.numTris+=e.numTris}}}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class QR extends To{constructor(...t){super(...t),this._gpuRenderPass=null}get gpuRenderPass(){return this._gpuRenderPass}initialize(t){return this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,t.subPasses&&(this._subPasses=t.subPasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0}destroy(){this._gpuRenderPass=null}}const tI=[10497,33648,33071,33071];class eI extends Co{constructor(...t){super(...t),this._gpuSampler=null}get gpuSampler(){return this._gpuSampler}initialize(t){this._minFilter=t.minFilter,this._magFilter=t.magFilter,this._mipFilter=t.mipFilter,this._addressU=t.addressU,this._addressV=t.addressV,this._addressW=t.addressW,this._maxAnisotropy=t.maxAnisotropy,this._cmpFunc=t.cmpFunc,this._borderColor=t.borderColor,this._minLOD=t.minLOD,this._maxLOD=t.maxLOD,this._mipLODBias=t.mipLODBias;let e=0,n=0;const i=this._minFilter,s=this._magFilter,r=this._mipFilter;e=i===cr.LINEAR||i===cr.ANISOTROPIC?r===cr.LINEAR||r===cr.ANISOTROPIC?9987:r===cr.POINT?9985:9729:r===cr.LINEAR||r===cr.ANISOTROPIC?9986:r===cr.POINT?9984:9728,n=s===cr.LINEAR||s===cr.ANISOTROPIC?9729:9728;const o=tI[this._addressU],a=tI[this._addressV],c=tI[this._addressW];return this._gpuSampler={glMinFilter:e,glMagFilter:n,glWrapS:o,glWrapT:a,glWrapR:c},!0}destroy(){this._gpuSampler=null}}class nI extends lo{constructor(...t){super(...t),this._gpuShader=null}get gpuShader(){return this._gpuShader}initialize(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks,samplers:t.samplers,gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplers:[]};for(let e=0;e<t.stages.length;++e){const n=t.stages[e];this._gpuShader.gpuStages[e]={type:n.stage,source:n.source,glShader:null}}return function(t,e){const{gl:n}=t;for(let t=0;t<e.gpuStages.length;t++){const i=e.gpuStages[t];let s=0,r="",o=1;switch(i.type){case pr.VERTEX:r="VertexShader",s=n.VERTEX_SHADER;break;case pr.FRAGMENT:r="FragmentShader",s=n.FRAGMENT_SHADER;break;default:return void console.error("Unsupported ShaderType.")}const a=n.createShader(s);if(a&&(i.glShader=a,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(`${r} in '${e.name}' compilation failed.`),console.error("Shader source dump:",i.source.replace(/^|\n/g,()=>`\n${o++} `)),console.error(n.getShaderInfoLog(i.glShader));for(let i=0;i<e.gpuStages.length;i++){const i=e.gpuStages[t];i.glShader&&(n.deleteShader(i.glShader),i.glShader=null)}return}}const i=n.createProgram();if(!i)return;e.glProgram=i;for(let t=0;t<e.gpuStages.length;t++){const i=e.gpuStages[t];n.attachShader(e.glProgram,i.glShader)}if(n.linkProgram(e.glProgram),t.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const i=e.gpuStages[t];i.glShader&&(n.detachShader(e.glProgram,i.glShader),n.deleteShader(i.glShader),i.glShader=null)}if(!n.getProgramParameter(e.glProgram,n.LINK_STATUS))return console.error(`Failed to link shader '${e.name}'.`),void console.error(n.getProgramInfoLog(e.glProgram));console.info(`Shader '${e.name}' compilation succeeded.`);const s=n.getProgramParameter(e.glProgram,n.ACTIVE_ATTRIBUTES);e.glInputs=new Array(s);for(let t=0;t<s;++t){const i=n.getActiveAttrib(e.glProgram,t);if(i){let s;const r=i.name.indexOf("[");s=-1!==r?i.name.substr(0,r):i.name;const o=n.getAttribLocation(e.glProgram,s),a=fR(i.type,n),c=gR(i.type,n);e.glInputs[t]={binding:o,name:s,type:a,stride:c,count:i.size,size:c*i.size,glType:i.type,glLoc:o}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(let t=0;t<e.blocks.length;++t){const i=e.blocks[t],s={set:i.set,binding:i.binding,name:i.name,size:0,glUniforms:new Array(i.members.length),glActiveUniforms:[]};e.glBlocks[t]=s;for(let t=0;t<i.members.length;++t){const e=i.members[t],r=pR(e.type,n),o=mR(e.type),a=gR(r,n),c=a*e.count,l=s.size/4,h=new o(c/4);s.glUniforms[t]={binding:-1,name:e.name,type:e.type,stride:a,count:e.count,size:c,offset:s.size,glType:r,glLoc:-1,array:h,begin:l},s.size+=c}}}if(e.samplers.length>0){e.glSamplers=new Array(e.samplers.length);for(let t=0;t<e.samplers.length;++t){const i=e.samplers[t];e.glSamplers[t]={set:i.set,binding:i.binding,name:i.name,type:i.type,count:i.count,units:[],glUnits:null,glType:pR(i.type,n),glLoc:null}}}const r=n.getProgramParameter(e.glProgram,n.ACTIVE_UNIFORMS);for(let t=0;t<r;++t){const i=n.getActiveUniform(e.glProgram,t);if(i&&i.type!==n.SAMPLER_2D&&i.type!==n.SAMPLER_CUBE){const t=n.getUniformLocation(e.glProgram,i.name);if(null!==t&&("number"==typeof t||-1!==t.id)){let n;const s=i.name.indexOf("[");n=-1!==s?i.name.substr(0,s):i.name;for(let i=0;i<e.glBlocks.length;i++){const s=e.glBlocks[i];for(let e=0;e<s.glUniforms.length;e++){const i=s.glUniforms[e];if(i.name===n){i.glLoc=t,s.glActiveUniforms.push(i);break}}}}}}const o=[],a=[],{bindingMappingInfo:c}=t,{texUnitCacheMap:l}=t.stateCache;let h=0;for(let t=0;t<e.blocks.length;++t)e.blocks[t].set===c.flexibleSet&&h++;let _=0;for(let i=0;i<e.samplers.length;++i){const s=e.samplers[i],r=n.getUniformLocation(e.glProgram,s.name);if(null===r||"number"!=typeof r&&-1===r.id||(o.push(e.glSamplers[i]),a.push(r)),void 0===l[s.name]){let e=s.binding+c.samplerOffsets[s.set]+_;s.set===c.flexibleSet&&(e-=h),l[s.name]=e%t.maxTextureUnits,_+=s.count-1}}if(o.length){const i=[];for(let e=0;e<o.length;++e){const n=o[e];let s=l[n.name];if(void 0!==s){n.glLoc=a[e];for(let e=0;e<n.count;++e){for(;i[s];)s=(s+1)%t.maxTextureUnits;n.units.push(s),i[s]=!0}}}let s=0;for(let e=0;e<o.length;++e){const n=o[e];if(!n.glLoc){n.glLoc=a[e];for(let e=0;e<n.count;++e){for(;i[s];)s=(s+1)%t.maxTextureUnits;void 0===l[n.name]&&(l[n.name]=s),n.units.push(s),i[s]=!0}}}t.stateCache.glProgram!==e.glProgram&&n.useProgram(e.glProgram);for(let t=0;t<o.length;t++){const e=o[t];e.glUnits=new Int32Array(e.units),n.uniform1iv(e.glLoc,e.glUnits)}t.stateCache.glProgram!==e.glProgram&&n.useProgram(t.stateCache.glProgram)}for(let t=0;t<e.glBlocks.length;)e.glBlocks[t].glActiveUniforms.length?t++:(e.glBlocks[t]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplers=o}(this._device,this._gpuShader),!0}destroy(){this._gpuShader&&(function(t,e){if(e.glProgram){const{gl:n}=t;if(!t.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const i=e.gpuStages[t];i.glShader&&(n.detachShader(e.glProgram,i.glShader),n.deleteShader(i.glShader),i.glShader=null)}n.deleteProgram(e.glProgram),e.glProgram=null}}(this._device,this._gpuShader),this._gpuShader=null)}}class iI{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new Gr,this.scissorRect=new Ur(0,0,0,0),this.rs=new qr,this.dss=new Xr,this.bs=new Kr,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}initialize(t,e){for(let e=0;e<t;++e)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)}}class sI extends io{constructor(...t){super(...t),this._gpuTexture=null}get gpuTexture(){return this._gpuTexture}initialize(t){return"texture"in t?(console.log("WebGL does not support texture view."),!1):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=no(this._width)&&no(this._height),this._size=Nr(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._flags&dr.BAKUP_BUFFER&&(this._buffer=new ArrayBuffer(this._size)),this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(t,e){const{gl:n}=t;e.glInternalFmt=uR(e.format,n),e.glFormat=dR(e.format,n),e.glType=_R(e.format,n);let i=e.width,s=e.height;switch(e.type){case hr.TEX2D:{e.glTarget=n.TEXTURE_2D;const r=Math.max(i,s);if(r>t.maxTextureSize&&T(9100,r,t.maxTextureSize),!t.WEBGL_depth_texture&&Dr[e.format].hasDepth){const r=n.createRenderbuffer();r&&e.size>0&&(e.glRenderbuffer=r,t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),e.glInternalFmt===n.DEPTH_COMPONENT&&(e.glInternalFmt=n.DEPTH_COMPONENT16),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,s))}else if(e.samples===ur.X1){const r=n.createTexture();if(r&&e.size>0){e.glTexture=r;const o=t.stateCache.glTexUnits[t.stateCache.texUnit];if(o.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),o.glTexture=e.glTexture),Dr[e.format].isCompressed)if(e.glInternalFmt!==sR.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<e.mipLevel;++t){const r=Mr(e.format,i,s,1),o=new Uint8Array(r);n.compressedTexImage2D(n.TEXTURE_2D,t,e.glInternalFmt,i,s,0,o),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}else{const t=Mr(e.format,2,2,1),i=new Uint8Array(t);n.compressedTexImage2D(n.TEXTURE_2D,0,e.glInternalFmt,2,2,0,i)}else for(let t=0;t<e.mipLevel;++t)n.texImage2D(n.TEXTURE_2D,t,e.glInternalFmt,i,s,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),s=Math.max(1,s>>1);e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}else n.deleteTexture(r)}break}case hr.CUBE:{e.glTarget=n.TEXTURE_CUBE_MAP;const r=Math.max(i,s);r>t.maxCubeMapTextureSize&&T(9100,r,t.maxTextureSize);const o=n.createTexture();if(o&&e.size>0){e.glTexture=o;const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),r.glTexture=e.glTexture),Dr[e.format].isCompressed)if(e.glInternalFmt!==sR.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<6;++t){i=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r){const o=Mr(e.format,i,s,1),a=new Uint8Array(o);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,i,s,0,a),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}}else for(let t=0;t<6;++t){const i=Mr(e.format,2,2,1),s=new Uint8Array(i);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,e.glInternalFmt,2,2,0,s)}else for(let t=0;t<6;++t){i=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,i,s,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}e.isPowerOf2?(e.glWrapS=n.REPEAT,e.glWrapT=n.REPEAT):(e.glWrapS=n.CLAMP_TO_EDGE,e.glWrapT=n.CLAMP_TO_EDGE),e.glMinFilter=n.LINEAR,e.glMagFilter=n.LINEAR,n.texParameteri(e.glTarget,n.TEXTURE_WRAP_S,e.glWrapS),n.texParameteri(e.glTarget,n.TEXTURE_WRAP_T,e.glWrapT),n.texParameteri(e.glTarget,n.TEXTURE_MIN_FILTER,e.glMinFilter),n.texParameteri(e.glTarget,n.TEXTURE_MAG_FILTER,e.glMagFilter)}break}default:console.error("Unsupported TextureType, create texture failed."),e.type=hr.TEX2D,e.glTarget=n.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)}destroy(){var t,e;this._gpuTexture&&(t=this._device,(e=this._gpuTexture).glTexture&&(t.gl.deleteTexture(e.glTexture),e.glTexture=null),e.glRenderbuffer&&(t.gl.deleteRenderbuffer(e.glRenderbuffer),e.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null),this._buffer=null}resize(t,e){const n=this._size;this._width=t,this._height=e,this._size=Nr(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){const{gl:n}=t;e.glInternalFmt=uR(e.format,n),e.glFormat=dR(e.format,n),e.glType=_R(e.format,n);let i=e.width,s=e.height;switch(e.type){case hr.TEX2D:{e.glTarget=n.TEXTURE_2D;const r=Math.max(i,s);if(r>t.maxTextureSize&&T(9100,r,t.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,e.glInternalFmt,i,s);else if(e.glTexture){const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_2D,e.glTexture),r.glTexture=e.glTexture),Dr[e.format].isCompressed){if(e.glInternalFmt!==sR.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<e.mipLevel;++t){const r=Mr(e.format,i,s,1),o=new Uint8Array(r);n.compressedTexImage2D(n.TEXTURE_2D,t,e.glInternalFmt,i,s,0,o),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}}else for(let t=0;t<e.mipLevel;++t)n.texImage2D(n.TEXTURE_2D,t,e.glInternalFmt,i,s,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}break}case hr.CUBE:{e.glTarget=n.TEXTURE_CUBE_MAP;const r=Math.max(i,s);r>t.maxCubeMapTextureSize&&T(9100,r,t.maxTextureSize);const o=t.stateCache.glTexUnits[t.stateCache.texUnit];if(o.glTexture!==e.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,e.glTexture),o.glTexture=e.glTexture),Dr[e.format].isCompressed){if(e.glInternalFmt!==sR.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<6;++t){i=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r){const o=Mr(e.format,i,s,1),a=new Uint8Array(o);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,i,s,0,a),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}}}else for(let t=0;t<6;++t){i=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,i,s,0,e.glFormat,e.glType,null),i=Math.max(1,i>>1),s=Math.max(1,s>>1)}break}default:console.error("Unsupported TextureType, create texture failed."),e.type=hr.TEX2D,e.glTarget=n.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=n,this._device.memoryStatus.textureSize+=this._size)}}class rI extends class{constructor(){this._canvas=null,this._canvas2D=null,this._gfxAPI=br.UNKNOWN,this._transform=wr.IDENTITY,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(Rr.COUNT),this._queue=null,this._cmdBuff=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._nativeWidth=0,this._nativeHeight=0,this._maxVertexAttributes=0,this._maxVertexUniformVectors=0,this._maxFragmentUniformVectors=0,this._maxTextureUnits=0,this._maxVertexTextureUnits=0,this._maxUniformBufferBindings=0,this._maxUniformBlockSize=0,this._maxTextureSize=0,this._maxCubeMapTextureSize=0,this._uboOffsetAlignment=1,this._depthBits=0,this._stencilBits=0,this._colorFmt=Xs.UNKNOWN,this._depthStencilFmt=Xs.UNKNOWN,this._macros=new Map,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new Or,this._clipSpaceMinZ=-1,this._screenSpaceSignY=1,this._UVSpaceSignY=-1}get canvas(){return this._canvas}get canvas2D(){return this._canvas2D}get gfxAPI(){return this._gfxAPI}get queue(){return this._queue}get commandBuffer(){return this._cmdBuff}get devicePixelRatio(){return this._devicePixelRatio}get width(){return this._width}get height(){return this._height}get nativeWidth(){return this._nativeWidth}get nativeHeight(){return this._nativeHeight}get renderer(){return this._renderer}get vendor(){return this._vendor}get maxVertexAttributes(){return this._maxVertexAttributes}get maxVertexUniformVectors(){return this._maxVertexUniformVectors}get maxFragmentUniformVectors(){return this._maxFragmentUniformVectors}get maxTextureUnits(){return this._maxTextureUnits}get maxVertexTextureUnits(){return this._maxVertexTextureUnits}get maxUniformBufferBindings(){return this._maxUniformBufferBindings}get maxUniformBlockSize(){return this._maxUniformBlockSize}get maxTextureSize(){return this._maxTextureSize}get maxCubeMapTextureSize(){return this._maxCubeMapTextureSize}get uboOffsetAlignment(){return this._uboOffsetAlignment}get depthBits(){return this._depthBits}get stencilBits(){return this._stencilBits}get colorFormat(){return this._colorFmt}get depthStencilFormat(){return this._depthStencilFmt}get macros(){return this._macros}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}get memoryStatus(){return this._memoryStatus}get clipSpaceMinZ(){return this._clipSpaceMinZ}get screenSpaceSignY(){return this._screenSpaceSignY}get UVSpaceSignY(){return this._UVSpaceSignY}get surfaceTransform(){return this._transform}hasFeature(t){return this._features[t]}}{constructor(...t){super(...t),this.stateCache=new iI,this.cmdAllocator=new HR,this.nullTex2D=null,this.nullTexCube=null,this._webGLRC=null,this._isAntialias=!0,this._isPremultipliedAlpha=!0,this._useVAO=!1,this._destroyShadersImmediately=!0,this._noCompressedTexSubImage2D=!1,this._bindingMappingInfo=new Qr,this._webGLContextLostHandler=null,this._extensions=null,this._EXT_texture_filter_anisotropic=null,this._EXT_blend_minmax=null,this._EXT_frag_depth=null,this._EXT_shader_texture_lod=null,this._EXT_sRGB=null,this._OES_vertex_array_object=null,this._EXT_color_buffer_half_float=null,this._WEBGL_color_buffer_float=null,this._WEBGL_compressed_texture_etc1=null,this._WEBGL_compressed_texture_etc=null,this._WEBGL_compressed_texture_pvrtc=null,this._WEBGL_compressed_texture_astc=null,this._WEBGL_compressed_texture_s3tc=null,this._WEBGL_compressed_texture_s3tc_srgb=null,this._WEBGL_debug_shaders=null,this._WEBGL_draw_buffers=null,this._WEBGL_lose_context=null,this._WEBGL_depth_texture=null,this._WEBGL_debug_renderer_info=null,this._OES_texture_half_float=null,this._OES_texture_half_float_linear=null,this._OES_texture_float=null,this._OES_texture_float_linear=null,this._OES_standard_derivatives=null,this._OES_element_index_uint=null,this._ANGLE_instanced_arrays=null}get gl(){return this._webGLRC}get webGLQueue(){return this._queue}get isAntialias(){return this._isAntialias}get isPremultipliedAlpha(){return this._isPremultipliedAlpha}get useVAO(){return this._useVAO}get destroyShadersImmediately(){return this._destroyShadersImmediately}get noCompressedTexSubImage2D(){return this._noCompressedTexSubImage2D}get bindingMappingInfo(){return this._bindingMappingInfo}get EXT_texture_filter_anisotropic(){return this._EXT_texture_filter_anisotropic}get EXT_blend_minmax(){return this._EXT_blend_minmax}get EXT_frag_depth(){return this._EXT_frag_depth}get EXT_shader_texture_lod(){return this._EXT_shader_texture_lod}get EXT_sRGB(){return this._EXT_sRGB}get OES_vertex_array_object(){return this._OES_vertex_array_object}get WEBGL_color_buffer_float(){return this._WEBGL_color_buffer_float}get WEBGL_compressed_texture_etc1(){return this._WEBGL_compressed_texture_etc1}get WEBGL_compressed_texture_pvrtc(){return this._WEBGL_compressed_texture_pvrtc}get WEBGL_compressed_texture_astc(){return this._WEBGL_compressed_texture_astc}get WEBGL_compressed_texture_s3tc(){return this._WEBGL_compressed_texture_s3tc}get WEBGL_compressed_texture_s3tc_srgb(){return this._WEBGL_compressed_texture_s3tc_srgb}get WEBGL_debug_shaders(){return this._WEBGL_debug_shaders}get WEBGL_draw_buffers(){return this._WEBGL_draw_buffers}get WEBGL_lose_context(){return this._WEBGL_lose_context}get WEBGL_depth_texture(){return this._WEBGL_depth_texture}get WEBGL_debug_renderer_info(){return this._WEBGL_debug_renderer_info}get OES_texture_half_float(){return this._OES_texture_half_float}get OES_texture_half_float_linear(){return this._OES_texture_half_float_linear}get OES_texture_float(){return this._OES_texture_float}get OES_standard_derivatives(){return this._OES_standard_derivatives}get OES_element_index_uint(){return this._OES_element_index_uint}get ANGLE_instanced_arrays(){return this._ANGLE_instanced_arrays}initialize(t){this._canvas=t.canvasElm,this._isAntialias=t.isAntialias,this._isPremultipliedAlpha=t.isPremultipliedAlpha,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{const t={alpha:Kt.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(t){return console.error(t),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener("webglcontextlost",this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=br.WEBGL,this._deviceName="WebGL";const e=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=e.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR)),this._version=e.getParameter(e.VERSION),this._maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._depthBits=e.getParameter(e.DEPTH_BITS),this._stencilBits=e.getParameter(e.STENCIL_BITS),this.stateCache.initialize(this._maxTextureUnits,this._maxVertexAttributes),this._devicePixelRatio=t.devicePixelRatio||1,this._width=this._canvas.width,this._height=this._canvas.height,this._nativeWidth=Math.max(t.nativeWidth||this._width,0),this._nativeHeight=Math.max(t.nativeHeight||this._height,0),this._colorFmt=Xs.RGBA8,24===this._depthBits?8===this._stencilBits?this._depthStencilFmt=Xs.D24S8:this._depthStencilFmt=Xs.D24:8===this._stencilBits?this._depthStencilFmt=Xs.D16S8:this._depthStencilFmt=Xs.D16,this._extensions=e.getSupportedExtensions();let n="";if(this._extensions){for(const t of this._extensions)n+=t+" ";console.debug("EXTENSIONS: "+n)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_blend_minmax=this.getExtension("EXT_blend_minmax"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),Om.os===Om.OS_IOS&&14===Om.osMainVersion&&Om.isBrowser||(this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc")),Om.browserType===Om.BROWSER_TYPE_UC&&(this._ANGLE_instanced_arrays=null),Om.os===Om.OS_IOS&&Om.osMainVersion<=10&&(this._destroyShadersImmediately=!1),this._features.fill(!1),this._EXT_blend_minmax&&(this._features[Rr.BLEND_MINMAX]=!0),this._WEBGL_color_buffer_float&&(this._features[Rr.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[Rr.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[Rr.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[Rr.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[Rr.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[Rr.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[Rr.FORMAT_RGB8]=!0,this._WEBGL_depth_texture&&(this._features[Rr.FORMAT_D16]=!0,this._features[Rr.FORMAT_D24]=!0,this._features[Rr.FORMAT_D24S8]=!0),this._OES_element_index_uint&&(this._features[Rr.ELEMENT_INDEX_UINT]=!0),this._ANGLE_instanced_arrays&&(this._features[Rr.INSTANCED_ARRAYS]=!0),this._WEBGL_draw_buffers&&(this._features[Rr.MULTIPLE_RENDER_TARGETS]=!0);let i="";this._WEBGL_compressed_texture_etc1&&(this._features[Rr.FORMAT_ETC1]=!0,i+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[Rr.FORMAT_ETC2]=!0,i+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[Rr.FORMAT_DXT]=!0,i+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[Rr.FORMAT_PVRTC]=!0,i+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[Rr.FORMAT_ASTC]=!0,i+="astc "),this._OES_vertex_array_object&&(this._useVAO=!0),console.info("RENDERER: "+this._renderer),console.info("VENDOR: "+this._vendor),console.info("VERSION: "+this._version),console.info("DPR: "+this._devicePixelRatio),console.info(`SCREEN_SIZE: ${this._width} x ${this._height}`),console.info(`NATIVE_SIZE: ${this._nativeWidth} x ${this._nativeHeight}`),console.info("MAX_VERTEX_UNIFORM_VECTORS: "+this._maxVertexUniformVectors),console.info("DEPTH_BITS: "+this._depthBits),console.info("STENCIL_BITS: "+this._stencilBits),this._EXT_texture_filter_anisotropic&&console.info("MAX_TEXTURE_MAX_ANISOTROPY_EXT: "+this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT),console.info("USE_VAO: "+this._useVAO),console.info("COMPRESSED_FORMAT: "+i),this.initStates(e),this._queue=this.createQueue(new Go(Er.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new Mo(this._queue)),this.nullTex2D=this.createTexture(new eo(hr.TEX2D,_r.SAMPLED,Xs.RGBA8,2,2,dr.GEN_MIPMAP)),this.nullTexCube=this.createTexture(new eo(hr.TEX2D,_r.SAMPLED,Xs.RGBA8,2,2,dr.CUBEMAP|dr.GEN_MIPMAP,6));const s=new Wr;s.texExtent.width=2,s.texExtent.height=2;const r=new Uint8Array(this.nullTex2D.size);return r.fill(0),this.copyBuffersToTexture([r],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([r,r,r,r,r,r],this.nullTexCube,[s]),!0}destroy(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener("webglcontextlost",this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGLRC=null}resize(t,e){this._width===t&&this._height===e||(console.info(`Resizing device: ${t}x${e}`),this._canvas.width=t,this._canvas.height=e,this._width=t,this._height=e)}acquire(){this.cmdAllocator.releaseCmds()}present(){const t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()}createCommandBuffer(t){const e=new(t.type===fr.PRIMARY?ZR:VR)(this);return e.initialize(t),e}createBuffer(t){const e=new UR(this);return e.initialize(t)?e:null}createTexture(t){const e=new sI(this);return e.initialize(t)?e:null}createSampler(t){const e=new eI(this);return e.initialize(t)?e:null}createDescriptorSet(t){const e=new hR(this);return e.initialize(t)?e:null}createShader(t){const e=new nI(this);return e.initialize(t)?e:null}createInputAssembler(t){const e=new WR(this);return e.initialize(t)?e:null}createRenderPass(t){const e=new QR(this);return e.initialize(t)?e:null}createFramebuffer(t){const e=new jR(this);return e.initialize(t)?e:null}createDescriptorSetLayout(t){const e=new qR(this);return e.initialize(t)?e:null}createPipelineLayout(t){const e=new XR(this);return e.initialize(t)?e:null}createPipelineState(t){const e=new KR(this);return e.initialize(t)?e:null}createFence(t){const e=new kR(this);return e.initialize(t)?e:null}createQueue(t){const e=new JR(this);return e.initialize(t)?e:null}copyBuffersToTexture(t,e,n){FR(this,t,e.gpuTexture,n)}copyTexImagesToTexture(t,e,n){!function(t,e,n,i){const{gl:s}=t,r=t.stateCache.glTexUnits[t.stateCache.texUnit];r.glTexture!==n.glTexture&&(s.bindTexture(n.glTarget,n.glTexture),r.glTexture=n.glTexture);let o=0,a=0;switch(n.glTarget){case s.TEXTURE_2D:for(let t=0;t<i.length;t++){const r=i[t];s.texSubImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,n.glFormat,n.glType,e[o++])}break;case s.TEXTURE_CUBE_MAP:for(let t=0;t<i.length;t++){const r=i[t],c=r.texSubres.baseArrayLayer+r.texSubres.layerCount;for(a=r.texSubres.baseArrayLayer;a<c;++a)s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,n.glFormat,n.glType,e[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&dr.GEN_MIPMAP&&n.isPowerOf2&&s.generateMipmap(n.glTarget)}(this,t,e.gpuTexture,n)}copyFramebufferToBuffer(t,e,n){const i=this._webGLRC,s=t.gpuFramebuffer,r=s.gpuColorTextures[0].format,o=dR(r,i),a=_R(r,i),c=Br(Dr[r]),l=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==s.glFramebuffer&&(i.bindFramebuffer(i.FRAMEBUFFER,s.glFramebuffer),this.stateCache.glFramebuffer=s.glFramebuffer);const h=new c(e);for(const t of n){const e=t.texExtent.width,n=t.texExtent.height;i.readPixels(t.texOffset.x,t.texOffset.y,e,n,o,a,h)}this.stateCache.glFramebuffer!==l&&(i.bindFramebuffer(i.FRAMEBUFFER,l),this.stateCache.glFramebuffer=l)}blitFramebuffer(t,e,n,i,s){}getExtension(t){const e=["","WEBKIT_","MOZ_"];for(let n=0;n<e.length;++n){const i=this.gl.getExtension(e[n]+t);if(i)return i}return null}initStates(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}_onWebGLContextLost(t){x(11e3),_(t)}}var oI,aI,cI,lI,hI,_I;t("WebGLDevice",rI),i.WebGLDevice=rI,function(t){t[t.positions=Ws.ATTR_POSITION]="positions",t[t.normals=Ws.ATTR_NORMAL]="normals",t[t.uvs=Ws.ATTR_TEX_COORD]="uvs",t[t.colors=Ws.ATTR_COLOR]="colors"}(oI||(oI={}));class uI{constructor(){this._arrayBufferOrPaddings=[],this._length=0}setNextAlignment(t){if(0!==t){const e=this._length%t;if(0!==e){const n=t-e;this._arrayBufferOrPaddings.push(n),this._length+=n}}}addBuffer(t){const e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e}getLength(){return this._length}getCombined(){const t=new Uint8Array(this._length);let e=0;return this._arrayBufferOrPaddings.forEach(n=>{"number"==typeof n?e+=n:(t.set(new Uint8Array(n),e),e+=n.byteLength)}),t.buffer}}class dI{constructor(t,e){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,!this._mesh.struct.morph)return;const n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(let t=0;t<n;++t){const n=this._mesh.struct.morph.subMeshMorphs[t];n&&(n.targets.length>$c.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[t]=new mI(this._mesh,t,this._mesh.struct.morph,e):this._subMeshRenderings[t]=new pI(this._mesh,t,this._mesh.struct.morph,e))}}createInstance(){const t=this._mesh.struct.primitives.length,e=new Array(t);for(let s=0;s<t;++s){var n,i;e[s]=null!==(n=null===(i=this._subMeshRenderings[s])||void 0===i?void 0:i.createInstance())&&void 0!==n?n:null}return{setWeights:(t,n)=>{var i;null===(i=e[t])||void 0===i||i.setWeights(n)},requiredPatches:t=>{this._mesh.struct.morph;const n=this._mesh.struct.morph.subMeshMorphs[t],i=e[t];if(null===i)return;const s=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:n.targets.length}];return n.attributes.includes(Ws.ATTR_POSITION)&&s.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),n.attributes.includes(Ws.ATTR_NORMAL)&&s.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),n.attributes.includes(Ws.ATTR_TANGENT)&&s.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),s.push(...i.requiredPatches()),s},adaptPipelineState:(t,n)=>{var i;null===(i=e[t])||void 0===i||i.adaptPipelineState(n)},destroy:()=>{for(const t of e)null==t||t.destroy()}}}}class pI{constructor(t,e,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;const s=n.subMeshMorphs[e];this._subMeshMorph=s,yI(t,e,i);const r=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=r;const o=s.targets.length,a=vI(i,r*o);this._textureInfo={width:a.width,height:a.height},this._attributes=s.attributes.map((e,n)=>{const i=a.create(),o=i.valueView;return s.targets.forEach((e,i)=>{const s=e.displacements[n],a=new Float32Array(t.data.buffer,t.data.byteOffset+s.offset,s.count),c=r*i*4;for(let t=0;t<r;++t)o[c+4*t+0]=a[3*t+0],o[c+4*t+1]=a[3*t+1],o[c+4*t+2]=a[3*t+2]}),i.updatePixels(),{name:e,morphTexture:i}})}destroy(){for(const t of this._attributes)t.morphTexture.destroy()}createInstance(){const t=new gI(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:e=>{t.setWeights(e),t.commit()},requiredPatches:()=>[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}],adaptPipelineState:e=>{for(const t of this._attributes){let n;switch(t.name){case Ws.ATTR_POSITION:n=tl;break;case Ws.ATTR_NORMAL:n=il;break;case Ws.ATTR_TANGENT:n=ol;break;default:_("Unexpected attribute!")}void 0!==n&&(e.bindSampler(n,t.morphTexture.sampler),e.bindTexture(n,t.morphTexture.texture))}e.bindBuffer($c.BINDING,t.buffer),e.update()},destroy:()=>{}}}}class mI{constructor(t,e,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;const s=n.subMeshMorphs[e];yI(t,e,i),this._attributes=s.attributes.map((e,n)=>({name:e,targets:s.targets.map(e=>({displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[n].offset,e.displacements[n].count)}))}))}get data(){return this._attributes}createInstance(){return new fI(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)}}class fI{constructor(t,e,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new gI(n,0);const i=vI(n,e);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map(t=>{const e=i.create();return{attributeName:t.name,morphTexture:e}})}setWeights(t){for(let e=0;e<this._attributes.length;++e){const n=this._attributes[e],i=n.morphTexture.valueView,s=this._owner.data[e];t.length,s.targets.length;for(let e=0;e<s.targets.length;++e){const n=s.targets[e].displacements,r=t[e],o=n.length/3;if(0===e)for(let t=0;t<o;++t)i[4*t+0]=n[3*t+0]*r,i[4*t+1]=n[3*t+1]*r,i[4*t+2]=n[3*t+2]*r;else for(let t=0;t<o;++t)i[4*t+0]+=n[3*t+0]*r,i[4*t+1]+=n[3*t+1]*r,i[4*t+2]+=n[3*t+2]*r}n.morphTexture.updatePixels()}}requiredPatches(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]}adaptPipelineState(t){for(const e of this._attributes){let n;switch(e.attributeName){case Ws.ATTR_POSITION:n=tl;break;case Ws.ATTR_NORMAL:n=il;break;case Ws.ATTR_TANGENT:n=ol;break;default:_("Unexpected attribute!")}void 0!==n&&(t.bindSampler(n,e.morphTexture.sampler),t.bindTexture(n,e.morphTexture.texture))}t.bindBuffer($c.BINDING,this._morphUniforms.buffer),t.update()}destroy(){this._morphUniforms.destroy();for(let t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()}}class gI{constructor(t,e){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer($c.SIZE)),this._remoteBuffer=t.createBuffer(new uo(Ys.UNIFORM|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,$c.SIZE,$c.SIZE))}destroy(){this._remoteBuffer.destroy()}get buffer(){return this._remoteBuffer}setWeights(t){t.length,this._targetCount;for(let e=0;e<t.length;++e)this._localBuffer.setFloat32($c.OFFSET_OF_WEIGHTS+4*e,t[e],i.sys.isLittleEndian)}setMorphTextureInfo(t,e){this._localBuffer.setFloat32($c.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,i.sys.isLittleEndian),this._localBuffer.setFloat32($c.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,i.sys.isLittleEndian)}setVerticesCount(t){this._localBuffer.setFloat32($c.OFFSET_OF_VERTICES_COUNT,t,i.sys.isLittleEndian)}commit(){this._remoteBuffer.update(this._localBuffer.buffer)}}function vI(t,e){let n,i,s,r;t.hasFeature(Rr.TEXTURE_FLOAT)?(n=e,s=16,i=Zu.PixelFormat.RGBA32F,r=Float32Array):(n=4*e,s=4,i=Zu.PixelFormat.RGBA8888,r=Uint8Array);const{width:o,height:a}=function(t){t<5&&(t=5);const e=q(Y(t)),n=e>>1;return{width:1<<(1&e?n+1:n),height:1<<n}}(n);return{width:o,height:a,create:()=>{const e=new ArrayBuffer(o*a*s),n=new Float32Array(e),c=r===Float32Array?n:new r(e),l=new P_({width:o,height:a,_data:c,_compressed:!1,format:i}),h=new Zu;h.setFilters(Zu.Filter.NEAREST,Zu.Filter.NEAREST),h.setMipFilter(Zu.Filter.NONE),h.setWrapMode(Zu.WrapMode.CLAMP_TO_EDGE,Zu.WrapMode.CLAMP_TO_EDGE,Zu.WrapMode.CLAMP_TO_EDGE),h.image=l,h.getGFXTexture()||_("Unexpected: failed to create morph texture?");const u=z_.getSampler(t,h.getSamplerHash());return{get texture(){return h.getGFXTexture()},get sampler(){return u},get valueView(){return n},destroy(){h.destroy()},updatePixels(){h.uploadData(c)}}}}}function yI(t,e,n){t.renderingSubMeshes[e].enableVertexIdChannel(n)}function xI(t){switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}const SI=new ln,TI=new ln,EI=new Uint8Array;let CI=t("Mesh",Yl("cc.Mesh")((lI=Gl((cI=class extends y_{get _nativeAsset(){return this._data.buffer}set _nativeAsset(t){this._data.byteLength===t.byteLength?this._data.set(new Uint8Array(t)):this._data=new Uint8Array(t),this.loaded=!0,this.emit("load")}get subMeshCount(){const t=this.renderingSubMeshes;return t?t.length:0}get minPosition(){return this.struct.minPosition}get maxPosition(){return this.struct.maxPosition}get struct(){return this._struct}get data(){return this._data}get hash(){return this._hash||(this._hash=vo(this._data,666)),this._hash}get jointBufferIndices(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map(t=>t.jointMapIndex||0)}get renderingSubMeshes(){return this.initialize(),this._renderingSubMeshes}constructor(){super(),this.morphRendering=null,Ul(this,"_struct",lI,this),Ul(this,"_dataLength",hI,this),Ul(this,"_hash",_I,this),this._data=EI,this._initialized=!1,this._renderingSubMeshes=null,this._boneSpaceBounds=new Map,this._jointBufferIndices=null,this.loaded=!1}initialize(){if(this._initialized)return;this._initialized=!0,this._data.byteLength!==this._dataLength&&(this._data=new Uint8Array(this._dataLength),i.assetManager.postLoadNative(this));const{buffer:t}=this._data,e=i.director.root.device,n=this._createVertexBuffers(e,t),s=[];for(let i=0;i<this._struct.primitives.length;i++){const r=this._struct.primitives[i];if(0===r.vertexBundelIndices.length)continue;let o=null,a=null;if(r.indexView){const n=r.indexView;let i=n.stride,s=n.length;if(4===i&&!e.hasFeature(Rr.ELEMENT_INDEX_UINT)){const t=this._struct.vertexBundles[r.vertexBundelIndices[0]].view.count;if(t>=65536){x(10001,t,65536);continue}i>>=1,s>>=1}o=e.createBuffer(new uo(Ys.INDEX,Ks.DEVICE,s,i)),a=new(xI(n.stride))(t,n.offset,n.count),n.stride!==i&&(a=xI(i).from(a)),this.loaded?o.update(a):this.once("load",()=>{o.update(a)})}const c=r.vertexBundelIndices.map(t=>n[t]),l=[];if(r.vertexBundelIndices.length>0){const t=r.vertexBundelIndices[0],e=this._struct.vertexBundles[t].attributes;for(let t=0;t<e.length;++t){const n=e[t];l[t]=new Yo(n.name,n.format,n.isInstanced,n.stream,n.isInstanced,n.location)}}const h=new Qv(c,l,r.primitiveMode,o);h.mesh=this,h.subMeshIdx=i,s.push(h)}this._renderingSubMeshes=s,this._struct.morph&&(this.morphRendering=function(t,e){return new dI(t,e)}(this,e))}destroy(){return this.destroyRenderingMesh(),super.destroy()}destroyRenderingMesh(){if(this._renderingSubMeshes){for(let t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1}}assign(t,e){this.reset({struct:t,data:e})}reset(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._dataLength=this.data.byteLength,this._hash=0,this.loaded=!0,this.emit("load")}getBoneSpaceBounds(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);const e=[];this._boneSpaceBounds.set(t.hash,e);const n=[],{bindposes:i}=t;for(let t=0;t<i.length;t++)e.push(new nc(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);const{primitives:s}=this._struct;for(let t=0;t<s.length;t++){const s=this.readAttribute(t,Ws.ATTR_JOINTS),r=this.readAttribute(t,Ws.ATTR_WEIGHTS),o=this.readAttribute(t,Ws.ATTR_POSITION);if(!s||!r||!o)continue;const a=Math.min(s.length/4,r.length/4,o.length/3);for(let t=0;t<a;t++){ln.set(SI,o[3*t+0],o[3*t+1],o[3*t+2]);for(let o=0;o<4;++o){const a=4*t+o,c=s[a];if(0===r[a]||c>=i.length)continue;ln.transformMat4(TI,SI,i[c]),n[c]=!0;const l=e[c];ln.min(l.center,l.center,TI),ln.max(l.halfExtents,l.halfExtents,TI)}}}for(let t=0;t<i.length;t++){const i=e[t];n[t]?nc.fromPoints(i,i.center,i.halfExtents):e[t]=null}return e}merge(t,e,n){if(n&&(!this.loaded||!t.loaded||!this.validateMergingMesh(t)))return!1;const i=new ln,s=e&&new vn,r=e&&new nc;if(s&&e.getRotation(s),!this._initialized){const n=JSON.parse(JSON.stringify(t._struct)),o=t._data.slice();if(e){n.maxPosition&&n.minPosition&&(ln.add(r.center,n.maxPosition,n.minPosition),ln.multiplyScalar(r.center,r.center,.5),ln.subtract(r.halfExtents,n.maxPosition,n.minPosition),ln.multiplyScalar(r.halfExtents,r.halfExtents,.5),nc.transform(r,r,e),ln.add(n.maxPosition,r.center,r.halfExtents),ln.subtract(n.minPosition,r.center,r.halfExtents));for(let t=0;t<n.vertexBundles.length;t++){const r=n.vertexBundles[t];for(let t=0;t<r.attributes.length;t++)if(r.attributes[t].name===Ws.ATTR_POSITION||r.attributes[t].name===Ws.ATTR_NORMAL){const{format:n}=r.attributes[t],a=new DataView(o.buffer,r.view.offset+AI(r.attributes,t)),c=RI(a,n),l=II(a,n);if(!c||!l)continue;const h=r.view.count,_=r.view.stride,u=wI(n);for(let n=0;n<h;n++){const o=n*_,a=o+u,h=a+u;switch(i.set(c(o),c(a),c(h)),r.attributes[t].name){case Ws.ATTR_POSITION:i.transformMat4(e);break;case Ws.ATTR_NORMAL:ln.transformQuat(i,i,s)}l(o,i.x),l(a,i.y),l(h,i.z)}}}}return this.reset({struct:n,data:o}),this.initialize(),!0}const o=new uI;let a,c,l,h,_,u=0,d=0,p=0,m=0,f=0,g=0,v=0,y=0,x=!1;const S=new Array(this._struct.vertexBundles.length);for(let n=0;n<this._struct.vertexBundles.length;++n){const r=this._struct.vertexBundles[n],T=t._struct.vertexBundles[n];p=r.view.offset,m=T.view.offset,d=r.view.stride,u=r.view.count+T.view.count,a=new ArrayBuffer(u*d),c=new Uint8Array(a),l=this._data.subarray(p,p+r.view.length),p+=l.length,h=t._data.subarray(m,m+T.view.length),m+=h.length,c.set(l),f=0;for(const t of r.attributes){v=0,x=!1;for(const e of T.attributes){if(t.name===e.name&&t.format===e.format){x=!0;break}v+=Dr[e.format].size}if(x){y=Dr[t.format].size,g=r.view.length+f;for(let n=0;n<T.view.count;++n){if(_=h.subarray(v,v+y),c.set(_,g),(t.name===Ws.ATTR_POSITION||t.name===Ws.ATTR_NORMAL)&&e){const n=new Float32Array(c.buffer,g,3);switch(i.set(n[0],n[1],n[2]),t.name){case Ws.ATTR_POSITION:i.transformMat4(e);break;case Ws.ATTR_NORMAL:ln.transformQuat(i,i,s)}n[0]=i.x,n[1]=i.y,n[2]=i.z}g+=r.view.stride,v+=T.view.stride}}f+=Dr[t.format].size}S[n]={attributes:r.attributes,view:{offset:o.getLength(),length:a.byteLength,count:u,stride:d}},o.addBuffer(a)}let T,E,C,A=0,b=2,w=0;const R=new Array(this._struct.primitives.length);for(let e=0;e<this._struct.primitives.length;++e){const n=this._struct.primitives[e],i=t._struct.primitives[e];R[e]={primitiveMode:n.primitiveMode,vertexBundelIndices:n.vertexBundelIndices};for(const t of n.vertexBundelIndices)w=Math.max(w,this._struct.vertexBundles[t].view.count);if(n.indexView&&i.indexView){A=n.indexView.count,A+=i.indexView.count,p=n.indexView.offset,m=i.indexView.offset,b=A<256?1:A<65536?2:4;const s=new ArrayBuffer(A*b);if(T=2===b?new Uint16Array(s):1===b?new Uint8Array(s):new Uint32Array(s),E=2===n.indexView.stride?new Uint16Array(this._data.buffer,p,n.indexView.count):1===n.indexView.stride?new Uint8Array(this._data.buffer,p,n.indexView.count):new Uint32Array(this._data.buffer,p,n.indexView.count),b===n.indexView.stride)T.set(E);else for(let t=0;t<n.indexView.count;++t)T[t]=E[t];p+=n.indexView.length,C=2===i.indexView.stride?new Uint16Array(t._data.buffer,m,i.indexView.count):1===i.indexView.stride?new Uint8Array(t._data.buffer,m,i.indexView.count):new Uint32Array(t._data.buffer,m,i.indexView.count);for(let t=0;t<i.indexView.count;++t)T[n.indexView.count+t]=w+C[t];m+=i.indexView.length,R[e].indexView={offset:o.getLength(),length:s.byteLength,count:A,stride:b},o.setNextAlignment(b),o.addBuffer(s)}}const I={vertexBundles:S,primitives:R,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return I.minPosition&&t._struct.minPosition&&I.maxPosition&&t._struct.maxPosition&&(e?(ln.add(r.center,t._struct.maxPosition,t._struct.minPosition),ln.multiplyScalar(r.center,r.center,.5),ln.subtract(r.halfExtents,t._struct.maxPosition,t._struct.minPosition),ln.multiplyScalar(r.halfExtents,r.halfExtents,.5),nc.transform(r,r,e),ln.add(i,r.center,r.halfExtents),ln.max(I.maxPosition,I.maxPosition,i),ln.subtract(i,r.center,r.halfExtents),ln.min(I.minPosition,I.minPosition,i)):(ln.min(I.minPosition,I.minPosition,t._struct.minPosition),ln.max(I.maxPosition,I.maxPosition,t._struct.maxPosition))),this.reset({struct:I,data:new Uint8Array(o.getCombined())}),this.initialize(),!0}validateMergingMesh(t){if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(let e=0;e<this._struct.vertexBundles.length;++e){const n=this._struct.vertexBundles[e],i=t._struct.vertexBundles[e];if(n.attributes.length!==i.attributes.length)return!1;for(let t=0;t<n.attributes.length;++t)if(n.attributes[t].format!==i.attributes[t].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(let e=0;e<this._struct.primitives.length;++e){const n=this._struct.primitives[e],i=t._struct.primitives[e];if(n.vertexBundelIndices.length!==i.vertexBundelIndices.length)return!1;for(let t=0;t<n.vertexBundelIndices.length;++t)if(n.vertexBundelIndices[t]!==i.vertexBundelIndices[t])return!1;if(n.primitiveMode!==i.primitiveMode)return!1;if(n.indexView){if(void 0===i.indexView)return!1}else if(i.indexView)return!1}return!0}readAttribute(t,e){let n=null;return this._accessAttribute(t,e,(t,e)=>{const i=t.view.count,{format:s}=t.attributes[e],r=Br(Dr[s]);if(0===i)return;const o=new DataView(this._data.buffer,t.view.offset+AI(t.attributes,e)),a=Dr[s],c=RI(o,s);if(!r||!c)return;const l=a.count,h=new r(i*l),_=t.view.stride;for(let t=0;t<i;++t)for(let e=0;e<l;++e)h[l*t+e]=c(_*t+h.BYTES_PER_ELEMENT*e);n=h}),n}copyAttribute(t,e,n,i,s){let r=!1;return this._accessAttribute(t,e,(t,e)=>{const o=t.view.count;if(0===o)return void(r=!0);const{format:a}=t.attributes[e],c=new DataView(this._data.buffer,t.view.offset+AI(t.attributes,e)),l=new DataView(n,s),h=Dr[a],_=RI(c,a),u=II(l,a);if(!_||!u)return;const d=h.count,p=t.view.stride,m=wI(a),f=i,g=m;for(let t=0;t<o;++t)for(let e=0;e<d;++e)u(f*t+g*e,_(p*t+m*e));r=!0}),r}readIndices(t){if(t>=this._struct.primitives.length)return null;const e=this._struct.primitives[t];if(!e.indexView)return null;const{stride:n}=e.indexView;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)}copyIndices(t,e){if(t>=this._struct.primitives.length)return!1;const n=this._struct.primitives[t];if(!n.indexView)return!1;const i=n.indexView.count,s=1===n.indexView.stride?Xs.R8UI:2===n.indexView.stride?Xs.R16UI:Xs.R32UI,r=RI(new DataView(this._data.buffer),s);for(let t=0;t<i;++t)e[t]=r(n.indexView.offset+Dr[s].size*t);return!0}_accessAttribute(t,e,n){if(t>=this._struct.primitives.length)return;const i=this._struct.primitives[t];for(const t of i.vertexBundelIndices){const i=this._struct.vertexBundles[t],s=i.attributes.findIndex(t=>t.name===e);if(!(s<0)){n(i,s);break}}}_createVertexBuffers(t,e){return this._struct.vertexBundles.map(n=>{const i=t.createBuffer(new uo(Ys.VERTEX,Ks.DEVICE,n.view.length,n.view.stride)),s=new Uint8Array(e,n.view.offset,n.view.length);return this.loaded?i.update(s):this.once("load",()=>{i.update(s)}),i})}}).prototype,"_struct",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),hI=Gl(cI.prototype,"_dataLength",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_I=Gl(cI.prototype,"_hash",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aI=cI))||aI);function AI(t,e){let n=0;for(let i=0;i<e;++i){const e=t[i];n+=Dr[e.format].size}return n}i.Mesh=CI;const{isLittleEndian:bI}=Om;function wI(t){const e=Dr[t];return e.size/e.count}function RI(t,e){const n=Dr[e],i=n.size/n.count;switch(n.type){case Ar.UNORM:switch(i){case 1:return e=>t.getUint8(e);case 2:return e=>t.getUint16(e,bI);case 4:return e=>t.getUint32(e,bI)}break;case Ar.SNORM:case Ar.INT:switch(i){case 1:return e=>t.getInt8(e);case 2:return e=>t.getInt16(e,bI);case 4:return e=>t.getInt32(e,bI)}break;case Ar.UINT:switch(i){case 1:return e=>t.getUint8(e);case 2:return e=>t.getUint16(e,bI);case 4:return e=>t.getUint32(e,bI)}break;case Ar.FLOAT:return e=>t.getFloat32(e,bI)}return null}function II(t,e){const n=Dr[e],i=n.size/n.count;switch(n.type){case Ar.UNORM:switch(i){case 1:return(e,n)=>t.setUint8(e,n);case 2:return(e,n)=>t.setUint16(e,n,bI);case 4:return(e,n)=>t.setUint32(e,n,bI)}break;case Ar.SNORM:case Ar.INT:switch(i){case 1:return(e,n)=>t.setInt8(e,n);case 2:return(e,n)=>t.setInt16(e,n,bI);case 4:return(e,n)=>t.setInt32(e,n,bI)}break;case Ar.UINT:switch(i){case 1:return(e,n)=>t.setUint8(e,n);case 2:return(e,n)=>t.setUint16(e,n,bI);case 4:return(e,n)=>t.setUint32(e,n,bI)}break;case Ar.FLOAT:return(e,n)=>t.setFloat32(e,n,bI)}return null}const PI=[new Yo(Ws.ATTR_POSITION,Xs.RGB32F),new Yo(Ws.ATTR_NORMAL,Xs.RGB32F),new Yo(Ws.ATTR_TEX_COORD,Xs.RG32F),new Yo(Ws.ATTR_TANGENT,Xs.RGBA32F),new Yo(Ws.ATTR_COLOR,Xs.RGBA32F)],OI=new ln;var DI,MI,NI,LI,zI,BI,FI,UI,GI,HI,VI,kI,jI,WI,qI,XI,YI,KI,$I,ZI,JI,QI,tP,eP,nP,iP,sP,rP,oP,aP,cP=Object.freeze({__proto__:null,find:PT,toPPM:function(t,e,n){return`P3 ${e} ${n} 255\n${t.filter((t,e)=>e%4<3).toString()}\n`},readMesh:function(t,e=0){const n={positions:[]},i=new DataView(t.data.buffer,t.data.byteOffset,t.data.byteLength),s=t.struct,r=s.primitives[e];for(const t of r.vertexBundelIndices){const e=s.vertexBundles[t];let r=e.view.offset;const{length:o,stride:a}=e.view;for(const t of e.attributes){const e=oI[t.name];e&&(n[e]=(n[e]||[]).concat(Zv(i,t.format,r,o,a))),r+=Dr[t.format].size}}const o=r.indexView;return n.indices=Zv(i,Xs[`R${8*o.stride}UI`],o.offset,o.length),n},createMesh:function(t,e,n){n=n||{};const i=[];let s=0;const r=[];let o,a=0;const c=t.positions.slice();if(c.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===Ws.ATTR_POSITION){o=e;break}o||(o=PI[0]),i.push(o);const e=Dr[o.format];a=Math.max(a,Math.floor(c.length/e.count)),r.push({offset:s,data:c,attribute:o}),s+=e.size}if(t.normals&&t.normals.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===Ws.ATTR_NORMAL){o=e;break}o||(o=PI[1]);const e=Dr[o.format];i.push(o),a=Math.max(a,Math.floor(t.normals.length/e.count)),r.push({offset:s,data:t.normals,attribute:o}),s+=e.size}if(t.uvs&&t.uvs.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===Ws.ATTR_TEX_COORD){o=e;break}o||(o=PI[2]);const e=Dr[o.format];i.push(o),a=Math.max(a,Math.floor(t.uvs.length/e.count)),r.push({offset:s,data:t.uvs,attribute:o}),s+=e.size}if(t.tangents&&t.tangents.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===Ws.ATTR_TANGENT){o=e;break}o||(o=PI[3]);const e=Dr[o.format];i.push(o),a=Math.max(a,Math.floor(t.tangents.length/e.count)),r.push({offset:s,data:t.tangents,attribute:o}),s+=e.size}if(t.colors&&t.colors.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===Ws.ATTR_COLOR){o=e;break}o||(o=PI[4]);const e=Dr[o.format];i.push(o),a=Math.max(a,Math.floor(t.colors.length/e.count)),r.push({offset:s,data:t.colors,attribute:o}),s+=e.size}if(t.customAttributes)for(const e of t.customAttributes){const t=Dr[e.attr.format];i.push(e.attr),a=Math.max(a,Math.floor(e.values.length/t.count)),r.push({offset:s,data:e.values,attribute:e.attr}),s+=t.size}const l=new uI,h=new ArrayBuffer(a*s),_=new DataView(h);for(const t of r)$v(_,t.data,t.attribute.format,t.offset,s);l.setNextAlignment(0);const u={attributes:i,view:{offset:l.getLength(),length:h.byteLength,count:a,stride:s}};l.addBuffer(h);let d=null,p=0;if(t.indices){const{indices:e}=t;p=e.length,d=new ArrayBuffer(2*p),$v(new DataView(d),e,Xs.R16UI)}const m={primitiveMode:t.primitiveMode||Js.TRIANGLE_LIST,vertexBundelIndices:[0]};d&&(l.setNextAlignment(2),m.indexView={offset:l.getLength(),length:d.byteLength,count:p,stride:2},l.addBuffer(d));let f=t.minPos;if(!f&&n.calculateBounds){f=ln.set(new ln,1/0,1/0,1/0);for(let t=0;t<a;++t)ln.set(OI,c[3*t+0],c[3*t+1],c[3*t+2]),ln.min(f,f,OI)}let g=t.maxPos;if(!g&&n.calculateBounds){g=ln.set(new ln,-1/0,-1/0,-1/0);for(let t=0;t<a;++t)ln.set(OI,c[3*t+0],c[3*t+1],c[3*t+2]),ln.max(g,g,OI)}const v={vertexBundles:[u],primitives:[m]};return f&&(v.minPosition=new ln(f.x,f.y,f.z)),g&&(v.maxPosition=new ln(g.x,g.y,g.z)),e||(e=new CI),e.reset({struct:v,data:new Uint8Array(l.getCombined())}),e},readBuffer:Zv,writeBuffer:$v,mapBuffer:Jv});t("utils",cP);class lP extends Wd{constructor(...t){super(...t),this._morphRenderingInstance=null,this._usedMaterials=new Set}getMacroPatches(t){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(t):void 0}initSubModel(t,e,n){return super.initSubModel(t,e,this._launderMaterial(n))}setSubModelMaterial(t,e){return super.setSubModelMaterial(t,this._launderMaterial(e))}_updateLocalDescriptors(t,e){super._updateLocalDescriptors(t,e),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,e)}_launderMaterial(t){return t}setMorphRendering(t){this._morphRenderingInstance=t}}const hP=jt({OFF:0,ON:1}),_P=jt({OFF:0,ON:1});let uP=(DI=Yl("cc.ModelLightmapSettings"),MI=Jl(eh({formerlySerializedAs:"_recieveShadow"})),DI((zI=Gl((LI=class{constructor(){Ul(this,"texture",zI,this),Ul(this,"uvParam",BI,this),Ul(this,"_bakeable",FI,this),Ul(this,"_castShadow",UI,this),Ul(this,"_receiveShadow",GI,this),Ul(this,"_lightmapSize",HI,this)}get bakeable(){return this._bakeable}set bakeable(t){this._bakeable=t}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t}get receiveShadow(){return this._receiveShadow}set receiveShadow(t){this._receiveShadow=t}get lightmapSize(){return this._lightmapSize}set lightmapSize(t){this._lightmapSize=t}}).prototype,"texture",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BI=Gl(LI.prototype,"uvParam",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new dn}}),FI=Gl(LI.prototype,"_bakeable",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UI=Gl(LI.prototype,"_castShadow",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GI=Gl(LI.prototype,"_receiveShadow",[MI],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),HI=Gl(LI.prototype,"_lightmapSize",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),Gl(LI.prototype,"bakeable",[ch],Object.getOwnPropertyDescriptor(LI.prototype,"bakeable"),LI.prototype),Gl(LI.prototype,"castShadow",[ch],Object.getOwnPropertyDescriptor(LI.prototype,"castShadow"),LI.prototype),Gl(LI.prototype,"receiveShadow",[ch],Object.getOwnPropertyDescriptor(LI.prototype,"receiveShadow"),LI.prototype),Gl(LI.prototype,"lightmapSize",[ch],Object.getOwnPropertyDescriptor(LI.prototype,"lightmapSize"),LI.prototype),NI=LI))||NI),dP=t("MeshRenderer",(VI=Yl("cc.MeshRenderer"),kI=ah(),jI=$l(100),WI=ih(),qI=Ah(hP),XI=_h(),YI=Ah(_P),KI=_h(),$I=Ah(CI),ZI=_h(),JI=lh(),VI(QI=kI(QI=jI(QI=WI(QI=nh((aP=oP=class extends qA{get shadowCastingMode(){return this._shadowCastingMode}set shadowCastingMode(t){this._shadowCastingMode=t,this._updateCastShadow()}get receiveShadow(){return this._shadowReceivingMode}set receiveShadow(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}get mesh(){return this._mesh}set mesh(t){const e=this._mesh;this._mesh=t,this._mesh&&this._mesh.initialize(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}get model(){return this._model}get enableMorph(){return this._enableMorph}set enableMorph(t){this._enableMorph=t}constructor(){super(),Ul(this,"lightmapSettings",eP,this),Ul(this,"_mesh",nP,this),Ul(this,"_shadowCastingMode",iP,this),Ul(this,"_shadowReceivingMode",sP,this),this._modelType=void 0,this._model=null,this._morphInstance=null,Ul(this,"_enableMorph",rP,this),this._modelType=Wd}onLoad(){this._mesh&&this._mesh.initialize(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}onRestore(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}onEnable(){this._model||this._updateModels(),this._attachToScene()}onDisable(){this._model&&this._detachFromScene()}onDestroy(){this._model&&(i.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}setWeights(t,e){this._morphInstance&&this._morphInstance.setWeights(e,t)}setInstancedAttribute(t,e){if(!this.model)return;const{attributes:n,views:i}=this.model.instancedAttributes;for(let s=0;s<n.length;s++)if(n[s].name===t){i[s].set(e);break}}_updateLightmap(t,e,n,i,s){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=s,this._onUpdateLightingmap()}_updateModels(){if(!this.enabledInHierarchy||!this._mesh)return;const t=this._model;t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}_createModel(){const t=this._morphInstance&&this._modelType===Wd?lP:this._modelType,e=this._model=i.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof lP&&e.setMorphRendering(this._morphInstance)}_attachToScene(){if(!this.node.scene||!this._model)return;const t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}_detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}_updateModelParams(){if(!this._mesh||!this._model)return;this.node.hasChangedFlags|=Ol.POSITION,this._model.transform.hasChangedFlags|=Ol.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();const t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(let n=0;n<t;++n){let t=this.getRenderMaterial(n);t&&!t.isValid&&(t=null);const i=e[n];i&&this._model.initSubModel(n,i,t||this._getBuiltinMaterial())}this._model.enabled=!0}_onUpdateLightingmap(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])}_onMaterialModified(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())}_onRebuildPSO(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap())}_onMeshChanged(t){}_clearMaterials(){if(!this._model)return;const t=this._model.subModels;for(let e=0;e<t.length;++e)this._onMaterialModified(e,null)}_getBuiltinMaterial(){return Rd.get("missing-material")}_onVisibilityChange(t){this._model&&(this._model.visFlags=t)}_updateCastShadow(){this._model&&(this._shadowCastingMode===hP.OFF?this._model.castShadow=!1:(this._shadowCastingMode,hP.ON,this._shadowCastingMode,this._model.castShadow=!0))}_updateReceiveShadow(){this._model&&(this._shadowReceivingMode===_P.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}_isBatchingEnabled(){for(let t=0;t<this._materials.length;++t){const e=this._materials[t];if(e)for(let t=0;t<e.passes.length;++t)if(e.passes[t].batchingScheme)return!0}return!1}_watchMorphInMesh(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),!this._enableMorph)return;if(!this._mesh||!this._mesh.struct.morph||!this._mesh.morphRendering)return;const{morph:t}=this._mesh.struct;this._morphInstance=this._mesh.morphRendering.createInstance();const e=this._mesh.struct.primitives.length;for(let n=0;n<e;++n){const e=t.subMeshMorphs[n];if(!e)continue;const i=e.weights||t.weights,s=i?i.slice():new Array(e.targets.length).fill(0);this._morphInstance.setWeights(n,s)}this._model&&this._model instanceof lP&&this._model.setMorphRendering(this._morphInstance)}_syncMorphWeights(t){if(!this._morphInstance)return;const e=this._morphInstance[t];e&&e.renderResources&&e.renderResources.setWeights(e.weights)}},oP.ShadowCastingMode=hP,oP.ShadowReceivingMode=_P,eP=Gl((tP=aP).prototype,"lightmapSettings",[Ql,ch,xh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new uP}}),nP=Gl(tP.prototype,"_mesh",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iP=Gl(tP.prototype,"_shadowCastingMode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hP.OFF}}),sP=Gl(tP.prototype,"_shadowReceivingMode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _P.ON}}),Gl(tP.prototype,"shadowCastingMode",[qI,XI,xh],Object.getOwnPropertyDescriptor(tP.prototype,"shadowCastingMode"),tP.prototype),Gl(tP.prototype,"receiveShadow",[YI,KI,xh],Object.getOwnPropertyDescriptor(tP.prototype,"receiveShadow"),tP.prototype),Gl(tP.prototype,"mesh",[$I,ZI],Object.getOwnPropertyDescriptor(tP.prototype,"mesh"),tP.prototype),Gl(tP.prototype,"enableMorph",[JI,xh],Object.getOwnPropertyDescriptor(tP.prototype,"enableMorph"),tP.prototype),rP=Gl(tP.prototype,"_enableMorph",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),QI=tP))||QI)||QI)||QI)||QI)||QI));function pP(t,e){const n=t.sharedMaterials.length;if(n!==e.sharedMaterials.length)return!1;for(let i=0;i<n;i++)if(t.getRenderMaterial(i)!==e.getRenderMaterial(i))return!1;return!0}var mP,fP,gP,vP,yP,xP,SP,TP;t("BatchingUtility",class{static batchStaticModel(t,e){const n=t.getComponentsInChildren(dP);if(n.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(let t=1;t<n.length;t++){if(!n[0].mesh.validateMergingMesh(n[t].mesh))return console.error(`the meshes of ${n[0].node.name} and ${n[t].node.name} can't be merged`),!1;if(!pP(n[0],n[t]))return console.error(`the materials of ${n[0].node.name} and ${n[t].node.name} can't be merged`),!1}const i=new CI,s=new bn,r=new bn;t.getWorldMatrix(r),bn.invert(r,r);for(let t=0;t<n.length;t++){const e=n[t];e.node.getWorldMatrix(s),bn.multiply(s,r,s),i.merge(n[t].mesh,s),e.enabled=!1}const o=e.addComponent(dP);return o.mesh=i,o.sharedMaterials=n[0].sharedMaterials,!0}static unbatchStaticModel(t,e){const n=t.getComponentsInChildren("cc.MeshRenderer");for(let t=0;t<n.length;t++)n[t].enabled=!0;const i=e.getComponent("cc.MeshRenderer");return i&&i.destroy(),!0}});let EP=t("Skeleton",(mP=Yl("cc.Skeleton"),fP=Ah([ge]),gP=Ah([bn]),mP((xP=Gl((yP=class extends y_{constructor(...t){super(...t),Ul(this,"_joints",xP,this),Ul(this,"_bindposes",SP,this),Ul(this,"_hash",TP,this),this._invBindposes=null}get joints(){return this._joints}set joints(t){this._joints=t}get bindposes(){return this._bindposes}set bindposes(t){this._bindposes=t}get inverseBindposes(){if(!this._invBindposes){this._invBindposes=[];for(let t=0;t<this._bindposes.length;t++){const e=new bn;bn.invert(e,this._bindposes[t]),this._invBindposes.push(e)}}return this._invBindposes}get hash(){if(!this._hash){let t="";for(let e=0;e<this._bindposes.length;e++){const n=this._bindposes[e];t+=`${n.m00.toPrecision(2)} ${n.m01.toPrecision(2)} ${n.m02.toPrecision(2)} ${n.m03.toPrecision(2)} ${n.m04.toPrecision(2)} ${n.m05.toPrecision(2)} ${n.m06.toPrecision(2)} ${n.m07.toPrecision(2)} ${n.m08.toPrecision(2)} ${n.m09.toPrecision(2)} ${n.m10.toPrecision(2)} ${n.m11.toPrecision(2)} ${n.m12.toPrecision(2)} ${n.m13.toPrecision(2)} ${n.m14.toPrecision(2)} ${n.m15.toPrecision(2)}\n`}this._hash=vo(t,666)}return this._hash}destroy(){return i.director.root.dataPoolManager.releaseSkeleton(this),super.destroy()}}).prototype,"_joints",[fP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),SP=Gl(yP.prototype,"_bindposes",[gP],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TP=Gl(yP.prototype,"_hash",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vP=yP))||vP));var CP,AP,bP,wP,RP,IP,PP,OP,DP,MP,NP,LP,zP,BP,FP,UP,GP,HP,VP,kP;i.Skeleton=EP;const jP=jt({LUMINOUS_POWER:0,LUMINANCE:1}),WP=new ln;let qP=Yl("cc.StaticLightSettings")((bP=Gl((AP=class{constructor(){Ul(this,"_baked",bP,this),Ul(this,"_editorOnly",wP,this),Ul(this,"_bakeable",RP,this),Ul(this,"_castShadow",IP,this)}get editorOnly(){return this._editorOnly}set editorOnly(t){this._editorOnly=t}get baked(){return this._baked}set baked(t){this._baked=t}get bakeable(){return this._bakeable}set bakeable(t){this._bakeable=t}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t}}).prototype,"_baked",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wP=Gl(AP.prototype,"_editorOnly",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RP=Gl(AP.prototype,"_bakeable",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),IP=Gl(AP.prototype,"_castShadow",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gl(AP.prototype,"editorOnly",[ch],Object.getOwnPropertyDescriptor(AP.prototype,"editorOnly"),AP.prototype),Gl(AP.prototype,"bakeable",[ch],Object.getOwnPropertyDescriptor(AP.prototype,"bakeable"),AP.prototype),Gl(AP.prototype,"castShadow",[ch],Object.getOwnPropertyDescriptor(AP.prototype,"castShadow"),AP.prototype),CP=AP))||CP,XP=t("Light",(PP=Yl("cc.Light"),OP=_h(),DP=_h(),MP=uh(),NP=_h(),LP=Ah(qP),PP((kP=VP=class extends Nu{get color(){return this._color}set color(t){this._color=t,this._light&&(WP.x=t.r/255,WP.y=t.g/255,WP.z=t.b/255,this._light.color=WP)}get useColorTemperature(){return this._useColorTemperature}set useColorTemperature(t){this._useColorTemperature=t,this._light&&(this._light.useColorTemperature=t)}get colorTemperature(){return this._colorTemperature}set colorTemperature(t){this._colorTemperature=t,this._light&&(this._light.colorTemperature=t)}get staticSettings(){return this._staticSettings}set staticSettings(t){this._staticSettings=t}get type(){return this._type}get baked(){return this.staticSettings.baked}set baked(t){this.staticSettings.baked=t,null!==this._light&&(this._light.baked=t)}constructor(){super(),Ul(this,"_color",FP,this),Ul(this,"_useColorTemperature",UP,this),Ul(this,"_colorTemperature",GP,this),Ul(this,"_staticSettings",HP,this),this._type=Dl.UNKNOWN,this._lightType=void 0,this._light=null,this._lightType=Ll}onLoad(){this._createLight()}onEnable(){this._attachToScene()}onDisable(){this._detachFromScene()}onDestroy(){this._destroyLight()}_createLight(){this._light||(this._light=i.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked}_destroyLight(){this._light&&(i.director.root.destroyLight(this),this._light=null)}_attachToScene(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){const t=this._getRenderScene();switch(this._type){case Dl.DIRECTIONAL:t.addDirectionalLight(this._light),t.setMainLight(this._light);break;case Dl.SPHERE:t.addSphereLight(this._light);break;case Dl.SPOT:t.addSpotLight(this._light)}}}_detachFromScene(){if(this._light&&this._light.scene){const t=this._light.scene;switch(this._type){case Dl.DIRECTIONAL:t.removeDirectionalLight(this._light),t.unsetMainLight(this._light);break;case Dl.SPHERE:t.removeSphereLight(this._light);break;case Dl.SPOT:t.removeSpotLight(this._light)}}}},VP.Type=Dl,VP.PhotometricTerm=jP,FP=Gl((BP=kP).prototype,"_color",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ln.WHITE.clone()}}),UP=Gl(BP.prototype,"_useColorTemperature",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GP=Gl(BP.prototype,"_colorTemperature",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),HP=Gl(BP.prototype,"_staticSettings",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qP}}),Gl(BP.prototype,"color",[OP],Object.getOwnPropertyDescriptor(BP.prototype,"color"),BP.prototype),Gl(BP.prototype,"useColorTemperature",[DP],Object.getOwnPropertyDescriptor(BP.prototype,"useColorTemperature"),BP.prototype),Gl(BP.prototype,"colorTemperature",[fh,MP,NP],Object.getOwnPropertyDescriptor(BP.prototype,"colorTemperature"),BP.prototype),Gl(BP.prototype,"staticSettings",[LP],Object.getOwnPropertyDescriptor(BP.prototype,"staticSettings"),BP.prototype),zP=BP))||zP));var YP,KP,$P,ZP,JP,QP,tO,eO,nO,iO,sO,rO,oO,aO,cO,lO,hO,_O,uO,dO,pO,mO,fO,gO,vO,yO,xO,SO,TO,EO,CO,AO,bO,wO,RO,IO,PO,OO,DO,MO,NO,LO,zO,BO,FO;t("DirectionalLight",(YP=Yl("cc.DirectionalLight"),KP=ah(),$P=ih(),ZP=vh(),JP=_h(),YP(QP=KP(QP=$P(QP=nh((eO=Gl((tO=class extends XP{get illuminance(){return this._illuminance}set illuminance(t){this._illuminance=t,this._light&&(this._light.illuminance=this._illuminance)}constructor(){super(),Ul(this,"_illuminance",eO,this),this._type=Dl.DIRECTIONAL,this._light=null,this._lightType=Fl}_createLight(){super._createLight(),this._light&&(this.illuminance=this._illuminance)}}).prototype,"_illuminance",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),Gl(tO.prototype,"illuminance",[ZP,JP],Object.getOwnPropertyDescriptor(tO.prototype,"illuminance"),tO.prototype),QP=tO))||QP)||QP)||QP)||QP)),t("SphereLight",(nO=Yl("cc.SphereLight"),iO=ah(),sO=ih(),rO=vh(),oO=_h(),aO=vh(),cO=_h(),lO=Ah(jP),hO=_h(),_O=_h(),uO=_h(),nO(dO=iO(dO=sO(dO=nh((mO=Gl((pO=class extends XP{get luminousPower(){return this._luminance*Nl(this._size)}set luminousPower(t){this._luminance=t/Nl(this._size),this._light&&(this._light.luminance=this._luminance)}get luminance(){return this._luminance}set luminance(t){this._luminance=t,this._light&&(this._light.luminance=t)}get term(){return this._term}set term(t){this._term=t}get size(){return this._size}set size(t){this._size=t,this._light&&(this._light.size=t)}get range(){return this._range}set range(t){this._range=t,this._light&&(this._light.range=t)}constructor(){super(),Ul(this,"_size",mO,this),Ul(this,"_luminance",fO,this),Ul(this,"_term",gO,this),Ul(this,"_range",vO,this),this._type=Dl.SPHERE,this._light=null,this._lightType=zp}_createLight(){super._createLight(),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range)}}).prototype,"_size",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),fO=Gl(pO.prototype,"_luminance",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Nl(.15)}}),gO=Gl(pO.prototype,"_term",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jP.LUMINOUS_POWER}}),vO=Gl(pO.prototype,"_range",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Gl(pO.prototype,"luminousPower",[rO,oO],Object.getOwnPropertyDescriptor(pO.prototype,"luminousPower"),pO.prototype),Gl(pO.prototype,"luminance",[aO,cO],Object.getOwnPropertyDescriptor(pO.prototype,"luminance"),pO.prototype),Gl(pO.prototype,"term",[lO,hO],Object.getOwnPropertyDescriptor(pO.prototype,"term"),pO.prototype),Gl(pO.prototype,"size",[_O],Object.getOwnPropertyDescriptor(pO.prototype,"size"),pO.prototype),Gl(pO.prototype,"range",[uO],Object.getOwnPropertyDescriptor(pO.prototype,"range"),pO.prototype),dO=pO))||dO)||dO)||dO)||dO)),t("SpotLight",(yO=Yl("cc.SpotLight"),xO=ah(),SO=ih(),TO=vh(),EO=_h(),CO=vh(),AO=_h(),bO=Ah(jP),wO=_h(),RO=_h(),IO=_h(),PO=uh(),OO=_h(),yO(DO=xO(DO=SO(DO=nh((NO=Gl((MO=class extends XP{get luminousPower(){return this._luminance*Nl(this._size)}set luminousPower(t){this._luminance=t/Nl(this._size),this._light&&(this._light.luminance=this._luminance)}get luminance(){return this._luminance}set luminance(t){this._luminance=t,this._light&&(this._light.luminance=t)}get term(){return this._term}set term(t){this._term=t}get size(){return this._size}set size(t){this._size=t,this._light&&(this._light.size=t)}get range(){return this._range}set range(t){this._range=t,this._light&&(this._light.range=t)}get spotAngle(){return this._spotAngle}set spotAngle(t){this._spotAngle=t,this._light&&(this._light.spotAngle=je(t))}constructor(){super(),Ul(this,"_size",NO,this),Ul(this,"_luminance",LO,this),Ul(this,"_term",zO,this),Ul(this,"_range",BO,this),Ul(this,"_spotAngle",FO,this),this._type=Dl.SPOT,this._light=null,this._lightType=kp}_createLight(){super._createLight(),this._light&&(this.luminance=this._luminance,this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle)}}).prototype,"_size",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),LO=Gl(MO.prototype,"_luminance",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Nl(.15)}}),zO=Gl(MO.prototype,"_term",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jP.LUMINOUS_POWER}}),BO=Gl(MO.prototype,"_range",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),FO=Gl(MO.prototype,"_spotAngle",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),Gl(MO.prototype,"luminousPower",[TO,EO],Object.getOwnPropertyDescriptor(MO.prototype,"luminousPower"),MO.prototype),Gl(MO.prototype,"luminance",[CO,AO],Object.getOwnPropertyDescriptor(MO.prototype,"luminance"),MO.prototype),Gl(MO.prototype,"term",[bO,wO],Object.getOwnPropertyDescriptor(MO.prototype,"term"),MO.prototype),Gl(MO.prototype,"size",[RO],Object.getOwnPropertyDescriptor(MO.prototype,"size"),MO.prototype),Gl(MO.prototype,"range",[IO],Object.getOwnPropertyDescriptor(MO.prototype,"range"),MO.prototype),Gl(MO.prototype,"spotAngle",[fh,PO,OO],Object.getOwnPropertyDescriptor(MO.prototype,"spotAngle"),MO.prototype),DO=MO))||DO)||DO)||DO)||DO));const UO=function(t,e,n){t[e+0]=n.m00,t[e+1]=n.m01,t[e+2]=n.m02,t[e+3]=n.m12,t[e+4]=n.m04,t[e+5]=n.m05,t[e+6]=n.m06,t[e+7]=n.m13,t[e+8]=n.m08,t[e+9]=n.m09,t[e+10]=n.m10,t[e+11]=n.m14};function GO(t,e){const n=4/Math.sqrt(e);return 12*Math.ceil(Math.max(480*n,t)/12)}new vn,new vn,new ln,new vn,new ln;const HO=L_([cr.POINT,cr.POINT,cr.NONE,lr.CLAMP,lr.CLAMP,lr.CLAMP]),VO=new ln,kO=new ln,jO=new ln,WO=new ln,qO=new bn,XO=new bn,YO=new nc,KO=Number.MAX_SAFE_INTEGER;class $O{get pixelsPerJoint(){return this._pixelsPerJoint}constructor(t){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=t;const e=function(t){return t.hasFeature(Rr.TEXTURE_FLOAT)?Xs.RGBA32F:Xs.RGBA8}(this._device);this._formatSize=Dr[e].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new Kp(t),this._pool.initialize({format:e,roundUpFn:GO}),this._customPool=new Kp(t),this._customPool.initialize({format:e,roundUpFn:GO})}clear(){this._pool.destroy(),this._textureBuffers.clear()}registerCustomTextureLayouts(t){for(let e=0;e<t.length;e++){const n=t[e],i=this._customPool.createChunk(n.textureLength);for(let t=0;t<n.contents.length;t++){const e=n.contents[t],{skeleton:s}=e;this._chunkIdxMap.set(s,i);for(let t=0;t<e.clips.length;t++){const n=e.clips[t];this._chunkIdxMap.set(s^n,i)}}}}getDefaultPoseTexture(t,e,n){const i=0^t.hash;let s=this._textureBuffers.get(i)||null;if(s&&s.bounds.has(e.hash))return s.refCount++,s;const{joints:r,bindposes:o}=t;let a=null,c=!1;const l=r.length;if(s)s.refCount++;else{const e=12*l,n=this._chunkIdxMap.get(i),r=void 0!==n?this._customPool.alloc(e*Float32Array.BYTES_PER_ELEMENT,n):this._pool.alloc(e*Float32Array.BYTES_PER_ELEMENT);if(!r)return s;s={pixelOffset:r.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:0,readyToBeDeleted:!1,handle:r},a=new Float32Array(e),c=!0}ln.set(jO,KO,KO,KO),ln.set(WO,-KO,-KO,-KO);const h=e.getBoneSpaceBounds(t);for(let e=0,i=0;e<l;e++,i+=12){const s=n.getChildByPath(r[e]),l=s?$w(s,n,qO):t.inverseBindposes[e],_=h[e];_&&(nc.transform(YO,_,l),YO.getBoundary(VO,kO),ln.min(jO,jO,VO),ln.max(WO,WO,kO)),c&&(s&&bn.multiply(l,l,o[e]),UO(a,i,s?l:bn.IDENTITY))}const _=[new nc];return s.bounds.set(e.hash,_),nc.fromPoints(_[0],jO,WO),c&&(this._pool.update(s.handle,a.buffer),this._textureBuffers.set(i,s)),s}getSequencePoseTexture(t,e,n,i){const s=t.hash^e.hash;let r=this._textureBuffers.get(s)||null;if(r&&r.bounds.has(n.hash))return r.refCount++,r;const{joints:o,bindposes:a}=t,c=Vb.getOrExtract(e),{frames:l}=c.info;let h=null,_=!1;const u=o.length;if(r)r.refCount++;else{const n=12*u*l,o=this._chunkIdxMap.get(s),a=void 0!==o?this._customPool.alloc(n*Float32Array.BYTES_PER_ELEMENT,o):this._pool.alloc(n*Float32Array.BYTES_PER_ELEMENT);if(!a)return null;const c=this._createAnimInfos(t,e,i);r={pixelOffset:a.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:t.hash,clipHash:e.hash,readyToBeDeleted:!1,handle:a,animInfos:c},h=new Float32Array(n),_=!0}const d=n.getBoneSpaceBounds(t),p=[];r.bounds.set(n.hash,p);for(let t=0;t<l;t++)p.push(new nc(KO,KO,KO,-KO,-KO,-KO));for(let e=0,n=0;e<l;e++){const i=p[e];for(let s=0;s<u;s++,n+=12){const{curveData:o,downstream:c,bindposeIdx:l,bindposeCorrection:u}=r.animInfos[s];let p,m=!0;o&&c?p=bn.multiply(qO,o[e],c):o?p=o[e]:c?p=c:(p=t.inverseBindposes[l],m=!1);const f=d[s];if(f){const t=u?bn.multiply(XO,p,u):p;nc.transform(YO,f,t),YO.getBoundary(VO,kO),ln.min(i.center,i.center,VO),ln.max(i.halfExtents,i.halfExtents,kO)}_&&(m&&bn.multiply(qO,p,a[l]),UO(h,n,m?qO:bn.IDENTITY))}nc.fromPoints(i,i.center,i.halfExtents)}return _&&(this._pool.update(r.handle,h.buffer),this._textureBuffers.set(s,r)),r}releaseHandle(t){if(t.refCount>0&&t.refCount--,!t.refCount&&t.readyToBeDeleted){const e=t.skeletonHash^t.clipHash;(void 0!==this._chunkIdxMap.get(e)?this._customPool:this._pool).free(t.handle),this._textureBuffers.get(e)===t&&this._textureBuffers.delete(e)}}releaseSkeleton(t){const e=this._textureBuffers.values();let n=e.next();for(;!n.done;){const i=n.value;i.skeletonHash===t.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=e.next()}}releaseAnimationClip(t){const e=this._textureBuffers.values();let n=e.next();for(;!n.done;){const i=n.value;i.clipHash===t.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=e.next()}}_createAnimInfos(t,e,n){const i=[],{joints:s,bindposes:r}=t,o=s.length,a=Vb.getOrExtract(e);for(let e=0;e<o;e++){let c,l,h=s[e],_=a.data[h],u=n.getChildByPath(h);for(;!_;){const t=h.lastIndexOf("/");if(h=h.substring(0,t),_=a.data[h],u?(c||(c=new bn),bn.fromRTS(qO,u.rotation,u.position,u.scale),bn.multiply(c,qO,c),u=u.parent):l=h,t<0)break}let d,p=e;if(void 0!==l&&_){p=e-1;for(let n=0;n<o;n++)if(s[n]===l){p=n,d=new bn,bn.multiply(d,r[n],t.inverseBindposes[e]);break}}i.push({curveData:_&&_.worldMatrix.values,downstream:c,bindposeIdx:p,bindposeCorrection:d})}return i}}class ZO{constructor(t){this._pool=new Map,this._device=void 0,this._device=t}getData(t="-1"){const e=this._pool.get(t);if(e)return e;const n=this._device.createBuffer(new uo(Ys.UNIFORM|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,Yc.SIZE,Yc.SIZE)),i=new Float32Array([0,0,0,0]);n.update(i);const s={buffer:n,data:i,dirty:!1};return this._pool.set(t,s),s}destroy(t){const e=this._pool.get(t);e&&(e.buffer.destroy(),this._pool.delete(t))}switchClip(t,e){return t.data[0]=0,t.buffer.update(t.data),t.dirty=!1,t}clear(){for(const t of this._pool.values())t.buffer.destroy();this._pool.clear()}}i.internal.DataPoolManager=class{constructor(t){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new $O(t),this.jointAnimationInfo=new ZO(t)}releaseSkeleton(t){this.jointTexturePool.releaseSkeleton(t)}releaseAnimationClip(t){this.jointTexturePool.releaseAnimationClip(t)}clear(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()}};const JO=[{name:"CC_USE_SKINNING",value:!0}];function QO(t,e,n,i){for(let s=0;s<n.length;s++){const r=n[s];let o=-1;for(let t=0;t<r.length;t++)if(r[t]===i){o=t;break}o>=0&&(e.push(s),t.push(o))}}const tD=new ln,eD=new ln,nD=new ln,iD=new ln,sD=new bn,rD=new nc;class oD extends lP{constructor(){super(),this.uploadAnimation=null,this._buffers=[],this._dataArray=[],this._joints=[],this._bufferIndices=null,this.type=Vd.SKINNING}destroy(){if(this.bindSkeleton(),this._buffers.length){for(let t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}super.destroy()}bindSkeleton(t=null,e=null,n=null){for(let t=0;t<this._joints.length;t++)mw(this._joints[t].target);if(this._bufferIndices=null,this._joints.length=0,!t||!e||!n)return;this.transform=e;const i=n.getBoneSpaceBounds(t),s=n.struct.jointMaps;this._ensureEnoughBuffers(s&&s.length||1),this._bufferIndices=n.jointBufferIndices;for(let n=0;n<t.joints.length;n++){const r=i[n],o=e.getChildByPath(t.joints[n]);if(!r||!o)continue;const a=pw(o,e),c=t.bindposes[n],l=[],h=[];s?QO(l,h,s,n):(l.push(n),h.push(0)),this._joints.push({indices:l,buffers:h,bound:r,target:o,bindpose:c,transform:a})}}updateTransform(t){const e=this.transform;(e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdated=!0),ln.set(tD,1/0,1/0,1/0),ln.set(eD,-1/0,-1/0,-1/0);for(let e=0;e<this._joints.length;e++){const{bound:n,transform:i}=this._joints[e],s=dw(i,t);nc.transform(rD,n,s),rD.getBoundary(nD,iD),ln.min(tD,tD,nD),ln.max(eD,eD,iD)}const n=this._worldBounds;this._modelBounds&&n&&(nc.fromPoints(this._modelBounds,tD,eD),this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,this._worldBounds),Ti.setVec3(this._hWorldBounds,xi.CENTER,n.center),Ti.setVec3(this._hWorldBounds,xi.HALF_EXTENSION,n.halfExtents))}updateUBOs(t){super.updateUBOs(t);for(let t=0;t<this._joints.length;t++){const{indices:e,buffers:n,transform:i,bindpose:s}=this._joints[t];bn.multiply(sD,i.world,s);for(let t=0;t<n.length;t++)UO(this._dataArray[n[t]],12*e[t],sD)}for(let t=0;t<this._buffers.length;t++)this._buffers[t].update(this._dataArray[t]);return!0}initSubModel(t,e,n){const i=e.vertexBuffers,s=e.iaInfo;s.vertexBuffers=e.jointMappedBuffers,super.initSubModel(t,e,n),s.vertexBuffers=i}getMacroPatches(t){const e=super.getMacroPatches(t);return e?JO.concat(e):JO}_updateLocalDescriptors(t,e){super._updateLocalDescriptors(t,e);const n=this._buffers[this._bufferIndices[t]];n&&e.bindBuffer(Kc.BINDING,n)}_ensureEnoughBuffers(t){for(let e=0;e<t;e++)this._buffers[e]||(this._buffers[e]=this._device.createBuffer(new uo(Ys.UNIFORM|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,Kc.SIZE,Kc.SIZE))),this._dataArray[e]||(this._dataArray[e]=new Float32Array(Kc.COUNT))}}const aD=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}];class cD extends lP{constructor(){super(),this.uploadedAnim=void 0,this._jointsMedium=void 0,this._skeleton=null,this._mesh=null,this._dataPoolManager=void 0,this._instAnimInfoIdx=-1,this.type=Vd.BAKED_SKINNING,this._dataPoolManager=i.director.root.dataPoolManager;const t=new Float32Array(4),e=this._dataPoolManager.jointAnimationInfo.getData();this._jointsMedium={buffer:null,jointTextureInfo:t,animInfo:e,texture:null,boundsInfo:null}}destroy(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),super.destroy()}bindSkeleton(t=null,e=null,n=null){if(this._skeleton=t,this._mesh=n,!t||!e||!n)return;this.transform=e;const i=this._dataPoolManager;this._jointsMedium.animInfo=i.jointAnimationInfo.getData(e.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new uo(Ys.UNIFORM|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,Xc.SIZE,Xc.SIZE)))}updateTransform(t){if(super.updateTransform(t),!this.uploadedAnim)return;const{animInfo:e,boundsInfo:n}=this._jointsMedium,i=n[e.data[0]],s=this._worldBounds;if(s&&i){const t=this.transform;i.transform(t._mat,t._pos,t._rot,t._scale,s),Ti.setVec3(this._hWorldBounds,xi.CENTER,s.center),Ti.setVec3(this._hWorldBounds,xi.HALF_EXTENSION,s.halfExtents)}}updateUBOs(t){super.updateUBOs(t);const e=this._jointsMedium.animInfo,n=this._instAnimInfoIdx;return n>=0?this.instancedAttributes.views[n][0]=e.data[0]:e.dirty&&(e.buffer.update(e.data),e.dirty=!1),!0}uploadAnimation(t){if(!this._skeleton||!this._mesh||this.uploadedAnim===t)return;this.uploadedAnim=t;const e=this._dataPoolManager;let n=null;t?(n=e.jointTexturePool.getSequencePoseTexture(this._skeleton,t,this._mesh,this.transform),this._jointsMedium.boundsInfo=n&&n.bounds.get(this._mesh.hash),this._modelBounds=null):(n=e.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._modelBounds=n&&n.bounds.get(this._mesh.hash)[0]),this._applyJointTexture(n)}_applyJointTexture(t=null){const e=this._jointsMedium.texture;if(e&&e!==t&&this._dataPoolManager.jointTexturePool.releaseHandle(e),this._jointsMedium.texture=t,!t)return;const{buffer:n,jointTextureInfo:i}=this._jointsMedium;i[0]=t.handle.texture.width,i[1]=this._skeleton.joints.length,i[2]=t.pixelOffset+.1,i[3]=1/i[0],this.updateInstancedJointTextureInfo(),n&&n.update(i);const s=t.handle.texture;for(let t=0;t<this._subModels.length;++t)this._subModels[t].descriptorSet.bindTexture(Zc,s)}getMacroPatches(t){const e=super.getMacroPatches(t);return e?e.concat(aD):aD}_updateLocalDescriptors(t,e){super._updateLocalDescriptors(t,e);const{buffer:n,texture:i,animInfo:s}=this._jointsMedium;if(e.bindBuffer(Xc.BINDING,n),e.bindBuffer(Yc.BINDING,s.buffer),i){const t=z_.getSampler(this._device,HO);e.bindTexture(Zc,i.handle.texture),e.bindSampler(Zc,t)}}_updateInstancedAttributes(t,e){super._updateInstancedAttributes(t,e),this._instAnimInfoIdx=this._getInstancedAttributeIndex("a_jointAnimInfo"),this.updateInstancedJointTextureInfo()}updateInstancedJointTextureInfo(){const{jointTextureInfo:t,animInfo:e}=this._jointsMedium,n=this._instAnimInfoIdx;if(n>=0){const i=this.instancedAttributes.views[n];i[0]=e.data[0],i[1]=t[1],i[2]=t[2]}}}var lD,hD,_D,uD,dD,pD,mD,fD,gD,vD,yD,xD,SD;let TD=t("SkinnedMeshRenderer",(lD=Yl("cc.SkinnedMeshRenderer"),hD=ah(),_D=$l(100),uD=ih(),dD=Ah(EP),pD=Ah(sx),mD=Ah(EP),fD=Ah(sx),gD=_h(),lD(vD=hD(vD=_D(vD=nh(vD=uD((xD=Gl((yD=class extends dP{get skeleton(){return this._skeleton}set skeleton(t){t!==this._skeleton&&(this._skeleton=t,this._update())}get skinningRoot(){return this._skinningRoot}set skinningRoot(t){t!==this._skinningRoot&&(this._skinningRoot=t,this._updateModelType(),this._update())}get model(){return this._model}constructor(){super(),Ul(this,"_skeleton",xD,this),Ul(this,"_skinningRoot",SD,this),this._clip=null,this._modelType=cD}__preload(){this._updateModelType()}uploadAnimation(t){this._clip=t,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(t)}setUseBakedAnimation(t=!0){const e=t?cD:oD;this._modelType!==e&&(this._modelType=e,this._model&&(i.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))}setMaterial(t,e){super.setMaterial(t,e),this._modelType===oD&&this.getMaterialInstance(e)}_updateModelParams(){this._update(),super._updateModelParams()}_updateModelType(){if(!this._skinningRoot)return;const t=this._skinningRoot.getComponent("cc.SkeletalAnimation");t&&this.setUseBakedAnimation(t.useBakedAnimation)}_update(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))}}).prototype,"_skeleton",[dD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SD=Gl(yD.prototype,"_skinningRoot",[pD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gl(yD.prototype,"skeleton",[mD],Object.getOwnPropertyDescriptor(yD.prototype,"skeleton"),yD.prototype),Gl(yD.prototype,"skinningRoot",[fD,gD],Object.getOwnPropertyDescriptor(yD.prototype,"skinningRoot"),yD.prototype),vD=yD))||vD)||vD)||vD)||vD)||vD));var ED,CD,AD,bD,wD,RD,ID,PD,OD,DD,MD,ND,LD,zD,BD,FD,UD,GD,HD,VD,kD,jD,WD,qD,XD,YD,KD,$D,ZD;const JD=new Yo(Ws.ATTR_BATCH_ID,Xs.R32F),QD=new Yo(Ws.ATTR_BATCH_UV,Xs.RG32F),tM=Dr[JD.format].size+Dr[QD.format].size;let eM=t("SkinnedMeshUnit",(ED=Yl("cc.SkinnedMeshUnit"),CD=Ah(CI),AD=Ah(EP),bD=Ah(Ap),wD=Ah(TD),ED((PD=Gl((ID=class{constructor(){Ul(this,"mesh",PD,this),Ul(this,"skeleton",OD,this),Ul(this,"material",DD,this),Ul(this,"_localTransform",MD,this),Ul(this,"_offset",ND,this),Ul(this,"_size",LD,this)}set offset(t){rn.copy(this._offset,t)}get offset(){return this._offset}set size(t){rn.copy(this._size,t)}get size(){return this._size}set copyFrom(t){t&&(this.mesh=t.mesh,this.skeleton=t.skeleton,this.material=t.getMaterial(0),t.skinningRoot&&$w(t.node,t.skinningRoot,this._localTransform))}get copyFrom(){return null}}).prototype,"mesh",[CD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OD=Gl(ID.prototype,"skeleton",[AD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DD=Gl(ID.prototype,"material",[bD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MD=Gl(ID.prototype,"_localTransform",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bn}}),ND=Gl(ID.prototype,"_offset",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rn(0,0)}}),LD=Gl(ID.prototype,"_size",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rn(1,1)}}),Gl(ID.prototype,"offset",[ch],Object.getOwnPropertyDescriptor(ID.prototype,"offset"),ID.prototype),Gl(ID.prototype,"size",[ch],Object.getOwnPropertyDescriptor(ID.prototype,"size"),ID.prototype),Gl(ID.prototype,"copyFrom",[wD],Object.getOwnPropertyDescriptor(ID.prototype,"copyFrom"),ID.prototype),RD=ID))||RD));const nM=new bn,iM=(new bn,new ln);t("SkinnedMeshBatchRenderer",(zD=Yl("cc.SkinnedMeshBatchRenderer"),BD=ah(),FD=$l(100),UD=ih(),GD=_h(),HD=Ah([ge]),VD=_h(),kD=Ah([eM]),jD=_h(),WD=lh(),qD=lh(),zD(XD=BD(XD=FD(XD=nh(XD=UD((KD=Gl((YD=class extends TD{constructor(...t){super(...t),Ul(this,"atlasSize",KD,this),Ul(this,"batchableTextureNames",$D,this),Ul(this,"units",ZD,this),this._textures={},this._batchMaterial=null}get mesh(){return super.mesh}set mesh(t){super.mesh=t}get skeleton(){return super.skeleton}set skeleton(t){super.skeleton=t}onLoad(){super.onLoad(),this.cook()}onDestroy(){for(const t in this._textures)this._textures[t].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),super.onDestroy()}_onMaterialModified(t,e){this.cookMaterials(),super._onMaterialModified(t,this.getMaterialInstance(t))}cook(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()}cookMaterials(){this._batchMaterial||(this._batchMaterial=this.getMaterial(0));const t=this.getMaterialInstance(0);if(!t||!this._batchMaterial||!this._batchMaterial.effectAsset)return void console.warn("incomplete batch material!");t.copy(this._batchMaterial),this.resizeAtlases();const e=t.effectAsset.techniques[t.technique];for(let n=0;n<e.passes.length;n++){const i=e.passes[n];if(i.properties)for(const e in i.properties)if(i.properties[e].type>=qs.SAMPLER1D){let i=null;this.batchableTextureNames.find(t=>t===e)?(i=this._textures[e],i||(i=this.createTexture(e)),this.cookTextures(i,e,n)):this.units.some(t=>i=t.material&&t.material.getProperty(e,n)),i&&t.setProperty(e,i,n)}else{const i=[];for(let t=0;t<this.units.length;t++){const s=this.units[t];s.material&&i.push(s.material.getProperty(e.slice(0,-3),n))}t.setProperty(e,i,n)}}}cookSkeletons(){if(!this._skinningRoot)return void console.warn("no skinning root specified!");const t=[],e=[];for(let n=0;n<this.units.length;n++){const i=this.units[n];if(!i||!i.skeleton)continue;const s=i.skeleton;bn.invert(nM,i._localTransform);for(let n=0;n<s.joints.length;n++){const i=s.joints[n];t.findIndex(t=>t===i)>=0||(t.push(i),e.push(bn.multiply(new bn,s.bindposes[n]||bn.IDENTITY,nM)))}}const n=Array.from(Array(t.length).keys()).sort((e,n)=>t[e]>t[n]?1:t[e]<t[n]?-1:0),i=new EP;i.joints=t.map((t,e,i)=>i[n[e]]),i.bindposes=e.map((t,e,i)=>i[n[e]]),this._skeleton&&this._skeleton.destroy(),this.skeleton=i}cookMeshes(){let t=!1;for(let e=0;e<this.units.length;e++)if(this.units[e].mesh){t=!0;break}if(!t||!this._skinningRoot)return;this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new CI;let e=0,n=Xs.UNKNOWN,i=0,s=Xs.UNKNOWN,r=0,o=Xs.UNKNOWN,a=0,c=Xs.UNKNOWN,l=0,h=Xs.UNKNOWN;const _=new Array(this.units.length),u=this.units.length;for(let t=0;t<u;t++){const e=this.units[t];e&&e.skeleton&&(_[t]=e.skeleton.joints.map(t=>this._skeleton.joints.findIndex(e=>t===e)))}for(let t=0;t<u;t++){const u=this.units[t];if(!u||!u.mesh||!u.mesh.data)continue;const d=this._createUnitMesh(t,u.mesh),p=new DataView(d.data.buffer);bn.inverseTranspose(nM,u._localTransform);const{offset:m}=u,{size:f}=u;for(let g=0;g<d.struct.vertexBundles.length;g++){const v=d.struct.vertexBundles[g];e=v.view.offset,n=Xs.UNKNOWN;for(let t=0;t<v.attributes.length;t++){const i=v.attributes[t];if(i.name===Ws.ATTR_POSITION){n=i.format;break}e+=Dr[i.format].size}if(n){const t=Zv(p,n,e,v.view.length,v.view.stride);for(let e=0;e<t.length;e+=3)ln.fromArray(iM,t,e),ln.transformMat4(iM,iM,u._localTransform),ln.toArray(t,iM,e);$v(p,t,n,e,v.view.stride)}i=v.view.offset,s=Xs.UNKNOWN;for(let t=0;t<v.attributes.length;t++){const e=v.attributes[t];if(e.name===Ws.ATTR_NORMAL){s=e.format;break}i+=Dr[e.format].size}if(s){const t=Zv(p,s,i,v.view.length,v.view.stride);for(let e=0;e<t.length;e+=3)ln.fromArray(iM,t,e),ln.transformMat4Normal(iM,iM,nM),ln.toArray(t,iM,e);$v(p,t,s,i,v.view.stride)}r=v.view.offset,o=Xs.UNKNOWN;for(let t=0;t<v.attributes.length;t++){const e=v.attributes[t];if(e.name===Ws.ATTR_TANGENT){o=e.format;break}r+=Dr[e.format].size}if(o){const t=Zv(p,o,r,v.view.length,v.view.stride);for(let e=0;e<t.length;e+=3)ln.fromArray(iM,t,e),ln.transformMat4Normal(iM,iM,nM),ln.toArray(t,iM,e);$v(p,t,o,r,v.view.stride)}a=v.view.offset,c=Xs.UNKNOWN;for(let t=0;t<v.attributes.length;t++){const e=v.attributes[t];if(e.name===Ws.ATTR_BATCH_UV){c=e.format;break}a+=Dr[e.format].size}c&&Jv(p,(t,e)=>{var n;const i=0===e?"x":"y";return(t=(n=t)-Math.floor(n))*f[i]+m[i]},c,a,v.view.length,v.view.stride,p);const y=_[t];if(y){l=v.view.offset,h=Xs.UNKNOWN;for(let t=0;t<v.attributes.length;t++){const e=v.attributes[t];if(e.name===Ws.ATTR_JOINTS){h=e.format;break}l+=Dr[e.format].size}h&&Jv(p,t=>y[t],h,l,v.view.length,v.view.stride,p)}}this._mesh.merge(d)}this._onMeshChanged(this._mesh),this._updateModels()}cookTextures(t,e,n){const s=[],r=[],o=[],a=[];for(let t=0;t<this.units.length;t++){const i=this.units[t];if(!i.material)continue;const c=i.material.getProperty(e,n);if(c&&c.image&&c.image.data){const t=new Wr;t.texOffset.x=i.offset.x*this.atlasSize,t.texOffset.y=i.offset.y*this.atlasSize,t.texExtent.width=i.size.x*this.atlasSize,t.texExtent.height=i.size.y*this.atlasSize;const{data:e}=c.image;ArrayBuffer.isView(e)?(o.push(e),a.push(t)):(s.push(e),r.push(t))}}const c=t.getGFXTexture(),{device:l}=i.director.root;o.length>0&&l.copyBuffersToTexture(o,c,a),s.length>0&&l.copyTexImagesToTexture(s,c,r)}createTexture(t){const e=new Zu;return e.setFilters(T_.LINEAR,T_.LINEAR),e.setMipFilter(T_.NEAREST),e.reset({width:this.atlasSize,height:this.atlasSize,format:x_.RGBA8888}),e.loaded=!0,this._textures[t]=e,e}resizeAtlases(){for(const t in this._textures)this._textures[t].reset({width:this.atlasSize,height:this.atlasSize,format:x_.RGBA8888})}_createUnitMesh(t,e){const n=JSON.parse(JSON.stringify(e.struct)),s={};for(let t=0;t<e.struct.primitives.length;t++){const i=e.struct.primitives[t];let r=0,o=Xs.UNKNOWN,a=0;for(;a<i.vertexBundelIndices.length;a++){const t=e.struct.vertexBundles[i.vertexBundelIndices[a]];r=t.view.offset,o=Xs.UNKNOWN;for(let e=0;e<t.attributes.length;e++){const n=t.attributes[e];if(n.name===Ws.ATTR_TEX_COORD){o=n.format;break}r+=Dr[n.format].size}if(o)break}if(void 0!==s[a])continue;s[a]=[o,r];const c=n.vertexBundles[a];c.attributes.push(JD),c.attributes.push(QD),c.view.offset=0,c.view.length+=c.view.count*tM,c.view.stride+=tM}let r=0;for(let t=0;t<n.vertexBundles.length;t++)r+=n.vertexBundles[t].view.length;for(let t=0;t<n.primitives.length;t++){const e=n.primitives[t];e.indexView&&(e.indexView.offset=r,r+=e.indexView.length)}const o=new Uint8Array(r),a=e.data,c=new DataView(o.buffer),l=new DataView(a.buffer),{isLittleEndian:h}=i.sys;for(const i in s){const r=n.vertexBundles[i],_=e.struct.vertexBundles[i],[u,d]=s[i],p=Zv(l,u,d,_.view.length,_.view.stride),m=_.view,f=r.view,g=m.stride,v=f.stride;let y=m.offset,x=f.offset;for(let e=0;e<f.count;e++){const n=a.subarray(y,y+g);o.set(n,x),c.setFloat32(x+g,t),c.setFloat32(x+g+4,p[2*e],h),c.setFloat32(x+g+8,p[2*e+1],h),x+=v,y+=g}}for(let t=0;t<n.primitives.length;t++){const i=e.struct.primitives[t],s=n.primitives[t];if(i.indexView&&s.indexView){const t=i.indexView.stride,e=s.indexView.stride;let n=i.indexView.offset,r=s.indexView.offset;for(let i=0;i<s.indexView.count;i++){const i=a.subarray(n,n+t);o.set(i,r),r+=e,n+=t}}}const _=new CI;return _.reset({struct:n,data:o}),_}}).prototype,"atlasSize",[Ql,GD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),$D=Gl(YD.prototype,"batchableTextureNames",[HD,Ql,VD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZD=Gl(YD.prototype,"units",[kD,Ql,jD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gl(YD.prototype,"mesh",[bh,WD],Object.getOwnPropertyDescriptor(YD.prototype,"mesh"),YD.prototype),Gl(YD.prototype,"skeleton",[bh,qD],Object.getOwnPropertyDescriptor(YD.prototype,"skeleton"),YD.prototype),XD=YD))||XD)||XD)||XD)||XD)||XD));const sM=new bn,rM=new bn,oM=[];class aM extends ww{constructor(t,e=""){super(t,e),this._frames=1,this._bakedDuration=0,this._animInfo=null,this._sockets=[],this._animInfoMgr=void 0,this._comps=[],this._parent=null,this._curvesInited=!1,this._animInfoMgr=i.director.root.dataPoolManager.jointAnimationInfo}initialize(t){if(this._curveLoaded)return;this._comps.length=0;const e=t.getComponentsInChildren(TD);for(let n=0;n<e.length;++n){const i=e[n];i.skinningRoot===t&&this._comps.push(i)}this._parent=t.getComponent("cc.SkeletalAnimation");const n=this._parent.useBakedAnimation;super.initialize(t,n?oM:void 0),this._curvesInited=!n;const{info:i}=Vb.getOrExtract(this.clip);this._frames=i.frames-1,this._animInfo=this._animInfoMgr.getData(t.uuid),this._bakedDuration=this._frames/i.sample}onPlay(){if(super.onPlay(),this._parent.useBakedAnimation){this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration,this._animInfoMgr.switchClip(this._animInfo,this.clip);for(let t=0;t<this._comps.length;++t)this._comps[t].uploadAnimation(this.clip)}else this._sampleCurves=super._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,super.initialize(this._targetNode),this._curvesInited=!0)}rebuildSocketCurves(t){if(this._sockets.length=0,!this._targetNode)return;const e=this._targetNode;for(let n=0;n<t.length;++n){const i=t[n],s=e.getChildByPath(i.path);if(!i.target)continue;const r=Vb.getOrExtract(this.clip);let o,a=i.path,c=r.data[a],l=s;for(;!c;){const t=a.lastIndexOf("/");if(a=a.substring(0,t),c=r.data[a],l&&(o||(o=bn.identity(rM)),bn.fromRTS(sM,l.rotation,l.position,l.scale),bn.multiply(o,sM,o),l=l.parent),t<0)break}const h=c&&c.worldMatrix.values,{frames:_}=r.info,u=[];for(let t=0;t<_;t++){let e;e=h&&o?bn.multiply(sM,h[t],o):h?h[t]:o||bn.IDENTITY;const n={pos:new ln,rot:new vn,scale:new ln};bn.toRTS(e,n.rot,n.pos,n.scale),u.push(n)}this._sockets.push({target:i.target,frames:u})}}_sampleCurvesBaked(t){const e=this._animInfo,n=t*this._frames+.5|0;if(n!==e.data[0]){e.data[0]=n,e.dirty=!0;for(let t=0;t<this._sockets.length;++t){const{target:e,frames:i}=this._sockets[t],{pos:s,rot:r,scale:o}=i[n];e.setRTS(r,s,o)}}}}var cM,lM,hM,_M,uM,dM,pM,mM,fM,gM,vM,yM,xM,SM,TM,EM,CM,AM,bM,wM;t("SkeletalAnimationState",aM);let RM=t("Socket",(cM=Yl("cc.SkeletalAnimation.Socket"),lM=Ah(sx),cM((uM=Gl((_M=class{constructor(t="",e=null){Ul(this,"path",uM,this),Ul(this,"target",dM,this),this.path=t,this.target=e}}).prototype,"path",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dM=Gl(_M.prototype,"target",[lM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hM=_M))||hM));Vt.setClassAlias(RM,"cc.SkeletalAnimationComponent.Socket");const IM=new bn,PM=new bn;function OM(t,e="",n=[]){for(let i=0;i<t.children.length;i++){const s=t.children[i];if(!s)continue;const r=e?`${e}/${s.name}`:s.name;n.push(r),OM(s,r,n)}return n}t("SkeletalAnimation",(pM=Yl("cc.SkeletalAnimation"),mM=ah(),fM=$l(99),gM=ih(),vM=Ah([RM]),yM=_h(),xM=_h(),SM=Ah([RM]),pM(TM=mM(TM=fM(TM=nh(TM=gM((wM=bM=class extends Xw{constructor(...t){super(...t),Ul(this,"_useBakedAnimation",CM,this),Ul(this,"_sockets",AM,this)}get sockets(){return this._sockets}set sockets(t){if(!this._useBakedAnimation){const e=i.director.getAnimationManager();e.removeSockets(this.node,this._sockets),e.addSockets(this.node,t)}this._sockets=t,this.rebuildSocketAnimations()}get useBakedAnimation(){return this._useBakedAnimation}set useBakedAnimation(t){this._useBakedAnimation=t;const e=this.node.getComponentsInChildren(TD);for(let t=0;t<e.length;++t){const n=e[t];n.skinningRoot===this.node&&n.setUseBakedAnimation(this._useBakedAnimation)}this._useBakedAnimation?i.director.getAnimationManager().removeSockets(this.node,this._sockets):i.director.getAnimationManager().addSockets(this.node,this._sockets)}onDestroy(){super.onDestroy(),i.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),i.director.getAnimationManager().removeSockets(this.node,this._sockets)}start(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,super.start()}querySockets(){const t=this._defaultClip&&Object.keys(Vb.getOrExtract(this._defaultClip).data).sort().reduce((t,e)=>(e.startsWith(t[t.length-1])||t.push(e),t),[])||[];if(!t.length)return["please specify a valid default animation clip first"];const e=[];for(let n=0;n<t.length;n++){const i=t[n],s=this.node.getChildByPath(i);s&&(e.push(i),OM(s,i,e))}return e}rebuildSocketAnimations(){for(const t of this._sockets){const e=this.node.getChildByPath(t.path),{target:n}=t;e&&n&&(n.name=t.path.substring(t.path.lastIndexOf("/")+1)+" Socket",n.parent=this.node,$w(e,this.node,IM),bn.fromRTS(PM,n.rotation,n.position,n.scale),bn.equals(PM,IM)||(n.matrix=IM))}for(const t of Object.keys(this._nameToState))this._nameToState[t].rebuildSocketCurves(this._sockets)}createSocket(t){const e=this._sockets.find(e=>e.path===t);if(e)return e.target;if(!this.node.getChildByPath(t))return console.warn("illegal socket path"),null;const n=new sx;return n.parent=this.node,this._sockets.push(new RM(t,n)),this.rebuildSocketAnimations(),n}_createState(t,e){return new aM(t,e)}_doCreateState(t,e){const n=super._doCreateState(t,e);return n.rebuildSocketCurves(this._sockets),n}},bM.Socket=RM,Gl((EM=wM).prototype,"sockets",[vM,yM],Object.getOwnPropertyDescriptor(EM.prototype,"sockets"),EM.prototype),Gl(EM.prototype,"useBakedAnimation",[xM],Object.getOwnPropertyDescriptor(EM.prototype,"useBakedAnimation"),EM.prototype),CM=Gl(EM.prototype,"_useBakedAnimation",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),AM=Gl(EM.prototype,"_sockets",[SM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TM=EM))||TM)||TM)||TM)||TM)||TM)),i.utils=cP;const DM=new ln,MM=new bn;function NM(t,e,n,i){const s=n.data;let r=e.acquireBufferBatch(),o=r.byteOffset>>2,a=n.vertexCount,c=r.indicesOffset,l=r.vertexOffset;r.request(a,n.indicesCount)||(r=e.currBufferBatch,a=0,c=0,l=0);const h=r.vData,_=r.iData;t.getWorldMatrix(MM);for(let t=0;t<a;t++){const e=s[t];ln.set(DM,e.x,e.y,0),ln.transformMat4(DM,DM,MM),h[o++]=DM.x,h[o++]=DM.y,h[o++]=DM.z,h[o++]=e.u,h[o++]=e.v,Ln.toArray(h,i,o),o+=4}for(let t=0,e=a/4;t<e;t++){const e=l+4*t;_[c++]=e,_[c++]=e+1,_[c++]=e+2,_[c++]=e+1,_[c++]=e+3,_[c++]=e+2}}class LM{constructor(t,e){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;const n=new zM;n.initWithSize(t,e),this._texture=n,this._width=t,this._height=e,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}insertSpriteFrame(t){const e=t.rect,n=t.texture,s=this._innerTextureInfos[n.getId()];let r=e.x,o=e.y;if(s)r+=s.x,o+=s.y;else{const t=n.width,e=n.height;if(this._x+t+2>this._width&&(this._x=2,this._y=this._nexty),this._y+e+2>this._nexty&&(this._nexty=this._y+e+2),this._nexty>this._height)return null;i.internal.dynamicAtlasManager.textureBleeding&&((t<=8||e<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,r+=this._x,o+=this._y,this._x+=t+2}const a={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(t),a}deleteInnerTexture(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)}isEmpty(){return this._count<=0}reset(){this._x=2,this._y=2,this._nexty=2;const t=this._innerSpriteFrames;for(let e=0,n=t.length;e<n;e++){const n=t[e];n.isValid&&n._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}}destroy(){this.reset(),this._texture.destroy()}}class zM extends Zu{initWithSize(t,e,n=x_.RGBA8888){this.reset({width:t,height:e,format:n}),this.loaded=!0,this.emit("load")}drawTextureAt(t,e,n){const i=this.getGFXTexture();if(!t||!i)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const r=new Wr;r.texOffset.x=e,r.texOffset.y=n,r.texExtent.width=t.width,r.texExtent.height=t.height,s.copyTexImagesToTexture([t.data],i,[r])}}class BM{constructor(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){this._enabled!==t&&(t?(this.reset(),i.director.on(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):i.director.off(i.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this),this._enabled=t)}get maxAtlasCount(){return this._maxAtlasCount}set maxAtlasCount(t){this._maxAtlasCount=t}get atlasCount(){return this._atlases.length}get textureBleeding(){return this._textureBleeding}set textureBleeding(t){this._textureBleeding=t}get textureSize(){return this._textureSize}set textureSize(t){this._textureSize=t}get maxFrameSize(){return this._maxFrameSize}set maxFrameSize(t){this._maxFrameSize=t}newAtlas(){let t=this._atlases[++this._atlasIndex];return t||(t=new LM(this._textureSize,this._textureSize),this._atlases.push(t)),t}beforeSceneLoad(){this.reset()}insertSpriteFrame(t){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!t||t._original)return null;if(!t.packable)return null;let e=this._atlases[this._atlasIndex];e||(e=this.newAtlas());const n=e.insertSpriteFrame(t);return n||this._atlasIndex===this._maxAtlasCount?n:(e=this.newAtlas(),e.insertSpriteFrame(t))}reset(){for(let t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1}deleteAtlasSpriteFrame(t){if(!t._original)return;const e=t._original._texture;this.deleteAtlasTexture(e)}deleteAtlasTexture(t){if(t)for(let e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)}packToDynamicAtlas(t,e){if(!e._original&&e.packable){const t=this.insertSpriteFrame(e);t&&e._setDynamicAtlasFrame(t)}}}BM.instance=void 0;const FM=t("dynamicAtlasManager",BM.instance=new BM);var UM;i.internal.dynamicAtlasManager=FM;const GM=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}];let HM=t("SpriteFrame",Yl("cc.SpriteFrame")(UM=class t extends y_{static createWithImage(e){const n=e instanceof P_?e:new P_(e),i=new Zu;i.image=n;const s=new t;return s.texture=i,s}get insetTop(){return this._capInsets[1]}set insetTop(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}get insetBottom(){return this._capInsets[3]}set insetBottom(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}get insetLeft(){return this._capInsets[0]}set insetLeft(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}get insetRight(){return this._capInsets[2]}set insetRight(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}get rect(){return this._rect}set rect(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV())}get originalSize(){return this._originalSize}set originalSize(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV())}get offset(){return this._offset}set offset(t){this._offset.set(t)}get rotated(){return this._rotated}set rotated(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}get texture(){return this._texture}set texture(t){t?this.reset({texture:t},!0):console.warn("Error Texture in "+this.name)}get atlasUuid(){return this._atlasUuid}set atlasUuid(t){this._atlasUuid=t}get width(){return this._texture.width}get height(){return this._texture.height}set _textureSource(t){window.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}get flipUVX(){return this._isFlipUVX}set flipUVX(t){this._isFlipUVX=t,this._calculateUV()}get flipUVY(){return this._isFlipUVY}set flipUVY(t){this._isFlipUVY=t,this._calculateUV()}get packable(){return this._packable}set packable(t){this._packable=t}get original(){return this._original}constructor(){super(),this.vertices=null,this.uv=[],this.uvHash=0,this.unbiasUV=[],this.uvSliced=[],this._rect=new Mn,this._offset=new rn,this._originalSize=new On,this._rotated=!1,this._capInsets=[0,0,0,0],this._atlasUuid="",this._texture=void 0,this._isFlipUVY=!1,this._isFlipUVX=!1,this._original=null,this._packable=!0}textureLoaded(){return this.texture&&this.texture.loaded}isRotated(){return this._rotated}setRotated(t){this.rotated=t}getRect(t){return t?(t.set(this._rect),t):this._rect.clone()}setRect(t){this.rect=t}getOriginalSize(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()}setOriginalSize(t){this.originalSize=t}getOffset(t){return t?(t.set(this._offset),t):this._offset.clone()}setOffset(t){this.offset=t}getGFXTexture(){return this._texture.getGFXTexture()}getGFXSampler(){return this._texture.getGFXSampler()}getHash(){return this._texture.getHash()}getSamplerHash(){return this._texture.getSamplerHash()}reset(t,e=!1){let n=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),t&&(t.texture&&(this.loaded=!1,this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()}checkRect(t){const e=this._rect;let n=e.x,i=e.y;return this._rotated?(n+=e.height,i+=e.width):(n+=e.width,i+=e.height),n>t.width?(T(3300,`${this.name}/${t.name}`,n,t.width),!1):!(i>t.height&&(T(3301,`${this.name}/${t.name}`,i,t.height),1))}onLoaded(){this.loaded=!0,this.emit("load")}destroy(){return this._packable&&FM&&FM.deleteAtlasSpriteFrame(this),super.destroy()}_calculateSlicedUV(){const t=this._rect,e=this.texture,n=e.width,i=e.height,s=this._capInsets[0],r=this._capInsets[2],o=t.width-s-r,a=this._capInsets[1],c=this._capInsets[3],l=t.height-a-c,h=this.uvSliced;if(h.length=0,this._rotated){GM[0].u=(t.x+.5)/n,GM[1].u=(t.x+c)/n,GM[2].u=(t.x+c+l)/n,GM[3].u=(t.x+t.height-.5)/n,GM[3].v=(t.y+.5)/i,GM[2].v=(t.y+s)/i,GM[1].v=(t.y+s+o)/i,GM[0].v=(t.y+t.width-.5)/i;for(let t=0;t<4;++t){const e=GM[t];for(let t=0;t<4;++t){const n=GM[3-t];h.push({u:e.u,v:n.v})}}}else{GM[0].u=(t.x+.5)/n,GM[1].u=(t.x+s)/n,GM[2].u=(t.x+s+o)/n,GM[3].u=(t.x+t.width-.5)/n,GM[3].v=(t.y+.5)/i,GM[2].v=(t.y+a)/i,GM[1].v=(t.y+a+l)/i,GM[0].v=(t.y+t.height-.5)/i;for(let t=0;t<4;++t){const e=GM[t];for(let t=0;t<4;++t){const n=GM[t];h.push({u:n.u,v:e.v})}}}}_calculateUV(){const t=this._rect,e=this.uv,n=this.unbiasUV,i=this.texture,s=i.width,r=i.height;if(this._rotated){const i=0===s?0:(t.x+.5)/s,o=0===s?0:(t.x+t.height-.5)/s,a=0===r?0:(t.y+.5)/r,c=0===r?0:(t.y+t.width-.5)/r;this._isFlipUVX&&this._isFlipUVY?(e[0]=o,e[1]=c,e[2]=o,e[3]=a,e[4]=i,e[5]=c,e[6]=i,e[7]=a):this._isFlipUVX?(e[0]=o,e[1]=a,e[2]=o,e[3]=c,e[4]=i,e[5]=a,e[6]=i,e[7]=c):this._isFlipUVY?(e[0]=i,e[1]=c,e[2]=i,e[3]=a,e[4]=o,e[5]=c,e[6]=o,e[7]=a):(e[0]=i,e[1]=a,e[2]=i,e[3]=c,e[4]=o,e[5]=a,e[6]=o,e[7]=c);const l=0===s?0:t.x/s,h=0===s?0:(t.x+t.height)/s,_=0===r?0:t.y/r,u=0===r?0:(t.y+t.width)/r;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=u,n[2]=h,n[3]=_,n[4]=l,n[5]=u,n[6]=l,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=h,n[3]=u,n[4]=l,n[5]=_,n[6]=l,n[7]=u):this._isFlipUVY?(n[0]=l,n[1]=u,n[2]=l,n[3]=_,n[4]=h,n[5]=u,n[6]=h,n[7]=_):(n[0]=l,n[1]=_,n[2]=l,n[3]=u,n[4]=h,n[5]=_,n[6]=h,n[7]=u)}else{const i=0===s?0:(t.x+.5)/s,o=0===s?0:(t.x+t.width-.5)/s,a=0===r?0:(t.y+t.height-.5)/r,c=0===r?0:(t.y+.5)/r;this._isFlipUVX&&this._isFlipUVY?(e[0]=o,e[1]=c,e[2]=i,e[3]=c,e[4]=o,e[5]=a,e[6]=i,e[7]=a):this._isFlipUVX?(e[0]=o,e[1]=a,e[2]=i,e[3]=a,e[4]=o,e[5]=c,e[6]=i,e[7]=c):this._isFlipUVY?(e[0]=i,e[1]=c,e[2]=o,e[3]=c,e[4]=i,e[5]=a,e[6]=o,e[7]=a):(e[0]=i,e[1]=a,e[2]=o,e[3]=a,e[4]=i,e[5]=c,e[6]=o,e[7]=c);const l=0===s?0:t.x/s,h=0===s?0:(t.x+t.width)/s,_=0===r?0:(t.y+t.height)/r,u=0===r?0:t.y/r;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=u,n[2]=l,n[3]=u,n[4]=h,n[5]=_,n[6]=l,n[7]=_):this._isFlipUVX?(n[0]=h,n[1]=_,n[2]=l,n[3]=_,n[4]=h,n[5]=u,n[6]=l,n[7]=u):this._isFlipUVY?(n[0]=l,n[1]=u,n[2]=h,n[3]=u,n[4]=l,n[5]=_,n[6]=h,n[7]=_):(n[0]=l,n[1]=_,n[2]=h,n[3]=_,n[4]=l,n[5]=u,n[6]=h,n[7]=u)}let o="";for(let t=0;t<e.length;t++)o+=e[t];this.uvHash=vo(o,666);const a=this.vertices;if(a){a.nu.length=0,a.nv.length=0;for(let t=0;t<a.u.length;t++)a.nu[t]=a.u[t]/s,a.nv[t]=a.v[t]/r}this._calculateSlicedUV()}_setDynamicAtlasFrame(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())}_resetDynamicAtlasFrame(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())}_checkPackable(){const t=FM;if(!t)return;const e=this._texture;if(!(e instanceof Zu)||e.isCompressed)return void(this._packable=!1);const n=this.width,i=this.height;!e.image||n>t.maxFrameSize||i>t.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)}_serialize(t){}_deserialize(t,e){const n=t,i=n.rect;i&&(this._rect=new Mn(i.x,i.y,i.width,i.height));const s=n.offset;n.offset&&(this._offset=new rn(s.x,s.y));const r=n.originalSize;n.originalSize&&(this._originalSize=new On(r.width,r.height)),this._rotated=!!n.rotated,this._name=n.name,this._packable=!!n.packable;const o=n.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=n.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}clone(){var e,n,i,s;const r=new t,o=this.vertices;return r.vertices=o?{x:o.x,y:o.y,triangles:o.triangles,nu:null===(e=o.nu)||void 0===e?void 0:e.slice(0),u:null===(n=o.u)||void 0===n?void 0:n.slice(0),nv:null===(i=o.nv)||void 0===i?void 0:i.slice(0),v:null===(s=o.v)||void 0===s?void 0:s.slice(0)}:null,r.uv.splice(0,r.uv.length,...this.uv),r.uvHash=this.uvHash,r.unbiasUV.splice(0,r.unbiasUV.length,...this.unbiasUV),r.uvSliced.splice(0,r.uvSliced.length,...this.uvSliced),r._rect.set(this._rect),r._offset.set(this._offset),r._originalSize.set(this._originalSize),r._rotated=this._rotated,r._capInsets.splice(0,r._capInsets.length,...this._capInsets),r._atlasUuid=this._atlasUuid,r._texture=this._texture,r._isFlipUVX=this._isFlipUVX,r._isFlipUVY=this._isFlipUVY,r}_textureLoaded(){const t=this._texture,e={};let n=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(e.rect=new Mn(0,0,t.width,t.height),n=!0),(0===this._originalSize.width||0===this._originalSize.height||n)&&(e.originalSize=new On(t.width,t.height),n=!0),n&&(this.reset(e),this.onLoaded()),this._checkPackable()}_refreshTexture(t){this._texture=t,t.loaded?this._textureLoaded():t.once("load",this._textureLoaded,this)}})||UM);var VM,kM,jM;i.SpriteFrame=HM;let WM=t("SpriteAtlas",Yl("cc.SpriteAtlas")((jM=Gl((kM=class extends y_{constructor(...t){super(...t),Ul(this,"spriteFrames",jM,this)}getTexture(){const t=Object.keys(this.spriteFrames);if(t.length>0){const e=this.spriteFrames[t[0]];return e&&e.texture}return null}getSpriteFrame(t){const e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null}getSpriteFrames(){const t=[],e=this.spriteFrames;for(const n of Object.keys(e))t.push(e[n]);return t}_serialize(t){}_deserialize(t,e){const n=t;this._name=n.name;const i=n.spriteFrames;this.spriteFrames=dt();for(let t=0;t<i.length;t+=2)e.result.push(this.spriteFrames,i[t],i[t+1])}}).prototype,"spriteFrames",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dt()}}),VM=kM))||VM);var qM;i.SpriteAtlas=WM;let XM=t("Font",Yl("cc.Font")(qM=class extends y_{})||qM);var YM,KM,$M;i.Font=XM;let ZM=t("TTFFont",Yl("cc.TTFFont")(($M=Gl((KM=class extends XM{constructor(...t){super(...t),Ul(this,"_fontFamily",$M,this)}get _nativeAsset(){return this._fontFamily}set _nativeAsset(t){this._fontFamily=t||"Arial"}get _nativeDep(){return{uuid:this._uuid,__nativeName__:this._native,ext:N(this._native),__isNative__:!0}}}).prototype,"_fontFamily",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gl(KM.prototype,"_nativeAsset",[bh,Ch],Object.getOwnPropertyDescriptor(KM.prototype,"_nativeAsset"),KM.prototype),Gl(KM.prototype,"_nativeDep",[bh],Object.getOwnPropertyDescriptor(KM.prototype,"_nativeDep"),KM.prototype),YM=KM))||YM);var JM,QM,tN,eN,nN,iN,sN,rN;i.TTFFont=ZM;class oN{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0}}class aN{constructor(t){this.letterDefinitions={},this.texture=t}addLetterDefinitions(t,e){this.letterDefinitions[t]=e}cloneLetterDefinition(){const t={};for(const e of Object.keys(this.letterDefinitions)){const n=new oN;Ct(n,this.letterDefinitions[e]),t[e]=n}return t}getTexture(){return this.texture}getLetter(t){return this.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const n=t.charCodeAt(0);let i;return i=this.letterDefinitions.hasOwnProperty(n)?this.letterDefinitions[n]:null,i}clear(){this.letterDefinitions={}}}let cN=t("BitmapFont",(JM=Yl("cc.BitmapFont"),QM=Ah(HM),JM((nN=Gl((eN=class extends XM{constructor(...t){super(...t),Ul(this,"fntDataStr",nN,this),Ul(this,"spriteFrame",iN,this),Ul(this,"fontSize",sN,this),Ul(this,"fntConfig",rN,this)}onLoaded(){const t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new aN(t.texture));const e=this.fntConfig;if(!e)return void _("The fnt config is not exists!");const n=e.fontDefDictionary;for(const t in n){const e=new oN,i=n[t].rect;e.offsetX=n[t].xOffset,e.offsetY=n[t].yOffset,e.w=i.width,e.h=i.height,e.u=i.x,e.v=i.y,e.textureID=0,e.valid=!0,e.xAdvance=n[t].xAdvance,this.fontDefDictionary.addLetterDefinitions(t,e)}}}).prototype,"fntDataStr",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),iN=Gl(eN.prototype,"spriteFrame",[QM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sN=Gl(eN.prototype,"fontSize",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),rN=Gl(eN.prototype,"fntConfig",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tN=eN))||tN));var lN;i.BitmapFont=cN;let hN=t("LabelAtlas",Yl("cc.LabelAtlas")(lN=class extends cN{})||lN);i.LabelAtlas=hN;const _N=t("BASELINE_RATIO",.26),uN=t("MIDDLE_RATIO",(_N+1)/2-_N);const dN=new Gt(2);dN.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};const pN=new class{constructor(t){this.count=0,this.limit=0,this.datas={},this.limit=t}moveToHead(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t}put(t,e){const n=dN.get();if(n.key=t,n.value=e,this.count>=this.limit){const t=this.tail;delete this.datas[t.key],this.count--,this.tail=t.prev,this.tail.next=null,t.prev=null,t.next=null,dN.put(t)}this.moveToHead(n)}remove(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--}get(t){const e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null}clear(){this.count=0,this.datas={},this.head=null,this.tail=null}has(t){return!!this.datas[t]}delete(t){const e=this.datas[t];this.remove(e)}}(100),mN=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûа-яА-ЯЁё]+|\S)/,fN=/^[!,.:;'}\]%\?>、‘“》？。，！]/,gN=/([a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+|\S)$/,vN=/[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]+$/,yN=/^[a-zA-Z0-9ÄÖÜäöüßéèçàùêâîôûаíìÍÌïÁÀáàÉÈÒÓòóŐőÙÚŰúűñÑæÆœŒÃÂãÔõěščřžýáíéóúůťďňĚŠČŘŽÁÍÉÓÚŤżźśóńłęćąŻŹŚÓŃŁĘĆĄ-яА-ЯЁё]/;function xN(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function SN(t){const e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function TN(t,e,n){const i=`${n||t.font}🎮${e}`,s=pN.get(i);if(null!==s)return s;const r=t.measureText(e),o=r&&r.width||0;return pN.put(i,o),o}function EN(t,e,n){let i=e,s=n;const r=t[e];if(r>="\udc00"&&r<="\udfff"&&i--,void 0!==n)if(n-1!==e){const e=t[n-1];e>="\ud800"&&e<="\udbff"&&s--}else r>="\ud800"&&r<="\udbff"&&s++;return t.substring(i,s)}function CN(t,e,n,i){const s=[];if(0===t.length||n<0)return s.push(""),s;let r=t;for(;e>n&&r.length>1;){let t=r.length*(n/e)|0,o=EN(r,t),a=e-i(o),c=o,l=0,h=0;const _=10;for(;a>n&&h++<_;)t*=n/a,t|=0,o=EN(r,t),a=e-i(o);for(h=0;a<=n&&h++<_;){if(o){const t=mN.exec(o);l=t?t[0].length:1,c=o}t+=l,o=EN(r,t),a=e-i(o)}t-=l,0===t?(t=1,c=EN(r,1)):1===t&&r[0]>="\ud800"&&r[0]<="\udbff"&&(t=2,c=EN(r,2));let u,d=EN(r,0,t);fN.test(c||o)&&(u=gN.exec(d),t-=u?u[0].length:0,0===t&&(t=1),c=EN(r,t),d=EN(r,0,t)),yN.test(c)&&(u=vN.exec(d),u&&d!==u[0]&&(t-=u[0].length,c=EN(r,t),d=EN(r,0,t))),0===s.length?s.push(d):(d=d.trim(),d.length>0&&s.push(d)),r=c||o,e=i(r)}return 0===s.length?s.push(r):(r=r.trim(),r.length>0&&s.push(r)),s}let AN;class bN{constructor(){this.pool=[]}static getInstance(){return AN||(AN=new bN),AN}get(){let t=this.pool.pop();if(!t){const e=document.createElement("canvas"),n=e.getContext("2d");t={canvas:e,context:n}}return t}put(t){this.pool.length>=Kt.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)}}t("CanvasPool",bN);const wN=Ln.WHITE.clone();class RN{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}}const IN=`rgba(255, 255, 255, ${(1/255).toFixed(3)})`;class PN{constructor(t,e){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=e,this.hash=t.charCodeAt(0)+e.hash}updateRenderData(){this._updateProperties(),this._updateTexture()}destroy(){this.image=null}_updateProperties(){if(this.data=bN.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;const t=TN(this.context,this.char,this.labelInfo.fontDesc),e=2*this.labelInfo.margin+2;this.width=parseFloat(t.toFixed(2))+e,this.height=(1+_N)*this.labelInfo.fontSize+e,this.offsetY=-this.labelInfo.fontSize*_N/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new P_),this.image.reset(this.canvas)}_updateTexture(){if(!this.context||!this.canvas)return;const t=this.context,e=this.labelInfo,n=this.canvas.width,i=this.canvas.height;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,n,i),t.fillStyle=IN,t.fillRect(0,0,n,i),t.font=e.fontDesc;const s=e.fontSize,r=n/2,o=i/2+s*uN+0*s,a=e.color;if(t.lineJoin="round",t.fillStyle=`rgba(${a.r}, ${a.g}, ${a.b}, 1)`,e.isOutlined){const n=e.out||wN;t.strokeStyle=`rgba(${n.r}, ${n.g}, ${n.b}, ${n.a/255})`,t.lineWidth=2*e.margin,t.strokeText(this.char,r,o)}t.fillText(this.char,r,o)}}class ON extends Zu{initWithSize(t,e,n=x_.RGBA8888){this.reset({width:t,height:e,format:n}),this.loaded=!0,this.emit("load")}drawTextureAt(t,e,n){const i=this.getGFXTexture();if(!t||!i)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const r=new Wr;r.texOffset.x=e,r.texOffset.y=n,r.texExtent.width=t.width,r.texExtent.height=t.height,s.copyTexImagesToTexture([t.data],i,[r])}}class DN{get width(){return this._width}get height(){return this._height}constructor(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;const n=new ON;n.initWithSize(t,e),this.fontDefDictionary=new aN(n),this._halfBleed=1,this._width=t,this._height=e,rE.on(sE.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}insertLetterTexture(t){const e=t.image,n=rE.root.device;if(!e||!this.fontDefDictionary||!n)return null;const i=e.width,s=e.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+s>this._nextY&&(this._nextY=this._y+s+0),this._nextY>this._height)return null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;const r=new RN;return r.u=this._x+this._halfBleed,r.v=this._y+this._halfBleed,r.texture=this.fontDefDictionary.texture,r.valid=!0,r.w=t.width-2,r.h=t.height-2,r.xAdvance=r.w,r.offsetY=t.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(t.hash,r),r}update(){this._dirty&&(this._dirty=!1)}reset(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()}destroy(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)}getTexture(){return this.fontDefDictionary.getTexture()}beforeSceneLoad(){this.clearAllCache()}clearAllCache(){this.destroy();const t=new ON;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t}getLetter(t){return this.fontDefDictionary.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const n=t.charCodeAt(0)+e.hash;let i=this.fontDefDictionary.letterDefinitions[n];if(!i){const n=new PN(t,e);n.updateRenderData(),i=this.insertLetterTexture(n),n.destroy()}return i}}const MN={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:Ln.WHITE.clone(),isOutlined:!1,out:Ln.WHITE.clone(),margin:0};class NN{constructor(){this.material=null,this.vertexCount=0,this.indicesCount=0}}class LN extends NN{constructor(...t){super(...t),this.vData=null,this.uvDirty=!0,this.vertDirty=!0,this._data=[],this._indices=[],this._pivotX=0,this._pivotY=0,this._width=0,this._height=0}get dataLength(){return this._data.length}set dataLength(t){const e=this._data;if(e.length!==t){const n=e.length;let i=0;for(i=t;i<n;i++)BN.free(e[i]);for(i=n;i<t;i++)e[i]=BN.alloc();e.length=t}}get data(){return this._data}static add(){return FN.add()}static remove(t){const e=FN.data.indexOf(t);-1!==e&&(FN.data[e].clear(),FN.removeAt(e))}updateSizeNPivot(t,e,n,i){t===this._width&&e===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=t,this._height=e,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)}clear(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0}}class zN extends NN{constructor(t=9){super(),this.vData=void 0,this.iData=void 0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.byteCount=0,this.lastFilledIndices=0,this.lastFilledVertex=0,this._formatByte=void 0,this._formatByte=t*Float32Array.BYTES_PER_ELEMENT,this.vData=new Float32Array(256*t*Float32Array.BYTES_PER_ELEMENT),this.iData=new Uint16Array(1536)}set formatByte(t){this._formatByte=t}get formatByte(){return this._formatByte}get floatStride(){return this._formatByte>>2}get vDataOffset(){return this.byteCount>>>2}static add(){return UN.add()}static remove(t){const e=UN.data.indexOf(t);-1!==e&&(UN.data[e].reset(),UN.removeAt(e))}request(t,e){const n=this.byteCount+t*this._formatByte;return this.reserve(t,e),this.vertexCount+=t,this.indicesCount+=e,this.byteCount=n,!0}reserve(t,e){const n=this.byteCount+t*this._formatByte,i=this.indicesCount+e;if(t+this.vertexCount>65535)return!1;let s=this.vData.byteLength,r=this.iData.length,o=this.vData.length,a=this.iData.length;if(n>s||i>r){for(;s<n||r<i;)o*=2,a*=2,s=4*o,r=a;this._reallocBuffer(o,a)}return!0}advance(t,e){this.vertexCount+=t,this.indicesCount+=e,this.byteCount+=t*this._formatByte}reset(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.lastFilledIndices=0,this.lastFilledVertex=0}_reallocBuffer(t,e){const n=this.vData;this.vData=new Float32Array(t),this.vData.set(n,0);const i=this.iData;this.iData=new Uint16Array(e),this.iData.set(i,0)}}const BN=new Jh(()=>({x:0,y:0,z:0,u:0,v:0,color:Ln.WHITE.clone()}),128),FN=new Qh(()=>new LN,32),UN=new Qh(()=>new zN,32);var GN,HN,VN,kN,jN,WN,qN,XN,YN,KN,$N,ZN,JN,QN,tL,eL;const nL=new rn,iL=new rn,sL=new bn,rL=new bn,oL=new bn,aL=new bn(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),cL=new Mn;let lL,hL=t("UITransform",(GN=Yl("cc.UITransform"),HN=ah(),VN=$l(110),kN=ih(),jN=gh(),WN=_h(),qN=gh(),XN=_h(),YN=_h(),GN(KN=HN(KN=VN(KN=kN(KN=Zl(KN=nh((eL=tL=class t extends Nu{constructor(...t){super(...t),Ul(this,"_priority",ZN,this),Ul(this,"_contentSize",JN,this),Ul(this,"_anchorPoint",QN,this)}get contentSize(){return this._contentSize}set contentSize(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit(pf.SIZE_CHANGED))}get width(){return this._contentSize.width}set width(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit(pf.SIZE_CHANGED))}get height(){return this._contentSize.height}set height(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit(pf.SIZE_CHANGED))}get anchorPoint(){return this._anchorPoint}set anchorPoint(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit(pf.ANCHOR_CHANGED,this._anchorPoint))}get anchorX(){return this._anchorPoint.x}set anchorX(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit(pf.ANCHOR_CHANGED,this._anchorPoint))}get anchorY(){return this._anchorPoint.y}set anchorY(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit(pf.ANCHOR_CHANGED,this._anchorPoint))}get priority(){return this._priority}set priority(t){this._priority!==t&&(this.node.getComponent("cc.RenderRoot2D")?x(6706):(this._priority=t,this._checkAndSortSiblings(),this.node.parent._updateSiblingIndex()))}get visibility(){const t=rE.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}get cameraPriority(){const t=rE.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}__preload(){this.node._uiProps.uiTransformComp=this}onEnable(){this.node.on(pf.PARENT_CHANGED,this._parentChanged,this),this._checkAndSortSiblings()&&this.node.parent._updateSiblingIndex()}onDisable(){this.node.off(pf.PARENT_CHANGED,this._parentChanged,this)}onDestroy(){this.node._uiProps.uiTransformComp=null}setContentSize(t,e){const n=this._contentSize;if(void 0===e){if((t=t).width===n.width&&t.height===n.height)return;n.width=t.width,n.height=t.height}else{if(t===n.width&&e===n.height)return;n.width=t,n.height=e}this.node.emit(pf.SIZE_CHANGED)}setAnchorPoint(t,e){const n=this._anchorPoint;if(void 0===e){if((t=t).x===n.x&&t.y===n.y)return;n.x=t.x,n.y=t.y}else{if(t===n.x&&e===n.y)return;n.x=t,n.y=e}this.node.emit(pf.ANCHOR_CHANGED,this._anchorPoint)}isHit(t,e){const n=this._contentSize.width,s=this._contentSize.height,r=nL,o=iL,a=this._getRenderScene().cameras;for(let c=0;c<a.length;c++){const l=a[c];if(!(l.visibility&this.node.layer))continue;l.node.getWorldRT(sL);const h=sL.m12,_=sL.m13,u=i.visibleRect.center;if(sL.m12=u.x-(sL.m00*h+sL.m04*_),sL.m13=u.y-(sL.m01*h+sL.m05*_),bn.invert(sL,sL),rn.transformMat4(r,t,sL),this.node.getWorldMatrix(oL),bn.invert(sL,oL),bn.strictEquals(sL,aL))continue;rn.transformMat4(o,r,sL),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*s;let d=!1;if(o.x>=0&&o.y>=0&&o.x<=n&&o.y<=s&&(d=!0,e&&e.mask)){const t=e.mask;let n=this.node;const i=t?t.length:0;for(let e=0,s=0;n&&s<i;++e,n=n.parent){const i=t[s];if(e===i.index){if(n!==i.comp.node){t.length=s;break}{const t=i.comp;if(t&&t._enabled&&!t.isHit(r)){d=!1;break}s++}}else if(e>i.index){t.length=s;break}}}if(d)return!0}return!1}convertToNodeSpaceAR(t,e){return this.node.getWorldMatrix(oL),bn.invert(sL,oL),e||(e=new ln),ln.transformMat4(e,t,sL)}convertToWorldSpaceAR(t,e){return this.node.getWorldMatrix(oL),e||(e=new ln),ln.transformMat4(e,t,oL)}getBoundingBox(){bn.fromRTS(rL,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const t=this._contentSize.width,e=this._contentSize.height,n=new Mn(-this._anchorPoint.x*t,-this._anchorPoint.y*e,t,e);return n.transformMat4(rL),n}getBoundingBoxToWorld(){return this.node.parent?(this.node.parent.getWorldMatrix(oL),this.getBoundingBoxTo(oL)):this.getBoundingBox()}getBoundingBoxTo(e){bn.fromRTS(rL,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const n=this._contentSize.width,i=this._contentSize.height,s=new Mn(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(bn.multiply(oL,e,rL),s.transformMat4(oL),!this.node.children)return s;const r=this.node.children;for(const n of r)if(n&&n.active){const i=n.getComponent(t);if(i){const t=i.getBoundingBoxTo(e);t&&Mn.union(s,s,t)}}return s}getComputeAABB(t){const e=this._contentSize.width,n=this._contentSize.height;cL.set(-this._anchorPoint.x*e,-this._anchorPoint.y*n,e,n),cL.transformMat4(this.node.worldMatrix);const i=cL.x+.5*cL.width,s=cL.y+.5*cL.height,r=this.node.worldPosition.z,o=cL.width/2,a=cL.height/2;return null!=t?(nc.set(t,i,s,r,o,a,.001),t):new nc(i,s,r,o,a,.001)}_parentChanged(t){this.node.getComponent("cc.RenderRoot2D")||this._checkAndSortSiblings()}_checkAndSortSiblings(){const t=this.node.parent&&this.node.parent.children;let e=!1;return t&&t.sort((t,n)=>{const i=t._uiProps.uiTransformComp,s=n._uiProps.uiTransformComp;let r=(i?i.priority:0)-(s?s.priority:0);return 0===r&&(r=t.getSiblingIndex()-n.getSiblingIndex()),e=r>0,r}),e}},tL.EventType=pf,Gl(($N=eL).prototype,"contentSize",[jN,WN],Object.getOwnPropertyDescriptor($N.prototype,"contentSize"),$N.prototype),Gl($N.prototype,"anchorPoint",[qN,XN],Object.getOwnPropertyDescriptor($N.prototype,"anchorPoint"),$N.prototype),Gl($N.prototype,"priority",[YN],Object.getOwnPropertyDescriptor($N.prototype,"priority"),$N.prototype),ZN=Gl($N.prototype,"_priority",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JN=Gl($N.prototype,"_contentSize",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On(100,100)}}),QN=Gl($N.prototype,"_anchorPoint",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rn(.5,.5)}}),KN=$N))||KN)||KN)||KN)||KN)||KN)||KN));!function(t){t[t.DISABLED=0]="DISABLED",t[t.CLEAR=1]="CLEAR",t[t.ENTER_LEVEL=2]="ENTER_LEVEL",t[t.ENABLED=3]="ENABLED",t[t.EXIT_LEVEL=4]="EXIT_LEVEL",t[t.CLEAR_INVERTED=5]="CLEAR_INVERTED",t[t.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(lL||(lL={}));class _L{constructor(){this.stage=lL.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:ir.ALWAYS,stencilMask:65535,writeMask:65535,failOp:sr.KEEP,zFailOp:sr.KEEP,passOp:sr.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}get pattern(){return this._stencilPattern}pushMask(t){this._maskStack.push(t)}clear(t){t.stencilStage=t.inverted?lL.CLEAR_INVERTED:lL.CLEAR}enterLevel(t){t.graphics.stencilStage=t.inverted?lL.ENTER_LEVEL_INVERTED:lL.ENTER_LEVEL}enableMask(){this.stage=lL.ENABLED}exitMask(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=lL.DISABLED:this.stage=lL.ENABLED)}getWriteMask(){return 1<<this._maskStack.length-1}getExitWriteMask(){return 1<<this._maskStack.length}getStencilRef(){let t=0;for(let e=0;e<this._maskStack.length;++e)t+=1<<e;return t}reset(){this._maskStack.length=0,this.stage=lL.DISABLED}destroy(){this.stencilStateMap.forEach(t=>{t.destroy()}),this.stencilStateMap.clear()}getStencilStage(t,e){let n=0,i=!1,s=!1,r=ir.LESS,o=this.stencilStateMap;if(e&&e.passes[0]){const a=e.passes[0].depthStencilState;let c=0,l=0;a.depthTest&&(c=1),a.depthWrite&&(l=1),n=c|l<<1|a.depthFunc<<2|t<<6|this._maskStack.length<<9,i=a.depthTest,s=a.depthWrite,r=a.depthFunc,o=this.stencilStateMapWithDepth}else n=t<<16|this._maskStack.length;if(o&&o.has(n))return o.get(n);this.setStateFromStage(t);const a=new Xr(i,s,r,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return o.set(n,a),a}getStencilHash(t){return t<<8|this._maskStack.length}setStateFromStage(t){const e=this._stencilPattern;t===lL.DISABLED?(e.stencilTest=!1,e.func=ir.ALWAYS,e.failOp=sr.KEEP,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,t===lL.ENABLED?(e.func=ir.EQUAL,e.failOp=sr.KEEP,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):t===lL.CLEAR?(e.func=ir.NEVER,e.failOp=sr.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===lL.CLEAR_INVERTED||t===lL.ENTER_LEVEL?(e.func=ir.NEVER,e.failOp=sr.REPLACE,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===lL.ENTER_LEVEL_INVERTED&&(e.func=ir.NEVER,e.failOp=sr.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))}}var uL,dL,pL,mL,fL,gL,vL,yL,xL,SL,TL,EL,CL,AL,bL,wL,RL,IL,PL,OL,DL,ML,NL,LL,zL,BL;let FL;t("StencilManager",_L),_L.sharedManager=null,_L.sharedManager=new _L,Xt(or),function(t){t[t.ADD_COLOR=0]="ADD_COLOR",t[t.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",t[t.GRAYSCALE=2]="GRAYSCALE",t[t.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",t[t.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(FL||(FL=t("InstanceMaterialType",{})));let UL=t("Renderable2D",(uL=Yl("cc.Renderable2D"),dL=Kl(hL),pL=lh(),mL=Ah(Ap),fL=Ah(Ap),gL=gh(),vL=hh(),yL=lh(),xL=Ah(or),SL=gh(),TL=_h(),EL=lh(),CL=Ah(or),AL=gh(),bL=_h(),wL=gh(),RL=_h(),uL(IL=dL(IL=Zl(IL=nh((BL=zL=class t extends qA{constructor(...t){super(...t),Ul(this,"_materials",OL,this),Ul(this,"_customMaterial",DL,this),this.stencilStage=lL.DISABLED,Ul(this,"_srcBlendFactor",ML,this),Ul(this,"_dstBlendFactor",NL,this),Ul(this,"_color",LL,this),this._assembler=null,this._postAssembler=null,this._renderData=null,this._renderDataFlag=!0,this._renderFlag=!0,this._delegateSrc=null,this._instanceMaterialType=FL.ADD_COLOR_AND_TEXTURE,this._blendState=new Kr,this._blendHash=0,this._lastParent=null}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setMaterial(null,e);this._materials.splice(t.length)}}get customMaterial(){return this._customMaterial}set customMaterial(t){this._customMaterial=t,this.updateMaterial()}updateMaterial(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);const t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._updateBlendFunc()}get srcBlendFactor(){return this._customMaterial&&x(12001),this._srcBlendFactor}set srcBlendFactor(t){this._customMaterial?x(12001):this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}get dstBlendFactor(){return this._customMaterial&&x(12001),this._dstBlendFactor}set dstBlendFactor(t){this._customMaterial?x(12001):this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}get color(){return this._color}set color(t){this._color.equals(t)||(this._color.set(t),this._updateColor(),this.markForUpdateRenderData())}get renderData(){return this._renderData}set delegateSrc(t){this._delegateSrc=t}get blendHash(){return this._blendHash}updateBlendHash(){const t=this._blendState.targets[0].blendDst<<4;this._blendHash=t|this._blendState.targets[0].blendSrc}__preload(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()}onEnable(){this.node.on(pf.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(pf.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()}onRestore(){this.updateMaterial(),this._renderFlag=this._canRender()}onDisable(){this.node.off(pf.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(pf.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}onDestroy(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(let t=0;t<this._materialInstances.length;t++)this._materialInstances[t].destroy();this._renderData=null,this._blendState&&this._blendState.destroy()}markForUpdateRenderData(t=!0){if(this._renderFlag=this._canRender(),t&&this._renderFlag){const e=this._renderData;e&&(e.vertDirty=!0),this._renderDataFlag=t}else t||(this._renderDataFlag=t)}requestRenderData(){const t=LN.add();return this._renderData=t,t}destroyRenderData(){this._renderData&&(LN.remove(this._renderData),this._renderData=null)}updateAssembler(t){this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(t))}postUpdateAssembler(t){this._renderFlag&&this._postRender(t)}_render(t){}_postRender(t){}_checkAndUpdateRenderData(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}_canRender(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0}_postCanRender(){}_updateColor(){this._assembler&&this._assembler.updateColor&&this._assembler.updateColor(this)}_updateBlendFunc(){let t=this._blendState.targets[0];t||(t=new Yr,this._blendState.setTarget(0,t)),t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(t.blend=!0,t.blendDstAlpha=or.ONE_MINUS_SRC_ALPHA,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor),this.updateBlendHash()}getBlendState(){return this._blendState}_nodeStateChange(e){this._renderData&&this.markForUpdateRenderData();for(let e=0;e<this.node.children.length;++e){const n=this.node.children[e].getComponent(t);n&&n.markForUpdateRenderData()}}_updateBuiltinMaterial(){let t;switch(this._instanceMaterialType){case FL.ADD_COLOR:t=Rd.get("ui-base-material");break;case FL.GRAYSCALE:t=Rd.get("ui-sprite-gray-material");break;case FL.USE_ALPHA_SEPARATED:t=Rd.get("ui-sprite-alpha-sep-material");break;case FL.USE_ALPHA_SEPARATED_AND_GRAY:t=Rd.get("ui-sprite-gray-alpha-sep-material");break;default:t=Rd.get("ui-sprite-material")}return t}},zL.BlendState=or,zL.Assembler=null,zL.PostAssembler=null,OL=Gl((PL=BL).prototype,"_materials",[bh],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Gl(PL.prototype,"sharedMaterials",[bh,pL],Object.getOwnPropertyDescriptor(PL.prototype,"sharedMaterials"),PL.prototype),DL=Gl(PL.prototype,"_customMaterial",[mL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gl(PL.prototype,"customMaterial",[fL,gL,vL],Object.getOwnPropertyDescriptor(PL.prototype,"customMaterial"),PL.prototype),Gl(PL.prototype,"srcBlendFactor",[yL,xL,SL,TL],Object.getOwnPropertyDescriptor(PL.prototype,"srcBlendFactor"),PL.prototype),Gl(PL.prototype,"dstBlendFactor",[EL,CL,AL,bL],Object.getOwnPropertyDescriptor(PL.prototype,"dstBlendFactor"),PL.prototype),Gl(PL.prototype,"color",[wL,RL],Object.getOwnPropertyDescriptor(PL.prototype,"color"),PL.prototype),ML=Gl(PL.prototype,"_srcBlendFactor",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return or.SRC_ALPHA}}),NL=Gl(PL.prototype,"_dstBlendFactor",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return or.ONE_MINUS_SRC_ALPHA}}),LL=Gl(PL.prototype,"_color",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ln.WHITE.clone()}}),IL=PL))||IL)||IL)||IL)||IL));var GL,HL,VL,kL,jL,WL,qL,XL,YL,KL,$L,ZL,JL,QL,tz,ez,nz,iz,sz,rz,oz,az,cz,lz,hz,_z,uz,dz,pz,mz,fz,gz,vz,yz,xz,Sz,Tz,Ez,Cz,Az,bz,wz,Rz,Iz,Pz,Oz,Dz,Mz,Nz,Lz,zz,Bz,Fz,Uz,Gz,Hz,Vz,kz,jz,Wz;let qz,Xz,Yz,Kz;i.internal.Renderable2D=UL,function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(qz||(qz=t("HorizontalTextAlignment",{}))),Xt(qz),function(t){t[t.TOP=0]="TOP",t[t.CENTER=1]="CENTER",t[t.BOTTOM=2]="BOTTOM"}(Xz||(Xz=t("VerticalTextAlignment",{}))),Xt(Xz),function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.SHRINK=2]="SHRINK",t[t.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(Yz||(Yz=t("Overflow",{}))),Xt(Yz),function(t){t[t.NONE=0]="NONE",t[t.BITMAP=1]="BITMAP",t[t.CHAR=2]="CHAR"}(Kz||(Kz=t("CacheMode",{}))),Xt(Kz);let $z,Zz,Jz,Qz=t("Label",(GL=Yl("cc.Label"),HL=ah(),VL=$l(110),kL=ih(),jL=gh(),WL=_h(),qL=Ah(qz),XL=gh(),YL=_h(),KL=Ah(Xz),$L=gh(),ZL=_h(),JL=gh(),QL=_h(),tz=gh(),ez=lh(),nz=_h(),iz=gh(),sz=_h(),rz=Ah(Yz),oz=gh(),az=_h(),cz=gh(),lz=_h(),hz=Ah(XM),_z=gh(),uz=lh(),dz=_h(),pz=gh(),mz=_h(),fz=Ah(Kz),gz=gh(),vz=_h(),yz=gh(),xz=_h(),Sz=gh(),Tz=_h(),Ez=gh(),Cz=_h(),Az=lh(),GL(bz=HL(bz=VL(bz=kL((Wz=jz=class t extends UL{get string(){return this._string}set string(t){t+="",this._string!==t&&(this._string=t,this.updateRenderData())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.updateRenderData())}get verticalAlign(){return this._verticalAlign}set verticalAlign(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.updateRenderData())}get actualFontSize(){return this._actualFontSize}set actualFontSize(t){this._actualFontSize=t}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this.updateRenderData())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this.updateRenderData())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.updateRenderData())}get overflow(){return this._overflow}set overflow(t){this._overflow!==t&&(this._overflow=t,this.updateRenderData())}get enableWrapText(){return this._enableWrapText}set enableWrapText(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.updateRenderData())}get font(){return this._font}set font(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.updateRenderData())}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(this._cacheMode!==Kz.BITMAP||this._font instanceof cN||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===Kz.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}get spriteFrame(){return this._texture}get ttfSpriteFrame(){return this._ttfSpriteFrame}get isBold(){return this._isBold}set isBold(t){this._isBold!==t&&(this._isBold=t,this.updateRenderData())}get isItalic(){return this._isItalic}set isItalic(t){this._isItalic!==t&&(this._isItalic=t,this.updateRenderData())}get isUnderline(){return this._isUnderline}set isUnderline(t){this._isUnderline!==t&&(this._isUnderline=t,this.updateRenderData())}get underlineHeight(){return this._underlineHeight}set underlineHeight(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.updateRenderData())}get assemblerData(){return this._assemblerData}get fontAtlas(){return this._fontAtlas}set fontAtlas(t){this._fontAtlas=t}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this.updateRenderData())}get _bmFontOriginalSize(){return this._font instanceof cN?this._font.fontSize:-1}constructor(){super(),Ul(this,"_string",Rz,this),Ul(this,"_horizontalAlign",Iz,this),Ul(this,"_verticalAlign",Pz,this),Ul(this,"_actualFontSize",Oz,this),Ul(this,"_fontSize",Dz,this),Ul(this,"_fontFamily",Mz,this),Ul(this,"_lineHeight",Nz,this),Ul(this,"_overflow",Lz,this),Ul(this,"_enableWrapText",zz,this),Ul(this,"_font",Bz,this),Ul(this,"_isSystemFontUsed",Fz,this),this._spacingX=0,Ul(this,"_isItalic",Uz,this),Ul(this,"_isBold",Gz,this),Ul(this,"_isUnderline",Hz,this),Ul(this,"_underlineHeight",Vz,this),Ul(this,"_cacheMode",kz,this),this._N$file=null,this._texture=null,this._ttfSpriteFrame=null,this._userDefinedFont=null,this._assemblerData=null,this._fontAtlas=null,this._letterTexture=null,this._ttfSpriteFrame=null}onEnable(){super.onEnable(),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this.updateRenderData(!0)}onDisable(){super.onDisable()}onDestroy(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){const t=this._ttfSpriteFrame.texture;if(t&&null===this._ttfSpriteFrame.original){const e=t;e.image&&e.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,super.onDestroy()}updateRenderData(t=!1){this.markForUpdateRenderData(),t&&(this._flushAssembler(),this._applyFontTexture())}_render(t){t.commitComp(this,this._texture,this._assembler,null)}_updateColor(){this._font instanceof cN?super._updateColor():this.updateRenderData(!1)}_canRender(){if(!super._canRender()||!this._string)return!1;const t=this._font;if(t&&t instanceof cN){const e=t.spriteFrame;if(!e||!e.textureLoaded())return!1}return!0}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}_applyFontTexture(){const t=this._font;if(t instanceof cN){const e=t.spriteFrame,n=()=>{this._texture=e,this._assembler&&this._assembler.updateRenderData(this)};e&&(e.loaded||e.textureLoaded?n():e.once("load",n,this))}else{if(this.cacheMode===Kz.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new HM,this._assemblerData=this._assembler.getAssemblerData();const t=new P_(this._assemblerData.canvas)._texture;this._ttfSpriteFrame.texture=t}this.cacheMode!==Kz.CHAR&&(this._texture=this._ttfSpriteFrame)}}},jz.HorizontalAlign=qz,jz.VerticalAlign=Xz,jz.Overflow=Yz,jz.CacheMode=Kz,jz._canvasPool=bN.getInstance(),Gl((wz=Wz).prototype,"string",[jL,WL,yh],Object.getOwnPropertyDescriptor(wz.prototype,"string"),wz.prototype),Gl(wz.prototype,"horizontalAlign",[qL,XL,YL],Object.getOwnPropertyDescriptor(wz.prototype,"horizontalAlign"),wz.prototype),Gl(wz.prototype,"verticalAlign",[KL,$L,ZL],Object.getOwnPropertyDescriptor(wz.prototype,"verticalAlign"),wz.prototype),Gl(wz.prototype,"fontSize",[JL,QL],Object.getOwnPropertyDescriptor(wz.prototype,"fontSize"),wz.prototype),Gl(wz.prototype,"fontFamily",[tz,ez,nz],Object.getOwnPropertyDescriptor(wz.prototype,"fontFamily"),wz.prototype),Gl(wz.prototype,"lineHeight",[iz,sz],Object.getOwnPropertyDescriptor(wz.prototype,"lineHeight"),wz.prototype),Gl(wz.prototype,"overflow",[rz,oz,az],Object.getOwnPropertyDescriptor(wz.prototype,"overflow"),wz.prototype),Gl(wz.prototype,"enableWrapText",[cz,lz],Object.getOwnPropertyDescriptor(wz.prototype,"enableWrapText"),wz.prototype),Gl(wz.prototype,"font",[hz,_z,uz,dz],Object.getOwnPropertyDescriptor(wz.prototype,"font"),wz.prototype),Gl(wz.prototype,"useSystemFont",[pz,mz],Object.getOwnPropertyDescriptor(wz.prototype,"useSystemFont"),wz.prototype),Gl(wz.prototype,"cacheMode",[fz,gz,vz],Object.getOwnPropertyDescriptor(wz.prototype,"cacheMode"),wz.prototype),Gl(wz.prototype,"isBold",[yz,xz],Object.getOwnPropertyDescriptor(wz.prototype,"isBold"),wz.prototype),Gl(wz.prototype,"isItalic",[Sz,Tz],Object.getOwnPropertyDescriptor(wz.prototype,"isItalic"),wz.prototype),Gl(wz.prototype,"isUnderline",[Ez,Cz],Object.getOwnPropertyDescriptor(wz.prototype,"isUnderline"),wz.prototype),Gl(wz.prototype,"underlineHeight",[Az,ch],Object.getOwnPropertyDescriptor(wz.prototype,"underlineHeight"),wz.prototype),Rz=Gl(wz.prototype,"_string",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),Iz=Gl(wz.prototype,"_horizontalAlign",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qz.CENTER}}),Pz=Gl(wz.prototype,"_verticalAlign",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Xz.CENTER}}),Oz=Gl(wz.prototype,"_actualFontSize",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Dz=Gl(wz.prototype,"_fontSize",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Mz=Gl(wz.prototype,"_fontFamily",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),Nz=Gl(wz.prototype,"_lineHeight",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),Lz=Gl(wz.prototype,"_overflow",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Yz.NONE}}),zz=Gl(wz.prototype,"_enableWrapText",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Bz=Gl(wz.prototype,"_font",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Fz=Gl(wz.prototype,"_isSystemFontUsed",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Uz=Gl(wz.prototype,"_isItalic",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gz=Gl(wz.prototype,"_isBold",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hz=Gl(wz.prototype,"_isUnderline",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Vz=Gl(wz.prototype,"_underlineHeight",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),kz=Gl(wz.prototype,"_cacheMode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kz.NONE}}),bz=wz))||bz)||bz)||bz)||bz));!function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE"}($z||($z={})),Xt($z),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER"}(Zz||(Zz={})),Xt(Zz),function(t){t[t.PT_CORNER=1]="PT_CORNER",t[t.PT_LEFT=2]="PT_LEFT",t[t.PT_BEVEL=4]="PT_BEVEL",t[t.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(Jz||(Jz={})),Xt(Jz);const tB=Math.PI,eB=Math.min,nB=Math.max,iB=Math.cos,sB=Math.sin,rB=Math.abs,oB=Math.sign,aB=.5522847493;function cB(t,e,n,i,s){t.moveTo(e-i,n),t.bezierCurveTo(e-i,n+s*aB,e-i*aB,n+s,e,n+s),t.bezierCurveTo(e+i*aB,n+s,e+i,n+s*aB,e+i,n),t.bezierCurveTo(e+i,n-s*aB,e+i*aB,n-s,e,n-s),t.bezierCurveTo(e-i*aB,n-s,e-i,n-s*aB,e-i,n),t.close()}class lB extends rn{constructor(t,e){super(t,e),this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0,this.reset()}reset(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}class hB{constructor(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}reset(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}class _B{constructor(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Ln.WHITE.clone(),this.lineCap=$z.BUTT,this.strokeColor=Ln.BLACK.clone(),this.lineJoin=Zz.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}moveTo(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,Jz.PT_CORNER),this._commandX=t,this._commandY=e}lineTo(t,e){this.addPoint(t,e,Jz.PT_CORNER),this._commandX=t,this._commandY=e}bezierCurveTo(t,e,n,i,s,r){const o=this._curPath,a=o.points[o.points.length-1];a&&(a.x!==t||a.y!==e||n!==s||i!==r?(function t(e,n,i,s,r,o,a,c,l,h,_){let u=0,d=0,p=0,m=0,f=0,g=0,v=0,y=0,x=0,S=0,T=0,E=0,C=0,A=0,b=0,w=0;h>10||(u=.5*(n+s),d=.5*(i+r),p=.5*(s+o),m=.5*(r+a),f=.5*(o+c),g=.5*(a+l),v=.5*(u+p),y=.5*(d+m),C=c-n,A=l-i,b=rB((s-c)*A-(r-l)*C),w=rB((o-c)*A-(a-l)*C),(b+w)*(b+w)<e.tessTol*(C*C+A*A)?e.addPoint(c,l,0===_?_|Jz.PT_BEVEL:_):(x=.5*(p+f),S=.5*(m+g),T=.5*(v+x),E=.5*(y+S),t(e,n,i,u,d,v,y,T,E,h+1,0),t(e,T,E,x,S,f,g,c,l,h+1,_)))}(this,a.x,a.y,t,e,n,i,s,r,0,Jz.PT_CORNER),this._commandX=s,this._commandY=r):this.lineTo(s,r))}quadraticCurveTo(t,e,n,i){const s=this._commandX,r=this._commandY;this.bezierCurveTo(s+2/3*(t-s),r+2/3*(e-r),n+2/3*(t-n),i+2/3*(e-i),n,i)}arc(t,e,n,i,s,r){!function(t,e,n,i,s,r,o){let a=0,c=0,l=0,h=0,_=0,u=0,d=0,p=0,m=0,f=0,g=0,v=0,y=0,x=0,S=0,T=0;if(c=r-s,o=o||!1)if(rB(c)>=2*tB)c=2*tB;else for(;c<0;)c+=2*tB;else if(rB(c)>=2*tB)c=2*-tB;else for(;c>0;)c-=2*tB;for(T=0|nB(1,eB(rB(c)/(.5*tB)+.5,5)),l=c/T/2,h=rB(4/3*(1-iB(l))/sB(l)),o||(h=-h),S=0;S<=T;S++)a=s+c*(S/T),_=iB(a),u=sB(a),d=e+_*i,p=n+u*i,m=-u*i*h,f=_*i*h,0===S?t.moveTo(d,p):t.bezierCurveTo(g+y,v+x,d-m,p-f,d,p),g=d,v=p,y=m,x=f}(this,t,e,n,i,s,r)}ellipse(t,e,n,i){cB(this,t,e,n,i),this._curPath.complex=!1}circle(t,e,n){cB(this,t,e,n,n),this._curPath.complex=!1}rect(t,e,n,i){this.moveTo(t,e),this.lineTo(t+n,e),this.lineTo(t+n,e+i),this.lineTo(t,e+i),this.close(),this._curPath.complex=!1}roundRect(t,e,n,i,s){!function(t,e,n,i,s,r){if(r<.1)t.rect(e,n,i,s);else{const o=eB(r,.5*rB(i))*oB(i),a=eB(r,.5*rB(s))*oB(s);t.moveTo(e,n+a),t.lineTo(e,n+s-a),t.bezierCurveTo(e,n+s-a*(1-aB),e+o*(1-aB),n+s,e+o,n+s),t.lineTo(e+i-o,n+s),t.bezierCurveTo(e+i-o*(1-aB),n+s,e+i,n+s-a*(1-aB),e+i,n+s-a),t.lineTo(e+i,n+a),t.bezierCurveTo(e+i,n+a*(1-aB),e+i-o*(1-aB),n,e+i-o,n),t.lineTo(e+o,n),t.bezierCurveTo(e+o*(1-aB),n,e,n+a*(1-aB),e,n+a),t.close()}}(this,t,e,n,i,s),this._curPath.complex=!1}clear(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;const t=this._renderDataList;for(let e=0,n=t.length;e<n;e++){const n=t[e];n&&zN.remove(n)}this._renderDataList.length=0}close(){this._curPath.closed=!0}requestRenderData(){const t=zN.add();return this._renderDataList.push(t),t}getRenderDataList(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList}addPoint(t,e,n){const i=this._curPath;if(!i)return;const s=this._points,r=i.points;let o=s[this.pointsOffset++];o?(o.x=t,o.y=e):(o=new lB(t,e),s.push(o)),o.flags=n,r.push(o)}_addPath(){const t=this.pathLength;let e=this.paths[t];return e?e.reset():(e=new hB,this.paths.push(e)),this.pathLength++,this._curPath=e,e}}const uB=[new Yo(Ws.ATTR_POSITION,Xs.RGB32F)],dB=[new Yo(Ws.ATTR_POSITION,Xs.RGB32F),new Yo(Ws.ATTR_COLOR,Xs.RGBA32F)],pB=[new Yo(Ws.ATTR_POSITION,Xs.RGB32F),new Yo(Ws.ATTR_TEX_COORD,Xs.RG32F),new Yo(Ws.ATTR_COLOR,Xs.RGBA32F)],mB=[new Yo(Ws.ATTR_POSITION,Xs.RGB32F),new Yo(Ws.ATTR_TEX_COORD,Xs.RG32F),new Yo(Ws.ATTR_COLOR,Xs.RGBA32F),new Yo(Ws.ATTR_COLOR2,Xs.RGBA32F)];function fB(t){let e=0;for(let n=0;n<t.length;n++){const i=t[n];e+=Dr[i.format].count}return e}function gB(t){let e=0;for(let n=0;n<t.length;n++){const i=t[n];e+=Dr[i.format].size}return e}var vB,yB,xB,SB,TB,EB,CB,AB,bB,wB,RB,IB,PB,OB,DB,MB,NB,LB,zB,BB,FB,UB,GB,HB;i.internal.vfmtPosUvColor=pB,i.internal.vfmtPosUvTwoColor=mB;const VB=dB.concat([new Yo("a_dist",Xs.R32F)]),kB=fB(VB),jB=gB(VB);let WB=t("Graphics",(vB=Yl("cc.Graphics"),yB=ah(),xB=$l(110),SB=ih(),TB=Ah(Zz),EB=_h(),CB=Ah($z),AB=_h(),bB=_h(),wB=_h(),RB=_h(),IB=lh(),PB=lh(),OB=lh(),vB(DB=yB(DB=xB(DB=SB((HB=GB=class t extends UL{get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}get lineJoin(){return this._lineJoin}set lineJoin(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}get lineCap(){return this._lineCap}set lineCap(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}get strokeColor(){return this._strokeColor}set strokeColor(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}get fillColor(){return this._fillColor}set fillColor(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}get miterLimit(){return this._miterLimit}set miterLimit(t){this._miterLimit=t}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateColor(),this.markForUpdateRenderData())}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(t){}constructor(){super(),this.impl=null,this.model=null,Ul(this,"_lineWidth",NB,this),Ul(this,"_strokeColor",LB,this),Ul(this,"_lineJoin",zB,this),Ul(this,"_lineCap",BB,this),Ul(this,"_fillColor",FB,this),Ul(this,"_miterLimit",UB,this),this._isDrawing=!1,this._isNeedUploadData=!0,this._instanceMaterialType=FL.ADD_COLOR,this.impl=new _B}onRestore(){this.impl||this._flushAssembler()}onLoad(){this.model=rE.root.createModel(Wd),this.model.node=this.model.transform=this.node,this._flushAssembler()}onEnable(){super.onEnable(),this._updateMtlForGraphics()}onDisable(){super.onDisable()}onDestroy(){super.onDestroy(),this._sceneGetter=null,this.model&&(rE.root.destroyModel(this.model),this.model=null),this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)}moveTo(t,e){this.impl&&this.impl.moveTo(t,e)}lineTo(t,e){this.impl&&this.impl.lineTo(t,e)}bezierCurveTo(t,e,n,i,s,r){this.impl&&this.impl.bezierCurveTo(t,e,n,i,s,r)}quadraticCurveTo(t,e,n,i){this.impl&&this.impl.quadraticCurveTo(t,e,n,i)}arc(t,e,n,i,s,r){this.impl&&this.impl.arc(t,e,n,i,s,r)}ellipse(t,e,n,i){this.impl&&this.impl.ellipse(t,e,n,i)}circle(t,e,n){this.impl&&this.impl.circle(t,e,n)}rect(t,e,n,i){this.impl&&this.impl.rect(t,e,n,i)}roundRect(t,e,n,i,s){this.impl&&this.impl.roundRect(t,e,n,i,s)}fillRect(t,e,n,i){this.rect(t,e,n,i),this.fill()}clear(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(let t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}}close(){this.impl&&this.impl.close()}stroke(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)}fill(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)}_updateMtlForGraphics(){let t;this._customMaterial?t=this.getMaterialInstance(0):(t=Rd.get("ui-graphics-material"),this.setMaterial(t,0),t=this.getMaterialInstance(0),t.recompileShaders({USE_LOCAL:!0}))}activeSubModel(t){if(this.model){if(this.model.subModels.length<=t){const e=i.director.root.device,n=e.createBuffer(new uo(Ys.VERTEX|Ys.TRANSFER_DST,Ks.DEVICE,65535*jB,jB)),s=e.createBuffer(new uo(Ys.INDEX|Ys.TRANSFER_DST,Ks.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new Qv([n],VB,Js.TRIANGLE_LIST,s);r.subMeshIdx=0,this.model.initSubModel(t,r,this.getMaterialInstance(0))}}else x(4500,this.node.name)}_uploadData(t){const e=this.impl;if(!e)return;const n=e&&e.getRenderDataList();if(n.length<=0||!this.model)return;const i=this.model.subModels;for(let t=0;t<n.length;t++){const e=n[t],s=i[t].inputAssembler;if(e.lastFilledVertex===e.vertexStart)continue;const r=new Float32Array(e.vData.buffer,0,e.vertexStart*kB);s.vertexBuffers[0].update(r),s.vertexCount=e.vertexStart;const o=new Uint16Array(e.iData.buffer,0,e.indicesStart);s.indexBuffer.update(o),s.indexCount=e.indicesStart,e.lastFilledVertex=e.vertexStart,e.lastFilledIndices=e.indicesStart}t.removeUploadBuffersFunc(this),this._isNeedUploadData=!1}_render(t){if(this._isNeedUploadData){if(this.impl){const t=this.impl.getRenderDataList(),e=this.model.subModels.length;if(t.length>e)for(let n=e;n<t.length;n++)this.activeSubModel(n)}t.addUploadBuffersFunc(this,this._uploadData)}t.commitModel(this,this.model,this.getMaterialInstance(0))}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}_canRender(){return!!super._canRender()&&!!this.model&&this._isDrawing}},GB.LineJoin=Zz,GB.LineCap=$z,Gl((MB=HB).prototype,"lineWidth",[ch],Object.getOwnPropertyDescriptor(MB.prototype,"lineWidth"),MB.prototype),Gl(MB.prototype,"lineJoin",[TB,EB],Object.getOwnPropertyDescriptor(MB.prototype,"lineJoin"),MB.prototype),Gl(MB.prototype,"lineCap",[CB,AB],Object.getOwnPropertyDescriptor(MB.prototype,"lineCap"),MB.prototype),Gl(MB.prototype,"strokeColor",[bB],Object.getOwnPropertyDescriptor(MB.prototype,"strokeColor"),MB.prototype),Gl(MB.prototype,"fillColor",[wB],Object.getOwnPropertyDescriptor(MB.prototype,"fillColor"),MB.prototype),Gl(MB.prototype,"miterLimit",[RB],Object.getOwnPropertyDescriptor(MB.prototype,"miterLimit"),MB.prototype),Gl(MB.prototype,"color",[bh,IB],Object.getOwnPropertyDescriptor(MB.prototype,"color"),MB.prototype),Gl(MB.prototype,"srcBlendFactor",[bh,PB],Object.getOwnPropertyDescriptor(MB.prototype,"srcBlendFactor"),MB.prototype),Gl(MB.prototype,"dstBlendFactor",[bh,OB],Object.getOwnPropertyDescriptor(MB.prototype,"dstBlendFactor"),MB.prototype),NB=Gl(MB.prototype,"_lineWidth",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),LB=Gl(MB.prototype,"_strokeColor",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ln.BLACK.clone()}}),zB=Gl(MB.prototype,"_lineJoin",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zz.MITER}}),BB=Gl(MB.prototype,"_lineCap",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $z.BUTT}}),FB=Gl(MB.prototype,"_fillColor",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ln.WHITE.clone()}}),UB=Gl(MB.prototype,"_miterLimit",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),DB=MB))||DB)||DB)||DB)||DB));var qB,XB,YB,KB,$B,ZB,JB,QB,tF,eF,nF,iF,sF,rF,oF,aF,cF,lF,hF,_F,uF,dF,pF,mF,fF,gF,vF;const yF=new bn,xF=new rn,SF=new bn,TF=[];let EF;!function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",t[t.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(EF||(EF={})),Xt(EF);let CF=t("Mask",(qB=Yl("cc.Mask"),XB=ah(),YB=$l(110),KB=ih(),$B=Ah(EF),ZB=gh(),JB=_h(),QB=gh(),tF=_h(),eF=lh(),nF=Ah(HM),iF=lh(),sF=lh(),rF=uh(),oF=lh(),aF=lh(),cF=lh(),lF=lh(),qB(hF=XB(hF=YB(hF=KB((vF=gF=class t extends UL{get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==EF.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}get inverted(){return this._inverted}set inverted(t){i.game.renderType!==of.RENDER_TYPE_CANVAS?(this._inverted=t,this.stencilStage=lL.DISABLED,this._graphics&&(this._graphics.stencilStage=lL.DISABLED)):x(4202)}get segments(){return this._segments}set segments(t){this._segments!==t&&(this._segments=He(t,3,1e4),this._updateGraphics())}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this._type===EF.IMAGE_STENCIL&&!e&&t&&this.markForUpdateRenderData()}get alphaThreshold(){return this._alphaThreshold}set alphaThreshold(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,this.type===EF.IMAGE_STENCIL&&this._graphics)&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold)}get graphics(){return this._graphics}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this.markForUpdateRenderData())}get customMaterial(){return this._customMaterial}set customMaterial(t){}constructor(){super(),this._clearStencilMtl=null,this._clearModel=null,Ul(this,"_type",uF,this),Ul(this,"_inverted",dF,this),Ul(this,"_segments",pF,this),Ul(this,"_spriteFrame",mF,this),Ul(this,"_alphaThreshold",fF,this),this._graphics=null,this._instanceMaterialType=FL.ADD_COLOR}onLoad(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()}onEnable(){super.onEnable(),this._updateGraphics(),this._broadcastToNode(this.node)}onRestore(){this._createGraphics(),this._updateGraphics()}onDisable(){super.onDisable(),this._disableGraphics()}onDestroy(){super.onDestroy(),this._clearModel&&rE.root.destroyModel(this._clearModel),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics()}isHit(t){const e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=n.width,s=n.height,r=xF;this.node.getWorldMatrix(yF),bn.invert(SF,yF),rn.transformMat4(r,t,SF);const o=e.anchorPoint;r.x+=o.x*i,r.y+=o.y*s;let a=!1;if(this.type===EF.RECT||this.type===EF.GRAPHICS_STENCIL)a=r.x>=0&&r.y>=0&&r.x<=i&&r.y<=s;else if(this.type===EF.ELLIPSE){const t=i/2,e=s/2,n=r.x-.5*i,o=r.y-.5*s;a=n*n/(t*t)+o*o/(e*e)<1}return this._inverted&&(a=!a),a}_render(t){t.commitComp(this,null,this._assembler,null)}_postRender(t){this._postAssembler&&t.commitComp(this,null,this._postAssembler,null)}_nodeStateChange(t){super._nodeStateChange(t),this._updateGraphics()}_canRender(){return!!super._canRender()&&null!==this._graphics&&(this._type!==EF.IMAGE_STENCIL||null!==this._spriteFrame)}_flushAssembler(){const e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()}_createGraphics(){if(!this._graphics){const t=this._graphics=new WB;t.node=this.node,t.node.getWorldMatrix(),t.lineWidth=0;const e=Ln.WHITE.clone();e.a=0,t.fillColor=e}this._updateMaterial()}_updateGraphics(){if(!this._graphics||this._type!==EF.RECT&&this._type!==EF.ELLIPSE)return;const t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();const n=t.contentSize,i=n.width,s=n.height,r=t.anchorPoint,o=-i*r.x,a=-s*r.y;if(this._type===EF.RECT)e.rect(o,a,i,s);else if(this._type===EF.ELLIPSE){const t=function(t,e,n){TF.length=0;const i=2*Math.PI/n;for(let s=0;s<n;++s)TF.push(new ln(e.x*Math.cos(i*s)+t.x,e.y*Math.sin(i*s)+t.y,0));return TF}(new ln(o+i/2,a+s/2,0),new ln(i/2,s/2,0),this._segments);for(let n=0;n<t.length;++n){const i=t[n];0===n?e.moveTo(i.x,i.y):e.lineTo(i.x,i.y)}e.close()}e.fill()}_createClearModel(){if(!this._clearModel){const t=Rd.get("default-clear-stencil");this._clearStencilMtl=new Dp({parent:t,owner:this,subModelIdx:0}),this._clearModel=rE.root.createModel(Wd),this._clearModel.node=this._clearModel.transform=this.node;const e=gB(uB),n=i.director.root.device,s=n.createBuffer(new uo(Ys.VERTEX|Ys.TRANSFER_DST,Ks.DEVICE,4*e,e)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);s.update(r);const o=n.createBuffer(new uo(Ys.INDEX|Ys.TRANSFER_DST,Ks.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a);const c=new Qv([s],uB,Js.TRIANGLE_LIST,o);c.subMeshIdx=0,this._clearModel.initSubModel(0,c,this._clearStencilMtl)}}_updateMaterial(){if(this._graphics){const t=this._graphics;let e;t.stencilStage=lL.DISABLED,this._type===EF.IMAGE_STENCIL?(e=Rd.get("ui-alpha-test-material"),t.setMaterial(e,0),e=t.getMaterialInstance(0),e.setProperty("alphaThreshold",this._alphaThreshold)):(e=Rd.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}}_disableGraphics(){this._graphics&&this._graphics.onDisable()}_removeGraphics(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)}_useRenderData(){this._type!==EF.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())}_broadcastToNode(e){const n=e.children;e.eventProcessor.registerComponentHitList(t);for(let t=0,e=n.length;t<e;t++)this._broadcastToNode(n[t])}},gF.Type=EF,Gl((_F=vF).prototype,"type",[$B,ZB,JB],Object.getOwnPropertyDescriptor(_F.prototype,"type"),_F.prototype),Gl(_F.prototype,"inverted",[QB,tF],Object.getOwnPropertyDescriptor(_F.prototype,"inverted"),_F.prototype),Gl(_F.prototype,"segments",[eF],Object.getOwnPropertyDescriptor(_F.prototype,"segments"),_F.prototype),Gl(_F.prototype,"spriteFrame",[nF,iF],Object.getOwnPropertyDescriptor(_F.prototype,"spriteFrame"),_F.prototype),Gl(_F.prototype,"alphaThreshold",[sF,rF,fh],Object.getOwnPropertyDescriptor(_F.prototype,"alphaThreshold"),_F.prototype),Gl(_F.prototype,"dstBlendFactor",[bh,oF],Object.getOwnPropertyDescriptor(_F.prototype,"dstBlendFactor"),_F.prototype),Gl(_F.prototype,"srcBlendFactor",[bh,aF],Object.getOwnPropertyDescriptor(_F.prototype,"srcBlendFactor"),_F.prototype),Gl(_F.prototype,"color",[bh,cF],Object.getOwnPropertyDescriptor(_F.prototype,"color"),_F.prototype),Gl(_F.prototype,"customMaterial",[bh,lF],Object.getOwnPropertyDescriptor(_F.prototype,"customMaterial"),_F.prototype),uF=Gl(_F.prototype,"_type",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return EF.RECT}}),dF=Gl(_F.prototype,"_inverted",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),pF=Gl(_F.prototype,"_segments",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),mF=Gl(_F.prototype,"_spriteFrame",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fF=Gl(_F.prototype,"_alphaThreshold",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),hF=_F))||hF)||hF)||hF)||hF));i.Mask=CF;const AF=/^(click)(\s)*=|(param)(\s)*=/,bF=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;class wF{constructor(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}parse(t){this._resultObjectArray.length=0,this._stack.length=0;let e=0;const n=t.length;for(;e<n;){let i=t.indexOf(">",e),s=-1;if(i>=0&&(s=t.lastIndexOf("<",i),s<e-1&&(s=t.indexOf("<",i+1),i=t.indexOf(">",s+1))),s<0)this._stack.pop(),this._processResult(t.substring(e)),e=n;else{let n=t.substring(e,s);const r=t.substring(s+1,i);""===r&&(n=t.substring(e,i+1)),this._processResult(n),-1===i?i=s:"/"===t.charAt(s+1)?this._stack.pop():this._addToStack(r),e=i+1}}return this._resultObjectArray}_attributeToObject(t){t=t.trim();const e={};let n=/^(color|size)(\s)*=/.exec(t),i="",s=0,r="";if(n){if(i=n[0],""===(t=t.substring(i.length).trim()))return e;switch(s=t.indexOf(" "),i[0]){case"c":e.color=s>-1?t.substring(0,s).trim():t;break;case"s":e.size=parseInt(t)}return s>-1&&(r=t.substring(s+1).trim(),e.event=this._processEventHandler(r)),e}if(n=/^(br(\s)*\/)/.exec(t),n&&n[0].length>0&&(i=n[0].trim(),i.startsWith("br")&&"/"===i[i.length-1]))return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t);let o="";if(n&&n[0].length>0&&(i=n[0].trim(),i.startsWith("img")&&"/"===i[i.length-1])){let r;n=bF.exec(t);let a=!1;for(;n;){if(i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),o=t.substring(i.length).trim(),s=o.indexOf(" "),r=s>-1?o.substr(0,s):o,i=i.replace(/[^a-zA-Z]/g,"").trim(),i=i.toLowerCase(),t=o.substring(s).trim(),r.endsWith("/")&&(r=r.slice(0,-1)),"src"===i){switch(r.charCodeAt(0)){case 34:case 39:a=!0,r=r.slice(1,-1)}e.isImage=!0,e.src=r}else if("height"===i)e.imageHeight=parseInt(r);else if("width"===i)e.imageWidth=parseInt(r);else if("align"===i){switch(r.charCodeAt(0)){case 34:case 39:r=r.slice(1,-1)}e.imageAlign=r.toLowerCase()}else"offset"===i?e.imageOffset=r:"click"===i&&(e.event=this._processEventHandler(`${i}=${r}`));e.event&&"param"===i&&(e.event[i]=r.replace(/^"|"$/g,"")),n=bF.exec(t)}return a&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(t),n){const r={color:"#ffffff",width:1};if(t=n[0].substring("outline".length).trim()){const a=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;let c;for(n=a.exec(t);n;)i=(t=t.substring(t.indexOf(n[0]))).substr(0,n[0].length),o=t.substring(i.length).trim(),s=o.indexOf(" "),c=s>-1?o.substr(0,s):o,i=i.replace(/[^a-zA-Z]/g,"").trim(),i=i.toLowerCase(),t=o.substring(s).trim(),"click"===i?e.event=this._processEventHandler(`${i}=${c}`):"color"===i?r.color=c:"width"===i&&(r.width=parseInt(c)),e.event&&"param"===i&&(e.event[i]=c.replace(/^"|"$/g,"")),n=a.exec(t)}e.outline=r}if(n=/^(on|u|b|i)(\s)*/.exec(t),n&&n[0].length>0){switch(i=n[0],t=t.substring(i.length).trim(),i[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e}_processEventHandler(t){const e={};let n=0,i=!1,s=AF.exec(t);for(;s;){let r=s[0],o="";if(i=!1,'"'===(t=t.substring(r.length).trim()).charAt(0))n=t.indexOf('"',1),n>-1&&(o=t.substring(1,n).trim(),i=!0),n++;else if("'"===t.charAt(0))n=t.indexOf("'",1),n>-1&&(o=t.substring(1,n).trim(),i=!0),n++;else{const e=/(\S)+/.exec(t);o=e?e[0]:"",n=o.length}i&&(r=r.substring(0,r.length-1).trim(),e[r]=o),t=t.substring(n).trim(),s=AF.exec(t)}return e}_addToStack(t){const e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;const t=this._stack[this._stack.length-1];for(const n in t)e[n]||(e[n]=t[n]);this._stack.push(e)}}_processResult(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))}_escapeSpecialSymbol(t){for(const e of this._specialSymbolArray){const n=e[0],i=e[1];t=t.replace(n,i)}return t}}var RF,IF,PF,OF,DF,MF,NF,LF,zF,BF,FF;t("HtmlTextParser",wF);let UF=t("LabelOutline",(RF=Yl("cc.LabelOutline"),IF=ah(),PF=$l(110),OF=ih(),DF=Kl(Qz),MF=_h(),NF=_h(),RF(LF=IF(LF=PF(LF=OF(LF=DF(LF=nh((BF=Gl((zF=class extends Nu{constructor(...t){super(...t),Ul(this,"_color",BF,this),Ul(this,"_width",FF,this)}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}get width(){return this._width}set width(t){this._width!==t&&(this._width=t,this._updateRenderData())}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const t=this.node.getComponent(Qz);t&&t.updateRenderData(!0)}}).prototype,"_color",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln(0,0,0,255)}}),FF=Gl(zF.prototype,"_width",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Gl(zF.prototype,"color",[MF],Object.getOwnPropertyDescriptor(zF.prototype,"color"),zF.prototype),Gl(zF.prototype,"width",[NF],Object.getOwnPropertyDescriptor(zF.prototype,"width"),zF.prototype),LF=zF))||LF)||LF)||LF)||LF)||LF)||LF));var GF,HF,VF,kF,jF,WF,qF,XF,YF,KF,$F,ZF,JF,QF,tU,eU,nU,iU,sU,rU,oU,aU,cU,lU,hU,_U,uU,dU,pU,mU,fU,gU,vU,yU,xU,SU,TU,EU,CU,AU,bU,wU,RU;!function(t){t[t.SIMPLE=0]="SIMPLE",t[t.SLICED=1]="SLICED",t[t.TILED=2]="TILED",t[t.FILLED=3]="FILLED"}(AU||(AU={})),Xt(AU),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.RADIAL=2]="RADIAL"}(bU||(bU={})),Xt(bU),function(t){t[t.CUSTOM=0]="CUSTOM",t[t.TRIMMED=1]="TRIMMED",t[t.RAW=2]="RAW"}(wU||(wU={})),Xt(wU),function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(RU||(RU={}));let IU=t("Sprite",(GF=Yl("cc.Sprite"),HF=ah(),VF=$l(110),kF=ih(),jF=Ah(WM),WF=gh(),qF=_h(),XF=Ah(HM),YF=gh(),KF=_h(),$F=Ah(AU),ZF=gh(),JF=_h(),QF=Ah(bU),tU=_h(),eU=_h(),nU=uh(),iU=_h(),sU=uh(),rU=_h(),oU=gh(),aU=_h(),cU=Ah(wU),lU=gh(),hU=_h(),GF(_U=HF(_U=VF(_U=kF((CU=EU=class t extends UL{constructor(...t){super(...t),Ul(this,"_spriteFrame",dU,this),Ul(this,"_type",pU,this),Ul(this,"_fillType",mU,this),Ul(this,"_sizeMode",fU,this),Ul(this,"_fillCenter",gU,this),Ul(this,"_fillStart",vU,this),Ul(this,"_fillRange",yU,this),Ul(this,"_isTrimmedMode",xU,this),Ul(this,"_useGrayscale",SU,this),Ul(this,"_atlas",TU,this)}get spriteAtlas(){return this._atlas}set spriteAtlas(t){this._atlas!==t&&(this._atlas=t)}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(!1),this._applySpriteFrame(e)}get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this._flushAssembler())}get fillType(){return this._fillType}set fillType(t){this._fillType!==t&&(t===bU.RADIAL||this._fillType===bU.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}get fillCenter(){return this._fillCenter}set fillCenter(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,this._type===AU.FILLED&&this._renderData&&this.markForUpdateRenderData()}get fillStart(){return this._fillStart}set fillStart(t){this._fillStart=He(t,-1,1),this._type===AU.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get fillRange(){return this._fillRange}set fillRange(t){this._fillRange=He(t,-1,1),this._type===AU.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get trim(){return this._isTrimmedMode}set trim(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,this._type===AU.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}get grayscale(){return this._useGrayscale}set grayscale(t){this._useGrayscale!==t&&(this._useGrayscale=t,this._instanceMaterialType=!0===t?FL.GRAYSCALE:FL.ADD_COLOR_AND_TEXTURE,this.updateMaterial())}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,t!==wU.CUSTOM&&this._applySpriteSize())}__preload(){this.changeMaterialForDefine(),super.__preload(),this._spriteFrame&&(this._spriteFrame.on("load",this._markForUpdateUvDirty,this),this._markForUpdateUvDirty())}onEnable(){super.onEnable(),this._activateMaterial()}onDestroy(){this.destroyRenderData(),this._spriteFrame&&this._spriteFrame.off("load"),super.onDestroy()}changeSpriteFrameFromAtlas(t){if(!this._atlas)return void console.warn("SpriteAtlas is null.");const e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}changeMaterialForDefine(){let t;this._spriteFrame&&(t=this._spriteFrame.texture);let e=!1;if(t instanceof $_){const n=t.getPixelFormat();e=n===x_.RGBA_ETC1||n===x_.RGB_A_PVRTC_4BPPV1||n===x_.RGB_A_PVRTC_2BPPV1}e&&this.grayscale?this._instanceMaterialType=FL.USE_ALPHA_SEPARATED_AND_GRAY:e?this._instanceMaterialType=FL.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=FL.GRAYSCALE:this._instanceMaterialType=FL.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}_render(t){t.commitComp(this,this._spriteFrame,this._assembler,null)}_canRender(){if(!super._canRender())return!1;const t=this._spriteFrame;return!(!t||!t.textureLoaded())}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this._updateColor())}_applySpriteSize(){if(this._spriteFrame){if(wU.RAW===this._sizeMode){const t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(wU.TRIMMED===this._sizeMode){const t=this._spriteFrame.getRect();this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}}_resized(){}_activateMaterial(){const t=this._spriteFrame,e=this.getRenderMaterial(0);i.game.renderType!==i.game.RENDER_TYPE_CANVAS?(t&&e&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=e)):this.markForUpdateRenderData()}_onTextureLoaded(){this.isValid&&(this.changeMaterialForDefine(),this._applySpriteSize())}_applySpriteFrame(t){const e=this._spriteFrame;this._renderData&&(t&&t.off("load",this._markForUpdateUvDirty),e&&e.on("load",this._markForUpdateUvDirty,this),this._renderData.uvDirty||(this._renderData.uvDirty=!t||!e||t.uvHash!==e.uvHash),this._renderDataFlag=this._renderData.uvDirty),e&&(t&&e===t||(e.loaded?this._onTextureLoaded():e.once("load",this._onTextureLoaded,this)))}_markForUpdateUvDirty(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},EU.FillType=bU,EU.Type=AU,EU.SizeMode=wU,EU.EventType=RU,Gl((uU=CU).prototype,"spriteAtlas",[jF,WF,qF],Object.getOwnPropertyDescriptor(uU.prototype,"spriteAtlas"),uU.prototype),Gl(uU.prototype,"spriteFrame",[XF,YF,KF],Object.getOwnPropertyDescriptor(uU.prototype,"spriteFrame"),uU.prototype),Gl(uU.prototype,"type",[$F,ZF,JF],Object.getOwnPropertyDescriptor(uU.prototype,"type"),uU.prototype),Gl(uU.prototype,"fillType",[QF,tU],Object.getOwnPropertyDescriptor(uU.prototype,"fillType"),uU.prototype),Gl(uU.prototype,"fillCenter",[eU],Object.getOwnPropertyDescriptor(uU.prototype,"fillCenter"),uU.prototype),Gl(uU.prototype,"fillStart",[nU,iU],Object.getOwnPropertyDescriptor(uU.prototype,"fillStart"),uU.prototype),Gl(uU.prototype,"fillRange",[sU,rU],Object.getOwnPropertyDescriptor(uU.prototype,"fillRange"),uU.prototype),Gl(uU.prototype,"trim",[oU,aU],Object.getOwnPropertyDescriptor(uU.prototype,"trim"),uU.prototype),Gl(uU.prototype,"grayscale",[ch],Object.getOwnPropertyDescriptor(uU.prototype,"grayscale"),uU.prototype),Gl(uU.prototype,"sizeMode",[cU,lU,hU],Object.getOwnPropertyDescriptor(uU.prototype,"sizeMode"),uU.prototype),dU=Gl(uU.prototype,"_spriteFrame",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pU=Gl(uU.prototype,"_type",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AU.SIMPLE}}),mU=Gl(uU.prototype,"_fillType",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bU.HORIZONTAL}}),fU=Gl(uU.prototype,"_sizeMode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wU.TRIMMED}}),gU=Gl(uU.prototype,"_fillCenter",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rn(0,0)}}),vU=Gl(uU.prototype,"_fillStart",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yU=Gl(uU.prototype,"_fillRange",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xU=Gl(uU.prototype,"_isTrimmedMode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SU=Gl(uU.prototype,"_useGrayscale",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TU=Gl(uU.prototype,"_atlas",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_U=uU))||_U)||_U)||_U)||_U));var PU;let OU=t("RenderRoot2D",Yl("cc.RenderRoot2D")(PU=$l(100)(PU=ih()(PU=Kl(hL)(PU=Zl(PU=nh(PU=class extends Nu{onEnable(){i.director.root.batcher2D.addScreen(this)}onDisable(){i.director.root.batcher2D.removeScreen(this)}onDestroy(){i.director.root.batcher2D.removeScreen(this)}})||PU)||PU)||PU)||PU)||PU)||PU);var DU,MU,NU,LU,zU,BU,FU,UU,GU,HU,VU,kU;const jU=new ln,WU=jt({OVERLAY:0,INTERSPERSE:1});let qU=t("Canvas",(DU=Yl("cc.Canvas"),MU=ah(),NU=$l(100),LU=ih(),zU=Ah(LA),BU=_h(),FU=_h(),UU=Ah(LA),DU(GU=MU(GU=NU(GU=LU(GU=nh(GU=Zl((Gl((HU=class extends OU{get renderMode(){return this._renderMode}set renderMode(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}get cameraComponent(){return this._cameraComponent}set cameraComponent(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}get alignCanvasWithScreen(){return this._alignCanvasWithScreen}set alignCanvasWithScreen(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}constructor(){super(),Ul(this,"_cameraComponent",VU,this),Ul(this,"_alignCanvasWithScreen",kU,this),this._thisOnCameraResized=void 0,this._fitDesignResolution=void 0,this._pos=new ln,this._renderMode=WU.OVERLAY,this._thisOnCameraResized=this._onResizeCamera.bind(this)}__preload(){const t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&this._cameraComponent._createCamera(),this._onResizeCamera(),this.node.on(pf.TRANSFORM_CHANGED,this._thisOnCameraResized)}onDestroy(){super.onDestroy(),this.node.off(pf.TRANSFORM_CHANGED,this._thisOnCameraResized)}_onResizeCamera(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture){const t=this._cameraComponent.targetTexture.window;this._cameraComponent.camera&&this._cameraComponent.camera.setFixedSize(t.width,t.height),this._cameraComponent.orthoHeight=Lm.height/2}else if(af.canvas){const t=af.canvas;this._cameraComponent.camera&&this._cameraComponent.camera.resize(t.width,t.height),this._cameraComponent.orthoHeight=af.canvas.height/df.getScaleY()/2}this.node.getWorldPosition(jU),this._cameraComponent.node.setWorldPosition(jU.x,jU.y,1e3)}}_getViewPriority(){if(this._cameraComponent){var t;let e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return e=this._renderMode===WU.OVERLAY?e|1<<30:e&~(1<<30),e}return 0}}).prototype,"cameraComponent",[zU,BU],Object.getOwnPropertyDescriptor(HU.prototype,"cameraComponent"),HU.prototype),Gl(HU.prototype,"alignCanvasWithScreen",[FU],Object.getOwnPropertyDescriptor(HU.prototype,"alignCanvasWithScreen"),HU.prototype),VU=Gl(HU.prototype,"_cameraComponent",[UU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kU=Gl(HU.prototype,"_alignCanvasWithScreen",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),GU=HU))||GU)||GU)||GU)||GU)||GU)||GU));var XU;i.Canvas=qU;let YU=t("UIComponent",Yl("cc.UIComponent")(XU=Kl(hL)(XU=$l(110)(XU=Zl(XU=nh(XU=class extends Nu{constructor(...t){super(...t),this._lastParent=null,this.stencilStage=lL.DISABLED}__preload(){this.node._uiProps.uiComp=this}onEnable(){}onDisable(){}onDestroy(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}updateAssembler(t){}postUpdateAssembler(t){}})||XU)||XU)||XU)||XU)||XU);var KU,$U,ZU,JU,QU,tG,eG,nG,iG,sG,rG,oG,aG,cG,lG,hG,_G,uG,dG,pG,mG,fG,gG,vG,yG,xG,SG,TG,EG,CG,AG,bG,wG,RG,IG;const PG=new wF,OG=new Gt(t=>{if(!i.isValid(t.node))return!1;{const e=t.node.getComponent(UF);e&&(e.width=0)}return!0},20),DG=new Gt(t=>i.isValid(t.node),10);function MG(t){return{node:new DT(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function NG(t,e){let n;"RICHTEXT_CHILD"===t?n=OG._get():"RICHTEXT_Image_CHILD"===t&&(n=DG._get()),n=n||MG(t);let i=n.node;return i||(i=new DT(t)),"RICHTEXT_Image_CHILD"===t?(n.comp=i.getComponent(IU)||i.addComponent(IU),n.comp.spriteFrame=e,n.comp.type=IU.Type.SLICED,n.comp.sizeMode=IU.SizeMode.CUSTOM):(n.comp=i.getComponent(Qz)||i.addComponent(Qz),n.comp.string=e,n.comp.horizontalAlign=qz.LEFT,n.comp.verticalAlign=Xz.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var LG;t("RichText",(KU=Yl("cc.RichText"),$U=ah(),ZU=$l(110),JU=ih(),QU=_h(),tG=Ah(qz),eG=_h(),nG=_h(),iG=_h(),sG=Ah(XM),rG=_h(),oG=_h(),aG=Ah(Kz),cG=_h(),lG=_h(),hG=_h(),_G=Ah(WM),uG=_h(),dG=_h(),KU(pG=$U(pG=ZU(pG=JU(pG=nh((IG=RG=class extends YU{get string(){return this._string}set string(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}get font(){return this._font}set font(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}get maxWidth(){return this._maxWidth}set maxWidth(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}get imageAtlas(){return this._imageAtlas}set imageAtlas(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}get handleTouchEvent(){return this._handleTouchEvent}set handleTouchEvent(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}constructor(){super(),Ul(this,"_lineHeight",fG,this),Ul(this,"_string",gG,this),Ul(this,"_horizontalAlign",vG,this),Ul(this,"_fontSize",yG,this),Ul(this,"_maxWidth",xG,this),Ul(this,"_fontFamily",SG,this),Ul(this,"_font",TG,this),Ul(this,"_isSystemFontUsed",EG,this),Ul(this,"_userDefinedFont",CG,this),Ul(this,"_cacheMode",AG,this),Ul(this,"_imageAtlas",bG,this),Ul(this,"_handleTouchEvent",wG,this),this._textArray=[],this._segments=[],this._labelSegmentsCache=[],this._linesWidth=[],this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0,this._lineOffsetX=0,this._updateRichTextStatus=void 0,this._updateRichTextStatus=this._updateRichText}onLoad(){this.node.on(pf.LAYER_CHANGED,this._applyLayer,this)}onEnable(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}onDisable(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}start(){this._onTTFLoaded(),this.node.on(sx.EventType.ANCHOR_CHANGED,this._updateRichTextPosition,this)}onRestore(){}onDestroy(){for(const t of this._segments)t.node.removeFromParent(),"RICHTEXT_CHILD"===t.type?OG.put(t):"RICHTEXT_Image_CHILD"===t.type&&DG.put(t);this.node.off(sx.EventType.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(pf.LAYER_CHANGED,this._applyLayer,this)}_addEventListeners(){this.node.on(sx.EventType.TOUCH_END,this._onTouchEnded,this)}_removeEventListeners(){this.node.off(sx.EventType.TOUCH_END,this._onTouchEnded,this)}_updateLabelSegmentTextAttributes(){this._segments.forEach(t=>{this._applyTextAttribute(t)})}_createFontLabel(t){return NG("RICHTEXT_CHILD",t)}_createImage(t){return NG("RICHTEXT_Image_CHILD",t)}_onTTFLoaded(){this._font instanceof ZM?this._font._nativeAsset?(this._layoutDirty=!0,this._updateRichText()):dC.postLoadNative(this._font,()=>{this.isValid&&(this._layoutDirty=!0,this._updateRichText())}):(this._layoutDirty=!0,this._updateRichText())}_measureText(t,e){const n=e=>{let n;return 0===this._labelSegmentsCache.length?(n=this._createFontLabel(e),this._labelSegmentsCache.push(n)):(n=this._labelSegmentsCache[0],n.node.getComponent(Qz).string=e),n.styleIndex=t,this._applyTextAttribute(n),n.node._uiProps.uiTransformComp.contentSize.width};return e?n(e):n}_onTouchEnded(t){const e=this.node.getComponents(Nu);for(const n of this._segments){const i=n.clickHandler,s=n.clickParam;i&&this._containsTouchLocation(n,t.touch.getUILocation())&&(e.forEach(e=>{const n=e[i];e.enabledInHierarchy&&n&&n.call(e,t,s)}),t.propagationStopped=!0)}}_containsTouchLocation(t,e){const n=t.node.getComponent(hL);return!!n&&n.getBoundingBoxToWorld().contains(e)}_resetState(){const t=this.node.children;for(let e=t.length-1;e>=0;e--){const n=t[e];if("RICHTEXT_CHILD"===n.name||"RICHTEXT_Image_CHILD"===n.name){n.parent===this.node?n.parent=null:t.splice(e,1);const i=MG(n.name);i.node=n,"RICHTEXT_CHILD"===n.name?(i.comp=n.getComponent(Qz),OG.put(i)):(i.comp=n.getComponent(IU),DG.put(i))}}t.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}_activateChildren(t){for(let e=this.node.children.length-1;e>=0;e--){const n=this.node.children[e];"RICHTEXT_CHILD"!==n.name&&"RICHTEXT_Image_CHILD"!==n.name||(n.active=t)}}_addLabelSegment(t,e){let n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(t);else{n=this._labelSegmentsCache.pop();const e=n.node.getComponent(Qz);e&&(e.string=t)}return n.styleIndex=e,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this._applyTextAttribute(n),this.node.addChild(n.node),this._segments.push(n),n}_updateRichTextWithMaxWidth(t,e,n){let i,s=e;if(this._lineOffsetX>0&&s+this._lineOffsetX>this._maxWidth){let e=0;for(;this._lineOffsetX<=this._maxWidth;){const i=this._getFirstWordLen(t,e,t.length),r=t.substr(e,i),o=this._measureText(n,r);if(!(this._lineOffsetX+o<=this._maxWidth)){if(e>0){const i=t.substr(0,e);this._addLabelSegment(i,n),t=t.substr(e,t.length),s=this._measureText(n,t)}this._updateLineInfo();break}this._lineOffsetX+=o,e+=i}}if(s>this._maxWidth){const e=CN(t,s,this._maxWidth,this._measureText(n));for(let t=0;t<e.length;++t){const s=e[t];i=this._addLabelSegment(s,n);const r=i.node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=r.width,e.length>1&&t<e.length-1&&this._updateLineInfo()}}else this._lineOffsetX+=s,this._addLabelSegment(t,n)}_isLastComponentCR(t){return t.length-1===t.lastIndexOf("\n")}_updateLineInfo(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}_needsUpdateTextLayout(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(let e=0;e<this._textArray.length;e++){const n=this._textArray[e],i=t[e];if(n.text!==i.text)return!0;{const t=n.style,e=i.style;if(t){if(e){if(!!e.outline!=!!t.outline)return!0;if(t.size!==e.size||t.italic!==e.italic||t.isImage!==e.isImage)return!0;if(t.src!==e.src||t.imageAlign!==e.imageAlign||t.imageHeight!==e.imageHeight||t.imageWidth!==e.imageWidth||t.imageOffset!==e.imageOffset)return!0}else if(t.size||t.italic||t.isImage||t.outline)return!0}else if(e&&(e.size||e.italic||e.isImage||e.outline))return!0}}return!1}_addRichTextImageElement(t){if(!t.style)return;const e=t.style,n=e.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){const t=this._createImage(i);switch(t.comp,e.imageAlign){case"top":t.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":t.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:t.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.node.layer=this.node.layer,this.node.addChild(t.node),this._segments.push(t);const n=i.rect.clone();let s=1,r=n.width,o=n.height;const a=e.imageWidth||0,c=e.imageHeight||0;c>0?(s=c/o,r*=s,o*=s):(s=this._lineHeight/o,r*=s,o*=s),a>0&&(r=a),this._maxWidth>0?(this._lineOffsetX+r>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=r):(this._lineOffsetX+=r,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),t.node._uiProps.uiTransformComp.setContentSize(r,o),t.lineCount=this._lineCount,t.clickHandler="",t.clickParam="";const l=e.event;l&&(t.clickHandler=l.click,t.clickParam=l.param)}else x(4400)}_updateRichText(){if(!this.enabledInHierarchy)return;const t=PG.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();let e,n=!1;for(let t=0;t<this._textArray.length;++t){const i=this._textArray[t],s=i.text;if(void 0===s)continue;if(""===s){if(i.style&&i.style.isNewLine){this._updateLineInfo();continue}if(i.style&&i.style.isImage&&this._imageAtlas){this._addRichTextImageElement(i);continue}}const r=s.split("\n");for(let i=0;i<r.length;++i){const o=r[i];if(""!==o)if(n=!1,this._maxWidth>0){const e=this._measureText(t,o);this._updateRichTextWithMaxWidth(o,e,t),r.length>1&&i<r.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(o,t),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),r.length>1&&i<r.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(s)&&i===r.length-1)continue;this._updateLineInfo(),n=!0}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+_N)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}_getFirstWordLen(t,e,n){let i=t.charAt(e);if(xN(i)||SN(i))return 1;let s=1;for(let r=e+1;r<n&&(i=t.charAt(r),!SN(i)&&!xN(i));++r)s++;return s}_updateRichTextPosition(){let t=0,e=1;const n=this._lineCount,i=this.node._uiProps.uiTransformComp,s=i.anchorX,r=i.anchorY;for(let i=0;i<this._segments.length;++i){const o=this._segments[i],a=o.lineCount;a>e&&(t=0,e=a);let c=this._labelWidth*(.5*this._horizontalAlign-s);switch(this._horizontalAlign){case qz.LEFT:break;case qz.CENTER:c-=this._linesWidth[a-1]/2;break;case qz.RIGHT:c-=this._linesWidth[a-1]}const l=o.node.position;if(o.node.setPosition(t+c,this._lineHeight*(n-a)-this._labelHeight*r,l.z),a===e&&(t+=o.node._uiProps.uiTransformComp.width),o.node.getComponent(IU)){const t=o.node.position.clone(),e=this._lineHeight,n=this._lineHeight*(1+_N);switch(o.node._uiProps.uiTransformComp.anchorY){case 1:t.y+=e+(n-e)/2;break;case.5:t.y+=n/2;break;default:t.y+=(n-e)/2}if(o.imageOffset){const e=o.imageOffset.split(",");if(1===e.length&&e[0]){const n=parseFloat(e[0]);Number.isInteger(n)&&(t.y+=n)}else if(2===e.length){const n=parseFloat(e[0]),i=parseFloat(e[1]);Number.isInteger(n)&&(t.x+=n),Number.isInteger(i)&&(t.y+=i)}}o.node.position=t}const h=o.node.getComponent(UF);if(h){const t=o.node.position.clone();t.y-=h.width,o.node.position=t}}}_convertLiteralColorValue(t){const e=t.toUpperCase();return Ln[e]?Ln[e]:(new Ln).fromHEX(t)}_applyTextAttribute(t){const e=t.node.getComponent(Qz);if(!e)return;const n=t.styleIndex;let i;if(this._textArray[n]&&(i=this._textArray[n].style),i){if(e.color=this._convertLiteralColorValue(i.color||"white"),e.isBold=!!i.bold,e.isItalic=!!i.italic,e.isUnderline=!!i.underline,i.outline){let e=t.node.getComponent(UF);e||(e=t.node.addComponent(UF)),e.color=this._convertLiteralColorValue(i.outline.color),e.width=i.outline.width}e.fontSize=i.size||this._fontSize,t.clickHandler="",t.clickParam="";const n=i.event;n&&(t.clickHandler=n.click||"",t.clickParam=n.param||"")}else e.fontSize=this._fontSize;e.cacheMode=this._cacheMode,this._font instanceof XM&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0);const s=e._assembler;s&&s.updateRenderData(e)}_applyLayer(){for(const t of this._segments)t.node.layer=this.node.layer}},RG.HorizontalAlign=qz,RG.VerticalAlign=Xz,Gl((mG=IG).prototype,"string",[yh,QU],Object.getOwnPropertyDescriptor(mG.prototype,"string"),mG.prototype),Gl(mG.prototype,"horizontalAlign",[tG,eG],Object.getOwnPropertyDescriptor(mG.prototype,"horizontalAlign"),mG.prototype),Gl(mG.prototype,"fontSize",[nG],Object.getOwnPropertyDescriptor(mG.prototype,"fontSize"),mG.prototype),Gl(mG.prototype,"fontFamily",[iG],Object.getOwnPropertyDescriptor(mG.prototype,"fontFamily"),mG.prototype),Gl(mG.prototype,"font",[sG,rG],Object.getOwnPropertyDescriptor(mG.prototype,"font"),mG.prototype),Gl(mG.prototype,"useSystemFont",[oG],Object.getOwnPropertyDescriptor(mG.prototype,"useSystemFont"),mG.prototype),Gl(mG.prototype,"cacheMode",[aG,cG],Object.getOwnPropertyDescriptor(mG.prototype,"cacheMode"),mG.prototype),Gl(mG.prototype,"maxWidth",[lG],Object.getOwnPropertyDescriptor(mG.prototype,"maxWidth"),mG.prototype),Gl(mG.prototype,"lineHeight",[hG],Object.getOwnPropertyDescriptor(mG.prototype,"lineHeight"),mG.prototype),Gl(mG.prototype,"imageAtlas",[_G,uG],Object.getOwnPropertyDescriptor(mG.prototype,"imageAtlas"),mG.prototype),Gl(mG.prototype,"handleTouchEvent",[dG],Object.getOwnPropertyDescriptor(mG.prototype,"handleTouchEvent"),mG.prototype),fG=Gl(mG.prototype,"_lineHeight",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),gG=Gl(mG.prototype,"_string",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),vG=Gl(mG.prototype,"_horizontalAlign",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qz.LEFT}}),yG=Gl(mG.prototype,"_fontSize",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),xG=Gl(mG.prototype,"_maxWidth",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),SG=Gl(mG.prototype,"_fontFamily",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),TG=Gl(mG.prototype,"_font",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),EG=Gl(mG.prototype,"_isSystemFontUsed",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),CG=Gl(mG.prototype,"_userDefinedFont",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),AG=Gl(mG.prototype,"_cacheMode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Kz.NONE}}),bG=Gl(mG.prototype,"_imageAtlas",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wG=Gl(mG.prototype,"_handleTouchEvent",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),pG=mG))||pG)||pG)||pG)||pG)||pG)),t("UIMeshRenderer",Yl("cc.UIMeshRenderer")(LG=ah()(LG=$l(110)(LG=ih()(LG=class extends YU{constructor(...t){super(...t),this._models=null,this._modelComponent=null}get modelComponent(){return this._modelComponent}onLoad(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn(`node '${this.node&&this.node.name}' doesn't have any renderable component`)}onEnable(){super.onEnable()}onDisable(){super.onDisable()}onDestroy(){super.onDestroy(),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)}updateAssembler(t){if(this._models){this._modelComponent._detachFromScene();for(const e of this._models)t.commitModel.call(t,this,e,this._modelComponent.material);return!0}return!1}update(){this._fitUIRenderQueue()}_fitUIRenderQueue(){if(!this._modelComponent)return;const t=this._modelComponent.sharedMaterials.length;for(let e=0;e<t;e++){const t=this._modelComponent.getMaterialInstance(e);if(null==t)continue;const n=t.passes,i=n.length;for(let e=0;e<i;e++){const i=n[e];i._priority=Sc.MAX-11,i.blendState.targets[0].blend||t.overridePipelineStates({blendState:{targets:[{blend:!0}]}},e)}}}})||LG)||LG)||LG)||LG);class zG{get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(t){this.vData=null,this.iData=null,this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=1,this._attributes=null,this._vertexBuffers=[],this._indexBuffer=null,this._iaInfo=null,this._batcher=void 0,this._dirty=!1,this._vertexFormatBytes=0,this._initVDataCount=0,this._initIDataCount=1536,this._outOfCallback=null,this._hInputAssemblers=[],this._nextFreeIAHandle=0,this._batcher=t}get vertexFormatBytes(){return this._vertexFormatBytes}initialize(t,e){this._outOfCallback=e;const n=fB(t);this._vertexFormatBytes=n*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes;const i=Float32Array.BYTES_PER_ELEMENT*n;this.vertexBuffers.length||this.vertexBuffers.push(this._batcher.device.createBuffer(new uo(Ys.VERTEX|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,i,i)));const s=Uint16Array.BYTES_PER_ELEMENT;this.indexBuffer||(this._indexBuffer=this._batcher.device.createBuffer(new uo(Ys.INDEX|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,s,s))),this._attributes=t,this._iaInfo=new Vo(this.attributes,this.vertexBuffers,this.indexBuffer),this._reallocBuffer()}request(t=4,e=6){this.lastByteOffset=this.byteOffset;const n=this.byteOffset+t*this._vertexFormatBytes,i=this.indicesOffset+e;if(t+this.vertexOffset>65535)return this._outOfCallback&&this._outOfCallback.call(this._batcher,t,e),!1;let s=this.vData.byteLength,r=this.iData.length;if(n>s||i>r){for(;s<n||r<i;)this._initVDataCount*=2,this._initIDataCount*=2,s=4*this._initVDataCount,r=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=t,this.indicesOffset+=e,this.byteOffset=n,this._dirty=!0,!0}reset(){this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this._nextFreeIAHandle=0,this._dirty=!1}destroy(){this._attributes=null,this.vertexBuffers[0].destroy(),this.vertexBuffers.length=0,this.indexBuffer.destroy(),this._indexBuffer=null;for(let t=0;t<this._hInputAssemblers.length;t++)$n.free(this._hInputAssemblers[t]);this._hInputAssemblers.length=0}recordBatch(){const t=this.indicesOffset-this.indicesStart;if(!t)return 0;this._hInputAssemblers.length<=this._nextFreeIAHandle&&this._hInputAssemblers.push($n.alloc(this._batcher.device,this._iaInfo));const e=this._hInputAssemblers[this._nextFreeIAHandle++],n=$n.get(e);return n.firstIndex=this.indicesStart,n.indexCount=t,e}uploadBuffers(){if(0===this.byteOffset||!this._dirty)return;const t=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),e=new Uint16Array(this.iData.buffer,0,this.indicesOffset);this.byteOffset>this.vertexBuffers[0].size&&this.vertexBuffers[0].resize(this.byteOffset),this.vertexBuffers[0].update(t),2*this.indicesOffset>this.indexBuffer.size&&this.indexBuffer.resize(2*this.indicesOffset),this.indexBuffer.update(e),this._dirty=!1}_reallocBuffer(){this._reallocVData(!0),this._reallocIData(!0)}_reallocVData(t){let e;if(this.vData&&(e=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),e&&t){const t=new Uint8Array(this.vData.buffer);for(let n=0,i=e.length;n<i;n++)t[n]=e[n]}}_reallocIData(t){const e=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),e&&t){const t=this.iData;for(let n=0,i=e.length;n<i;n++)t[n]=e[n]}}}t("MeshBuffer",zG),zG.OPACITY_OFFSET=8;const BG=yc.Enum.NONE|yc.Enum.UI_3D;class FG{get handle(){return this._handle}get hInputAssembler(){return yi.get(this._handle,gi.INPUT_ASSEMBLER)}set hInputAssembler(t){yi.set(this._handle,gi.INPUT_ASSEMBLER,t)}get hDescriptorSet(){return yi.get(this._handle,gi.DESCRIPTOR_SET)}set hDescriptorSet(t){yi.set(this._handle,gi.DESCRIPTOR_SET,t)}get visFlags(){return yi.get(this._handle,gi.VIS_FLAGS)}set visFlags(t){yi.set(this._handle,gi.VIS_FLAGS,t)}get passes(){return this._passes}constructor(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._handle=0,this._passes=[],this._handle=yi.alloc(),yi.set(this._handle,gi.VIS_FLAGS,BG),yi.set(this._handle,gi.INPUT_ASSEMBLER,0),yi.set(this._handle,gi.DESCRIPTOR_SET,0)}destroy(t){if(this._handle){const t=this.passes.length;for(let e=0;e<t;e++)this.passes[e]._destroyHandle();this._passes=[],yi.free(this._handle),this._handle=0}}clear(){this.bufferBatch=null,this.hInputAssembler=0,this.hDescriptorSet=0,this.camera=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=BG}fillPasses(t,e,n,s,r,o){if(t){const a=t.passes;if(!a)return;yi.set(this._handle,gi.PASS_COUNT,a.length);let c=gi.PASS_0,l=gi.SHADER_0,h=0;for(let t=0;t<a.length;t++,c++,l++){this._passes[t]||(this._passes[t]=new Nd(i.director.root),this._passes[t]._handle=hi.alloc());const _=a[t],u=this._passes[t];e||(e=_.depthStencilState,n=0),s||(s=_.blendState,r=0),-1===r&&(r=0),h=n<<16|r,_.update(),u._initPassFromTarget(_,e,s,h),yi.set(this._handle,c,u.handle),yi.set(this._handle,l,u.getShaderVariant(o))}}}}var UG,GG,HG,VG,kG,jG,WG,qG,XG,YG,KG,$G,ZG,JG,QG,tH,eH,nH,iH,sH,rH,oH;t("UIStaticBatch",(UG=Yl("cc.UIStaticBatch"),GG=ah(),HG=ih(),VG=$l(110),kG=lh(),jG=lh(),WG=lh(),UG(qG=GG(qG=HG(qG=VG((Gl((XG=class extends UL{constructor(...t){super(...t),this._init=!1,this._meshBuffer=null,this._dirty=!0,this._lastMeshBuffer=null,this._uiDrawBatchList=[]}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateColor(),this.markForUpdateRenderData())}get drawBatchList(){return this._uiDrawBatchList}onLoad(){const t=this._getBatcher();if(!t)return;const e=pB,n=new zG(t);n.initialize(e,this._arrivalMaxBuffer.bind(this)),this._meshBuffer=n}onDestroy(){super.onDestroy(),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)}updateAssembler(t){this._dirty&&(t.finishMergeBatches(),this._lastMeshBuffer=t.currBufferBatch,t.currBufferBatch=this._meshBuffer,t.currStaticRoot=this),this._init&&(t.finishMergeBatches(),t.commitStaticBatch(this))}postUpdateAssembler(t){this._dirty&&(t.finishMergeBatches(),t.currBufferBatch=this._lastMeshBuffer,t.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadBuffers())}markAsDirty(){this._getBatcher()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())}_requireDrawBatch(){const t=new FG;return t.isStatic=!0,this._uiDrawBatchList.push(t),t}_clearData(){if(this._meshBuffer){this._meshBuffer.reset();const t=this._getBatcher();for(let e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1}_getBatcher(){return rE.root&&rE.root.batcher2D?rE.root.batcher2D:(x(9301),null)}_arrivalMaxBuffer(){const t=this._getBatcher();t&&t.autoMergeBatches(),x(9300)}}).prototype,"dstBlendFactor",[bh,kG],Object.getOwnPropertyDescriptor(XG.prototype,"dstBlendFactor"),XG.prototype),Gl(XG.prototype,"srcBlendFactor",[bh,jG],Object.getOwnPropertyDescriptor(XG.prototype,"srcBlendFactor"),XG.prototype),Gl(XG.prototype,"color",[bh,WG],Object.getOwnPropertyDescriptor(XG.prototype,"color"),XG.prototype),qG=XG))||qG)||qG)||qG)||qG));let aH=t("LabelShadow",(YG=Yl("cc.LabelShadow"),KG=ah(),$G=$l(110),ZG=ih(),JG=Kl(Qz),QG=_h(),tH=_h(),eH=_h(),YG(nH=KG(nH=$G(nH=ZG(nH=JG(nH=nh((sH=Gl((iH=class extends Nu{constructor(...t){super(...t),Ul(this,"_color",sH,this),Ul(this,"_offset",rH,this),Ul(this,"_blur",oH,this)}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}get offset(){return this._offset}set offset(t){this._offset=t,this._updateRenderData()}get blur(){return this._blur}set blur(t){this._blur=t,this._updateRenderData()}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const t=this.node.getComponent(Qz);t&&t.updateRenderData(!0)}}).prototype,"_color",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln(0,0,0,255)}}),rH=Gl(iH.prototype,"_offset",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rn(2,2)}}),oH=Gl(iH.prototype,"_blur",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Gl(iH.prototype,"color",[QG],Object.getOwnPropertyDescriptor(iH.prototype,"color"),iH.prototype),Gl(iH.prototype,"offset",[tH],Object.getOwnPropertyDescriptor(iH.prototype,"offset"),iH.prototype),Gl(iH.prototype,"blur",[eH],Object.getOwnPropertyDescriptor(iH.prototype,"blur"),iH.prototype),nH=iH))||nH)||nH)||nH)||nH)||nH)||nH));var cH,lH,hH;t("UIOpacity",Yl("cc.UIOpacity")(cH=ah()(cH=$l(110)(cH=ih()(cH=nh((Gl((lH=class extends Nu{constructor(...t){super(...t),Ul(this,"_opacity",hH,this)}get opacity(){return this._opacity}set opacity(t){this._opacity!==t&&(t=re(t,0,255),this._opacity=t,this.node._uiProps.opacity=t/255)}onEnable(){this.node._uiProps.opacity=this._opacity/255}onDisable(){this.node._uiProps.opacity=1}}).prototype,"opacity",[ch],Object.getOwnPropertyDescriptor(lH.prototype,"opacity"),lH.prototype),hH=Gl(lH.prototype,"_opacity",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),cH=lH))||cH)||cH)||cH)||cH)||cH);class _H{constructor(t,e,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=n}}function uH(t,e,n,i,s){let r=0,o=null;if(s===function(t,e,n,i){let s=0;for(let r=e,o=n-i;r<n;r+=i)s+=(t[o]-t[r])*(t[r+1]+t[o+1]),o=r;return s}(t,e,n,i)>0)for(r=e;r<n;r+=i)o=PH(r,t[r],t[r+1],o);else for(r=n-i;r>=e;r-=i)o=PH(r,t[r],t[r+1],o);return o&&bH(o,o.next)&&(OH(o),o=o.next),o}function dH(t,e=null){if(!t)return t;e||(e=t);let n=t,i=!1;do{if(i=!1,n.steiner||!bH(n,n.next)&&0!==AH(n.prev,n,n.next))n=n.next;else{if(OH(n),n=e=n.prev,n===n.next)return null;i=!0}}while(i||n!==e);return e}function pH(t,e,n,i,s,r,o=0){if(!t)return;!o&&r&&function(t,e,n,i){let s=t;do{null===s.z&&(s.z=SH(s.x,s.y,e,n,i)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==t);s.prevZ.nextZ=null,s.prevZ=null,function(t){let e=0,n=null,i=null,s=null,r=null,o=0,a=0,c=0,l=1;do{for(n=t,t=null,r=null,o=0;n;){for(o++,i=n,a=0,e=0;e<l&&(a++,i=i.nextZ,i);e++);for(c=l;a>0||c>0&&i;)0===a?(s=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(s=n,n=n.nextZ,a--):(s=i,i=i.nextZ,c--):(s=n,n=n.nextZ,a--),r?r.nextZ=s:t=s,s.prevZ=r,r=s;n=i}r.nextZ=null,l*=2}while(o>1)}(s)}(t,i,s,r);let a=t,c=null,l=null;for(;t.prev!==t.next;)if(c=t.prev,l=t.next,r?fH(t,i,s,r):mH(t))e.push(c.i/n),e.push(t.i/n),e.push(l.i/n),OH(t),t=l.next,a=l.next;else if((t=l)===a){o?1===o?pH(t=gH(t,e,n),e,n,i,s,r,2):2===o&&vH(t,e,n,i,s,r):pH(dH(t),e,n,i,s,r,1);break}}function mH(t){const e=t.prev,n=t,i=t.next;if(AH(e,n,i)>=0)return!1;let s=t.next.next;for(;s!==t.prev;){if(EH(e.x,e.y,n.x,n.y,i.x,i.y,s.x,s.y)&&AH(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function fH(t,e,n,i){const s=t.prev,r=t,o=t.next;if(AH(s,r,o)>=0)return!1;const a=s.x<r.x?s.x<o.x?s.x:o.x:r.x<o.x?r.x:o.x,c=s.y<r.y?s.y<o.y?s.y:o.y:r.y<o.y?r.y:o.y,l=s.x>r.x?s.x>o.x?s.x:o.x:r.x>o.x?r.x:o.x,h=s.y>r.y?s.y>o.y?s.y:o.y:r.y>o.y?r.y:o.y,_=SH(a,c,e,n,i),u=SH(l,h,e,n,i);let d=t.nextZ;for(;d&&d.z<=u;){if(d!==t.prev&&d!==t.next&&EH(s.x,s.y,r.x,r.y,o.x,o.y,d.x,d.y)&&AH(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(d=t.prevZ;d&&d.z>=_;){if(d!==t.prev&&d!==t.next&&EH(s.x,s.y,r.x,r.y,o.x,o.y,d.x,d.y)&&AH(d.prev,d,d.next)>=0)return!1;d=d.prevZ}return!0}function gH(t,e,n){let i=t;do{const s=i.prev,r=i.next.next;!bH(s,r)&&wH(s,i,i.next,r)&&RH(s,r)&&RH(r,s)&&(e.push(s.i/n),e.push(i.i/n),e.push(r.i/n),OH(i),OH(i.next),i=t=r),i=i.next}while(i!==t);return i}function vH(t,e,n,i,s,r){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.i!==t.i&&CH(o,t)){let a=IH(o,t);return o=dH(o,o.next),a=dH(a,a.next),pH(o,e,n,i,s,r),void pH(a,e,n,i,s,r)}t=t.next}o=o.next}while(o!==t)}function yH(t,e){return t.x-e.x}function xH(t,e){if(e=function(t,e){let n=e;const i=t.x,s=t.y;let r=-1/0,o=null;do{if(s<=n.y&&s>=n.next.y){const t=n.x+(s-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=i&&t>r){if(r=t,t===i){if(s===n.y)return n;if(s===n.next.y)return n.next}o=n.x<n.next.x?n:n.next}}n=n.next}while(n!==e);if(!o)return null;if(i===r)return o.prev;const a=o,c=o.x,l=o.y;let h,_=1/0;for(n=o.next;n!==a;)i>=n.x&&n.x>=c&&EH(s<l?i:r,s,c,l,s<l?r:i,s,n.x,n.y)&&(h=Math.abs(s-n.y)/(i-n.x),(h<_||h===_&&n.x>o.x)&&RH(n,t)&&(o=n,_=h)),n=n.next;return o}(t,e)){const n=IH(e,t);dH(n,n.next)}}function SH(t,e,n,i,s){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/s)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/s)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function TH(t){let e=t,n=t;do{e.x<n.x&&(n=e),e=e.next}while(e!==t);return n}function EH(t,e,n,i,s,r,o,a){return(s-o)*(e-a)-(t-o)*(r-a)>=0&&(t-o)*(i-a)-(n-o)*(e-a)>=0&&(n-o)*(r-a)-(s-o)*(i-a)>=0}function CH(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&wH(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&RH(t,e)&&RH(e,t)&&function(t,e){let n=t,i=!1;const s=(t.x+e.x)/2,r=(t.y+e.y)/2;do{n.y>r!=n.next.y>r&&s<(n.next.x-n.x)*(r-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==t);return i}(t,e)}function AH(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function bH(t,e){return t.x===e.x&&t.y===e.y}function wH(t,e,n,i){return!!(bH(t,e)&&bH(n,i)||bH(t,i)&&bH(n,e))||AH(t,e,n)>0!=AH(t,e,i)>0&&AH(n,i,t)>0!=AH(n,i,e)>0}function RH(t,e){return AH(t.prev,t,t.next)<0?AH(t,e,t.next)>=0&&AH(t,t.prev,e)>=0:AH(t,e,t.prev)<0||AH(t,t.next,e)<0}function IH(t,e){const n=new _H(t.i,t.x,t.y),i=new _H(e.i,e.x,e.y),s=t.next,r=e.prev;return t.next=e,e.prev=t,n.next=s,s.prev=n,i.next=n,n.prev=i,r.next=i,i.prev=r,i}function PH(t,e,n,i){const s=new _H(t,e,n);return i?(s.next=i.next,s.prev=i,i.next.prev=s,i.next=s):(s.prev=s,s.next=s),s}function OH(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function DH(t,e,n){n=n||3;const i=e?e.length:0,s=i?e[0]*n:t.length;let r=uH(t,0,s,n,!0);const o=[];if(!r)return o;let a=0,c=0,l=0,h=0,_=0,u=0,d=0;if(i&&(r=function(t,e,n,i){const s=[];let r=0,o=0,a=0,c=0,l=null;for(r=0,o=e.length;r<o;r++)a=e[r]*i,c=r<o-1?e[r+1]*i:t.length,l=uH(t,a,c,i,!1),l&&(l===l.next&&(l.steiner=!0),s.push(TH(l)));if(s.sort(yH),!n)return n;for(r=0;r<s.length;r++)xH(s[r],n),n=dH(n,n.next);return n}(t,e,r,n)),t.length>80*n){a=l=t[0],c=h=t[1];for(let e=n;e<s;e+=n)_=t[e],u=t[e+1],_<a&&(a=_),u<c&&(c=u),_>l&&(l=_),u>h&&(h=u);d=Math.max(l-a,h-c)}return pH(r,o,n,a,c,d),o}const MH=Math.PI,NH=Math.min,LH=Math.max,zH=Math.ceil,BH=Math.acos,FH=Math.cos,UH=Math.sin,GH=Math.atan2;let HH=null,VH=null;const kH=new Ln,jH=[];for(let t=0;t<4;t++)jH.push(new ln);function WH(t,e,n){return t<e?e:t>n?n:t}const qH={useModel:!0,updateRenderData(t){},fillBuffers(t,e){},renderIA(t,e){},getRenderData(t,e){if(!VH)return null;const n=VH.getRenderDataList();let i=n[VH.dataOffset];if(!i)return null;let s=i;const r=s?s.vertexStart+e:0;return(r>65535||3*r>131070)&&(++VH.dataOffset,VH.dataOffset<n.length?i=n[VH.dataOffset]:(i=VH.requestRenderData(),n[VH.dataOffset]=i),s=i),s&&s.vertexCount<r&&s.request(e,3*e),i},stroke(t){Ln.copy(kH,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill(t){Ln.copy(kH,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end(t){t.markForUpdateRenderData()},_expandStroke(t){const e=.5*t.lineWidth,n=t.lineCap,i=t.lineJoin,s=t.miterLimit;if(VH=t.impl,!VH)return;const r=function(t,e,n){const i=2*BH(t/(t+n));return LH(2,zH(e/i))}(e,MH,VH.tessTol);this._calculateJoins(VH,e,i,s);const o=VH.paths;let a=0;for(let t=VH.pathOffset,e=VH.pathLength;t<e;t++){const e=o[t],s=e.points.length;i===Zz.ROUND?a+=2*(s+e.bevel*(r+2)+1):a+=2*(s+5*e.bevel+1),e.closed||(n===$z.ROUND?a+=2*(2*r+2):a+=12)}const c=HH=this.getRenderData(t,a);if(!c)return;const l=c.vData,h=c.iData;for(let t=VH.pathOffset,s=VH.pathLength;t<s;t++){const s=o[t],a=s.points,_=a.length,u=c.vertexStart;let d,p,m=0,f=0;const g=s.closed;if(g?(d=a[_-1],p=a[0],m=0,f=_):(d=a[0],p=a[1],m=1,f=_-1),p=p||d,!g){const t=new lB(p.x,p.y);t.subtract(d),t.normalize();const i=t.x,s=t.y;n===$z.BUTT?this._buttCapStart(d,i,s,e,0):n===$z.SQUARE?this._buttCapStart(d,i,s,e,e):n===$z.ROUND&&this._roundCapStart(d,i,s,e,r)}for(let t=m;t<f;++t)i===Zz.ROUND?this._roundJoin(d,p,e,e,r):0!=(p.flags&(Jz.PT_BEVEL|Jz.PT_INNERBEVEL))?this._bevelJoin(d,p,e,e):(this._vSet(p.x+p.dmx*e,p.y+p.dmy*e,1),this._vSet(p.x-p.dmx*e,p.y-p.dmy*e,-1)),d=p,p=a[t+1];if(g){const t=8*u;this._vSet(l[t],l[t+1],1),this._vSet(l[t+8],l[t+8+1],-1)}else{const t=new lB(p.x,p.y);t.subtract(d),t.normalize();const i=t.x,s=t.y;n===$z.BUTT?this._buttCapEnd(p,i,s,e,0):n===$z.SQUARE?this._buttCapEnd(p,i,s,e,e):n===$z.ROUND&&this._roundCapEnd(p,i,s,e,r)}let v=c.indicesStart;for(let t=u+2,e=c.vertexStart;t<e;t++)h[v++]=t-2,h[v++]=t-1,h[v++]=t;c.indicesStart=v}HH=null,VH=null},_expandFill(t){if(VH=t.impl,!VH)return;const e=VH.paths;let n=0;for(let t=VH.pathOffset,i=VH.pathLength;t<i;t++)n+=e[t].points.length;const i=HH=this.getRenderData(t,n);if(!i)return;const s=i,r=s.vData,o=s.iData;for(let t=VH.pathOffset,n=VH.pathLength;t<n;t++){const n=e[t],a=n.points,c=a.length;if(0===c)continue;const l=i.vertexStart;for(let t=0;t<c;++t)this._vSet(a[t].x,a[t].y);let h=i.indicesStart;if(n.complex){const t=[];for(let e=l,n=i.vertexStart;e<n;e++){let n=8*e;t.push(r[n++]),t.push(r[n++]),t.push(r[n++])}const e=DH(t,null,3);if(!e||0===e.length)continue;for(let t=0,n=e.length;t<n;t++)o[h++]=e[t]+l}else{const t=l;for(let e=l+2,n=s.vertexStart;e<n;e++)o[h++]=t,o[h++]=e-1,o[h++]=e}s.indicesStart=h}HH=null,VH=null},_calculateJoins(t,e,n,i){let s=0;e>0&&(s=1/e);const r=t.paths;for(let e=t.pathOffset,o=t.pathLength;e<o;e++){const t=r[e],o=t.points,a=o.length;let c=o[a-1],l=o[0];t.bevel=0;for(let e=0;e<a;e++){let r=0,a=0,h=0;const _=c.dy,u=-c.dx,d=l.dy,p=-l.dx;if(l.dmx=.5*(_+d),l.dmy=.5*(u+p),r=l.dmx*l.dmx+l.dmy*l.dmy,r>1e-6){let t=1/r;t>600&&(t=600),l.dmx*=t,l.dmy*=t}a=l.dx*c.dy-c.dx*l.dy,a>0&&(l.flags|=Jz.PT_LEFT),h=LH(11,NH(c.len,l.len)*s),r*h*h<1&&(l.flags|=Jz.PT_INNERBEVEL),l.flags&Jz.PT_CORNER&&(r*i*i<1||n===Zz.BEVEL||n===Zz.ROUND)&&(l.flags|=Jz.PT_BEVEL),0!=(l.flags&(Jz.PT_BEVEL|Jz.PT_INNERBEVEL))&&t.bevel++,c=l,l=o[e+1]}}},_flattenPaths(t){const e=t.paths;for(let n=t.pathOffset,i=t.pathLength;n<i;n++){const t=e[n],i=t.points;let s=i[i.length-1],r=i[0];i.length>2&&s.equals(r)&&(t.closed=!0,i.pop(),s=i[i.length-1]);for(let t=0,e=i.length;t<e;t++){const e=new lB(r.x,r.y);e.subtract(s),s.len=e.length(),(e.x||e.y)&&e.normalize(),s.dx=e.x,s.dy=e.y,s=r,r=i[t+1]}}},_chooseBevel(t,e,n,i){const s=n.x,r=n.y;let o=0,a=0,c=0,l=0;return 0!==t?(o=s+e.dy*i,a=r-e.dx*i,c=s+n.dy*i,l=r-n.dx*i):(o=c=s+n.dmx*i,a=l=r+n.dmy*i),[o,a,c,l]},_buttCapStart(t,e,n,i,s){const r=t.x-e*s,o=t.y-n*s,a=n,c=-e;this._vSet(r+a*i,o+c*i,1),this._vSet(r-a*i,o-c*i,-1)},_buttCapEnd(t,e,n,i,s){const r=t.x+e*s,o=t.y+n*s,a=n,c=-e;this._vSet(r+a*i,o+c*i,1),this._vSet(r-a*i,o-c*i,-1)},_roundCapStart(t,e,n,i,s){const r=t.x,o=t.y,a=n,c=-e;for(let t=0;t<s;t++){const l=t/(s-1)*MH,h=FH(l)*i,_=UH(l)*i;this._vSet(r-a*h-e*_,o-c*h-n*_,1),this._vSet(r,o,0)}this._vSet(r+a*i,o+c*i,1),this._vSet(r-a*i,o-c*i,-1)},_roundCapEnd(t,e,n,i,s){const r=t.x,o=t.y,a=n,c=-e;this._vSet(r+a*i,o+c*i,1),this._vSet(r-a*i,o-c*i,-1);for(let t=0;t<s;t++){const l=t/(s-1)*MH,h=FH(l)*i,_=UH(l)*i;this._vSet(r,o,0),this._vSet(r-a*h+e*_,o-c*h+n*_,1)}},_roundJoin(t,e,n,i,s){const r=t.dy,o=-t.dx,a=e.dy,c=-e.dx,l=e.x,h=e.y;if(0!=(e.flags&Jz.PT_LEFT)){const _=this._chooseBevel(e.flags&Jz.PT_INNERBEVEL,t,e,n),u=_[0],d=_[1],p=_[2],m=_[3],f=GH(-o,-r);let g=GH(-c,-a);g>f&&(g-=2*MH),this._vSet(u,d,1),this._vSet(l-r*i,e.y-o*i,-1);const v=WH(zH((f-g)/MH)*s,2,s);for(let t=0;t<v;t++){const e=f+t/(v-1)*(g-f),n=l+FH(e)*i,s=h+UH(e)*i;this._vSet(l,h,0),this._vSet(n,s,-1)}this._vSet(p,m,1),this._vSet(l-a*i,h-c*i,-1)}else{const _=this._chooseBevel(e.flags&Jz.PT_INNERBEVEL,t,e,-i),u=_[0],d=_[1],p=_[2],m=_[3],f=GH(o,r);let g=GH(c,a);g<f&&(g+=2*MH),this._vSet(l+r*i,h+o*i,1),this._vSet(u,d,-1);const v=WH(zH((g-f)/MH)*s,2,s);for(let t=0;t<v;t++){const e=f+t/(v-1)*(g-f),i=l+FH(e)*n,s=h+UH(e)*n;this._vSet(i,s,1),this._vSet(l,h,0)}this._vSet(l+a*i,h+c*i,1),this._vSet(p,m,-1)}},_bevelJoin(t,e,n,i){let s=0,r=0,o=0,a=0,c=0,l=0,h=0,_=0;const u=t.dy,d=-t.dx,p=e.dy,m=-e.dx;if(e.flags&Jz.PT_LEFT){const s=this._chooseBevel(e.flags&Jz.PT_INNERBEVEL,t,e,n);c=s[0],l=s[1],h=s[2],_=s[3],this._vSet(c,l,1),this._vSet(e.x-u*i,e.y-d*i,-1),this._vSet(h,_,1),this._vSet(e.x-p*i,e.y-m*i,-1)}else{const c=this._chooseBevel(e.flags&Jz.PT_INNERBEVEL,t,e,-i);s=c[0],r=c[1],o=c[2],a=c[3],this._vSet(e.x+u*n,e.y+d*n,1),this._vSet(s,r,-1),this._vSet(e.x+p*n,e.y+m*n,1),this._vSet(o,a,-1)}},_vSet(t,e,n=0){if(!HH)return;const i=HH;let s=8*i.vertexStart;const r=i.vData;r[s++]=t,r[s++]=e,r[s++]=0,Ln.toArray(r,kH,s),s+=4,r[s++]=n,i.vertexStart++}},XH=t("graphicsAssembler",{getAssembler:()=>qH});WB.Assembler=XH;class YH{constructor(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}}const KH=new Mn;let $H=null,ZH=null;const JH=[],QH=[],tV=[],eV=[],nV=new On,iV=new On,sV=new rn;let rV=null,oV=0,aV=0,cV=0,lV=0,hV=0,_V=1,uV=null,dV="",pV=0,mV=0,fV=0,gV=0,vV=0,yV=0,xV=0,SV=!1,TV=0,EV=0,CV=0;const AV={updateRenderData(t){t.renderData&&t.renderData.vertDirty&&$H!==t&&($H=t,ZH=$H.node._uiProps.uiTransformComp,this._updateFontFamily(t),this._updateProperties(t),this._updateLabelInfo(t),this._updateContent(),$H.actualFontSize=pV,ZH.setContentSize(iV),$H.renderData.vertDirty=$H.renderData.uvDirty=!1,$H=null,this._resetProperties())},_updateFontScale(){_V=pV/mV},_updateFontFamily(t){const e=t.font;uV=e.spriteFrame,rV=e.fntConfig,MN.fontAtlas=e.fontDefDictionary,FM.packToDynamicAtlas(t,uV)},_updateLabelInfo(t){MN.hash="",MN.margin=0},_updateProperties(t){dV=t.string.toString(),pV=t.fontSize,mV=rV?rV.fontSize:t.fontSize,fV=t.horizontalAlign,gV=t.verticalAlign,vV=t.spacingX,xV=t.overflow,yV=t._lineHeight;const e=ZH.contentSize;iV.width=e.width,iV.height=e.height,xV===Yz.NONE?(SV=!1,iV.width+=2*MN.margin,iV.height+=2*MN.margin):xV===Yz.RESIZE_HEIGHT?(SV=!0,iV.height+=2*MN.margin):SV=t.enableWrapText,MN.lineHeight=yV,MN.fontSize=pV,this._setupBMFontOverflowMetrics()},_resetProperties(){rV=null,uV=null,MN.hash="",MN.margin=0},_updateContent(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText(){const t=dV,e=t.length,n=rV.kerningDict,i=JH;let s=-1;for(let r=0;r<e;++r){const o=t.charCodeAt(r),a=n[s<<16|65535&o]||0;i[r]=r<e-1?a:0,s=o}},_multilineTextWrap(t){const e=dV.length;let n=0,i=0,s=0,r=0,o=0,a=0,c=0,l=null;for(let h=0;h<e;){let _=dV.charAt(h);if("\n"===_){tV.push(o),o=0,n++,i=0,s-=yV*this._getFontScale()+0,this._recordPlaceholderInfo(h,_),h++;continue}const u=t(dV,h,e);let d=a,p=c,m=o,f=i,g=!1;for(let t=0;t<u;++t){const r=h+t;if(_=dV.charAt(r),"\r"===_){this._recordPlaceholderInfo(r,_);continue}if(l=MN.fontAtlas.getLetterDefinitionForChar(_,MN),!l){this._recordPlaceholderInfo(r,_),console.log(`Can't find letter definition in texture atlas ${rV.atlasName} for letter:${_}`);continue}const a=f+l.offsetX*_V-MN.margin;if(SV&&CV>0&&i>0&&a+l.w*_V>CV&&!SN(_)){tV.push(o),o=0,n++,i=0,s-=yV*this._getFontScale()+0,g=!0;break}sV.x=a,sV.y=s-l.offsetY*_V,this._recordLetterInfo(sV,_,r,n),r+1<JH.length&&r<e-1&&(f+=JH[r+1]),f+=l.xAdvance*_V+vV,m=sV.x+l.w*_V,d<sV.y&&(d=sV.y),p>sV.y-l.h*_V&&(p=sV.y-l.h*_V)}g||(i=f,o=m,a<d&&(a=d),c>p&&(c=p),r<o&&(r=o),h+=u)}return tV.push(o),oV=n+1,aV=oV*yV*this._getFontScale(),oV>1&&(aV+=0*(oV-1)),iV.width=TV,iV.height=EV,TV<=0&&(iV.width=parseFloat(r.toFixed(2))+2*MN.margin),EV<=0&&(iV.height=parseFloat(aV.toFixed(2))+2*MN.margin),lV=iV.height,hV=0,a>0&&(lV=iV.height+a),c<-aV&&(hV=aV+c),!0},_getFirstCharLen:()=>1,_getFontScale:()=>xV===Yz.SHRINK?_V:1,_getFirstWordLen(t,e,n){let i=t.charAt(e);if(xN(i)||"\n"===i||SN(i))return 1;let s=1,r=MN.fontAtlas.getLetterDefinitionForChar(i,MN);if(!r)return s;let o=r.xAdvance*_V+vV,a=0;for(let c=e+1;c<n&&(i=t.charAt(c),r=MN.fontAtlas.getLetterDefinitionForChar(i,MN),r);++c){if(a=o+r.offsetX*_V,a+r.w*_V>CV&&!SN(i)&&CV>0)return s;if(o+=r.xAdvance*_V+vV,"\n"===i||SN(i)||xN(i))break;s++}return s},_multilineTextWrapByWord(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo(t,e){if(t>=QH.length){const t=new YH;QH.push(t)}QH[t].char=e,QH[t].hash=e.charCodeAt(0)+MN.hash,QH[t].valid=!1},_recordLetterInfo(t,e,n,i){if(n>=QH.length){const t=new YH;QH.push(t)}const s=e.charCodeAt(0)+MN.hash;QH[n].line=i,QH[n].char=e,QH[n].hash=s,QH[n].valid=MN.fontAtlas.getLetter(s).valid,QH[n].x=t.x,QH[n].y=t.y},_alignText(){aV=0,tV.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),xV===Yz.SHRINK&&pV>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||xV===Yz.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown(t){let e=!0;t||(t=.1,e=!1),pV=t,e&&this._updateContent()},_shrinkLabelToContentSize(t){let e=0,n=0|pV,i=0;for(;e<n;){i=e+n+1>>1;const s=i;if(s<=0)break;_V=s/mV,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),t()?n=i-1:e=i}e>=0&&this._scaleFontSizeDown(e)},_isVerticalClamp:()=>aV>iV.height,_isHorizontalClamp(){let t=!1;for(let e=0,n=dV.length;e<n;++e){const n=QH[e];if(n.valid){const e=MN.fontAtlas.getLetterDefinitionForChar(n.char,MN);if(!e)continue;const i=n.x+e.w/2*_V,s=n.line;if(TV>0)if(SV){if(tV[s]>iV.width&&(i>iV.width||i<0)){t=!0;break}}else if(i>iV.width){t=!0;break}}}return t},_isHorizontalClamped(t,e){const n=tV[e],i=t>iV.width||t<0;return SV?n>iV.width&&i:i},_updateQuads(){if(!$H)return!1;const t=uV?uV.texture:MN.fontAtlas.getTexture(),e=$H.renderData;e.dataLength=e.vertexCount=e.indicesCount=0;const n=ZH.anchorPoint,i=iV,s=n.x*i.width,r=n.y*i.height;let o=!0;for(let e=0,n=dV.length;e<n;++e){const n=QH[e];if(!n.valid)continue;const i=MN.fontAtlas.getLetter(n.hash);if(!i){console.warn("Can't find letter in this bitmap-font");continue}KH.height=i.h,KH.width=i.w,KH.x=i.u,KH.y=i.v;let a=n.y+cV;if(EV>0){if(a>lV){const t=a-lV;KH.y+=t,KH.height-=t,a-=t}a-i.h*_V<hV&&xV===Yz.CLAMP&&(KH.height=a<hV?0:(a-hV)/_V)}const c=n.line,l=n.x+i.w/2*_V+eV[c];if(TV>0&&this._isHorizontalClamped(l,c))if(xV===Yz.CLAMP)KH.width=0;else if(xV===Yz.SHRINK){if(iV.width>i.w){o=!1;break}KH.width=0}if(KH.height>0&&KH.width>0){const e=this._determineRect(),i=n.x+eV[n.line];this.appendQuad($H,t,KH,e,i-s,a-r,_V)}}return o},appendQuad(t,e,n,i,s,r,o){},_determineRect(){const t=uV.isRotated(),e=uV.getOriginalSize(),n=uV.getRect(),i=uV.getOffset(),s=i.x+(e.width-n.width)/2,r=i.y-(e.height-n.height)/2;if(t){const t=KH.x;KH.x=n.x+n.height-KH.y-KH.height-r,KH.y=t+n.y-s,KH.y<0&&(KH.height+=r)}else KH.x+=n.x-s,KH.y+=n.y+r;return t},_computeAlignmentOffset(){switch(eV.length=0,fV){case qz.LEFT:for(let t=0;t<oV;++t)eV.push(0);break;case qz.CENTER:for(let t=0,e=tV.length;t<e;t++)eV.push((iV.width-tV[t])/2);break;case qz.RIGHT:for(let t=0,e=tV.length;t<e;t++)eV.push(iV.width-tV[t])}if(cV=iV.height,gV!==Xz.TOP){const t=iV.height-aV+yV*this._getFontScale()-mV*_V;gV===Xz.BOTTOM?cV-=t:cV-=t/2}},_setupBMFontOverflowMetrics(){let t=iV.width,e=iV.height;xV===Yz.RESIZE_HEIGHT&&(e=0),xV===Yz.NONE&&(t=0,e=0),TV=t,EV=e,nV.width=t,nV.height=e,CV=t}},bV={createData:t=>t.requestRenderData(),fillBuffers(t,e){NM(t.node,e,t.renderData,t.color)},appendQuad(t,e,n,i,s,r,o){const a=t.renderData;if(!a)return;const c=a.dataLength;a.dataLength+=4,a.vertexCount=a.dataLength,a.indicesCount=a.dataLength/2*3;const l=a.data,h=e.width,_=e.height,u=n.width,d=n.height;let p=0,m=0,f=0,g=0;i?(p=n.x/h,g=(n.x+d)/h,m=(n.y+u)/_,f=n.y/_,l[c].u=p,l[c].v=f,l[c+1].u=p,l[c+1].v=m,l[c+2].u=g,l[c+2].v=f,l[c+3].u=g,l[c+3].v=m):(p=n.x/h,g=(n.x+u)/h,m=(n.y+d)/_,f=n.y/_,l[c].u=p,l[c].v=m,l[c+1].u=g,l[c+1].v=m,l[c+2].u=p,l[c+2].v=f,l[c+3].u=g,l[c+3].v=f),l[c].x=s,l[c].y=r-d*o,l[c+1].x=s+u*o,l[c+1].y=r-d*o,l[c+2].x=s,l[c+2].y=r,l[c+3].x=s+u*o,l[c+3].y=r}};Et(bV,AV);let wV=null;const RV=Ct(AV,{getAssemblerData:()=>(wV||(wV=new DN(1024,1024)),wV.getTexture()),_updateFontFamily(t){MN.fontAtlas=wV,MN.fontFamily=this._getFontFamily(t);const e=t.getComponent(UF);e&&e.enabled?(MN.isOutlined=!0,MN.margin=e.width,MN.out=e.color.clone(),MN.out.a=e.color.a*t.color.a/255):(MN.isOutlined=!1,MN.margin=0)},_getFontFamily(t){let e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(t.font._nativeAsset?e=t.font._nativeAsset:dC.postLoadNative(t.font,()=>{t.isValid&&(e=t.font._nativeAsset||"Arial",t.updateRenderData(!0))})),e},_updateLabelInfo(t){MN.fontDesc=this._getFontDesc(),MN.color=t.color,MN.hash=function(t){const e=t.color.toHEX();let n="";return t.isOutlined&&t.margin>0&&(n=n+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+n}(MN)},_getFontDesc(){let t=MN.fontSize.toString()+"px ";return t+=MN.fontFamily,t},_computeHorizontalKerningForText(){},_determineRect:()=>!1}),IV=new Ln(255,255,255,255),PV={createData:t=>t.requestRenderData(),fillBuffers(t,e){if(!t.renderData)return;const n=t.node;IV.a=t.color.a,NM(n,e,t.renderData,IV)},appendQuad:bV.appendQuad};Et(PV,RV);const OV=Qz.Overflow;let DV=null,MV=null,NV=null,LV="",zV="",BV=0,FV=0,UV=[];const GV=new On;let HV=0,VV=0,kV=0,jV=new Ln,WV="",qV=OV.NONE,XV=!1,YV=null;const KV=Ln.BLACK.clone();let $V=null;const ZV=Ln.BLACK.clone(),JV=new Mn,QV=On.ZERO.clone(),tk=On.ZERO.clone(),ek=rn.ZERO.clone(),nk=rn.ZERO.clone();let ik=0,sk=0,rk=!1,ok=!1,ak=!1;const ck=["left","center","right"],lk={getAssemblerData:()=>Qz._canvasPool.get(),resetAssemblerData(t){t&&Qz._canvasPool.put(t)},updateRenderData(t){if(!t.renderData||!t.renderData.vertDirty)return;const e=t.node._uiProps.uiTransformComp;this._updateFontFamily(t),this._updateProperties(t,e),this._calculateLabelFont(),this._updateLabelDimensions(),this._resetDynamicAtlas(t),this._updateTexture(),this._calDynamicAtlas(t),t.actualFontSize=BV,e.setContentSize(GV),this.updateVertexData(t),this.updateUvs(t),t.markForUpdateRenderData(!1),DV=null,MV=null,NV=null},updateVertexData(t){},updateUvs(t){},_updateFontFamily(t){t.useSystemFont?WV=t.fontFamily||"Arial":t.font?t.font._nativeAsset?WV=t.font._nativeAsset:(dC.postLoadNative(t.font,()=>{t.isValid&&(WV=t.font._nativeAsset||"Arial",t.updateRenderData(!0))}),WV="Arial"):WV="Arial"},_updateProperties(t,e){const n=t.assemblerData;n&&(DV=n.context,MV=n.canvas,NV=t.spriteFrame,zV=t.string.toString(),BV=t.fontSize,FV=BV,qV=t.overflow,tk.width=GV.width=e.width,tk.height=GV.height=e.height,sk=t.underlineHeight,HV=t.lineHeight,VV=t.horizontalAlign,kV=t.verticalAlign,jV=t.color,rk=t.isBold,ok=t.isItalic,ak=t.isUnderline,XV=qV!==OV.NONE&&(qV===OV.RESIZE_HEIGHT||t.enableWrapText),YV=UF&&t.getComponent(UF),YV=YV&&YV.enabled&&YV.width>0?YV:null,YV&&KV.set(YV.color),$V=aH&&t.getComponent(aH),$V=$V&&$V.enabled?$V:null,$V&&ZV.set($V.color),this._updatePaddingRect())},_updatePaddingRect(){let t=0,e=0,n=0,i=0,s=0;if(QV.width=QV.height=0,YV&&(s=YV.width,t=e=n=i=s,QV.width=QV.height=2*s),$V){const r=$V.blur+s,o=$V.offset.x,a=$V.offset.y;n=Math.max(n,-o+r),i=Math.max(i,o+r),t=Math.max(t,a+r),e=Math.max(e,-a+r)}if(ok){const t=FV*Math.tan(.20943951);i+=t,QV.width+=t}JV.x=n,JV.y=t,JV.width=n+i,JV.height=t+e},_calculateFillTextStartPosition(){let t=0;VV===qz.RIGHT?t=GV.width-JV.width:VV===qz.CENTER&&(t=(GV.width-JV.width)/2);const e=this._getLineHeight()*(UV.length-1);let n=BV*(1-_N/2);if(kV!==Xz.TOP){let t=e+JV.height+BV-GV.height;kV===Xz.BOTTOM?(t+=_N/2*BV,n-=t):n-=t/2}n+=0*BV,ek.set(t+JV.x,n+JV.y)},_updateTexture(){if(!DV||!MV)return;DV.clearRect(0,0,MV.width,MV.height),DV.font=LV,this._calculateFillTextStartPosition();const t=this._getLineHeight();DV.lineJoin="round",DV.fillStyle=`rgba(${jV.r}, ${jV.g}, ${jV.b}, 1)`;const e=ek.x;let n=0;this._drawTextEffect(ek,t);for(let i=0;i<UV.length;++i)n=ek.y+i*t,YV&&DV.strokeText(UV[i],e,n),DV.fillText(UV[i],e,n);if($V&&(DV.shadowColor="transparent"),NV){let t;t=NV instanceof HM?NV.texture:NV,0!==MV.width&&0!==MV.height&&(t.reset({width:MV.width,height:MV.height,mipmapLevel:1}),t.uploadData(MV),NV instanceof HM&&(NV.rect=new Mn(0,0,MV.width,MV.height),NV._calculateUV()),i.director.root&&i.director.root.batcher2D&&i.director.root.batcher2D._releaseDescriptorSetCache(t.getHash()))}},_resetDynamicAtlas(t){if(t.cacheMode!==Qz.CacheMode.BITMAP)return;const e=t.ttfSpriteFrame;FM.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()},_calDynamicAtlas(t){if(t.cacheMode!==Qz.CacheMode.BITMAP)return;const e=t.ttfSpriteFrame;FM.packToDynamicAtlas(t,e),t.renderData.uvDirty=!0},_setupOutline(){DV.strokeStyle=`rgba(${KV.r}, ${KV.g}, ${KV.b}, ${KV.a/255})`,DV.lineWidth=2*YV.width},_setupShadow(){DV.shadowColor=`rgba(${ZV.r}, ${ZV.g}, ${ZV.b}, ${ZV.a/255})`,DV.shadowBlur=$V.blur,DV.shadowOffsetX=$V.offset.x,DV.shadowOffsetY=-$V.offset.y},_drawTextEffect(t,e){if(!$V&&!YV&&!ak)return;const n=UV.length>1&&$V,i=this._measureText(DV,LV);let s=0,r=0;$V&&this._setupShadow(),YV&&this._setupOutline();for(let o=0;o<UV.length;++o)s=t.x,r=t.y+o*e,n&&(YV&&DV.strokeText(UV[o],s,r),DV.fillText(UV[o],s,r)),ak&&(ik=i(UV[o]),VV===qz.RIGHT?nk.x=t.x-ik:VV===qz.CENTER?nk.x=t.x-ik/2:nk.x=t.x,nk.y=r+FV/8,DV.fillRect(nk.x,nk.y,ik,sk));n&&(DV.shadowColor="transparent")},_updateLabelDimensions(){GV.width=Math.min(GV.width,2048),GV.height=Math.min(GV.height,2048);let t=!1;MV.width!==GV.width&&(MV.width=GV.width,t=!0),MV.height!==GV.height&&(MV.height=GV.height,t=!0),t&&(DV.font=LV),DV.textAlign=ck[VV],DV.textBaseline="alphabetic"},_getFontDesc(){let t=BV.toString()+"px ";return t+=WV,rk&&(t="bold "+t),ok&&(t="italic "+t),t},_getLineHeight(){let t=HV;return t=0===t?BV:t*BV/FV,0|t},_calculateParagraphLength(t,e){const n=[];for(const i of t){const t=TN(e,i,LV);n.push(t)}return n},_measureText:(t,e)=>n=>TN(t,n,e),_calculateShrinkFont(t){if(!DV)return;const e=this._calculateParagraphLength(t,DV);let n=0,i=0,s=0;if(XV){const e=tk.width,s=tk.height;if(e<0||s<0)return;i=s+1;let r=[],o=0,a=0|BV+1,c=0;for(;o<a;){if(c=o+a+1>>1,c<=0){v(4003);break}BV=c,LV=this._getFontDesc(),DV.font=LV;const l=this._getLineHeight();for(i=0,n=0;n<t.length;++n){const s=TN(DV,t[n],LV);r=CN(t[n],s,e,this._measureText(DV,LV)),i+=r.length*l}i>s?a=c-1:o=c}0===o?v(4003):(BV=o,LV=this._getFontDesc(),DV.font=LV)}else{for(i=t.length*this._getLineHeight(),n=0;n<t.length;++n)s<e[n]&&(s=e[n]);const r=(GV.width-JV.width)/s,o=GV.height/i;BV=FV*Math.min(1,r,o)|0,LV=this._getFontDesc(),DV.font=LV}},_calculateWrapText(t){if(!XV||!DV)return;UV=[];const e=tk.width;for(let n=0;n<t.length;++n){const i=TN(DV,t[n],LV),s=CN(t[n],i,e,this._measureText(DV,LV));UV=UV.concat(s)}},_calculateLabelFont(){if(!DV)return;const t=zV.split("\n");switch(UV=t,LV=this._getFontDesc(),DV.font=LV,qV){case OV.NONE:{let e=0,n=0;for(let n=0;n<t.length;++n){const i=TN(DV,t[n],LV);e=e>i?e:i}n=(UV.length+_N)*this._getLineHeight();const i=parseFloat(e.toFixed(2)),s=parseFloat(n.toFixed(2));GV.width=i+JV.width,GV.height=s+JV.height,tk.width=i+QV.width,tk.height=s+QV.height;break}case OV.SHRINK:this._calculateShrinkFont(t),this._calculateWrapText(t);break;case OV.CLAMP:this._calculateWrapText(t);break;case OV.RESIZE_HEIGHT:{this._calculateWrapText(t);const e=(UV.length+_N)*this._getLineHeight();GV.height=e+JV.height,tk.height=e+QV.height;break}}}},hk=Ln.WHITE.clone(),_k={createData(t){const e=t.requestRenderData();e.dataLength=4,e.vertexCount=4,e.indicesCount=6;const n=e.vData=new Float32Array(36);n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;let i=5;for(let t=0;t<4;t++)Ln.toArray(n,hk,i),i+=9;return e},fillBuffers(t,e){const n=t.renderData,i=n.data,s=t.node;let r=e.acquireBufferBatch(),o=r.byteOffset>>2,a=r.indicesOffset,c=r.vertexOffset;r.request()||(r=e.currBufferBatch,a=0,c=0,o=0);const l=r.vData,h=r.iData,_=n.vData,u=i[0],d=i[3];s.updateWorldTransform();const p=s._pos,m=s._rot,f=s._scale,g=u.x*f.x,v=d.x*f.x,y=u.y*f.y,x=d.y*f.y,S=m.x,T=m.y,E=m.z,C=m.w,A=S*T,b=E*C,w=S*S-T*T,R=C*C-E*E,I=R+w,P=2*(A-b),O=R-w,D=2*(A+b),M=p.x,N=p.y;_[0]=I*g+P*y+M,_[1]=O*y+D*g+N,_[9]=I*v+P*y+M,_[10]=O*y+D*v+N,_[18]=I*g+P*x+M,_[19]=O*x+D*g+N,_[27]=I*v+P*x+M,_[28]=O*x+D*v+N,l.set(_,o),h[a++]=c,h[a++]=c+1,h[a++]=c+2,h[a++]=c+2,h[a++]=c+1,h[a++]=c+3},updateVertexData(t){const e=t.renderData;if(!e)return;const n=t.node._uiProps.uiTransformComp,i=n.width,s=n.height,r=n.anchorX*i,o=n.anchorY*s,a=e.data;a[0].x=-r,a[0].y=-o,a[3].x=i-r,a[3].y=s-o},updateUvs(t){const e=t.renderData;if(!e)return;const n=e.vData;if(!n||!e.uvDirty)return;const i=t.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7],e.uvDirty=!1}};Et(_k,lk);const uk=t("labelAssembler",{getAssembler(t){let e=_k;return t.font instanceof cN?e=bV:t.cacheMode===Qz.CacheMode.CHAR&&(e=PV),e}});Qz.Assembler=uk;const dk=IU.FillType,pk=new bn,mk={useModel:!1,updateRenderData(t){const e=t.spriteFrame;FM.packToDynamicAtlas(t,e);const n=t.renderData;if(n&&e){const e=n.uvDirty,i=n.vertDirty;if(!e&&!i)return;let s=t.fillStart,r=t.fillRange;r<0&&(s+=r,r=-r),r=s+r,s=s>1?1:s,s=s<0?0:s,r=r>1?1:r,r=r<0?0:r,r-=s,r=r<0?0:r;let o=s+r;o=o>1?1:o,e&&this.updateUVs(t,s,o),i&&(this.updateVertexData&&this.updateVertexData(t,s,o),this.updateWorldVertexData(t))}},updateUVs(t,e,n){const i=t.spriteFrame,s=t.renderData,r=s.data,o=i.width,a=i.height,c=i.getRect();let l=0,h=0,_=0,u=0,d=0,p=0,m=0,f=0,g=0,v=0,y=0,x=0;switch(i.isRotated()?(l=c.x/o,h=(c.y+c.width)/a,_=(c.x+c.height)/o,u=c.y/a,d=m=l,g=y=_,f=x=h,p=v=u):(l=c.x/o,h=(c.y+c.height)/a,_=(c.x+c.width)/o,u=c.y/a,d=g=l,m=y=_,p=f=h,v=x=u),t.fillType){case dk.HORIZONTAL:r[0].u=d+(m-d)*e,r[0].v=p+(f-p)*e,r[1].u=d+(m-d)*n,r[1].v=p+(f-p)*n,r[2].u=g+(y-g)*e,r[2].v=v+(x-v)*e,r[3].u=g+(y-g)*n,r[3].v=v+(x-v)*n;break;case dk.VERTICAL:r[0].u=d+(g-d)*e,r[0].v=p+(v-p)*e,r[1].u=m+(y-m)*e,r[1].v=f+(x-f)*e,r[2].u=d+(g-d)*n,r[2].v=p+(v-p)*n,r[3].u=m+(y-m)*n,r[3].v=f+(x-f)*n;break;default:T(2626)}s.uvDirty=!1},updateVertexData(t,e,n){const i=t.renderData,s=i.data,r=t.node._uiProps.uiTransformComp,o=r.width,a=r.height,c=r.anchorX*o,l=r.anchorY*a;let h=-c,_=-l,u=o-c,d=a-l,p=0,m=0;switch(t.fillType){case dk.HORIZONTAL:p=h+(u-h)*e,m=h+(u-h)*n,h=p,u=m;break;case dk.VERTICAL:p=_+(d-_)*e,m=_+(d-_)*n,_=p,d=m;break;default:T(2626)}s[4].x=h,s[4].y=_,s[5].x=u,s[5].y=_,s[6].x=h,s[6].y=d,s[7].x=u,s[7].y=d,i.vertDirty=!1},createData(t){const e=t.requestRenderData();e.dataLength=8,e.vertexCount=4,e.indicesCount=6;const n=e.data;for(const t of n)t.z=0;return e},updateWorldVertexData(t){const e=t.node,n=t.renderData.data;e.getWorldMatrix(pk);for(let t=0;t<4;t++){const e=n[t+4],i=n[t];ln.transformMat4(i,e,pk)}},fillBuffers(t,e){t.node.hasChangedFlags&&this.updateWorldVertexData(t),t.node,function(t,e,n,i){const s=n.data;let r=e.acquireBufferBatch(),o=r.byteOffset>>2,a=n.vertexCount,c=r.indicesOffset,l=r.vertexOffset;r.request(a,n.indicesCount)||(r=e.currBufferBatch,a=0,c=0,l=0);const h=r.vData;for(let t=0;t<a;t++){const e=s[t];h[o++]=e.x,h[o++]=e.y,h[o++]=e.z,h[o++]=e.u,h[o++]=e.v,Ln.toArray(h,i,o),o+=4}const _=r.iData;_[c++]=l,_[c++]=l+1,_[c++]=l+2,_[c++]=l+1,_[c++]=l+3,_[c++]=l+2}(0,e,t.renderData,t.color)}},fk=2*Math.PI,gk=[new rn,new rn,new rn,new rn],vk=new Array(4),yk=new Array(8),xk=[new rn,new rn,new rn,new rn],Sk=[new rn,new rn,new rn,new rn],Tk=new rn,Ek=[new rn,new rn,new rn,new rn];function Ck(t,e,n,i,s,r,o){let a=Math.sin(r);a=Math.abs(a)>1e-6?a:0;let c=Math.cos(r);c=Math.abs(c)>1e-6?c:0;let l=0,h=0;if(0!==c){if(l=a/c,(t-s.x)*c>0){const e=s.y+l*(t-s.x);o[0].x=t,o[0].y=e}if((e-s.x)*c>0){const t=s.y+l*(e-s.x);o[2].x=e,o[2].y=t}}if(0!==a){if(h=c/a,(i-s.y)*a>0){const t=s.x+h*(i-s.y);o[3].x=t,o[3].y=i}if((n-s.y)*a>0){const t=s.x+h*(n-s.y);o[1].x=t,o[1].y=n}}}function Ak(t,e){const n=e.x-t.x,i=e.y-t.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;{let t=Math.atan(i/n);return n<0&&(t+=Math.PI),t}}function bk(t,e,n,i,s){const r=vk,o=r[0],a=r[1],c=r[2],l=r[3];t[e].x=n.x,t[e].y=n.y,t[e+1].x=i.x,t[e+1].y=i.y,t[e+2].x=s.x,t[e+2].y=s.y;let h=0,_=0;h=(n.x-o)/(c-o),_=(n.y-a)/(l-a),wk(h,_,t,e),h=(i.x-o)/(c-o),_=(i.y-a)/(l-a),wk(h,_,t,e+1),h=(s.x-o)/(c-o),_=(s.y-a)/(l-a),wk(h,_,t,e+2)}function wk(t,e,n,i){const s=yk,r=s[0]+(s[2]-s[0])*t,o=s[4]+(s[6]-s[4])*t,a=s[1]+(s[3]-s[1])*t,c=s[5]+(s[7]-s[5])*t,l=n[i];l.u=r+(o-r)*e,l.v=a+(c-a)*e}const Rk={useModel:!1,createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.spriteFrame;FM.packToDynamicAtlas(t,e);const n=t.renderData;if(n&&e&&(n.vertDirty||n.uvDirty)){const i=n.data;let s=t.fillStart,r=t.fillRange;for(r<0&&(s+=r,r=-r);s>=1;)s-=1;for(;s<0;)s+=1;s*=fk,r*=fk;const o=s+r;!function(t){const e=t.node._uiProps.uiTransformComp,n=e.width,i=e.height,s=e.anchorX*n,r=e.anchorY*i,o=-s,a=-r,c=n-s,l=i-r,h=vk;h[0]=o,h[1]=a,h[2]=c,h[3]=l;const _=t.fillCenter,u=Tk.x=Math.min(Math.max(0,_.x),1)*(c-o)+o,d=Tk.y=Math.min(Math.max(0,_.y),1)*(l-a)+a;gk[0].x=gk[3].x=o,gk[1].x=gk[2].x=c,gk[0].y=gk[1].y=a,gk[2].y=gk[3].y=l;for(const t of Ek)rn.set(t,0,0);u!==h[0]&&rn.set(Ek[0],3,0),u!==h[2]&&rn.set(Ek[2],1,2),d!==h[1]&&rn.set(Ek[1],0,1),d!==h[3]&&rn.set(Ek[3],2,3)}(t),function(t){const e=t.width,n=t.height,i=t.getRect();let s=0,r=0,o=0,a=0;const c=yk;t.isRotated()?(s=i.x/e,r=(i.x+i.height)/e,o=i.y/n,a=(i.y+i.width)/n,c[0]=c[2]=s,c[4]=c[6]=r,c[3]=c[7]=a,c[1]=c[5]=o):(s=i.x/e,r=(i.x+i.width)/e,o=i.y/n,a=(i.y+i.height)/n,c[0]=c[4]=s,c[2]=c[6]=r,c[1]=c[3]=a,c[5]=c[7]=o)}(e),Ck(vk[0],vk[2],vk[1],vk[3],Tk,s,xk),Ck(vk[0],vk[2],vk[1],vk[3],Tk,s+r,Sk);let a=0;for(let t=0;t<4;++t){const e=Ek[t];if(!e)continue;if(r>=fk){n.dataLength=a+3,bk(i,a,Tk,gk[e.x],gk[e.y]),a+=3;continue}let c=Ak(Tk,gk[e.x]),l=Ak(Tk,gk[e.y]);l<c&&(l+=fk),c-=fk,l-=fk;for(let r=0;r<3;++r)c>=o||(c>=s?(n.dataLength=a+3,bk(i,a,Tk,gk[e.x],l>=o?Sk[t]:gk[e.y]),a+=3):l>s&&(l<=o?(n.dataLength=a+3,bk(i,a,Tk,xk[t],gk[e.y]),a+=3):(n.dataLength=a+3,bk(i,a,Tk,xk[t],Sk[t]),a+=3))),c+=fk,l+=fk}n.indicesCount=n.vertexCount=a,n.vertDirty=n.uvDirty=!1}},fillBuffers(t,e){!function(t,e,n,i){const s=n.data;let r=e.acquireBufferBatch(),o=r.byteOffset>>2,a=n.vertexCount,c=r.indicesOffset,l=r.vertexOffset;r.request(a,n.indicesCount)||(r=e.currBufferBatch,a=0,c=0,l=0);const h=r.vData;t.getWorldMatrix(MM);for(let t=0;t<a;t++){const e=s[t];ln.set(DM,e.x,e.y,0),ln.transformMat4(DM,DM,MM),h[o++]=DM.x,h[o++]=DM.y,h[o++]=DM.z,h[o++]=e.u,h[o++]=e.v,Ln.toArray(h,i,o),o+=4}const _=r.iData;for(let t=0;t<n.dataLength;t++)_[c+t]=l+t}(t.node,e,t.renderData,t.color)}},Ik=[];for(let t=0;t<4;t++)Ik.push(new ln);const Pk={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.vertexCount=4,e.indicesCount=6,e.vData=new Float32Array(36),e},updateRenderData(t){const e=t.spriteFrame;FM.packToDynamicAtlas(t,e);const n=t.renderData;n&&e&&(n.vertDirty&&this.updateVertexData(t),n.uvDirty&&this.updateUvs(t))},fillBuffers(t,e){if(null===t)return;const n=t.renderData.data,i=t.node;let s=e.acquireBufferBatch(),r=s.byteOffset>>2,o=s.indicesOffset,a=s.vertexOffset;s.request()||(s=e.currBufferBatch,r=0,o=0,a=0);const c=s.vData,l=s.iData,h=t.renderData.vData,_=n[0],u=n[3],d=i.worldMatrix,p=d.m00,m=d.m01,f=d.m04,g=d.m05,v=d.m12,y=d.m13,x=_.x,S=u.x,T=_.y,E=u.y,C=p*x,A=p*S,b=m*x,w=m*S,R=f*T,I=f*E,P=g*T,O=g*E;h[0]=C+R+v,h[1]=b+P+y,h[9]=A+R+v,h[10]=w+P+y,h[18]=C+I+v,h[19]=b+O+y,h[27]=A+I+v,h[28]=w+O+y,c.set(h,r),l[o++]=a,l[o++]=a+1,l[o++]=a+2,l[o++]=a+2,l[o++]=a+1,l[o++]=a+3},updateVertexData(t){const e=t.renderData;if(!e)return;const n=t.node._uiProps.uiTransformComp,i=e.data,s=n.width,r=n.height,o=n.anchorX*s,a=n.anchorY*r;let c=0,l=0,h=0,_=0;if(t.trim)c=-o,l=-a,h=s-o,_=r-a;else{const e=t.spriteFrame,n=e.getOriginalSize(),i=e.getRect(),u=n.width,d=n.height,p=i.width,m=i.height,f=e.getOffset(),g=s/u,v=r/d,y=f.x+(u-p)/2,x=f.x-(u-p)/2;c=y*g-o,l=(f.y+(d-m)/2)*v-a,h=s+x*g-o,_=r+(f.y-(d-m)/2)*v-a}i[0].x=c,i[0].y=l,i[0].z=0,i[3].x=h,i[3].y=_,i[3].z=0,e.vertDirty=!1},updateUvs(t){const e=t.renderData,n=e.vData,i=t.spriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7],e.uvDirty=!1},updateColor(t){const e=t.renderData.vData;let n=5;const i=t.color,s=i.r/255,r=i.g/255,o=i.b/255,a=i.a/255;for(let t=0;t<4;t++)e[n]=s,e[n+1]=r,e[n+2]=o,e[n+3]=a,n+=9}},Ok=new ln,Dk=new bn,Mk={useModel:!1,createData(t){const e=t.requestRenderData();return e.dataLength=20,e.vertexCount=16,e.indicesCount=54,e},updateRenderData(t){const e=t.spriteFrame;FM.packToDynamicAtlas(t,e);const n=t.renderData;n&&e&&n.vertDirty&&(this.updateVertexData(t),this.updateWorldVertexData(t))},updateVertexData(t){const e=t.renderData,n=e.data,i=t.node._uiProps.uiTransformComp,s=i.width,r=i.height,o=i.anchorX*s,a=i.anchorY*r,c=t.spriteFrame,l=c.insetLeft,h=c.insetRight,_=c.insetTop,u=c.insetBottom;let d=s-l-h,p=r-_-u,m=s/(l+h),f=r/(_+u);m=Number.isNaN(m)||m>1?1:m,f=Number.isNaN(f)||f>1?1:f,d=d<0?0:d,p=p<0?0:p,n[0].x=-o,n[0].y=-a,n[1].x=l*m-o,n[1].y=u*f-a,n[2].x=n[1].x+d,n[2].y=n[1].y+p,n[3].x=s-o,n[3].y=r-a,e.vertDirty=!1},fillBuffers(t,e){t.node.hasChangedFlags&&this.updateWorldVertexData(t);let n=e.acquireBufferBatch();const i=t.renderData,s=i.data;let r=n.byteOffset>>2;const o=i.vertexCount;let a=n.indicesOffset,c=n.vertexOffset;const l=t.spriteFrame.uvSliced;n.request(o,i.indicesCount)||(n=e.currBufferBatch,r=0,a=0,c=0);const h=n.vData,_=n.iData;for(let e=4;e<20;++e){const n=s[e],i=l[e-4];h[r++]=n.x,h[r++]=n.y,h[r++]=n.z,h[r++]=i.u,h[r++]=i.v,Ln.toArray(h,t.color,r),r+=4}for(let t=0;t<3;++t)for(let e=0;e<3;++e){const n=c+4*t+e;_[a++]=n,_[a++]=n+1,_[a++]=n+4,_[a++]=n+1,_[a++]=n+5,_[a++]=n+4}},updateWorldVertexData(t){const e=t.node,n=t.renderData.data;e.getWorldMatrix(Dk);for(let t=0;t<4;++t){const e=n[t];for(let i=0;i<4;++i){const s=n[i],r=n[4+4*t+i];ln.set(Ok,s.x,e.y,0),ln.transformMat4(r,Ok,Dk)}}}},Nk=[];for(let t=0;t<4;t++)Nk.push(new ln);const Lk={useModel:!1,sizableWidth:0,sizableHeight:0,vRepeat:0,hRepeat:0,row:0,col:0,createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.renderData,n=t.spriteFrame;if(!n||!e||!e.uvDirty&&!e.vertDirty)return;const i=t.node._uiProps.uiTransformComp,s=Math.abs(i.width),r=Math.abs(i.height),o=n.getRect(),a=n.insetLeft,c=n.insetRight,l=o.width-a-c,h=n.insetTop,_=n.insetBottom,u=o.height-h-_;this.sizableWidth=s-a-c,this.sizableHeight=r-h-_,this.sizableWidth=this.sizableWidth>0?this.sizableWidth:0,this.sizableHeight=this.sizableHeight>0?this.sizableHeight:0,this.hRepeat=0===l?this.sizableWidth:this.sizableWidth/l,this.vRepeat=0===u?this.sizableHeight:this.sizableHeight/u,this.row=Math.ceil(this.vRepeat+2),this.col=Math.ceil(this.hRepeat+2),e.dataLength=Math.max(8,this.row+1,this.col+1),this.updateVerts(t),e.vertexCount=this.row*this.col*4,e.indicesCount=this.row*this.col*6,e.uvDirty=!1,e.vertDirty=!1},fillBuffers(t,e){const n=t.node,i=t.renderData;let s=e.acquireBufferBatch(),r=s.indicesOffset,o=s.byteOffset>>2,a=s.vertexOffset;const c=i.vertexCount,l=i.indicesCount,h=s.vData,_=s.iData;s.request(c,l)||(s=e.currBufferBatch,o=0,r=0,a=0);const u=t.spriteFrame,d=u.isRotated(),p=u.uv,m=u.uvSliced,f=u.getRect(),g=u.insetLeft,v=u.insetRight,y=f.width-g-v,x=u.insetTop,S=u.insetBottom,T=f.height-x-S,E=n.worldMatrix;this.fillVertices(h,o,E,this.row,this.col,i.data);let C=0,A=0;for(let e=0,n=this.row;e<n;++e){A=this.sizableHeight>T?this.sizableHeight>=e*T?1:this.vRepeat%1:this.vRepeat;for(let n=0,i=this.col;n<i;++n){C=this.sizableWidth>y?this.sizableWidth>=n*y?1:this.hRepeat%1:this.hRepeat;const i=o+3,s=i+1;d?(h[i]=p[0],h[s]=p[1],h[i+9]=p[0],h[s+9]=p[1]+(p[7]-p[1])*C,h[i+18]=p[0]+(p[6]-p[0])*A,h[s+18]=p[1],h[i+27]=h[i+18],h[s+27]=h[s+9]):(0===n?h[i]=p[0]:n>0&&n<this.col-1?h[i]=m[1].u:n===this.col-1&&(h[i]=m[2].u),0===e?h[s]=m[0].v:e>0&&e<this.row-1?h[s]=m[4].v:e===this.row-1&&(h[s]=m[8].v),0===n||n>0&&n<this.col-1?h[i+9]=m[1].u+(m[2].u-m[1].u)*C:n===this.col-1&&(h[i+9]=m[3].u),0===e?h[s+9]=m[0].v:e>0&&e<this.row-1?h[s+9]=m[4].v:e===this.row-1&&(h[s+9]=m[8].v),0===n?h[i+18]=p[0]:n>0&&n<this.col-1?h[i+18]=m[1].u:n===this.col-1&&(h[i+18]=m[2].u),0===e||e>0&&e<this.row-1?h[s+18]=m[4].v+(m[8].v-m[4].v)*A:e===this.row-1&&(h[s+18]=m[12].v),h[i+27]=h[i+9],h[s+27]=h[s+18]),Ln.toArray(h,t.color,s+1),Ln.toArray(h,t.color,s+9+1),Ln.toArray(h,t.color,s+18+1),Ln.toArray(h,t.color,s+27+1),o+=36}}for(let t=0;t<l;t+=6)_[r++]=a,_[r++]=a+1,_[r++]=a+2,_[r++]=a+1,_[r++]=a+3,_[r++]=a+2,a+=4},fillVertices(t,e,n,i,s,r){let o=0,a=0,c=0,l=0;for(let h=0,_=i;h<_;++h){c=r[h].y,l=r[h+1].y;for(let i=0,h=s;i<h;++i){o=r[i].x,a=r[i+1].x,ln.set(Nk[0],o,c,0),ln.set(Nk[1],a,c,0),ln.set(Nk[2],o,l,0),ln.set(Nk[3],a,l,0);for(let i=0;i<4;i++){const s=Nk[i];ln.transformMat4(s,s,n);const r=9*i;t[e+r]=s.x,t[e+r+1]=s.y,t[e+r+2]=s.z}e+=36}}},updateVerts(t){const e=t.node._uiProps.uiTransformComp,n=t.renderData.data,i=t.spriteFrame,s=i.getRect(),r=Math.abs(e.width),o=Math.abs(e.height),a=e.anchorX*r,c=e.anchorY*o,l=i.insetLeft,h=i.insetRight,_=s.width-l-h,u=i.insetTop,d=i.insetBottom,p=s.height-u-d,m=e.width/(l+h)>1?1:e.width/(l+h),f=e.height/(u+d)>1?1:e.height/(u+d);let g=0,v=0;g=_>0?Math.floor(1e3*this.sizableWidth)/1e3%_==0?_:this.sizableWidth%_:this.sizableWidth,v=p>0?Math.floor(1e3*this.sizableHeight)/1e3%p==0?p:this.sizableHeight%p:this.sizableHeight;for(let t=0;t<=this.col;t++)0===t?n[t].x=-a:t>0&&t<this.col?1===t?n[t].x=l*m+Math.min(_,this.sizableWidth)-a:_>0?t===this.col-1?n[t].x=l+g+_*(t-2)-a:n[t].x=l+Math.min(_,this.sizableWidth)+_*(t-2)-a:n[t].x=l+this.sizableWidth-a:t===this.col&&(n[t].x=Math.min(l+this.sizableWidth+h,r)-a);for(let t=0;t<=this.row;t++)0===t?n[t].y=-c:t>0&&t<this.row?1===t?n[t].y=d*f+Math.min(p,this.sizableHeight)-c:p>0?t===this.row-1?n[t].y=d+v+(t-2)*p-c:n[t].y=d+Math.min(p,this.sizableHeight)+(t-2)*p-c:n[t].y=d+this.sizableHeight-c:t===this.row&&(n[t].y=Math.min(d+this.sizableHeight+u,o)-c)}},zk=IU.Type,Bk=IU.FillType,Fk=t("spriteAssembler",{getAssembler(t){let e=Pk;const n=t;switch(n.type){case zk.SLICED:e=Mk;break;case zk.TILED:e=Lk;break;case zk.FILLED:e=n.fillType===Bk.RADIAL?Rk:mk}return e}});IU.Assembler=Fk;const Uk=_L.sharedManager,Gk={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.vertexCount=4,e.indicesCount=6,e.vData=new Float32Array(36),e},updateRenderData(t){t.type===EF.IMAGE_STENCIL&&(Pk.updateRenderData(t),Pk.updateColor(t))},fillBuffers(t,e){(t.type!==EF.IMAGE_STENCIL||t.spriteFrame)&&(Uk.pushMask(t),e.finishMergeBatches(),function(t,e){Uk.clear(t),e.commitModel(t,t._clearModel,t._clearStencilMtl)}(t,e),function(t,e){if(Uk.enterLevel(t),t.type===EF.IMAGE_STENCIL){Pk.fillBuffers(t,e);const n=t.graphics.getMaterialInstance(0);e.forceMergeBatches(n,t.spriteFrame,t.graphics)}else t.graphics.updateAssembler(e)}(t,e),Uk.enableMask())}},Hk={fillBuffers(t,e){Uk.exitMask()}},Vk={getAssembler:()=>Gk},kk={getAssembler:()=>Hk};CF.Assembler=Vk,CF.PostAssembler=kk;const jk=new wo(null),Wk=new bn;class qk{get handle(){return this._handle}constructor(){this._handle=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;const t=i.director.root.device;this._localData=new Float32Array(jc.COUNT),this._localBuffer=t.createBuffer(new uo(Ys.UNIFORM|Ys.TRANSFER_DST,Ks.HOST|Ks.DEVICE,jc.SIZE,jc.SIZE))}initialize(t){const e=i.director.root.device;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,jk.layout=t.passes[0].localSetLayout,this._handle&&(Kn.free(this._handle),this._handle=null),this._handle=Kn.alloc(e,jk),this._descriptorSet=Kn.get(this._handle),this._descriptorSet.bindBuffer(jc.BINDING,this._localBuffer);const n=wc.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,t.texture),this._descriptorSet.bindSampler(n,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0}updateTransform(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())}updateLocal(){this._transform&&this.uploadLocalData()}equals(t,e,n){return this._transform===t&&this._textureHash===e&&this._samplerHash===n}reset(){this._transform=null,this._textureHash=0,this._samplerHash=0}destroy(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._handle&&(Kn.free(this._handle),this._handle=null),this._localData=null}uploadLocalData(){const t=this._transform;if((t.hasChangedFlags||t._dirtyFlags)&&t.updateWorldTransform(),this._transformUpdate){const e=t._mat;bn.toArray(this._localData,e,jc.MAT_WORLD_OFFSET),bn.inverseTranspose(Wk,e),bn.toArray(this._localData,Wk,jc.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}}}class Xk{constructor(){this._descriptorSetCache=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new Jh(()=>new qk,16)}getDescriptorSet(t){const e=i.director.root;if(t.useLocalData){const e=this._localDescriptorSetCache;for(let n=0,i=e.length;n<i;n++){const i=e[n];if(i.equals(t.useLocalData,t.textureHash,t.samplerHash))return i.handle}const n=this._localCachePool.alloc();return n.initialize(t),this._localDescriptorSetCache.push(n),n.handle}{const n=this._descriptorSetCache.get(t.textureHash);if(n&&n.has(t.samplerHash))return n.get(t.samplerHash);{jk.layout=t.passes[0].localSetLayout;const i=Kn.alloc(e.device,jk),s=Kn.get(i),r=wc.SAMPLER_SPRITE;return s.bindTexture(r,t.texture),s.bindSampler(r,t.sampler),s.update(),n?this._descriptorSetCache.get(t.textureHash).set(t.samplerHash,i):this._descriptorSetCache.set(t.textureHash,new Map([[t.samplerHash,i]])),i}}}update(){this._localDescriptorSetCache.forEach(t=>{t.updateLocal()})}reset(){this._localDescriptorSetCache.forEach(t=>{this._localCachePool.free(t)}),this._localDescriptorSetCache.length=0}releaseDescriptorSetCache(t){this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).forEach(t=>{Kn.free(t)}),this._descriptorSetCache.delete(t))}destroy(){this._descriptorSetCache.forEach(t=>{t.forEach(t=>{Kn.free(t)})}),this._descriptorSetCache.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy(t=>{t.destroy()})}}i.internal.Batcher2D=class{get currBufferBatch(){return this._currMeshBuffer||(this._currMeshBuffer=this.acquireBufferBatch()),this._currMeshBuffer}set currBufferBatch(t){t&&(this._currMeshBuffer=t)}get batches(){return this._batches}acquireBufferBatch(t=pB){const e=t===pB?36:gB(t);return this._currMeshBuffer&&this._currMeshBuffer.vertexFormatBytes===e||this._requireBufferBatch(t),this._currMeshBuffer}registerCustomBuffer(t,e){let n;t instanceof zG?n=t:(n=this._bufferBatchPool.add(),n.initialize(t,e||this._recreateMeshBuffer.bind(this,t)));const i=n.vertexFormatBytes;let s=this._customMeshBuffers.get(i);return s||(s=[],this._customMeshBuffers.set(i,s)),s.push(n),n}unRegisterCustomBuffer(t){const e=this._customMeshBuffers.get(t.vertexFormatBytes);if(e)for(let n=0;n<e.length;n++)if(e[n]===t){e.splice(n,1);break}}set currStaticRoot(t){this._currStaticRoot=t}constructor(t){this.device=void 0,this._screens=[],this._bufferBatchPool=new Qh(()=>new zG(this),128),this._drawBatchPool=void 0,this._meshBuffers=new Map,this._customMeshBuffers=new Map,this._meshBufferUseCount=new Map,this._batches=void 0,this._doUploadBuffersCall=new Map,this._emptyMaterial=new Ap,this._currScene=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currBlendTargetHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._parentOpacity=1,this._descriptorSetCache=new Xk,this._root=t,this.device=t.device,this._batches=new t_(64),this._drawBatchPool=new Jh(()=>new FG,128)}initialize(){return!0}destroy(){for(let t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy();for(const t of this._meshBuffers.keys()){const e=this._meshBuffers.get(t);e&&e.forEach(t=>t.destroy())}this._drawBatchPool&&this._drawBatchPool.destroy(t=>{t.destroy(this)}),this._descriptorSetCache.destroy(),this._meshBuffers.clear(),_L.sharedManager.destroy()}addScreen(t){this._screens.push(t),this._screens.sort(this._screenSort)}getFirstRenderCamera(t){if(t.scene&&t.scene.renderScene){const e=t.scene.renderScene.cameras;for(let n=0;n<e.length;n++){const i=e[n];if(i.visibility&t.layer)return i}}return null}removeScreen(t){const e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)}sortScreens(){this._screens.sort(this._screenSort)}addUploadBuffersFunc(t,e){this._doUploadBuffersCall.set(t,e)}removeUploadBuffersFunc(t){this._doUploadBuffersCall.delete(t)}update(){const t=this._screens;for(let e=0;e<t.length;++e){const n=t[e];n.enabledInHierarchy&&this._recursiveScreenNode(n.node)}let e=0;if(this._batches.length)for(let t=0;t<this._batches.length;++t){const n=this._batches.array[t];if(n.renderScene){if(n.model){const t=n.model.subModels;for(let n=0;n<t.length;n++)t[n].priority=e++}else n.hDescriptorSet=this._descriptorSetCache.getDescriptorSet(n);n.renderScene.addBatch(n)}}}uploadBuffers(){if(this._batches.length>0){const t=this._doUploadBuffersCall;for(const e of t.keys())t.get(e).call(e,this);const e=this._meshBuffers;for(const t of e.keys()){const n=e.get(t);n&&n.forEach(t=>{t.uploadBuffers(),t.reset()})}const n=this._customMeshBuffers;for(const t of n.keys()){const e=n.get(t);e&&e.forEach(t=>{t.uploadBuffers(),t.reset()})}this._descriptorSetCache.update()}}reset(){for(let t=0;t<this._batches.length;++t){const e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}this._parentOpacity=1,this._currLayer=0,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._currScene=null,this._currMeshBuffer=null,this._meshBufferUseCount.clear(),this._batches.clear(),_L.sharedManager.reset(),this._descriptorSetCache.reset()}commitComp(t,e,n,i){const s=t;let r,o,a=0,c=0;e?(r=e.getGFXTexture(),o=e.getGFXSampler(),a=e.getHash(),c=e.getSamplerHash()):(r=null,o=null);const l=s._getRenderScene(),h=s.getRenderMaterial(0);s.stencilStage=_L.sharedManager.stage;const _=s.blendHash,u=s.stencilStage;this._currScene===l&&this._currLayer===t.node.layer&&this._currMaterial===h&&this._currBlendTargetHash===_&&this._currDepthStencilStateStage===u&&this._currTextureHash===a&&this._currSamplerHash===c&&this._currTransform===i||(this.autoMergeBatches(this._currComponent),this._currScene=l,this._currComponent=s,this._currTransform=i,this._currMaterial=h,this._currTexture=r,this._currSampler=o,this._currTextureHash=a,this._currSamplerHash=c,this._currBlendTargetHash=_,this._currDepthStencilStateStage=u,this._currLayer=t.node.layer),n&&(n.fillBuffers(s,this),this._applyOpacity(s))}commitModel(t,e,n){let s;this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(this._currComponent);let r=0;n&&(t.stencilStage!==lL.ENABLED&&t.stencilStage!==lL.DISABLED||(t.stencilStage=_L.sharedManager.stage),s=_L.sharedManager.getStencilStage(t.stencilStage,n),r=_L.sharedManager.getStencilHash(t.stencilStage));const o=i.director.getTotalFrames();e&&(e.updateTransform(o),e.updateUBOs(o));for(let i=0;i<e.subModels.length;i++){const o=this._drawBatchPool.alloc(),a=e.subModels[i];o.renderScene=t._getRenderScene(),o.visFlags=t.node.layer,o.model=e,o.bufferBatch=null,o.texture=null,o.sampler=null,o.useLocalData=null,s||(s=null),o.fillPasses(n,s,r,null,0,a.patches),o.hDescriptorSet=di.get(a.handle,_i.DESCRIPTOR_SET),o.hInputAssembler=di.get(a.handle,_i.INPUT_ASSEMBLER),o.model.visFlags=o.visFlags,this._batches.push(o)}this._currMaterial=this._emptyMaterial,this._currScene=null,this._currComponent=null,this._currTransform=null,this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}commitStaticBatch(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()}autoMergeBatches(t){const e=this.currBufferBatch,n=null==e?void 0:e.recordBatch(),i=this._currMaterial;if(!n||!i||!e)return;let s,r,o=0,a=0;t&&(s=-1===t.blendHash?null:t.getBlendState(),a=t.blendHash,r=null!==t.customMaterial?_L.sharedManager.getStencilStage(t.stencilStage,i):_L.sharedManager.getStencilStage(t.stencilStage),o=_L.sharedManager.getStencilHash(t.stencilStage));const c=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();c.renderScene=this._currScene,c.visFlags=this._currLayer,c.bufferBatch=e,c.texture=this._currTexture,c.sampler=this._currSampler,c.hInputAssembler=n,c.useLocalData=this._currTransform,c.textureHash=this._currTextureHash,c.samplerHash=this._currSamplerHash,c.fillPasses(i,r,o,s,a,null),this._batches.push(c),e.vertexStart=e.vertexOffset,e.indicesStart=e.indicesOffset,e.byteStart=e.byteOffset,Om.__isWebIOS14OrIPadOS14Env&&(this._currMeshBuffer=null)}forceMergeBatches(t,e,n){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=e.getSamplerHash()):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this._currScene=n._getRenderScene(),this.autoMergeBatches(n)}finishMergeBatches(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}flushMaterial(t){this._currMaterial=t}walk(t,e=0){const n=t.children.length,i=this._parentOpacity;if(this._parentOpacity*=t._uiProps.opacity,this._preProcess(t),n>0&&!t._static){const n=t.children;for(let t=0;t<n.length;++t){const i=n[t];this.walk(i,e)}}this._postProcess(t),this._parentOpacity=i,e+=1}_preProcess(t){if(!t._uiProps.uiTransformComp)return;const e=t._uiProps.uiComp;e&&e.enabledInHierarchy&&e.updateAssembler(this)}_postProcess(t){const e=t._uiProps.uiComp;e&&e.enabledInHierarchy&&e.postUpdateAssembler(this)}_recursiveScreenNode(t){this.walk(t),this.autoMergeBatches(this._currComponent)}_createMeshBuffer(t){const e=this._bufferBatchPool.add();e.initialize(t,this._recreateMeshBuffer.bind(this,t));const n=gB(t);let i=this._meshBuffers.get(n);return i||(i=[],this._meshBuffers.set(n,i)),i.push(e),e}_recreateMeshBuffer(t,e,n){this.autoMergeBatches(),this._requireBufferBatch(t,e,n)}_requireBufferBatch(t,e,n){const i=gB(t);let s=this._meshBuffers.get(i);s||(s=[],this._meshBuffers.set(i,s));const r=this._meshBufferUseCount.get(i)||0;r>=s.length?this._currMeshBuffer=this._createMeshBuffer(t):this._currMeshBuffer=s[r],this._meshBufferUseCount.set(i,r+1),e&&n&&this._currMeshBuffer.request(e,n)}_screenSort(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()}_applyOpacity(t){const e=t.color.a/255,n=this._parentOpacity*=e,i=this.currBufferBatch,s=i.byteOffset>>2,r=i.vData,o=i.lastByteOffset>>2,a=i.vertexFormatBytes/4;for(let t=o;t<s;t+=a)r[t+zG.OPACITY_OFFSET]*=n;i.lastByteOffset=i.byteOffset}_releaseDescriptorSetCache(t){this._descriptorSetCache.releaseDescriptorSetCache(t)}};let Yk=null,Kk=-1;const $k=Object.create(null),Zk=[],Jk=(()=>{let t;return()=>{if(void 0===t)if("FontFace"in window){const e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),n=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);t=e?parseInt(e[1],10)>42:!n}else t=!1;return t}})();function Qk(){let t=!0;const e=Date.now();for(let n=Zk.length-1;n>=0;n--){const i=Zk[n],s=i.fontFamilyName;if(e-i.startTime>3e3){x(4933,s),i.onComplete(null,s),Zk.splice(n,1);continue}const r=i.refWidth,o="40px "+s;Yk.font=o,r!==TN(Yk,"BES bswy:->@123丁ぁᄁ",o)?(Zk.splice(n,1),i.onComplete(null,s)):t=!1}t&&(clearInterval(Kk),Kk=-1)}function tj(t,e,n){const i=function(t){const e=t.lastIndexOf(".ttf");if(-1===e)return t;const n=t.lastIndexOf("/");let i;return i=-1===n?t.substring(0,e)+"_LABEL":t.substring(n+1,e)+"_LABEL",-1!==i.indexOf(" ")&&(i=`"${i}"`),i}(t);if($k[i])return void n(null,i);if(!Yk){const t=document.createElement("canvas");t.width=100,t.height=100,Yk=t.getContext("2d")}const s=TN(Yk,"BES bswy:->@123丁ぁᄁ","40px "+i),r=document.createElement("style");r.type="text/css";let o="";Number.isNaN(i)?o+=`@font-face { font-family:${i}; src:`:o+=`@font-face { font-family:"${i}"; src:`,o+=`url("${t}");`,r.textContent=o+"}",document.body.appendChild(r);const a=document.createElement("div"),c=a.style;if(c.fontFamily=i,a.innerHTML=".",c.position="absolute",c.left="-100px",c.top="-100px",document.body.appendChild(a),Jk())!function(t,e,n){const i=new Promise((n,i)=>{const s=()=>{Date.now()-t>=3e3?i():document.fonts.load("40px "+e).then(t=>{t.length>=1?n():setTimeout(s,100)},()=>{i()})};s()});let s=null;const r=new Promise((t,e)=>{s=setTimeout(e,3e3)});Promise.race([r,i]).then(()=>{s&&(clearTimeout(s),s=null),n(null,e)},()=>{x(4933,e),n(null,e)})}(Date.now(),i,n);else{const t={fontFamilyName:i,refWidth:s,onComplete:n,startTime:Date.now()};Zk.push(t),-1===Kk&&(Kk=setInterval(Qk,100))}$k[i]=r}function ej(t,e,n,i){const s=new ZM;s._nativeUrl=t,s._nativeAsset=e,i(null,s)}var nj,ij,sj,rj,oj,aj,cj,lj,hj,_j,uj,dj,pj,mj,fj,gj,vj,yj,xj,Sj,Tj,Ej,Cj,Aj,bj,wj,Rj,Ij,Pj,Oj,Dj,Mj,Nj,Lj,zj,Bj,Fj,Uj,Gj,Hj,Vj,kj,jj,Wj,qj,Xj,Yj,Kj,$j,Zj;NE.register({".font":tj,".eot":tj,".ttf":tj,".woff":tj,".svg":tj,".ttc":tj}),HE.register({".font":ej,".eot":ej,".ttf":ej,".woff":ej,".svg":ej,".ttc":ej}),i.UI={MeshBuffer:zG,spriteAssembler:Fk,graphicsAssembler:XH,labelAssembler:uk};const Jj=new Ln;var Qj,tW;let eW;!function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.SPRITE=2]="SPRITE",t[t.SCALE=3]="SCALE"}(Qj||(Qj={})),Xt(Qj),function(t){t.NORMAL="normal",t.HOVER="hover",t.PRESSED="pressed",t.DISABLED="disabled"}(tW||(tW={})),function(t){t.CLICK="click"}(eW||(eW={}));let nW,iW,sW,rW=t("Button",(nj=Yl("cc.Button"),ij=ah(),sj=$l(110),rj=ih(),oj=Kl(hL),aj=Ah(sx),cj=gh(),lj=_h(),hj=gh(),_j=_h(),uj=Ah(Qj),dj=gh(),pj=_h(),mj=_h(),fj=_h(),gj=_h(),vj=_h(),yj=dh(),xj=ph(),Sj=_h(),Tj=_h(),Ej=Ah(HM),Cj=_h(),Aj=Ah(HM),bj=_h(),wj=Ah(HM),Rj=_h(),Ij=Ah(HM),Pj=_h(),Oj=Ah([pC]),Dj=gh(),Mj=_h(),nj(Nj=ij(Nj=sj(Nj=rj(Nj=oj(Nj=nh((Zj=$j=class extends Nu{constructor(...t){super(...t),Ul(this,"clickEvents",zj,this),Ul(this,"_interactable",Bj,this),Ul(this,"_transition",Fj,this),Ul(this,"_normalColor",Uj,this),Ul(this,"_hoverColor",Gj,this),Ul(this,"_pressedColor",Hj,this),Ul(this,"_disabledColor",Vj,this),Ul(this,"_normalSprite",kj,this),Ul(this,"_hoverSprite",jj,this),Ul(this,"_pressedSprite",Wj,this),Ul(this,"_disabledSprite",qj,this),Ul(this,"_duration",Xj,this),Ul(this,"_zoomScale",Yj,this),Ul(this,"_target",Kj,this),this._pressed=!1,this._hovered=!1,this._fromColor=new Ln,this._toColor=new Ln,this._time=0,this._transitionFinished=!0,this._fromScale=new ln,this._toScale=new ln,this._originalScale=null,this._sprite=null,this._targetScale=new ln}get target(){return this._target||this.node}set target(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}get interactable(){return this._interactable}set interactable(t){this._interactable=t,this._updateState(),this._interactable||this._resetState()}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get transition(){return this._transition}set transition(t){this._transition!==t&&(this._transition===Qj.COLOR?this._updateColorTransition(tW.NORMAL):this._transition===Qj.SPRITE&&this._updateSpriteTransition(tW.NORMAL),this._transition=t,this._updateState())}get normalColor(){return this._normalColor}set normalColor(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}get pressedColor(){return this._pressedColor}set pressedColor(t){this._pressedColor!==t&&this._pressedColor.set(t)}get hoverColor(){return this._hoverColor}set hoverColor(t){this._hoverColor!==t&&this._hoverColor.set(t)}get disabledColor(){return this._disabledColor}set disabledColor(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}get duration(){return this._duration}set duration(t){this._duration!==t&&(this._duration=t)}get zoomScale(){return this._zoomScale}set zoomScale(t){this._zoomScale!==t&&(this._zoomScale=t)}get normalSprite(){return this._normalSprite}set normalSprite(t){if(this._normalSprite===t)return;this._normalSprite=t;const e=this.node.getComponent(IU);e&&(e.spriteFrame=t),this._updateState()}get pressedSprite(){return this._pressedSprite}set pressedSprite(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}get hoverSprite(){return this._hoverSprite}set hoverSprite(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}get disabledSprite(){return this._disabledSprite}set disabledSprite(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}__preload(){this.target||(this.target=this.node);const t=this.node.getComponent(IU);t&&(this._normalSprite=t.spriteFrame),this._applyTarget(),this._resetState()}onEnable(){this._registerNodeEvent()}onDisable(){this._resetState(),this._unregisterNodeEvent()}update(t){const e=this.target;if(this._transitionFinished||!e)return;if(this._transition!==Qj.COLOR&&this._transition!==Qj.SCALE)return;this._time+=t;let n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===Qj.COLOR){const t=e._uiProps.uiComp;Ln.lerp(Jj,this._fromColor,this._toColor,n),t&&(t.color=Jj)}else this.transition===Qj.SCALE&&(e.getScale(this._targetScale),this._targetScale.x=ke(this._fromScale.x,this._toScale.x,n),this._targetScale.y=ke(this._fromScale.y,this._toScale.y,n),e.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}_resizeNodeToTargetNode(){this.target&&this.target._uiProps.uiTransformComp}_resetState(){this._pressed=!1,this._hovered=!1;const t=this.target;if(!t)return;const e=t.getComponent(UL);if(!e)return;const n=this._transition;n===Qj.COLOR&&this._interactable?e.color=this._normalColor:n===Qj.SCALE&&this._originalScale&&t.setScale(this._originalScale),this._transitionFinished=!0}_registerNodeEvent(){this.node.on(pf.TOUCH_START,this._onTouchBegan,this),this.node.on(pf.TOUCH_MOVE,this._onTouchMove,this),this.node.on(pf.TOUCH_END,this._onTouchEnded,this),this.node.on(pf.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(pf.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(pf.MOUSE_LEAVE,this._onMouseMoveOut,this)}_registerTargetEvent(t){t.on(pf.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)}_unregisterNodeEvent(){this.node.off(pf.TOUCH_START,this._onTouchBegan,this),this.node.off(pf.TOUCH_MOVE,this._onTouchMove,this),this.node.off(pf.TOUCH_END,this._onTouchEnded,this),this.node.off(pf.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(pf.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(pf.MOUSE_LEAVE,this._onMouseMoveOut,this)}_unregisterTargetEvent(t){t.off(pf.TRANSFORM_CHANGED)}_getTargetSprite(t){let e=null;return t&&(e=t.getComponent(IU)),e}_applyTarget(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new ln),ln.copy(this._originalScale,this.target.getScale()))}_onTargetSpriteFrameChanged(t){this._transition===Qj.SPRITE&&this._setCurrentStateSpriteFrame(t.spriteFrame)}_setCurrentStateSpriteFrame(t){if(t)switch(this._getButtonState()){case tW.NORMAL:this._normalSprite=t;break;case tW.HOVER:this._hoverSprite=t;break;case tW.PRESSED:this._pressedSprite=t;break;case tW.DISABLED:this._disabledSprite=t}}_onTargetColorChanged(t){this._transition===Qj.COLOR&&this._setCurrentStateColor(t)}_setCurrentStateColor(t){switch(this._getButtonState()){case tW.NORMAL:this._normalColor=t;break;case tW.HOVER:this._hoverColor=t;break;case tW.PRESSED:this._pressedColor=t;break;case tW.DISABLED:this._disabledColor=t}}_onTargetTransformChanged(t){t|Ol.SCALE&&this._originalScale&&this._transition===Qj.SCALE&&this._transitionFinished&&ln.copy(this._originalScale,this.target.getScale())}_onTouchBegan(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchMove(t){if(!this._interactable||!this.enabledInHierarchy||!this._pressed)return;if(!t)return;const e=t.touch;if(!e)return;const n=this.node._uiProps.uiTransformComp.isHit(e.getUILocation());if(this._transition===Qj.SCALE&&this.target&&this._originalScale)n?(ln.copy(this._fromScale,this._originalScale),ln.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale));else{let t;t=n?tW.PRESSED:tW.NORMAL,this._applyTransition(t)}t&&(t.propagationStopped=!0)}_onTouchEnded(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(pC.emitEvents(this.clickEvents,t),this.node.emit(eW.CLICK,this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchCancel(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}_onMouseMoveIn(t){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==Qj.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}_onMouseMoveOut(t){this._hovered&&(this._hovered=!1,this._updateState())}_updateState(){const t=this._getButtonState();this._applyTransition(t)}_getButtonState(){let t=tW.NORMAL;return this._interactable?this._pressed?t=tW.PRESSED:this._hovered&&(t=tW.HOVER):t=tW.DISABLED,t.toString()}_updateColorTransition(t){var e;const n=this[t+"Color"],i=null===(e=this.target)||void 0===e?void 0:e.getComponent(UL);i&&(t===tW.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))}_updateSpriteTransition(t){const e=this[t+"Sprite"];this._sprite&&e&&(this._sprite.spriteFrame=e)}_updateScaleTransition(t){this._interactable&&(t===tW.PRESSED?this._zoomUp():this._zoomBack())}_zoomUp(){this._originalScale&&(ln.copy(this._fromScale,this._originalScale),ln.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)}_zoomBack(){this.target&&this._originalScale&&(ln.copy(this._fromScale,this.target.getScale()),ln.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}_applyTransition(t){const e=this._transition;e===Qj.COLOR?this._updateColorTransition(t):e===Qj.SPRITE?this._updateSpriteTransition(t):e===Qj.SCALE&&this._updateScaleTransition(t)}},$j.Transition=Qj,$j.EventType=eW,Gl((Lj=Zj).prototype,"target",[aj,cj,lj],Object.getOwnPropertyDescriptor(Lj.prototype,"target"),Lj.prototype),Gl(Lj.prototype,"interactable",[hj,_j],Object.getOwnPropertyDescriptor(Lj.prototype,"interactable"),Lj.prototype),Gl(Lj.prototype,"transition",[uj,dj,pj],Object.getOwnPropertyDescriptor(Lj.prototype,"transition"),Lj.prototype),Gl(Lj.prototype,"normalColor",[mj],Object.getOwnPropertyDescriptor(Lj.prototype,"normalColor"),Lj.prototype),Gl(Lj.prototype,"pressedColor",[fj],Object.getOwnPropertyDescriptor(Lj.prototype,"pressedColor"),Lj.prototype),Gl(Lj.prototype,"hoverColor",[gj],Object.getOwnPropertyDescriptor(Lj.prototype,"hoverColor"),Lj.prototype),Gl(Lj.prototype,"disabledColor",[vj],Object.getOwnPropertyDescriptor(Lj.prototype,"disabledColor"),Lj.prototype),Gl(Lj.prototype,"duration",[yj,xj,Sj],Object.getOwnPropertyDescriptor(Lj.prototype,"duration"),Lj.prototype),Gl(Lj.prototype,"zoomScale",[Tj],Object.getOwnPropertyDescriptor(Lj.prototype,"zoomScale"),Lj.prototype),Gl(Lj.prototype,"normalSprite",[Ej,Cj],Object.getOwnPropertyDescriptor(Lj.prototype,"normalSprite"),Lj.prototype),Gl(Lj.prototype,"pressedSprite",[Aj,bj],Object.getOwnPropertyDescriptor(Lj.prototype,"pressedSprite"),Lj.prototype),Gl(Lj.prototype,"hoverSprite",[wj,Rj],Object.getOwnPropertyDescriptor(Lj.prototype,"hoverSprite"),Lj.prototype),Gl(Lj.prototype,"disabledSprite",[Ij,Pj],Object.getOwnPropertyDescriptor(Lj.prototype,"disabledSprite"),Lj.prototype),zj=Gl(Lj.prototype,"clickEvents",[Oj,Ql,Dj,Mj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Bj=Gl(Lj.prototype,"_interactable",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Fj=Gl(Lj.prototype,"_transition",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qj.NONE}}),Uj=Gl(Lj.prototype,"_normalColor",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ln.WHITE.clone()}}),Gj=Gl(Lj.prototype,"_hoverColor",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln(211,211,211,255)}}),Hj=Gl(Lj.prototype,"_pressedColor",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ln.WHITE.clone()}}),Vj=Gl(Lj.prototype,"_disabledColor",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ln(124,124,124,255)}}),kj=Gl(Lj.prototype,"_normalSprite",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jj=Gl(Lj.prototype,"_hoverSprite",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wj=Gl(Lj.prototype,"_pressedSprite",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qj=Gl(Lj.prototype,"_disabledSprite",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Xj=Gl(Lj.prototype,"_duration",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Yj=Gl(Lj.prototype,"_zoomScale",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Kj=Gl(Lj.prototype,"_target",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Nj=Lj))||Nj)||Nj)||Nj)||Nj)||Nj)||Nj));(function(t){t[t.DEFAULT=0]="DEFAULT",t[t.DONE=1]="DONE",t[t.SEND=2]="SEND",t[t.SEARCH=3]="SEARCH",t[t.GO=4]="GO",t[t.NEXT=5]="NEXT"})(nW||(nW={})),jt(nW),function(t){t[t.ANY=0]="ANY",t[t.EMAIL_ADDR=1]="EMAIL_ADDR",t[t.NUMERIC=2]="NUMERIC",t[t.PHONE_NUMBER=3]="PHONE_NUMBER",t[t.URL=4]="URL",t[t.DECIMAL=5]="DECIMAL",t[t.SINGLE_LINE=6]="SINGLE_LINE"}(iW||(iW={})),jt(iW),function(t){t[t.PASSWORD=0]="PASSWORD",t[t.SENSITIVE=1]="SENSITIVE",t[t.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",t[t.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",t[t.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",t[t.DEFAULT=5]="DEFAULT"}(sW||(sW={})),jt(sW);var oW,aW,cW,lW,hW,_W,uW,dW,pW,mW,fW,gW,vW,yW,xW,SW,TW,EW,CW,AW,bW,wW,RW,IW,PW,OW,DW,MW,NW,LW,zW,BW,FW,UW,GW,HW,VW,kW,jW,WW,qW,XW,YW,KW,$W,ZW,JW,QW,tq,eq,nq,iq,sq,rq,oq,aq,cq,lq,hq,_q,uq,dq,pq,mq,fq,gq,vq,yq,xq,Sq,Tq,Eq,Cq,Aq,bq,wq,Rq,Iq,Pq,Oq,Dq,Mq,Nq,Lq,zq,Bq,Fq,Uq,Gq,Hq,Vq,kq,jq,Wq,qq,Xq,Yq,Kq,$q,Zq,Jq,Qq,tX,eX,nX,iX,sX,rX,oX,aX,cX,lX,hX,_X,uX;new bn,new bn,new ln,function(t){t.EDITING_DID_BEGAN="editing-did-began",t.EDITING_DID_ENDED="editing-did-ended",t.TEXT_CHANGED="text-changed",t.EDITING_RETURN="editing-return"}(uq||(uq={})),t("EditBox",(oW=Yl("cc.EditBox"),aW=ah(),cW=$l(100),lW=ih(),hW=Kl(hL),_W=gh(),uW=_h(),dW=gh(),pW=_h(),mW=Ah(Qz),fW=gh(),gW=_h(),vW=Ah(Qz),yW=gh(),xW=_h(),SW=Ah(HM),TW=gh(),EW=_h(),CW=Ah(sW),AW=gh(),bW=_h(),wW=Ah(iW),RW=gh(),IW=_h(),PW=Ah(nW),OW=gh(),DW=_h(),MW=gh(),NW=_h(),LW=gh(),zW=_h(),BW=Ah([pC]),FW=gh(),UW=_h(),GW=Ah([pC]),HW=gh(),VW=_h(),kW=Ah([pC]),jW=gh(),WW=_h(),qW=Ah([pC]),XW=gh(),YW=_h(),oW(KW=aW(KW=cW(KW=lW(KW=hW(KW=nh((_q=hq=class t extends Nu{constructor(...t){super(...t),Ul(this,"editingDidBegan",ZW,this),Ul(this,"textChanged",JW,this),Ul(this,"editingDidEnded",QW,this),Ul(this,"editingReturn",tq,this),this._impl=null,this._background=null,Ul(this,"_textLabel",eq,this),Ul(this,"_placeholderLabel",nq,this),Ul(this,"_returnType",iq,this),Ul(this,"_string",sq,this),Ul(this,"_tabIndex",rq,this),Ul(this,"_backgroundImage",oq,this),Ul(this,"_inputFlag",aq,this),Ul(this,"_inputMode",cq,this),Ul(this,"_maxLength",lq,this),this._isLabelVisible=!1}get string(){return this._string}set string(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string=t,this._updateString(t)}get placeholder(){return this._placeholderLabel?this._placeholderLabel.string:""}set placeholder(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}get textLabel(){return this._textLabel}set textLabel(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}get placeholderLabel(){return this._placeholderLabel}set placeholderLabel(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}get backgroundImage(){return this._backgroundImage}set backgroundImage(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._createBackgroundSprite())}get inputFlag(){return this._inputFlag}set inputFlag(t){this._inputFlag=t,this._updateString(this._string)}get inputMode(){return this._inputMode}set inputMode(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}get returnType(){return this._returnType}set returnType(t){this._returnType=t}get maxLength(){return this._maxLength}set maxLength(t){this._maxLength=t}get tabIndex(){return this._tabIndex}set tabIndex(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}__preload(){this._init()}onEnable(){this._registerEvent(),this._impl&&this._impl.onEnable()}update(){this._impl&&this._impl.update()}onDisable(){this._unregisterEvent(),this._impl&&this._impl.onDisable()}onDestroy(){this._impl&&this._impl.clear()}setFocus(){this._impl&&this._impl.setFocus(!0)}focus(){this._impl&&this._impl.setFocus(!0)}blur(){this._impl&&this._impl.setFocus(!1)}isFocused(){return!!this._impl&&this._impl.isFocused()}_editBoxEditingDidBegan(){pC.emitEvents(this.editingDidBegan,this),this.node.emit(uq.EDITING_DID_BEGAN,this)}_editBoxEditingDidEnded(){pC.emitEvents(this.editingDidEnded,this),this.node.emit(uq.EDITING_DID_ENDED,this)}_editBoxTextChanged(t){t=this._updateLabelStringStyle(t,!0),this.string=t,pC.emitEvents(this.textChanged,t,this),this.node.emit(uq.TEXT_CHANGED,this)}_editBoxEditingReturn(){pC.emitEvents(this.editingReturn,this),this.node.emit(uq.EDITING_RETURN,this)}_showLabels(){this._isLabelVisible=!0,this._updateLabels()}_hideLabels(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}_onTouchBegan(t){t.propagationStopped=!0}_onTouchCancel(t){t.propagationStopped=!0}_onTouchEnded(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0}_init(){this._createBackgroundSprite(),this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(pf.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}_createBackgroundSprite(){this._background||(this._background=this.node.getComponent(IU),this._background||(this._background=this.node.addComponent(IU))),this._background.type=IU.Type.SLICED,this._background.spriteFrame=this._backgroundImage}_updateTextLabel(){let t=this._textLabel;if(!t){let e=this.node.getChildByName("TEXT_LABEL");e||(e=new sx("TEXT_LABEL")),t=e.getComponent(Qz),t||(t=e.addComponent(Qz)),e.parent=this.node,this._textLabel=t}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=Qz.Overflow.CLAMP,this._inputMode===iW.ANY?(t.verticalAlign=Xz.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)}_updatePlaceholderLabel(){let t=this._placeholderLabel;if(!t){let e=this.node.getChildByName("PLACEHOLDER_LABEL");e||(e=new sx("PLACEHOLDER_LABEL")),t=e.getComponent(Qz),t||(t=e.addComponent(Qz)),e.parent=this.node,this._placeholderLabel=t}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=Qz.Overflow.CLAMP,this._inputMode===iW.ANY?(t.verticalAlign=Xz.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this.placeholder}_syncSize(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){const n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=t.anchorPoint,n.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}_updateLabels(){if(this._isLabelVisible){const t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}}_updateString(t){const e=this._textLabel;if(!e)return;let n=t;n&&(n=this._updateLabelStringStyle(n)),e.string=n,this._updateLabels()}_updateLabelStringStyle(t,e=!1){const n=this._inputFlag;if(e||n!==sW.PASSWORD)n===sW.INITIAL_CAPS_ALL_CHARACTERS?t=t.toUpperCase():n===sW.INITIAL_CAPS_WORD?t=t.replace(/(?:^|\s)\S/g,t=>t.toUpperCase()):n===sW.INITIAL_CAPS_SENTENCE&&(t=function(t){return t.charAt(0).toUpperCase()+t.slice(1)}(t));else{let e="";const n=t.length;for(let t=0;t<n;++t)e+="●";t=e}return t}_registerEvent(){this.node.on(pf.TOUCH_START,this._onTouchBegan,this),this.node.on(pf.TOUCH_END,this._onTouchEnded,this)}_unregisterEvent(){this.node.off(pf.TOUCH_START,this._onTouchBegan,this),this.node.off(pf.TOUCH_END,this._onTouchEnded,this)}_updateLabelPosition(t){const e=this.node._uiProps.uiTransformComp,n=-e.anchorX*e.width,i=-e.anchorY*e.height,s=this._placeholderLabel,r=this._textLabel;r&&(r.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),r.node.position=new ln(n+2,i+t.height,r.node.position.z),this._inputMode===iW.ANY&&(r.verticalAlign=Xz.TOP),r.enableWrapText=this._inputMode===iW.ANY),s&&(s.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),s.lineHeight=t.height,s.node.position=new ln(n+2,i+t.height,s.node.position.z),this._inputMode===iW.ANY&&(s.verticalAlign=Xz.TOP),s.enableWrapText=this._inputMode===iW.ANY)}_resizeChildNodes(){const t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.position=new ln(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));const n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.position=new ln(-t.width/2,t.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(t.contentSize));const i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(t.contentSize)}},hq._EditBoxImpl=class{constructor(){this._editing=!1,this._delegate=null}init(t){}onEnable(){}update(){}onDisable(){this._editing&&this.endEditing()}clear(){this._delegate=null}setTabIndex(t){}setSize(t,e){}setFocus(t){t?this.beginEditing():this.endEditing()}isFocused(){return this._editing}beginEditing(){}endEditing(){}},hq.KeyboardReturnType=nW,hq.InputFlag=sW,hq.InputMode=iW,hq.EventType=uq,Gl(($W=_q).prototype,"string",[_W,uW],Object.getOwnPropertyDescriptor($W.prototype,"string"),$W.prototype),Gl($W.prototype,"placeholder",[dW,pW],Object.getOwnPropertyDescriptor($W.prototype,"placeholder"),$W.prototype),Gl($W.prototype,"textLabel",[mW,fW,gW],Object.getOwnPropertyDescriptor($W.prototype,"textLabel"),$W.prototype),Gl($W.prototype,"placeholderLabel",[vW,yW,xW],Object.getOwnPropertyDescriptor($W.prototype,"placeholderLabel"),$W.prototype),Gl($W.prototype,"backgroundImage",[SW,TW,EW],Object.getOwnPropertyDescriptor($W.prototype,"backgroundImage"),$W.prototype),Gl($W.prototype,"inputFlag",[CW,AW,bW],Object.getOwnPropertyDescriptor($W.prototype,"inputFlag"),$W.prototype),Gl($W.prototype,"inputMode",[wW,RW,IW],Object.getOwnPropertyDescriptor($W.prototype,"inputMode"),$W.prototype),Gl($W.prototype,"returnType",[PW,OW,DW],Object.getOwnPropertyDescriptor($W.prototype,"returnType"),$W.prototype),Gl($W.prototype,"maxLength",[MW,NW],Object.getOwnPropertyDescriptor($W.prototype,"maxLength"),$W.prototype),Gl($W.prototype,"tabIndex",[LW,zW],Object.getOwnPropertyDescriptor($W.prototype,"tabIndex"),$W.prototype),ZW=Gl($W.prototype,"editingDidBegan",[BW,Ql,FW,UW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),JW=Gl($W.prototype,"textChanged",[GW,Ql,HW,VW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),QW=Gl($W.prototype,"editingDidEnded",[kW,Ql,jW,WW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),tq=Gl($W.prototype,"editingReturn",[qW,Ql,XW,YW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eq=Gl($W.prototype,"_textLabel",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nq=Gl($W.prototype,"_placeholderLabel",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iq=Gl($W.prototype,"_returnType",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nW.DEFAULT}}),sq=Gl($W.prototype,"_string",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),rq=Gl($W.prototype,"_tabIndex",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),oq=Gl($W.prototype,"_backgroundImage",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aq=Gl($W.prototype,"_inputFlag",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sW.DEFAULT}}),cq=Gl($W.prototype,"_inputMode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iW.ANY}}),lq=Gl($W.prototype,"_maxLength",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),KW=$W))||KW)||KW)||KW)||KW)||KW)||KW));const dX=pf;var pX,mX,fX,gX,vX,yX;!function(t){t[t.NONE=0]="NONE",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.GRID=3]="GRID"}(pX||(pX={})),Xt(pX),function(t){t[t.NONE=0]="NONE",t[t.CONTAINER=1]="CONTAINER",t[t.CHILDREN=2]="CHILDREN"}(mX||(mX={})),Xt(mX),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(fX||(fX={})),Xt(fX),function(t){t[t.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",t[t.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(gX||(gX={})),Xt(gX),function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(vX||(vX={})),Xt(vX),function(t){t[t.NONE=0]="NONE",t[t.FIXED_ROW=1]="FIXED_ROW",t[t.FIXED_COL=2]="FIXED_COL"}(yX||(yX={})),Xt(yX);const xX=new ln;let SX=t("Layout",(dq=Yl("cc.Layout"),pq=ah(),mq=$l(110),fq=ih(),gq=Kl(hL),vq=lh(),yq=_h(),xq=lh(),Sq=_h(),Tq=Ah(pX),Eq=_h(),Cq=Ah(mX),Aq=lh(),bq=_h(),wq=lh(),Rq=_h(),Iq=Ah(fX),Pq=_h(),Oq=_h(),Dq=_h(),Mq=_h(),Nq=_h(),Lq=_h(),zq=_h(),Bq=Ah(gX),Fq=_h(),Uq=Ah(vX),Gq=_h(),Hq=Ah(yX),Vq=lh(),kq=_h(),jq=lh(),Wq=_h(),qq=_h(),dq(Xq=pq(Xq=mq(Xq=fq(Xq=gq(Xq=nh((uX=_X=class extends Nu{constructor(...t){super(...t),Ul(this,"_resizeMode",Kq,this),Ul(this,"_layoutType",$q,this),Ul(this,"_cellSize",Zq,this),Ul(this,"_startAxis",Jq,this),Ul(this,"_paddingLeft",Qq,this),Ul(this,"_paddingRight",tX,this),Ul(this,"_paddingTop",eX,this),Ul(this,"_paddingBottom",nX,this),Ul(this,"_spacingX",iX,this),Ul(this,"_spacingY",sX,this),Ul(this,"_verticalDirection",rX,this),Ul(this,"_horizontalDirection",oX,this),Ul(this,"_constraint",aX,this),Ul(this,"_constraintNum",cX,this),Ul(this,"_affectedByScale",lX,this),Ul(this,"_isAlign",hX,this),this._layoutSize=new On(300,200),this._layoutDirty=!0,this._childrenDirty=!1,this._usefulLayoutObj=[],this._init=!1}get alignHorizontal(){return this._isAlign}set alignHorizontal(t){this._layoutType===pX.HORIZONTAL&&(this._isAlign=t,this._doLayoutDirty())}get alignVertical(){return this._isAlign}set alignVertical(t){this._layoutType===pX.VERTICAL&&(this._isAlign=t,this._doLayoutDirty())}get type(){return this._layoutType}set type(t){this._layoutType=t,this._doLayoutDirty()}get resizeMode(){return this._resizeMode}set resizeMode(t){this._layoutType!==pX.NONE&&(this._resizeMode=t,this._doLayoutDirty())}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}get startAxis(){return this._startAxis}set startAxis(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}get paddingLeft(){return this._paddingLeft}set paddingLeft(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}get paddingRight(){return this._paddingRight}set paddingRight(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}get paddingTop(){return this._paddingTop}set paddingTop(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}get paddingBottom(){return this._paddingBottom}set paddingBottom(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}get spacingY(){return this._spacingY}set spacingY(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}get verticalDirection(){return this._verticalDirection}set verticalDirection(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}get horizontalDirection(){return this._horizontalDirection}set horizontalDirection(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}get padding(){return this._paddingLeft}set padding(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}get constraint(){return this._constraint}set constraint(t){this._layoutType!==pX.NONE&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}get constraintNum(){return this._constraintNum}set constraintNum(t){this._constraint!==yX.NONE&&this._constraintNum!==t&&(t<=0&&_("Limit values to be greater than 0"),this._constraintNum=t,this._doLayoutDirty())}get affectedByScale(){return this._affectedByScale}set affectedByScale(t){this._affectedByScale=t,this._doLayoutDirty()}updateLayout(t=!1){(this._layoutDirty||t)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)}onEnable(){this._addEventListeners();const t=this.node._uiProps.uiTransformComp;t.contentSize.equals(On.ZERO)&&t.setContentSize(this._layoutSize),this._doLayoutDirty()}onDisable(){this._usefulLayoutObj.length=0,this._removeEventListeners()}_checkUsefulObj(){this._usefulLayoutObj.length=0;const t=this.node.children;for(let e=0;e<t.length;++e){const n=t[e],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}}_addEventListeners(){rE.on(sE.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(dX.SIZE_CHANGED,this._resized,this),this.node.on(dX.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(dX.CHILD_ADDED,this._childAdded,this),this.node.on(dX.CHILD_REMOVED,this._childRemoved,this),this.node.on(dX.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this._addChildrenEventListeners()}_removeEventListeners(){rE.off(sE.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(dX.SIZE_CHANGED,this._resized,this),this.node.off(dX.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(dX.CHILD_ADDED,this._childAdded,this),this.node.off(dX.CHILD_REMOVED,this._childRemoved,this),this.node.off(dX.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this._removeChildrenEventListeners()}_addChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const n=t[e];n.on(dX.SIZE_CHANGED,this._doLayoutDirty,this),n.on(dX.TRANSFORM_CHANGED,this._transformDirty,this),n.on(dX.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on("active-in-hierarchy-changed",this._childrenChanged,this)}}_removeChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const n=t[e];n.off(dX.SIZE_CHANGED,this._doLayoutDirty,this),n.off(dX.TRANSFORM_CHANGED,this._transformDirty,this),n.off(dX.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off("active-in-hierarchy-changed",this._childrenChanged,this)}}_childAdded(t){t.on(dX.SIZE_CHANGED,this._doLayoutDirty,this),t.on(dX.TRANSFORM_CHANGED,this._transformDirty,this),t.on(dX.ANCHOR_CHANGED,this._doLayoutDirty,this),t.on("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_childRemoved(t){t.off(dX.SIZE_CHANGED,this._doLayoutDirty,this),t.off(dX.TRANSFORM_CHANGED,this._transformDirty,this),t.off(dX.ANCHOR_CHANGED,this._doLayoutDirty,this),t.off("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_resized(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()}_doLayoutHorizontally(t,e,n,i){const s=this.node._uiProps.uiTransformComp.anchorPoint,r=this._getFixedColumn();let o=1,a=this._paddingLeft;this._horizontalDirection===vX.RIGHT_TO_LEFT&&(o=-1,a=this._paddingRight);const c=(this._horizontalDirection-s.x)*t+o*a;let l=c-o*this._spacingX,h=0,_=0,u=0,d=0,p=!1;const m=this._usefulLayoutObj.length;let f=this._cellSize.width;const g=this._getPaddingH();this._layoutType!==pX.GRID&&this._resizeMode===mX.CHILDREN&&(f=(t-g-(m-1)*this._spacingX)/m);const v=this._usefulLayoutObj;for(let a=0;a<v.length;++a){const m=v[a],y=m.node,x=y.scale,S=this._getUsedScaleValue(x.x),T=this._getUsedScaleValue(x.y);this._resizeMode===mX.CHILDREN&&(m.width=f/S,this._layoutType===pX.GRID&&(m.height=this._cellSize.height/T));const E=Math.abs(this._horizontalDirection-m.anchorX),C=m.width*S,A=m.height*T;A>u&&(d=Math.max(u,d),_=u||A,u=A),l+=o*(E*C+this._spacingX);const b=o*(1-E)*C;if(e){if(r>0)p=a/r>0&&a%r==0,p&&(_=u>A?u:_);else if(C>t-g)l>c+o*E*C&&(p=!0);else{const e=(1-this._horizontalDirection-s.x)*t,n=l+b+o*(o>0?this._paddingRight:this._paddingLeft);p=Math.abs(n)>Math.abs(e)}p&&(l=c+o*E*C,A!==u&&(_=u),h+=_+this._spacingY,_=u=A)}const w=n(y,m,h);i&&y.setPosition(l,w),l+=b}return _=Math.max(_,u),Math.max(d,h+_)+this._getPaddingV()}_doLayoutVertically(t,e,n,i){const s=this.node._uiProps.uiTransformComp.anchorPoint,r=this._getFixedColumn();let o=1,a=this._paddingBottom;this._verticalDirection===gX.TOP_TO_BOTTOM&&(o=-1,a=this._paddingTop);const c=(this._verticalDirection-s.y)*t+o*a;let l=c-o*this._spacingY,h=0,_=0,u=0,d=0,p=!1;const m=this._usefulLayoutObj.length;let f=this._cellSize.height;const g=this._getPaddingV();this._layoutType!==pX.GRID&&this._resizeMode===mX.CHILDREN&&(f=(t-g-(m-1)*this._spacingY)/m);const v=this._usefulLayoutObj;for(let a=0;a<v.length;++a){const m=v[a],y=m.node,x=y.scale,S=this._getUsedScaleValue(x.x),T=this._getUsedScaleValue(x.y);this._resizeMode===mX.CHILDREN&&(m.height=f/T,this._layoutType===pX.GRID&&(m.width=this._cellSize.width/S));const E=Math.abs(this._verticalDirection-m.anchorY),C=m.width*S,A=m.height*T;C>h&&(_=Math.max(h,_),u=h||C,h=C),l+=o*(E*A+this._spacingY);const b=o*(1-E)*A;if(e){if(r>0)p=a/r>0&&a%r==0,p&&(u=h>A?h:u);else if(A>t-g)l>c+o*E*A&&(p=!0);else{const e=(1-this._verticalDirection-s.y)*t,n=l+b+o*(o>0?this._paddingTop:this._paddingBottom);p=Math.abs(n)>Math.abs(e)}p&&(l=c+o*E*A,C!==h&&(u=h),d+=u+this._spacingX,u=h=C)}const w=n(y,m,d);i&&(y.getPosition(xX),y.setPosition(w,l,xX.z)),l+=b}return u=Math.max(u,h),Math.max(_,d+u)+this._getPaddingH()}_doLayoutGridAxisHorizontal(t,e){const n=e.width;let i=1,s=-t.y*e.height,r=this._paddingBottom;this._verticalDirection===gX.TOP_TO_BOTTOM&&(i=-1,s=(1-t.y)*e.height,r=this._paddingTop);const o=(t,e,n)=>s+i*(n+(1-e.anchorY)*e.height*this._getUsedScaleValue(t.scale.y)+r);let a=0;this._resizeMode===mX.CONTAINER&&(a=this._doLayoutHorizontally(n,!0,o,!1),s=-t.y*a,this._verticalDirection===gX.TOP_TO_BOTTOM&&(i=-1,s=(1-t.y)*a)),this._doLayoutHorizontally(n,!0,o,!0),this._resizeMode===mX.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(n,a)}_doLayoutGridAxisVertical(t,e){const n=e.height;let i=1,s=-t.x*e.width,r=this._paddingLeft;this._horizontalDirection===vX.RIGHT_TO_LEFT&&(i=-1,s=(1-t.x)*e.width,r=this._paddingRight);const o=(t,e,n)=>s+i*(n+(1-e.anchorX)*e.width*this._getUsedScaleValue(t.scale.x)+r);let a=0;this._resizeMode===mX.CONTAINER&&(a=this._doLayoutVertically(n,!0,o,!1),s=-t.x*a,this._horizontalDirection===vX.RIGHT_TO_LEFT&&(i=-1,s=(1-t.x)*a)),this._doLayoutVertically(n,!0,o,!0),this._resizeMode===mX.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(a,n)}_doLayoutGrid(){const t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,n=t.contentSize;this.startAxis===fX.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,n):this.startAxis===fX.VERTICAL&&this._doLayoutGridAxisVertical(e,n)}_getHorizontalBaseWidth(t=!0){const e=this._usefulLayoutObj;let n=0;const i=e.length;if(this._resizeMode===mX.CONTAINER){for(let t=0;t<e.length;++t){const i=e[t],s=i.node.scale;n+=i.width*this._getUsedScaleValue(s.x)}n+=(i-1)*this._spacingX+this._getPaddingH()}else n=this.node._uiProps.uiTransformComp.width;return n}_getVerticalBaseHeight(){const t=this._usefulLayoutObj;let e=0;const n=t.length;if(this._resizeMode===mX.CONTAINER){for(let n=0;n<t.length;++n){const i=t[n],s=i.node.scale;e+=i.height*this._getUsedScaleValue(s.y)}e+=(n-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e}_doLayout(){if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===pX.HORIZONTAL){const t=this._getHorizontalBaseWidth(),e=t=>(this._isAlign?ln.ZERO:t.position).y;this._doLayoutHorizontally(t,!1,e,!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===pX.VERTICAL){const t=this._getVerticalBaseHeight(),e=t=>(this._isAlign?ln.ZERO:t.position).x;this._doLayoutVertically(t,!1,e,!0),this.node._uiProps.uiTransformComp.height=t}else this._layoutType===pX.GRID&&this._doLayoutGrid()}_getUsedScaleValue(t){return this._affectedByScale?Math.abs(t):1}_transformDirty(t){t&Ol.SCALE&&t&Ol.POSITION&&this._affectedByScale&&this._doLayoutDirty()}_doLayoutDirty(){this._layoutDirty=!0}_childrenChanged(){this._childrenDirty=!0,this._doLayoutDirty()}_getPaddingH(){return this._paddingLeft+this._paddingRight}_getPaddingV(){return this._paddingTop+this._paddingBottom}_getFixedColumn(){if(this._layoutType!==pX.GRID||this._constraint===yX.NONE||this._constraintNum<=0)return 0;let t=this._constraint===yX.FIXED_ROW?Math.round(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===fX.VERTICAL&&(t=this._constraint===yX.FIXED_COL?Math.round(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t}},_X.Type=pX,_X.VerticalDirection=gX,_X.HorizontalDirection=vX,_X.ResizeMode=mX,_X.AxisDirection=fX,_X.Constraint=yX,Gl((Yq=uX).prototype,"alignHorizontal",[vq,yq],Object.getOwnPropertyDescriptor(Yq.prototype,"alignHorizontal"),Yq.prototype),Gl(Yq.prototype,"alignVertical",[xq,Sq],Object.getOwnPropertyDescriptor(Yq.prototype,"alignVertical"),Yq.prototype),Gl(Yq.prototype,"type",[Tq,Eq],Object.getOwnPropertyDescriptor(Yq.prototype,"type"),Yq.prototype),Gl(Yq.prototype,"resizeMode",[Cq,Aq,bq],Object.getOwnPropertyDescriptor(Yq.prototype,"resizeMode"),Yq.prototype),Gl(Yq.prototype,"cellSize",[wq,Rq],Object.getOwnPropertyDescriptor(Yq.prototype,"cellSize"),Yq.prototype),Gl(Yq.prototype,"startAxis",[Iq,Pq],Object.getOwnPropertyDescriptor(Yq.prototype,"startAxis"),Yq.prototype),Gl(Yq.prototype,"paddingLeft",[Oq],Object.getOwnPropertyDescriptor(Yq.prototype,"paddingLeft"),Yq.prototype),Gl(Yq.prototype,"paddingRight",[Dq],Object.getOwnPropertyDescriptor(Yq.prototype,"paddingRight"),Yq.prototype),Gl(Yq.prototype,"paddingTop",[Mq],Object.getOwnPropertyDescriptor(Yq.prototype,"paddingTop"),Yq.prototype),Gl(Yq.prototype,"paddingBottom",[Nq],Object.getOwnPropertyDescriptor(Yq.prototype,"paddingBottom"),Yq.prototype),Gl(Yq.prototype,"spacingX",[Lq],Object.getOwnPropertyDescriptor(Yq.prototype,"spacingX"),Yq.prototype),Gl(Yq.prototype,"spacingY",[zq],Object.getOwnPropertyDescriptor(Yq.prototype,"spacingY"),Yq.prototype),Gl(Yq.prototype,"verticalDirection",[Bq,Fq],Object.getOwnPropertyDescriptor(Yq.prototype,"verticalDirection"),Yq.prototype),Gl(Yq.prototype,"horizontalDirection",[Uq,Gq],Object.getOwnPropertyDescriptor(Yq.prototype,"horizontalDirection"),Yq.prototype),Gl(Yq.prototype,"constraint",[Hq,Vq,kq],Object.getOwnPropertyDescriptor(Yq.prototype,"constraint"),Yq.prototype),Gl(Yq.prototype,"constraintNum",[jq,Wq],Object.getOwnPropertyDescriptor(Yq.prototype,"constraintNum"),Yq.prototype),Gl(Yq.prototype,"affectedByScale",[qq],Object.getOwnPropertyDescriptor(Yq.prototype,"affectedByScale"),Yq.prototype),Kq=Gl(Yq.prototype,"_resizeMode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mX.NONE}}),$q=Gl(Yq.prototype,"_layoutType",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pX.NONE}}),Zq=Gl(Yq.prototype,"_cellSize",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On(40,40)}}),Jq=Gl(Yq.prototype,"_startAxis",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fX.HORIZONTAL}}),Qq=Gl(Yq.prototype,"_paddingLeft",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tX=Gl(Yq.prototype,"_paddingRight",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eX=Gl(Yq.prototype,"_paddingTop",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nX=Gl(Yq.prototype,"_paddingBottom",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),iX=Gl(Yq.prototype,"_spacingX",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sX=Gl(Yq.prototype,"_spacingY",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),rX=Gl(Yq.prototype,"_verticalDirection",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gX.TOP_TO_BOTTOM}}),oX=Gl(Yq.prototype,"_horizontalDirection",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vX.LEFT_TO_RIGHT}}),aX=Gl(Yq.prototype,"_constraint",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yX.NONE}}),cX=Gl(Yq.prototype,"_constraintNum",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),lX=Gl(Yq.prototype,"_affectedByScale",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hX=Gl(Yq.prototype,"_isAlign",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Xq=Yq))||Xq)||Xq)||Xq)||Xq)||Xq)||Xq));var TX,EX,CX,AX,bX,wX,RX,IX,PX,OX,DX,MX,NX,LX,zX,BX,FX,UX,GX,HX,VX,kX,jX,WX,qX,XX,YX,KX,$X,ZX,JX,QX,tY,eY,nY,iY,sY,rY,oY,aY,cY,lY,hY,_Y,uY,dY,pY;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.FILLED=2]="FILLED"}(jX||(jX={})),jt(jX),t("ProgressBar",(TX=Yl("cc.ProgressBar"),EX=ah(),CX=$l(110),AX=ih(),bX=Kl(hL),wX=Ah(IU),RX=_h(),IX=Ah(jX),PX=_h(),OX=_h(),DX=uh(),MX=_h(),NX=_h(),TX(LX=EX(LX=CX(LX=AX(LX=bX((kX=VX=class extends Nu{constructor(...t){super(...t),Ul(this,"_barSprite",BX,this),Ul(this,"_mode",FX,this),Ul(this,"_totalLength",UX,this),Ul(this,"_progress",GX,this),Ul(this,"_reverse",HX,this)}get barSprite(){return this._barSprite}set barSprite(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}get mode(){return this._mode}set mode(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp.contentSize;this._mode===jX.HORIZONTAL?this.totalLength=e.width:this._mode===jX.VERTICAL?this.totalLength=e.height:this._mode===jX.FILLED&&(this.totalLength=this._barSprite.fillRange)}}get totalLength(){return this._totalLength}set totalLength(t){this._mode===jX.FILLED&&(t=Ve(t)),this._totalLength=t,this._updateBarStatus()}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}get reverse(){return this._reverse}set reverse(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}_initBarSprite(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=this.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint,s=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===IU.FillType.RADIAL&&(this._mode=jX.FILLED),this._mode===jX.HORIZONTAL?this.totalLength=s.width:this._mode===jX.VERTICAL?this.totalLength=s.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){const e=-n.width*i.x;t.setPosition(e,0,0)}}}_updateBarStatus(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp,n=e.anchorPoint,i=e.contentSize,s=t.getPosition();let r=new rn(0,.5);const o=Ve(this._progress);let a=this._totalLength*o,c=i,l=0,h=0;switch(this._mode){case jX.HORIZONTAL:this._reverse&&(r=new rn(1,.5)),c=new On(a,i.height),l=this._totalLength,h=i.height;break;case jX.VERTICAL:r=this._reverse?new rn(.5,1):new rn(.5,0),c=new On(i.width,a),l=i.width,h=this._totalLength}if(this._mode===jX.FILLED)this._barSprite.type!==IU.Type.FILLED?_("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(a*=-1),this._barSprite.fillRange=a);else if(this._barSprite.type!==IU.Type.FILLED){const i=r.x-n.x,o=r.y-n.y,a=new ln(l*i,h*o,0);t.setPosition(s.x+a.x,s.y+a.y,s.z),e.setAnchorPoint(r),e.setContentSize(c)}else _("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},VX.Mode=jX,Gl((zX=kX).prototype,"barSprite",[wX,RX],Object.getOwnPropertyDescriptor(zX.prototype,"barSprite"),zX.prototype),Gl(zX.prototype,"mode",[IX,PX],Object.getOwnPropertyDescriptor(zX.prototype,"mode"),zX.prototype),Gl(zX.prototype,"totalLength",[OX],Object.getOwnPropertyDescriptor(zX.prototype,"totalLength"),zX.prototype),Gl(zX.prototype,"progress",[DX,fh,MX],Object.getOwnPropertyDescriptor(zX.prototype,"progress"),zX.prototype),Gl(zX.prototype,"reverse",[NX],Object.getOwnPropertyDescriptor(zX.prototype,"reverse"),zX.prototype),BX=Gl(zX.prototype,"_barSprite",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FX=Gl(zX.prototype,"_mode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jX.HORIZONTAL}}),UX=Gl(zX.prototype,"_totalLength",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),GX=Gl(zX.prototype,"_progress",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),HX=Gl(zX.prototype,"_reverse",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LX=zX))||LX)||LX)||LX)||LX)||LX));const mY=new ln,fY=new ln,gY=new ln,vY=new rn,yY=new Ln;var xY;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(xY||(xY={})),Xt(xY);let SY=t("ScrollBar",(WX=Yl("cc.ScrollBar"),qX=ah(),XX=$l(110),YX=ih(),KX=Kl(hL),$X=Ah(IU),ZX=gh(),JX=_h(),QX=Ah(xY),tY=gh(),eY=_h(),nY=gh(),iY=_h(),sY=gh(),rY=_h(),WX(oY=qX(oY=XX(oY=YX(oY=KX((pY=dY=class extends Nu{constructor(...t){super(...t),Ul(this,"_scrollView",cY,this),Ul(this,"_handle",lY,this),Ul(this,"_direction",hY,this),Ul(this,"_enableAutoHide",_Y,this),Ul(this,"_autoHideTime",uY,this),this._touching=!1,this._opacity=255,this._autoHideRemainingTime=0}get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t,this.onScroll(mY))}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this.onScroll(new ln))}get enableAutoHide(){return this._enableAutoHide}set enableAutoHide(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}get autoHideTime(){return this._autoHideTime}set autoHideTime(t){this._autoHideTime!==t&&(this._autoHideTime=t)}hide(){this._autoHideRemainingTime=0,this._setOpacity(0)}show(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}onScroll(t){if(!this._scrollView)return;const e=this._scrollView.content;if(!e)return;const n=e._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,s=this.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(n,i))return;this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));let r=0,o=0,a=0,c=0,l=0;this._direction===xY.HORIZONTAL?(r=n.width,o=i.width,l=s.width,a=t.x,c=-this._convertToScrollViewSpace(e).x):this._direction===xY.VERTICAL&&(r=n.height,o=i.height,l=s.height,a=t.y,c=-this._convertToScrollViewSpace(e).y);const h=this._calculateLength(r,o,l,a),_=this._calculatePosition(r,o,l,c,a,h);this._updateLength(h),this._updateHandlerPosition(_)}setScrollView(t){this._scrollView=t}onTouchBegan(){this._enableAutoHide&&(this._touching=!0)}onTouchEnded(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){const t=this._scrollView.content;if(t){const e=t._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,n))return}}this._autoHideRemainingTime=this._autoHideTime}}onEnable(){const t=this.node.getComponent(IU);t&&(this._opacity=t.color.a)}start(){this._enableAutoHide&&this._setOpacity(0)}update(t){this._processAutoHide(t)}_convertToScrollViewSpace(t){const e=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,n=t._uiProps.uiTransformComp;if(!e||!n)return mY;fY.set(-n.anchorX*n.width,-n.anchorY*n.height,0),n.convertToWorldSpaceAR(fY,gY);const i=e.convertToNodeSpaceAR(gY);return i.x+=e.anchorX*e.width,i.y+=e.anchorY*e.height,i}_setOpacity(t){if(this._handle){let e=this.node.getComponent(IU);e&&(yY.set(e.color),yY.a=t,e.color=yY),e=this._handle.getComponent(IU),e&&(yY.set(e.color),yY.a=t,e.color=yY)}}_updateHandlerPosition(t){if(this._handle){const e=this._fixupHandlerPosition();this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}}_fixupHandlerPosition(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize,n=t.anchorPoint,i=this.handle.node._uiProps.uiTransformComp.contentSize,s=this.handle.node.parent;ln.set(fY,-e.width*n.x,-e.height*n.y,0);const r=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(fY,gY);let o=new ln;return s._uiProps.uiTransformComp.convertToNodeSpaceAR(r,o),this.direction===xY.HORIZONTAL?o=new ln(o.x,o.y+(e.height-i.height)/2,0):this.direction===xY.VERTICAL&&(o=new ln(o.x+(e.width-i.width)/2,o.y,0)),this.handle.node.setPosition(o),o}_conditionalDisableScrollBar(t,e){return t.width<=e.width&&this._direction===xY.HORIZONTAL||t.height<=e.height&&this._direction===xY.VERTICAL}_calculateLength(t,e,n,i){let s=t;return i&&(s+=20*(i>0?i:-i)),n*(e/s)}_calculatePosition(t,e,n,i,s,r){let o=t-e;s&&(o+=Math.abs(s));let a=0;o&&(a=i/o,a=Ve(a));const c=(n-r)*a;return this._direction===xY.VERTICAL?new ln(0,c,0):new ln(c,0,0)}_updateLength(t){if(this._handle){const e=this._handle.node._uiProps.uiTransformComp,n=e.contentSize,i=e.anchorPoint;i.x===vY.x&&i.y===vY.y||e.setAnchorPoint(vY),this._direction===xY.HORIZONTAL?e.setContentSize(t,n.height):e.setContentSize(n.width,t)}}_processAutoHide(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);const t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},dY.Direction=xY,Gl((aY=pY).prototype,"handle",[$X,ZX,JX],Object.getOwnPropertyDescriptor(aY.prototype,"handle"),aY.prototype),Gl(aY.prototype,"direction",[QX,tY,eY],Object.getOwnPropertyDescriptor(aY.prototype,"direction"),aY.prototype),Gl(aY.prototype,"enableAutoHide",[nY,iY],Object.getOwnPropertyDescriptor(aY.prototype,"enableAutoHide"),aY.prototype),Gl(aY.prototype,"autoHideTime",[sY,rY],Object.getOwnPropertyDescriptor(aY.prototype,"autoHideTime"),aY.prototype),cY=Gl(aY.prototype,"_scrollView",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lY=Gl(aY.prototype,"_handle",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),hY=Gl(aY.prototype,"_direction",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xY.HORIZONTAL}}),_Y=Gl(aY.prototype,"_enableAutoHide",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),uY=Gl(aY.prototype,"_autoHideTime",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oY=aY))||oY)||oY)||oY)||oY)||oY));var TY;let EY=t("ViewGroup",Yl("cc.ViewGroup")(TY=$l(110)(TY=class extends Nu{})||TY)||TY);var CY,AY,bY,wY,RY,IY,PY,OY,DY,MY,NY,LY,zY,BY,FY,UY,GY,HY,VY,kY,jY,WY,qY,XY,YY,KY,$Y,ZY,JY,QY,tK,eK,nK,iK,sK,rK,oK,aK,cK,lK,hK,_K,uK,dK,pK,mK,fK,gK;i.ViewGroup=EY;const vK=new ln,yK=new ln,xK=new ln,SK=new rn,TK=new rn,EK=()=>(new Date).getMilliseconds(),CK={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};let AK;!function(t){t.SCROLL_TO_TOP="scroll-to-top",t.SCROLL_TO_BOTTOM="scroll-to-bottom",t.SCROLL_TO_LEFT="scroll-to-left",t.SCROLL_TO_RIGHT="scroll-to-right",t.SCROLL_BEGAN="scroll-began",t.SCROLL_ENDED="scroll-ended",t.BOUNCE_TOP="bounce-top",t.BOUNCE_BOTTOM="bounce-bottom",t.BOUNCE_LEFT="bounce-left",t.BOUNCE_RIGHT="bounce-right",t.SCROLLING="scrolling",t.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",t.TOUCH_UP="touch-up"}(AK||(AK={}));let bK=t("ScrollView",(CY=Yl("cc.ScrollView"),AY=ah(),bY=$l(110),wY=ih(),RY=Kl(hL),IY=uh(),PY=gh(),OY=_h(),DY=uh(),MY=gh(),NY=_h(),LY=gh(),zY=_h(),BY=gh(),FY=_h(),UY=Ah(sx),GY=gh(),HY=_h(),VY=gh(),kY=_h(),jY=Ah(SY),WY=gh(),qY=_h(),XY=gh(),YY=_h(),KY=Ah(SY),$Y=gh(),ZY=_h(),JY=gh(),QY=_h(),tK=Ah([pC]),eK=gh(),nK=_h(),CY(iK=AY(iK=bY(iK=wY(iK=RY((gK=fK=class extends EY{constructor(...t){super(...t),Ul(this,"bounceDuration",rK,this),Ul(this,"brake",oK,this),Ul(this,"elastic",aK,this),Ul(this,"inertia",cK,this),Ul(this,"horizontal",lK,this),Ul(this,"vertical",hK,this),Ul(this,"cancelInnerEvents",_K,this),Ul(this,"scrollEvents",uK,this),this._autoScrolling=!1,this._scrolling=!1,Ul(this,"_content",dK,this),Ul(this,"_horizontalScrollBar",pK,this),Ul(this,"_verticalScrollBar",mK,this),this._topBoundary=0,this._bottomBoundary=0,this._leftBoundary=0,this._rightBoundary=0,this._touchMoveDisplacements=[],this._touchMoveTimeDeltas=[],this._touchMovePreviousTimestamp=0,this._touchMoved=!1,this._autoScrollAttenuate=!1,this._autoScrollStartPosition=new ln,this._autoScrollTargetDelta=new ln,this._autoScrollTotalTime=0,this._autoScrollAccumulatedTime=0,this._autoScrollCurrentlyOutOfBoundary=!1,this._autoScrollBraking=!1,this._autoScrollBrakingStartPosition=new ln,this._outOfBoundaryAmount=new ln,this._outOfBoundaryAmountDirty=!0,this._stopMouseWheel=!1,this._mouseWheelEventElapsedTime=0,this._isScrollEndedWithThresholdEventFired=!1,this._scrollEventEmitMask=0,this._isBouncing=!1,this._contentPos=new ln,this._deltaPos=new ln}get content(){return this._content}set content(t){if(this._content===t)return;const e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):v(4302)}get horizontalScrollBar(){return this._horizontalScrollBar}set horizontalScrollBar(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(vK)))}get verticalScrollBar(){return this._verticalScrollBar}set verticalScrollBar(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(vK)))}get view(){const t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}scrollToBottom(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new rn(0,0),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n,!0)}scrollToTop(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new rn(0,1),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToLeft(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new rn(0,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToRight(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new rn(1,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToTopLeft(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new rn(0,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToTopRight(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new rn(1,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToBottomLeft(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new rn(0,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToBottomRight(t,e=!0){const n=this._calculateMovePercentDelta({anchor:new rn(1,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(n,t,!1!==e):this._moveContent(n)}scrollToOffset(t,e,n=!0){const i=this.getMaxScrollOffset(),s=new rn(0,0);0===i.x?s.x=0:s.x=t.x/i.x,0===i.y?s.y=1:s.y=(i.y-t.y)/i.y,this.scrollTo(s,e,n)}getScrollOffset(){const t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new ln(e,t,0)}getMaxScrollOffset(){if(!this._content||!this.view)return vK;const t=this._content._uiProps.uiTransformComp.contentSize;let e=t.width-this.view.width,n=t.height-this.view.height;return e=e>=0?e:0,n=n>=0?n:0,new ln(e,n,0)}scrollToPercentHorizontal(t,e,n){const i=this._calculateMovePercentDelta({anchor:new rn(t,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(i,e,!1!==n):this._moveContent(i)}scrollTo(t,e,n){const i=this._calculateMovePercentDelta({anchor:new rn(t),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)}scrollToPercentVertical(t,e,n){const i=this._calculateMovePercentDelta({anchor:new rn(0,t),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(i,e,n):this._moveContent(i)}stopAutoScroll(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}setContentPosition(t){if(!this._content)return;const e=this.getContentPosition();Math.abs(t.x-e.x)<1e-4&&Math.abs(t.y-e.y)<1e-4||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}getContentPosition(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):vK}isScrolling(){return this._scrolling}isAutoScrolling(){return this._autoScrolling}getScrollEndedEventTiming(){return 1e-4}start(){this._calculateBoundary(),this._content&&rE.once(sE.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}onEnable(){this._registerEvent(),this._content&&(this._content.on(sx.EventType.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(sx.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(sx.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(sx.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()}update(t){this._autoScrolling&&this._processAutoScrolling(t)}onDisable(){this._unregisterEvent(),this._content&&(this._content.off(sx.EventType.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(sx.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(sx.EventType.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(sx.EventType.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}_registerEvent(){this.node.on(sx.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(sx.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(sx.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(sx.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(sx.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_unregisterEvent(){this.node.off(sx.EventType.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(sx.EventType.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(sx.EventType.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(sx.EventType.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(sx.EventType.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_onMouseWheel(t,e){if(!this.enabledInHierarchy)return;if(this._hasNestedViewGroup(t,e))return;const n=new ln,i=t.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(t)}_onTouchBegan(t,e){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(t,e)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(t)))}_onTouchMoved(t,e){if(!this.enabledInHierarchy||!this._content)return;if(this._hasNestedViewGroup(t,e))return;const n=t.touch;if(this._handleMoveLogic(n),!this.cancelInnerEvents)return;const i=n.getUILocation(SK);if(i.subtract(n.getUIStartLocation(TK)),i.length()>7&&!this._touchMoved&&t.target!==this.node){const e=new Fm(t.getTouches(),t.bubbles);e.type=sx.EventType.TOUCH_CANCEL,e.touch=t.touch,e.simulate=!0,t.target.dispatchEvent(e),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(t)}_onTouchEnded(t,e){if(!this.enabledInHierarchy||!this._content||!t)return;if(this._hasNestedViewGroup(t,e))return;this._dispatchEvent(AK.TOUCH_UP);const n=t.touch;this._handleReleaseLogic(n),this._touchMoved?t.propagationStopped=!0:this._stopPropagationIfTargetIsMe(t)}_onTouchCancelled(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){if(t&&!t.simulate){const e=t.touch;this._handleReleaseLogic(e)}this._stopPropagationIfTargetIsMe(t)}}_calculateBoundary(){if(this._content&&this.view){const t=this._content.getComponent(SX);t&&t.enabledInHierarchy&&t.updateLayout();const e=this.view,n=e.width*e.anchorX,i=e.height*e.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize)}}_hasNestedViewGroup(t,e){if(t&&t.eventPhase===Zh.CAPTURING_PHASE){if(e)for(const n of e){const e=n;if(this.node===e)return!(!t.target||!t.target.getComponent(EY));if(e.getComponent(EY))return!0}return!1}}_startInertiaScroll(t){const e=new ln(t);e.multiplyScalar(.7),this._startAttenuatingAutoScroll(e,t)}_calculateAttenuatedFactor(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))}_startAttenuatingAutoScroll(t,e){const n=new ln(t);if(n.normalize(),this._content&&this.view){const t=this._content._uiProps.uiTransformComp.contentSize,e=this.view.contentSize,i=t.width-e.width,s=t.height-e.height,r=this._calculateAttenuatedFactor(i),o=this._calculateAttenuatedFactor(s);n.x=n.x*i*(1-this.brake)*r,n.y=n.y*s*o*(1-this.brake),n.z=0}const i=t.length();let s=n.length()/i;if(n.add(t),this.brake>0&&s>7){s=Math.sqrt(s);const e=new ln(t);e.multiplyScalar(s),n.set(e),n.add(t)}let r=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&s>3&&(s=3,r*=s),0===this.brake&&s>1&&(r*=s),this._startAutoScroll(n,r,!0)}_calculateAutoScrollTimeByInitialSpeed(t){return Math.sqrt(Math.sqrt(t/5))}_startAutoScroll(t,e,n=!1){const i=this._flattenVectorByDirection(t);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,ln.copy(this._autoScrollStartPosition,this.getContentPosition()),this._autoScrollTotalTime=e,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition=new ln,this._getHowMuchOutOfBoundary().equals(vK,1e-4)||(this._autoScrollCurrentlyOutOfBoundary=!0)}_calculateTouchMoveVelocity(){let t=0;if(t=this._touchMoveTimeDeltas.reduce((t,e)=>t+e,t),t<=0||t>=.5)return new ln;let e=new ln;return e=this._touchMoveDisplacements.reduce((t,e)=>(t.add(e),t),e),new ln(e.x*(1-this.brake)/t,e.y*(1-this.brake)/t,0)}_flattenVectorByDirection(t){const e=t;return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e}_moveContent(t,e){const n=this._flattenVectorByDirection(t);yK.set(this.getContentPosition()),yK.add(n),yK.set(1e-4*Math.floor(1e4*yK.x),1e-4*Math.floor(1e4*yK.y),yK.z),this.setContentPosition(yK);const i=this._getHowMuchOutOfBoundary();this._updateScrollBar(i),this.elastic&&e&&this._startBounceBackIfNeeded()}_getContentLeftBoundary(){if(!this._content)return-1;const t=this.getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width}_getContentRightBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width}_getContentTopBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height}_getContentBottomBoundary(){if(!this._content)return-1;const t=this.getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height}_getHowMuchOutOfBoundary(t){if((t=t||new ln).equals(vK,1e-4)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;let e=new ln;return this._getContentLeftBoundary()+t.x>this._leftBoundary?e.x=this._leftBoundary-(this._getContentLeftBoundary()+t.x):this._getContentRightBoundary()+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(this._getContentRightBoundary()+t.x)),this._getContentTopBoundary()+t.y<this._topBoundary?e.y=this._topBoundary-(this._getContentTopBoundary()+t.y):this._getContentBottomBoundary()+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(this._getContentBottomBoundary()+t.y)),t.equals(vK,1e-4)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),e=this._clampDelta(e),e}_updateScrollBar(t){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(t),this.verticalScrollBar&&this.verticalScrollBar.onScroll(t)}_onScrollBarTouchBegan(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}_onScrollBarTouchEnded(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}_dispatchEvent(t){if(t===AK.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(t===AK.SCROLL_TO_TOP||t===AK.SCROLL_TO_BOTTOM||t===AK.SCROLL_TO_LEFT||t===AK.SCROLL_TO_RIGHT){const e=1<<CK[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}pC.emitEvents(this.scrollEvents,this,CK[t]),this.node.emit(t,this)}_adjustContentOutOfBoundary(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){const t=this._getHowMuchOutOfBoundary();yK.set(this.getContentPosition()),yK.add(t),this._content.setPosition(yK),this._updateScrollBar(vK)}}_hideScrollBar(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()}_updateScrollBarState(){if(!this._content||!this.view)return;const t=this.view,e=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(e.height<t.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(e.width<t.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}_stopPropagationIfTargetIsMe(t){t.eventPhase===Zh.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)}_processDeltaMove(t){this._scrollChildren(t),this._gatherTouchMove(t)}_handleMoveLogic(t){this._deltaPos.set(this._getLocalAxisAlignDelta(t)),this._processDeltaMove(this._deltaPos)}_handleReleaseLogic(t){this._deltaPos.set(this._getLocalAxisAlignDelta(t)),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(AK.SCROLL_ENDED))}_getLocalAxisAlignDelta(t){const e=this.node._uiProps.uiTransformComp,n=new ln;return e&&(t.getUILocation(SK),t.getUIPreviousLocation(TK),yK.set(SK.x,SK.y,0),xK.set(TK.x,TK.y,0),e.convertToNodeSpaceAR(yK,yK),e.convertToNodeSpaceAR(xK,xK),ln.subtract(n,yK,xK)),n}_scrollChildren(t){const e=t=this._clampDelta(t);let n,i;if(this.elastic&&(n=this._getHowMuchOutOfBoundary(),e.x*=0===n.x?1:.5,e.y*=0===n.y?1:.5),this.elastic||(n=this._getHowMuchOutOfBoundary(e),e.add(n)),this._content){const{anchorX:t,anchorY:n,width:s,height:r}=this._content._uiProps.uiTransformComp,o=this._content.position||vK;e.y>0?o.y-n*r+e.y>=this._bottomBoundary&&(i=AK.SCROLL_TO_BOTTOM):e.y<0&&o.y-n*r+r+e.y<=this._topBoundary&&(i=AK.SCROLL_TO_TOP),e.x<0?o.x-t*s+s+e.x<=this._rightBoundary&&(i=AK.SCROLL_TO_RIGHT):e.x>0&&o.x-t*s+e.x>=this._leftBoundary&&(i=AK.SCROLL_TO_LEFT)}this._moveContent(e,!1),0===e.x&&0===e.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent(AK.SCROLL_BEGAN)),this._dispatchEvent(AK.SCROLLING)),i&&i.length>0&&this._dispatchEvent(i)}_handlePressLogic(){this._autoScrolling&&this._dispatchEvent(AK.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=EK(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}_clampDelta(t){if(this._content&&this.view){const e=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<e.width&&(t.x=0),n.height<e.height&&(t.y=0)}return t}_gatherTouchMove(t){const e=t.clone();for(this._clampDelta(e);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);const n=EK();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n}_startBounceBackIfNeeded(){if(!this.elastic)return!1;let t=this._getHowMuchOutOfBoundary();if(t=this._clampDelta(t),t.equals(vK,1e-4))return!1;const e=Math.max(this.bounceDuration,0);return this._startAutoScroll(t,e,!0),this._isBouncing||(t.y>0&&this._dispatchEvent(AK.BOUNCE_TOP),t.y<0&&this._dispatchEvent(AK.BOUNCE_BOTTOM),t.x>0&&this._dispatchEvent(AK.BOUNCE_RIGHT),t.x<0&&this._dispatchEvent(AK.BOUNCE_LEFT),this._isBouncing=!0),!0}_processInertiaScroll(){if(!this._startBounceBackIfNeeded()&&this.inertia){const t=this._calculateTouchMoveVelocity();!t.equals(yK,1e-4)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()}_isOutOfBoundary(){return!this._getHowMuchOutOfBoundary().equals(vK,1e-4)}_isNecessaryAutoScrollBrake(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this.getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}_processAutoScrolling(t){const e=this._isNecessaryAutoScrollBrake(),n=e?.05:1;this._autoScrollAccumulatedTime+=t*(1/n);let i=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);var s;this._autoScrollAttenuate&&(s=i,i=(s-=1)*s*s*s*s+1);const r=new ln(this._autoScrollTargetDelta);r.multiplyScalar(i);const o=new ln(this._autoScrollStartPosition);o.add(r);let a=Math.abs(i-1)<=1e-4;if(Math.abs(i-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(AK.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){const t=new ln(o);t.subtract(this._autoScrollBrakingStartPosition),e&&t.multiplyScalar(n),o.set(this._autoScrollBrakingStartPosition),o.add(t)}else{const t=new ln(o);t.subtract(this.getContentPosition());const e=this._getHowMuchOutOfBoundary(t);e.equals(vK,1e-4)||(o.add(e),a=!0)}a&&(this._autoScrolling=!1);const c=new ln(o);c.subtract(this.getContentPosition()),this._moveContent(this._clampDelta(c),a),this._dispatchEvent(AK.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(AK.SCROLL_ENDED))}_checkMouseWheel(t){if(!this._getHowMuchOutOfBoundary().equals(vK,1e-4))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(AK.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=t,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(AK.SCROLL_ENDED),this._stopMouseWheel=!1)}_calculateMovePercentDelta(t){const e=t.anchor,n=t.applyToHorizontal,i=t.applyToVertical;this._calculateBoundary(),e.clampf(new rn(0,0),new rn(1,1));let s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;let r=this._getContentLeftBoundary()-this._leftBoundary;r=-r;const o=new ln;if(this._content&&this.view){let t=0;const a=this._content._uiProps.uiTransformComp.contentSize,c=this.view.contentSize;n&&(t=a.width-c.width,o.x=r-t*e.x),i&&(t=a.height-c.height,o.y=s-t*e.y)}return o}_moveContentToTopLeft(t){let e=this._getContentBottomBoundary()-this._bottomBoundary;e=-e;const n=new ln;let i=0,s=this._getContentLeftBoundary()-this._leftBoundary;if(s=-s,this._content){const r=this._content._uiProps.uiTransformComp.contentSize;r.height<t.height&&(i=r.height-t.height,n.y=e-i),r.width<t.width&&(i=r.width-t.width,n.x=s)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()}_scaleChanged(t){t===Ol.SCALE&&this._calculateBoundary()}},fK.EventType=AK,rK=Gl((sK=gK).prototype,"bounceDuration",[Ql,IY,PY,OY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),oK=Gl(sK.prototype,"brake",[Ql,DY,MY,NY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),aK=Gl(sK.prototype,"elastic",[Ql,LY,zY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cK=Gl(sK.prototype,"inertia",[Ql,BY,FY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Gl(sK.prototype,"content",[UY,GY,HY],Object.getOwnPropertyDescriptor(sK.prototype,"content"),sK.prototype),lK=Gl(sK.prototype,"horizontal",[Ql,VY,kY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Gl(sK.prototype,"horizontalScrollBar",[jY,WY,qY],Object.getOwnPropertyDescriptor(sK.prototype,"horizontalScrollBar"),sK.prototype),hK=Gl(sK.prototype,"vertical",[Ql,XY,YY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Gl(sK.prototype,"verticalScrollBar",[KY,$Y,ZY],Object.getOwnPropertyDescriptor(sK.prototype,"verticalScrollBar"),sK.prototype),_K=Gl(sK.prototype,"cancelInnerEvents",[Ql,JY,QY],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),uK=Gl(sK.prototype,"scrollEvents",[tK,Ql,eK,nK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dK=Gl(sK.prototype,"_content",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pK=Gl(sK.prototype,"_horizontalScrollBar",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mK=Gl(sK.prototype,"_verticalScrollBar",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iK=sK))||iK)||iK)||iK)||iK)||iK));var wK,RK,IK,PK,OK,DK,MK,NK,LK,zK,BK,FK,UK,GK,HK,VK,kK,jK,WK,qK,XK;const YK=new ln;var KK,$K,ZK,JK,QK,t$,e$,n$,i$,s$,r$,o$,a$,c$,l$,h$,_$,u$,d$,p$,m$,f$,g$,v$,y$,x$,S$,T$,E$,C$,A$,b$,w$,R$,I$,P$,O$,D$,M$,N$,L$,z$,B$,F$,U$,G$,H$,V$,k$,j$,W$,q$,X$,Y$,K$,$$,Z$,J$,Q$,tZ,eZ,nZ,iZ,sZ,rZ,oZ,aZ,cZ,lZ,hZ,_Z;function uZ(...t){return Object.assign({},...t)}!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(KK||(KK={})),Xt(KK),t("Slider",(wK=Yl("cc.Slider"),RK=ah(),IK=$l(110),PK=ih(),OK=Kl(hL),DK=Ah(IU),MK=_h(),NK=Ah(KK),LK=_h(),zK=uh(),BK=_h(),FK=Ah([pC]),UK=_h(),wK(GK=RK(GK=IK(GK=PK(GK=OK((XK=qK=class extends Nu{constructor(...t){super(...t),Ul(this,"slideEvents",VK,this),Ul(this,"_handle",kK,this),Ul(this,"_direction",jK,this),Ul(this,"_progress",WK,this),this._offset=new ln,this._dragging=!1,this._touchHandle=!1,this._handleLocalPos=new ln,this._touchPos=new ln}get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._changeLayout())}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}__preload(){this._updateHandlePosition()}onEnable(){this._updateHandlePosition(),this.node.on(pf.TOUCH_START,this._onTouchBegan,this),this.node.on(pf.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(pf.TOUCH_END,this._onTouchEnded,this),this.node.on(pf.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(pf.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(pf.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(pf.TOUCH_END,this._onTouchEnded,this))}onDisable(){this.node.off(pf.TOUCH_START,this._onTouchBegan,this),this.node.off(pf.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(pf.TOUCH_END,this._onTouchEnded,this),this.node.off(pf.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(pf.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(pf.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(pf.TOUCH_END,this._onTouchEnded,this))}_onHandleDragStart(t){if(!t||!this._handle||!this._handle.node._uiProps.uiTransformComp)return;this._dragging=!0,this._touchHandle=!0;const e=t.touch.getUILocation();ln.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}_onTouchBegan(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchMoved(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchEnded(t){this._dragging=!1,this._touchHandle=!1,this._offset=new ln,t&&(t.propagationStopped=!0)}_onTouchCancelled(t){this._dragging=!1,t&&(t.propagationStopped=!0)}_handleSliderLogic(t){this._updateProgress(t),this._emitSlideEvent()}_emitSlideEvent(){pC.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}_updateProgress(t){if(!this._handle||!t)return;const e=t.getUILocation();ln.set(this._touchPos,e.x,e.y,0);const n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,YK);this.direction===KK.Horizontal?this.progress=Ve(.5+(i.x-this._offset.x)/n.width):this.progress=Ve(.5+(i.y-this._offset.y)/n.height)}_updateHandlePosition(){if(!this._handle)return;this._handleLocalPos.set(this._handle.node.getPosition());const t=this.node._uiProps.uiTransformComp;this._direction===KK.Horizontal?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}_changeLayout(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){const t=this._handle.node.position;this._direction===KK.Horizontal?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}},qK.Direction=KK,Gl((HK=XK).prototype,"handle",[DK,MK],Object.getOwnPropertyDescriptor(HK.prototype,"handle"),HK.prototype),Gl(HK.prototype,"direction",[NK,LK],Object.getOwnPropertyDescriptor(HK.prototype,"direction"),HK.prototype),Gl(HK.prototype,"progress",[fh,zK,BK],Object.getOwnPropertyDescriptor(HK.prototype,"progress"),HK.prototype),VK=Gl(HK.prototype,"slideEvents",[FK,Ql,UK],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kK=Gl(HK.prototype,"_handle",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jK=Gl(HK.prototype,"_direction",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KK.Horizontal}}),WK=Gl(HK.prototype,"_progress",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),GK=HK))||GK)||GK)||GK)||GK)||GK)),function(t){t.TOGGLE="toggle"}(m$||(m$={})),t("Toggle",($K=Yl("cc.Toggle"),ZK=ah(),JK=$l(110),QK=ih(),t$=Kl(hL),e$=gh(),n$=_h(),i$=Ah(IU),s$=gh(),r$=_h(),o$=Ah([pC]),a$=_h(),$K(c$=ZK(c$=JK(c$=QK(c$=t$((p$=d$=class t extends rW{constructor(...t){super(...t),Ul(this,"checkEvents",h$,this),Ul(this,"_isChecked",_$,this),Ul(this,"_checkMark",u$,this)}get isChecked(){return this._isChecked}set isChecked(t){this._set(t)}get checkMark(){return this._checkMark}set checkMark(t){this._checkMark!==t&&(this._checkMark=t)}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get _toggleContainer(){const t=this.node.parent;return i.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}_internalToggle(){this.isChecked=!this.isChecked}_set(t,e=!0){if(this._isChecked==t)return;this._isChecked=t;const n=this._toggleContainer;n&&n.enabled&&this.enabled&&(t||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}playEffect(){this._checkMark&&(this._checkMark.node.active=this._isChecked)}setIsCheckedWithoutNotify(t){this._set(t,!1)}onEnable(){super.onEnable(),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)}onDisable(){super.onDisable(),this.node.off(t.EventType.CLICK,this._internalToggle,this)}OnDestroy(){const t=this._toggleContainer;t&&t.ensureValidState()}_emitToggleEvents(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&pC.emitEvents(this.checkEvents,this)}},d$.EventType=uZ(m$,eW),Gl((l$=p$).prototype,"isChecked",[e$,n$],Object.getOwnPropertyDescriptor(l$.prototype,"isChecked"),l$.prototype),Gl(l$.prototype,"checkMark",[i$,s$,r$],Object.getOwnPropertyDescriptor(l$.prototype,"checkMark"),l$.prototype),h$=Gl(l$.prototype,"checkEvents",[o$,Ql,a$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_$=Gl(l$.prototype,"_isChecked",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),u$=Gl(l$.prototype,"_checkMark",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c$=l$))||c$)||c$)||c$)||c$)||c$)),t("ToggleContainer",(f$=Yl("cc.ToggleContainer"),g$=ah(),v$=$l(110),y$=ih(),x$=_h(),S$=Ah([pC]),T$=_h(),f$(E$=g$(E$=v$(E$=y$(E$=nh((A$=Gl((C$=class extends Nu{constructor(...t){super(...t),Ul(this,"_allowSwitchOff",A$,this),Ul(this,"checkEvents",b$,this)}get allowSwitchOff(){return this._allowSwitchOff}set allowSwitchOff(t){this._allowSwitchOff=t}get toggleItems(){return this.node.children.map(t=>{const e=t.getComponent("cc.Toggle");if(e&&e.enabled)return e}).filter(Boolean)}onEnable(){this.ensureValidState(),this.node.on(pf.CHILD_ADDED,this.ensureValidState,this),this.node.on(pf.CHILD_REMOVED,this.ensureValidState,this)}onDisable(){this.node.off(pf.CHILD_ADDED,this.ensureValidState,this),this.node.off(pf.CHILD_REMOVED,this.ensureValidState,this)}activeToggles(){return this.toggleItems.filter(t=>t.isChecked)}anyTogglesChecked(){return!!this.toggleItems.find(t=>t.isChecked)}notifyToggleCheck(t,e=!0){if(this.enabledInHierarchy){for(let n=0;n<this.toggleItems.length;n++){const i=this.toggleItems[n];i!==t&&(e?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&i.Component.EventHandler.emitEvents(this.checkEvents,t)}}ensureValidState(){const t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){const e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}const e=this.activeToggles();if(e.length>1){const t=e[0];for(let n=0;n<e.length;++n){const i=e[n];i!==t&&(i.isChecked=!1)}}}}).prototype,"_allowSwitchOff",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Gl(C$.prototype,"allowSwitchOff",[x$],Object.getOwnPropertyDescriptor(C$.prototype,"allowSwitchOff"),C$.prototype),b$=Gl(C$.prototype,"checkEvents",[S$,Ql,T$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),E$=C$))||E$)||E$)||E$)||E$)||E$));const dZ=new ln;function pZ(t){return t instanceof IT?Lm:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:On.ZERO}function mZ(t,e,n,i){let s=t.parent?t.parent.getScale():dZ,r=s.x,o=s.y,a=0,c=0;for(let l=t.parent;;){if(!l)return n.x=n.y=0,void(i.x=i.y=1);const t=l.getPosition();if(a+=t.x,c+=t.y,l=l.parent,l===e)break;{s=l?l.getScale():dZ;const t=s.x,e=s.y;a*=t,c*=e,r*=t,o*=e}}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-c}let fZ,gZ;!function(t){t[t.ONCE=0]="ONCE",t[t.ALWAYS=1]="ALWAYS",t[t.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(fZ||(fZ={})),Xt(fZ),function(t){t[t.TOP=1]="TOP",t[t.MID=2]="MID",t[t.BOT=4]="BOT",t[t.LEFT=8]="LEFT",t[t.CENTER=16]="CENTER",t[t.RIGHT=32]="RIGHT",t[t.HORIZONTAL=56]="HORIZONTAL",t[t.VERTICAL=7]="VERTICAL"}(gZ||(gZ={}));const vZ=gZ.TOP|gZ.BOT,yZ=gZ.LEFT|gZ.RIGHT;let xZ=t("Widget",(w$=Yl("cc.Widget"),R$=ah(),I$=$l(110),P$=ih(),O$=Kl(hL),D$=Ah(sx),M$=_h(),N$=_h(),L$=_h(),z$=_h(),B$=_h(),F$=_h(),U$=_h(),G$=lh(),H$=lh(),V$=Ah(fZ),k$=_h(),w$(j$=R$(j$=I$(j$=P$(j$=O$(j$=nh((_Z=hZ=class extends Nu{constructor(...t){super(...t),this._lastPos=new ln,this._lastSize=new On,this._dirty=!0,Ul(this,"_alignFlags",q$,this),Ul(this,"_target",X$,this),Ul(this,"_left",Y$,this),Ul(this,"_right",K$,this),Ul(this,"_top",$$,this),Ul(this,"_bottom",Z$,this),Ul(this,"_horizontalCenter",J$,this),Ul(this,"_verticalCenter",Q$,this),Ul(this,"_isAbsLeft",tZ,this),Ul(this,"_isAbsRight",eZ,this),Ul(this,"_isAbsTop",nZ,this),Ul(this,"_isAbsBottom",iZ,this),Ul(this,"_isAbsHorizontalCenter",sZ,this),Ul(this,"_isAbsVerticalCenter",rZ,this),Ul(this,"_originalWidth",oZ,this),Ul(this,"_originalHeight",aZ,this),Ul(this,"_alignMode",cZ,this),Ul(this,"_lockFlags",lZ,this)}get target(){return this._target}set target(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}get isAlignTop(){return(this._alignFlags&gZ.TOP)>0}set isAlignTop(t){this._setAlign(gZ.TOP,t),this._recursiveDirty()}get isAlignBottom(){return(this._alignFlags&gZ.BOT)>0}set isAlignBottom(t){this._setAlign(gZ.BOT,t),this._recursiveDirty()}get isAlignLeft(){return(this._alignFlags&gZ.LEFT)>0}set isAlignLeft(t){this._setAlign(gZ.LEFT,t),this._recursiveDirty()}get isAlignRight(){return(this._alignFlags&gZ.RIGHT)>0}set isAlignRight(t){this._setAlign(gZ.RIGHT,t),this._recursiveDirty()}get isAlignVerticalCenter(){return(this._alignFlags&gZ.MID)>0}set isAlignVerticalCenter(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=gZ.MID):this._alignFlags&=~gZ.MID,this._recursiveDirty()}get isAlignHorizontalCenter(){return(this._alignFlags&gZ.CENTER)>0}set isAlignHorizontalCenter(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=gZ.CENTER):this._alignFlags&=~gZ.CENTER,this._recursiveDirty()}get isStretchWidth(){return(this._alignFlags&yZ)===yZ}get isStretchHeight(){return(this._alignFlags&vZ)===vZ}get top(){return this._top}set top(t){this._top=t,this._recursiveDirty()}get editorTop(){return this._isAbsTop?this._top:100*this._top}set editorTop(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}get bottom(){return this._bottom}set bottom(t){this._bottom=t,this._recursiveDirty()}get editorBottom(){return this._isAbsBottom?this._bottom:100*this._bottom}set editorBottom(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}get left(){return this._left}set left(t){this._left=t,this._recursiveDirty()}get editorLeft(){return this._isAbsLeft?this._left:100*this._left}set editorLeft(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}get right(){return this._right}set right(t){this._right=t,this._recursiveDirty()}get editorRight(){return this._isAbsRight?this._right:100*this._right}set editorRight(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}get horizontalCenter(){return this._horizontalCenter}set horizontalCenter(t){this._horizontalCenter=t,this._recursiveDirty()}get editorHorizontalCenter(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter}set editorHorizontalCenter(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}get verticalCenter(){return this._verticalCenter}set verticalCenter(t){this._verticalCenter=t,this._recursiveDirty()}get editorVerticalCenter(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter}set editorVerticalCenter(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}get isAbsoluteTop(){return this._isAbsTop}set isAbsoluteTop(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(gZ.TOP,this._isAbsTop))}get isAbsoluteBottom(){return this._isAbsBottom}set isAbsoluteBottom(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(gZ.BOT,this._isAbsBottom))}get isAbsoluteLeft(){return this._isAbsLeft}set isAbsoluteLeft(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(gZ.LEFT,this._isAbsLeft))}get isAbsoluteRight(){return this._isAbsRight}set isAbsoluteRight(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(gZ.RIGHT,this._isAbsRight))}get isAbsoluteHorizontalCenter(){return this._isAbsHorizontalCenter}set isAbsoluteHorizontalCenter(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(gZ.CENTER,this._isAbsHorizontalCenter))}get isAbsoluteVerticalCenter(){return this._isAbsVerticalCenter}set isAbsoluteVerticalCenter(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(gZ.MID,this._isAbsVerticalCenter))}get alignMode(){return this._alignMode}set alignMode(t){this._alignMode=t,this._recursiveDirty()}get alignFlags(){return this._alignFlags}set alignFlags(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}updateAlignment(){i._widgetManager.updateAlignment(this.node)}_validateTargetInDEV(){}setDirty(){this._recursiveDirty()}onEnable(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),i._widgetManager.add(this),this._registerEvent(),this._registerTargetEvents()}onDisable(){i._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}onDestroy(){this._removeParentEvent()}_adjustWidgetToAllowMovingInEditor(t){}_adjustWidgetToAllowResizingInEditor(){}_adjustWidgetToAnchorChanged(){this.setDirty()}_adjustTargetToParentChanged(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents()}_registerEvent(){this.node.on(pf.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(pf.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_unregisterEvent(){this.node.off(pf.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}_removeParentEvent(){this.node.off(pf.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_autoChangedValue(t,e){if(!((this._alignFlags&t)>0))return;const n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,s=i?i.contentSize:Lm;this.isAlignLeft&&t===gZ.LEFT?this._left=e?this._left*s.width:this._left/s.width:this.isAlignRight&&t===gZ.RIGHT?this._right=e?this._right*s.width:this._right/s.width:this.isAlignHorizontalCenter&&t===gZ.CENTER?this._horizontalCenter=e?this._horizontalCenter*s.width:this._horizontalCenter/s.width:this.isAlignTop&&t===gZ.TOP?this._top=e?this._top*s.height:this._top/s.height:this.isAlignBottom&&t===gZ.BOT?this._bottom=e?this._bottom*s.height:this._bottom/s.height:this.isAbsoluteVerticalCenter&&t===gZ.MID&&(this._verticalCenter=this._verticalCenter/s.height),this._recursiveDirty()}_registerTargetEvents(){const t=this._target||this.node.parent;t&&t.getComponent(hL)&&(t.on(pf.TRANSFORM_CHANGED,this._targetChangedOperation,this),t.on(pf.SIZE_CHANGED,this._targetChangedOperation,this))}_unregisterTargetEvents(){const t=this._target||this.node.parent;t&&(t.off(pf.TRANSFORM_CHANGED,this._targetChangedOperation,this),t.off(pf.SIZE_CHANGED,this._targetChangedOperation,this))}_unregisterOldParentEvents(t){const e=this._target||t;e&&(e.off(pf.TRANSFORM_CHANGED,this._targetChangedOperation,this),e.off(pf.SIZE_CHANGED,this._targetChangedOperation,this))}_targetChangedOperation(){this.alignMode===fZ.ALWAYS&&this._recursiveDirty()}_setAlign(t,e){if(e===(this._alignFlags&t)>0)return;const n=(t&yZ)>0,i=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~t)}_recursiveDirty(){this._dirty||(this._dirty=!0)}},hZ.AlignMode=fZ,Gl((W$=_Z).prototype,"target",[D$,M$],Object.getOwnPropertyDescriptor(W$.prototype,"target"),W$.prototype),Gl(W$.prototype,"isAlignTop",[N$],Object.getOwnPropertyDescriptor(W$.prototype,"isAlignTop"),W$.prototype),Gl(W$.prototype,"isAlignBottom",[L$],Object.getOwnPropertyDescriptor(W$.prototype,"isAlignBottom"),W$.prototype),Gl(W$.prototype,"isAlignLeft",[z$],Object.getOwnPropertyDescriptor(W$.prototype,"isAlignLeft"),W$.prototype),Gl(W$.prototype,"isAlignRight",[B$],Object.getOwnPropertyDescriptor(W$.prototype,"isAlignRight"),W$.prototype),Gl(W$.prototype,"isAlignVerticalCenter",[F$],Object.getOwnPropertyDescriptor(W$.prototype,"isAlignVerticalCenter"),W$.prototype),Gl(W$.prototype,"isAlignHorizontalCenter",[U$],Object.getOwnPropertyDescriptor(W$.prototype,"isAlignHorizontalCenter"),W$.prototype),Gl(W$.prototype,"isStretchWidth",[G$],Object.getOwnPropertyDescriptor(W$.prototype,"isStretchWidth"),W$.prototype),Gl(W$.prototype,"isStretchHeight",[H$],Object.getOwnPropertyDescriptor(W$.prototype,"isStretchHeight"),W$.prototype),Gl(W$.prototype,"editorTop",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"editorTop"),W$.prototype),Gl(W$.prototype,"editorBottom",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"editorBottom"),W$.prototype),Gl(W$.prototype,"editorLeft",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"editorLeft"),W$.prototype),Gl(W$.prototype,"editorRight",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"editorRight"),W$.prototype),Gl(W$.prototype,"editorHorizontalCenter",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"editorHorizontalCenter"),W$.prototype),Gl(W$.prototype,"editorVerticalCenter",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"editorVerticalCenter"),W$.prototype),Gl(W$.prototype,"isAbsoluteTop",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"isAbsoluteTop"),W$.prototype),Gl(W$.prototype,"isAbsoluteBottom",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"isAbsoluteBottom"),W$.prototype),Gl(W$.prototype,"isAbsoluteLeft",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"isAbsoluteLeft"),W$.prototype),Gl(W$.prototype,"isAbsoluteRight",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"isAbsoluteRight"),W$.prototype),Gl(W$.prototype,"isAbsoluteHorizontalCenter",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"isAbsoluteHorizontalCenter"),W$.prototype),Gl(W$.prototype,"isAbsoluteVerticalCenter",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"isAbsoluteVerticalCenter"),W$.prototype),Gl(W$.prototype,"alignMode",[V$,k$],Object.getOwnPropertyDescriptor(W$.prototype,"alignMode"),W$.prototype),Gl(W$.prototype,"alignFlags",[ch],Object.getOwnPropertyDescriptor(W$.prototype,"alignFlags"),W$.prototype),q$=Gl(W$.prototype,"_alignFlags",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),X$=Gl(W$.prototype,"_target",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Y$=Gl(W$.prototype,"_left",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),K$=Gl(W$.prototype,"_right",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$$=Gl(W$.prototype,"_top",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Z$=Gl(W$.prototype,"_bottom",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),J$=Gl(W$.prototype,"_horizontalCenter",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Q$=Gl(W$.prototype,"_verticalCenter",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tZ=Gl(W$.prototype,"_isAbsLeft",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eZ=Gl(W$.prototype,"_isAbsRight",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nZ=Gl(W$.prototype,"_isAbsTop",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iZ=Gl(W$.prototype,"_isAbsBottom",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),sZ=Gl(W$.prototype,"_isAbsHorizontalCenter",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),rZ=Gl(W$.prototype,"_isAbsVerticalCenter",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),oZ=Gl(W$.prototype,"_originalWidth",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),aZ=Gl(W$.prototype,"_originalHeight",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cZ=Gl(W$.prototype,"_alignMode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fZ.ON_WINDOW_RESIZE}}),lZ=Gl(W$.prototype,"_lockFlags",[Ql,th],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),j$=W$))||j$)||j$)||j$)||j$)||j$)||j$));var SZ,TZ,EZ,CZ,AZ,bZ,wZ,RZ,IZ,PZ,OZ,DZ,MZ,NZ,LZ,zZ,BZ,FZ,UZ;i.internal.computeInverseTransForTarget=mZ,i.internal.getReadonlyNodeSize=pZ;const GZ=new Ln;var HZ;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(HZ||(HZ={})),Xt(HZ);let VZ=t("PageViewIndicator",(SZ=Yl("cc.PageViewIndicator"),TZ=ah(),EZ=$l(110),CZ=ih(),AZ=Ah(HM),bZ=_h(),wZ=Ah(HZ),RZ=_h(),IZ=Ah(On),PZ=_h(),OZ=_h(),SZ(DZ=TZ(DZ=EZ(DZ=CZ((UZ=FZ=class extends Nu{constructor(...t){super(...t),Ul(this,"spacing",NZ,this),Ul(this,"_spriteFrame",LZ,this),Ul(this,"_direction",zZ,this),Ul(this,"_cellSize",BZ,this),this._layout=null,this._pageView=null,this._indicators=[]}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){this._spriteFrame!==t&&(this._spriteFrame=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t)}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize=t)}onLoad(){this._updateLayout()}setPageView(t){this._pageView=t,this._refresh()}_updateLayout(){this._layout=this.getComponent(SX),this._layout||(this._layout=this.addComponent(SX));const t=this._layout;this.direction===HZ.HORIZONTAL?(t.type=SX.Type.HORIZONTAL,t.spacingX=this.spacing):this.direction===HZ.VERTICAL&&(t.type=SX.Type.VERTICAL,t.spacingY=this.spacing),t.resizeMode=SX.ResizeMode.CONTAINER}_createIndicator(){const t=new sx,e=t.addComponent(IU);return e.spriteFrame=this.spriteFrame,e.sizeMode=IU.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t}_changedState(){const t=this._indicators;if(0===t.length||!this._pageView)return;const e=this._pageView.curPageIdx;if(!(e>=t.length)){for(let e=0;e<t.length;++e){const n=t[e];if(!n._uiProps.uiComp)continue;const i=n._uiProps.uiComp;GZ.set(i.color),GZ.a=127.5,i.color=GZ}if(t[e]._uiProps.uiComp){const n=t[e]._uiProps.uiComp;GZ.set(n.color),GZ.a=255,n.color=GZ}}}_refresh(){if(!this._pageView)return;const t=this._indicators,e=this._pageView.getPages();if(e.length===t.length)return;let n=0;if(e.length>t.length)for(n=0;n<e.length;++n)t[n]||(t[n]=this._createIndicator());else for(n=t.length-e.length;n>0;--n){const e=t[n-1];this.node.removeChild(e),t.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}},FZ.Direction=HZ,Gl((MZ=UZ).prototype,"spriteFrame",[AZ,bZ],Object.getOwnPropertyDescriptor(MZ.prototype,"spriteFrame"),MZ.prototype),Gl(MZ.prototype,"direction",[wZ,RZ],Object.getOwnPropertyDescriptor(MZ.prototype,"direction"),MZ.prototype),Gl(MZ.prototype,"cellSize",[IZ,PZ],Object.getOwnPropertyDescriptor(MZ.prototype,"cellSize"),MZ.prototype),NZ=Gl(MZ.prototype,"spacing",[Ql,OZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LZ=Gl(MZ.prototype,"_spriteFrame",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zZ=Gl(MZ.prototype,"_direction",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HZ.HORIZONTAL}}),BZ=Gl(MZ.prototype,"_cellSize",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On(20,20)}}),DZ=MZ))||DZ)||DZ)||DZ)||DZ));var kZ,jZ,WZ,qZ,XZ,YZ,KZ,$Z,ZZ,JZ,QZ,tJ,eJ,nJ,iJ,sJ,rJ,oJ,aJ,cJ,lJ,hJ,_J,uJ,dJ,pJ,mJ,fJ,gJ,vJ,yJ,xJ,SJ,TJ,EJ,CJ,AJ,bJ,wJ,RJ,IJ,PJ;const OJ=new rn;var DJ,MJ,NJ;!function(t){t[t.Unified=0]="Unified",t[t.Free=1]="Free"}(DJ||(DJ={})),Xt(DJ),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(MJ||(MJ={})),Xt(MJ),function(t){t.PAGE_TURNING="page-turning"}(NJ||(NJ={})),t("PageView",(kZ=Yl("cc.PageView"),jZ=ah(),WZ=$l(110),qZ=ih(),XZ=Ah(DJ),YZ=_h(),KZ=Ah(MJ),$Z=_h(),ZZ=uh(),JZ=_h(),QZ=uh(),tJ=_h(),eJ=Ah(VZ),nJ=_h(),iJ=_h(),sJ=Ah(SY),rJ=lh(),oJ=Ah(SY),aJ=lh(),cJ=lh(),lJ=lh(),hJ=lh(),_J=Ah([pC]),uJ=lh(),dJ=Ah([pC]),pJ=_h(),kZ(mJ=jZ(mJ=WZ(mJ=qZ((PJ=IJ=class t extends bK{constructor(...t){super(...t),Ul(this,"autoPageTurningThreshold",gJ,this),Ul(this,"horizontal",vJ,this),Ul(this,"vertical",yJ,this),Ul(this,"cancelInnerEvents",xJ,this),Ul(this,"scrollEvents",SJ,this),Ul(this,"pageTurningSpeed",TJ,this),Ul(this,"pageEvents",EJ,this),Ul(this,"_sizeMode",CJ,this),Ul(this,"_direction",AJ,this),Ul(this,"_scrollThreshold",bJ,this),Ul(this,"_pageTurningEventTiming",wJ,this),Ul(this,"_indicator",RJ,this),this._curPageIdx=0,this._lastPageIdx=0,this._pages=[],this._initContentPos=new ln,this._scrollCenterOffsetX=[],this._scrollCenterOffsetY=[],this._touchBeganPosition=new ln,this._touchEndPosition=new ln}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}get scrollThreshold(){return this._scrollThreshold}set scrollThreshold(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}get pageTurningEventTiming(){return this._pageTurningEventTiming}set pageTurningEventTiming(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}get indicator(){return this._indicator}set indicator(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}get curPageIdx(){return this._curPageIdx}get verticalScrollBar(){return super.verticalScrollBar}set verticalScrollBar(t){super.verticalScrollBar=t}get horizontalScrollBar(){return super.horizontalScrollBar}set horizontalScrollBar(t){super.horizontalScrollBar=t}onEnable(){super.onEnable(),this.node.on(pf.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onDisable(){super.onDisable(),this.node.off(pf.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onLoad(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}getCurrentPageIndex(){return this._curPageIdx}setCurrentPageIndex(t){this.scrollToPage(t,1)}getPages(){return this._pages}addPage(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):v(4301))}insertPage(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void v(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}}removePage(t){if(!t||!this.content)return;const e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):x(4300,t.name)}removePageAtIndex(t){const e=this._pages;if(t<0||t>=e.length)return;const n=e[t];n&&this.content&&(this.content.removeChild(n),e.splice(t,1),this._updatePageView())}removeAllPages(){if(!this.content)return;const t=this._pages;for(let e=0,n=t.length;e<n;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}scrollToPage(t,e=.3){t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())}getScrollEndedEventTiming(){return this.pageTurningEventTiming}_updatePageView(){if(!this.content)return;const t=this.content.getComponent(SX);t&&t.enabled&&t.updateLayout();const e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);const n=this._initContentPos;for(let t=0;t<e;++t){const e=this._pages[t].position;this.direction===MJ.Horizontal?this._scrollCenterOffsetX[t]=Math.abs(n.x+e.x):this._scrollCenterOffsetY[t]=Math.abs(n.y+e.y)}this.indicator&&this.indicator._refresh()}_updateAllPagesSize(){const t=this.view;if(!this.content||!t)return;if(this._sizeMode!==DJ.Unified)return;const e=this._pages,n=t.contentSize;for(let t=0,i=e.length;t<i;t++)e[t]._uiProps.uiTransformComp.setContentSize(n)}_handleReleaseLogic(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))}_onTouchBegan(t,e){t.touch.getUILocation(OJ),ln.set(this._touchBeganPosition,OJ.x,OJ.y,0),super._onTouchBegan(t,e)}_onTouchMoved(t,e){super._onTouchMoved(t,e)}_onTouchEnded(t,e){t.touch.getUILocation(OJ),ln.set(this._touchEndPosition,OJ.x,OJ.y,0),super._onTouchEnded(t,e)}_onTouchCancelled(t,e){t.touch.getUILocation(OJ),ln.set(this._touchEndPosition,OJ.x,OJ.y,0),super._onTouchCancelled(t,e)}_onMouseWheel(){}_syncScrollDirection(){this.horizontal=this.direction===MJ.Horizontal,this.vertical=this.direction===MJ.Vertical}_syncSizeMode(){const t=this.view;if(!this.content||!t)return;const e=this.content.getComponent(SX);if(e){if(this._sizeMode===DJ.Free&&this._pages.length>0){const n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===MJ.Horizontal?(e.paddingLeft=(t.width-n.width)/2,e.paddingRight=(t.width-i.width)/2):this.direction===MJ.Vertical&&(e.paddingTop=(t.height-n.height)/2,e.paddingBottom=(t.height-i.height)/2)}e.updateLayout()}}_initPages(){if(!this.content)return;this._initContentPos=this.content.position;const t=this.content.children;for(let e=0;e<t.length;++e){const n=t[e];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}_dispatchPageTurningEvent(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,pC.emitEvents(this.pageEvents,this,NJ.PAGE_TURNING),this.node.emit(NJ.PAGE_TURNING,this))}_isQuicklyScrollable(t){if(this.direction===MJ.Horizontal){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===MJ.Vertical&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1}_moveOffsetValue(t){const e=new ln;if(this._sizeMode===DJ.Free)this.direction===MJ.Horizontal?e.x=this._scrollCenterOffsetX[t]:this.direction===MJ.Vertical&&(e.y=this._scrollCenterOffsetY[t]);else{const n=this.view;if(!n)return e;this.direction===MJ.Horizontal?e.x=t*n.width:this.direction===MJ.Vertical&&(e.y=t*n.height)}return e}_getDragDirection(t){return this._direction===MJ.Horizontal?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1}_isScrollable(t,e,n){if(this._sizeMode===DJ.Free){let i=0,s=0;if(this.direction===MJ.Horizontal)return i=this._scrollCenterOffsetX[e],s=this._scrollCenterOffsetX[n],Math.abs(t.x)>=Math.abs(i-s)*this.scrollThreshold;if(this.direction===MJ.Vertical)return i=this._scrollCenterOffsetY[e],s=this._scrollCenterOffsetY[n],Math.abs(t.y)>=Math.abs(i-s)*this.scrollThreshold}else{const e=this.view;if(!e)return;if(this.direction===MJ.Horizontal)return Math.abs(t.x)>=e.width*this.scrollThreshold;if(this.direction===MJ.Vertical)return Math.abs(t.y)>=e.height*this.scrollThreshold}}_autoScrollToPage(){if(this._startBounceBackIfNeeded()){let t=this._getHowMuchOutOfBoundary();t=this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{const t=new ln;ln.subtract(t,this._touchBeganPosition,this._touchEndPosition);const e=this._curPageIdx,n=e+this._getDragDirection(t),i=this.pageTurningSpeed*Math.abs(e-n);if(n<this._pages.length){if(this._isScrollable(t,e,n))return void this.scrollToPage(n,i);{const t=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(t))return void this.scrollToPage(n,i)}}this.scrollToPage(e,i)}}},IJ.SizeMode=DJ,IJ.Direction=MJ,IJ.EventType=uZ(NJ,AK),Gl((fJ=PJ).prototype,"sizeMode",[XZ,YZ],Object.getOwnPropertyDescriptor(fJ.prototype,"sizeMode"),fJ.prototype),Gl(fJ.prototype,"direction",[KZ,$Z],Object.getOwnPropertyDescriptor(fJ.prototype,"direction"),fJ.prototype),Gl(fJ.prototype,"scrollThreshold",[fh,ZZ,JZ],Object.getOwnPropertyDescriptor(fJ.prototype,"scrollThreshold"),fJ.prototype),Gl(fJ.prototype,"pageTurningEventTiming",[fh,QZ,tJ],Object.getOwnPropertyDescriptor(fJ.prototype,"pageTurningEventTiming"),fJ.prototype),Gl(fJ.prototype,"indicator",[eJ,nJ],Object.getOwnPropertyDescriptor(fJ.prototype,"indicator"),fJ.prototype),gJ=Gl(fJ.prototype,"autoPageTurningThreshold",[Ql,iJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),Gl(fJ.prototype,"verticalScrollBar",[sJ,bh,rJ],Object.getOwnPropertyDescriptor(fJ.prototype,"verticalScrollBar"),fJ.prototype),Gl(fJ.prototype,"horizontalScrollBar",[oJ,bh,aJ],Object.getOwnPropertyDescriptor(fJ.prototype,"horizontalScrollBar"),fJ.prototype),vJ=Gl(fJ.prototype,"horizontal",[bh,Ql,cJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),yJ=Gl(fJ.prototype,"vertical",[bh,Ql,lJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),xJ=Gl(fJ.prototype,"cancelInnerEvents",[bh,Ql,hJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),SJ=Gl(fJ.prototype,"scrollEvents",[_J,Ql,bh,uJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TJ=Gl(fJ.prototype,"pageTurningSpeed",[Ql,ch],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),EJ=Gl(fJ.prototype,"pageEvents",[dJ,Ql,pJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),CJ=Gl(fJ.prototype,"_sizeMode",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return DJ.Unified}}),AJ=Gl(fJ.prototype,"_direction",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return MJ.Horizontal}}),bJ=Gl(fJ.prototype,"_scrollThreshold",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),wJ=Gl(fJ.prototype,"_pageTurningEventTiming",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),RJ=Gl(fJ.prototype,"_indicator",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mJ=fJ))||mJ)||mJ)||mJ)||mJ));const LJ=new ln,zJ=new rn,BJ=new ln,FJ=new ln(1,1,1);function UJ(t,e){const n=e.target;let i;const s=BJ,r=FJ;n?(i=n,mZ(t,i,s,r)):i=t.parent;const o=pZ(i),a=i instanceof IT||!i.getComponent(hL),c=a?zJ:i.getComponent(hL).anchorPoint,l=a;t.getPosition(LJ);const h=t._uiProps.uiTransformComp;let _=LJ.x,u=LJ.y;const d=h.anchorPoint,p=t.getScale();if(e.alignFlags&gZ.HORIZONTAL){let t=0,i=0;const a=o.width;l?(t=Lm.left.x,i=Lm.right.x):(t=-c.x*a,i=t+a),t+=e.isAbsoluteLeft?e.left:e.left*a,i-=e.isAbsoluteRight?e.right:e.right*a,n&&(t+=s.x,t*=r.x,i+=s.x,i*=r.x);let u=0,m=d.x,f=p.x;if(f<0&&(m=1-m,f=-f),e.isStretchWidth)u=i-t,0!==f&&(h.width=u/f),_=t+m*u;else if(u=h.width*f,e.isAlignHorizontalCenter){let t=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*a,i=(.5-c.x)*o.width;n&&(t*=r.x,i+=s.x,i*=r.x),_=i+(m-.5)*u+t}else _=e.isAlignLeft?t+m*u:i+(m-1)*u;e._lastSize.width=u}if(e.alignFlags&gZ.VERTICAL){let t=0,i=0;const a=o.height;l?(i=Lm.bottom.y,t=Lm.top.y):(i=-c.y*a,t=i+a),i+=e.isAbsoluteBottom?e.bottom:e.bottom*a,t-=e.isAbsoluteTop?e.top:e.top*a,n&&(i+=s.y,i*=r.y,t+=s.y,t*=r.y);let _=0,m=d.y,f=p.y;if(f<0&&(m=1-m,f=-f),e.isStretchHeight)_=t-i,0!==f&&(h.height=_/f),u=i+m*_;else if(_=h.height*f,e.isAlignVerticalCenter){let t=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*a,i=(.5-c.y)*o.height;n&&(t*=r.y,i+=s.y,i*=r.y),u=i+(m-.5)*_+t}else u=e.isAlignBottom?i+m*_:t+(m-1)*_;e._lastSize.height=_}t.setPosition(_,u,LJ.z),ln.set(e._lastPos,_,u,LJ.z)}function GJ(){const t=rE.getScene();if(t){if(VJ.isAligning=!0,VJ._nodesOrderDirty)HJ.length=0,function t(e){const n=e.getComponent(xZ);if(n)if(UJ(e,n),n.alignMode===fZ.ONCE)n.enabled=!1;else{if(!i.isValid(e,!0))return;HJ.push(n)}const s=e.children;for(const e of s)e.active&&t(e)}(t),VJ._nodesOrderDirty=!1;else{let t=null;const e=VJ._activeWidgetsIterator;for(e.i=0;e.i<HJ.length;++e.i)t=HJ[e.i],t._dirty&&(UJ(t.node,t),t._dirty=!1)}VJ.isAligning=!1}}const HJ=[],VJ=t("widgetManager",i._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Ht.MutableForwardIterator(HJ),animationState:null,init(){rE.on(sE.EVENT_AFTER_UPDATE,GJ),lf.instance.on("design-resolution-changed",this.onResized,this);{const t=this.onResized.bind(this);lf.instance.on("canvas-resize",t),window.addEventListener("orientationchange",t)}},add(t){this._nodesOrderDirty=!0},remove(t){this._activeWidgetsIterator.remove(t)},onResized(){const t=rE.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized(t){const e=sx.isNode(t)&&t.getComponent(xZ);e&&e.enabled&&(e.alignMode===fZ.ON_WINDOW_RESIZE||e.alignMode===fZ.ALWAYS)&&e.setDirty();const n=t.children;for(const t of n)this.refreshWidgetOnResized(t)},updateOffsetsToStayPut(t,e){function n(t,e){return Math.abs(t-e)>1e-10?e:t}const i=t.node;let s=i.parent;if(s){const r=new ln,o=new ln(1,1,1);if(t.target&&(s=t.target,mZ(i,s,r,o)),!e)return;const a=s._uiProps&&s._uiProps.uiTransformComp,c=a?a.anchorPoint:zJ,l=i._uiProps.uiTransformComp,h=pZ(s),_=l.anchorPoint,u=i.getPosition(),d=gZ,p=i.getScale();let m=0;if(e&d.LEFT){let e=-c.x*h.width;e+=r.x,e*=o.x,m=u.x-_.x*l.width*p.x-e,t.isAbsoluteLeft||(m/=h.width),m/=o.x,t.left=n(t.left,m)}if(e&d.RIGHT){let e=(1-c.x)*h.width;e+=r.x,m=(e*=o.x)-(u.x+(1-_.x)*l.width*p.x),t.isAbsoluteRight||(m/=h.width),m/=o.x,t.right=n(t.right,m)}if(e&d.TOP){let e=(1-c.y)*h.height;e+=r.y,m=(e*=o.y)-(u.y+(1-_.y)*l.height*p.y),t.isAbsoluteTop||(m/=h.height),m/=o.y,t.top=n(t.top,m)}if(e&d.BOT){let e=-c.y*h.height;e+=r.y,e*=o.y,m=u.y-_.y*l.height*p.y-e,t.isAbsoluteBottom||(m/=h.height),m/=o.y,t.bottom=n(t.bottom,m)}}},updateAlignment:function t(e){const n=e.parent;n&&sx.isNode(n)&&t(n);const i=e.getComponent(xZ);i&&n&&UJ(e,i)},AlignMode:fZ,AlignFlags:gZ});var kJ,jJ,WJ,qJ,XJ,YJ,KJ,$J,ZJ,JJ,QJ,tQ,eQ,nQ,iQ,sQ,rQ,oQ,aQ,cQ,lQ;rE.on(sE.EVENT_INIT,()=>{VJ.init()}),t("SafeArea",Yl("cc.SafeArea")(kJ=ah()(kJ=$l(110)(kJ=nh(kJ=ih()(kJ=Kl(xZ)(kJ=class extends Nu{onEnable(){this.updateArea(),df.on("canvas-resize",this.updateArea,this)}onDisable(){df.off("canvas-resize",this.updateArea,this)}updateArea(){const t=this.node.getComponent(xZ),e=this.node.getComponent(hL);if(!t||!e)return;t.updateAlignment();const n=this.node.position.clone(),s=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;const r=i.winSize.width,o=i.winSize.height,a=Om.getSafeAreaRect();t.top=o-a.y-a.height,t.bottom=a.y,t.left=a.x,t.right=r-a.x-a.width,t.updateAlignment();const c=this.node.position.clone(),l=s.x-(c.x-n.x)/e.width,h=s.y-(c.y-n.y)/e.height;e.setAnchorPoint(l,h),VJ.add(t)}})||kJ)||kJ)||kJ)||kJ)||kJ)||kJ),t("UICoordinateTracker",(jJ=Yl("cc.UICoordinateTracker"),WJ=ah(),qJ=ih(),XJ=$l(110),YJ=Ah(sx),KJ=_h(),$J=Ah(LA),ZJ=_h(),JJ=_h(),QJ=_h(),tQ=Ah([pC]),eQ=_h(),jJ(nQ=WJ(nQ=qJ(nQ=XJ((Gl((iQ=class extends Nu{constructor(...t){super(...t),Ul(this,"syncEvents",sQ,this),Ul(this,"_target",rQ,this),Ul(this,"_camera",oQ,this),Ul(this,"_useScale",aQ,this),Ul(this,"_distance",cQ,this),this._transformPos=new ln,this._viewPos=new ln,this._canMove=!0,this._lastWPos=new ln,this._lastCameraPos=new ln}get target(){return this._target}set target(t){this._target!==t&&(this._target=t,this._checkCanMove())}get camera(){return this._camera}set camera(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}get useScale(){return this._useScale}set useScale(t){this._useScale!==t&&(this._useScale=t)}get distance(){return this._distance}set distance(t){this._distance!==t&&(this._distance=t)}onEnable(){this._checkCanMove()}update(){const t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&ln.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){const t=this._distance/Math.abs(this._viewPos.z);pC.emitEvents(this.syncEvents,this._transformPos,t)}}_checkCanMove(){this._canMove=!(!this._camera||!this._target)}}).prototype,"target",[YJ,KJ],Object.getOwnPropertyDescriptor(iQ.prototype,"target"),iQ.prototype),Gl(iQ.prototype,"camera",[$J,ZJ],Object.getOwnPropertyDescriptor(iQ.prototype,"camera"),iQ.prototype),Gl(iQ.prototype,"useScale",[JJ],Object.getOwnPropertyDescriptor(iQ.prototype,"useScale"),iQ.prototype),Gl(iQ.prototype,"distance",[QJ],Object.getOwnPropertyDescriptor(iQ.prototype,"distance"),iQ.prototype),sQ=Gl(iQ.prototype,"syncEvents",[tQ,Ql,eQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rQ=Gl(iQ.prototype,"_target",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oQ=Gl(iQ.prototype,"_camera",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aQ=Gl(iQ.prototype,"_useScale",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),cQ=Gl(iQ.prototype,"_distance",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nQ=iQ))||nQ)||nQ)||nQ)||nQ));const hQ=[pf.TOUCH_START,pf.TOUCH_END,pf.TOUCH_MOVE,pf.MOUSE_DOWN,pf.MOUSE_MOVE,pf.MOUSE_UP,pf.MOUSE_ENTER,pf.MOUSE_LEAVE,pf.MOUSE_WHEEL];function _Q(t){t.propagationStopped=!0}var uQ,dQ,pQ,mQ,fQ,gQ,vQ,yQ,xQ,SQ,TQ;t("BlockInputEvents",Yl("cc.BlockInputEvents")(lQ=ah()(lQ=ih()(lQ=class extends Nu{onEnable(){for(let t=0;t<hQ.length;t++)this.node.on(hQ[t],_Q,this)}onDisable(){for(let t=0;t<hQ.length;t++)this.node.off(hQ[t],_Q,this)}})||lQ)||lQ)||lQ);let EQ=t("SubContextView",(uQ=Yl("cc.SubContextView"),dQ=ah(),pQ=$l(110),mQ=Kl(hL),fQ=ih(),gQ=_h(),vQ=_h(),uQ(yQ=dQ(yQ=pQ(yQ=mQ(yQ=fQ((Gl((xQ=class extends Nu{get designResolutionSize(){return this._designResolutionSize}set designResolutionSize(t){}get fps(){return this._fps}set fps(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}constructor(){super(),Ul(this,"_fps",SQ,this),this._sprite=void 0,this._imageAsset=void 0,this._updatedTime=0,this._updateInterval=0,this._openDataContext=void 0,this._content=void 0,Ul(this,"_designResolutionSize",TQ,this),this._content=new DT("content"),this._sprite=null,this._imageAsset=new P_,this._openDataContext=null,this._updatedTime=performance.now()}onLoad(){window.__globalAdapter&&__globalAdapter.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=__globalAdapter.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView()):this.enabled=!1}onEnable(){this._registerNodeEvent()}onDisable(){this._unregisterNodeEvent()}_initSharedCanvas(){if(this._openDataContext){const t=this._openDataContext.canvas;t.width=this._designResolutionSize.width,t.height=this._designResolutionSize.height}}_initContentNode(){if(this._openDataContext){const t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),e._texture.create(t.width,t.height),this._sprite=this._content.getComponent(IU),this._sprite||(this._sprite=this._content.addComponent(IU)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._imageAsset._texture;else{const t=new HM;t.texture=this._imageAsset._texture,this._sprite.spriteFrame=t}this._content.parent=this.node}}_updateSubContextView(){if(!(this._openDataContext&&__globalAdapter&&__globalAdapter.getSystemInfoSync))return;const t=this.node.getComponent(hL),e=this._content.getComponent(hL),n=t.width/e.width,i=t.height/e.height,s=n>i?i:n;e.width*=s,e.height*=s;const r=__globalAdapter.getSystemInfoSync(),o=e.getBoundingBoxToWorld(),a=df.getVisibleSize(),c=r.screenWidth*(o.x/a.width),l=r.screenHeight*(o.y/a.height),h=r.screenWidth*(o.width/a.width),_=r.screenHeight*(o.height/a.height);this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:c,y:l,width:h,height:_})}_updateSubContextTexture(){const t=this._imageAsset;if(!t||!this._openDataContext)return;if(t.width<=0||t.height<=0)return;const e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._imageAsset._texture.create(e.width,e.height),this._imageAsset._texture.uploadData(e)}_registerNodeEvent(){this.node.on(sx.EventType.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(sx.EventType.SIZE_CHANGED,this._updateSubContextView,this)}_unregisterNodeEvent(){this.node.off(sx.EventType.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(sx.EventType.SIZE_CHANGED,this._updateSubContextView,this)}update(t){void 0!==t?performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture()):this._updateSubContextTexture()}}).prototype,"designResolutionSize",[gQ],Object.getOwnPropertyDescriptor(xQ.prototype,"designResolutionSize"),xQ.prototype),Gl(xQ.prototype,"fps",[vQ],Object.getOwnPropertyDescriptor(xQ.prototype,"fps"),xQ.prototype),SQ=Gl(xQ.prototype,"_fps",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),TQ=Gl(xQ.prototype,"_designResolutionSize",[Ql],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new On(640,960)}}),yQ=xQ))||yQ)||yQ)||yQ)||yQ)||yQ));i.SubContextView=EQ}}}));
